# 预约单功能实现计划

## 实现任务列表

- [ ] 1. 后端核心服务实现
  - 创建预约单调度服务和冲突检测服务
  - 实现定时任务调度器和WebSocket消息处理
  - _需求: 1.1, 2.1, 2.2, 3.1, 5.1_

- [ ] 1.1 创建预约单调度服务
  - 实现ScheduledOrderService类，包含创建、激活、冲突处理方法
  - 添加预约时间验证和乘客状态检查逻辑
  - _需求: 1.1, 1.2, 1.3, 1.4, 1.5, 1.6_

- [ ] 1.2 实现冲突检测服务
  - 创建ConflictDetectionService类，实现乘客冲突检查
  - 实现冲突响应处理逻辑（取消/延后）
  - _需求: 2.1, 2.2, 3.2, 3.3, 3.4, 3.5_

- [ ] 1.3 创建定时任务调度器
  - 实现ScheduledOrderScheduler类，管理预约单激活任务
  - 添加系统启动时的任务恢复机制
  - _需求: 2.1, 2.4, 9.1_

- [ ] 1.4 扩展WebSocket消息处理
  - 在现有WebSocket服务中添加预约单消息类型
  - 实现冲突询问和预约单推送消息
  - _需求: 2.3, 3.1, 4.1, 8.1, 8.2, 8.3, 8.4, 8.5, 8.6_

- [ ] 2. 数据库查询方法扩展
  - 在OrderMapper中添加预约单相关查询方法
  - 实现预约单状态管理和批量查询
  - _需求: 5.1, 5.2, 5.3, 5.4, 5.5, 5.6_

- [ ] 2.1 扩展OrderMapper查询方法
  - 添加selectPendingScheduledOrders方法查询待激活预约单
  - 添加selectCurrentOrderByPassengerId方法检查乘客冲突
  - 添加selectAvailableScheduledOrdersForDriver方法查询司机可接预约单
  - _需求: 2.1, 3.1, 4.5, 7.2_

- [ ] 2.2 更新OrderMapper.xml映射文件
  - 实现新增查询方法的SQL映射
  - 优化查询性能，添加必要的索引建议
  - _需求: 10.1, 10.2, 10.5_

- [ ] 3. 后端API接口实现
  - 创建乘客端预约单管理接口
  - 创建司机端预约单查询和接单接口
  - _需求: 1.1, 1.2, 1.3, 1.4, 1.5, 1.6, 4.4, 6.1, 6.2, 6.3, 6.4, 6.5, 7.1, 7.2, 7.3, 7.4, 7.5_

- [ ] 3.1 实现乘客端预约单API
  - 创建ScheduledOrderController，实现创建、查询、取消预约单接口
  - 实现冲突处理响应接口
  - 添加请求参数验证和错误处理
  - _需求: 1.1, 1.2, 1.3, 1.4, 1.5, 1.6, 3.2, 3.3, 3.4, 6.1, 6.2, 6.3, 6.4, 6.5_

- [ ] 3.2 实现司机端预约单API
  - 在DriverController中添加预约单查询和接单方法
  - 实现预约单列表过滤和排序逻辑
  - _需求: 4.5, 7.1, 7.2, 7.3, 7.4, 7.5_

- [ ] 4. 前端乘客端UI实现
  - 在乘客地图页面添加预约用车选项
  - 实现预约时间选择和冲突处理弹窗
  - _需求: 1.1, 1.2, 1.3, 3.1, 3.2, 3.3, 3.4, 3.5, 3.6_

- [ ] 4.1 扩展乘客地图页面UI
  - 在PassengerMap.vue中添加预约用车选项切换
  - 实现预约时间选择器组件
  - 添加预约单创建表单和验证
  - _需求: 1.1, 1.2, 1.3, 1.4, 1.5, 1.6_

- [ ] 4.2 实现冲突处理弹窗组件
  - 创建ScheduledOrderConflictDialog.vue组件
  - 实现冲突信息显示和处理选项
  - 添加延后时间选择和确认逻辑
  - _需求: 3.1, 3.2, 3.3, 3.4, 3.5, 3.6_

- [ ] 4.3 扩展乘客订单store
  - 在order.js中添加预约单相关状态和方法
  - 实现预约单创建、查询、冲突处理逻辑
  - 添加WebSocket消息处理for预约单
  - _需求: 1.1, 1.2, 1.3, 3.1, 3.2, 3.3, 8.1, 8.2, 8.3, 8.4_

- [ ] 5. 前端司机端UI实现
  - 修改司机地图页面显示预约单标识
  - 添加预约单列表查看功能
  - _需求: 4.1, 4.2, 4.3, 4.4, 4.5, 7.1, 7.2, 7.3, 7.4, 7.5, 7.6_

- [ ] 5.1 更新司机订单通知显示
  - 修改DriverMap.vue中的订单通知组件
  - 添加预约单标识和预约时间显示
  - 区分实时单和预约单的视觉样式
  - _需求: 4.1, 4.2, 4.3_

- [ ] 5.2 实现预约单列表组件
  - 创建ScheduledOrderList.vue组件
  - 实现预约单列表显示和筛选功能
  - 添加预约单接单操作
  - _需求: 7.1, 7.2, 7.3, 7.4, 7.5_

- [ ] 5.3 扩展司机端store
  - 在driver.js中添加预约单相关状态管理
  - 实现预约单查询和接单方法
  - 添加预约单WebSocket消息处理
  - _需求: 4.4, 4.5, 7.1, 7.2, 7.3, 7.4, 7.5, 7.6_

- [ ] 6. 我的行程页面扩展
  - 在MyTrips.vue中添加预约单显示
  - 实现预约单管理功能
  - _需求: 6.1, 6.2, 6.3, 6.4, 6.5, 6.6_

- [ ] 6.1 扩展我的行程页面
  - 修改MyTrips.vue添加预约单标签页
  - 实现预约单列表显示和状态筛选
  - 添加预约单取消功能
  - _需求: 6.1, 6.2, 6.3, 6.4, 6.5, 6.6_

- [ ] 7. 系统集成和测试
  - 集成所有组件并进行端到端测试
  - 实现错误处理和异常恢复机制
  - _需求: 9.1, 9.2, 9.3, 9.4, 9.5, 9.6, 10.1, 10.2, 10.3, 10.4, 10.5, 10.6_

- [ ] 7.1 实现错误处理和日志记录
  - 添加预约单相关异常类和处理逻辑
  - 实现关键操作的日志记录
  - 添加系统监控和告警机制
  - _需求: 9.1, 9.2, 9.3, 9.4, 9.5, 9.6_

- [ ] 7.2 性能优化和压力测试
  - 优化数据库查询和索引
  - 实现批量操作和缓存机制
  - 进行并发场景的压力测试
  - _需求: 10.1, 10.2, 10.3, 10.4, 10.5, 10.6_

- [ ] 7.3 创建端到端测试用例
  - 编写完整的预约单流程测试
  - 测试各种冲突处理场景
  - 验证系统恢复和异常处理能力
  - _需求: 所有需求的综合验证_