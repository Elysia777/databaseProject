# 预约单功能需求文档

## 介绍

本功能允许乘客预约未来某个时间的用车服务，系统会在预约时间前20分钟开始向司机推送订单。当预约单激活时如果乘客正在进行实时单，系统会询问乘客是否取消或延后预约单。

## 需求

### 需求1：乘客创建预约单

**用户故事：** 作为乘客，我想要预约未来某个时间的用车服务，以便提前安排出行计划。

#### 验收标准

1. WHEN 乘客在地图页面选择"预约用车"选项 THEN 系统应显示时间选择器
2. WHEN 乘客选择预约时间 THEN 系统应验证时间不能是过去时间且至少30分钟后
3. WHEN 乘客提交预约单 THEN 系统应检查乘客是否有进行中的订单
4. IF 乘客有进行中订单 THEN 系统应提示"请完成当前订单后再预约"
5. WHEN 预约单创建成功 THEN 系统应保存订单类型为"RESERVATION"，状态为"PENDING"
6. WHEN 预约单创建成功 THEN 系统应显示预约确认信息和订单号

### 需求2：预约单定时激活机制

**用户故事：** 作为系统，我需要在预约时间前20分钟自动激活预约单，开始分配司机。

#### 验收标准

1. WHEN 系统检测到预约时间前20分钟 THEN 系统应直接激活预约单
2. WHEN 预约单激活 THEN 系统应开始向司机推送预约单
3. WHEN 向司机推送预约单 THEN 订单应明确标识为"预约订单"并显示预约时间
4. WHEN 预约单激活 THEN 系统应设置30分钟的超时时间，超时后自动取消
5. WHEN 预约单超时 THEN 系统应通知乘客"预约订单超时，未找到司机"

### 需求3：订单互斥检查

**用户故事：** 作为乘客，我希望系统确保我同时只能有一个订单，避免订单冲突。

#### 验收标准

1. WHEN 乘客尝试创建实时单 THEN 系统应检查是否有进行中的预约单
2. IF 乘客有进行中的预约单 THEN 系统应提示"您有预约订单，请先取消预约单或等待完成"
3. WHEN 乘客尝试创建预约单 THEN 系统应检查是否有进行中的实时单
4. IF 乘客有进行中的实时单 THEN 系统应提示"请完成当前订单后再预约"
5. WHEN 乘客有任何进行中订单 THEN 系统应禁用其他类型订单的创建按钮
6. WHEN 订单完成或取消 THEN 系统应立即允许创建新订单

### 需求4：司机端预约单显示

**用户故事：** 作为司机，我希望能清楚地识别预约单和实时单，了解预约时间信息。

#### 验收标准

1. WHEN 司机收到预约单推送 THEN 订单通知应显示"📅 预约订单"标识
2. WHEN 显示预约单 THEN 系统应显示预约时间信息
3. WHEN 司机查看订单详情 THEN 系统应显示"预约时间：YYYY-MM-DD HH:mm"
4. WHEN 司机接受预约单 THEN 后续流程应与实时单相同
5. WHEN 司机上线时 THEN 系统应显示可接的预约单列表
6. WHEN 预约单距离预约时间超过2小时 THEN 系统应在订单列表中显示但不主动推送

### 需求5：预约单状态管理

**用户故事：** 作为系统，我需要正确管理预约单的各种状态转换。

#### 验收标准

1. WHEN 创建预约单 THEN 状态应为"PENDING"，订单类型为"RESERVATION"
2. WHEN 预约单激活 THEN 状态应保持"PENDING"但开始分配司机
3. WHEN 司机接单 THEN 状态应变为"ASSIGNED"
4. WHEN 预约单超时无司机接单 THEN 状态应变为"CANCELLED"，取消原因为"超时无司机"
5. WHEN 乘客主动取消预约单 THEN 状态应变为"CANCELLED"，取消原因为"乘客取消"
6. WHEN 预约单延后 THEN 系统应更新scheduledTime字段并重新安排激活

### 需求6：预约单查询和管理

**用户故事：** 作为乘客，我希望能查看和管理我的预约单。

#### 验收标准

1. WHEN 乘客查看"我的行程" THEN 系统应显示所有预约单
2. WHEN 显示预约单列表 THEN 系统应显示预约时间、状态、起终点信息
3. WHEN 预约单状态为"PENDING" THEN 乘客应能取消预约单
4. WHEN 预约单已激活或司机已接单 THEN 乘客不能取消预约单
5. WHEN 乘客取消预约单 THEN 系统应发送确认消息
6. WHEN 预约单完成 THEN 系统应支持正常的支付和评价流程

### 需求7：司机端预约单查询

**用户故事：** 作为司机，我希望能主动查看可接的预约单。

#### 验收标准

1. WHEN 司机在地图页面 THEN 系统应提供"预约单"查看入口
2. WHEN 司机查看预约单列表 THEN 系统应显示2小时内的可接预约单
3. WHEN 显示预约单 THEN 系统应显示预约时间、距离、预估收入
4. WHEN 司机接受预约单 THEN 系统应从列表中移除该订单
5. WHEN 预约单被其他司机接受 THEN 系统应实时更新列表
6. WHEN 司机有当前订单 THEN 系统不应显示预约单推送但可查看列表

### 需求8：通知和消息系统

**用户故事：** 作为用户，我希望及时收到预约单相关的通知消息。

#### 验收标准

1. WHEN 预约单创建成功 THEN 乘客应收到确认通知
2. WHEN 预约单即将激活（前30分钟） THEN 乘客应收到提醒通知
3. WHEN 司机接受预约单 THEN 乘客应收到司机信息通知
4. WHEN 预约单发生冲突 THEN 乘客应立即收到冲突处理弹窗
5. WHEN 预约单被取消或延后 THEN 相关司机应收到取消通知
6. WHEN 预约单超时 THEN 乘客应收到超时取消通知

### 需求9：数据一致性和错误处理

**用户故事：** 作为系统，我需要确保预约单数据的一致性和正确的错误处理。

#### 验收标准

1. WHEN 系统重启 THEN 应能正确恢复所有预约单的定时任务
2. WHEN 网络异常 THEN 系统应能重试关键操作
3. WHEN 数据库异常 THEN 系统应记录错误日志并通知管理员
4. WHEN 乘客或司机离线 THEN 系统应正确处理消息推送失败
5. WHEN 时间同步异常 THEN 系统应使用服务器时间为准
6. WHEN 并发冲突 THEN 系统应使用数据库锁确保数据一致性

### 需求10：性能和扩展性

**用户故事：** 作为系统，我需要确保预约单功能的性能和扩展性。

#### 验收标准

1. WHEN 系统有大量预约单 THEN 定时任务应在1分钟内完成检查
2. WHEN 司机查询预约单 THEN 响应时间应小于2秒
3. WHEN 乘客创建预约单 THEN 响应时间应小于3秒
4. WHEN 系统推送预约单 THEN 应支持批量推送提高效率
5. WHEN 预约单数量增长 THEN 系统应支持分页查询
6. WHEN 高并发场景 THEN 系统应能正确处理订单分配竞争