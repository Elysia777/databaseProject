<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>当前订单API测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        button {
            background: #409EFF;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #66b1ff;
        }
        .result-display {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 14px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .status-good {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .status-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔍 当前订单API测试</h1>
        <p>测试新添加的获取司机当前订单接口</p>
    </div>

    <div class="container">
        <h3>测试接口</h3>
        <button onclick="testCurrentOrderAPI()">测试 /api/drivers/1/current-order</button>
        <button onclick="testCurrentOrderAPI(2)">测试 /api/drivers/2/current-order</button>
        <button onclick="testCurrentOrderAPI(999)">测试不存在的司机</button>
        
        <div id="result" class="result-display">
            点击按钮测试API...
        </div>
    </div>

    <div class="container">
        <h3>创建测试数据</h3>
        <button onclick="createTestOrder()">创建测试订单</button>
        <button onclick="acceptOrder()">司机接单</button>
        
        <div id="setupResult" class="result-display">
            点击按钮创建测试数据...
        </div>
    </div>

    <script>
        let testOrderId = null;

        function log(message, containerId = 'result') {
            const container = document.getElementById(containerId);
            const timestamp = new Date().toLocaleTimeString();
            container.textContent += `[${timestamp}] ${message}\\n`;
            container.scrollTop = container.scrollHeight;
            console.log(message);
        }

        async function testCurrentOrderAPI(driverId = 1) {
            const resultDiv = document.getElementById('result');
            resultDiv.textContent = '';
            resultDiv.className = 'result-display';
            
            log(`🔍 测试司机 ${driverId} 的当前订单API...`);
            
            try {
                const response = await fetch(`/api/drivers/${driverId}/current-order`);
                
                log(`响应状态: ${response.status}`);
                
                if (response.ok) {
                    const result = await response.json();
                    log(`响应数据: ${JSON.stringify(result, null, 2)}`);
                    
                    if (result.success) {
                        if (result.data) {
                            log('✅ 找到当前订单');
                            log(`订单ID: ${result.data.id}`);
                            log(`订单号: ${result.data.orderNumber}`);
                            log(`订单状态: ${result.data.status}`);
                            log(`上车地址: ${result.data.pickupAddress}`);
                            log(`目的地址: ${result.data.destinationAddress}`);
                            resultDiv.className = 'result-display status-good';
                        } else {
                            log('⚠️ 司机当前没有进行中的订单');
                            resultDiv.className = 'result-display status-good';
                        }
                    } else {
                        log(`❌ API返回错误: ${result.message}`);
                        resultDiv.className = 'result-display status-error';
                    }
                } else {
                    log(`❌ HTTP错误: ${response.status}`);
                    const errorText = await response.text();
                    log(`错误详情: ${errorText}`);
                    resultDiv.className = 'result-display status-error';
                }
            } catch (error) {
                log(`❌ 请求异常: ${error.message}`);
                resultDiv.className = 'result-display status-error';
            }
        }

        async function createTestOrder() {
            const resultDiv = document.getElementById('setupResult');
            resultDiv.textContent = '';
            resultDiv.className = 'result-display';
            
            log('📋 创建测试订单...', 'setupResult');
            
            try {
                const orderData = {
                    passengerId: 1,
                    pickupAddress: 'API测试订单 - 大连理工大学',
                    pickupLatitude: 39.044237,
                    pickupLongitude: 121.749849,
                    destinationAddress: '测试目的地 - 大连火车站',
                    destinationLatitude: 39.054237,
                    destinationLongitude: 121.759849
                };
                
                const response = await fetch('/api/orders/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(orderData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    testOrderId = result.data;
                    log(`✅ 订单创建成功，ID: ${testOrderId}`, 'setupResult');
                    resultDiv.className = 'result-display status-good';
                } else {
                    log(`❌ 订单创建失败: ${response.status}`, 'setupResult');
                    resultDiv.className = 'result-display status-error';
                }
            } catch (error) {
                log(`❌ 创建订单异常: ${error.message}`, 'setupResult');
                resultDiv.className = 'result-display status-error';
            }
        }

        async function acceptOrder() {
            if (!testOrderId) {
                log('❌ 请先创建测试订单', 'setupResult');
                return;
            }
            
            log('🚗 司机接单...', 'setupResult');
            
            try {
                const response = await fetch(`/api/drivers/1/accept-order/${testOrderId}`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    log('✅ 司机接单成功', 'setupResult');
                    log('现在可以测试当前订单API了', 'setupResult');
                    document.getElementById('setupResult').className = 'result-display status-good';
                } else {
                    log(`❌ 司机接单失败: ${response.status}`, 'setupResult');
                    document.getElementById('setupResult').className = 'result-display status-error';
                }
            } catch (error) {
                log(`❌ 接单异常: ${error.message}`, 'setupResult');
                document.getElementById('setupResult').className = 'result-display status-error';
            }
        }

        // 页面加载时的说明
        window.onload = function() {
            log('API测试页面加载完成');
            log('');
            log('测试步骤:');
            log('1. 先创建测试订单');
            log('2. 司机接单');
            log('3. 测试当前订单API');
            log('');
            log('或者直接测试API（如果已有数据）');
        };
    </script>
</body>
</html>