<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å½“å‰è®¢å•APIæµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        button {
            background: #409EFF;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #66b1ff;
        }
        .result-display {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 14px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .status-good {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .status-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” å½“å‰è®¢å•APIæµ‹è¯•</h1>
        <p>æµ‹è¯•æ–°æ·»åŠ çš„è·å–å¸æœºå½“å‰è®¢å•æ¥å£</p>
    </div>

    <div class="container">
        <h3>æµ‹è¯•æ¥å£</h3>
        <button onclick="testCurrentOrderAPI()">æµ‹è¯• /api/drivers/1/current-order</button>
        <button onclick="testCurrentOrderAPI(2)">æµ‹è¯• /api/drivers/2/current-order</button>
        <button onclick="testCurrentOrderAPI(999)">æµ‹è¯•ä¸å­˜åœ¨çš„å¸æœº</button>
        
        <div id="result" class="result-display">
            ç‚¹å‡»æŒ‰é’®æµ‹è¯•API...
        </div>
    </div>

    <div class="container">
        <h3>åˆ›å»ºæµ‹è¯•æ•°æ®</h3>
        <button onclick="createTestOrder()">åˆ›å»ºæµ‹è¯•è®¢å•</button>
        <button onclick="acceptOrder()">å¸æœºæ¥å•</button>
        
        <div id="setupResult" class="result-display">
            ç‚¹å‡»æŒ‰é’®åˆ›å»ºæµ‹è¯•æ•°æ®...
        </div>
    </div>

    <script>
        let testOrderId = null;

        function log(message, containerId = 'result') {
            const container = document.getElementById(containerId);
            const timestamp = new Date().toLocaleTimeString();
            container.textContent += `[${timestamp}] ${message}\\n`;
            container.scrollTop = container.scrollHeight;
            console.log(message);
        }

        async function testCurrentOrderAPI(driverId = 1) {
            const resultDiv = document.getElementById('result');
            resultDiv.textContent = '';
            resultDiv.className = 'result-display';
            
            log(`ğŸ” æµ‹è¯•å¸æœº ${driverId} çš„å½“å‰è®¢å•API...`);
            
            try {
                const response = await fetch(`/api/drivers/${driverId}/current-order`);
                
                log(`å“åº”çŠ¶æ€: ${response.status}`);
                
                if (response.ok) {
                    const result = await response.json();
                    log(`å“åº”æ•°æ®: ${JSON.stringify(result, null, 2)}`);
                    
                    if (result.success) {
                        if (result.data) {
                            log('âœ… æ‰¾åˆ°å½“å‰è®¢å•');
                            log(`è®¢å•ID: ${result.data.id}`);
                            log(`è®¢å•å·: ${result.data.orderNumber}`);
                            log(`è®¢å•çŠ¶æ€: ${result.data.status}`);
                            log(`ä¸Šè½¦åœ°å€: ${result.data.pickupAddress}`);
                            log(`ç›®çš„åœ°å€: ${result.data.destinationAddress}`);
                            resultDiv.className = 'result-display status-good';
                        } else {
                            log('âš ï¸ å¸æœºå½“å‰æ²¡æœ‰è¿›è¡Œä¸­çš„è®¢å•');
                            resultDiv.className = 'result-display status-good';
                        }
                    } else {
                        log(`âŒ APIè¿”å›é”™è¯¯: ${result.message}`);
                        resultDiv.className = 'result-display status-error';
                    }
                } else {
                    log(`âŒ HTTPé”™è¯¯: ${response.status}`);
                    const errorText = await response.text();
                    log(`é”™è¯¯è¯¦æƒ…: ${errorText}`);
                    resultDiv.className = 'result-display status-error';
                }
            } catch (error) {
                log(`âŒ è¯·æ±‚å¼‚å¸¸: ${error.message}`);
                resultDiv.className = 'result-display status-error';
            }
        }

        async function createTestOrder() {
            const resultDiv = document.getElementById('setupResult');
            resultDiv.textContent = '';
            resultDiv.className = 'result-display';
            
            log('ğŸ“‹ åˆ›å»ºæµ‹è¯•è®¢å•...', 'setupResult');
            
            try {
                const orderData = {
                    passengerId: 1,
                    pickupAddress: 'APIæµ‹è¯•è®¢å• - å¤§è¿ç†å·¥å¤§å­¦',
                    pickupLatitude: 39.044237,
                    pickupLongitude: 121.749849,
                    destinationAddress: 'æµ‹è¯•ç›®çš„åœ° - å¤§è¿ç«è½¦ç«™',
                    destinationLatitude: 39.054237,
                    destinationLongitude: 121.759849
                };
                
                const response = await fetch('/api/orders/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(orderData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    testOrderId = result.data;
                    log(`âœ… è®¢å•åˆ›å»ºæˆåŠŸï¼ŒID: ${testOrderId}`, 'setupResult');
                    resultDiv.className = 'result-display status-good';
                } else {
                    log(`âŒ è®¢å•åˆ›å»ºå¤±è´¥: ${response.status}`, 'setupResult');
                    resultDiv.className = 'result-display status-error';
                }
            } catch (error) {
                log(`âŒ åˆ›å»ºè®¢å•å¼‚å¸¸: ${error.message}`, 'setupResult');
                resultDiv.className = 'result-display status-error';
            }
        }

        async function acceptOrder() {
            if (!testOrderId) {
                log('âŒ è¯·å…ˆåˆ›å»ºæµ‹è¯•è®¢å•', 'setupResult');
                return;
            }
            
            log('ğŸš— å¸æœºæ¥å•...', 'setupResult');
            
            try {
                const response = await fetch(`/api/drivers/1/accept-order/${testOrderId}`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    log('âœ… å¸æœºæ¥å•æˆåŠŸ', 'setupResult');
                    log('ç°åœ¨å¯ä»¥æµ‹è¯•å½“å‰è®¢å•APIäº†', 'setupResult');
                    document.getElementById('setupResult').className = 'result-display status-good';
                } else {
                    log(`âŒ å¸æœºæ¥å•å¤±è´¥: ${response.status}`, 'setupResult');
                    document.getElementById('setupResult').className = 'result-display status-error';
                }
            } catch (error) {
                log(`âŒ æ¥å•å¼‚å¸¸: ${error.message}`, 'setupResult');
                document.getElementById('setupResult').className = 'result-display status-error';
            }
        }

        // é¡µé¢åŠ è½½æ—¶çš„è¯´æ˜
        window.onload = function() {
            log('APIæµ‹è¯•é¡µé¢åŠ è½½å®Œæˆ');
            log('');
            log('æµ‹è¯•æ­¥éª¤:');
            log('1. å…ˆåˆ›å»ºæµ‹è¯•è®¢å•');
            log('2. å¸æœºæ¥å•');
            log('3. æµ‹è¯•å½“å‰è®¢å•API');
            log('');
            log('æˆ–è€…ç›´æ¥æµ‹è¯•APIï¼ˆå¦‚æœå·²æœ‰æ•°æ®ï¼‰');
        };
    </script>
</body>
</html>