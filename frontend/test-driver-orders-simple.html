<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>司机订单查询测试（简化版）</title>
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            padding: 24px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e4e7ed;
            border-radius: 8px;
        }
        .test-title {
            font-size: 18px;
            font-weight: 600;
            color: #303133;
            margin-bottom: 16px;
        }
        .test-controls {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }
        .test-result {
            background: #f8f9fa;
            border-radius: 4px;
            padding: 12px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .success { color: #67c23a; }
        .error { color: #f56c6c; }
        .info { color: #409eff; }
    </style>
</head>
<body>
    <div id="app">
        <div class="container">
            <h1>司机订单查询测试（简化版）</h1>
            
            <!-- 基础查询测试 -->
            <div class="test-section">
                <div class="test-title">1. 基础订单查询</div>
                <div class="test-controls">
                    <el-input v-model="driverId" placeholder="司机ID" style="width: 120px;"></el-input>
                    <el-button @click="testBasicQuery" type="primary">基础查询</el-button>
                </div>
                <div class="test-result">{{ basicResult }}</div>
            </div>

            <!-- 状态筛选测试 -->
            <div class="test-section">
                <div class="test-title">2. 状态筛选查询</div>
                <div class="test-controls">
                    <el-select v-model="statusFilter" placeholder="选择状态" style="width: 150px;">
                        <el-option label="已完成" value="COMPLETED"></el-option>
                        <el-option label="已取消" value="CANCELLED"></el-option>
                        <el-option label="进行中" value="IN_PROGRESS"></el-option>
                        <el-option label="已接单" value="ASSIGNED"></el-option>
                    </el-select>
                    <el-button @click="testStatusFilter" type="primary">状态筛选</el-button>
                </div>
                <div class="test-result">{{ statusResult }}</div>
            </div>

            <!-- 日期范围查询测试 -->
            <div class="test-section">
                <div class="test-title">3. 日期范围查询</div>
                <div class="test-controls">
                    <el-date-picker
                        v-model="dateRange"
                        type="daterange"
                        range-separator="至"
                        start-placeholder="开始日期"
                        end-placeholder="结束日期"
                        format="YYYY-MM-DD"
                        value-format="YYYY-MM-DD"
                        style="width: 300px;">
                    </el-date-picker>
                    <el-button @click="testDateRange" type="primary">日期查询</el-button>
                </div>
                <div class="test-result">{{ dateResult }}</div>
            </div>

            <!-- 分页测试 -->
            <div class="test-section">
                <div class="test-title">4. 分页测试</div>
                <div class="test-controls">
                    <el-input-number v-model="pageSize" :min="5" :max="50" style="width: 120px;"></el-input-number>
                    <span>每页条数</span>
                    <el-button @click="testPagination" type="primary">分页测试</el-button>
                </div>
                <div class="test-result">{{ paginationResult }}</div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/element-plus/dist/index.full.js"></script>
    <script>
        const { createApp, ref } = Vue;
        
        createApp({
            setup() {
                // 测试数据
                const driverId = ref('1');
                const statusFilter = ref('');
                const dateRange = ref(null);
                const pageSize = ref(10);
                
                // 测试结果
                const basicResult = ref('等待测试...');
                const statusResult = ref('等待测试...');
                const dateResult = ref('等待测试...');
                const paginationResult = ref('等待测试...');

                // 通用请求函数
                const makeRequest = async (params = {}) => {
                    try {
                        const url = new URL(`/api/drivers/${driverId.value}/orders`, window.location.origin);
                        Object.keys(params).forEach(key => {
                            if (params[key] !== null && params[key] !== undefined && params[key] !== '') {
                                url.searchParams.append(key, params[key]);
                            }
                        });

                        console.log('请求URL:', url.toString());
                        
                        const response = await fetch(url);
                        const result = await response.json();
                        
                        return {
                            success: result.code === 200,
                            data: result.data,
                            message: result.message,
                            url: url.toString()
                        };
                    } catch (error) {
                        return {
                            success: false,
                            error: error.message,
                            url: '请求失败'
                        };
                    }
                };

                // 格式化结果
                const formatResult = (result) => {
                    if (!result.success) {
                        return `❌ 请求失败: ${result.error || result.message}\n请求URL: ${result.url}`;
                    }
                    
                    const data = result.data;
                    let output = `✅ 请求成功\n请求URL: ${result.url}\n\n`;
                    
                    if (Array.isArray(data)) {
                        output += `📋 查询到 ${data.length} 条记录\n\n`;
                        
                        if (data.length > 0) {
                            // 统计信息
                            const completed = data.filter(order => order.status === 'COMPLETED').length;
                            const totalEarnings = data
                                .filter(order => order.status === 'COMPLETED')
                                .reduce((sum, order) => sum + (parseFloat(order.actualFare || order.estimatedFare || 0)), 0);
                            
                            output += `📊 统计信息:\n`;
                            output += `- 已完成订单: ${completed}\n`;
                            output += `- 总收入: ¥${totalEarnings.toFixed(2)}\n\n`;
                            
                            output += `📋 订单列表:\n`;
                            data.slice(0, 5).forEach((order, index) => {
                                output += `${index + 1}. ${order.orderNumber} - ${order.status}\n`;
                                output += `   费用: ¥${order.actualFare || order.estimatedFare || '0'}\n`;
                                output += `   时间: ${order.createdAt}\n\n`;
                            });
                            
                            if (data.length > 5) {
                                output += `... 还有 ${data.length - 5} 条记录\n`;
                            }
                        }
                    }
                    
                    return output;
                };

                // 测试函数
                const testBasicQuery = async () => {
                    basicResult.value = '🔄 正在查询...';
                    const result = await makeRequest({ page: 1, size: pageSize.value });
                    basicResult.value = formatResult(result);
                };

                const testStatusFilter = async () => {
                    statusResult.value = '🔄 正在查询...';
                    const result = await makeRequest({ 
                        status: statusFilter.value,
                        page: 1, 
                        size: pageSize.value 
                    });
                    statusResult.value = formatResult(result);
                };

                const testDateRange = async () => {
                    dateResult.value = '🔄 正在查询...';
                    const params = { page: 1, size: pageSize.value };
                    if (dateRange.value && dateRange.value.length === 2) {
                        params.startDate = dateRange.value[0];
                        params.endDate = dateRange.value[1];
                    }
                    const result = await makeRequest(params);
                    dateResult.value = formatResult(result);
                };

                const testPagination = async () => {
                    paginationResult.value = '🔄 正在测试分页...';
                    let output = '📄 分页测试结果:\n\n';
                    
                    for (let page = 1; page <= 2; page++) {
                        const result = await makeRequest({ page, size: pageSize.value });
                        output += `第 ${page} 页:\n`;
                        if (result.success && Array.isArray(result.data)) {
                            output += `- 记录数: ${result.data.length}\n\n`;
                        } else {
                            output += `- 查询失败或无数据\n\n`;
                        }
                    }
                    
                    paginationResult.value = output;
                };

                return {
                    driverId,
                    statusFilter,
                    dateRange,
                    pageSize,
                    basicResult,
                    statusResult,
                    dateResult,
                    paginationResult,
                    testBasicQuery,
                    testStatusFilter,
                    testDateRange,
                    testPagination
                };
            }
        }).use(ElementPlus).mount('#app');
    </script>
</body>
</html>