<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>管理员密码重置工具</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .section h3 {
            margin-top: 0;
            color: #333;
        }
        .password-info {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
        .password-info h4 {
            color: #856404;
            margin-top: 0;
        }
        .sql-code {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            font-family: monospace;
            font-size: 12px;
            margin: 10px 0;
            white-space: pre-wrap;
        }
        .test-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .test-btn:hover {
            background: #0056b3;
        }
        .test-btn.success {
            background: #28a745;
        }
        .test-btn.danger {
            background: #dc3545;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin: 15px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .warning { color: #ffc107; }
        .info { color: #17a2b8; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔑 管理员密码重置工具</h1>
        
        <div class="password-info">
            <h4>⚠️ 密码问题说明</h4>
            <p>数据库中的管理员密码使用BCrypt加密，当前加密的密码哈希值对应的明文密码可能不是"123456"。</p>
            <p>以下提供几种解决方案：</p>
        </div>

        <div class="section">
            <h3>🔧 解决方案1：直接重置数据库密码</h3>
            <p>在数据库中执行以下SQL语句，将管理员密码重置为"123456"：</p>
            <div class="sql-code">-- 重置admin用户密码为123456
UPDATE users SET password = '$2a$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2uheWG/igi.' 
WHERE username = 'admin';

-- 重置superadmin用户密码为123456  
UPDATE users SET password = '$2a$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2uheWG/igi.' 
WHERE username = 'superadmin';</div>
            <button class="test-btn" onclick="copySQL()">复制SQL语句</button>
        </div>

        <div class="section">
            <h3>🧪 解决方案2：测试现有密码</h3>
            <p>尝试使用常见的默认密码登录：</p>
            <button class="test-btn" onclick="testPassword('admin', '123456')">测试 admin/123456</button>
            <button class="test-btn" onclick="testPassword('admin', 'admin')">测试 admin/admin</button>
            <button class="test-btn" onclick="testPassword('admin', 'password')">测试 admin/password</button>
            <button class="test-btn" onclick="testPassword('superadmin', '123456')">测试 superadmin/123456</button>
            <button class="test-btn" onclick="testPassword('superadmin', 'admin')">测试 superadmin/admin</button>
            
            <div id="passwordTestResult" class="log"></div>
        </div>

        <div class="section">
            <h3>🔍 解决方案3：检查用户数据</h3>
            <button class="test-btn" onclick="checkAdminUsers()">检查管理员用户数据</button>
            <button class="test-btn" onclick="checkUserTable()">检查users表数据</button>
            
            <div id="userCheckResult" class="log"></div>
        </div>

        <div class="section">
            <h3>📝 测试日志</h3>
            <button class="test-btn" onclick="clearLog()">清空日志</button>
            <div id="testLog" class="log"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8080';
        
        function log(message, type = 'info') {
            const logDiv = document.getElementById('testLog');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : type === 'info' ? 'info' : '';
            logDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('testLog').innerHTML = '';
            document.getElementById('passwordTestResult').innerHTML = '';
            document.getElementById('userCheckResult').innerHTML = '';
        }

        // 复制SQL语句
        function copySQL() {
            const sqlText = `-- 重置admin用户密码为123456
UPDATE users SET password = '$2a$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2uheWG/igi.' 
WHERE username = 'admin';

-- 重置superadmin用户密码为123456  
UPDATE users SET password = '$2a$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2uheWG/igi.' 
WHERE username = 'superadmin';`;

            navigator.clipboard.writeText(sqlText).then(() => {
                log('✅ SQL语句已复制到剪贴板', 'success');
            }).catch(() => {
                log('❌ 复制失败，请手动复制', 'error');
            });
        }

        // 测试密码
        async function testPassword(username, password) {
            log(`测试登录: ${username}/${password}`, 'info');
            
            try {
                const response = await fetch(`${API_BASE}/api/admin/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        username: username,
                        password: password
                    })
                });

                const result = await response.json();
                
                if (response.ok && result.code === 200) {
                    log(`✅ 登录成功: ${username}/${password}`, 'success');
                    document.getElementById('passwordTestResult').innerHTML += `
                        <div class="success">
                            <strong>登录成功!</strong><br>
                            用户名: ${username}<br>
                            密码: ${password}<br>
                            管理员: ${result.data.adminInfo.realName}<br>
                            角色: ${result.data.adminInfo.roleName}<br>
                        </div>
                    `;
                } else {
                    log(`❌ 登录失败: ${username}/${password} - ${result.message}`, 'error');
                    document.getElementById('passwordTestResult').innerHTML += `
                        <div class="error">
                            登录失败: ${username}/${password}<br>
                            错误: ${result.message}<br>
                        </div>
                    `;
                }
            } catch (error) {
                log(`❌ 网络错误: ${error.message}`, 'error');
            }
        }

        // 检查管理员用户
        async function checkAdminUsers() {
            log('检查管理员用户数据...', 'info');
            
            try {
                const response = await fetch(`${API_BASE}/api/users`);
                const result = await response.json();
                
                if (response.ok && result.code === 200) {
                    const adminUsers = result.data.filter(user => user.userType === 'ADMIN');
                    log(`找到 ${adminUsers.length} 个管理员用户`, 'success');
                    
                    document.getElementById('userCheckResult').innerHTML = `
                        <div class="info">
                            <strong>管理员用户列表:</strong><br>
                            ${adminUsers.map(user => 
                                `• ID: ${user.id}, 用户名: ${user.username}, 姓名: ${user.realName}, 状态: ${user.status}`
                            ).join('<br>')}
                        </div>
                    `;
                } else {
                    log(`❌ 获取用户数据失败: ${result.message}`, 'error');
                }
            } catch (error) {
                log(`❌ 检查用户数据异常: ${error.message}`, 'error');
            }
        }

        // 检查users表数据
        async function checkUserTable() {
            log('检查users表数据...', 'info');
            
            // 这里可以添加更详细的用户表检查逻辑
            log('⚠️ 需要数据库直接访问权限来检查详细的用户表数据', 'warning');
            
            document.getElementById('userCheckResult').innerHTML += `
                <div class="warning">
                    <strong>数据库密码哈希信息:</strong><br>
                    当前数据库中的密码哈希: $2a$10$N.zmdr9k7uOCQb376NoUnuTJ8iAt6Z5EHsM8lE9lBOsl7iKTVEFDa<br>
                    正确的123456哈希应该是: $2a$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2uheWG/igi.<br>
                    <br>
                    <strong>建议操作:</strong><br>
                    1. 连接到MySQL数据库<br>
                    2. 执行上面的UPDATE语句重置密码<br>
                    3. 使用 admin/123456 或 superadmin/123456 登录<br>
                </div>
            `;
        }

        // 页面加载时初始化
        window.onload = function() {
            log('管理员密码重置工具已加载', 'info');
            log('当前数据库中的密码哈希可能不对应123456', 'warning');
            log('请使用上述解决方案重置密码', 'info');
        };
    </script>
</body>
</html>