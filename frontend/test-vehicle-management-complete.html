<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>车辆管理完整测试</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/element-plus/dist/index.full.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css">
    <style>
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #333;
            border-bottom: 2px solid #409EFF;
            padding-bottom: 8px;
        }
        .test-result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
        }
        .success {
            background: #f0f9ff;
            border: 1px solid #67c23a;
            color: #67c23a;
        }
        .error {
            background: #fef0f0;
            border: 1px solid #f56c6c;
            color: #f56c6c;
        }
        .warning {
            background: #fdf6ec;
            border: 1px solid #e6a23c;
            color: #e6a23c;
        }
        .data-display {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .button-group {
            margin: 15px 0;
        }
        .button-group button {
            margin-right: 10px;
            margin-bottom: 10px;
        }
        .vehicle-card {
            border: 1px solid #e4e7ed;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            background: #fafafa;
        }
        .vehicle-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .vehicle-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="container">
            <h1>车辆管理完整测试</h1>
            
            <!-- 1. API连接测试 -->
            <div class="test-section">
                <div class="section-title">1. API连接测试</div>
                <div class="button-group">
                    <el-button type="primary" @click="testVehicleAPI">测试车辆API</el-button>
                    <el-button @click="testDriverAPI">测试司机API</el-button>
                </div>
                <div v-if="apiResult" class="test-result" :class="apiResult.type">
                    {{ apiResult.message }}
                </div>
                <div v-if="apiData" class="data-display">{{ JSON.stringify(apiData, null, 2) }}</div>
            </div>

            <!-- 2. 车辆数据展示 -->
            <div class="test-section">
                <div class="section-title">2. 车辆数据展示</div>
                <div class="button-group">
                    <el-button type="primary" @click="loadVehicles">加载车辆数据</el-button>
                    <el-button @click="refreshVehicles">刷新数据</el-button>
                </div>
                <div v-if="vehicleResult" class="test-result" :class="vehicleResult.type">
                    {{ vehicleResult.message }}
                </div>
                
                <div v-if="vehicles.length > 0">
                    <h4>车辆列表 ({{ vehicles.length }}辆)</h4>
                    <div v-for="vehicle in vehicles.slice(0, 5)" :key="vehicle.id" class="vehicle-card">
                        <div class="vehicle-header">
                            <h5>{{ vehicle.plateNumber }} - {{ vehicle.brand }} {{ vehicle.model }}</h5>
                            <el-tag :type="getStatusTagType(vehicle.status)">
                                {{ getStatusText(vehicle.status) }}
                            </el-tag>
                        </div>
                        <div class="vehicle-info">
                            <div><strong>司机:</strong> {{ vehicle.driverName || '未分配' }}</div>
                            <div><strong>颜色:</strong> {{ vehicle.color }}</div>
                            <div><strong>类型:</strong> {{ vehicle.vehicleType }}</div>
                            <div><strong>激活状态:</strong> {{ vehicle.isActive ? '是' : '否' }}</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 3. 车辆操作测试 -->
            <div class="test-section">
                <div class="section-title">3. 车辆操作测试</div>
                <div class="button-group">
                    <el-button type="success" @click="testApproveVehicle">测试审核通过</el-button>
                    <el-button type="warning" @click="testRejectVehicle">测试拒绝车辆</el-button>
                    <el-button type="danger" @click="testDeactivateVehicle">测试停用车辆</el-button>
                </div>
                <div v-if="operationResult" class="test-result" :class="operationResult.type">
                    {{ operationResult.message }}
                </div>
            </div>

            <!-- 4. 添加车辆测试 -->
            <div class="test-section">
                <div class="section-title">4. 添加车辆测试</div>
                <el-form :model="newVehicle" label-width="100px" style="max-width: 600px;">
                    <el-form-item label="车牌号">
                        <el-input v-model="newVehicle.plateNumber" placeholder="请输入车牌号" />
                    </el-form-item>
                    <el-form-item label="品牌">
                        <el-input v-model="newVehicle.brand" placeholder="请输入品牌" />
                    </el-form-item>
                    <el-form-item label="型号">
                        <el-input v-model="newVehicle.model" placeholder="请输入型号" />
                    </el-form-item>
                    <el-form-item label="颜色">
                        <el-input v-model="newVehicle.color" placeholder="请输入颜色" />
                    </el-form-item>
                    <el-form-item label="车辆类型">
                        <el-select v-model="newVehicle.vehicleType" placeholder="请选择类型">
                            <el-option label="轿车" value="SEDAN" />
                            <el-option label="SUV" value="SUV" />
                            <el-option label="MPV" value="MPV" />
                            <el-option label="其他" value="OTHER" />
                        </el-select>
                    </el-form-item>
                    <el-form-item label="司机ID">
                        <el-input v-model="newVehicle.driverId" type="number" placeholder="请输入司机ID" />
                    </el-form-item>
                </el-form>
                <div class="button-group">
                    <el-button type="primary" @click="addVehicle" :loading="adding">添加车辆</el-button>
                    <el-button @click="fillSampleVehicle">填充示例数据</el-button>
                    <el-button @click="clearVehicleForm">清空表单</el-button>
                </div>
                <div v-if="addResult" class="test-result" :class="addResult.type">
                    {{ addResult.message }}
                </div>
            </div>

            <!-- 5. 统计信息测试 -->
            <div class="test-section">
                <div class="section-title">5. 统计信息测试</div>
                <div class="button-group">
                    <el-button type="primary" @click="calculateStats">计算统计信息</el-button>
                </div>
                <div v-if="statsResult" class="test-result" :class="statsResult.type">
                    {{ statsResult.message }}
                </div>
                <div v-if="stats" class="data-display">{{ JSON.stringify(stats, null, 2) }}</div>
            </div>

            <!-- 6. 完整功能测试 -->
            <div class="test-section">
                <div class="section-title">6. 完整功能测试</div>
                <div class="button-group">
                    <el-button type="success" @click="runCompleteTest" :loading="testing">运行完整测试</el-button>
                    <el-button @click="clearAllResults">清除所有结果</el-button>
                </div>
                <div v-if="completeResult" class="test-result" :class="completeResult.type">
                    {{ completeResult.message }}
                </div>
                <div v-if="completeData" class="data-display">{{ JSON.stringify(completeData, null, 2) }}</div>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, reactive } = Vue;
        const { ElMessage } = ElementPlus;

        createApp({
            setup() {
                // 响应式数据
                const apiResult = ref(null);
                const apiData = ref(null);
                const vehicleResult = ref(null);
                const vehicles = ref([]);
                const operationResult = ref(null);
                const addResult = ref(null);
                const statsResult = ref(null);
                const stats = ref(null);
                const completeResult = ref(null);
                const completeData = ref(null);
                const adding = ref(false);
                const testing = ref(false);

                // 新车辆表单
                const newVehicle = reactive({
                    plateNumber: '',
                    brand: '',
                    model: '',
                    color: '',
                    vehicleType: '',
                    driverId: ''
                });

                // 测试车辆API
                const testVehicleAPI = async () => {
                    try {
                        apiResult.value = { type: 'warning', message: '正在测试车辆API...' };
                        
                        const response = await fetch('/api/vehicles/all');
                        const data = await response.json();
                        
                        apiData.value = {
                            status: response.status,
                            success: data.success || data.code === 200,
                            dataCount: data.data ? data.data.length : 0,
                            sampleData: data.data ? data.data.slice(0, 2) : null
                        };
                        
                        if (response.ok && (data.success || data.code === 200)) {
                            apiResult.value = { 
                                type: 'success', 
                                message: `车辆API测试成功！返回${apiData.value.dataCount}条数据` 
                            };
                        } else {
                            apiResult.value = { 
                                type: 'error', 
                                message: `车辆API测试失败：${data.message || '未知错误'}` 
                            };
                        }
                    } catch (error) {
                        apiResult.value = { type: 'error', message: '车辆API测试失败: ' + error.message };
                        console.error('车辆API测试失败:', error);
                    }
                };

                // 测试司机API
                const testDriverAPI = async () => {
                    try {
                        apiResult.value = { type: 'warning', message: '正在测试司机API...' };
                        
                        const response = await fetch('/api/drivers');
                        const data = await response.json();
                        
                        apiData.value = {
                            status: response.status,
                            success: data.success || data.code === 200,
                            dataCount: data.data ? data.data.length : 0,
                            sampleData: data.data ? data.data.slice(0, 2) : null
                        };
                        
                        if (response.ok && (data.success || data.code === 200)) {
                            apiResult.value = { 
                                type: 'success', 
                                message: `司机API测试成功！返回${apiData.value.dataCount}条数据` 
                            };
                        } else {
                            apiResult.value = { 
                                type: 'error', 
                                message: `司机API测试失败：${data.message || '未知错误'}` 
                            };
                        }
                    } catch (error) {
                        apiResult.value = { type: 'error', message: '司机API测试失败: ' + error.message };
                        console.error('司机API测试失败:', error);
                    }
                };

                // 加载车辆数据
                const loadVehicles = async () => {
                    try {
                        vehicleResult.value = { type: 'warning', message: '正在加载车辆数据...' };
                        
                        const response = await fetch('/api/vehicles/all');
                        const data = await response.json();
                        
                        if (response.ok && (data.success || data.code === 200)) {
                            vehicles.value = data.data || [];
                            vehicleResult.value = { 
                                type: 'success', 
                                message: `成功加载${vehicles.value.length}辆车辆` 
                            };
                        } else {
                            vehicleResult.value = { 
                                type: 'error', 
                                message: `加载车辆失败：${data.message || '未知错误'}` 
                            };
                        }
                    } catch (error) {
                        vehicleResult.value = { type: 'error', message: '加载车辆失败: ' + error.message };
                        console.error('加载车辆失败:', error);
                    }
                };

                // 刷新车辆数据
                const refreshVehicles = () => {
                    loadVehicles();
                    ElMessage.success('正在刷新车辆数据...');
                };

                // 测试审核通过
                const testApproveVehicle = async () => {
                    if (vehicles.value.length === 0) {
                        ElMessage.warning('请先加载车辆数据');
                        return;
                    }
                    
                    const pendingVehicle = vehicles.value.find(v => v.status === 'PENDING');
                    if (!pendingVehicle) {
                        operationResult.value = { 
                            type: 'warning', 
                            message: '没有找到待审核的车辆，无法测试审核功能' 
                        };
                        return;
                    }
                    
                    try {
                        operationResult.value = { type: 'warning', message: '正在测试审核通过...' };
                        
                        const response = await fetch(`/api/vehicles/${pendingVehicle.id}/approve`, {
                            method: 'POST'
                        });
                        
                        const result = await response.json();
                        
                        if (result.success || result.code === 200) {
                            operationResult.value = { 
                                type: 'success', 
                                message: `车辆 ${pendingVehicle.plateNumber} 审核通过测试成功` 
                            };
                            loadVehicles(); // 刷新数据
                        } else {
                            operationResult.value = { 
                                type: 'error', 
                                message: `审核通过测试失败：${result.message}` 
                            };
                        }
                    } catch (error) {
                        operationResult.value = { type: 'error', message: '审核通过测试失败: ' + error.message };
                    }
                };

                // 测试拒绝车辆
                const testRejectVehicle = async () => {
                    if (vehicles.value.length === 0) {
                        ElMessage.warning('请先加载车辆数据');
                        return;
                    }
                    
                    const pendingVehicle = vehicles.value.find(v => v.status === 'PENDING');
                    if (!pendingVehicle) {
                        operationResult.value = { 
                            type: 'warning', 
                            message: '没有找到待审核的车辆，无法测试拒绝功能' 
                        };
                        return;
                    }
                    
                    try {
                        operationResult.value = { type: 'warning', message: '正在测试拒绝车辆...' };
                        
                        const response = await fetch(`/api/vehicles/${pendingVehicle.id}/reject`, {
                            method: 'POST'
                        });
                        
                        const result = await response.json();
                        
                        if (result.success || result.code === 200) {
                            operationResult.value = { 
                                type: 'success', 
                                message: `车辆 ${pendingVehicle.plateNumber} 拒绝测试成功` 
                            };
                            loadVehicles(); // 刷新数据
                        } else {
                            operationResult.value = { 
                                type: 'error', 
                                message: `拒绝车辆测试失败：${result.message}` 
                            };
                        }
                    } catch (error) {
                        operationResult.value = { type: 'error', message: '拒绝车辆测试失败: ' + error.message };
                    }
                };

                // 测试停用车辆
                const testDeactivateVehicle = async () => {
                    if (vehicles.value.length === 0) {
                        ElMessage.warning('请先加载车辆数据');
                        return;
                    }
                    
                    const activeVehicle = vehicles.value.find(v => v.status === 'ACTIVE');
                    if (!activeVehicle) {
                        operationResult.value = { 
                            type: 'warning', 
                            message: '没有找到活跃的车辆，无法测试停用功能' 
                        };
                        return;
                    }
                    
                    try {
                        operationResult.value = { type: 'warning', message: '正在测试停用车辆...' };
                        
                        const response = await fetch(`/api/vehicles/${activeVehicle.id}/deactivate`, {
                            method: 'POST'
                        });
                        
                        const result = await response.json();
                        
                        if (result.success || result.code === 200) {
                            operationResult.value = { 
                                type: 'success', 
                                message: `车辆 ${activeVehicle.plateNumber} 停用测试成功` 
                            };
                            loadVehicles(); // 刷新数据
                        } else {
                            operationResult.value = { 
                                type: 'error', 
                                message: `停用车辆测试失败：${result.message}` 
                            };
                        }
                    } catch (error) {
                        operationResult.value = { type: 'error', message: '停用车辆测试失败: ' + error.message };
                    }
                };

                // 填充示例数据
                const fillSampleVehicle = () => {
                    Object.assign(newVehicle, {
                        plateNumber: '京A' + Math.random().toString().substr(2, 5),
                        brand: '丰田',
                        model: '凯美瑞',
                        color: '白色',
                        vehicleType: 'SEDAN',
                        driverId: '1'
                    });
                    ElMessage.success('已填充示例数据');
                };

                // 清空车辆表单
                const clearVehicleForm = () => {
                    Object.assign(newVehicle, {
                        plateNumber: '',
                        brand: '',
                        model: '',
                        color: '',
                        vehicleType: '',
                        driverId: ''
                    });
                    ElMessage.success('表单已清空');
                };

                // 添加车辆
                const addVehicle = async () => {
                    if (!newVehicle.plateNumber || !newVehicle.brand || !newVehicle.model) {
                        ElMessage.warning('请填写完整的车辆信息');
                        return;
                    }
                    
                    try {
                        adding.value = true;
                        addResult.value = { type: 'warning', message: '正在添加车辆...' };
                        
                        const response = await fetch('/api/vehicles', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                ...newVehicle,
                                driverId: parseInt(newVehicle.driverId)
                            })
                        });
                        
                        const result = await response.json();
                        
                        if (result.success || result.code === 200) {
                            addResult.value = { 
                                type: 'success', 
                                message: `车辆 ${newVehicle.plateNumber} 添加成功` 
                            };
                            clearVehicleForm();
                            loadVehicles(); // 刷新数据
                        } else {
                            addResult.value = { 
                                type: 'error', 
                                message: `添加车辆失败：${result.message}` 
                            };
                        }
                    } catch (error) {
                        addResult.value = { type: 'error', message: '添加车辆失败: ' + error.message };
                    } finally {
                        adding.value = false;
                    }
                };

                // 计算统计信息
                const calculateStats = () => {
                    if (vehicles.value.length === 0) {
                        statsResult.value = { type: 'warning', message: '请先加载车辆数据' };
                        return;
                    }
                    
                    const totalVehicles = vehicles.value.length;
                    const activeVehicles = vehicles.value.filter(v => v.status === 'ACTIVE').length;
                    const pendingVehicles = vehicles.value.filter(v => v.status === 'PENDING').length;
                    const rejectedVehicles = vehicles.value.filter(v => v.status === 'REJECTED').length;
                    const inactiveVehicles = vehicles.value.filter(v => v.status === 'INACTIVE').length;
                    
                    stats.value = {
                        totalVehicles,
                        activeVehicles,
                        pendingVehicles,
                        rejectedVehicles,
                        inactiveVehicles,
                        vehicleTypes: {
                            SEDAN: vehicles.value.filter(v => v.vehicleType === 'SEDAN').length,
                            SUV: vehicles.value.filter(v => v.vehicleType === 'SUV').length,
                            MPV: vehicles.value.filter(v => v.vehicleType === 'MPV').length,
                            OTHER: vehicles.value.filter(v => v.vehicleType === 'OTHER').length
                        },
                        withDrivers: vehicles.value.filter(v => v.driverName).length,
                        withoutDrivers: vehicles.value.filter(v => !v.driverName).length
                    };
                    
                    statsResult.value = { 
                        type: 'success', 
                        message: '统计信息计算完成' 
                    };
                };

                // 运行完整测试
                const runCompleteTest = async () => {
                    testing.value = true;
                    completeResult.value = { type: 'warning', message: '正在运行完整测试...' };
                    
                    try {
                        const testResults = [];
                        
                        // 1. 测试API连接
                        await testVehicleAPI();
                        testResults.push({ 
                            step: 'API连接测试', 
                            success: apiResult.value?.type === 'success',
                            message: apiResult.value?.message 
                        });
                        
                        // 2. 加载车辆数据
                        await loadVehicles();
                        testResults.push({ 
                            step: '车辆数据加载', 
                            success: vehicleResult.value?.type === 'success',
                            message: vehicleResult.value?.message 
                        });
                        
                        // 3. 计算统计信息
                        calculateStats();
                        testResults.push({ 
                            step: '统计信息计算', 
                            success: statsResult.value?.type === 'success',
                            message: statsResult.value?.message 
                        });
                        
                        const successCount = testResults.filter(r => r.success).length;
                        const totalCount = testResults.length;
                        
                        completeData.value = {
                            testResults,
                            summary: {
                                total: totalCount,
                                success: successCount,
                                failed: totalCount - successCount,
                                successRate: Math.round((successCount / totalCount) * 100)
                            },
                            vehicleStats: stats.value,
                            timestamp: new Date().toISOString()
                        };
                        
                        if (successCount === totalCount) {
                            completeResult.value = { 
                                type: 'success', 
                                message: `完整测试通过！所有${totalCount}项测试都成功` 
                            };
                        } else {
                            completeResult.value = { 
                                type: 'warning', 
                                message: `完整测试部分通过：${successCount}/${totalCount}项成功` 
                            };
                        }
                    } catch (error) {
                        completeResult.value = { type: 'error', message: '完整测试失败: ' + error.message };
                    } finally {
                        testing.value = false;
                    }
                };

                // 清除所有结果
                const clearAllResults = () => {
                    apiResult.value = null;
                    apiData.value = null;
                    vehicleResult.value = null;
                    vehicles.value = [];
                    operationResult.value = null;
                    addResult.value = null;
                    statsResult.value = null;
                    stats.value = null;
                    completeResult.value = null;
                    completeData.value = null;
                    clearVehicleForm();
                    ElMessage.success('所有结果已清除');
                };

                // 辅助方法
                const getStatusText = (status) => {
                    const statusMap = {
                        'ACTIVE': '活跃',
                        'PENDING': '待审核',
                        'REJECTED': '已拒绝',
                        'INACTIVE': '已停用'
                    };
                    return statusMap[status] || status;
                };

                const getStatusTagType = (status) => {
                    const typeMap = {
                        'ACTIVE': 'success',
                        'PENDING': 'warning',
                        'REJECTED': 'danger',
                        'INACTIVE': 'info'
                    };
                    return typeMap[status] || 'default';
                };

                return {
                    apiResult,
                    apiData,
                    vehicleResult,
                    vehicles,
                    operationResult,
                    addResult,
                    statsResult,
                    stats,
                    completeResult,
                    completeData,
                    adding,
                    testing,
                    newVehicle,
                    testVehicleAPI,
                    testDriverAPI,
                    loadVehicles,
                    refreshVehicles,
                    testApproveVehicle,
                    testRejectVehicle,
                    testDeactivateVehicle,
                    fillSampleVehicle,
                    clearVehicleForm,
                    addVehicle,
                    calculateStats,
                    runCompleteTest,
                    clearAllResults,
                    getStatusText,
                    getStatusTagType
                };
            }
        }).use(ElementPlus).mount('#app');
    </script>
</body>
</html>