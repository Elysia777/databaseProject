<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket修复验证</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; }
        .step { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .step.success { background: #d4edda; border-color: #c3e6cb; }
        .step.error { background: #f8d7da; border-color: #f5c6cb; }
        .step.warning { background: #fff3cd; border-color: #ffeaa7; }
        button { background: #007bff; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
    </style>
</head>
<body>
    <h1>WebSocket修复验证</h1>
    
    <div class="step">
        <h3>修复内容总结</h3>
        <ul>
            <li>✅ 改进了订单状态初始化逻辑</li>
            <li>✅ 增强了WebSocket连接管理</li>
            <li>✅ 添加了自动重连机制</li>
            <li>✅ 优化了消息处理函数注册时机</li>
            <li>✅ 改进了状态恢复逻辑</li>
        </ul>
    </div>

    <div class="step">
        <h3>验证步骤</h3>
        <ol>
            <li>确保乘客已登录并有进行中的订单</li>
            <li>刷新乘客端页面（模拟前端重启）</li>
            <li>司机端发送位置更新或状态变化</li>
            <li>检查乘客端是否能收到消息并更新界面</li>
        </ol>
        <button onclick="startVerification()">开始验证</button>
    </div>

    <div id="results"></div>

    <script>
        function startVerification() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '';

            // 检查1: 用户登录状态
            const step1 = document.createElement('div');
            step1.className = 'step';
            const userStr = localStorage.getItem('user');
            const token = localStorage.getItem('token');
            
            if (userStr && token) {
                try {
                    const user = JSON.parse(userStr);
                    const passengerId = user.passengerId || user.id;
                    step1.className += ' success';
                    step1.innerHTML = `<h4>✅ 步骤1: 用户登录检查</h4><p>用户已登录，乘客ID: ${passengerId}</p>`;
                } catch (e) {
                    step1.className += ' error';
                    step1.innerHTML = `<h4>❌ 步骤1: 用户登录检查</h4><p>用户信息解析失败</p>`;
                }
            } else {
                step1.className += ' error';
                step1.innerHTML = `<h4>❌ 步骤1: 用户登录检查</h4><p>用户未登录，请先登录</p>`;
            }
            resultsDiv.appendChild(step1);

            // 检查2: 订单状态
            const step2 = document.createElement('div');
            step2.className = 'step';
            const currentOrder = localStorage.getItem('currentOrder');
            const orderStatus = localStorage.getItem('orderStatus');
            
            if (currentOrder && orderStatus) {
                try {
                    const order = JSON.parse(currentOrder);
                    if (['PENDING', 'ASSIGNED', 'PICKUP', 'IN_PROGRESS'].includes(orderStatus)) {
                        step2.className += ' success';
                        step2.innerHTML = `<h4>✅ 步骤2: 订单状态检查</h4><p>发现进行中的订单: #${order.orderNumber || order.id} (${orderStatus})</p>`;
                    } else {
                        step2.className += ' warning';
                        step2.innerHTML = `<h4>⚠️ 步骤2: 订单状态检查</h4><p>订单状态不需要WebSocket连接: ${orderStatus}</p>`;
                    }
                } catch (e) {
                    step2.className += ' error';
                    step2.innerHTML = `<h4>❌ 步骤2: 订单状态检查</h4><p>订单信息解析失败</p>`;
                }
            } else {
                step2.className += ' warning';
                step2.innerHTML = `<h4>⚠️ 步骤2: 订单状态检查</h4><p>没有当前订单</p>`;
            }
            resultsDiv.appendChild(step2);

            // 检查3: WebSocket连接
            const step3 = document.createElement('div');
            step3.className = 'step';
            const hasWebSocket = window.stompClient && window.stompClient.connected;
            
            if (hasWebSocket) {
                step3.className += ' success';
                step3.innerHTML = `<h4>✅ 步骤3: WebSocket连接检查</h4><p>WebSocket已连接</p>`;
            } else {
                step3.className += ' error';
                step3.innerHTML = `<h4>❌ 步骤3: WebSocket连接检查</h4><p>WebSocket未连接，请打开乘客地图页面</p>`;
            }
            resultsDiv.appendChild(step3);

            // 检查4: 消息处理函数
            const step4 = document.createElement('div');
            step4.className = 'step';
            const hasHandler = typeof window.handleMapOrderUpdate === 'function';
            
            if (hasHandler) {
                step4.className += ' success';
                step4.innerHTML = `<h4>✅ 步骤4: 消息处理函数检查</h4><p>消息处理函数已注册</p>`;
            } else {
                step4.className += ' error';
                step4.innerHTML = `<h4>❌ 步骤4: 消息处理函数检查</h4><p>消息处理函数未注册，请打开乘客地图页面</p>`;
            }
            resultsDiv.appendChild(step4);

            // 总结
            const summary = document.createElement('div');
            summary.className = 'step';
            const allGood = userStr && token && currentOrder && orderStatus && hasWebSocket && hasHandler;
            
            if (allGood) {
                summary.className += ' success';
                summary.innerHTML = `
                    <h4>🎉 验证结果</h4>
                    <p><strong>修复成功！</strong>所有检查项都通过了。</p>
                    <p>现在可以测试：刷新页面后司机发送消息，乘客端应该能正常接收。</p>
                `;
            } else {
                summary.className += ' warning';
                summary.innerHTML = `
                    <h4>⚠️ 验证结果</h4>
                    <p>部分检查项未通过，请按照上述提示进行修复。</p>
                    <p>建议：确保乘客已登录并有进行中的订单，然后打开乘客地图页面。</p>
                `;
            }
            resultsDiv.appendChild(summary);
        }

        // 页面加载时自动验证
        window.onload = function() {
            setTimeout(startVerification, 1000);
        };
    </script>
</body>
</html>