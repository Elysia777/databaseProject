<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocketä¿®å¤éªŒè¯</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; }
        .step { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .step.success { background: #d4edda; border-color: #c3e6cb; }
        .step.error { background: #f8d7da; border-color: #f5c6cb; }
        .step.warning { background: #fff3cd; border-color: #ffeaa7; }
        button { background: #007bff; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
    </style>
</head>
<body>
    <h1>WebSocketä¿®å¤éªŒè¯</h1>
    
    <div class="step">
        <h3>ä¿®å¤å†…å®¹æ€»ç»“</h3>
        <ul>
            <li>âœ… æ”¹è¿›äº†è®¢å•çŠ¶æ€åˆå§‹åŒ–é€»è¾‘</li>
            <li>âœ… å¢å¼ºäº†WebSocketè¿æ¥ç®¡ç†</li>
            <li>âœ… æ·»åŠ äº†è‡ªåŠ¨é‡è¿æœºåˆ¶</li>
            <li>âœ… ä¼˜åŒ–äº†æ¶ˆæ¯å¤„ç†å‡½æ•°æ³¨å†Œæ—¶æœº</li>
            <li>âœ… æ”¹è¿›äº†çŠ¶æ€æ¢å¤é€»è¾‘</li>
        </ul>
    </div>

    <div class="step">
        <h3>éªŒè¯æ­¥éª¤</h3>
        <ol>
            <li>ç¡®ä¿ä¹˜å®¢å·²ç™»å½•å¹¶æœ‰è¿›è¡Œä¸­çš„è®¢å•</li>
            <li>åˆ·æ–°ä¹˜å®¢ç«¯é¡µé¢ï¼ˆæ¨¡æ‹Ÿå‰ç«¯é‡å¯ï¼‰</li>
            <li>å¸æœºç«¯å‘é€ä½ç½®æ›´æ–°æˆ–çŠ¶æ€å˜åŒ–</li>
            <li>æ£€æŸ¥ä¹˜å®¢ç«¯æ˜¯å¦èƒ½æ”¶åˆ°æ¶ˆæ¯å¹¶æ›´æ–°ç•Œé¢</li>
        </ol>
        <button onclick="startVerification()">å¼€å§‹éªŒè¯</button>
    </div>

    <div id="results"></div>

    <script>
        function startVerification() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '';

            // æ£€æŸ¥1: ç”¨æˆ·ç™»å½•çŠ¶æ€
            const step1 = document.createElement('div');
            step1.className = 'step';
            const userStr = localStorage.getItem('user');
            const token = localStorage.getItem('token');
            
            if (userStr && token) {
                try {
                    const user = JSON.parse(userStr);
                    const passengerId = user.passengerId || user.id;
                    step1.className += ' success';
                    step1.innerHTML = `<h4>âœ… æ­¥éª¤1: ç”¨æˆ·ç™»å½•æ£€æŸ¥</h4><p>ç”¨æˆ·å·²ç™»å½•ï¼Œä¹˜å®¢ID: ${passengerId}</p>`;
                } catch (e) {
                    step1.className += ' error';
                    step1.innerHTML = `<h4>âŒ æ­¥éª¤1: ç”¨æˆ·ç™»å½•æ£€æŸ¥</h4><p>ç”¨æˆ·ä¿¡æ¯è§£æå¤±è´¥</p>`;
                }
            } else {
                step1.className += ' error';
                step1.innerHTML = `<h4>âŒ æ­¥éª¤1: ç”¨æˆ·ç™»å½•æ£€æŸ¥</h4><p>ç”¨æˆ·æœªç™»å½•ï¼Œè¯·å…ˆç™»å½•</p>`;
            }
            resultsDiv.appendChild(step1);

            // æ£€æŸ¥2: è®¢å•çŠ¶æ€
            const step2 = document.createElement('div');
            step2.className = 'step';
            const currentOrder = localStorage.getItem('currentOrder');
            const orderStatus = localStorage.getItem('orderStatus');
            
            if (currentOrder && orderStatus) {
                try {
                    const order = JSON.parse(currentOrder);
                    if (['PENDING', 'ASSIGNED', 'PICKUP', 'IN_PROGRESS'].includes(orderStatus)) {
                        step2.className += ' success';
                        step2.innerHTML = `<h4>âœ… æ­¥éª¤2: è®¢å•çŠ¶æ€æ£€æŸ¥</h4><p>å‘ç°è¿›è¡Œä¸­çš„è®¢å•: #${order.orderNumber || order.id} (${orderStatus})</p>`;
                    } else {
                        step2.className += ' warning';
                        step2.innerHTML = `<h4>âš ï¸ æ­¥éª¤2: è®¢å•çŠ¶æ€æ£€æŸ¥</h4><p>è®¢å•çŠ¶æ€ä¸éœ€è¦WebSocketè¿æ¥: ${orderStatus}</p>`;
                    }
                } catch (e) {
                    step2.className += ' error';
                    step2.innerHTML = `<h4>âŒ æ­¥éª¤2: è®¢å•çŠ¶æ€æ£€æŸ¥</h4><p>è®¢å•ä¿¡æ¯è§£æå¤±è´¥</p>`;
                }
            } else {
                step2.className += ' warning';
                step2.innerHTML = `<h4>âš ï¸ æ­¥éª¤2: è®¢å•çŠ¶æ€æ£€æŸ¥</h4><p>æ²¡æœ‰å½“å‰è®¢å•</p>`;
            }
            resultsDiv.appendChild(step2);

            // æ£€æŸ¥3: WebSocketè¿æ¥
            const step3 = document.createElement('div');
            step3.className = 'step';
            const hasWebSocket = window.stompClient && window.stompClient.connected;
            
            if (hasWebSocket) {
                step3.className += ' success';
                step3.innerHTML = `<h4>âœ… æ­¥éª¤3: WebSocketè¿æ¥æ£€æŸ¥</h4><p>WebSocketå·²è¿æ¥</p>`;
            } else {
                step3.className += ' error';
                step3.innerHTML = `<h4>âŒ æ­¥éª¤3: WebSocketè¿æ¥æ£€æŸ¥</h4><p>WebSocketæœªè¿æ¥ï¼Œè¯·æ‰“å¼€ä¹˜å®¢åœ°å›¾é¡µé¢</p>`;
            }
            resultsDiv.appendChild(step3);

            // æ£€æŸ¥4: æ¶ˆæ¯å¤„ç†å‡½æ•°
            const step4 = document.createElement('div');
            step4.className = 'step';
            const hasHandler = typeof window.handleMapOrderUpdate === 'function';
            
            if (hasHandler) {
                step4.className += ' success';
                step4.innerHTML = `<h4>âœ… æ­¥éª¤4: æ¶ˆæ¯å¤„ç†å‡½æ•°æ£€æŸ¥</h4><p>æ¶ˆæ¯å¤„ç†å‡½æ•°å·²æ³¨å†Œ</p>`;
            } else {
                step4.className += ' error';
                step4.innerHTML = `<h4>âŒ æ­¥éª¤4: æ¶ˆæ¯å¤„ç†å‡½æ•°æ£€æŸ¥</h4><p>æ¶ˆæ¯å¤„ç†å‡½æ•°æœªæ³¨å†Œï¼Œè¯·æ‰“å¼€ä¹˜å®¢åœ°å›¾é¡µé¢</p>`;
            }
            resultsDiv.appendChild(step4);

            // æ€»ç»“
            const summary = document.createElement('div');
            summary.className = 'step';
            const allGood = userStr && token && currentOrder && orderStatus && hasWebSocket && hasHandler;
            
            if (allGood) {
                summary.className += ' success';
                summary.innerHTML = `
                    <h4>ğŸ‰ éªŒè¯ç»“æœ</h4>
                    <p><strong>ä¿®å¤æˆåŠŸï¼</strong>æ‰€æœ‰æ£€æŸ¥é¡¹éƒ½é€šè¿‡äº†ã€‚</p>
                    <p>ç°åœ¨å¯ä»¥æµ‹è¯•ï¼šåˆ·æ–°é¡µé¢åå¸æœºå‘é€æ¶ˆæ¯ï¼Œä¹˜å®¢ç«¯åº”è¯¥èƒ½æ­£å¸¸æ¥æ”¶ã€‚</p>
                `;
            } else {
                summary.className += ' warning';
                summary.innerHTML = `
                    <h4>âš ï¸ éªŒè¯ç»“æœ</h4>
                    <p>éƒ¨åˆ†æ£€æŸ¥é¡¹æœªé€šè¿‡ï¼Œè¯·æŒ‰ç…§ä¸Šè¿°æç¤ºè¿›è¡Œä¿®å¤ã€‚</p>
                    <p>å»ºè®®ï¼šç¡®ä¿ä¹˜å®¢å·²ç™»å½•å¹¶æœ‰è¿›è¡Œä¸­çš„è®¢å•ï¼Œç„¶åæ‰“å¼€ä¹˜å®¢åœ°å›¾é¡µé¢ã€‚</p>
                `;
            }
            resultsDiv.appendChild(summary);
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨éªŒè¯
        window.onload = function() {
            setTimeout(startVerification, 1000);
        };
    </script>
</body>
</html>