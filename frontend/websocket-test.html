<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket连接测试</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.6.1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@7.0.0/bundles/stomp.umd.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .log-area {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin-top: 15px;
            height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }

        .status {
            padding: 5px 10px;
            border-radius: 3px;
            margin: 5px 0;
        }

        .status-online {
            background: #d4edda;
            color: #155724;
        }

        .status-offline {
            background: #f8d7da;
            color: #721c24;
        }

        input {
            padding: 8px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>🔧 WebSocket连接测试工具</h1>

        <div>
            <label>司机ID: </label>
            <input type="number" id="driverId" value="1" />
            <button class="button btn-primary" onclick="connectWebSocket()">连接WebSocket</button>
            <button class="button btn-danger" onclick="disconnectWebSocket()">断开连接</button>
            <button class="button btn-success" onclick="testMessage()">发送测试消息</button>
            <button class="button btn-success" onclick="openMultiDriverTest()">多司机测试</button>
        </div>

        <div id="connectionStatus" class="status status-offline">🔴 未连接</div>

        <div class="log-area" id="logArea"></div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:8080';
        let stompClient = null;
        let isConnected = false;

        function log(message, isError = false) {
            const logArea = document.getElementById('logArea');
            const timestamp = new Date().toLocaleTimeString();
            const color = isError ? 'red' : 'black';
            logArea.innerHTML += `<div style="color: ${color};">[${timestamp}] ${message}</div>`;
            logArea.scrollTop = logArea.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }

        function updateStatus(connected) {
            const statusEl = document.getElementById('connectionStatus');
            if (connected) {
                statusEl.textContent = '🟢 已连接';
                statusEl.className = 'status status-online';
            } else {
                statusEl.textContent = '🔴 未连接';
                statusEl.className = 'status status-offline';
            }
        }

        function connectWebSocket() {
            const driverId = document.getElementById('driverId').value;

            if (!driverId) {
                log('❌ 请输入司机ID', true);
                return;
            }

            if (stompClient && stompClient.connected) {
                log('⚠️ 已经连接，无需重复连接');
                return;
            }

            log('🔗 开始连接WebSocket...');
            log(`📍 连接地址: ${API_BASE_URL}/ws`);
            log(`👤 司机ID: ${driverId}`);

            try {
                // 检查库是否加载
                if (typeof SockJS === 'undefined') {
                    log('❌ SockJS库未加载', true);
                    return;
                }

                if (typeof StompJs === 'undefined') {
                    log('❌ StompJs库未加载', true);
                    return;
                }

                log('✅ WebSocket库加载正常');

                // 创建STOMP客户端
                stompClient = new StompJs.Client({
                    webSocketFactory: () => {
                        log('🔌 创建SockJS连接...');
                        return new SockJS(API_BASE_URL + '/ws');
                    },
                    debug: (str) => {
                        log(`🐛 STOMP调试: ${str}`);
                    }
                });

                // 连接成功回调
                stompClient.onConnect = function (frame) {
                    isConnected = true;
                    updateStatus(true);
                    log('✅ WebSocket连接成功!');
                    log(`📋 连接信息: ${JSON.stringify(frame.headers)}`);

                    // 发送司机连接消息
                    try {
                        const connectMsg = { driverId: driverId };
                        log(`📤 发送连接消息: ${JSON.stringify(connectMsg)}`);

                        stompClient.publish({
                            destination: '/app/driver/connect',
                            body: JSON.stringify(connectMsg)
                        });
                        log('✅ 司机连接消息发送成功');
                    } catch (error) {
                        log(`❌ 发送连接消息失败: ${error.message}`, true);
                    }

                    // 订阅队列
                    try {
                        // 订阅订单队列
                        const orderQueue = `/user/${driverId}/queue/orders`;
                        log(`📡 订阅订单队列: ${orderQueue}`);

                        stompClient.subscribe(orderQueue, function (message) {
                            console.log('🚗 收到订单消息原始对象:', message);
                            console.log('🚗 消息头:', message.headers);
                            console.log('🚗 消息体:', message.body);
                            log(`🚗 收到订单消息!`);
                            log(`📨 消息内容: ${message.body}`);
                            try {
                                const orderData = JSON.parse(message.body);
                                console.log('✅ 解析后的订单数据:', orderData);
                                log(`✅ 订单解析成功: 订单ID=${orderData.orderId}`);
                                // 这里应该显示订单通知
                                showOrderNotification(orderData);
                            } catch (error) {
                                console.error('❌ 订单消息解析失败:', error);
                                log(`❌ 订单消息解析失败: ${error.message}`, true);
                            }
                        });

                        // 订阅连接状态队列
                        const connectionQueue = `/user/${driverId}/queue/connection`;
                        log(`📡 订阅连接队列: ${connectionQueue}`);

                        stompClient.subscribe(connectionQueue, function (message) {
                            console.log('📡 收到连接状态消息原始对象:', message);
                            log(`📡 收到连接状态消息: ${message.body}`);
                        });

                        // 订阅通知队列
                        const notificationQueue = `/user/${driverId}/queue/notifications`;
                        log(`📡 订阅通知队列: ${notificationQueue}`);

                        stompClient.subscribe(notificationQueue, function (message) {
                            log(`📢 收到通知消息: ${message.body}`);
                        });

                        // 订阅广播测试主题
                        log(`📡 订阅广播测试主题: /topic/test`);
                        stompClient.subscribe('/topic/test', function (message) {
                            console.log('📻 收到广播消息:', message);
                            log(`📻 广播消息: ${message.body}`);
                        });

                        log('✅ 所有队列订阅完成');

                    } catch (error) {
                        log(`❌ 订阅队列失败: ${error.message}`, true);
                    }
                };

                // 连接错误回调
                stompClient.onStompError = function (frame) {
                    isConnected = false;
                    updateStatus(false);
                    log(`❌ STOMP连接错误: ${frame.headers['message']}`, true);
                    log(`❌ 错误详情: ${frame.body}`, true);
                };

                // WebSocket错误回调
                stompClient.onWebSocketError = function (event) {
                    log(`❌ WebSocket错误: ${event}`, true);
                };

                // 断开连接回调
                stompClient.onDisconnect = function () {
                    isConnected = false;
                    updateStatus(false);
                    log('🔌 WebSocket连接已断开');
                };

                // 激活连接
                log('🚀 激活STOMP连接...');
                stompClient.activate();

            } catch (error) {
                log(`❌ 连接失败: ${error.message}`, true);
                updateStatus(false);
            }
        }

        function disconnectWebSocket() {
            if (stompClient) {
                log('🔌 断开WebSocket连接...');
                stompClient.deactivate();
                stompClient = null;
                isConnected = false;
                updateStatus(false);
                log('✅ 连接已断开');
            } else {
                log('⚠️ 没有活动的连接');
            }
        }

        function testMessage() {
            if (!stompClient || !stompClient.connected) {
                log('❌ 请先连接WebSocket', true);
                return;
            }

            const driverId = document.getElementById('driverId').value;

            try {
                const testMsg = {
                    type: 'TEST',
                    driverId: driverId,
                    message: '这是一条测试消息',
                    timestamp: new Date().toISOString()
                };

                log(`📤 发送测试消息: ${JSON.stringify(testMsg)}`);

                stompClient.publish({
                    destination: '/app/test',
                    body: JSON.stringify(testMsg)
                });

                log('✅ 测试消息发送成功');
            } catch (error) {
                log(`❌ 发送测试消息失败: ${error.message}`, true);
            }
        }

        // 多司机测试功能
        function openMultiDriverTest() {
            // 创建多个司机测试窗口
            const driverCount = prompt('请输入要测试的司机数量（建议2-4个）:', '3');
            if (driverCount && !isNaN(driverCount)) {
                const count = parseInt(driverCount);
                for (let i = 1; i <= count; i++) {
                    const url = `websocket-test.html?driverId=${i}&title=司机${i}`;
                    window.open(url, `driver${i}`, 'width=800,height=600,left=' + (i * 50) + ',top=' + (i * 50));
                }
            }
        }

        // 从URL参数获取司机ID和标题
        function initFromUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const driverIdParam = urlParams.get('driverId');
            const titleParam = urlParams.get('title');
            
            if (driverIdParam) {
                document.getElementById('driverId').value = driverIdParam;
            }
            
            if (titleParam) {
                document.title = titleParam + ' - WebSocket测试';
                const h1 = document.querySelector('h1');
                if (h1) {
                    h1.textContent = `🔧 ${titleParam} WebSocket连接测试工具`;
                }
            }
        }

        // 存储当前显示的订单通知
        const activeOrders = new Map();

        function showOrderNotification(orderData) {
            log(`🎉 显示订单通知:`);
            log(`   订单ID: ${orderData.orderId}`);
            log(`   订单号: ${orderData.orderNumber}`);
            log(`   上车地址: ${orderData.pickupAddress}`);
            log(`   目的地: ${orderData.destinationAddress}`);
            log(`   距离: ${orderData.distance}km`);
            
            // 创建订单通知卡片
            createOrderCard(orderData);
            
            // 存储到活跃订单列表
            activeOrders.set(orderData.orderId, orderData);
        }

        function createOrderCard(orderData) {
            // 检查是否已存在该订单卡片
            const existingCard = document.getElementById(`order-card-${orderData.orderId}`);
            if (existingCard) {
                return; // 已存在，不重复创建
            }

            const logArea = document.getElementById('logArea');
            
            // 创建订单卡片
            const orderCard = document.createElement('div');
            orderCard.id = `order-card-${orderData.orderId}`;
            orderCard.style.cssText = `
                background: #fff3cd;
                border: 2px solid #ffc107;
                border-radius: 8px;
                padding: 15px;
                margin: 10px 0;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            `;
            
            orderCard.innerHTML = `
                <div style="font-weight: bold; color: #856404; margin-bottom: 10px;">
                    🚗 新订单通知 #${orderData.orderId}
                </div>
                <div style="margin-bottom: 8px;">📍 上车: ${orderData.pickupAddress}</div>
                <div style="margin-bottom: 8px;">🎯 目的地: ${orderData.destinationAddress}</div>
                <div style="margin-bottom: 8px;">📏 距离: ${orderData.distance}km</div>
                <div style="margin-bottom: 15px;">💰 预估费用: ${orderData.estimatedFare || '待计算'}</div>
                <div>
                    <button onclick="acceptOrder(${orderData.orderId})" 
                            style="background: #28a745; color: white; border: none; padding: 8px 15px; border-radius: 4px; margin-right: 10px; cursor: pointer;">
                        ✅ 接单
                    </button>
                    <button onclick="rejectOrder(${orderData.orderId})" 
                            style="background: #dc3545; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer;">
                        ❌ 拒单
                    </button>
                </div>
            `;
            
            // 插入到日志区域顶部
            logArea.insertBefore(orderCard, logArea.firstChild);
        }

        function acceptOrder(orderId) {
            const driverId = document.getElementById('driverId').value;
            log(`✅ 司机 ${driverId} 正在接单 ${orderId}...`);
            
            // 调用接单API
            fetch(`http://localhost:8080/api/drivers/${driverId}/accept-order/${orderId}`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    log(`✅ 接单成功！订单 ${orderId}`);
                    removeOrderCard(orderId);
                    
                    // 通知其他司机移除该订单
                    broadcastOrderAccepted(orderId);
                } else {
                    log(`❌ 接单失败: ${data.message}`, true);
                }
            })
            .catch(error => {
                log(`❌ 接单请求失败: ${error.message}`, true);
            });
        }

        function rejectOrder(orderId) {
            const driverId = document.getElementById('driverId').value;
            log(`❌ 司机 ${driverId} 正在拒单 ${orderId}...`);
            
            // 调用拒单API
            fetch(`http://localhost:8080/api/drivers/${driverId}/reject-order/${orderId}?reason=距离太远`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    log(`✅ 拒单成功！订单 ${orderId}`);
                    removeOrderCard(orderId);
                } else {
                    log(`❌ 拒单失败: ${data.message}`, true);
                }
            })
            .catch(error => {
                log(`❌ 拒单请求失败: ${error.message}`, true);
            });
        }

        function removeOrderCard(orderId) {
            const orderCard = document.getElementById(`order-card-${orderId}`);
            if (orderCard) {
                orderCard.remove();
                activeOrders.delete(orderId);
                log(`🗑️ 已移除订单 ${orderId} 的通知卡片`);
            }
        }

        function broadcastOrderAccepted(orderId) {
            // 使用localStorage广播订单被接单的消息
            localStorage.setItem('orderAccepted', JSON.stringify({
                orderId: orderId,
                timestamp: Date.now()
            }));
            
            // 立即清除，避免影响其他操作
            setTimeout(() => {
                localStorage.removeItem('orderAccepted');
            }, 1000);
        }

        // 监听其他窗口的订单接单广播
        window.addEventListener('storage', function(e) {
            if (e.key === 'orderAccepted' && e.newValue) {
                const data = JSON.parse(e.newValue);
                const orderId = data.orderId;
                
                // 如果当前窗口有该订单，则移除
                if (activeOrders.has(orderId)) {
                    removeOrderCard(orderId);
                    log(`📢 收到广播: 订单 ${orderId} 已被其他司机接单`);
                }
            }
        });

        // 页面加载完成时初始化
        window.onload = function () {
            initFromUrlParams();
            log('🚀 WebSocket测试工具已启动');
            log('💡 请先连接WebSocket，然后在主页面创建订单进行测试');
        };
    </script>
</body>

</html>    <s
cript>
        function openMultiDriverTest() {
            // 创建多个司机测试窗口
            const driverCount = prompt('请输入要测试的司机数量（建议2-4个）:', '3');
            if (driverCount && !isNaN(driverCount)) {
                const count = parseInt(driverCount);
                for (let i = 1; i <= count; i++) {
                    const url = `websocket-test.html?driverId=${i}&title=司机${i}`;
                    window.open(url, `driver${i}`, 'width=800,height=600,left=' + (i * 50) + ',top=' + (i * 50));
                }
            }
        }

        // 从URL参数获取司机ID和标题
        function initFromUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const driverIdParam = urlParams.get('driverId');
            const titleParam = urlParams.get('title');
            
            if (driverIdParam) {
                document.getElementById('driverId').value = driverIdParam;
            }
            
            if (titleParam) {
                document.title = titleParam + ' - WebSocket测试';
                const h1 = document.querySelector('h1');
                if (h1) {
                    h1.textContent = `🔧 ${titleParam} WebSocket连接测试工具`;
                }
            }
        }

        // 页面加载完成时初始化
        document.addEventListener('DOMContentLoaded', function() {
            initFromUrlParams();
            log('🚀 WebSocket测试工具已启动');
            log('💡 请先连接WebSocket，然后在主页面创建订单进行测试');
        });
    </script>    <s
cript>
        // 存储当前显示的订单通知
        const activeOrders = new Map();

        function showOrderNotification(orderData) {
            log(`🎉 显示订单通知:`);
            log(`   订单ID: ${orderData.orderId}`);
            log(`   订单号: ${orderData.orderNumber}`);
            log(`   上车地址: ${orderData.pickupAddress}`);
            log(`   目的地: ${orderData.destinationAddress}`);
            log(`   距离: ${orderData.distance}km`);
            
            // 创建订单通知卡片
            createOrderCard(orderData);
            
            // 存储到活跃订单列表
            activeOrders.set(orderData.orderId, orderData);
        }

        function createOrderCard(orderData) {
            // 检查是否已存在该订单卡片
            const existingCard = document.getElementById(`order-card-${orderData.orderId}`);
            if (existingCard) {
                return; // 已存在，不重复创建
            }

            const logArea = document.getElementById('logArea');
            
            // 创建订单卡片
            const orderCard = document.createElement('div');
            orderCard.id = `order-card-${orderData.orderId}`;
            orderCard.style.cssText = `
                background: #fff3cd;
                border: 2px solid #ffc107;
                border-radius: 8px;
                padding: 15px;
                margin: 10px 0;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            `;
            
            orderCard.innerHTML = `
                <div style="font-weight: bold; color: #856404; margin-bottom: 10px;">
                    🚗 新订单通知 #${orderData.orderId}
                </div>
                <div style="margin-bottom: 8px;">📍 上车: ${orderData.pickupAddress}</div>
                <div style="margin-bottom: 8px;">🎯 目的地: ${orderData.destinationAddress}</div>
                <div style="margin-bottom: 8px;">📏 距离: ${orderData.distance}km</div>
                <div style="margin-bottom: 15px;">💰 预估费用: ${orderData.estimatedFare || '待计算'}</div>
                <div>
                    <button onclick="acceptOrder(${orderData.orderId})" 
                            style="background: #28a745; color: white; border: none; padding: 8px 15px; border-radius: 4px; margin-right: 10px; cursor: pointer;">
                        ✅ 接单
                    </button>
                    <button onclick="rejectOrder(${orderData.orderId})" 
                            style="background: #dc3545; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer;">
                        ❌ 拒单
                    </button>
                </div>
            `;
            
            // 插入到日志区域顶部
            logArea.insertBefore(orderCard, logArea.firstChild);
        }

        function acceptOrder(orderId) {
            const driverId = document.getElementById('driverId').value;
            log(`✅ 司机 ${driverId} 正在接单 ${orderId}...`);
            
            // 调用接单API
            fetch(`http://localhost:8080/api/drivers/${driverId}/accept-order/${orderId}`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    log(`✅ 接单成功！订单 ${orderId}`);
                    removeOrderCard(orderId);
                    
                    // 通知其他司机移除该订单
                    broadcastOrderAccepted(orderId);
                } else {
                    log(`❌ 接单失败: ${data.message}`, true);
                }
            })
            .catch(error => {
                log(`❌ 接单请求失败: ${error.message}`, true);
            });
        }

        function rejectOrder(orderId) {
            const driverId = document.getElementById('driverId').value;
            log(`❌ 司机 ${driverId} 正在拒单 ${orderId}...`);
            
            // 调用拒单API
            fetch(`http://localhost:8080/api/drivers/${driverId}/reject-order/${orderId}?reason=距离太远`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    log(`✅ 拒单成功！订单 ${orderId}`);
                    removeOrderCard(orderId);
                } else {
                    log(`❌ 拒单失败: ${data.message}`, true);
                }
            })
            .catch(error => {
                log(`❌ 拒单请求失败: ${error.message}`, true);
            });
        }

        function removeOrderCard(orderId) {
            const orderCard = document.getElementById(`order-card-${orderId}`);
            if (orderCard) {
                orderCard.remove();
                activeOrders.delete(orderId);
                log(`🗑️ 已移除订单 ${orderId} 的通知卡片`);
            }
        }

        function broadcastOrderAccepted(orderId) {
            // 使用localStorage广播订单被接单的消息
            localStorage.setItem('orderAccepted', JSON.stringify({
                orderId: orderId,
                timestamp: Date.now()
            }));
            
            // 立即清除，避免影响其他操作
            setTimeout(() => {
                localStorage.removeItem('orderAccepted');
            }, 1000);
        }

        // 监听其他窗口的订单接单广播
        window.addEventListener('storage', function(e) {
            if (e.key === 'orderAccepted' && e.newValue) {
                const data = JSON.parse(e.newValue);
                const orderId = data.orderId;
                
                // 如果当前窗口有该订单，则移除
                if (activeOrders.has(orderId)) {
                    removeOrderCard(orderId);
                    log(`📢 收到广播: 订单 ${orderId} 已被其他司机接单`);
                }
            }
        });
    </script>