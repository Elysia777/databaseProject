<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocketè¿æ¥æµ‹è¯•</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.6.1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@7.0.0/bundles/stomp.umd.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .log-area {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin-top: 15px;
            height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }

        .status {
            padding: 5px 10px;
            border-radius: 3px;
            margin: 5px 0;
        }

        .status-online {
            background: #d4edda;
            color: #155724;
        }

        .status-offline {
            background: #f8d7da;
            color: #721c24;
        }

        input {
            padding: 8px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>ğŸ”§ WebSocketè¿æ¥æµ‹è¯•å·¥å…·</h1>

        <div>
            <label>å¸æœºID: </label>
            <input type="number" id="driverId" value="1" />
            <button class="button btn-primary" onclick="connectWebSocket()">è¿æ¥WebSocket</button>
            <button class="button btn-danger" onclick="disconnectWebSocket()">æ–­å¼€è¿æ¥</button>
            <button class="button btn-success" onclick="testMessage()">å‘é€æµ‹è¯•æ¶ˆæ¯</button>
            <button class="button btn-success" onclick="openMultiDriverTest()">å¤šå¸æœºæµ‹è¯•</button>
        </div>

        <div id="connectionStatus" class="status status-offline">ğŸ”´ æœªè¿æ¥</div>

        <div class="log-area" id="logArea"></div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:8080';
        let stompClient = null;
        let isConnected = false;

        function log(message, isError = false) {
            const logArea = document.getElementById('logArea');
            const timestamp = new Date().toLocaleTimeString();
            const color = isError ? 'red' : 'black';
            logArea.innerHTML += `<div style="color: ${color};">[${timestamp}] ${message}</div>`;
            logArea.scrollTop = logArea.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }

        function updateStatus(connected) {
            const statusEl = document.getElementById('connectionStatus');
            if (connected) {
                statusEl.textContent = 'ğŸŸ¢ å·²è¿æ¥';
                statusEl.className = 'status status-online';
            } else {
                statusEl.textContent = 'ğŸ”´ æœªè¿æ¥';
                statusEl.className = 'status status-offline';
            }
        }

        function connectWebSocket() {
            const driverId = document.getElementById('driverId').value;

            if (!driverId) {
                log('âŒ è¯·è¾“å…¥å¸æœºID', true);
                return;
            }

            if (stompClient && stompClient.connected) {
                log('âš ï¸ å·²ç»è¿æ¥ï¼Œæ— éœ€é‡å¤è¿æ¥');
                return;
            }

            log('ğŸ”— å¼€å§‹è¿æ¥WebSocket...');
            log(`ğŸ“ è¿æ¥åœ°å€: ${API_BASE_URL}/ws`);
            log(`ğŸ‘¤ å¸æœºID: ${driverId}`);

            try {
                // æ£€æŸ¥åº“æ˜¯å¦åŠ è½½
                if (typeof SockJS === 'undefined') {
                    log('âŒ SockJSåº“æœªåŠ è½½', true);
                    return;
                }

                if (typeof StompJs === 'undefined') {
                    log('âŒ StompJsåº“æœªåŠ è½½', true);
                    return;
                }

                log('âœ… WebSocketåº“åŠ è½½æ­£å¸¸');

                // åˆ›å»ºSTOMPå®¢æˆ·ç«¯
                stompClient = new StompJs.Client({
                    webSocketFactory: () => {
                        log('ğŸ”Œ åˆ›å»ºSockJSè¿æ¥...');
                        return new SockJS(API_BASE_URL + '/ws');
                    },
                    debug: (str) => {
                        log(`ğŸ› STOMPè°ƒè¯•: ${str}`);
                    }
                });

                // è¿æ¥æˆåŠŸå›è°ƒ
                stompClient.onConnect = function (frame) {
                    isConnected = true;
                    updateStatus(true);
                    log('âœ… WebSocketè¿æ¥æˆåŠŸ!');
                    log(`ğŸ“‹ è¿æ¥ä¿¡æ¯: ${JSON.stringify(frame.headers)}`);

                    // å‘é€å¸æœºè¿æ¥æ¶ˆæ¯
                    try {
                        const connectMsg = { driverId: driverId };
                        log(`ğŸ“¤ å‘é€è¿æ¥æ¶ˆæ¯: ${JSON.stringify(connectMsg)}`);

                        stompClient.publish({
                            destination: '/app/driver/connect',
                            body: JSON.stringify(connectMsg)
                        });
                        log('âœ… å¸æœºè¿æ¥æ¶ˆæ¯å‘é€æˆåŠŸ');
                    } catch (error) {
                        log(`âŒ å‘é€è¿æ¥æ¶ˆæ¯å¤±è´¥: ${error.message}`, true);
                    }

                    // è®¢é˜…é˜Ÿåˆ—
                    try {
                        // è®¢é˜…è®¢å•é˜Ÿåˆ—
                        const orderQueue = `/user/${driverId}/queue/orders`;
                        log(`ğŸ“¡ è®¢é˜…è®¢å•é˜Ÿåˆ—: ${orderQueue}`);

                        stompClient.subscribe(orderQueue, function (message) {
                            console.log('ğŸš— æ”¶åˆ°è®¢å•æ¶ˆæ¯åŸå§‹å¯¹è±¡:', message);
                            console.log('ğŸš— æ¶ˆæ¯å¤´:', message.headers);
                            console.log('ğŸš— æ¶ˆæ¯ä½“:', message.body);
                            log(`ğŸš— æ”¶åˆ°è®¢å•æ¶ˆæ¯!`);
                            log(`ğŸ“¨ æ¶ˆæ¯å†…å®¹: ${message.body}`);
                            try {
                                const orderData = JSON.parse(message.body);
                                console.log('âœ… è§£æåçš„è®¢å•æ•°æ®:', orderData);
                                log(`âœ… è®¢å•è§£ææˆåŠŸ: è®¢å•ID=${orderData.orderId}`);
                                // è¿™é‡Œåº”è¯¥æ˜¾ç¤ºè®¢å•é€šçŸ¥
                                showOrderNotification(orderData);
                            } catch (error) {
                                console.error('âŒ è®¢å•æ¶ˆæ¯è§£æå¤±è´¥:', error);
                                log(`âŒ è®¢å•æ¶ˆæ¯è§£æå¤±è´¥: ${error.message}`, true);
                            }
                        });

                        // è®¢é˜…è¿æ¥çŠ¶æ€é˜Ÿåˆ—
                        const connectionQueue = `/user/${driverId}/queue/connection`;
                        log(`ğŸ“¡ è®¢é˜…è¿æ¥é˜Ÿåˆ—: ${connectionQueue}`);

                        stompClient.subscribe(connectionQueue, function (message) {
                            console.log('ğŸ“¡ æ”¶åˆ°è¿æ¥çŠ¶æ€æ¶ˆæ¯åŸå§‹å¯¹è±¡:', message);
                            log(`ğŸ“¡ æ”¶åˆ°è¿æ¥çŠ¶æ€æ¶ˆæ¯: ${message.body}`);
                        });

                        // è®¢é˜…é€šçŸ¥é˜Ÿåˆ—
                        const notificationQueue = `/user/${driverId}/queue/notifications`;
                        log(`ğŸ“¡ è®¢é˜…é€šçŸ¥é˜Ÿåˆ—: ${notificationQueue}`);

                        stompClient.subscribe(notificationQueue, function (message) {
                            log(`ğŸ“¢ æ”¶åˆ°é€šçŸ¥æ¶ˆæ¯: ${message.body}`);
                        });

                        // è®¢é˜…å¹¿æ’­æµ‹è¯•ä¸»é¢˜
                        log(`ğŸ“¡ è®¢é˜…å¹¿æ’­æµ‹è¯•ä¸»é¢˜: /topic/test`);
                        stompClient.subscribe('/topic/test', function (message) {
                            console.log('ğŸ“» æ”¶åˆ°å¹¿æ’­æ¶ˆæ¯:', message);
                            log(`ğŸ“» å¹¿æ’­æ¶ˆæ¯: ${message.body}`);
                        });

                        log('âœ… æ‰€æœ‰é˜Ÿåˆ—è®¢é˜…å®Œæˆ');

                    } catch (error) {
                        log(`âŒ è®¢é˜…é˜Ÿåˆ—å¤±è´¥: ${error.message}`, true);
                    }
                };

                // è¿æ¥é”™è¯¯å›è°ƒ
                stompClient.onStompError = function (frame) {
                    isConnected = false;
                    updateStatus(false);
                    log(`âŒ STOMPè¿æ¥é”™è¯¯: ${frame.headers['message']}`, true);
                    log(`âŒ é”™è¯¯è¯¦æƒ…: ${frame.body}`, true);
                };

                // WebSocketé”™è¯¯å›è°ƒ
                stompClient.onWebSocketError = function (event) {
                    log(`âŒ WebSocketé”™è¯¯: ${event}`, true);
                };

                // æ–­å¼€è¿æ¥å›è°ƒ
                stompClient.onDisconnect = function () {
                    isConnected = false;
                    updateStatus(false);
                    log('ğŸ”Œ WebSocketè¿æ¥å·²æ–­å¼€');
                };

                // æ¿€æ´»è¿æ¥
                log('ğŸš€ æ¿€æ´»STOMPè¿æ¥...');
                stompClient.activate();

            } catch (error) {
                log(`âŒ è¿æ¥å¤±è´¥: ${error.message}`, true);
                updateStatus(false);
            }
        }

        function disconnectWebSocket() {
            if (stompClient) {
                log('ğŸ”Œ æ–­å¼€WebSocketè¿æ¥...');
                stompClient.deactivate();
                stompClient = null;
                isConnected = false;
                updateStatus(false);
                log('âœ… è¿æ¥å·²æ–­å¼€');
            } else {
                log('âš ï¸ æ²¡æœ‰æ´»åŠ¨çš„è¿æ¥');
            }
        }

        function testMessage() {
            if (!stompClient || !stompClient.connected) {
                log('âŒ è¯·å…ˆè¿æ¥WebSocket', true);
                return;
            }

            const driverId = document.getElementById('driverId').value;

            try {
                const testMsg = {
                    type: 'TEST',
                    driverId: driverId,
                    message: 'è¿™æ˜¯ä¸€æ¡æµ‹è¯•æ¶ˆæ¯',
                    timestamp: new Date().toISOString()
                };

                log(`ğŸ“¤ å‘é€æµ‹è¯•æ¶ˆæ¯: ${JSON.stringify(testMsg)}`);

                stompClient.publish({
                    destination: '/app/test',
                    body: JSON.stringify(testMsg)
                });

                log('âœ… æµ‹è¯•æ¶ˆæ¯å‘é€æˆåŠŸ');
            } catch (error) {
                log(`âŒ å‘é€æµ‹è¯•æ¶ˆæ¯å¤±è´¥: ${error.message}`, true);
            }
        }

        // å¤šå¸æœºæµ‹è¯•åŠŸèƒ½
        function openMultiDriverTest() {
            // åˆ›å»ºå¤šä¸ªå¸æœºæµ‹è¯•çª—å£
            const driverCount = prompt('è¯·è¾“å…¥è¦æµ‹è¯•çš„å¸æœºæ•°é‡ï¼ˆå»ºè®®2-4ä¸ªï¼‰:', '3');
            if (driverCount && !isNaN(driverCount)) {
                const count = parseInt(driverCount);
                for (let i = 1; i <= count; i++) {
                    const url = `websocket-test.html?driverId=${i}&title=å¸æœº${i}`;
                    window.open(url, `driver${i}`, 'width=800,height=600,left=' + (i * 50) + ',top=' + (i * 50));
                }
            }
        }

        // ä»URLå‚æ•°è·å–å¸æœºIDå’Œæ ‡é¢˜
        function initFromUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const driverIdParam = urlParams.get('driverId');
            const titleParam = urlParams.get('title');
            
            if (driverIdParam) {
                document.getElementById('driverId').value = driverIdParam;
            }
            
            if (titleParam) {
                document.title = titleParam + ' - WebSocketæµ‹è¯•';
                const h1 = document.querySelector('h1');
                if (h1) {
                    h1.textContent = `ğŸ”§ ${titleParam} WebSocketè¿æ¥æµ‹è¯•å·¥å…·`;
                }
            }
        }

        // å­˜å‚¨å½“å‰æ˜¾ç¤ºçš„è®¢å•é€šçŸ¥
        const activeOrders = new Map();

        function showOrderNotification(orderData) {
            log(`ğŸ‰ æ˜¾ç¤ºè®¢å•é€šçŸ¥:`);
            log(`   è®¢å•ID: ${orderData.orderId}`);
            log(`   è®¢å•å·: ${orderData.orderNumber}`);
            log(`   ä¸Šè½¦åœ°å€: ${orderData.pickupAddress}`);
            log(`   ç›®çš„åœ°: ${orderData.destinationAddress}`);
            log(`   è·ç¦»: ${orderData.distance}km`);
            
            // åˆ›å»ºè®¢å•é€šçŸ¥å¡ç‰‡
            createOrderCard(orderData);
            
            // å­˜å‚¨åˆ°æ´»è·ƒè®¢å•åˆ—è¡¨
            activeOrders.set(orderData.orderId, orderData);
        }

        function createOrderCard(orderData) {
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨è¯¥è®¢å•å¡ç‰‡
            const existingCard = document.getElementById(`order-card-${orderData.orderId}`);
            if (existingCard) {
                return; // å·²å­˜åœ¨ï¼Œä¸é‡å¤åˆ›å»º
            }

            const logArea = document.getElementById('logArea');
            
            // åˆ›å»ºè®¢å•å¡ç‰‡
            const orderCard = document.createElement('div');
            orderCard.id = `order-card-${orderData.orderId}`;
            orderCard.style.cssText = `
                background: #fff3cd;
                border: 2px solid #ffc107;
                border-radius: 8px;
                padding: 15px;
                margin: 10px 0;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            `;
            
            orderCard.innerHTML = `
                <div style="font-weight: bold; color: #856404; margin-bottom: 10px;">
                    ğŸš— æ–°è®¢å•é€šçŸ¥ #${orderData.orderId}
                </div>
                <div style="margin-bottom: 8px;">ğŸ“ ä¸Šè½¦: ${orderData.pickupAddress}</div>
                <div style="margin-bottom: 8px;">ğŸ¯ ç›®çš„åœ°: ${orderData.destinationAddress}</div>
                <div style="margin-bottom: 8px;">ğŸ“ è·ç¦»: ${orderData.distance}km</div>
                <div style="margin-bottom: 15px;">ğŸ’° é¢„ä¼°è´¹ç”¨: ${orderData.estimatedFare || 'å¾…è®¡ç®—'}</div>
                <div>
                    <button onclick="acceptOrder(${orderData.orderId})" 
                            style="background: #28a745; color: white; border: none; padding: 8px 15px; border-radius: 4px; margin-right: 10px; cursor: pointer;">
                        âœ… æ¥å•
                    </button>
                    <button onclick="rejectOrder(${orderData.orderId})" 
                            style="background: #dc3545; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer;">
                        âŒ æ‹’å•
                    </button>
                </div>
            `;
            
            // æ’å…¥åˆ°æ—¥å¿—åŒºåŸŸé¡¶éƒ¨
            logArea.insertBefore(orderCard, logArea.firstChild);
        }

        function acceptOrder(orderId) {
            const driverId = document.getElementById('driverId').value;
            log(`âœ… å¸æœº ${driverId} æ­£åœ¨æ¥å• ${orderId}...`);
            
            // è°ƒç”¨æ¥å•API
            fetch(`http://localhost:8080/api/drivers/${driverId}/accept-order/${orderId}`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    log(`âœ… æ¥å•æˆåŠŸï¼è®¢å• ${orderId}`);
                    removeOrderCard(orderId);
                    
                    // é€šçŸ¥å…¶ä»–å¸æœºç§»é™¤è¯¥è®¢å•
                    broadcastOrderAccepted(orderId);
                } else {
                    log(`âŒ æ¥å•å¤±è´¥: ${data.message}`, true);
                }
            })
            .catch(error => {
                log(`âŒ æ¥å•è¯·æ±‚å¤±è´¥: ${error.message}`, true);
            });
        }

        function rejectOrder(orderId) {
            const driverId = document.getElementById('driverId').value;
            log(`âŒ å¸æœº ${driverId} æ­£åœ¨æ‹’å• ${orderId}...`);
            
            // è°ƒç”¨æ‹’å•API
            fetch(`http://localhost:8080/api/drivers/${driverId}/reject-order/${orderId}?reason=è·ç¦»å¤ªè¿œ`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    log(`âœ… æ‹’å•æˆåŠŸï¼è®¢å• ${orderId}`);
                    removeOrderCard(orderId);
                } else {
                    log(`âŒ æ‹’å•å¤±è´¥: ${data.message}`, true);
                }
            })
            .catch(error => {
                log(`âŒ æ‹’å•è¯·æ±‚å¤±è´¥: ${error.message}`, true);
            });
        }

        function removeOrderCard(orderId) {
            const orderCard = document.getElementById(`order-card-${orderId}`);
            if (orderCard) {
                orderCard.remove();
                activeOrders.delete(orderId);
                log(`ğŸ—‘ï¸ å·²ç§»é™¤è®¢å• ${orderId} çš„é€šçŸ¥å¡ç‰‡`);
            }
        }

        function broadcastOrderAccepted(orderId) {
            // ä½¿ç”¨localStorageå¹¿æ’­è®¢å•è¢«æ¥å•çš„æ¶ˆæ¯
            localStorage.setItem('orderAccepted', JSON.stringify({
                orderId: orderId,
                timestamp: Date.now()
            }));
            
            // ç«‹å³æ¸…é™¤ï¼Œé¿å…å½±å“å…¶ä»–æ“ä½œ
            setTimeout(() => {
                localStorage.removeItem('orderAccepted');
            }, 1000);
        }

        // ç›‘å¬å…¶ä»–çª—å£çš„è®¢å•æ¥å•å¹¿æ’­
        window.addEventListener('storage', function(e) {
            if (e.key === 'orderAccepted' && e.newValue) {
                const data = JSON.parse(e.newValue);
                const orderId = data.orderId;
                
                // å¦‚æœå½“å‰çª—å£æœ‰è¯¥è®¢å•ï¼Œåˆ™ç§»é™¤
                if (activeOrders.has(orderId)) {
                    removeOrderCard(orderId);
                    log(`ğŸ“¢ æ”¶åˆ°å¹¿æ’­: è®¢å• ${orderId} å·²è¢«å…¶ä»–å¸æœºæ¥å•`);
                }
            }
        });

        // é¡µé¢åŠ è½½å®Œæˆæ—¶åˆå§‹åŒ–
        window.onload = function () {
            initFromUrlParams();
            log('ğŸš€ WebSocketæµ‹è¯•å·¥å…·å·²å¯åŠ¨');
            log('ğŸ’¡ è¯·å…ˆè¿æ¥WebSocketï¼Œç„¶ååœ¨ä¸»é¡µé¢åˆ›å»ºè®¢å•è¿›è¡Œæµ‹è¯•');
        };
    </script>
</body>

</html>    <s
cript>
        function openMultiDriverTest() {
            // åˆ›å»ºå¤šä¸ªå¸æœºæµ‹è¯•çª—å£
            const driverCount = prompt('è¯·è¾“å…¥è¦æµ‹è¯•çš„å¸æœºæ•°é‡ï¼ˆå»ºè®®2-4ä¸ªï¼‰:', '3');
            if (driverCount && !isNaN(driverCount)) {
                const count = parseInt(driverCount);
                for (let i = 1; i <= count; i++) {
                    const url = `websocket-test.html?driverId=${i}&title=å¸æœº${i}`;
                    window.open(url, `driver${i}`, 'width=800,height=600,left=' + (i * 50) + ',top=' + (i * 50));
                }
            }
        }

        // ä»URLå‚æ•°è·å–å¸æœºIDå’Œæ ‡é¢˜
        function initFromUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const driverIdParam = urlParams.get('driverId');
            const titleParam = urlParams.get('title');
            
            if (driverIdParam) {
                document.getElementById('driverId').value = driverIdParam;
            }
            
            if (titleParam) {
                document.title = titleParam + ' - WebSocketæµ‹è¯•';
                const h1 = document.querySelector('h1');
                if (h1) {
                    h1.textContent = `ğŸ”§ ${titleParam} WebSocketè¿æ¥æµ‹è¯•å·¥å…·`;
                }
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆæ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initFromUrlParams();
            log('ğŸš€ WebSocketæµ‹è¯•å·¥å…·å·²å¯åŠ¨');
            log('ğŸ’¡ è¯·å…ˆè¿æ¥WebSocketï¼Œç„¶ååœ¨ä¸»é¡µé¢åˆ›å»ºè®¢å•è¿›è¡Œæµ‹è¯•');
        });
    </script>    <s
cript>
        // å­˜å‚¨å½“å‰æ˜¾ç¤ºçš„è®¢å•é€šçŸ¥
        const activeOrders = new Map();

        function showOrderNotification(orderData) {
            log(`ğŸ‰ æ˜¾ç¤ºè®¢å•é€šçŸ¥:`);
            log(`   è®¢å•ID: ${orderData.orderId}`);
            log(`   è®¢å•å·: ${orderData.orderNumber}`);
            log(`   ä¸Šè½¦åœ°å€: ${orderData.pickupAddress}`);
            log(`   ç›®çš„åœ°: ${orderData.destinationAddress}`);
            log(`   è·ç¦»: ${orderData.distance}km`);
            
            // åˆ›å»ºè®¢å•é€šçŸ¥å¡ç‰‡
            createOrderCard(orderData);
            
            // å­˜å‚¨åˆ°æ´»è·ƒè®¢å•åˆ—è¡¨
            activeOrders.set(orderData.orderId, orderData);
        }

        function createOrderCard(orderData) {
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨è¯¥è®¢å•å¡ç‰‡
            const existingCard = document.getElementById(`order-card-${orderData.orderId}`);
            if (existingCard) {
                return; // å·²å­˜åœ¨ï¼Œä¸é‡å¤åˆ›å»º
            }

            const logArea = document.getElementById('logArea');
            
            // åˆ›å»ºè®¢å•å¡ç‰‡
            const orderCard = document.createElement('div');
            orderCard.id = `order-card-${orderData.orderId}`;
            orderCard.style.cssText = `
                background: #fff3cd;
                border: 2px solid #ffc107;
                border-radius: 8px;
                padding: 15px;
                margin: 10px 0;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            `;
            
            orderCard.innerHTML = `
                <div style="font-weight: bold; color: #856404; margin-bottom: 10px;">
                    ğŸš— æ–°è®¢å•é€šçŸ¥ #${orderData.orderId}
                </div>
                <div style="margin-bottom: 8px;">ğŸ“ ä¸Šè½¦: ${orderData.pickupAddress}</div>
                <div style="margin-bottom: 8px;">ğŸ¯ ç›®çš„åœ°: ${orderData.destinationAddress}</div>
                <div style="margin-bottom: 8px;">ğŸ“ è·ç¦»: ${orderData.distance}km</div>
                <div style="margin-bottom: 15px;">ğŸ’° é¢„ä¼°è´¹ç”¨: ${orderData.estimatedFare || 'å¾…è®¡ç®—'}</div>
                <div>
                    <button onclick="acceptOrder(${orderData.orderId})" 
                            style="background: #28a745; color: white; border: none; padding: 8px 15px; border-radius: 4px; margin-right: 10px; cursor: pointer;">
                        âœ… æ¥å•
                    </button>
                    <button onclick="rejectOrder(${orderData.orderId})" 
                            style="background: #dc3545; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer;">
                        âŒ æ‹’å•
                    </button>
                </div>
            `;
            
            // æ’å…¥åˆ°æ—¥å¿—åŒºåŸŸé¡¶éƒ¨
            logArea.insertBefore(orderCard, logArea.firstChild);
        }

        function acceptOrder(orderId) {
            const driverId = document.getElementById('driverId').value;
            log(`âœ… å¸æœº ${driverId} æ­£åœ¨æ¥å• ${orderId}...`);
            
            // è°ƒç”¨æ¥å•API
            fetch(`http://localhost:8080/api/drivers/${driverId}/accept-order/${orderId}`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    log(`âœ… æ¥å•æˆåŠŸï¼è®¢å• ${orderId}`);
                    removeOrderCard(orderId);
                    
                    // é€šçŸ¥å…¶ä»–å¸æœºç§»é™¤è¯¥è®¢å•
                    broadcastOrderAccepted(orderId);
                } else {
                    log(`âŒ æ¥å•å¤±è´¥: ${data.message}`, true);
                }
            })
            .catch(error => {
                log(`âŒ æ¥å•è¯·æ±‚å¤±è´¥: ${error.message}`, true);
            });
        }

        function rejectOrder(orderId) {
            const driverId = document.getElementById('driverId').value;
            log(`âŒ å¸æœº ${driverId} æ­£åœ¨æ‹’å• ${orderId}...`);
            
            // è°ƒç”¨æ‹’å•API
            fetch(`http://localhost:8080/api/drivers/${driverId}/reject-order/${orderId}?reason=è·ç¦»å¤ªè¿œ`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    log(`âœ… æ‹’å•æˆåŠŸï¼è®¢å• ${orderId}`);
                    removeOrderCard(orderId);
                } else {
                    log(`âŒ æ‹’å•å¤±è´¥: ${data.message}`, true);
                }
            })
            .catch(error => {
                log(`âŒ æ‹’å•è¯·æ±‚å¤±è´¥: ${error.message}`, true);
            });
        }

        function removeOrderCard(orderId) {
            const orderCard = document.getElementById(`order-card-${orderId}`);
            if (orderCard) {
                orderCard.remove();
                activeOrders.delete(orderId);
                log(`ğŸ—‘ï¸ å·²ç§»é™¤è®¢å• ${orderId} çš„é€šçŸ¥å¡ç‰‡`);
            }
        }

        function broadcastOrderAccepted(orderId) {
            // ä½¿ç”¨localStorageå¹¿æ’­è®¢å•è¢«æ¥å•çš„æ¶ˆæ¯
            localStorage.setItem('orderAccepted', JSON.stringify({
                orderId: orderId,
                timestamp: Date.now()
            }));
            
            // ç«‹å³æ¸…é™¤ï¼Œé¿å…å½±å“å…¶ä»–æ“ä½œ
            setTimeout(() => {
                localStorage.removeItem('orderAccepted');
            }, 1000);
        }

        // ç›‘å¬å…¶ä»–çª—å£çš„è®¢å•æ¥å•å¹¿æ’­
        window.addEventListener('storage', function(e) {
            if (e.key === 'orderAccepted' && e.newValue) {
                const data = JSON.parse(e.newValue);
                const orderId = data.orderId;
                
                // å¦‚æœå½“å‰çª—å£æœ‰è¯¥è®¢å•ï¼Œåˆ™ç§»é™¤
                if (activeOrders.has(orderId)) {
                    removeOrderCard(orderId);
                    log(`ğŸ“¢ æ”¶åˆ°å¹¿æ’­: è®¢å• ${orderId} å·²è¢«å…¶ä»–å¸æœºæ¥å•`);
                }
            }
        });
    </script>