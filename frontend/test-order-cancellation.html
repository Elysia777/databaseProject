<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è®¢å•å–æ¶ˆæµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #333;
        }
        button {
            background: #409EFF;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #66b1ff;
        }
        button.danger {
            background: #f56c6c;
        }
        button.success {
            background: #67c23a;
        }
        .result-display {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 14px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .status-good {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .status-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .status-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        .order-flow {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
            margin: 10px 0;
        }
        .flow-step {
            text-align: center;
            flex: 1;
        }
        .flow-arrow {
            font-size: 20px;
            color: #409EFF;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>âŒ è®¢å•å–æ¶ˆåŠŸèƒ½æµ‹è¯•</h1>
        <p>æµ‹è¯•ä¹˜å®¢å–æ¶ˆè®¢å•åå¸æœºç«¯çš„å¤„ç†</p>
    </div>

    <div class="container">
        <h2>ğŸ”§ ä¿®å¤å†…å®¹</h2>
        <div class="test-section">
            <h3>é—®é¢˜æè¿°</h3>
            <ul>
                <li>ä¹˜å®¢å–æ¶ˆè®¢å•åï¼Œå¸æœºç«¯ä¸‹é¢è¿˜ä¼šæ˜¾ç¤ºå½“å‰è®¢å•å†…å®¹</li>
                <li>å¸æœºæ²¡æœ‰æ”¶åˆ°ä¹˜å®¢å–æ¶ˆè®¢å•çš„é€šçŸ¥</li>
            </ul>
            
            <h3>ä¿®å¤æ–¹æ¡ˆ</h3>
            <ul>
                <li>ä¿®å¤è®¢å•IDæ¯”è¾ƒé€»è¾‘ï¼ˆç±»å‹è½¬æ¢é—®é¢˜ï¼‰</li>
                <li>å¢å¼ºresetOrderStateå‡½æ•°çš„æ¸…ç†åŠŸèƒ½</li>
                <li>æ”¹è¿›å–æ¶ˆé€šçŸ¥çš„å¤„ç†é€»è¾‘</li>
                <li>ç¡®ä¿åœ°å›¾æ ‡è®°å’Œè·¯å¾„è§„åˆ’è¢«æ­£ç¡®æ¸…ç†</li>
            </ul>
        </div>
    </div>

    <div class="container">
        <h2>ğŸ“‹ æµ‹è¯•æµç¨‹</h2>
        <div class="order-flow">
            <div class="flow-step">
                <div>1. åˆ›å»ºè®¢å•</div>
                <small>ä¹˜å®¢ä¸‹å•</small>
            </div>
            <div class="flow-arrow">â†’</div>
            <div class="flow-step">
                <div>2. å¸æœºæ¥å•</div>
                <small>è®¢å•åˆ†é…</small>
            </div>
            <div class="flow-arrow">â†’</div>
            <div class="flow-step">
                <div>3. ä¹˜å®¢å–æ¶ˆ</div>
                <small>æµ‹è¯•é‡ç‚¹</small>
            </div>
            <div class="flow-arrow">â†’</div>
            <div class="flow-step">
                <div>4. å¸æœºæ”¶åˆ°é€šçŸ¥</div>
                <small>éªŒè¯ç»“æœ</small>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="test-section">
            <h3>1. åˆ›å»ºæµ‹è¯•è®¢å•</h3>
            <button onclick="createTestOrder()">åˆ›å»ºæµ‹è¯•è®¢å•</button>
            <button onclick="checkOrderStatus()">æ£€æŸ¥è®¢å•çŠ¶æ€</button>
            
            <div id="orderResult" class="result-display">
                ç‚¹å‡»æŒ‰é’®åˆ›å»ºæµ‹è¯•è®¢å•...
            </div>
        </div>

        <div class="test-section">
            <h3>2. æ¨¡æ‹Ÿå¸æœºæ¥å•</h3>
            <button onclick="simulateDriverAccept()">å¸æœºæ¥å•</button>
            <button onclick="checkDriverOrder()">æ£€æŸ¥å¸æœºè®¢å•</button>
            
            <div id="driverResult" class="result-display">
                ç‚¹å‡»æŒ‰é’®æ¨¡æ‹Ÿå¸æœºæ¥å•...
            </div>
        </div>

        <div class="test-section">
            <h3>3. æµ‹è¯•ä¹˜å®¢å–æ¶ˆ</h3>
            <button onclick="cancelOrderByPassenger()" class="danger">ä¹˜å®¢å–æ¶ˆè®¢å•</button>
            <button onclick="checkCancellationEffect()">æ£€æŸ¥å–æ¶ˆæ•ˆæœ</button>
            
            <div id="cancelResult" class="result-display">
                ç‚¹å‡»æŒ‰é’®æµ‹è¯•ä¹˜å®¢å–æ¶ˆè®¢å•...
            </div>
        </div>

        <div class="test-section">
            <h3>4. WebSocketæ¶ˆæ¯ç›‘å¬</h3>
            <button onclick="startWebSocketMonitor()">å¼€å§‹ç›‘å¬</button>
            <button onclick="stopWebSocketMonitor()">åœæ­¢ç›‘å¬</button>
            
            <div id="websocketResult" class="result-display">
                ç‚¹å‡»æŒ‰é’®å¼€å§‹ç›‘å¬WebSocketæ¶ˆæ¯...
            </div>
        </div>
    </div>

    <script>
        let testOrderId = null;
        let wsMonitor = null;

        function log(message, containerId) {
            const container = document.getElementById(containerId);
            const timestamp = new Date().toLocaleTimeString();
            container.textContent += `[${timestamp}] ${message}\\n`;
            container.scrollTop = container.scrollHeight;
            console.log(message);
        }

        async function createTestOrder() {
            const resultDiv = document.getElementById('orderResult');
            resultDiv.textContent = '';
            resultDiv.className = 'result-display';
            
            log('ğŸ“‹ åˆ›å»ºæµ‹è¯•è®¢å•...', 'orderResult');
            
            try {
                const orderData = {
                    passengerId: 1,
                    pickupAddress: 'å–æ¶ˆæµ‹è¯•è®¢å• - å¤§è¿ç†å·¥å¤§å­¦',
                    pickupLatitude: 39.044237,
                    pickupLongitude: 121.749849,
                    destinationAddress: 'æµ‹è¯•ç›®çš„åœ° - å¤§è¿ç«è½¦ç«™',
                    destinationLatitude: 39.054237,
                    destinationLongitude: 121.759849
                };
                
                const response = await fetch('/api/orders/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(orderData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    testOrderId = result.data;
                    log(`âœ… è®¢å•åˆ›å»ºæˆåŠŸï¼ŒID: ${testOrderId}`, 'orderResult');
                    resultDiv.className = 'result-display status-good';
                } else {
                    log(`âŒ è®¢å•åˆ›å»ºå¤±è´¥: ${response.status}`, 'orderResult');
                    resultDiv.className = 'result-display status-error';
                }
            } catch (error) {
                log(`âŒ åˆ›å»ºè®¢å•å¼‚å¸¸: ${error.message}`, 'orderResult');
                resultDiv.className = 'result-display status-error';
            }
        }

        async function checkOrderStatus() {
            if (!testOrderId) {
                log('âŒ è¯·å…ˆåˆ›å»ºæµ‹è¯•è®¢å•', 'orderResult');
                return;
            }
            
            try {
                const response = await fetch(`/api/orders/${testOrderId}`);
                if (response.ok) {
                    const result = await response.json();
                    const order = result.data;
                    log(`è®¢å•çŠ¶æ€: ${order.status}`, 'orderResult');
                    log(`å¸æœºID: ${order.driverId || 'æœªåˆ†é…'}`, 'orderResult');
                    log(`å–æ¶ˆåŸå› : ${order.cancelReason || 'æ— '}`, 'orderResult');
                } else {
                    log(`âŒ æ£€æŸ¥è®¢å•çŠ¶æ€å¤±è´¥: ${response.status}`, 'orderResult');
                }
            } catch (error) {
                log(`âŒ æ£€æŸ¥è®¢å•çŠ¶æ€å¼‚å¸¸: ${error.message}`, 'orderResult');
            }
        }

        async function simulateDriverAccept() {
            if (!testOrderId) {
                log('âŒ è¯·å…ˆåˆ›å»ºæµ‹è¯•è®¢å•', 'driverResult');
                return;
            }
            
            const resultDiv = document.getElementById('driverResult');
            resultDiv.textContent = '';
            resultDiv.className = 'result-display';
            
            log('ğŸš— æ¨¡æ‹Ÿå¸æœºæ¥å•...', 'driverResult');
            
            try {
                const response = await fetch(`/api/drivers/1/accept-order/${testOrderId}`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    log('âœ… å¸æœºæ¥å•æˆåŠŸ', 'driverResult');
                    resultDiv.className = 'result-display status-good';
                } else {
                    log(`âŒ å¸æœºæ¥å•å¤±è´¥: ${response.status}`, 'driverResult');
                    resultDiv.className = 'result-display status-error';
                }
            } catch (error) {
                log(`âŒ å¸æœºæ¥å•å¼‚å¸¸: ${error.message}`, 'driverResult');
                resultDiv.className = 'result-display status-error';
            }
        }

        async function checkDriverOrder() {
            log('ğŸ” æ£€æŸ¥å¸æœºå½“å‰è®¢å•...', 'driverResult');
            
            try {
                const response = await fetch('/api/drivers/1/status-detail');
                if (response.ok) {
                    const result = await response.json();
                    // è¿™é‡Œå¯ä»¥æ£€æŸ¥å¸æœºçš„å½“å‰è®¢å•çŠ¶æ€
                    log('å¸æœºçŠ¶æ€æ£€æŸ¥å®Œæˆ', 'driverResult');
                }
            } catch (error) {
                log(`âŒ æ£€æŸ¥å¸æœºè®¢å•å¼‚å¸¸: ${error.message}`, 'driverResult');
            }
        }

        async function cancelOrderByPassenger() {
            if (!testOrderId) {
                log('âŒ è¯·å…ˆåˆ›å»ºæµ‹è¯•è®¢å•', 'cancelResult');
                return;
            }
            
            const resultDiv = document.getElementById('cancelResult');
            resultDiv.textContent = '';
            resultDiv.className = 'result-display';
            
            log('âŒ ä¹˜å®¢å–æ¶ˆè®¢å•...', 'cancelResult');
            
            try {
                const response = await fetch(`/api/orders/${testOrderId}/cancel`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    const result = await response.json();
                    log('âœ… è®¢å•å–æ¶ˆæˆåŠŸ', 'cancelResult');
                    log(`å“åº”: ${result.message}`, 'cancelResult');
                    log('\\nç­‰å¾…å¸æœºç«¯æ”¶åˆ°å–æ¶ˆé€šçŸ¥...', 'cancelResult');
                    resultDiv.className = 'result-display status-good';
                    
                    // å»¶è¿Ÿæ£€æŸ¥å–æ¶ˆæ•ˆæœ
                    setTimeout(() => {
                        checkCancellationEffect();
                    }, 2000);
                } else {
                    log(`âŒ è®¢å•å–æ¶ˆå¤±è´¥: ${response.status}`, 'cancelResult');
                    resultDiv.className = 'result-display status-error';
                }
            } catch (error) {
                log(`âŒ è®¢å•å–æ¶ˆå¼‚å¸¸: ${error.message}`, 'cancelResult');
                resultDiv.className = 'result-display status-error';
            }
        }

        async function checkCancellationEffect() {
            log('\\nğŸ” æ£€æŸ¥å–æ¶ˆæ•ˆæœ...', 'cancelResult');
            
            try {
                // æ£€æŸ¥è®¢å•çŠ¶æ€
                const orderResponse = await fetch(`/api/orders/${testOrderId}`);
                if (orderResponse.ok) {
                    const orderResult = await orderResponse.json();
                    const order = orderResult.data;
                    
                    log(`è®¢å•çŠ¶æ€: ${order.status}`, 'cancelResult');
                    log(`å–æ¶ˆåŸå› : ${order.cancelReason}`, 'cancelResult');
                    
                    if (order.status === 'CANCELLED') {
                        log('âœ… è®¢å•çŠ¶æ€å·²æ›´æ–°ä¸ºCANCELLED', 'cancelResult');
                    } else {
                        log('âŒ è®¢å•çŠ¶æ€æœªæ­£ç¡®æ›´æ–°', 'cancelResult');
                    }
                }
                
                // æ£€æŸ¥å¸æœºçŠ¶æ€
                const driverResponse = await fetch('/api/drivers/1/status-detail');
                if (driverResponse.ok) {
                    const driverResult = await driverResponse.json();
                    // å¯ä»¥æ£€æŸ¥å¸æœºæ˜¯å¦å·²é‡Šæ”¾
                    log('å¸æœºçŠ¶æ€æ£€æŸ¥å®Œæˆ', 'cancelResult');
                }
                
            } catch (error) {
                log(`âŒ æ£€æŸ¥å–æ¶ˆæ•ˆæœå¼‚å¸¸: ${error.message}`, 'cancelResult');
            }
        }

        function startWebSocketMonitor() {
            const resultDiv = document.getElementById('websocketResult');
            resultDiv.textContent = '';
            resultDiv.className = 'result-display';
            
            log('ğŸ”Œ å¼€å§‹ç›‘å¬WebSocketæ¶ˆæ¯...', 'websocketResult');
            
            try {
                wsMonitor = new WebSocket('ws://localhost:8080/ws/driver/1');
                
                wsMonitor.onopen = function() {
                    log('âœ… WebSocketè¿æ¥æˆåŠŸ', 'websocketResult');
                    resultDiv.className = 'result-display status-good';
                };
                
                wsMonitor.onmessage = function(event) {
                    log(`ğŸ“¨ æ”¶åˆ°æ¶ˆæ¯: ${event.data}`, 'websocketResult');
                    
                    try {
                        const data = JSON.parse(event.data);
                        if (data.type === 'ORDER_CANCELLED') {
                            log('ğŸ¯ æ”¶åˆ°è®¢å•å–æ¶ˆé€šçŸ¥ï¼', 'websocketResult');
                            log(`å–æ¶ˆåŸå› : ${data.reason}`, 'websocketResult');
                            log(`è®¢å•ID: ${data.orderId}`, 'websocketResult');
                        }
                    } catch (e) {
                        // å¿½ç•¥è§£æé”™è¯¯
                    }
                };
                
                wsMonitor.onerror = function(error) {
                    log(`âŒ WebSocketé”™è¯¯: ${error}`, 'websocketResult');
                    resultDiv.className = 'result-display status-error';
                };
                
                wsMonitor.onclose = function() {
                    log('ğŸ”Œ WebSocketè¿æ¥å…³é—­', 'websocketResult');
                };
                
            } catch (error) {
                log(`âŒ WebSocketç›‘å¬å¼‚å¸¸: ${error.message}`, 'websocketResult');
                resultDiv.className = 'result-display status-error';
            }
        }

        function stopWebSocketMonitor() {
            if (wsMonitor) {
                wsMonitor.close();
                wsMonitor = null;
                log('ğŸ”Œ WebSocketç›‘å¬å·²åœæ­¢', 'websocketResult');
            }
        }

        // é¡µé¢å¸è½½æ—¶æ¸…ç†WebSocket
        window.onbeforeunload = function() {
            if (wsMonitor) {
                wsMonitor.close();
            }
        };
    </script>
</body>
</html>