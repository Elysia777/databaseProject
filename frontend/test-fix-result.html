<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¿®å¤ç»“æœæµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #333;
        }
        button {
            background: #409EFF;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #66b1ff;
        }
        button.success {
            background: #67c23a;
        }
        button.danger {
            background: #f56c6c;
        }
        .result-display {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 14px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .status-good {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .status-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .status-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ‰ ä¿®å¤ç»“æœæµ‹è¯•</h1>
        <p>éªŒè¯å¸æœºçŠ¶æ€ä¿®å¤å’Œè®¢å•æ¨é€åŠŸèƒ½</p>
    </div>

    <div class="container">
        <div class="test-section">
            <h3>1. å¸æœºçŠ¶æ€éªŒè¯</h3>
            <button onclick="checkDriverStatus()">æ£€æŸ¥å¸æœºçŠ¶æ€</button>
            <button onclick="checkRedisDrivers()">æ£€æŸ¥Rediså¸æœº</button>
            
            <div id="driverStatus" class="result-display">
                ç‚¹å‡»æŒ‰é’®æ£€æŸ¥å¸æœºçŠ¶æ€...
            </div>
        </div>

        <div class="test-section">
            <h3>2. è®¢å•æ¨é€æµ‹è¯•</h3>
            <button onclick="createTestOrder()">åˆ›å»ºæµ‹è¯•è®¢å•</button>
            <button onclick="checkPendingOrders()">æ£€æŸ¥å¾…åˆ†é…è®¢å•</button>
            
            <div id="orderStatus" class="result-display">
                ç‚¹å‡»æŒ‰é’®æµ‹è¯•è®¢å•æ¨é€...
            </div>
        </div>

        <div class="test-section">
            <h3>3. WebSocketè¿æ¥æµ‹è¯•</h3>
            <button onclick="testWebSocketConnection()">æµ‹è¯•WebSocketè¿æ¥</button>
            <button onclick="simulateDriverConnection()">æ¨¡æ‹Ÿå¸æœºè¿æ¥</button>
            
            <div id="websocketStatus" class="result-display">
                ç‚¹å‡»æŒ‰é’®æµ‹è¯•WebSocketè¿æ¥...
            </div>
        </div>

        <div class="test-section">
            <h3>4. å®Œæ•´æµç¨‹æµ‹è¯•</h3>
            <button onclick="runFullTest()" style="background: #f56c6c; font-size: 16px; padding: 15px 30px;">ğŸš€ è¿è¡Œå®Œæ•´æµ‹è¯•</button>
            
            <div id="fullTestStatus" class="result-display">
                ç‚¹å‡»æŒ‰é’®è¿è¡Œå®Œæ•´æµ‹è¯•æµç¨‹...
            </div>
        </div>
    </div>

    <script>
        function log(message, containerId = 'fullTestStatus') {
            const container = document.getElementById(containerId);
            const timestamp = new Date().toLocaleTimeString();
            container.textContent += `[${timestamp}] ${message}\\n`;
            container.scrollTop = container.scrollHeight;
            console.log(message);
        }

        async function checkDriverStatus() {
            const statusDiv = document.getElementById('driverStatus');
            let status = 'å¸æœºçŠ¶æ€æ£€æŸ¥ç»“æœ:\\n\\n';
            
            try {
                // æ£€æŸ¥å¸æœº1çš„è¯¦ç»†çŠ¶æ€
                const response = await fetch('/api/drivers/1/status-detail');
                if (response.ok) {
                    const result = await response.json();
                    const detail = result.data;
                    
                    status += '=== å¸æœº1çŠ¶æ€è¯¦æƒ… ===\\n';
                    status += `æ•°æ®åº“å­˜åœ¨: ${detail.consistency.dbExists ? 'âœ…' : 'âŒ'}\\n`;
                    status += `Rediså­˜åœ¨: ${detail.consistency.redisExists ? 'âœ…' : 'âŒ'}\\n`;
                    status += `åœ¨çº¿ä¸”ç©ºé—²: ${detail.isOnlineAndFree ? 'âœ…' : 'âŒ'}\\n`;
                    
                    if (detail.database) {
                        status += `å¸æœºå§“å: ${detail.database.name}\\n`;
                        status += `å¸æœºçŠ¶æ€: ${detail.database.status}\\n`;
                        status += `å½“å‰ä½ç½®: ${detail.database.currentLatitude}, ${detail.database.currentLongitude}\\n`;
                    }
                    
                    if (detail.geoPosition) {
                        status += `GEOä½ç½®: ${detail.geoPosition.x}, ${detail.geoPosition.y}\\n`;
                    }
                    
                    statusDiv.className = detail.consistency.dbExists && detail.consistency.redisExists && detail.isOnlineAndFree 
                        ? 'result-display status-good' : 'result-display status-warning';
                } else {
                    status += `âŒ æ£€æŸ¥å¤±è´¥: ${response.status}\\n`;
                    statusDiv.className = 'result-display status-error';
                }
            } catch (error) {
                status += `âŒ æ£€æŸ¥å¼‚å¸¸: ${error.message}\\n`;
                statusDiv.className = 'result-display status-error';
            }
            
            statusDiv.textContent = status;
        }

        async function checkRedisDrivers() {
            const statusDiv = document.getElementById('driverStatus');
            let status = 'Rediså¸æœºæ£€æŸ¥ç»“æœ:\\n\\n';
            
            try {
                const response = await fetch('/api/drivers/online/redis');
                if (response.ok) {
                    const result = await response.json();
                    const drivers = result.data || [];
                    
                    status += `âœ… Redisè¿æ¥æ­£å¸¸\\n`;
                    status += `åœ¨çº¿å¸æœºæ•°é‡: ${drivers.length}\\n\\n`;
                    
                    if (drivers.length > 0) {
                        status += 'åœ¨çº¿å¸æœºåˆ—è¡¨:\\n';
                        drivers.forEach(driver => {
                            status += `- å¸æœº${driver.id}: ${driver.name} (${driver.status})\\n`;
                            status += `  ä½ç½®: ${driver.currentLatitude}, ${driver.currentLongitude}\\n`;
                        });
                        statusDiv.className = 'result-display status-good';
                    } else {
                        status += 'âŒ æ²¡æœ‰åœ¨çº¿å¸æœº\\n';
                        statusDiv.className = 'result-display status-warning';
                    }
                } else {
                    status += `âŒ æ£€æŸ¥å¤±è´¥: ${response.status}\\n`;
                    statusDiv.className = 'result-display status-error';
                }
            } catch (error) {
                status += `âŒ æ£€æŸ¥å¼‚å¸¸: ${error.message}\\n`;
                statusDiv.className = 'result-display status-error';
            }
            
            statusDiv.textContent = status;
        }

        async function createTestOrder() {
            const statusDiv = document.getElementById('orderStatus');
            let status = 'åˆ›å»ºæµ‹è¯•è®¢å•ç»“æœ:\\n\\n';
            
            try {
                const orderData = {
                    passengerId: 1,
                    pickupAddress: 'æµ‹è¯•ä¸Šè½¦ç‚¹ (å¤§è¿ç†å·¥å¤§å­¦)',
                    pickupLatitude: 39.044237,
                    pickupLongitude: 121.749849,
                    destinationAddress: 'æµ‹è¯•ç›®çš„åœ° (å¤§è¿ç«è½¦ç«™)',
                    destinationLatitude: 39.054237,
                    destinationLongitude: 121.759849
                };
                
                const response = await fetch('/api/orders/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(orderData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    status += 'âœ… æµ‹è¯•è®¢å•åˆ›å»ºæˆåŠŸ\\n';
                    status += `è®¢å•ID: ${result.data}\\n`;
                    status += '\\næ­£åœ¨æ£€æŸ¥è®¢å•æ¨é€æƒ…å†µ...\\n';
                    
                    // ç­‰å¾…ä¸€ä¸‹ï¼Œç„¶åæ£€æŸ¥è®¢å•çŠ¶æ€
                    setTimeout(async () => {
                        try {
                            const orderResponse = await fetch(`/api/orders/${result.data}`);
                            if (orderResponse.ok) {
                                const orderResult = await orderResponse.json();
                                const order = orderResult.data;
                                status += `\\nè®¢å•çŠ¶æ€: ${order.status}\\n`;
                                if (order.driverId) {
                                    status += `åˆ†é…å¸æœº: ${order.driverId}\\n`;
                                } else {
                                    status += 'âš ï¸  è®¢å•å°šæœªåˆ†é…å¸æœº\\n';
                                }
                                statusDiv.textContent = status;
                            }
                        } catch (e) {
                            status += `\\nâŒ æ£€æŸ¥è®¢å•çŠ¶æ€å¤±è´¥: ${e.message}\\n`;
                            statusDiv.textContent = status;
                        }
                    }, 2000);
                    
                    statusDiv.className = 'result-display status-good';
                } else {
                    status += `âŒ åˆ›å»ºè®¢å•å¤±è´¥: ${response.status}\\n`;
                    statusDiv.className = 'result-display status-error';
                }
            } catch (error) {
                status += `âŒ åˆ›å»ºè®¢å•å¼‚å¸¸: ${error.message}\\n`;
                statusDiv.className = 'result-display status-error';
            }
            
            statusDiv.textContent = status;
        }

        async function checkPendingOrders() {
            const statusDiv = document.getElementById('orderStatus');
            let status = 'å¾…åˆ†é…è®¢å•æ£€æŸ¥ç»“æœ:\\n\\n';
            
            try {
                const response = await fetch('/api/orders');
                if (response.ok) {
                    const result = await response.json();
                    const orders = result.data || [];
                    
                    const pendingOrders = orders.filter(order => order.status === 'PENDING');
                    
                    status += `æ€»è®¢å•æ•°: ${orders.length}\\n`;
                    status += `å¾…åˆ†é…è®¢å•æ•°: ${pendingOrders.length}\\n\\n`;
                    
                    if (pendingOrders.length > 0) {
                        status += 'å¾…åˆ†é…è®¢å•åˆ—è¡¨:\\n';
                        pendingOrders.forEach(order => {
                            status += `- è®¢å•${order.id}: ${order.pickupAddress} -> ${order.destinationAddress}\\n`;
                            status += `  åˆ›å»ºæ—¶é—´: ${order.createdAt}\\n`;
                        });
                        statusDiv.className = 'result-display status-warning';
                    } else {
                        status += 'âœ… æ²¡æœ‰å¾…åˆ†é…è®¢å•\\n';
                        statusDiv.className = 'result-display status-good';
                    }
                } else {
                    status += `âŒ æ£€æŸ¥å¤±è´¥: ${response.status}\\n`;
                    statusDiv.className = 'result-display status-error';
                }
            } catch (error) {
                status += `âŒ æ£€æŸ¥å¼‚å¸¸: ${error.message}\\n`;
                statusDiv.className = 'result-display status-error';
            }
            
            statusDiv.textContent = status;
        }

        async function testWebSocketConnection() {
            const statusDiv = document.getElementById('websocketStatus');
            let status = 'WebSocketè¿æ¥æµ‹è¯•ç»“æœ:\\n\\n';
            
            try {
                // æµ‹è¯•WebSocketè¿æ¥
                const ws = new WebSocket('ws://localhost:8080/ws/driver/1');
                
                ws.onopen = function() {
                    status += 'âœ… WebSocketè¿æ¥æˆåŠŸ\\n';
                    status += 'æ­£åœ¨ç­‰å¾…æ¶ˆæ¯...\\n';
                    statusDiv.textContent = status;
                    statusDiv.className = 'result-display status-good';
                };
                
                ws.onmessage = function(event) {
                    status += `ğŸ“¨ æ”¶åˆ°æ¶ˆæ¯: ${event.data}\\n`;
                    statusDiv.textContent = status;
                };
                
                ws.onerror = function(error) {
                    status += `âŒ WebSocketé”™è¯¯: ${error}\\n`;
                    statusDiv.textContent = status;
                    statusDiv.className = 'result-display status-error';
                };
                
                ws.onclose = function() {
                    status += 'ğŸ”Œ WebSocketè¿æ¥å…³é—­\\n';
                    statusDiv.textContent = status;
                };
                
                // 5ç§’åå…³é—­è¿æ¥
                setTimeout(() => {
                    if (ws.readyState === WebSocket.OPEN) {
                        ws.close();
                        status += '\\næµ‹è¯•å®Œæˆï¼Œè¿æ¥å·²å…³é—­\\n';
                        statusDiv.textContent = status;
                    }
                }, 5000);
                
            } catch (error) {
                status += `âŒ WebSocketæµ‹è¯•å¼‚å¸¸: ${error.message}\\n`;
                statusDiv.textContent = status;
                statusDiv.className = 'result-display status-error';
            }
        }

        async function simulateDriverConnection() {
            const statusDiv = document.getElementById('websocketStatus');
            let status = 'æ¨¡æ‹Ÿå¸æœºè¿æ¥ç»“æœ:\\n\\n';
            
            try {
                // å…ˆè®©å¸æœºä¸Šçº¿
                const onlineResponse = await fetch('/api/drivers/1/online?latitude=39.044237&longitude=121.749849', {
                    method: 'POST'
                });
                
                if (onlineResponse.ok) {
                    status += 'âœ… å¸æœº1ä¸Šçº¿æˆåŠŸ\\n';
                    
                    // å»ºç«‹WebSocketè¿æ¥
                    const ws = new WebSocket('ws://localhost:8080/ws/driver/1');
                    
                    ws.onopen = function() {
                        status += 'âœ… å¸æœº1 WebSocketè¿æ¥å»ºç«‹\\n';
                        statusDiv.textContent = status;
                        statusDiv.className = 'result-display status-good';
                        
                        // è¿æ¥å»ºç«‹åï¼Œåˆ›å»ºä¸€ä¸ªæµ‹è¯•è®¢å•
                        setTimeout(async () => {
                            const orderData = {
                                passengerId: 1,
                                pickupAddress: 'æµ‹è¯•æ¨é€è®¢å•',
                                pickupLatitude: 39.044237,
                                pickupLongitude: 121.749849,
                                destinationAddress: 'æµ‹è¯•ç›®çš„åœ°',
                                destinationLatitude: 39.054237,
                                destinationLongitude: 121.759849
                            };
                            
                            const orderResponse = await fetch('/api/orders/create', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify(orderData)
                            });
                            
                            if (orderResponse.ok) {
                                status += '\\nğŸ“‹ åˆ›å»ºæµ‹è¯•è®¢å•ï¼Œç­‰å¾…æ¨é€...\\n';
                                statusDiv.textContent = status;
                            }
                        }, 1000);
                    };
                    
                    ws.onmessage = function(event) {
                        status += `\\nğŸ‰ æ”¶åˆ°è®¢å•æ¨é€: ${event.data}\\n`;
                        statusDiv.textContent = status;
                        statusDiv.className = 'result-display status-good';
                    };
                    
                    ws.onerror = function(error) {
                        status += `\\nâŒ WebSocketé”™è¯¯: ${error}\\n`;
                        statusDiv.textContent = status;
                        statusDiv.className = 'result-display status-error';
                    };
                    
                    // 10ç§’åå…³é—­è¿æ¥
                    setTimeout(() => {
                        if (ws.readyState === WebSocket.OPEN) {
                            ws.close();
                            status += '\\næµ‹è¯•å®Œæˆï¼Œè¿æ¥å·²å…³é—­\\n';
                            statusDiv.textContent = status;
                        }
                    }, 10000);
                    
                } else {
                    status += `âŒ å¸æœºä¸Šçº¿å¤±è´¥: ${onlineResponse.status}\\n`;
                    statusDiv.className = 'result-display status-error';
                }
            } catch (error) {
                status += `âŒ æ¨¡æ‹Ÿè¿æ¥å¼‚å¸¸: ${error.message}\\n`;
                statusDiv.className = 'result-display status-error';
            }
            
            statusDiv.textContent = status;
        }

        async function runFullTest() {
            const statusDiv = document.getElementById('fullTestStatus');
            statusDiv.textContent = '';
            statusDiv.className = 'result-display';
            
            log('ğŸš€ å¼€å§‹å®Œæ•´æµ‹è¯•æµç¨‹...');
            
            try {
                // æ­¥éª¤1: æ£€æŸ¥å¸æœºçŠ¶æ€
                log('æ­¥éª¤1: æ£€æŸ¥å¸æœºçŠ¶æ€...');
                const driverResponse = await fetch('/api/drivers/online/redis');
                if (driverResponse.ok) {
                    const result = await driverResponse.json();
                    const drivers = result.data || [];
                    log(`âœ… å‘ç° ${drivers.length} ä¸ªåœ¨çº¿å¸æœº`);
                    
                    if (drivers.length === 0) {
                        log('âš ï¸  æ²¡æœ‰åœ¨çº¿å¸æœºï¼Œå°è¯•ä¿®å¤...');
                        const fixResponse = await fetch('/api/drivers/fix-redis-status', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' }
                        });
                        if (fixResponse.ok) {
                            log('âœ… å¸æœºçŠ¶æ€ä¿®å¤å®Œæˆ');
                        }
                    }
                } else {
                    log('âŒ æ£€æŸ¥å¸æœºçŠ¶æ€å¤±è´¥');
                    return;
                }
                
                // æ­¥éª¤2: å»ºç«‹WebSocketè¿æ¥
                log('æ­¥éª¤2: å»ºç«‹å¸æœºWebSocketè¿æ¥...');
                const ws = new WebSocket('ws://localhost:8080/ws/driver/1');
                
                await new Promise((resolve, reject) => {
                    ws.onopen = function() {
                        log('âœ… å¸æœº1 WebSocketè¿æ¥å»ºç«‹æˆåŠŸ');
                        resolve();
                    };
                    
                    ws.onerror = function(error) {
                        log(`âŒ WebSocketè¿æ¥å¤±è´¥: ${error}`);
                        reject(error);
                    };
                    
                    setTimeout(() => {
                        reject(new Error('WebSocketè¿æ¥è¶…æ—¶'));
                    }, 5000);
                });
                
                // æ­¥éª¤3: åˆ›å»ºæµ‹è¯•è®¢å•
                log('æ­¥éª¤3: åˆ›å»ºæµ‹è¯•è®¢å•...');
                const orderData = {
                    passengerId: 1,
                    pickupAddress: 'å®Œæ•´æµ‹è¯•è®¢å•',
                    pickupLatitude: 39.044237,
                    pickupLongitude: 121.749849,
                    destinationAddress: 'æµ‹è¯•ç›®çš„åœ°',
                    destinationLatitude: 39.054237,
                    destinationLongitude: 121.759849
                };
                
                const orderResponse = await fetch('/api/orders/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(orderData)
                });
                
                if (orderResponse.ok) {
                    const orderResult = await orderResponse.json();
                    log(`âœ… è®¢å•åˆ›å»ºæˆåŠŸï¼ŒID: ${orderResult.data}`);
                    
                    // æ­¥éª¤4: ç­‰å¾…è®¢å•æ¨é€
                    log('æ­¥éª¤4: ç­‰å¾…è®¢å•æ¨é€...');
                    
                    let messageReceived = false;
                    ws.onmessage = function(event) {
                        log(`ğŸ‰ æ”¶åˆ°è®¢å•æ¨é€: ${event.data}`);
                        messageReceived = true;
                        
                        // è§£ææ¨é€æ¶ˆæ¯
                        try {
                            const pushData = JSON.parse(event.data);
                            if (pushData.type === 'NEW_ORDER') {
                                log('âœ… è®¢å•æ¨é€æ ¼å¼æ­£ç¡®');
                                log(`è®¢å•è¯¦æƒ…: ${pushData.data.pickupAddress} -> ${pushData.data.destinationAddress}`);
                            }
                        } catch (e) {
                            log('âš ï¸  æ¨é€æ¶ˆæ¯æ ¼å¼å¼‚å¸¸');
                        }
                    };
                    
                    // ç­‰å¾…5ç§’æ£€æŸ¥æ˜¯å¦æ”¶åˆ°æ¨é€
                    setTimeout(() => {
                        if (messageReceived) {
                            log('\\nğŸ‰ å®Œæ•´æµ‹è¯•æµç¨‹æˆåŠŸï¼');
                            log('âœ… å¸æœºçŠ¶æ€æ­£å¸¸');
                            log('âœ… WebSocketè¿æ¥æ­£å¸¸');
                            log('âœ… è®¢å•åˆ›å»ºæ­£å¸¸');
                            log('âœ… è®¢å•æ¨é€æ­£å¸¸');
                            statusDiv.className = 'result-display status-good';
                        } else {
                            log('\\nâš ï¸  æµ‹è¯•éƒ¨åˆ†æˆåŠŸ');
                            log('âœ… å¸æœºçŠ¶æ€æ­£å¸¸');
                            log('âœ… WebSocketè¿æ¥æ­£å¸¸');
                            log('âœ… è®¢å•åˆ›å»ºæ­£å¸¸');
                            log('âŒ æœªæ”¶åˆ°è®¢å•æ¨é€');
                            statusDiv.className = 'result-display status-warning';
                        }
                        
                        ws.close();
                        log('\\næµ‹è¯•å®Œæˆï¼Œè¿æ¥å·²å…³é—­');
                    }, 5000);
                    
                } else {
                    log('âŒ è®¢å•åˆ›å»ºå¤±è´¥');
                    statusDiv.className = 'result-display status-error';
                }
                
            } catch (error) {
                log(`âŒ æµ‹è¯•è¿‡ç¨‹ä¸­å‡ºç°å¼‚å¸¸: ${error.message}`);
                statusDiv.className = 'result-display status-error';
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥çŠ¶æ€
        window.onload = function() {
            setTimeout(() => {
                checkDriverStatus();
                checkRedisDrivers();
            }, 1000);
        };
    </script>
</body>
</html>