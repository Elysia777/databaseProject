<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¢„çº¦å•æ¿€æ´»çŠ¶æ€ä¿®å¤æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 3px;
        }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .info { background-color: #d1ecf1; color: #0c5460; }
        .warning { background-color: #fff3cd; color: #856404; }
        .problem-analysis {
            background: #fff3cd;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #ffc107;
            margin: 15px 0;
        }
        .fix-highlight {
            background: #d4edda;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #28a745;
            margin: 15px 0;
        }
        .code-block {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 14px;
            border: 1px solid #e9ecef;
            overflow-x: auto;
            margin: 10px 0;
        }
        .status-flow {
            display: flex;
            align-items: center;
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        .status-box {
            padding: 10px 15px;
            border-radius: 5px;
            margin: 0 10px;
            font-weight: bold;
            text-align: center;
            min-width: 100px;
        }
        .status-scheduled { background: #ffc107; color: #212529; }
        .status-pending { background: #17a2b8; color: white; }
        .status-assigned { background: #28a745; color: white; }
        .arrow {
            font-size: 20px;
            color: #6c757d;
        }
        .comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        .before, .after {
            padding: 15px;
            border-radius: 5px;
        }
        .before { 
            background: #fff3cd; 
            border-left: 4px solid #ffc107;
        }
        .after { 
            background: #d4edda; 
            border-left: 4px solid #28a745;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 3px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background-color: #0056b3; }
    </style>
</head>
<body>
    <h1>ğŸ”§ é¢„çº¦å•æ¿€æ´»çŠ¶æ€ä¿®å¤æµ‹è¯•</h1>

    <div class="test-section">
        <h3>ğŸ› é—®é¢˜å‘ç°</h3>
        <div class="problem-analysis">
            <strong>é—®é¢˜æè¿°ï¼š</strong><br>
            é¢„çº¦å•æ¿€æ´»åçŠ¶æ€æ²¡æœ‰ä» SCHEDULED æ”¹ä¸º PENDINGï¼Œå¯¼è‡´å…¶ä»–å¸æœºä¸Šçº¿åæŸ¥è¯¢ä¸åˆ°è¿™ä¸ªé¢„çº¦å•ã€‚
            <br><br>
            <strong>å½±å“ï¼š</strong><br>
            â€¢ é¢„çº¦å•æ¿€æ´»åä»ä¿æŒ SCHEDULED çŠ¶æ€<br>
            â€¢ æ–°ä¸Šçº¿çš„å¸æœºæ— æ³•çœ‹åˆ°å·²æ¿€æ´»çš„é¢„çº¦å•<br>
            â€¢ åªæœ‰æ¿€æ´»æ—¶åœ¨çº¿çš„å¸æœºèƒ½æ”¶åˆ°é€šçŸ¥<br>
            â€¢ é™ä½äº†é¢„çº¦å•çš„æ´¾å•æˆåŠŸç‡
        </div>
    </div>

    <div class="test-section">
        <h3>ğŸ“Š çŠ¶æ€æµè½¬å¯¹æ¯”</h3>
        
        <h4>âŒ ä¿®å¤å‰çš„çŠ¶æ€æµè½¬</h4>
        <div class="status-flow">
            <div class="status-box status-scheduled">SCHEDULED</div>
            <div class="arrow">â†’</div>
            <div class="status-box status-scheduled">SCHEDULED</div>
            <div class="arrow">â†’</div>
            <div class="status-box status-assigned">ASSIGNED</div>
        </div>
        <div class="result error">
            <strong>é—®é¢˜ï¼š</strong> æ¿€æ´»åä»ç„¶æ˜¯ SCHEDULED çŠ¶æ€ï¼Œæ–°ä¸Šçº¿å¸æœºæŸ¥è¯¢ä¸åˆ°
        </div>

        <h4>âœ… ä¿®å¤åçš„çŠ¶æ€æµè½¬</h4>
        <div class="status-flow">
            <div class="status-box status-scheduled">SCHEDULED</div>
            <div class="arrow">â†’</div>
            <div class="status-box status-pending">PENDING</div>
            <div class="arrow">â†’</div>
            <div class="status-box status-assigned">ASSIGNED</div>
        </div>
        <div class="result success">
            <strong>æ­£ç¡®ï¼š</strong> æ¿€æ´»åå˜ä¸º PENDING çŠ¶æ€ï¼Œæ‰€æœ‰å¸æœºéƒ½èƒ½æŸ¥è¯¢åˆ°
        </div>
    </div>

    <div class="test-section">
        <h3>ğŸ” ä»£ç ä¿®å¤å¯¹æ¯”</h3>
        
        <div class="comparison">
            <div class="before">
                <h4>âŒ ä¿®å¤å‰çš„æ¿€æ´»é€»è¾‘</h4>
                <div class="code-block">
try {
    // å¼€å§‹åˆ†é…å¸æœº
    log.info("å¼€å§‹ä¸ºé¢„çº¦å•åˆ†é…å¸æœº: orderId={}", orderId);
    orderDispatchService.dispatchOrder(orderId);
    
    // è®¾ç½®è¶…æ—¶å–æ¶ˆä»»åŠ¡ï¼ˆ30åˆ†é’Ÿåï¼‰
    scheduleOrderTimeout(orderId);
    
    log.info("é¢„çº¦å•æ¿€æ´»æˆåŠŸ: orderId={}", orderId);
    
} catch (Exception e) {
    // æ¿€æ´»å¤±è´¥ï¼Œå–æ¶ˆè®¢å•
    cancelScheduledOrder(orderId, "ç³»ç»Ÿæ¿€æ´»å¤±è´¥");
}

// âŒ é—®é¢˜ï¼šæ²¡æœ‰å°†çŠ¶æ€ä»SCHEDULEDæ”¹ä¸ºPENDING
                </div>
            </div>
            
            <div class="after">
                <h4>âœ… ä¿®å¤åçš„æ¿€æ´»é€»è¾‘</h4>
                <div class="code-block">
try {
    // âœ… é¦–å…ˆå°†é¢„çº¦å•çŠ¶æ€ä»SCHEDULEDæ”¹ä¸ºPENDING
    log.info("å°†é¢„çº¦å•çŠ¶æ€ä»SCHEDULEDæ”¹ä¸ºPENDING: orderId={}", orderId);
    order.setStatus("PENDING");
    order.setUpdatedAt(LocalDateTime.now());
    orderMapper.updateById(order);
    
    // âœ… é€šçŸ¥ä¹˜å®¢é¢„çº¦å•å·²æ¿€æ´»
    webSocketNotificationService.notifyPassengerOrderStatusChange(
        order.getPassengerId(), orderId, "PENDING", 
        "é¢„çº¦æ—¶é—´å·²åˆ°ï¼Œæ­£åœ¨ä¸ºæ‚¨å¯»æ‰¾å¸æœº...");
    
    // å¼€å§‹åˆ†é…å¸æœº
    orderDispatchService.dispatchOrder(orderId);
    
    // è®¾ç½®è¶…æ—¶å–æ¶ˆä»»åŠ¡
    scheduleOrderTimeout(orderId);
    
} catch (Exception e) {
    cancelScheduledOrder(orderId, "ç³»ç»Ÿæ¿€æ´»å¤±è´¥");
}
                </div>
            </div>
        </div>
    </div>

    <div class="test-section">
        <h3>ğŸ”§ ä¿®å¤å†…å®¹è¯¦è§£</h3>
        
        <div class="fix-highlight">
            <strong>1. çŠ¶æ€æ›´æ–°</strong><br>
            â€¢ åœ¨è°ƒç”¨ dispatchOrder ä¹‹å‰å…ˆæ›´æ–°è®¢å•çŠ¶æ€<br>
            â€¢ ä» SCHEDULED æ”¹ä¸º PENDING<br>
            â€¢ æ›´æ–° updatedAt æ—¶é—´æˆ³
        </div>
        
        <div class="fix-highlight">
            <strong>2. ä¹˜å®¢é€šçŸ¥</strong><br>
            â€¢ é€šçŸ¥ä¹˜å®¢é¢„çº¦å•å·²æ¿€æ´»<br>
            â€¢ çŠ¶æ€æ–‡æœ¬ï¼š"é¢„çº¦æ—¶é—´å·²åˆ°ï¼Œæ­£åœ¨ä¸ºæ‚¨å¯»æ‰¾å¸æœº..."<br>
            â€¢ ç¡®ä¿å‰ç«¯çŠ¶æ€åŒæ­¥
        </div>
        
        <div class="fix-highlight">
            <strong>3. æ—¥å¿—å¢å¼º</strong><br>
            â€¢ è¯¦ç»†è®°å½•çŠ¶æ€å˜æ›´è¿‡ç¨‹<br>
            â€¢ åŒºåˆ†æˆåŠŸå’Œå¤±è´¥çš„æ—¥å¿—<br>
            â€¢ ä¾¿äºé—®é¢˜æ’æŸ¥å’Œç›‘æ§
        </div>
    </div>

    <div class="test-section">
        <h3>ğŸ§ª æµ‹è¯•åœºæ™¯</h3>
        
        <div class="result info">
            <strong>åœºæ™¯1ï¼šé¢„çº¦å•æ­£å¸¸æ¿€æ´»</strong><br>
            1. åˆ›å»ºé¢„çº¦å•ï¼ˆçŠ¶æ€ï¼šSCHEDULEDï¼‰<br>
            2. ç­‰å¾…æ¿€æ´»æ—¶é—´åˆ°è¾¾<br>
            3. ç³»ç»Ÿè‡ªåŠ¨æ¿€æ´»ï¼ˆçŠ¶æ€ï¼šSCHEDULED â†’ PENDINGï¼‰<br>
            4. éªŒè¯çŠ¶æ€æ­£ç¡®æ›´æ–° âœ…
        </div>
        
        <div class="result info">
            <strong>åœºæ™¯2ï¼šå¸æœºä¸Šçº¿æŸ¥è¯¢</strong><br>
            1. é¢„çº¦å•å·²æ¿€æ´»ï¼ˆçŠ¶æ€ï¼šPENDINGï¼‰<br>
            2. æ–°å¸æœºä¸Šçº¿<br>
            3. å¸æœºæŸ¥è¯¢å¾…åˆ†é…è®¢å•<br>
            4. èƒ½å¤ŸæŸ¥è¯¢åˆ°å·²æ¿€æ´»çš„é¢„çº¦å• âœ…
        </div>
        
        <div class="result info">
            <strong>åœºæ™¯3ï¼šä¹˜å®¢ç«¯çŠ¶æ€åŒæ­¥</strong><br>
            1. é¢„çº¦å•æ¿€æ´»æ—¶<br>
            2. ä¹˜å®¢æ”¶åˆ°çŠ¶æ€å˜æ›´é€šçŸ¥<br>
            3. å‰ç«¯æ˜¾ç¤º"æ­£åœ¨ä¸ºæ‚¨å¯»æ‰¾å¸æœº..."<br>
            4. çŠ¶æ€æ–‡æœ¬æ­£ç¡®æ˜¾ç¤º âœ…
        </div>
    </div>

    <div class="test-section">
        <h3>ğŸ” å…³é”®æ£€æŸ¥ç‚¹</h3>
        
        <div class="result warning">
            <strong>åç«¯æ—¥å¿—å…³é”®è¯ï¼š</strong><br>
            â€¢ "å°†é¢„çº¦å•çŠ¶æ€ä»SCHEDULEDæ”¹ä¸ºPENDING: orderId=X"<br>
            â€¢ "âœ… é¢„çº¦å•çŠ¶æ€å·²æ›´æ–°ä¸ºPENDING: orderId=X"<br>
            â€¢ "âœ… å·²é€šçŸ¥ä¹˜å®¢é¢„çº¦å•æ¿€æ´»: passengerId=X"<br>
            â€¢ "âœ… é¢„çº¦å•æ¿€æ´»æˆåŠŸ: orderId=X"
        </div>
        
        <div class="result warning">
            <strong>æ•°æ®åº“æ£€æŸ¥ï¼š</strong><br>
            â€¢ æŸ¥è¯¢ orders è¡¨ä¸­é¢„çº¦å•çš„ status å­—æ®µ<br>
            â€¢ æ¿€æ´»å‰ï¼šstatus = 'SCHEDULED'<br>
            â€¢ æ¿€æ´»åï¼šstatus = 'PENDING'<br>
            â€¢ updated_at å­—æ®µåº”è¯¥æ›´æ–°
        </div>
        
        <div class="result warning">
            <strong>å‰ç«¯çŠ¶æ€æ£€æŸ¥ï¼š</strong><br>
            â€¢ ä¹˜å®¢ç«¯æ”¶åˆ° ORDER_STATUS_CHANGE æ¶ˆæ¯<br>
            â€¢ çŠ¶æ€æ–‡æœ¬æ˜¾ç¤º"æ­£åœ¨ä¸ºæ‚¨å¯»æ‰¾å¸æœº..."<br>
            â€¢ å¸æœºç«¯èƒ½æŸ¥è¯¢åˆ° PENDING çŠ¶æ€çš„é¢„çº¦å•
        </div>
    </div>

    <div class="test-section">
        <h3>ğŸš€ å¼€å§‹æµ‹è¯•</h3>
        <p>ä½¿ç”¨ä»¥ä¸‹é“¾æ¥è¿›è¡Œé¢„çº¦å•æ¿€æ´»çŠ¶æ€æµ‹è¯•ï¼š</p>
        
        <div style="margin: 20px 0;">
            <a href="/passenger-app.html" target="_blank">
                <button>ä¹˜å®¢ç«¯ï¼ˆåˆ›å»ºé¢„çº¦å•ï¼‰</button>
            </a>
            <a href="/driver-app.html?driverId=1" target="_blank">
                <button>å¸æœº1ï¼ˆæ¿€æ´»å‰ä¸Šçº¿ï¼‰</button>
            </a>
            <a href="/driver-app.html?driverId=2" target="_blank">
                <button>å¸æœº2ï¼ˆæ¿€æ´»åä¸Šçº¿ï¼‰</button>
            </a>
        </div>

        <div class="result info">
            <strong>æµ‹è¯•æ­¥éª¤ï¼š</strong><br>
            1. ä¹˜å®¢åˆ›å»ºé¢„çº¦å•ï¼ˆçŠ¶æ€ï¼šSCHEDULEDï¼‰<br>
            2. ç­‰å¾…æ¿€æ´»æ—¶é—´åˆ°è¾¾æˆ–æ‰‹åŠ¨è§¦å‘æ¿€æ´»<br>
            3. æ£€æŸ¥è®¢å•çŠ¶æ€æ˜¯å¦å˜ä¸º PENDING<br>
            4. å¸æœº2ä¸Šçº¿ï¼Œæ£€æŸ¥æ˜¯å¦èƒ½æŸ¥è¯¢åˆ°é¢„çº¦å•<br>
            5. éªŒè¯ä¹˜å®¢ç«¯çŠ¶æ€æ–‡æœ¬æ˜¯å¦æ­£ç¡®æ˜¾ç¤º
        </div>
    </div>

    <div class="test-section">
        <h3>âœ… é¢„æœŸä¿®å¤æ•ˆæœ</h3>
        <div class="result success">
            <strong>ä¿®å¤å®Œæˆååº”è¯¥å®ç°ï¼š</strong><br>
            â€¢ é¢„çº¦å•æ¿€æ´»åçŠ¶æ€æ­£ç¡®å˜ä¸º PENDING âœ…<br>
            â€¢ æ–°ä¸Šçº¿çš„å¸æœºèƒ½æŸ¥è¯¢åˆ°å·²æ¿€æ´»çš„é¢„çº¦å• âœ…<br>
            â€¢ ä¹˜å®¢æ”¶åˆ°é¢„çº¦å•æ¿€æ´»çš„çŠ¶æ€é€šçŸ¥ âœ…<br>
            â€¢ é¢„çº¦å•çš„æ´¾å•æˆåŠŸç‡æé«˜ âœ…<br>
            â€¢ çŠ¶æ€æµè½¬é€»è¾‘ä¸å®æ—¶å•ä¿æŒä¸€è‡´ âœ…
        </div>
    </div>
</body>
</html>