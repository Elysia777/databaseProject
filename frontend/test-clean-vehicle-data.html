<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¸…ç†è½¦è¾†æ•°æ®æµ‹è¯•</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/element-plus@2.4.4/dist/index.full.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/element-plus@2.4.4/dist/index.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
        }
        .section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .code-block {
            background: #f8f8f8;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="container">
            <h1>ğŸ§¹ æ¸…ç†è½¦è¾†æ•°æ®æµ‹è¯•</h1>
            
            <!-- ç™»å½•åŒºåŸŸ -->
            <div class="section">
                <h3>1. ç™»å½•</h3>
                <el-form :model="loginForm" inline>
                    <el-form-item label="ç”¨æˆ·å">
                        <el-input v-model="loginForm.username" placeholder="driver1"></el-input>
                    </el-form-item>
                    <el-form-item label="å¯†ç ">
                        <el-input v-model="loginForm.password" type="password" placeholder="123456"></el-input>
                    </el-form-item>
                    <el-form-item>
                        <el-button type="primary" @click="login" :loading="loginLoading">ç™»å½•</el-button>
                    </el-form-item>
                </el-form>
                
                <div v-if="userInfo">
                    <strong>å½“å‰ç”¨æˆ·:</strong> {{ userInfo.username }} (ID: {{ userInfo.id }}, ç±»å‹: {{ userInfo.userType }})
                </div>
            </div>

            <!-- æ•°æ®æ£€æŸ¥ -->
            <div class="section">
                <h3>2. æ•°æ®æ£€æŸ¥</h3>
                <el-button @click="checkAllData" :loading="checkLoading">æ£€æŸ¥æ‰€æœ‰æ•°æ®</el-button>
                
                <div v-if="allData">
                    <h4>æ‰€æœ‰è½¦è¾†æ•°æ®:</h4>
                    <div class="code-block">{{ JSON.stringify(allData, null, 2) }}</div>
                </div>
            </div>

            <!-- å½“å‰å¸æœºè½¦è¾† -->
            <div class="section">
                <h3>3. å½“å‰å¸æœºè½¦è¾†</h3>
                <el-button @click="loadMyVehicles" :loading="myVehiclesLoading" :disabled="!userInfo">åŠ è½½æˆ‘çš„è½¦è¾†</el-button>
                
                <div v-if="myVehicles">
                    <h4>æˆ‘çš„è½¦è¾† (å¸æœºID: {{ userInfo?.id }}):</h4>
                    <div class="code-block">{{ JSON.stringify(myVehicles, null, 2) }}</div>
                </div>
            </div>

            <!-- æ¸…ç†æ“ä½œ -->
            <div class="section">
                <h3>4. æ¸…ç†æ“ä½œ</h3>
                <el-button @click="deleteAllMyVehicles" type="danger" :loading="deleteLoading" :disabled="!userInfo">
                    åˆ é™¤æˆ‘çš„æ‰€æœ‰è½¦è¾†
                </el-button>
                <el-button @click="addTestVehicle" type="primary" :loading="addLoading" :disabled="!userInfo">
                    æ·»åŠ æµ‹è¯•è½¦è¾†
                </el-button>
            </div>

            <!-- æ“ä½œæ—¥å¿— -->
            <div class="section">
                <h3>5. æ“ä½œæ—¥å¿—</h3>
                <div v-if="logs.length > 0">
                    <div v-for="(log, index) in logs" :key="index" class="code-block">
                        <strong>{{ log.action }}:</strong><br>
                        {{ JSON.stringify(log.result, null, 2) }}
                    </div>
                </div>
                <el-button @click="clearLogs">æ¸…é™¤æ—¥å¿—</el-button>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, reactive, computed } = Vue;
        const { ElMessage, ElMessageBox } = ElementPlus;

        createApp({
            setup() {
                const loginForm = reactive({
                    username: 'driver1',
                    password: '123456'
                });
                const loginLoading = ref(false);
                const userInfo = ref(null);
                const token = ref(localStorage.getItem('token'));
                
                const checkLoading = ref(false);
                const myVehiclesLoading = ref(false);
                const deleteLoading = ref(false);
                const addLoading = ref(false);
                
                const allData = ref(null);
                const myVehicles = ref(null);
                const logs = ref([]);

                // æ£€æŸ¥ç°æœ‰ç”¨æˆ·çŠ¶æ€
                const checkExistingUser = () => {
                    const storedUser = localStorage.getItem('user');
                    if (storedUser && token.value) {
                        try {
                            userInfo.value = JSON.parse(storedUser);
                        } catch (error) {
                            console.error('è§£æç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
                        }
                    }
                };

                // ç™»å½•
                const login = async () => {
                    loginLoading.value = true;
                    try {
                        const response = await fetch('/api/auth/login', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(loginForm)
                        });

                        const result = await response.json();
                        
                        logs.value.push({
                            action: 'ç™»å½•',
                            result: result
                        });

                        if (result.code === 200) {
                            token.value = result.data.token;
                            userInfo.value = result.data;
                            localStorage.setItem('token', token.value);
                            localStorage.setItem('user', JSON.stringify(result.data));
                            ElMessage.success('ç™»å½•æˆåŠŸ');
                        } else {
                            ElMessage.error(result.message || 'ç™»å½•å¤±è´¥');
                        }
                    } catch (error) {
                        ElMessage.error('ç™»å½•å¤±è´¥: ' + error.message);
                        logs.value.push({
                            action: 'ç™»å½•é”™è¯¯',
                            result: { error: error.message }
                        });
                    } finally {
                        loginLoading.value = false;
                    }
                };

                // æ£€æŸ¥æ‰€æœ‰æ•°æ®
                const checkAllData = async () => {
                    checkLoading.value = true;
                    try {
                        // å°è¯•è·å–æ‰€æœ‰è½¦è¾†æ•°æ®
                        const response = await fetch('/api/vehicles/all', {
                            headers: token.value ? {
                                'Authorization': `Bearer ${token.value}`
                            } : {}
                        });

                        let result = null;
                        if (response.ok) {
                            result = await response.json();
                        } else {
                            result = { 
                                error: `HTTP ${response.status}: ${response.statusText}`,
                                message: 'å¯èƒ½æ²¡æœ‰/api/vehicles/allç«¯ç‚¹'
                            };
                        }

                        allData.value = result;
                        logs.value.push({
                            action: 'æ£€æŸ¥æ‰€æœ‰æ•°æ®',
                            result: result
                        });

                    } catch (error) {
                        allData.value = { error: error.message };
                        logs.value.push({
                            action: 'æ£€æŸ¥æ‰€æœ‰æ•°æ®é”™è¯¯',
                            result: { error: error.message }
                        });
                    } finally {
                        checkLoading.value = false;
                    }
                };

                // åŠ è½½æˆ‘çš„è½¦è¾†
                const loadMyVehicles = async () => {
                    if (!userInfo.value || !token.value) {
                        ElMessage.error('è¯·å…ˆç™»å½•');
                        return;
                    }

                    myVehiclesLoading.value = true;
                    try {
                        const response = await fetch(`/api/vehicles/driver/${userInfo.value.id}`, {
                            headers: {
                                'Authorization': `Bearer ${token.value}`,
                                'Content-Type': 'application/json'
                            }
                        });

                        const result = await response.json();
                        myVehicles.value = result;
                        
                        logs.value.push({
                            action: `åŠ è½½å¸æœº${userInfo.value.id}çš„è½¦è¾†`,
                            result: result
                        });

                        if (result.code === 200) {
                            ElMessage.success(`åŠ è½½æˆåŠŸï¼Œå…±${result.data?.length || 0}è¾†è½¦`);
                        } else {
                            ElMessage.error(result.message || 'åŠ è½½å¤±è´¥');
                        }
                    } catch (error) {
                        ElMessage.error('åŠ è½½å¤±è´¥: ' + error.message);
                        logs.value.push({
                            action: 'åŠ è½½æˆ‘çš„è½¦è¾†é”™è¯¯',
                            result: { error: error.message }
                        });
                    } finally {
                        myVehiclesLoading.value = false;
                    }
                };

                // åˆ é™¤æˆ‘çš„æ‰€æœ‰è½¦è¾†
                const deleteAllMyVehicles = async () => {
                    if (!userInfo.value || !token.value) {
                        ElMessage.error('è¯·å…ˆç™»å½•');
                        return;
                    }

                    try {
                        await ElMessageBox.confirm('ç¡®å®šè¦åˆ é™¤æ‰€æœ‰è½¦è¾†å—ï¼Ÿ', 'è­¦å‘Š', {
                            confirmButtonText: 'ç¡®å®š',
                            cancelButtonText: 'å–æ¶ˆ',
                            type: 'warning'
                        });

                        // å…ˆè·å–æ‰€æœ‰è½¦è¾†
                        await loadMyVehicles();
                        
                        if (myVehicles.value?.data?.length > 0) {
                            deleteLoading.value = true;
                            
                            for (const vehicle of myVehicles.value.data) {
                                try {
                                    const response = await fetch(`/api/vehicles/${vehicle.id}`, {
                                        method: 'DELETE',
                                        headers: {
                                            'Authorization': `Bearer ${token.value}`,
                                            'Content-Type': 'application/json'
                                        }
                                    });

                                    const result = await response.json();
                                    logs.value.push({
                                        action: `åˆ é™¤è½¦è¾†${vehicle.id}`,
                                        result: result
                                    });
                                } catch (error) {
                                    logs.value.push({
                                        action: `åˆ é™¤è½¦è¾†${vehicle.id}é”™è¯¯`,
                                        result: { error: error.message }
                                    });
                                }
                            }
                            
                            ElMessage.success('åˆ é™¤æ“ä½œå®Œæˆ');
                            await loadMyVehicles(); // é‡æ–°åŠ è½½
                        } else {
                            ElMessage.info('æ²¡æœ‰è½¦è¾†éœ€è¦åˆ é™¤');
                        }
                    } catch (error) {
                        if (error !== 'cancel') {
                            ElMessage.error('åˆ é™¤å¤±è´¥: ' + error.message);
                        }
                    } finally {
                        deleteLoading.value = false;
                    }
                };

                // æ·»åŠ æµ‹è¯•è½¦è¾†
                const addTestVehicle = async () => {
                    if (!userInfo.value || !token.value) {
                        ElMessage.error('è¯·å…ˆç™»å½•');
                        return;
                    }

                    addLoading.value = true;
                    try {
                        const testVehicle = {
                            driverId: userInfo.value.id,
                            plateNumber: 'äº¬A' + Math.random().toString().substr(2, 5),
                            brand: 'ä¸°ç”°',
                            model: 'å‡¯ç¾ç‘',
                            color: 'ç™½è‰²',
                            year: 2023,
                            seats: 5,
                            vehicleType: 'COMFORT',
                            fuelType: 'GASOLINE'
                        };

                        const response = await fetch('/api/vehicles', {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${token.value}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(testVehicle)
                        });

                        const result = await response.json();
                        
                        logs.value.push({
                            action: 'æ·»åŠ æµ‹è¯•è½¦è¾†',
                            result: result
                        });

                        if (result.code === 200) {
                            ElMessage.success('æ·»åŠ æˆåŠŸ');
                            await loadMyVehicles(); // é‡æ–°åŠ è½½
                        } else {
                            ElMessage.error(result.message || 'æ·»åŠ å¤±è´¥');
                        }
                    } catch (error) {
                        ElMessage.error('æ·»åŠ å¤±è´¥: ' + error.message);
                        logs.value.push({
                            action: 'æ·»åŠ æµ‹è¯•è½¦è¾†é”™è¯¯',
                            result: { error: error.message }
                        });
                    } finally {
                        addLoading.value = false;
                    }
                };

                // æ¸…é™¤æ—¥å¿—
                const clearLogs = () => {
                    logs.value = [];
                };

                // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç°æœ‰ç”¨æˆ·
                checkExistingUser();

                return {
                    loginForm,
                    loginLoading,
                    userInfo,
                    checkLoading,
                    myVehiclesLoading,
                    deleteLoading,
                    addLoading,
                    allData,
                    myVehicles,
                    logs,
                    login,
                    checkAllData,
                    loadMyVehicles,
                    deleteAllMyVehicles,
                    addTestVehicle,
                    clearLogs
                };
            }
        }).use(ElementPlus).mount('#app');
    </script>
</body>
</html>