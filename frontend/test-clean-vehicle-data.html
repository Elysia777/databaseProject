<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>清理车辆数据测试</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/element-plus@2.4.4/dist/index.full.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/element-plus@2.4.4/dist/index.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
        }
        .section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .code-block {
            background: #f8f8f8;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="container">
            <h1>🧹 清理车辆数据测试</h1>
            
            <!-- 登录区域 -->
            <div class="section">
                <h3>1. 登录</h3>
                <el-form :model="loginForm" inline>
                    <el-form-item label="用户名">
                        <el-input v-model="loginForm.username" placeholder="driver1"></el-input>
                    </el-form-item>
                    <el-form-item label="密码">
                        <el-input v-model="loginForm.password" type="password" placeholder="123456"></el-input>
                    </el-form-item>
                    <el-form-item>
                        <el-button type="primary" @click="login" :loading="loginLoading">登录</el-button>
                    </el-form-item>
                </el-form>
                
                <div v-if="userInfo">
                    <strong>当前用户:</strong> {{ userInfo.username }} (ID: {{ userInfo.id }}, 类型: {{ userInfo.userType }})
                </div>
            </div>

            <!-- 数据检查 -->
            <div class="section">
                <h3>2. 数据检查</h3>
                <el-button @click="checkAllData" :loading="checkLoading">检查所有数据</el-button>
                
                <div v-if="allData">
                    <h4>所有车辆数据:</h4>
                    <div class="code-block">{{ JSON.stringify(allData, null, 2) }}</div>
                </div>
            </div>

            <!-- 当前司机车辆 -->
            <div class="section">
                <h3>3. 当前司机车辆</h3>
                <el-button @click="loadMyVehicles" :loading="myVehiclesLoading" :disabled="!userInfo">加载我的车辆</el-button>
                
                <div v-if="myVehicles">
                    <h4>我的车辆 (司机ID: {{ userInfo?.id }}):</h4>
                    <div class="code-block">{{ JSON.stringify(myVehicles, null, 2) }}</div>
                </div>
            </div>

            <!-- 清理操作 -->
            <div class="section">
                <h3>4. 清理操作</h3>
                <el-button @click="deleteAllMyVehicles" type="danger" :loading="deleteLoading" :disabled="!userInfo">
                    删除我的所有车辆
                </el-button>
                <el-button @click="addTestVehicle" type="primary" :loading="addLoading" :disabled="!userInfo">
                    添加测试车辆
                </el-button>
            </div>

            <!-- 操作日志 -->
            <div class="section">
                <h3>5. 操作日志</h3>
                <div v-if="logs.length > 0">
                    <div v-for="(log, index) in logs" :key="index" class="code-block">
                        <strong>{{ log.action }}:</strong><br>
                        {{ JSON.stringify(log.result, null, 2) }}
                    </div>
                </div>
                <el-button @click="clearLogs">清除日志</el-button>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, reactive, computed } = Vue;
        const { ElMessage, ElMessageBox } = ElementPlus;

        createApp({
            setup() {
                const loginForm = reactive({
                    username: 'driver1',
                    password: '123456'
                });
                const loginLoading = ref(false);
                const userInfo = ref(null);
                const token = ref(localStorage.getItem('token'));
                
                const checkLoading = ref(false);
                const myVehiclesLoading = ref(false);
                const deleteLoading = ref(false);
                const addLoading = ref(false);
                
                const allData = ref(null);
                const myVehicles = ref(null);
                const logs = ref([]);

                // 检查现有用户状态
                const checkExistingUser = () => {
                    const storedUser = localStorage.getItem('user');
                    if (storedUser && token.value) {
                        try {
                            userInfo.value = JSON.parse(storedUser);
                        } catch (error) {
                            console.error('解析用户信息失败:', error);
                        }
                    }
                };

                // 登录
                const login = async () => {
                    loginLoading.value = true;
                    try {
                        const response = await fetch('/api/auth/login', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(loginForm)
                        });

                        const result = await response.json();
                        
                        logs.value.push({
                            action: '登录',
                            result: result
                        });

                        if (result.code === 200) {
                            token.value = result.data.token;
                            userInfo.value = result.data;
                            localStorage.setItem('token', token.value);
                            localStorage.setItem('user', JSON.stringify(result.data));
                            ElMessage.success('登录成功');
                        } else {
                            ElMessage.error(result.message || '登录失败');
                        }
                    } catch (error) {
                        ElMessage.error('登录失败: ' + error.message);
                        logs.value.push({
                            action: '登录错误',
                            result: { error: error.message }
                        });
                    } finally {
                        loginLoading.value = false;
                    }
                };

                // 检查所有数据
                const checkAllData = async () => {
                    checkLoading.value = true;
                    try {
                        // 尝试获取所有车辆数据
                        const response = await fetch('/api/vehicles/all', {
                            headers: token.value ? {
                                'Authorization': `Bearer ${token.value}`
                            } : {}
                        });

                        let result = null;
                        if (response.ok) {
                            result = await response.json();
                        } else {
                            result = { 
                                error: `HTTP ${response.status}: ${response.statusText}`,
                                message: '可能没有/api/vehicles/all端点'
                            };
                        }

                        allData.value = result;
                        logs.value.push({
                            action: '检查所有数据',
                            result: result
                        });

                    } catch (error) {
                        allData.value = { error: error.message };
                        logs.value.push({
                            action: '检查所有数据错误',
                            result: { error: error.message }
                        });
                    } finally {
                        checkLoading.value = false;
                    }
                };

                // 加载我的车辆
                const loadMyVehicles = async () => {
                    if (!userInfo.value || !token.value) {
                        ElMessage.error('请先登录');
                        return;
                    }

                    myVehiclesLoading.value = true;
                    try {
                        const response = await fetch(`/api/vehicles/driver/${userInfo.value.id}`, {
                            headers: {
                                'Authorization': `Bearer ${token.value}`,
                                'Content-Type': 'application/json'
                            }
                        });

                        const result = await response.json();
                        myVehicles.value = result;
                        
                        logs.value.push({
                            action: `加载司机${userInfo.value.id}的车辆`,
                            result: result
                        });

                        if (result.code === 200) {
                            ElMessage.success(`加载成功，共${result.data?.length || 0}辆车`);
                        } else {
                            ElMessage.error(result.message || '加载失败');
                        }
                    } catch (error) {
                        ElMessage.error('加载失败: ' + error.message);
                        logs.value.push({
                            action: '加载我的车辆错误',
                            result: { error: error.message }
                        });
                    } finally {
                        myVehiclesLoading.value = false;
                    }
                };

                // 删除我的所有车辆
                const deleteAllMyVehicles = async () => {
                    if (!userInfo.value || !token.value) {
                        ElMessage.error('请先登录');
                        return;
                    }

                    try {
                        await ElMessageBox.confirm('确定要删除所有车辆吗？', '警告', {
                            confirmButtonText: '确定',
                            cancelButtonText: '取消',
                            type: 'warning'
                        });

                        // 先获取所有车辆
                        await loadMyVehicles();
                        
                        if (myVehicles.value?.data?.length > 0) {
                            deleteLoading.value = true;
                            
                            for (const vehicle of myVehicles.value.data) {
                                try {
                                    const response = await fetch(`/api/vehicles/${vehicle.id}`, {
                                        method: 'DELETE',
                                        headers: {
                                            'Authorization': `Bearer ${token.value}`,
                                            'Content-Type': 'application/json'
                                        }
                                    });

                                    const result = await response.json();
                                    logs.value.push({
                                        action: `删除车辆${vehicle.id}`,
                                        result: result
                                    });
                                } catch (error) {
                                    logs.value.push({
                                        action: `删除车辆${vehicle.id}错误`,
                                        result: { error: error.message }
                                    });
                                }
                            }
                            
                            ElMessage.success('删除操作完成');
                            await loadMyVehicles(); // 重新加载
                        } else {
                            ElMessage.info('没有车辆需要删除');
                        }
                    } catch (error) {
                        if (error !== 'cancel') {
                            ElMessage.error('删除失败: ' + error.message);
                        }
                    } finally {
                        deleteLoading.value = false;
                    }
                };

                // 添加测试车辆
                const addTestVehicle = async () => {
                    if (!userInfo.value || !token.value) {
                        ElMessage.error('请先登录');
                        return;
                    }

                    addLoading.value = true;
                    try {
                        const testVehicle = {
                            driverId: userInfo.value.id,
                            plateNumber: '京A' + Math.random().toString().substr(2, 5),
                            brand: '丰田',
                            model: '凯美瑞',
                            color: '白色',
                            year: 2023,
                            seats: 5,
                            vehicleType: 'COMFORT',
                            fuelType: 'GASOLINE'
                        };

                        const response = await fetch('/api/vehicles', {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${token.value}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(testVehicle)
                        });

                        const result = await response.json();
                        
                        logs.value.push({
                            action: '添加测试车辆',
                            result: result
                        });

                        if (result.code === 200) {
                            ElMessage.success('添加成功');
                            await loadMyVehicles(); // 重新加载
                        } else {
                            ElMessage.error(result.message || '添加失败');
                        }
                    } catch (error) {
                        ElMessage.error('添加失败: ' + error.message);
                        logs.value.push({
                            action: '添加测试车辆错误',
                            result: { error: error.message }
                        });
                    } finally {
                        addLoading.value = false;
                    }
                };

                // 清除日志
                const clearLogs = () => {
                    logs.value = [];
                };

                // 页面加载时检查现有用户
                checkExistingUser();

                return {
                    loginForm,
                    loginLoading,
                    userInfo,
                    checkLoading,
                    myVehiclesLoading,
                    deleteLoading,
                    addLoading,
                    allData,
                    myVehicles,
                    logs,
                    login,
                    checkAllData,
                    loadMyVehicles,
                    deleteAllMyVehicles,
                    addTestVehicle,
                    clearLogs
                };
            }
        }).use(ElementPlus).mount('#app');
    </script>
</body>
</html>