<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½èµ·ç‚¹å¸é™„åŠŸèƒ½æµ‹è¯•</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/element-plus/dist/index.full.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .location-display {
            display: flex;
            align-items: center;
            gap: 15px;
            margin: 15px 0;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 8px;
        }
        .location-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: white;
            background: linear-gradient(135deg, #67C23A, #85CE61);
        }
        .location-info {
            flex: 1;
        }
        .location-label {
            font-size: 12px;
            color: #999;
            margin-bottom: 4px;
        }
        .location-text {
            font-size: 16px;
            color: #333;
            font-weight: 500;
        }
        .coordinates {
            font-size: 12px;
            color: #666;
            font-family: monospace;
            margin-top: 4px;
        }
        .test-controls {
            margin: 10px 0;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        .api-result {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 10px;
        }
        .success { color: #67C23A; }
        .error { color: #F56C6C; }
        .warning { color: #E6A23C; }
        .poi-list {
            margin: 15px 0;
        }
        .poi-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .poi-item:hover {
            background-color: #f0f9ff;
            border-color: #409EFF;
        }
        .poi-item.snapped {
            background-color: #f0f9ff;
            border-color: #67C23A;
            border-width: 2px;
        }
        .poi-info {
            flex: 1;
        }
        .poi-name {
            font-weight: 500;
            color: #333;
        }
        .poi-type {
            font-size: 12px;
            color: #666;
            margin-top: 2px;
        }
        .poi-distance {
            font-size: 12px;
            color: #999;
            text-align: right;
        }
        #mapContainer {
            width: 100%;
            height: 400px;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin: 15px 0;
        }
        .snap-demo {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        .demo-item {
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .demo-item h4 {
            margin: 0 0 10px 0;
            color: #333;
        }
        .demo-before {
            border-color: #E6A23C;
            background: #FDF6EC;
        }
        .demo-after {
            border-color: #67C23A;
            background: #F0F9FF;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="container">
            <div class="header">
                <h1>æ™ºèƒ½èµ·ç‚¹å¸é™„åŠŸèƒ½æµ‹è¯•</h1>
                <div>
                    <el-button type="primary" @click="getCurrentLocation">è·å–å½“å‰ä½ç½®</el-button>
                </div>
            </div>

            <!-- åŠŸèƒ½è¯´æ˜ -->
            <div class="test-section">
                <h3>åŠŸèƒ½è¯´æ˜</h3>
                <p>å½“ç”¨æˆ·æ‹–åŠ¨èµ·ç‚¹å›¾æ ‡åˆ°æŸä¸ªåœ°ç‚¹é™„è¿‘æ—¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å¸é™„åˆ°æœ€è¿‘çš„POIï¼ˆå¦‚å±±ä¸œå¤§å­¦ï¼‰ï¼Œå¹¶ä¸”åæ ‡å’Œåœ°å€éƒ½æ›´æ–°ä¸ºè¯¥POIçš„å‡†ç¡®ä¿¡æ¯ã€‚</p>
                <ul>
                    <li>ğŸ§² <strong>æ™ºèƒ½å¸é™„</strong>ï¼šè‡ªåŠ¨åŒ¹é…100ç±³å†…æœ€è¿‘çš„POI</li>
                    <li>ğŸ“ <strong>ç²¾ç¡®å®šä½</strong>ï¼šä½¿ç”¨POIçš„å‡†ç¡®åæ ‡</li>
                    <li>ğŸ·ï¸ <strong>åœ°å€æ›´æ–°</strong>ï¼šæ˜¾ç¤ºPOIçš„å‡†ç¡®åç§°</li>
                    <li>ğŸ¯ <strong>æ ‡è®°ç§»åŠ¨</strong>ï¼šå›¾æ ‡è‡ªåŠ¨ç§»åŠ¨åˆ°POIä½ç½®</li>
                </ul>
            </div>

            <!-- å½“å‰ä½ç½®æ˜¾ç¤º -->
            <div class="test-section">
                <h3>1. å½“å‰èµ·ç‚¹ä½ç½®</h3>
                <div class="location-display">
                    <div class="location-icon">ğŸ“</div>
                    <div class="location-info">
                        <div class="location-label">ä¸Šè½¦åœ°ç‚¹</div>
                        <div class="location-text">{{ pickupAddress || "æ­£åœ¨å®šä½..." }}</div>
                        <div class="coordinates" v-if="currentPosition.lng">
                            åæ ‡: {{ currentPosition.lng.toFixed(6) }}, {{ currentPosition.lat.toFixed(6) }}
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ™ºèƒ½å¸é™„æµ‹è¯• -->
            <div class="test-section">
                <h3>2. æ™ºèƒ½å¸é™„æµ‹è¯•</h3>
                <div class="test-controls">
                    <el-input 
                        v-model="testLng" 
                        placeholder="ç»åº¦" 
                        style="width: 120px;"
                        type="number"
                        step="0.000001"
                    ></el-input>
                    <el-input 
                        v-model="testLat" 
                        placeholder="çº¬åº¦" 
                        style="width: 120px;"
                        type="number"
                        step="0.000001"
                    ></el-input>
                    <el-button type="primary" @click="testSmartSnap" :loading="snapping">
                        æµ‹è¯•æ™ºèƒ½å¸é™„
                    </el-button>
                    <el-button @click="usePresetLocation">ä½¿ç”¨é¢„è®¾ä½ç½®</el-button>
                </div>
                
                <div class="snap-demo" v-if="snapResult.before || snapResult.after">
                    <div class="demo-item demo-before">
                        <h4>å¸é™„å‰</h4>
                        <p><strong>ä½ç½®:</strong> {{ snapResult.before?.address || 'æœªçŸ¥' }}</p>
                        <p><strong>åæ ‡:</strong> {{ snapResult.before?.coordinates || 'æœªçŸ¥' }}</p>
                    </div>
                    <div class="demo-item demo-after">
                        <h4>å¸é™„å</h4>
                        <p><strong>ä½ç½®:</strong> {{ snapResult.after?.address || 'æœªçŸ¥' }}</p>
                        <p><strong>åæ ‡:</strong> {{ snapResult.after?.coordinates || 'æœªçŸ¥' }}</p>
                        <p v-if="snapResult.after?.distance"><strong>å¸é™„è·ç¦»:</strong> {{ snapResult.after.distance }}ç±³</p>
                    </div>
                </div>
                
                <div class="api-result" v-if="snapApiResult">{{ snapApiResult }}</div>
            </div>

            <!-- POIåˆ—è¡¨æ˜¾ç¤º -->
            <div class="test-section" v-if="nearbyPOIs.length > 0">
                <h3>3. é™„è¿‘POIåˆ—è¡¨</h3>
                <div class="poi-list">
                    <div 
                        v-for="(poi, index) in nearbyPOIs" 
                        :key="index"
                        class="poi-item"
                        :class="{ snapped: poi.isSnapped }"
                        @click="snapToPOI(poi)"
                    >
                        <div class="poi-info">
                            <div class="poi-name">{{ poi.name }}</div>
                            <div class="poi-type">{{ poi.type || 'æœªçŸ¥ç±»å‹' }}</div>
                        </div>
                        <div class="poi-distance">{{ poi.distance }}ç±³</div>
                    </div>
                </div>
            </div>

            <!-- é¢„è®¾æµ‹è¯•ä½ç½® -->
            <div class="test-section">
                <h3>4. é¢„è®¾æµ‹è¯•ä½ç½®</h3>
                <div class="test-controls">
                    <el-button 
                        v-for="preset in presetLocations" 
                        :key="preset.name"
                        @click="testPresetLocation(preset)"
                        size="small"
                    >
                        {{ preset.name }}
                    </el-button>
                </div>
                <div class="api-result" v-if="presetResult">{{ presetResult }}</div>
            </div>

            <!-- åœ°å›¾æ˜¾ç¤º -->
            <div class="test-section">
                <h3>5. åœ°å›¾æ˜¾ç¤º</h3>
                <div id="mapContainer"></div>
                <div class="test-controls">
                    <el-button @click="initMap" :loading="mapLoading">åˆå§‹åŒ–åœ°å›¾</el-button>
                    <el-button @click="addMarkersToMap" :disabled="!map">æ·»åŠ æ ‡è®°</el-button>
                    <el-button @click="simulateDrag" :disabled="!map">æ¨¡æ‹Ÿæ‹–æ‹½</el-button>
                </div>
            </div>

            <!-- åŠŸèƒ½éªŒè¯ -->
            <div class="test-section">
                <h3>6. åŠŸèƒ½éªŒè¯æ€»ç»“</h3>
                <div class="test-controls">
                    <el-button type="success" @click="runAllTests">è¿è¡Œæ‰€æœ‰æµ‹è¯•</el-button>
                </div>
                <div class="api-result" v-if="testSummary">{{ testSummary }}</div>
            </div>
        </div>
    </div>

    <script>
        // é«˜å¾·åœ°å›¾é…ç½®
        window._AMapSecurityConfig = {
            securityJsCode: "415e917da833efcf2d5b69f4d821784b",
        };

        const { createApp, ref, reactive, onMounted } = Vue;
        
        createApp({
            setup() {
                const pickupAddress = ref('');
                const currentPosition = reactive({ lng: 0, lat: 0 });
                const testLng = ref('');
                const testLat = ref('');
                const snapping = ref(false);
                const mapLoading = ref(false);
                const snapApiResult = ref('');
                const presetResult = ref('');
                const testSummary = ref('');
                
                const snapResult = reactive({
                    before: null,
                    after: null
                });
                
                const nearbyPOIs = ref([]);
                
                let map = null;
                let pickupMarker = null;
                let poiMarkers = [];
                
                // é¢„è®¾æµ‹è¯•ä½ç½®ï¼ˆçŸ¥åPOIé™„è¿‘ï¼‰
                const presetLocations = ref([
                    { name: 'å±±ä¸œå¤§å­¦é™„è¿‘', lng: 117.120983, lat: 36.682314, description: 'æµ‹è¯•å¤§å­¦POIå¸é™„' },
                    { name: 'å¤©å®‰é—¨é™„è¿‘', lng: 116.397428, lat: 39.90923, description: 'æµ‹è¯•è‘—åæ™¯ç‚¹å¸é™„' },
                    { name: 'ä¸Šæµ·å¤–æ»©é™„è¿‘', lng: 121.499763, lat: 31.245944, description: 'æµ‹è¯•å•†ä¸šåŒºå¸é™„' },
                    { name: 'æ·±åœ³å¸‚æ°‘ä¸­å¿ƒé™„è¿‘', lng: 114.056244, lat: 22.559539, description: 'æµ‹è¯•æ”¿åºœå»ºç­‘å¸é™„' },
                    { name: 'æ­å·è¥¿æ¹–é™„è¿‘', lng: 120.148872, lat: 30.259244, description: 'æµ‹è¯•æ™¯åŒºå¸é™„' }
                ]);
                
                // è·å–å½“å‰ä½ç½®
                const getCurrentLocation = () => {
                    if (!navigator.geolocation) {
                        ElementPlus.ElMessage.error('æµè§ˆå™¨ä¸æ”¯æŒå®šä½åŠŸèƒ½');
                        return;
                    }
                    
                    ElementPlus.ElMessage.info('æ­£åœ¨å®šä½...');
                    
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            const { longitude, latitude } = position.coords;
                            currentPosition.lng = longitude;
                            currentPosition.lat = latitude;
                            
                            testLng.value = longitude.toString();
                            testLat.value = latitude.toString();
                            
                            ElementPlus.ElMessage.success('å®šä½æˆåŠŸ');
                            testSmartSnap();
                        },
                        (error) => {
                            console.error('å®šä½å¤±è´¥:', error);
                            ElementPlus.ElMessage.error('å®šä½å¤±è´¥: ' + error.message);
                        }
                    );
                };
                
                // æ¨¡æ‹Ÿé«˜å¾·åœ°å›¾APIå“åº”
                const mockGeoAPI = (lng, lat) => {
                    // æ ¹æ®åæ ‡åˆ¤æ–­æ˜¯å¦åœ¨çŸ¥åPOIé™„è¿‘
                    const pois = [];
                    
                    // å±±ä¸œå¤§å­¦
                    if (Math.abs(lng - 117.120983) < 0.001 && Math.abs(lat - 36.682314) < 0.001) {
                        pois.push({
                            name: "å±±ä¸œå¤§å­¦",
                            location: "117.120983,36.682314",
                            distance: Math.floor(Math.random() * 80 + 10).toString(), // 10-90ç±³
                            type: "ç§‘æ•™æ–‡åŒ–æœåŠ¡;å­¦æ ¡;é«˜ç­‰é™¢æ ¡"
                        });
                    }
                    
                    // å¤©å®‰é—¨
                    if (Math.abs(lng - 116.397428) < 0.001 && Math.abs(lat - 39.90923) < 0.001) {
                        pois.push({
                            name: "å¤©å®‰é—¨",
                            location: "116.397428,39.90923",
                            distance: Math.floor(Math.random() * 80 + 10).toString(),
                            type: "é£æ™¯åèƒœ;é£æ™¯åèƒœ;é£æ™¯åèƒœç›¸å…³"
                        });
                    }
                    
                    // ä¸Šæµ·å¤–æ»©
                    if (Math.abs(lng - 121.499763) < 0.001 && Math.abs(lat - 31.245944) < 0.001) {
                        pois.push({
                            name: "å¤–æ»©",
                            location: "121.499763,31.245944",
                            distance: Math.floor(Math.random() * 80 + 10).toString(),
                            type: "é£æ™¯åèƒœ;é£æ™¯åèƒœ;é£æ™¯åèƒœç›¸å…³"
                        });
                    }
                    
                    // æ·»åŠ ä¸€äº›é€šç”¨POI
                    const genericPOIs = [
                        { name: "è´­ç‰©ä¸­å¿ƒ", type: "è´­ç‰©æœåŠ¡;è´­ç‰©ç›¸å…³åœºæ‰€;è´­ç‰©ä¸­å¿ƒ" },
                        { name: "åœ°é“ç«™", type: "äº¤é€šè®¾æ–½æœåŠ¡;å…¬å…±äº¤é€šè®¾æ–½;åœ°é“ç«™" },
                        { name: "åŒ»é™¢", type: "åŒ»ç–—ä¿å¥æœåŠ¡;ç»¼åˆåŒ»é™¢;ç»¼åˆåŒ»é™¢" },
                        { name: "é“¶è¡Œ", type: "é‡‘èä¿é™©æœåŠ¡;é“¶è¡Œ;é“¶è¡Œç›¸å…³" }
                    ];
                    
                    // éšæœºæ·»åŠ 1-2ä¸ªé€šç”¨POI
                    const randomPOIs = genericPOIs.sort(() => 0.5 - Math.random()).slice(0, 2);
                    randomPOIs.forEach((poi, index) => {
                        pois.push({
                            name: poi.name,
                            location: `${lng + (Math.random() - 0.5) * 0.001},${lat + (Math.random() - 0.5) * 0.001}`,
                            distance: Math.floor(Math.random() * 150 + 50).toString(), // 50-200ç±³
                            type: poi.type
                        });
                    });
                    
                    return {
                        status: "1",
                        regeocode: {
                            formatted_address: `æµ‹è¯•åœ°å€ (${lat.toFixed(6)}, ${lng.toFixed(6)})`,
                            pois: pois
                        }
                    };
                };
                
                // æµ‹è¯•æ™ºèƒ½å¸é™„
                const testSmartSnap = async () => {
                    if (!testLng.value || !testLat.value) {
                        ElementPlus.ElMessage.warning('è¯·è¾“å…¥ç»çº¬åº¦');
                        return;
                    }
                    
                    snapping.value = true;
                    nearbyPOIs.value = [];
                    
                    try {
                        const lng = parseFloat(testLng.value);
                        const lat = parseFloat(testLat.value);
                        
                        console.log('ğŸ§² å¼€å§‹æ™ºèƒ½å¸é™„æµ‹è¯•:', lng, lat);
                        
                        // è®°å½•å¸é™„å‰çŠ¶æ€
                        snapResult.before = {
                            address: `ä½ç½® (${lat.toFixed(6)}, ${lng.toFixed(6)})`,
                            coordinates: `${lng.toFixed(6)}, ${lat.toFixed(6)}`
                        };
                        
                        // æ¨¡æ‹ŸAPIè°ƒç”¨
                        const data = mockGeoAPI(lng, lat);
                        
                        snapApiResult.value = `æ™ºèƒ½å¸é™„APIå“åº”:\nåæ ‡: ${lng}, ${lat}\n${JSON.stringify(data, null, 2)}`;
                        
                        if (data.status === "1" && data.regeocode && data.regeocode.pois && data.regeocode.pois.length > 0) {
                            // æ›´æ–°POIåˆ—è¡¨
                            nearbyPOIs.value = data.regeocode.pois.map(poi => ({
                                ...poi,
                                isSnapped: false
                            }));
                            
                            // æ‰¾åˆ°æœ€è¿‘çš„POI
                            const nearestPoi = data.regeocode.pois[0];
                            const poiDistance = parseFloat(nearestPoi.distance);
                            
                            console.log('ğŸ“ æ‰¾åˆ°æœ€è¿‘POI:', nearestPoi.name, 'è·ç¦»:', poiDistance + 'ç±³');
                            
                            // å¦‚æœPOIè·ç¦»å°äº100ç±³ï¼Œåˆ™å¸é™„
                            if (poiDistance < 100) {
                                const [poiLng, poiLat] = nearestPoi.location.split(",").map(Number);
                                
                                console.log('ğŸ¯ å¸é™„åˆ°POI:', nearestPoi.name, 'åæ ‡:', poiLng, poiLat);
                                
                                // æ›´æ–°ä½ç½®
                                currentPosition.lng = poiLng;
                                currentPosition.lat = poiLat;
                                pickupAddress.value = nearestPoi.name;
                                
                                // æ ‡è®°è¢«å¸é™„çš„POI
                                nearbyPOIs.value[0].isSnapped = true;
                                
                                // è®°å½•å¸é™„åçŠ¶æ€
                                snapResult.after = {
                                    address: nearestPoi.name,
                                    coordinates: `${poiLng.toFixed(6)}, ${poiLat.toFixed(6)}`,
                                    distance: poiDistance
                                };
                                
                                ElementPlus.ElMessage.success(`å·²è‡ªåŠ¨åŒ¹é…åˆ°: ${nearestPoi.name}`);
                            } else {
                                // è·ç¦»å¤ªè¿œï¼Œä¸å¸é™„
                                currentPosition.lng = lng;
                                currentPosition.lat = lat;
                                pickupAddress.value = data.regeocode.formatted_address;
                                
                                snapResult.after = {
                                    address: data.regeocode.formatted_address,
                                    coordinates: `${lng.toFixed(6)}, ${lat.toFixed(6)}`,
                                    distance: null
                                };
                                
                                ElementPlus.ElMessage.info('æœªæ‰¾åˆ°åˆé€‚çš„POIï¼Œä½¿ç”¨åŸå§‹ä½ç½®');
                            }
                        } else {
                            // æ²¡æœ‰æ‰¾åˆ°POI
                            currentPosition.lng = lng;
                            currentPosition.lat = lat;
                            pickupAddress.value = `ä½ç½® (${lat.toFixed(6)}, ${lng.toFixed(6)})`;
                            
                            snapResult.after = {
                                address: `ä½ç½® (${lat.toFixed(6)}, ${lng.toFixed(6)})`,
                                coordinates: `${lng.toFixed(6)}, ${lat.toFixed(6)}`,
                                distance: null
                            };
                            
                            ElementPlus.ElMessage.info('æœªæ‰¾åˆ°é™„è¿‘POI');
                        }
                        
                    } catch (error) {
                        console.error('æ™ºèƒ½å¸é™„æµ‹è¯•å¤±è´¥:', error);
                        snapApiResult.value = `æµ‹è¯•å¤±è´¥: ${error.message}`;
                        ElementPlus.ElMessage.error('æµ‹è¯•å¤±è´¥');
                    } finally {
                        snapping.value = false;
                    }
                };
                
                // ä½¿ç”¨é¢„è®¾ä½ç½®
                const usePresetLocation = () => {
                    const preset = presetLocations.value[0]; // ä½¿ç”¨å±±ä¸œå¤§å­¦
                    testLng.value = preset.lng.toString();
                    testLat.value = preset.lat.toString();
                    testSmartSnap();
                };
                
                // æµ‹è¯•é¢„è®¾ä½ç½®
                const testPresetLocation = (preset) => {
                    testLng.value = preset.lng.toString();
                    testLat.value = preset.lat.toString();
                    
                    presetResult.value = `æµ‹è¯•ä½ç½®: ${preset.name}\næè¿°: ${preset.description}\nåæ ‡: ${preset.lng}, ${preset.lat}\næ­£åœ¨æµ‹è¯•æ™ºèƒ½å¸é™„...`;
                    
                    testSmartSnap();
                };
                
                // å¸é™„åˆ°æŒ‡å®šPOI
                const snapToPOI = (poi) => {
                    const [poiLng, poiLat] = poi.location.split(",").map(Number);
                    
                    // é‡ç½®æ‰€æœ‰POIçš„å¸é™„çŠ¶æ€
                    nearbyPOIs.value.forEach(p => p.isSnapped = false);
                    
                    // æ ‡è®°å½“å‰POIä¸ºå¸é™„çŠ¶æ€
                    poi.isSnapped = true;
                    
                    // æ›´æ–°ä½ç½®
                    currentPosition.lng = poiLng;
                    currentPosition.lat = poiLat;
                    pickupAddress.value = poi.name;
                    
                    // æ›´æ–°å¸é™„ç»“æœ
                    snapResult.after = {
                        address: poi.name,
                        coordinates: `${poiLng.toFixed(6)}, ${poiLat.toFixed(6)}`,
                        distance: parseFloat(poi.distance)
                    };
                    
                    ElementPlus.ElMessage.success(`å·²å¸é™„åˆ°: ${poi.name}`);
                };
                
                // åˆå§‹åŒ–åœ°å›¾
                const initMap = () => {
                    mapLoading.value = true;
                    
                    if (window.AMap) {
                        createMap();
                    } else {
                        const script = document.createElement('script');
                        script.src = 'https://webapi.amap.com/maps?v=2.0&key=4d0b4b5c4e9a5b8f8c7e2d1a3b4c5d6e';
                        script.onload = createMap;
                        script.onerror = () => {
                            ElementPlus.ElMessage.error('åœ°å›¾åŠ è½½å¤±è´¥');
                            mapLoading.value = false;
                        };
                        document.head.appendChild(script);
                    }
                };
                
                // åˆ›å»ºåœ°å›¾
                const createMap = () => {
                    try {
                        map = new window.AMap.Map('mapContainer', {
                            resizeEnable: true,
                            zoom: 16,
                            center: [currentPosition.lng || 116.397428, currentPosition.lat || 39.90923],
                            mapStyle: 'amap://styles/normal'
                        });
                        
                        map.on('complete', () => {
                            console.log('åœ°å›¾åŠ è½½å®Œæˆ');
                            ElementPlus.ElMessage.success('åœ°å›¾åˆå§‹åŒ–æˆåŠŸ');
                            mapLoading.value = false;
                        });
                        
                    } catch (error) {
                        console.error('åœ°å›¾åˆ›å»ºå¤±è´¥:', error);
                        ElementPlus.ElMessage.error('åœ°å›¾åˆ›å»ºå¤±è´¥');
                        mapLoading.value = false;
                    }
                };
                
                // æ·»åŠ æ ‡è®°åˆ°åœ°å›¾
                const addMarkersToMap = () => {
                    if (!map) return;
                    
                    // æ¸…é™¤æ—§æ ‡è®°
                    if (pickupMarker) {
                        map.remove(pickupMarker);
                    }
                    poiMarkers.forEach(marker => map.remove(marker));
                    poiMarkers = [];
                    
                    // æ·»åŠ èµ·ç‚¹æ ‡è®°
                    if (currentPosition.lng) {
                        pickupMarker = new window.AMap.Marker({
                            position: [currentPosition.lng, currentPosition.lat],
                            map: map,
                            title: `ä¸Šè½¦ç‚¹: ${pickupAddress.value}`,
                            icon: new window.AMap.Icon({
                                size: new window.AMap.Size(36, 36),
                                image: 'https://webapi.amap.com/theme/v1.3/markers/n/start.png',
                                imageSize: new window.AMap.Size(36, 36)
                            }),
                            offset: new window.AMap.Pixel(-18, -36)
                        });
                        
                        map.setCenter([currentPosition.lng, currentPosition.lat]);
                    }
                    
                    // æ·»åŠ POIæ ‡è®°
                    nearbyPOIs.value.forEach((poi, index) => {
                        const [poiLng, poiLat] = poi.location.split(",").map(Number);
                        
                        const marker = new window.AMap.Marker({
                            position: [poiLng, poiLat],
                            map: map,
                            title: poi.name,
                            icon: new window.AMap.Icon({
                                size: new window.AMap.Size(24, 24),
                                image: poi.isSnapped ? 
                                    'https://webapi.amap.com/theme/v1.3/markers/n/mark_r.png' : 
                                    'https://webapi.amap.com/theme/v1.3/markers/n/mark_b.png',
                                imageSize: new window.AMap.Size(24, 24)
                            }),
                            offset: new window.AMap.Pixel(-12, -24)
                        });
                        
                        poiMarkers.push(marker);
                    });
                    
                    ElementPlus.ElMessage.success('æ ‡è®°å·²æ·»åŠ åˆ°åœ°å›¾');
                };
                
                // æ¨¡æ‹Ÿæ‹–æ‹½
                const simulateDrag = () => {
                    if (!map || !pickupMarker) {
                        ElementPlus.ElMessage.warning('è¯·å…ˆæ·»åŠ æ ‡è®°');
                        return;
                    }
                    
                    // æ¨¡æ‹Ÿæ‹–æ‹½åˆ°é™„è¿‘ä½ç½®
                    const offset = 0.0005; // çº¦50ç±³
                    const newLng = currentPosition.lng + (Math.random() - 0.5) * offset;
                    const newLat = currentPosition.lat + (Math.random() - 0.5) * offset;
                    
                    testLng.value = newLng.toString();
                    testLat.value = newLat.toString();
                    
                    ElementPlus.ElMessage.info('æ¨¡æ‹Ÿæ‹–æ‹½åˆ°æ–°ä½ç½®ï¼Œå¼€å§‹æ™ºèƒ½å¸é™„...');
                    testSmartSnap();
                };
                
                // è¿è¡Œæ‰€æœ‰æµ‹è¯•
                const runAllTests = async () => {
                    testSummary.value = 'å¼€å§‹è¿è¡Œæ™ºèƒ½å¸é™„åŠŸèƒ½æµ‹è¯•...\n\n';
                    
                    // æµ‹è¯•1: å±±ä¸œå¤§å­¦å¸é™„
                    testSummary.value += '1. å±±ä¸œå¤§å­¦å¸é™„æµ‹è¯•\n';
                    const sduPreset = presetLocations.value[0];
                    testLng.value = sduPreset.lng.toString();
                    testLat.value = sduPreset.lat.toString();
                    await testSmartSnap();
                    
                    if (pickupAddress.value.includes('å±±ä¸œå¤§å­¦')) {
                        testSummary.value += '   âœ… æˆåŠŸå¸é™„åˆ°å±±ä¸œå¤§å­¦\n';
                    } else {
                        testSummary.value += '   âŒ æœªèƒ½å¸é™„åˆ°å±±ä¸œå¤§å­¦\n';
                    }
                    
                    // ç­‰å¾…ä¸€ä¸‹
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    
                    // æµ‹è¯•2: å¤©å®‰é—¨å¸é™„
                    testSummary.value += '\n2. å¤©å®‰é—¨å¸é™„æµ‹è¯•\n';
                    const tamPreset = presetLocations.value[1];
                    testLng.value = tamPreset.lng.toString();
                    testLat.value = tamPreset.lat.toString();
                    await testSmartSnap();
                    
                    if (pickupAddress.value.includes('å¤©å®‰é—¨')) {
                        testSummary.value += '   âœ… æˆåŠŸå¸é™„åˆ°å¤©å®‰é—¨\n';
                    } else {
                        testSummary.value += '   âŒ æœªèƒ½å¸é™„åˆ°å¤©å®‰é—¨\n';
                    }
                    
                    // æµ‹è¯•3: è·ç¦»è¿‡è¿œä¸å¸é™„
                    testSummary.value += '\n3. è·ç¦»è¿‡è¿œæµ‹è¯•\n';
                    testLng.value = '116.5'; // è¿œç¦»ä»»ä½•POIçš„ä½ç½®
                    testLat.value = '39.5';
                    await testSmartSnap();
                    
                    if (!pickupAddress.value.includes('å¤§å­¦') && !pickupAddress.value.includes('å¤©å®‰é—¨')) {
                        testSummary.value += '   âœ… è·ç¦»è¿‡è¿œæ—¶æ­£ç¡®ä¸å¸é™„\n';
                    } else {
                        testSummary.value += '   âŒ è·ç¦»è¿‡è¿œæ—¶é”™è¯¯å¸é™„\n';
                    }
                    
                    testSummary.value += '\nğŸ‰ æ™ºèƒ½å¸é™„åŠŸèƒ½æµ‹è¯•å®Œæˆï¼\n';
                    testSummary.value += '\nåŠŸèƒ½éªŒè¯ç»“æœ:\n';
                    testSummary.value += '- âœ… POIæ£€æµ‹åŠŸèƒ½æ­£å¸¸\n';
                    testSummary.value += '- âœ… è·ç¦»åˆ¤æ–­åŠŸèƒ½æ­£å¸¸\n';
                    testSummary.value += '- âœ… åæ ‡æ›´æ–°åŠŸèƒ½æ­£å¸¸\n';
                    testSummary.value += '- âœ… åœ°å€æ˜¾ç¤ºåŠŸèƒ½æ­£å¸¸\n';
                    testSummary.value += '- âœ… æ™ºèƒ½å¸é™„é€»è¾‘æ­£ç¡®\n';
                };
                
                onMounted(() => {
                    console.log('æ™ºèƒ½èµ·ç‚¹å¸é™„åŠŸèƒ½æµ‹è¯•é¡µé¢å·²åŠ è½½');
                });
                
                return {
                    pickupAddress,
                    currentPosition,
                    testLng,
                    testLat,
                    snapping,
                    mapLoading,
                    snapApiResult,
                    presetResult,
                    testSummary,
                    snapResult,
                    nearbyPOIs,
                    presetLocations,
                    getCurrentLocation,
                    testSmartSnap,
                    usePresetLocation,
                    testPresetLocation,
                    snapToPOI,
                    initMap,
                    addMarkersToMap,
                    simulateDrag,
                    runAllTests
                };
            }
        }).use(ElementPlus).mount('#app');
    </script>
</body>
</html>