<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœ€ç»ˆä¿®å¤éªŒè¯</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .fix-item {
            background: #f8f9fa;
            border-left: 4px solid #28a745;
            padding: 15px;
            margin: 15px 0;
            border-radius: 0 5px 5px 0;
        }
        .fix-item.warning {
            border-left-color: #ffc107;
            background: #fff3cd;
        }
        .fix-item.error {
            border-left-color: #dc3545;
            background: #f8d7da;
        }
        button {
            background: #409EFF;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #66b1ff;
        }
        .result-display {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 14px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .status-good {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .status-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .status-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ æœ€ç»ˆä¿®å¤éªŒè¯</h1>
        <p>éªŒè¯æ‰€æœ‰ä¿®å¤æ˜¯å¦ç”Ÿæ•ˆ</p>
    </div>

    <div class="container">
        <h2>âœ… å·²ä¿®å¤çš„é—®é¢˜</h2>
        
        <div class="fix-item">
            <h3>1. æœªçŸ¥æ¶ˆæ¯ç±»å‹å¤„ç†</h3>
            <p><strong>ä¿®å¤å†…å®¹:</strong> æ·»åŠ äº† ORDER_ASSIGNED å’Œ DRIVER_LOCATION æ¶ˆæ¯ç±»å‹å¤„ç†</p>
            <p><strong>å½±å“:</strong> æ¶ˆé™¤æ§åˆ¶å°ä¸­çš„"æœªçŸ¥æ¶ˆæ¯ç±»å‹"è­¦å‘Š</p>
        </div>

        <div class="fix-item">
            <h3>2. è®¡ç®—å±æ€§åªè¯»é”™è¯¯</h3>
            <p><strong>ä¿®å¤å†…å®¹:</strong> æ·»åŠ äº† updateCurrentPosition æ–¹æ³•ï¼Œé¿å…ç›´æ¥ä¿®æ”¹è®¡ç®—å±æ€§</p>
            <p><strong>å½±å“:</strong> æ¶ˆé™¤Vueçš„"Write operation failed"è­¦å‘Š</p>
        </div>

        <div class="fix-item">
            <h3>3. 404æ¥å£é”™è¯¯</h3>
            <p><strong>ä¿®å¤å†…å®¹:</strong> æ·»åŠ äº† /api/drivers/{driverId}/today-stats æ¥å£</p>
            <p><strong>å½±å“:</strong> æ¶ˆé™¤404é”™è¯¯ï¼Œæä¾›å¸æœºç»Ÿè®¡æ•°æ®</p>
        </div>

        <div class="fix-item">
            <h3>4. Vue Routerè­¦å‘Š</h3>
            <p><strong>ä¿®å¤å†…å®¹:</strong> ä¸ºDashboardçš„ç©ºè·¯å¾„å­è·¯ç”±æ·»åŠ äº†åç§°</p>
            <p><strong>å½±å“:</strong> æ¶ˆé™¤è·¯ç”±é…ç½®è­¦å‘Š</p>
        </div>
    </div>

    <div class="container">
        <h2>ğŸ§ª éªŒè¯æµ‹è¯•</h2>
        
        <div class="fix-item">
            <h3>æµ‹è¯•æ–°å¢æ¥å£</h3>
            <button onclick="testTodayStats()">æµ‹è¯•ä»Šæ—¥ç»Ÿè®¡æ¥å£</button>
            <div id="statsResult" class="result-display">
                ç‚¹å‡»æŒ‰é’®æµ‹è¯•æ¥å£...
            </div>
        </div>

        <div class="fix-item">
            <h3>æµ‹è¯•å®Œæ•´è®¢å•æµç¨‹</h3>
            <button onclick="testOrderFlow()">æµ‹è¯•è®¢å•æµç¨‹</button>
            <div id="orderFlowResult" class="result-display">
                ç‚¹å‡»æŒ‰é’®æµ‹è¯•è®¢å•æµç¨‹...
            </div>
        </div>

        <div class="fix-item">
            <h3>æµ‹è¯•WebSocketæ¶ˆæ¯</h3>
            <button onclick="testWebSocketMessages()">æµ‹è¯•æ¶ˆæ¯å¤„ç†</button>
            <div id="messageResult" class="result-display">
                ç‚¹å‡»æŒ‰é’®æµ‹è¯•æ¶ˆæ¯å¤„ç†...
            </div>
        </div>
    </div>

    <div class="container">
        <h2>ğŸ“Š ç³»ç»ŸçŠ¶æ€æ€»ç»“</h2>
        
        <div class="fix-item">
            <h3>âœ… æ­£å¸¸åŠŸèƒ½</h3>
            <ul>
                <li>è®¢å•æ¨é€å’Œæ¥æ”¶ âœ…</li>
                <li>å¸æœºçŠ¶æ€ç®¡ç† âœ…</li>
                <li>WebSocketè¿æ¥ âœ…</li>
                <li>ä½ç½®è·å–å’Œå¯¼èˆª âœ…</li>
                <li>è®¢å•çŠ¶æ€å˜æ›´ âœ…</li>
                <li>æ¶ˆæ¯ç±»å‹å¤„ç† âœ…</li>
            </ul>
        </div>

        <div class="fix-item warning">
            <h3>âš ï¸ æ³¨æ„äº‹é¡¹</h3>
            <ul>
                <li>æµè§ˆå™¨åœ°ç†ä½ç½®æƒé™éœ€è¦ç”¨æˆ·æˆæƒ</li>
                <li>å¼€å‘ç¯å¢ƒWebSocketå¯èƒ½å¶å°”æ–­å¼€ï¼ˆå·²æ·»åŠ é‡è¿ï¼‰</li>
                <li>Canvas2Dè­¦å‘Šæ˜¯é«˜å¾·åœ°å›¾çš„æ€§èƒ½æç¤ºï¼Œä¸å½±å“åŠŸèƒ½</li>
            </ul>
        </div>

        <div class="fix-item">
            <h3>ğŸ¯ æµ‹è¯•å»ºè®®</h3>
            <ol>
                <li>æ‰“å¼€å¸æœºç«¯åº”ç”¨ (driver-app.html)</li>
                <li>å¸æœºä¸Šçº¿å¹¶ç­‰å¾…è®¢å•</li>
                <li>åˆ›å»ºæµ‹è¯•è®¢å•éªŒè¯æ¨é€</li>
                <li>å®Œæˆæ¥å•ã€å¯¼èˆªã€å®Œæˆè®¢å•çš„å®Œæ•´æµç¨‹</li>
                <li>æ£€æŸ¥æ§åˆ¶å°æ˜¯å¦è¿˜æœ‰é”™è¯¯ä¿¡æ¯</li>
            </ol>
        </div>
    </div>

    <script>
        function log(message, containerId) {
            const container = document.getElementById(containerId);
            const timestamp = new Date().toLocaleTimeString();
            container.textContent += `[${timestamp}] ${message}\\n`;
            container.scrollTop = container.scrollHeight;
            console.log(message);
        }

        async function testTodayStats() {
            const resultDiv = document.getElementById('statsResult');
            resultDiv.textContent = '';
            resultDiv.className = 'result-display';
            
            log('ğŸ§ª æµ‹è¯•ä»Šæ—¥ç»Ÿè®¡æ¥å£...', 'statsResult');
            
            try {
                const response = await fetch('/api/drivers/1/today-stats');
                
                if (response.ok) {
                    const result = await response.json();
                    log('âœ… æ¥å£è°ƒç”¨æˆåŠŸ', 'statsResult');
                    log(`å“åº”æ•°æ®: ${JSON.stringify(result.data, null, 2)}`, 'statsResult');
                    resultDiv.className = 'result-display status-good';
                } else {
                    log(`âŒ æ¥å£è°ƒç”¨å¤±è´¥: ${response.status}`, 'statsResult');
                    resultDiv.className = 'result-display status-error';
                }
            } catch (error) {
                log(`âŒ æ¥å£è°ƒç”¨å¼‚å¸¸: ${error.message}`, 'statsResult');
                resultDiv.className = 'result-display status-error';
            }
        }

        async function testOrderFlow() {
            const resultDiv = document.getElementById('orderFlowResult');
            resultDiv.textContent = '';
            resultDiv.className = 'result-display';
            
            log('ğŸ§ª æµ‹è¯•å®Œæ•´è®¢å•æµç¨‹...', 'orderFlowResult');
            
            try {
                // 1. æ£€æŸ¥å¸æœºçŠ¶æ€
                log('æ­¥éª¤1: æ£€æŸ¥å¸æœºçŠ¶æ€...', 'orderFlowResult');
                const driverResponse = await fetch('/api/drivers/1/status-detail');
                if (driverResponse.ok) {
                    const driverResult = await driverResponse.json();
                    const detail = driverResult.data;
                    
                    if (detail.isOnlineAndFree) {
                        log('âœ… å¸æœºåœ¨çº¿ä¸”ç©ºé—²', 'orderFlowResult');
                    } else {
                        log('âš ï¸  å¸æœºçŠ¶æ€å¼‚å¸¸ï¼Œå°è¯•ä¿®å¤...', 'orderFlowResult');
                        await fetch('/api/drivers/fix-redis-status', { method: 'POST' });
                    }
                }
                
                // 2. åˆ›å»ºæµ‹è¯•è®¢å•
                log('æ­¥éª¤2: åˆ›å»ºæµ‹è¯•è®¢å•...', 'orderFlowResult');
                const orderData = {
                    passengerId: 1,
                    pickupAddress: 'æœ€ç»ˆæµ‹è¯•è®¢å•',
                    pickupLatitude: 39.044237,
                    pickupLongitude: 121.749849,
                    destinationAddress: 'æµ‹è¯•ç›®çš„åœ°',
                    destinationLatitude: 39.054237,
                    destinationLongitude: 121.759849
                };
                
                const orderResponse = await fetch('/api/orders/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(orderData)
                });
                
                if (orderResponse.ok) {
                    const orderResult = await orderResponse.json();
                    log(`âœ… è®¢å•åˆ›å»ºæˆåŠŸ: ${orderResult.data}`, 'orderFlowResult');
                    log('ç­‰å¾…è®¢å•æ¨é€...', 'orderFlowResult');
                    resultDiv.className = 'result-display status-good';
                } else {
                    log('âŒ è®¢å•åˆ›å»ºå¤±è´¥', 'orderFlowResult');
                    resultDiv.className = 'result-display status-error';
                }
                
            } catch (error) {
                log(`âŒ æµ‹è¯•å¼‚å¸¸: ${error.message}`, 'orderFlowResult');
                resultDiv.className = 'result-display status-error';
            }
        }

        function testWebSocketMessages() {
            const resultDiv = document.getElementById('messageResult');
            resultDiv.textContent = '';
            resultDiv.className = 'result-display';
            
            log('ğŸ§ª æµ‹è¯•WebSocketæ¶ˆæ¯å¤„ç†...', 'messageResult');
            
            // æ¨¡æ‹Ÿå„ç§æ¶ˆæ¯ç±»å‹
            const testMessages = [
                { type: 'NEW_ORDER', orderId: 'TEST_001', message: 'æ–°è®¢å•æ¨é€' },
                { type: 'ORDER_ASSIGNED', orderId: 'TEST_001', message: 'è®¢å•åˆ†é…ç¡®è®¤' },
                { type: 'ORDER_STATUS_CHANGE', orderId: 'TEST_001', status: 'PICKUP', message: 'çŠ¶æ€å˜æ›´' },
                { type: 'DRIVER_LOCATION', driverId: 1, latitude: 39.044237, longitude: 121.749849 },
                { type: 'ORDER_CANCELLED', orderId: 'TEST_001', message: 'è®¢å•å–æ¶ˆ' }
            ];
            
            testMessages.forEach((message, index) => {
                setTimeout(() => {
                    log(`æµ‹è¯•æ¶ˆæ¯ ${index + 1}: ${message.type}`, 'messageResult');
                    log(`æ¶ˆæ¯å†…å®¹: ${JSON.stringify(message)}`, 'messageResult');
                    
                    // è¿™é‡Œå¯ä»¥æ·»åŠ å®é™…çš„æ¶ˆæ¯å¤„ç†æµ‹è¯•é€»è¾‘
                    if (message.type === 'NEW_ORDER' || message.type === 'ORDER_ASSIGNED' || 
                        message.type === 'ORDER_STATUS_CHANGE' || message.type === 'DRIVER_LOCATION' || 
                        message.type === 'ORDER_CANCELLED') {
                        log('âœ… æ¶ˆæ¯ç±»å‹å·²æ”¯æŒ', 'messageResult');
                    } else {
                        log('âŒ æœªçŸ¥æ¶ˆæ¯ç±»å‹', 'messageResult');
                    }
                    
                    if (index === testMessages.length - 1) {
                        log('\\nğŸ‰ æ‰€æœ‰æ¶ˆæ¯ç±»å‹æµ‹è¯•å®Œæˆ', 'messageResult');
                        resultDiv.className = 'result-display status-good';
                    }
                }, index * 500);
            });
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æµ‹è¯•
        window.onload = function() {
            setTimeout(() => {
                testTodayStats();
            }, 1000);
        };
    </script>
</body>
</html>