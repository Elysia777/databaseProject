<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket会话恢复测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 3px;
        }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .info { background-color: #d1ecf1; color: #0c5460; }
        .warning { background-color: #fff3cd; color: #856404; }
        .test-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        .test-step {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #007bff;
        }
        .fix-highlight {
            background: #d4edda;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #28a745;
            margin: 15px 0;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 3px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background-color: #0056b3; }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-online { background-color: #28a745; }
        .status-offline { background-color: #dc3545; }
        .status-pending { background-color: #ffc107; }
        .code-snippet {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 3px;
            font-family: monospace;
            font-size: 14px;
            border: 1px solid #e9ecef;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>🔧 WebSocket会话恢复测试</h1>

    <div class="test-section">
        <h3>🎯 测试目标</h3>
        <p>验证司机WebSocket会话管理修复后，多司机切换登录不会影响订单取消通知的接收。</p>
        
        <div class="fix-highlight">
            <strong>🔧 主要修复内容：</strong><br>
            • 后端增加会话映射管理，防止会话冲突<br>
            • 前端增强WebSocket连接，支持多队列订阅<br>
            • 订单取消通知使用多重发送机制<br>
            • 增加连接确认和心跳检测
        </div>
    </div>

    <div class="test-section">
        <h3>🧪 测试场景</h3>
        
        <div class="test-grid">
            <div class="test-step">
                <h4>场景1：正常流程</h4>
                <ol>
                    <li>司机2登录并接单</li>
                    <li>乘客取消订单</li>
                    <li><span class="status-indicator status-online"></span>司机2应收到取消通知</li>
                </ol>
                <div class="result success">
                    <strong>预期结果：</strong> 通知正常接收 ✅
                </div>
            </div>

            <div class="test-step">
                <h4>场景2：重新登录</h4>
                <ol>
                    <li>司机2登录并接单</li>
                    <li>司机2退出登录</li>
                    <li>司机2重新登录</li>
                    <li>乘客取消订单</li>
                    <li><span class="status-indicator status-online"></span>司机2应收到取消通知</li>
                </ol>
                <div class="result success">
                    <strong>预期结果：</strong> 通知正常接收 ✅
                </div>
            </div>

            <div class="test-step">
                <h4>场景3：多司机切换（问题场景）</h4>
                <ol>
                    <li>司机2登录并接单</li>
                    <li>司机2退出登录</li>
                    <li>司机1登录</li>
                    <li>司机2重新登录</li>
                    <li>乘客取消订单</li>
                    <li><span class="status-indicator status-online"></span>司机2应收到取消通知</li>
                </ol>
                <div class="result warning">
                    <strong>修复前：</strong> 通知接收失败 ❌<br>
                    <strong>修复后：</strong> 通知正常接收 ✅
                </div>
            </div>

            <div class="test-step">
                <h4>场景4：并发登录</h4>
                <ol>
                    <li>司机1和司机2同时登录</li>
                    <li>司机2接单</li>
                    <li>司机1退出登录</li>
                    <li>乘客取消订单</li>
                    <li><span class="status-indicator status-online"></span>司机2应收到取消通知</li>
                </ol>
                <div class="result success">
                    <strong>预期结果：</strong> 通知正常接收 ✅
                </div>
            </div>
        </div>
    </div>

    <div class="test-section">
        <h3>🔍 修复技术细节</h3>
        
        <h4>1. 后端会话管理增强</h4>
        <div class="code-snippet">
// 会话映射表，防止会话冲突
private final Map&lt;String, String&gt; driverSessionMap = new ConcurrentHashMap&lt;&gt;();

// 建立新会话时清除旧会话
String oldSessionId = driverSessionMap.get(driverId);
if (oldSessionId != null && !oldSessionId.equals(currentSessionId)) {
    System.out.println("⚠️ 司机已有旧会话，将被新会话替换");
    driverSessionMap.remove(driverId);
}
driverSessionMap.put(driverId, currentSessionId);
        </div>

        <h4>2. 前端多队列订阅</h4>
        <div class="code-snippet">
// 订阅多个队列确保消息接收
stompClient.subscribe(`/user/${driverId}/queue/orders`, handleOrderMessage);
stompClient.subscribe(`/user/${driverId}/queue/notifications`, handleNotificationMessage);
stompClient.subscribe(`/user/${driverId}/queue/connection`, handleConnectionMessage);
stompClient.subscribe(`/topic/driver/${driverId}`, handleBroadcastMessage);
        </div>

        <h4>3. 多重通知机制</h4>
        <div class="code-snippet">
// 方式1：发送到通知队列
messagingTemplate.convertAndSendToUser(driverId, "/queue/notifications", notification);

// 方式2：发送到订单队列（备用）
messagingTemplate.convertAndSendToUser(driverId, "/queue/orders", notification);

// 方式3：广播到司机主题（最后备用）
messagingTemplate.convertAndSend("/topic/driver/" + driverId, notification);
        </div>
    </div>

    <div class="test-section">
        <h3>🔧 调试工具</h3>
        
        <div class="result info">
            <strong>浏览器控制台检查：</strong><br>
            • 查看 <code>window.driverStompClient</code> 连接状态<br>
            • 监控 WebSocket 消息接收日志<br>
            • 检查订阅的队列列表
        </div>

        <div class="result info">
            <strong>后端日志关键词：</strong><br>
            • "司机 X WebSocket会话已建立"<br>
            • "已有旧会话 X，将被新会话 Y 替换"<br>
            • "已通过多种方式通知司机订单取消"
        </div>

        <div class="result info">
            <strong>前端日志关键词：</strong><br>
            • "司机WebSocket订阅完成"<br>
            • "司机收到通知: ORDER_CANCELLED"<br>
            • "当前执行的订单被取消，清除订单状态"
        </div>
    </div>

    <div class="test-section">
        <h3>🚀 开始测试</h3>
        <p>使用以下链接进行测试，建议在不同浏览器标签页中打开：</p>
        
        <div style="margin: 20px 0;">
            <a href="/driver-app.html?driverId=1" target="_blank">
                <button>司机1登录页面</button>
            </a>
            <a href="/driver-app.html?driverId=2" target="_blank">
                <button>司机2登录页面</button>
            </a>
            <a href="/passenger-app.html" target="_blank">
                <button>乘客端页面</button>
            </a>
        </div>

        <div class="result warning">
            <strong>测试步骤：</strong><br>
            1. 在司机2页面登录并接单<br>
            2. 关闭司机2页面（模拟退出登录）<br>
            3. 在司机1页面登录<br>
            4. 重新打开司机2页面并登录<br>
            5. 在乘客端取消订单<br>
            6. 检查司机2是否收到取消通知
        </div>
    </div>

    <div class="test-section">
        <h3>✅ 预期修复效果</h3>
        <div class="result success">
            <strong>修复后应该实现：</strong><br>
            • 司机重新登录后WebSocket会话正确绑定 ✅<br>
            • 多司机切换不会影响其他司机的会话 ✅<br>
            • 订单取消通知能够准确送达对应司机 ✅<br>
            • WebSocket连接更加稳定和可靠 ✅<br>
            • 支持多种通知方式，提高送达率 ✅
        </div>
    </div>
</body>
</html>