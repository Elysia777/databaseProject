<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¯„ä»·ç³»ç»Ÿæœ€ç»ˆæ£€æŸ¥</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/element-plus/dist/index.full.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css">
    <style>
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: 20px;
            background-color: #f5f7fa;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        .step-card {
            margin-bottom: 20px;
        }
        .result-box {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin-top: 10px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
            border-left: 4px solid #e4e7ed;
        }
        .result-box.success {
            border-left-color: #67c23a;
            background-color: #f0f9ff;
        }
        .result-box.error {
            border-left-color: #f56c6c;
            background-color: #fef0f0;
        }
        .result-box.warning {
            border-left-color: #e6a23c;
            background-color: #fdf6ec;
        }
        .status-icon {
            margin-right: 8px;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="container">
            <h1>è¯„ä»·ç³»ç»Ÿæœ€ç»ˆæ£€æŸ¥</h1>
            <p>è¿™ä¸ªé¡µé¢å°†é€æ­¥æ£€æŸ¥è¯„ä»·ç³»ç»Ÿçš„å„ä¸ªç»„ä»¶ï¼Œç¡®ä¿ä¸€åˆ‡æ­£å¸¸å·¥ä½œã€‚</p>

            <!-- æ­¥éª¤1: åç«¯è¿æ¥æ£€æŸ¥ -->
            <el-card class="step-card">
                <template #header>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span>æ­¥éª¤1: åç«¯è¿æ¥æ£€æŸ¥</span>
                        <el-button type="primary" size="small" @click="checkBackend" :loading="loading.backend">
                            æ£€æŸ¥
                        </el-button>
                    </div>
                </template>
                <p>æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œ</p>
                <div v-if="results.backend" class="result-box" :class="results.backend.type">
                    <span class="status-icon">{{ results.backend.icon }}</span>{{ results.backend.message }}
                </div>
            </el-card>

            <!-- æ­¥éª¤2: æ•°æ®åº“æ•°æ®æ£€æŸ¥ -->
            <el-card class="step-card">
                <template #header>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span>æ­¥éª¤2: æ•°æ®åº“æ•°æ®æ£€æŸ¥</span>
                        <el-button type="primary" size="small" @click="checkDatabase" :loading="loading.database">
                            æ£€æŸ¥
                        </el-button>
                    </div>
                </template>
                <p>æ£€æŸ¥æ•°æ®åº“ä¸­æ˜¯å¦æœ‰å¿…è¦çš„ç”¨æˆ·å’Œå¸æœºæ•°æ®</p>
                <div v-if="results.database" class="result-box" :class="results.database.type">
                    <span class="status-icon">{{ results.database.icon }}</span>{{ results.database.message }}
                </div>
            </el-card>

            <!-- æ­¥éª¤3: è¯„ä»·APIæµ‹è¯• -->
            <el-card class="step-card">
                <template #header>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span>æ­¥éª¤3: è¯„ä»·APIæµ‹è¯•</span>
                        <el-button type="primary" size="small" @click="testReviewAPI" :loading="loading.reviewAPI">
                            æµ‹è¯•
                        </el-button>
                    </div>
                </template>
                <p>æµ‹è¯•è¯„ä»·è·å–APIæ˜¯å¦æ­£å¸¸å·¥ä½œ</p>
                <div v-if="results.reviewAPI" class="result-box" :class="results.reviewAPI.type">
                    <span class="status-icon">{{ results.reviewAPI.icon }}</span>{{ results.reviewAPI.message }}
                </div>
            </el-card>

            <!-- æ­¥éª¤4: åˆ›å»ºæµ‹è¯•æ•°æ® -->
            <el-card class="step-card" v-if="showCreateData">
                <template #header>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span>æ­¥éª¤4: åˆ›å»ºæµ‹è¯•æ•°æ®</span>
                        <el-button type="warning" size="small" @click="createTestData" :loading="loading.createData">
                            åˆ›å»º
                        </el-button>
                    </div>
                </template>
                <p>å¦‚æœæ²¡æœ‰è¯„ä»·æ•°æ®ï¼Œåˆ›å»ºä¸€äº›æµ‹è¯•æ•°æ®</p>
                <div v-if="results.createData" class="result-box" :class="results.createData.type">
                    <span class="status-icon">{{ results.createData.icon }}</span>{{ results.createData.message }}
                </div>
            </el-card>

            <!-- æ­¥éª¤5: æœ€ç»ˆéªŒè¯ -->
            <el-card class="step-card">
                <template #header>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span>æ­¥éª¤5: æœ€ç»ˆéªŒè¯</span>
                        <el-button type="success" size="small" @click="finalVerification" :loading="loading.final">
                            éªŒè¯
                        </el-button>
                    </div>
                </template>
                <p>æœ€ç»ˆéªŒè¯è¯„ä»·ç³»ç»Ÿæ˜¯å¦å®Œå…¨æ­£å¸¸</p>
                <div v-if="results.final" class="result-box" :class="results.final.type">
                    <span class="status-icon">{{ results.final.icon }}</span>{{ results.final.message }}
                </div>
            </el-card>

            <!-- è¯„ä»·æ•°æ®å±•ç¤º -->
            <el-card v-if="reviews.length > 0" class="step-card">
                <template #header>
                    <span>è¯„ä»·æ•°æ®å±•ç¤º ({{ reviews.length }} æ¡)</span>
                </template>
                <el-table :data="reviews" style="width: 100%">
                    <el-table-column prop="id" label="ID" width="60" />
                    <el-table-column label="è¯„åˆ†" width="100">
                        <template #default="scope">
                            <el-rate v-model="scope.row.rating" disabled show-score />
                        </template>
                    </el-table-column>
                    <el-table-column prop="reviewerName" label="è¯„ä»·è€…" width="120" />
                    <el-table-column prop="revieweeName" label="è¢«è¯„ä»·è€…" width="120" />
                    <el-table-column prop="comment" label="è¯„ä»·å†…å®¹" min-width="200" />
                    <el-table-column label="è¯„ä»·æ—¶é—´" width="160">
                        <template #default="scope">
                            {{ formatTime(scope.row.createdAt) }}
                        </template>
                    </el-table-column>
                </el-table>
            </el-card>

            <!-- ä¸€é”®è¿è¡Œæ‰€æœ‰æ£€æŸ¥ -->
            <div style="text-align: center; margin-top: 30px;">
                <el-button type="primary" size="large" @click="runAllChecks" :loading="runningAll">
                    <el-icon><Check /></el-icon>
                    ä¸€é”®è¿è¡Œæ‰€æœ‰æ£€æŸ¥
                </el-button>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, reactive, computed, onMounted } = Vue;
        const { ElMessage } = ElementPlus;

        createApp({
            setup() {
                const loading = reactive({
                    backend: false,
                    database: false,
                    reviewAPI: false,
                    createData: false,
                    final: false
                });

                const results = reactive({
                    backend: null,
                    database: null,
                    reviewAPI: null,
                    createData: null,
                    final: null
                });

                const reviews = ref([]);
                const runningAll = ref(false);
                const showCreateData = ref(false);

                const checkBackend = async () => {
                    loading.backend = true;
                    try {
                        const response = await fetch('/api/auth/users');
                        if (response.ok) {
                            results.backend = {
                                type: 'success',
                                icon: 'âœ…',
                                message: `åç«¯æœåŠ¡æ­£å¸¸è¿è¡Œ\nå“åº”çŠ¶æ€: ${response.status}\næœåŠ¡å™¨æ—¶é—´: ${new Date().toLocaleString()}`
                            };
                            ElMessage.success('åç«¯è¿æ¥æ­£å¸¸');
                        } else {
                            results.backend = {
                                type: 'error',
                                icon: 'âŒ',
                                message: `åç«¯æœåŠ¡å¼‚å¸¸\nå“åº”çŠ¶æ€: ${response.status}`
                            };
                            ElMessage.error('åç«¯è¿æ¥å¼‚å¸¸');
                        }
                    } catch (error) {
                        results.backend = {
                            type: 'error',
                            icon: 'âŒ',
                            message: `æ— æ³•è¿æ¥åˆ°åç«¯æœåŠ¡\né”™è¯¯: ${error.message}\nè¯·ç¡®ä¿åç«¯æœåŠ¡è¿è¡Œåœ¨8080ç«¯å£`
                        };
                        ElMessage.error('åç«¯è¿æ¥å¤±è´¥');
                    } finally {
                        loading.backend = false;
                    }
                };

                const checkDatabase = async () => {
                    loading.database = true;
                    try {
                        const response = await fetch('/api/auth/users');
                        const data = await response.json();
                        
                        if (response.ok && (data.success || data.code === 200)) {
                            const users = data.data || [];
                            const passengers = users.filter(u => u.userType === 'PASSENGER');
                            const drivers = users.filter(u => u.userType === 'DRIVER');
                            
                            let message = `æ•°æ®åº“æ•°æ®æ£€æŸ¥ç»“æœ:\n`;
                            message += `- æ€»ç”¨æˆ·æ•°: ${users.length}\n`;
                            message += `- ä¹˜å®¢æ•°: ${passengers.length}\n`;
                            message += `- å¸æœºæ•°: ${drivers.length}\n`;
                            
                            if (passengers.length > 0 && drivers.length > 0) {
                                results.database = {
                                    type: 'success',
                                    icon: 'âœ…',
                                    message: message + '\nâœ… æ•°æ®å……è¶³ï¼Œå¯ä»¥åˆ›å»ºè¯„ä»·'
                                };
                                ElMessage.success('æ•°æ®åº“æ•°æ®æ£€æŸ¥é€šè¿‡');
                            } else {
                                results.database = {
                                    type: 'warning',
                                    icon: 'âš ï¸',
                                    message: message + '\nâš ï¸ ç¼ºå°‘ä¹˜å®¢æˆ–å¸æœºæ•°æ®ï¼Œå¯èƒ½å½±å“è¯„ä»·åŠŸèƒ½'
                                };
                                ElMessage.warning('æ•°æ®åº“æ•°æ®ä¸å®Œæ•´');
                            }
                        } else {
                            results.database = {
                                type: 'error',
                                icon: 'âŒ',
                                message: `æ•°æ®åº“æŸ¥è¯¢å¤±è´¥\né”™è¯¯: ${data.message || 'æœªçŸ¥é”™è¯¯'}`
                            };
                            ElMessage.error('æ•°æ®åº“æŸ¥è¯¢å¤±è´¥');
                        }
                    } catch (error) {
                        results.database = {
                            type: 'error',
                            icon: 'âŒ',
                            message: `æ•°æ®åº“æ£€æŸ¥å¤±è´¥\né”™è¯¯: ${error.message}`
                        };
                        ElMessage.error('æ•°æ®åº“æ£€æŸ¥å¤±è´¥');
                    } finally {
                        loading.database = false;
                    }
                };

                const testReviewAPI = async () => {
                    loading.reviewAPI = true;
                    try {
                        const response = await fetch('/api/reviews/all');
                        const data = await response.json();
                        
                        console.log('è¯„ä»·APIå“åº”:', data);
                        
                        if (response.ok && (data.success === true || data.code === 200)) {
                            if (data.data && Array.isArray(data.data)) {
                                reviews.value = data.data;
                                results.reviewAPI = {
                                    type: 'success',
                                    icon: 'âœ…',
                                    message: `è¯„ä»·APIæ­£å¸¸å·¥ä½œ\nè·å–åˆ° ${data.data.length} æ¡è¯„ä»·æ•°æ®\n\n${data.data.length > 0 ? 'ç¤ºä¾‹æ•°æ®:\n' + JSON.stringify(data.data[0], null, 2) : 'æš‚æ— è¯„ä»·æ•°æ®'}`
                                };
                                
                                if (data.data.length === 0) {
                                    showCreateData.value = true;
                                }
                                
                                ElMessage.success('è¯„ä»·APIæµ‹è¯•é€šè¿‡');
                            } else {
                                results.reviewAPI = {
                                    type: 'warning',
                                    icon: 'âš ï¸',
                                    message: `è¯„ä»·APIè¿”å›æ ¼å¼å¼‚å¸¸\ndataå­—æ®µä¸æ˜¯æ•°ç»„: ${typeof data.data}\nå®Œæ•´å“åº”: ${JSON.stringify(data, null, 2)}`
                                };
                                showCreateData.value = true;
                                ElMessage.warning('è¯„ä»·APIè¿”å›æ ¼å¼å¼‚å¸¸');
                            }
                        } else {
                            results.reviewAPI = {
                                type: 'error',
                                icon: 'âŒ',
                                message: `è¯„ä»·APIè°ƒç”¨å¤±è´¥\nçŠ¶æ€: ${response.status}\né”™è¯¯: ${data.message || 'æœªçŸ¥é”™è¯¯'}\nå®Œæ•´å“åº”: ${JSON.stringify(data, null, 2)}`
                            };
                            ElMessage.error('è¯„ä»·APIè°ƒç”¨å¤±è´¥');
                        }
                    } catch (error) {
                        results.reviewAPI = {
                            type: 'error',
                            icon: 'âŒ',
                            message: `è¯„ä»·APIè¯·æ±‚å¤±è´¥\né”™è¯¯: ${error.message}\nå¯èƒ½åŸå› :\n1. reviewsè¡¨ä¸å­˜åœ¨\n2. æ•°æ®åº“è¿æ¥é—®é¢˜\n3. åç«¯ä»£ç é”™è¯¯`
                        };
                        ElMessage.error('è¯„ä»·APIè¯·æ±‚å¤±è´¥');
                    } finally {
                        loading.reviewAPI = false;
                    }
                };

                const createTestData = async () => {
                    loading.createData = true;
                    try {
                        // å°è¯•åˆ›å»ºä¸€ä¸ªæµ‹è¯•è¯„ä»·
                        const testReview = {
                            orderId: 1,
                            passengerId: 1,
                            driverId: 1,
                            rating: 5.0,
                            comment: 'è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•è¯„ä»·ï¼Œç”¨äºéªŒè¯ç³»ç»ŸåŠŸèƒ½ã€‚',
                            tags: '["æµ‹è¯•", "ç³»ç»ŸéªŒè¯"]'
                        };

                        const response = await fetch('/api/reviews', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(testReview)
                        });

                        const data = await response.json();
                        
                        if (response.ok && (data.success === true || data.code === 200)) {
                            results.createData = {
                                type: 'success',
                                icon: 'âœ…',
                                message: `æµ‹è¯•æ•°æ®åˆ›å»ºæˆåŠŸ\nè¯„ä»·ID: ${data.data?.id || 'æœªçŸ¥'}\nç°åœ¨å¯ä»¥é‡æ–°æµ‹è¯•è¯„ä»·API`
                            };
                            ElMessage.success('æµ‹è¯•æ•°æ®åˆ›å»ºæˆåŠŸ');
                            
                            // é‡æ–°æµ‹è¯•API
                            setTimeout(() => {
                                testReviewAPI();
                            }, 1000);
                        } else {
                            results.createData = {
                                type: 'error',
                                icon: 'âŒ',
                                message: `æµ‹è¯•æ•°æ®åˆ›å»ºå¤±è´¥\né”™è¯¯: ${data.message || 'æœªçŸ¥é”™è¯¯'}\n\nå¯èƒ½éœ€è¦:\n1. ç¡®ä¿reviewsè¡¨å­˜åœ¨\n2. ç¡®ä¿æœ‰å¯¹åº”çš„ç”¨æˆ·å’Œå¸æœºæ•°æ®\n3. æ£€æŸ¥æ•°æ®åº“çº¦æŸ`
                            };
                            ElMessage.error('æµ‹è¯•æ•°æ®åˆ›å»ºå¤±è´¥');
                        }
                    } catch (error) {
                        results.createData = {
                            type: 'error',
                            icon: 'âŒ',
                            message: `æµ‹è¯•æ•°æ®åˆ›å»ºè¯·æ±‚å¤±è´¥\né”™è¯¯: ${error.message}`
                        };
                        ElMessage.error('æµ‹è¯•æ•°æ®åˆ›å»ºè¯·æ±‚å¤±è´¥');
                    } finally {
                        loading.createData = false;
                    }
                };

                const finalVerification = async () => {
                    loading.final = true;
                    try {
                        // é‡æ–°æµ‹è¯•æ‰€æœ‰å…³é”®åŠŸèƒ½
                        const response = await fetch('/api/reviews/all');
                        const data = await response.json();
                        
                        if (response.ok && (data.success === true || data.code === 200) && 
                            data.data && Array.isArray(data.data) && data.data.length > 0) {
                            
                            results.final = {
                                type: 'success',
                                icon: 'ğŸ‰',
                                message: `ğŸ‰ è¯„ä»·ç³»ç»ŸéªŒè¯æˆåŠŸï¼\n\nâœ… åç«¯æœåŠ¡æ­£å¸¸\nâœ… æ•°æ®åº“è¿æ¥æ­£å¸¸\nâœ… è¯„ä»·APIå·¥ä½œæ­£å¸¸\nâœ… è·å–åˆ° ${data.data.length} æ¡è¯„ä»·æ•°æ®\n\nç³»ç»Ÿå·²å‡†å¤‡å°±ç»ªï¼Œå¯ä»¥æ­£å¸¸ä½¿ç”¨è¯„ä»·ç®¡ç†åŠŸèƒ½ï¼`
                            };
                            ElMessage.success('ç³»ç»ŸéªŒè¯æˆåŠŸï¼');
                        } else {
                            results.final = {
                                type: 'warning',
                                icon: 'âš ï¸',
                                message: `âš ï¸ ç³»ç»Ÿéƒ¨åˆ†åŠŸèƒ½æ­£å¸¸\n\nå¯èƒ½å­˜åœ¨çš„é—®é¢˜:\n- è¯„ä»·æ•°æ®ä¸ºç©º\n- APIè¿”å›æ ¼å¼å¼‚å¸¸\n\nå»ºè®®æ£€æŸ¥æ•°æ®åº“ä¸­çš„reviewsè¡¨å’Œæµ‹è¯•æ•°æ®`
                            };
                            ElMessage.warning('ç³»ç»Ÿéƒ¨åˆ†åŠŸèƒ½æ­£å¸¸');
                        }
                    } catch (error) {
                        results.final = {
                            type: 'error',
                            icon: 'âŒ',
                            message: `âŒ ç³»ç»ŸéªŒè¯å¤±è´¥\n\né”™è¯¯: ${error.message}\n\nè¯·æ£€æŸ¥:\n1. åç«¯æœåŠ¡çŠ¶æ€\n2. æ•°æ®åº“è¿æ¥\n3. reviewsè¡¨ç»“æ„`
                        };
                        ElMessage.error('ç³»ç»ŸéªŒè¯å¤±è´¥');
                    } finally {
                        loading.final = false;
                    }
                };

                const runAllChecks = async () => {
                    runningAll.value = true;
                    try {
                        await checkBackend();
                        await new Promise(resolve => setTimeout(resolve, 500));
                        
                        await checkDatabase();
                        await new Promise(resolve => setTimeout(resolve, 500));
                        
                        await testReviewAPI();
                        await new Promise(resolve => setTimeout(resolve, 500));
                        
                        await finalVerification();
                        
                        ElMessage.success('æ‰€æœ‰æ£€æŸ¥å®Œæˆ');
                    } catch (error) {
                        ElMessage.error('æ£€æŸ¥è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯');
                    } finally {
                        runningAll.value = false;
                    }
                };

                const formatTime = (time) => {
                    if (!time) return '-';
                    return new Date(time).toLocaleString();
                };

                onMounted(() => {
                    console.log('è¯„ä»·ç³»ç»Ÿæœ€ç»ˆæ£€æŸ¥é¡µé¢å·²åŠ è½½');
                });

                return {
                    loading,
                    results,
                    reviews,
                    runningAll,
                    showCreateData,
                    checkBackend,
                    checkDatabase,
                    testReviewAPI,
                    createTestData,
                    finalVerification,
                    runAllChecks,
                    formatTime
                };
            }
        }).use(ElementPlus).mount('#app');
    </script>
</body>
</html>