<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>评价系统最终检查</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/element-plus/dist/index.full.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css">
    <style>
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: 20px;
            background-color: #f5f7fa;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        .step-card {
            margin-bottom: 20px;
        }
        .result-box {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin-top: 10px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
            border-left: 4px solid #e4e7ed;
        }
        .result-box.success {
            border-left-color: #67c23a;
            background-color: #f0f9ff;
        }
        .result-box.error {
            border-left-color: #f56c6c;
            background-color: #fef0f0;
        }
        .result-box.warning {
            border-left-color: #e6a23c;
            background-color: #fdf6ec;
        }
        .status-icon {
            margin-right: 8px;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="container">
            <h1>评价系统最终检查</h1>
            <p>这个页面将逐步检查评价系统的各个组件，确保一切正常工作。</p>

            <!-- 步骤1: 后端连接检查 -->
            <el-card class="step-card">
                <template #header>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span>步骤1: 后端连接检查</span>
                        <el-button type="primary" size="small" @click="checkBackend" :loading="loading.backend">
                            检查
                        </el-button>
                    </div>
                </template>
                <p>检查后端服务是否正常运行</p>
                <div v-if="results.backend" class="result-box" :class="results.backend.type">
                    <span class="status-icon">{{ results.backend.icon }}</span>{{ results.backend.message }}
                </div>
            </el-card>

            <!-- 步骤2: 数据库数据检查 -->
            <el-card class="step-card">
                <template #header>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span>步骤2: 数据库数据检查</span>
                        <el-button type="primary" size="small" @click="checkDatabase" :loading="loading.database">
                            检查
                        </el-button>
                    </div>
                </template>
                <p>检查数据库中是否有必要的用户和司机数据</p>
                <div v-if="results.database" class="result-box" :class="results.database.type">
                    <span class="status-icon">{{ results.database.icon }}</span>{{ results.database.message }}
                </div>
            </el-card>

            <!-- 步骤3: 评价API测试 -->
            <el-card class="step-card">
                <template #header>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span>步骤3: 评价API测试</span>
                        <el-button type="primary" size="small" @click="testReviewAPI" :loading="loading.reviewAPI">
                            测试
                        </el-button>
                    </div>
                </template>
                <p>测试评价获取API是否正常工作</p>
                <div v-if="results.reviewAPI" class="result-box" :class="results.reviewAPI.type">
                    <span class="status-icon">{{ results.reviewAPI.icon }}</span>{{ results.reviewAPI.message }}
                </div>
            </el-card>

            <!-- 步骤4: 创建测试数据 -->
            <el-card class="step-card" v-if="showCreateData">
                <template #header>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span>步骤4: 创建测试数据</span>
                        <el-button type="warning" size="small" @click="createTestData" :loading="loading.createData">
                            创建
                        </el-button>
                    </div>
                </template>
                <p>如果没有评价数据，创建一些测试数据</p>
                <div v-if="results.createData" class="result-box" :class="results.createData.type">
                    <span class="status-icon">{{ results.createData.icon }}</span>{{ results.createData.message }}
                </div>
            </el-card>

            <!-- 步骤5: 最终验证 -->
            <el-card class="step-card">
                <template #header>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span>步骤5: 最终验证</span>
                        <el-button type="success" size="small" @click="finalVerification" :loading="loading.final">
                            验证
                        </el-button>
                    </div>
                </template>
                <p>最终验证评价系统是否完全正常</p>
                <div v-if="results.final" class="result-box" :class="results.final.type">
                    <span class="status-icon">{{ results.final.icon }}</span>{{ results.final.message }}
                </div>
            </el-card>

            <!-- 评价数据展示 -->
            <el-card v-if="reviews.length > 0" class="step-card">
                <template #header>
                    <span>评价数据展示 ({{ reviews.length }} 条)</span>
                </template>
                <el-table :data="reviews" style="width: 100%">
                    <el-table-column prop="id" label="ID" width="60" />
                    <el-table-column label="评分" width="100">
                        <template #default="scope">
                            <el-rate v-model="scope.row.rating" disabled show-score />
                        </template>
                    </el-table-column>
                    <el-table-column prop="reviewerName" label="评价者" width="120" />
                    <el-table-column prop="revieweeName" label="被评价者" width="120" />
                    <el-table-column prop="comment" label="评价内容" min-width="200" />
                    <el-table-column label="评价时间" width="160">
                        <template #default="scope">
                            {{ formatTime(scope.row.createdAt) }}
                        </template>
                    </el-table-column>
                </el-table>
            </el-card>

            <!-- 一键运行所有检查 -->
            <div style="text-align: center; margin-top: 30px;">
                <el-button type="primary" size="large" @click="runAllChecks" :loading="runningAll">
                    <el-icon><Check /></el-icon>
                    一键运行所有检查
                </el-button>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, reactive, computed, onMounted } = Vue;
        const { ElMessage } = ElementPlus;

        createApp({
            setup() {
                const loading = reactive({
                    backend: false,
                    database: false,
                    reviewAPI: false,
                    createData: false,
                    final: false
                });

                const results = reactive({
                    backend: null,
                    database: null,
                    reviewAPI: null,
                    createData: null,
                    final: null
                });

                const reviews = ref([]);
                const runningAll = ref(false);
                const showCreateData = ref(false);

                const checkBackend = async () => {
                    loading.backend = true;
                    try {
                        const response = await fetch('/api/auth/users');
                        if (response.ok) {
                            results.backend = {
                                type: 'success',
                                icon: '✅',
                                message: `后端服务正常运行\n响应状态: ${response.status}\n服务器时间: ${new Date().toLocaleString()}`
                            };
                            ElMessage.success('后端连接正常');
                        } else {
                            results.backend = {
                                type: 'error',
                                icon: '❌',
                                message: `后端服务异常\n响应状态: ${response.status}`
                            };
                            ElMessage.error('后端连接异常');
                        }
                    } catch (error) {
                        results.backend = {
                            type: 'error',
                            icon: '❌',
                            message: `无法连接到后端服务\n错误: ${error.message}\n请确保后端服务运行在8080端口`
                        };
                        ElMessage.error('后端连接失败');
                    } finally {
                        loading.backend = false;
                    }
                };

                const checkDatabase = async () => {
                    loading.database = true;
                    try {
                        const response = await fetch('/api/auth/users');
                        const data = await response.json();
                        
                        if (response.ok && (data.success || data.code === 200)) {
                            const users = data.data || [];
                            const passengers = users.filter(u => u.userType === 'PASSENGER');
                            const drivers = users.filter(u => u.userType === 'DRIVER');
                            
                            let message = `数据库数据检查结果:\n`;
                            message += `- 总用户数: ${users.length}\n`;
                            message += `- 乘客数: ${passengers.length}\n`;
                            message += `- 司机数: ${drivers.length}\n`;
                            
                            if (passengers.length > 0 && drivers.length > 0) {
                                results.database = {
                                    type: 'success',
                                    icon: '✅',
                                    message: message + '\n✅ 数据充足，可以创建评价'
                                };
                                ElMessage.success('数据库数据检查通过');
                            } else {
                                results.database = {
                                    type: 'warning',
                                    icon: '⚠️',
                                    message: message + '\n⚠️ 缺少乘客或司机数据，可能影响评价功能'
                                };
                                ElMessage.warning('数据库数据不完整');
                            }
                        } else {
                            results.database = {
                                type: 'error',
                                icon: '❌',
                                message: `数据库查询失败\n错误: ${data.message || '未知错误'}`
                            };
                            ElMessage.error('数据库查询失败');
                        }
                    } catch (error) {
                        results.database = {
                            type: 'error',
                            icon: '❌',
                            message: `数据库检查失败\n错误: ${error.message}`
                        };
                        ElMessage.error('数据库检查失败');
                    } finally {
                        loading.database = false;
                    }
                };

                const testReviewAPI = async () => {
                    loading.reviewAPI = true;
                    try {
                        const response = await fetch('/api/reviews/all');
                        const data = await response.json();
                        
                        console.log('评价API响应:', data);
                        
                        if (response.ok && (data.success === true || data.code === 200)) {
                            if (data.data && Array.isArray(data.data)) {
                                reviews.value = data.data;
                                results.reviewAPI = {
                                    type: 'success',
                                    icon: '✅',
                                    message: `评价API正常工作\n获取到 ${data.data.length} 条评价数据\n\n${data.data.length > 0 ? '示例数据:\n' + JSON.stringify(data.data[0], null, 2) : '暂无评价数据'}`
                                };
                                
                                if (data.data.length === 0) {
                                    showCreateData.value = true;
                                }
                                
                                ElMessage.success('评价API测试通过');
                            } else {
                                results.reviewAPI = {
                                    type: 'warning',
                                    icon: '⚠️',
                                    message: `评价API返回格式异常\ndata字段不是数组: ${typeof data.data}\n完整响应: ${JSON.stringify(data, null, 2)}`
                                };
                                showCreateData.value = true;
                                ElMessage.warning('评价API返回格式异常');
                            }
                        } else {
                            results.reviewAPI = {
                                type: 'error',
                                icon: '❌',
                                message: `评价API调用失败\n状态: ${response.status}\n错误: ${data.message || '未知错误'}\n完整响应: ${JSON.stringify(data, null, 2)}`
                            };
                            ElMessage.error('评价API调用失败');
                        }
                    } catch (error) {
                        results.reviewAPI = {
                            type: 'error',
                            icon: '❌',
                            message: `评价API请求失败\n错误: ${error.message}\n可能原因:\n1. reviews表不存在\n2. 数据库连接问题\n3. 后端代码错误`
                        };
                        ElMessage.error('评价API请求失败');
                    } finally {
                        loading.reviewAPI = false;
                    }
                };

                const createTestData = async () => {
                    loading.createData = true;
                    try {
                        // 尝试创建一个测试评价
                        const testReview = {
                            orderId: 1,
                            passengerId: 1,
                            driverId: 1,
                            rating: 5.0,
                            comment: '这是一个测试评价，用于验证系统功能。',
                            tags: '["测试", "系统验证"]'
                        };

                        const response = await fetch('/api/reviews', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(testReview)
                        });

                        const data = await response.json();
                        
                        if (response.ok && (data.success === true || data.code === 200)) {
                            results.createData = {
                                type: 'success',
                                icon: '✅',
                                message: `测试数据创建成功\n评价ID: ${data.data?.id || '未知'}\n现在可以重新测试评价API`
                            };
                            ElMessage.success('测试数据创建成功');
                            
                            // 重新测试API
                            setTimeout(() => {
                                testReviewAPI();
                            }, 1000);
                        } else {
                            results.createData = {
                                type: 'error',
                                icon: '❌',
                                message: `测试数据创建失败\n错误: ${data.message || '未知错误'}\n\n可能需要:\n1. 确保reviews表存在\n2. 确保有对应的用户和司机数据\n3. 检查数据库约束`
                            };
                            ElMessage.error('测试数据创建失败');
                        }
                    } catch (error) {
                        results.createData = {
                            type: 'error',
                            icon: '❌',
                            message: `测试数据创建请求失败\n错误: ${error.message}`
                        };
                        ElMessage.error('测试数据创建请求失败');
                    } finally {
                        loading.createData = false;
                    }
                };

                const finalVerification = async () => {
                    loading.final = true;
                    try {
                        // 重新测试所有关键功能
                        const response = await fetch('/api/reviews/all');
                        const data = await response.json();
                        
                        if (response.ok && (data.success === true || data.code === 200) && 
                            data.data && Array.isArray(data.data) && data.data.length > 0) {
                            
                            results.final = {
                                type: 'success',
                                icon: '🎉',
                                message: `🎉 评价系统验证成功！\n\n✅ 后端服务正常\n✅ 数据库连接正常\n✅ 评价API工作正常\n✅ 获取到 ${data.data.length} 条评价数据\n\n系统已准备就绪，可以正常使用评价管理功能！`
                            };
                            ElMessage.success('系统验证成功！');
                        } else {
                            results.final = {
                                type: 'warning',
                                icon: '⚠️',
                                message: `⚠️ 系统部分功能正常\n\n可能存在的问题:\n- 评价数据为空\n- API返回格式异常\n\n建议检查数据库中的reviews表和测试数据`
                            };
                            ElMessage.warning('系统部分功能正常');
                        }
                    } catch (error) {
                        results.final = {
                            type: 'error',
                            icon: '❌',
                            message: `❌ 系统验证失败\n\n错误: ${error.message}\n\n请检查:\n1. 后端服务状态\n2. 数据库连接\n3. reviews表结构`
                        };
                        ElMessage.error('系统验证失败');
                    } finally {
                        loading.final = false;
                    }
                };

                const runAllChecks = async () => {
                    runningAll.value = true;
                    try {
                        await checkBackend();
                        await new Promise(resolve => setTimeout(resolve, 500));
                        
                        await checkDatabase();
                        await new Promise(resolve => setTimeout(resolve, 500));
                        
                        await testReviewAPI();
                        await new Promise(resolve => setTimeout(resolve, 500));
                        
                        await finalVerification();
                        
                        ElMessage.success('所有检查完成');
                    } catch (error) {
                        ElMessage.error('检查过程中出现错误');
                    } finally {
                        runningAll.value = false;
                    }
                };

                const formatTime = (time) => {
                    if (!time) return '-';
                    return new Date(time).toLocaleString();
                };

                onMounted(() => {
                    console.log('评价系统最终检查页面已加载');
                });

                return {
                    loading,
                    results,
                    reviews,
                    runningAll,
                    showCreateData,
                    checkBackend,
                    checkDatabase,
                    testReviewAPI,
                    createTestData,
                    finalVerification,
                    runAllChecks,
                    formatTime
                };
            }
        }).use(ElementPlus).mount('#app');
    </script>
</body>
</html>