<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è®¢å•æ¨é€ä¿®å¤æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #333;
        }
        button {
            background: #409EFF;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #66b1ff;
        }
        button.success {
            background: #67c23a;
        }
        button.danger {
            background: #f56c6c;
        }
        .result-display {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 14px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .status-good {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .status-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .status-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        .order-card {
            background: #fff;
            border: 2px solid #409EFF;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .order-number {
            font-weight: bold;
            color: #409EFF;
        }
        .countdown {
            background: #f56c6c;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-weight: bold;
        }
        .order-details {
            margin: 10px 0;
        }
        .order-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ è®¢å•æ¨é€ä¿®å¤æµ‹è¯•</h1>
        <p>æµ‹è¯•ä¿®å¤åçš„è®¢å•æ¨é€å’Œç•Œé¢æ˜¾ç¤ºåŠŸèƒ½</p>
    </div>

    <div class="container">
        <div class="test-section">
            <h3>1. WebSocketè¿æ¥çŠ¶æ€</h3>
            <button onclick="connectWebSocket()">å»ºç«‹WebSocketè¿æ¥</button>
            <button onclick="disconnectWebSocket()">æ–­å¼€è¿æ¥</button>
            
            <div id="connectionStatus" class="result-display">
                ç‚¹å‡»æŒ‰é’®å»ºç«‹WebSocketè¿æ¥...
            </div>
        </div>

        <div class="test-section">
            <h3>2. è®¢å•æ¨é€æµ‹è¯•</h3>
            <button onclick="createTestOrder()">åˆ›å»ºæµ‹è¯•è®¢å•</button>
            <button onclick="checkOrderData()">æ£€æŸ¥æ¨é€æ•°æ®</button>
            
            <div id="pushStatus" class="result-display">
                ç‚¹å‡»æŒ‰é’®æµ‹è¯•è®¢å•æ¨é€...
            </div>
        </div>

        <div class="test-section">
            <h3>3. æ¥æ”¶åˆ°çš„è®¢å•</h3>
            <div id="receivedOrders">
                <p>ç­‰å¾…æ¥æ”¶è®¢å•æ¨é€...</p>
            </div>
        </div>
    </div>

    <script>
        let ws = null;
        let receivedOrders = [];

        function log(message, containerId = 'pushStatus') {
            const container = document.getElementById(containerId);
            const timestamp = new Date().toLocaleTimeString();
            container.textContent += `[${timestamp}] ${message}\\n`;
            container.scrollTop = container.scrollHeight;
            console.log(message);
        }

        function connectWebSocket() {
            const statusDiv = document.getElementById('connectionStatus');
            
            if (ws && ws.readyState === WebSocket.OPEN) {
                statusDiv.textContent = 'âš ï¸  WebSocketå·²ç»è¿æ¥\\n';
                statusDiv.className = 'result-display status-warning';
                return;
            }

            try {
                ws = new WebSocket('ws://localhost:8080/ws/driver/1');
                
                ws.onopen = function() {
                    statusDiv.textContent = 'âœ… WebSocketè¿æ¥æˆåŠŸ\\nå¸æœºID: 1\\nç­‰å¾…è®¢å•æ¨é€...\\n';
                    statusDiv.className = 'result-display status-good';
                    log('WebSocketè¿æ¥å»ºç«‹æˆåŠŸ', 'connectionStatus');
                };
                
                ws.onmessage = function(event) {
                    log('ğŸ“¨ æ”¶åˆ°æ¨é€æ¶ˆæ¯', 'connectionStatus');
                    handleOrderPush(event.data);
                };
                
                ws.onerror = function(error) {
                    statusDiv.textContent += `âŒ WebSocketé”™è¯¯: ${error}\\n`;
                    statusDiv.className = 'result-display status-error';
                    log('WebSocketè¿æ¥é”™è¯¯', 'connectionStatus');
                };
                
                ws.onclose = function() {
                    statusDiv.textContent += 'ğŸ”Œ WebSocketè¿æ¥å…³é—­\\n';
                    log('WebSocketè¿æ¥å…³é—­', 'connectionStatus');
                };
                
            } catch (error) {
                statusDiv.textContent = `âŒ è¿æ¥å¤±è´¥: ${error.message}\\n`;
                statusDiv.className = 'result-display status-error';
            }
        }

        function disconnectWebSocket() {
            if (ws) {
                ws.close();
                ws = null;
                document.getElementById('connectionStatus').textContent += 'ğŸ”Œ æ‰‹åŠ¨æ–­å¼€è¿æ¥\\n';
            }
        }

        function handleOrderPush(messageData) {
            try {
                const data = JSON.parse(messageData);
                log(`æ”¶åˆ°è®¢å•æ¨é€: ${JSON.stringify(data, null, 2)}`, 'pushStatus');
                
                // æ£€æŸ¥æ•°æ®å®Œæ•´æ€§
                const requiredFields = ['orderId', 'orderNumber', 'pickupAddress', 'destinationAddress', 
                                      'pickupLatitude', 'pickupLongitude', 'destinationLatitude', 'destinationLongitude'];
                
                const missingFields = requiredFields.filter(field => !data[field]);
                
                if (missingFields.length > 0) {
                    log(`âš ï¸  æ¨é€æ•°æ®ç¼ºå°‘å­—æ®µ: ${missingFields.join(', ')}`, 'pushStatus');
                } else {
                    log('âœ… æ¨é€æ•°æ®å®Œæ•´', 'pushStatus');
                }
                
                // æ·»åŠ åˆ°æ¥æ”¶è®¢å•åˆ—è¡¨
                receivedOrders.push({
                    ...data,
                    receivedAt: new Date().toLocaleTimeString(),
                    countdown: 15
                });
                
                displayReceivedOrders();
                startCountdown(data.orderId);
                
            } catch (error) {
                log(`âŒ è§£ææ¨é€æ•°æ®å¤±è´¥: ${error.message}`, 'pushStatus');
            }
        }

        function displayReceivedOrders() {
            const container = document.getElementById('receivedOrders');
            
            if (receivedOrders.length === 0) {
                container.innerHTML = '<p>ç­‰å¾…æ¥æ”¶è®¢å•æ¨é€...</p>';
                return;
            }
            
            container.innerHTML = receivedOrders.map(order => `
                <div class="order-card" id="order-${order.orderId}">
                    <div class="order-header">
                        <span class="order-number">è®¢å• ${order.orderNumber}</span>
                        <span class="countdown" id="countdown-${order.orderId}">${order.countdown}s</span>
                    </div>
                    <div class="order-details">
                        <p><strong>ä¸Šè½¦åœ°å€:</strong> ${order.pickupAddress}</p>
                        <p><strong>ç›®çš„åœ°å€:</strong> ${order.destinationAddress}</p>
                        <p><strong>ä¸Šè½¦åæ ‡:</strong> ${order.pickupLatitude}, ${order.pickupLongitude}</p>
                        <p><strong>ç›®çš„åæ ‡:</strong> ${order.destinationLatitude}, ${order.destinationLongitude}</p>
                        <p><strong>è·ç¦»:</strong> ${order.distance} km</p>
                        <p><strong>é¢„ä¼°è´¹ç”¨:</strong> ${order.estimatedFare}</p>
                        <p><strong>æ¥æ”¶æ—¶é—´:</strong> ${order.receivedAt}</p>
                    </div>
                    <div class="order-actions">
                        <button class="success" onclick="acceptOrder('${order.orderId}')">æ¥å•</button>
                        <button class="danger" onclick="rejectOrder('${order.orderId}')">æ‹’å•</button>
                    </div>
                </div>
            `).join('');
        }

        function startCountdown(orderId) {
            const order = receivedOrders.find(o => o.orderId === orderId);
            if (!order) return;
            
            const interval = setInterval(() => {
                order.countdown--;
                const countdownElement = document.getElementById(`countdown-${orderId}`);
                if (countdownElement) {
                    countdownElement.textContent = `${order.countdown}s`;
                }
                
                if (order.countdown <= 0) {
                    clearInterval(interval);
                    // è‡ªåŠ¨æ‹’å•
                    rejectOrder(orderId, 'è¶…æ—¶è‡ªåŠ¨æ‹’å•');
                }
            }, 1000);
        }

        async function acceptOrder(orderId) {
            try {
                const response = await fetch(`/api/drivers/1/accept-order/${orderId}`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    log(`âœ… æ¥å•æˆåŠŸ: ${orderId}`, 'pushStatus');
                    removeOrder(orderId);
                } else {
                    log(`âŒ æ¥å•å¤±è´¥: ${orderId}`, 'pushStatus');
                }
            } catch (error) {
                log(`âŒ æ¥å•å¼‚å¸¸: ${error.message}`, 'pushStatus');
            }
        }

        async function rejectOrder(orderId, reason = 'å¸æœºæ‹’å•') {
            try {
                const response = await fetch(`/api/drivers/1/reject-order/${orderId}?reason=${encodeURIComponent(reason)}`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    log(`âœ… æ‹’å•æˆåŠŸ: ${orderId} (${reason})`, 'pushStatus');
                    removeOrder(orderId);
                } else {
                    log(`âŒ æ‹’å•å¤±è´¥: ${orderId}`, 'pushStatus');
                }
            } catch (error) {
                log(`âŒ æ‹’å•å¼‚å¸¸: ${error.message}`, 'pushStatus');
            }
        }

        function removeOrder(orderId) {
            receivedOrders = receivedOrders.filter(order => order.orderId !== orderId);
            displayReceivedOrders();
        }

        async function createTestOrder() {
            try {
                const orderData = {
                    passengerId: 1,
                    pickupAddress: 'ä¿®å¤æµ‹è¯•è®¢å• - å¤§è¿ç†å·¥å¤§å­¦',
                    pickupLatitude: 39.044237,
                    pickupLongitude: 121.749849,
                    destinationAddress: 'ä¿®å¤æµ‹è¯•ç›®çš„åœ° - å¤§è¿ç«è½¦ç«™',
                    destinationLatitude: 39.054237,
                    destinationLongitude: 121.759849
                };
                
                const response = await fetch('/api/orders/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(orderData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    log(`âœ… æµ‹è¯•è®¢å•åˆ›å»ºæˆåŠŸï¼ŒID: ${result.data}`, 'pushStatus');
                    log('ç­‰å¾…è®¢å•æ¨é€...', 'pushStatus');
                } else {
                    log(`âŒ åˆ›å»ºè®¢å•å¤±è´¥: ${response.status}`, 'pushStatus');
                }
            } catch (error) {
                log(`âŒ åˆ›å»ºè®¢å•å¼‚å¸¸: ${error.message}`, 'pushStatus');
            }
        }

        async function checkOrderData() {
            if (receivedOrders.length === 0) {
                log('âŒ æ²¡æœ‰æ¥æ”¶åˆ°è®¢å•æ•°æ®', 'pushStatus');
                return;
            }
            
            const latestOrder = receivedOrders[receivedOrders.length - 1];
            log('æœ€æ–°è®¢å•æ•°æ®æ£€æŸ¥:', 'pushStatus');
            log(`è®¢å•ID: ${latestOrder.orderId}`, 'pushStatus');
            log(`è®¢å•å·: ${latestOrder.orderNumber}`, 'pushStatus');
            log(`ä¸Šè½¦åœ°å€: ${latestOrder.pickupAddress}`, 'pushStatus');
            log(`ç›®çš„åœ°å€: ${latestOrder.destinationAddress}`, 'pushStatus');
            log(`ä¸Šè½¦åæ ‡: ${latestOrder.pickupLatitude}, ${latestOrder.pickupLongitude}`, 'pushStatus');
            log(`ç›®çš„åæ ‡: ${latestOrder.destinationLatitude}, ${latestOrder.destinationLongitude}`, 'pushStatus');
            log(`è·ç¦»: ${latestOrder.distance} km`, 'pushStatus');
            log(`é¢„ä¼°è´¹ç”¨: ${latestOrder.estimatedFare}`, 'pushStatus');
            
            // æ£€æŸ¥æ•°æ®å®Œæ•´æ€§
            const requiredFields = ['orderId', 'orderNumber', 'pickupAddress', 'destinationAddress', 
                                  'pickupLatitude', 'pickupLongitude', 'destinationLatitude', 'destinationLongitude'];
            
            const missingFields = requiredFields.filter(field => !latestOrder[field]);
            
            if (missingFields.length === 0) {
                log('âœ… è®¢å•æ•°æ®å®Œæ•´ï¼Œå¯ä»¥æ­£å¸¸æ˜¾ç¤º', 'pushStatus');
            } else {
                log(`âŒ è®¢å•æ•°æ®ä¸å®Œæ•´ï¼Œç¼ºå°‘: ${missingFields.join(', ')}`, 'pushStatus');
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿æ¥
        window.onload = function() {
            setTimeout(() => {
                connectWebSocket();
            }, 1000);
        };
    </script>
</body>
</html>