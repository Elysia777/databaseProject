<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>订单推送修复测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #333;
        }
        button {
            background: #409EFF;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #66b1ff;
        }
        button.success {
            background: #67c23a;
        }
        button.danger {
            background: #f56c6c;
        }
        .result-display {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 14px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .status-good {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .status-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .status-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        .order-card {
            background: #fff;
            border: 2px solid #409EFF;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .order-number {
            font-weight: bold;
            color: #409EFF;
        }
        .countdown {
            background: #f56c6c;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-weight: bold;
        }
        .order-details {
            margin: 10px 0;
        }
        .order-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔧 订单推送修复测试</h1>
        <p>测试修复后的订单推送和界面显示功能</p>
    </div>

    <div class="container">
        <div class="test-section">
            <h3>1. WebSocket连接状态</h3>
            <button onclick="connectWebSocket()">建立WebSocket连接</button>
            <button onclick="disconnectWebSocket()">断开连接</button>
            
            <div id="connectionStatus" class="result-display">
                点击按钮建立WebSocket连接...
            </div>
        </div>

        <div class="test-section">
            <h3>2. 订单推送测试</h3>
            <button onclick="createTestOrder()">创建测试订单</button>
            <button onclick="checkOrderData()">检查推送数据</button>
            
            <div id="pushStatus" class="result-display">
                点击按钮测试订单推送...
            </div>
        </div>

        <div class="test-section">
            <h3>3. 接收到的订单</h3>
            <div id="receivedOrders">
                <p>等待接收订单推送...</p>
            </div>
        </div>
    </div>

    <script>
        let ws = null;
        let receivedOrders = [];

        function log(message, containerId = 'pushStatus') {
            const container = document.getElementById(containerId);
            const timestamp = new Date().toLocaleTimeString();
            container.textContent += `[${timestamp}] ${message}\\n`;
            container.scrollTop = container.scrollHeight;
            console.log(message);
        }

        function connectWebSocket() {
            const statusDiv = document.getElementById('connectionStatus');
            
            if (ws && ws.readyState === WebSocket.OPEN) {
                statusDiv.textContent = '⚠️  WebSocket已经连接\\n';
                statusDiv.className = 'result-display status-warning';
                return;
            }

            try {
                ws = new WebSocket('ws://localhost:8080/ws/driver/1');
                
                ws.onopen = function() {
                    statusDiv.textContent = '✅ WebSocket连接成功\\n司机ID: 1\\n等待订单推送...\\n';
                    statusDiv.className = 'result-display status-good';
                    log('WebSocket连接建立成功', 'connectionStatus');
                };
                
                ws.onmessage = function(event) {
                    log('📨 收到推送消息', 'connectionStatus');
                    handleOrderPush(event.data);
                };
                
                ws.onerror = function(error) {
                    statusDiv.textContent += `❌ WebSocket错误: ${error}\\n`;
                    statusDiv.className = 'result-display status-error';
                    log('WebSocket连接错误', 'connectionStatus');
                };
                
                ws.onclose = function() {
                    statusDiv.textContent += '🔌 WebSocket连接关闭\\n';
                    log('WebSocket连接关闭', 'connectionStatus');
                };
                
            } catch (error) {
                statusDiv.textContent = `❌ 连接失败: ${error.message}\\n`;
                statusDiv.className = 'result-display status-error';
            }
        }

        function disconnectWebSocket() {
            if (ws) {
                ws.close();
                ws = null;
                document.getElementById('connectionStatus').textContent += '🔌 手动断开连接\\n';
            }
        }

        function handleOrderPush(messageData) {
            try {
                const data = JSON.parse(messageData);
                log(`收到订单推送: ${JSON.stringify(data, null, 2)}`, 'pushStatus');
                
                // 检查数据完整性
                const requiredFields = ['orderId', 'orderNumber', 'pickupAddress', 'destinationAddress', 
                                      'pickupLatitude', 'pickupLongitude', 'destinationLatitude', 'destinationLongitude'];
                
                const missingFields = requiredFields.filter(field => !data[field]);
                
                if (missingFields.length > 0) {
                    log(`⚠️  推送数据缺少字段: ${missingFields.join(', ')}`, 'pushStatus');
                } else {
                    log('✅ 推送数据完整', 'pushStatus');
                }
                
                // 添加到接收订单列表
                receivedOrders.push({
                    ...data,
                    receivedAt: new Date().toLocaleTimeString(),
                    countdown: 15
                });
                
                displayReceivedOrders();
                startCountdown(data.orderId);
                
            } catch (error) {
                log(`❌ 解析推送数据失败: ${error.message}`, 'pushStatus');
            }
        }

        function displayReceivedOrders() {
            const container = document.getElementById('receivedOrders');
            
            if (receivedOrders.length === 0) {
                container.innerHTML = '<p>等待接收订单推送...</p>';
                return;
            }
            
            container.innerHTML = receivedOrders.map(order => `
                <div class="order-card" id="order-${order.orderId}">
                    <div class="order-header">
                        <span class="order-number">订单 ${order.orderNumber}</span>
                        <span class="countdown" id="countdown-${order.orderId}">${order.countdown}s</span>
                    </div>
                    <div class="order-details">
                        <p><strong>上车地址:</strong> ${order.pickupAddress}</p>
                        <p><strong>目的地址:</strong> ${order.destinationAddress}</p>
                        <p><strong>上车坐标:</strong> ${order.pickupLatitude}, ${order.pickupLongitude}</p>
                        <p><strong>目的坐标:</strong> ${order.destinationLatitude}, ${order.destinationLongitude}</p>
                        <p><strong>距离:</strong> ${order.distance} km</p>
                        <p><strong>预估费用:</strong> ${order.estimatedFare}</p>
                        <p><strong>接收时间:</strong> ${order.receivedAt}</p>
                    </div>
                    <div class="order-actions">
                        <button class="success" onclick="acceptOrder('${order.orderId}')">接单</button>
                        <button class="danger" onclick="rejectOrder('${order.orderId}')">拒单</button>
                    </div>
                </div>
            `).join('');
        }

        function startCountdown(orderId) {
            const order = receivedOrders.find(o => o.orderId === orderId);
            if (!order) return;
            
            const interval = setInterval(() => {
                order.countdown--;
                const countdownElement = document.getElementById(`countdown-${orderId}`);
                if (countdownElement) {
                    countdownElement.textContent = `${order.countdown}s`;
                }
                
                if (order.countdown <= 0) {
                    clearInterval(interval);
                    // 自动拒单
                    rejectOrder(orderId, '超时自动拒单');
                }
            }, 1000);
        }

        async function acceptOrder(orderId) {
            try {
                const response = await fetch(`/api/drivers/1/accept-order/${orderId}`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    log(`✅ 接单成功: ${orderId}`, 'pushStatus');
                    removeOrder(orderId);
                } else {
                    log(`❌ 接单失败: ${orderId}`, 'pushStatus');
                }
            } catch (error) {
                log(`❌ 接单异常: ${error.message}`, 'pushStatus');
            }
        }

        async function rejectOrder(orderId, reason = '司机拒单') {
            try {
                const response = await fetch(`/api/drivers/1/reject-order/${orderId}?reason=${encodeURIComponent(reason)}`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    log(`✅ 拒单成功: ${orderId} (${reason})`, 'pushStatus');
                    removeOrder(orderId);
                } else {
                    log(`❌ 拒单失败: ${orderId}`, 'pushStatus');
                }
            } catch (error) {
                log(`❌ 拒单异常: ${error.message}`, 'pushStatus');
            }
        }

        function removeOrder(orderId) {
            receivedOrders = receivedOrders.filter(order => order.orderId !== orderId);
            displayReceivedOrders();
        }

        async function createTestOrder() {
            try {
                const orderData = {
                    passengerId: 1,
                    pickupAddress: '修复测试订单 - 大连理工大学',
                    pickupLatitude: 39.044237,
                    pickupLongitude: 121.749849,
                    destinationAddress: '修复测试目的地 - 大连火车站',
                    destinationLatitude: 39.054237,
                    destinationLongitude: 121.759849
                };
                
                const response = await fetch('/api/orders/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(orderData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    log(`✅ 测试订单创建成功，ID: ${result.data}`, 'pushStatus');
                    log('等待订单推送...', 'pushStatus');
                } else {
                    log(`❌ 创建订单失败: ${response.status}`, 'pushStatus');
                }
            } catch (error) {
                log(`❌ 创建订单异常: ${error.message}`, 'pushStatus');
            }
        }

        async function checkOrderData() {
            if (receivedOrders.length === 0) {
                log('❌ 没有接收到订单数据', 'pushStatus');
                return;
            }
            
            const latestOrder = receivedOrders[receivedOrders.length - 1];
            log('最新订单数据检查:', 'pushStatus');
            log(`订单ID: ${latestOrder.orderId}`, 'pushStatus');
            log(`订单号: ${latestOrder.orderNumber}`, 'pushStatus');
            log(`上车地址: ${latestOrder.pickupAddress}`, 'pushStatus');
            log(`目的地址: ${latestOrder.destinationAddress}`, 'pushStatus');
            log(`上车坐标: ${latestOrder.pickupLatitude}, ${latestOrder.pickupLongitude}`, 'pushStatus');
            log(`目的坐标: ${latestOrder.destinationLatitude}, ${latestOrder.destinationLongitude}`, 'pushStatus');
            log(`距离: ${latestOrder.distance} km`, 'pushStatus');
            log(`预估费用: ${latestOrder.estimatedFare}`, 'pushStatus');
            
            // 检查数据完整性
            const requiredFields = ['orderId', 'orderNumber', 'pickupAddress', 'destinationAddress', 
                                  'pickupLatitude', 'pickupLongitude', 'destinationLatitude', 'destinationLongitude'];
            
            const missingFields = requiredFields.filter(field => !latestOrder[field]);
            
            if (missingFields.length === 0) {
                log('✅ 订单数据完整，可以正常显示', 'pushStatus');
            } else {
                log(`❌ 订单数据不完整，缺少: ${missingFields.join(', ')}`, 'pushStatus');
            }
        }

        // 页面加载时自动连接
        window.onload = function() {
            setTimeout(() => {
                connectWebSocket();
            }, 1000);
        };
    </script>
</body>
</html>