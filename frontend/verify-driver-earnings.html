<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¸æœºæ”¶å…¥ç»Ÿè®¡åŠŸèƒ½éªŒè¯</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
        }
        .test-item {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-title {
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }
        .test-controls {
            margin: 10px 0;
        }
        .test-controls input, .test-controls select, .test-controls button {
            margin: 5px;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .test-controls button {
            background: #409EFF;
            color: white;
            cursor: pointer;
        }
        .test-controls button:hover {
            background: #337ecc;
        }
        .result {
            background: #f9f9f9;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 10px;
        }
        .success { color: #67C23A; }
        .error { color: #F56C6C; }
        .warning { color: #E6A23C; }
        .stats-display {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-value {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .stat-label {
            font-size: 12px;
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>å¸æœºæ”¶å…¥ç»Ÿè®¡åŠŸèƒ½éªŒè¯</h1>
        <p>æ­¤é¡µé¢ç”¨äºéªŒè¯å¸æœºæ”¶å…¥ç»Ÿè®¡æŒ‰æœˆä»½æŸ¥è¯¢åŠŸèƒ½æ˜¯å¦æ­£å¸¸å·¥ä½œã€‚</p>

        <!-- åŸºç¡€é…ç½® -->
        <div class="test-item">
            <div class="test-title">1. åŸºç¡€é…ç½®</div>
            <div class="test-controls">
                <label>å¸æœºID: </label>
                <input type="number" id="driverId" value="1" min="1">
                <label>æŸ¥è¯¢æœˆä»½: </label>
                <input type="month" id="queryMonth" value="">
                <button onclick="updateConfig()">æ›´æ–°é…ç½®</button>
            </div>
            <div id="configResult" class="result"></div>
        </div>

        <!-- å¸æœºä¿¡æ¯éªŒè¯ -->
        <div class="test-item">
            <div class="test-title">2. å¸æœºä¿¡æ¯éªŒè¯</div>
            <div class="test-controls">
                <button onclick="testDriverInfo()">è·å–å¸æœºä¿¡æ¯</button>
            </div>
            <div id="driverInfoResult" class="result"></div>
        </div>

        <!-- æ”¶å…¥ç»Ÿè®¡APIæµ‹è¯• -->
        <div class="test-item">
            <div class="test-title">3. æ”¶å…¥ç»Ÿè®¡APIæµ‹è¯•</div>
            <div class="test-controls">
                <button onclick="testEarningsAPI()">æµ‹è¯•æ”¶å…¥ç»Ÿè®¡API</button>
                <button onclick="testEarningsChart()">æµ‹è¯•å›¾è¡¨æ•°æ®API</button>
            </div>
            <div class="stats-display" id="statsDisplay" style="display: none;">
                <div class="stat-card">
                    <div class="stat-value" id="totalEarnings">Â¥0.00</div>
                    <div class="stat-label">æ€»æ”¶å…¥</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalOrders">0</div>
                    <div class="stat-label">å®Œæˆè®¢å•</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="averageEarnings">Â¥0.00</div>
                    <div class="stat-label">å¹³å‡å•ä»·</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalDistance">0.0km</div>
                    <div class="stat-label">æ€»é‡Œç¨‹</div>
                </div>
            </div>
            <div id="earningsResult" class="result"></div>
        </div>

        <!-- æœˆä»½æŸ¥è¯¢æµ‹è¯• -->
        <div class="test-item">
            <div class="test-title">4. å¤šæœˆä»½å¯¹æ¯”æµ‹è¯•</div>
            <div class="test-controls">
                <button onclick="testMultipleMonths()">æµ‹è¯•è¿‘3ä¸ªæœˆæ•°æ®</button>
            </div>
            <div id="multiMonthResult" class="result"></div>
        </div>

        <!-- æ•°æ®å®Œæ•´æ€§æ£€æŸ¥ -->
        <div class="test-item">
            <div class="test-title">5. æ•°æ®å®Œæ•´æ€§æ£€æŸ¥</div>
            <div class="test-controls">
                <button onclick="checkDataIntegrity()">æ£€æŸ¥æ•°æ®å®Œæ•´æ€§</button>
            </div>
            <div id="integrityResult" class="result"></div>
        </div>

        <!-- æ€§èƒ½æµ‹è¯• -->
        <div class="test-item">
            <div class="test-title">6. æ€§èƒ½æµ‹è¯•</div>
            <div class="test-controls">
                <button onclick="performanceTest()">æ‰§è¡Œæ€§èƒ½æµ‹è¯•</button>
            </div>
            <div id="performanceResult" class="result"></div>
        </div>

        <!-- åŠŸèƒ½éªŒè¯æ€»ç»“ -->
        <div class="test-item">
            <div class="test-title">7. åŠŸèƒ½éªŒè¯æ€»ç»“</div>
            <div class="test-controls">
                <button onclick="runAllTests()">è¿è¡Œæ‰€æœ‰æµ‹è¯•</button>
            </div>
            <div id="summaryResult" class="result"></div>
        </div>
    </div>

    <script>
        // å…¨å±€é…ç½®
        let config = {
            driverId: 1,
            queryMonth: new Date().toISOString().slice(0, 7)
        };

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('queryMonth').value = config.queryMonth;
            updateConfig();
        });

        // æ›´æ–°é…ç½®
        function updateConfig() {
            config.driverId = document.getElementById('driverId').value;
            config.queryMonth = document.getElementById('queryMonth').value;
            
            const result = `é…ç½®å·²æ›´æ–°:
å¸æœºID: ${config.driverId}
æŸ¥è¯¢æœˆä»½: ${config.queryMonth}
å½“å‰æ—¶é—´: ${new Date().toLocaleString()}`;
            
            document.getElementById('configResult').textContent = result;
            document.getElementById('configResult').className = 'result success';
        }

        // æµ‹è¯•å¸æœºä¿¡æ¯
        async function testDriverInfo() {
            const resultDiv = document.getElementById('driverInfoResult');
            resultDiv.textContent = 'æ­£åœ¨è·å–å¸æœºä¿¡æ¯...';
            
            try {
                const response = await fetch(`/api/drivers/${config.driverId}`);
                const result = await response.json();
                
                resultDiv.textContent = JSON.stringify(result, null, 2);
                resultDiv.className = result.code === 200 ? 'result success' : 'result error';
                
                return result.code === 200;
            } catch (error) {
                resultDiv.textContent = `è¯·æ±‚å¤±è´¥: ${error.message}`;
                resultDiv.className = 'result error';
                return false;
            }
        }

        // æµ‹è¯•æ”¶å…¥ç»Ÿè®¡API
        async function testEarningsAPI() {
            const resultDiv = document.getElementById('earningsResult');
            resultDiv.textContent = 'æ­£åœ¨æŸ¥è¯¢æ”¶å…¥ç»Ÿè®¡...';
            
            try {
                const params = new URLSearchParams({
                    month: config.queryMonth,
                    page: '1',
                    size: '31'
                });
                
                const response = await fetch(`/api/drivers/${config.driverId}/earnings?${params}`);
                const result = await response.json();
                
                resultDiv.textContent = JSON.stringify(result, null, 2);
                
                if (result.code === 200 && result.data && result.data.summary) {
                    // æ›´æ–°ç»Ÿè®¡æ˜¾ç¤º
                    const summary = result.data.summary;
                    document.getElementById('totalEarnings').textContent = `Â¥${(summary.totalEarnings || 0).toFixed(2)}`;
                    document.getElementById('totalOrders').textContent = summary.totalOrders || 0;
                    document.getElementById('averageEarnings').textContent = `Â¥${(summary.averageEarnings || 0).toFixed(2)}`;
                    document.getElementById('totalDistance').textContent = `${(summary.totalDistance || 0).toFixed(1)}km`;
                    document.getElementById('statsDisplay').style.display = 'grid';
                    
                    resultDiv.className = 'result success';
                    return true;
                } else {
                    resultDiv.className = 'result error';
                    return false;
                }
            } catch (error) {
                resultDiv.textContent = `è¯·æ±‚å¤±è´¥: ${error.message}`;
                resultDiv.className = 'result error';
                return false;
            }
        }

        // æµ‹è¯•å›¾è¡¨æ•°æ®API
        async function testEarningsChart() {
            const resultDiv = document.getElementById('earningsResult');
            
            try {
                const params = new URLSearchParams({
                    month: config.queryMonth,
                    type: 'daily'
                });
                
                const response = await fetch(`/api/drivers/${config.driverId}/earnings/chart?${params}`);
                const result = await response.json();
                
                const chartResult = `å›¾è¡¨æ•°æ®APIæµ‹è¯•ç»“æœ:
${JSON.stringify(result, null, 2)}`;
                
                resultDiv.textContent += '\n\n' + chartResult;
                return result.code === 200;
            } catch (error) {
                resultDiv.textContent += `\n\nå›¾è¡¨æ•°æ®APIè¯·æ±‚å¤±è´¥: ${error.message}`;
                return false;
            }
        }

        // æµ‹è¯•å¤šä¸ªæœˆä»½
        async function testMultipleMonths() {
            const resultDiv = document.getElementById('multiMonthResult');
            resultDiv.textContent = 'æ­£åœ¨æµ‹è¯•å¤šæœˆä»½æŸ¥è¯¢...';
            
            const months = [];
            const now = new Date();
            for (let i = 0; i < 3; i++) {
                const month = new Date(now.getFullYear(), now.getMonth() - i, 1);
                months.push(month.toISOString().slice(0, 7));
            }
            
            const results = [];
            
            for (const month of months) {
                try {
                    const params = new URLSearchParams({
                        month: month,
                        page: '1',
                        size: '10'
                    });
                    
                    const response = await fetch(`/api/drivers/${config.driverId}/earnings?${params}`);
                    const result = await response.json();
                    
                    results.push({
                        month: month,
                        success: result.code === 200,
                        data: result.data?.summary || null,
                        error: result.message
                    });
                } catch (error) {
                    results.push({
                        month: month,
                        success: false,
                        error: error.message
                    });
                }
            }
            
            let output = 'å¤šæœˆä»½æŸ¥è¯¢æµ‹è¯•ç»“æœ:\n\n';
            results.forEach(result => {
                output += `${result.month}: `;
                if (result.success && result.data) {
                    output += `æˆåŠŸ - æ”¶å…¥: Â¥${(result.data.totalEarnings || 0).toFixed(2)}, è®¢å•: ${result.data.totalOrders || 0}\n`;
                } else {
                    output += `å¤±è´¥ - ${result.error || 'æœªçŸ¥é”™è¯¯'}\n`;
                }
            });
            
            resultDiv.textContent = output;
            resultDiv.className = 'result';
        }

        // æ£€æŸ¥æ•°æ®å®Œæ•´æ€§
        async function checkDataIntegrity() {
            const resultDiv = document.getElementById('integrityResult');
            resultDiv.textContent = 'æ­£åœ¨æ£€æŸ¥æ•°æ®å®Œæ•´æ€§...';
            
            const checks = [];
            
            // æ£€æŸ¥å¸æœºä¿¡æ¯
            try {
                const driverResponse = await fetch(`/api/drivers/${config.driverId}`);
                const driverResult = await driverResponse.json();
                checks.push({
                    name: 'å¸æœºä¿¡æ¯',
                    success: driverResult.code === 200,
                    message: driverResult.code === 200 ? 'å¸æœºä¿¡æ¯æ­£å¸¸' : driverResult.message
                });
            } catch (error) {
                checks.push({
                    name: 'å¸æœºä¿¡æ¯',
                    success: false,
                    message: error.message
                });
            }
            
            // æ£€æŸ¥è®¢å•æ•°æ®
            try {
                const ordersResponse = await fetch(`/api/drivers/${config.driverId}/orders?page=1&size=5`);
                const ordersResult = await ordersResponse.json();
                checks.push({
                    name: 'è®¢å•æ•°æ®',
                    success: ordersResult.code === 200,
                    message: ordersResult.code === 200 ? 
                        `æ‰¾åˆ° ${ordersResult.data?.length || 0} æ¡è®¢å•è®°å½•` : 
                        ordersResult.message
                });
            } catch (error) {
                checks.push({
                    name: 'è®¢å•æ•°æ®',
                    success: false,
                    message: error.message
                });
            }
            
            let output = 'æ•°æ®å®Œæ•´æ€§æ£€æŸ¥ç»“æœ:\n\n';
            checks.forEach(check => {
                output += `${check.name}: ${check.success ? 'âœ“' : 'âœ—'} ${check.message}\n`;
            });
            
            resultDiv.textContent = output;
            resultDiv.className = 'result';
        }

        // æ€§èƒ½æµ‹è¯•
        async function performanceTest() {
            const resultDiv = document.getElementById('performanceResult');
            resultDiv.textContent = 'æ­£åœ¨æ‰§è¡Œæ€§èƒ½æµ‹è¯•...';
            
            const tests = [];
            
            // æµ‹è¯•æ”¶å…¥ç»Ÿè®¡APIå“åº”æ—¶é—´
            const startTime = performance.now();
            try {
                const params = new URLSearchParams({
                    month: config.queryMonth,
                    page: '1',
                    size: '31'
                });
                
                const response = await fetch(`/api/drivers/${config.driverId}/earnings?${params}`);
                const result = await response.json();
                const endTime = performance.now();
                
                tests.push({
                    name: 'æ”¶å…¥ç»Ÿè®¡API',
                    time: (endTime - startTime).toFixed(2),
                    success: result.code === 200
                });
            } catch (error) {
                const endTime = performance.now();
                tests.push({
                    name: 'æ”¶å…¥ç»Ÿè®¡API',
                    time: (endTime - startTime).toFixed(2),
                    success: false,
                    error: error.message
                });
            }
            
            let output = 'æ€§èƒ½æµ‹è¯•ç»“æœ:\n\n';
            tests.forEach(test => {
                output += `${test.name}: ${test.time}ms ${test.success ? 'âœ“' : 'âœ—'}`;
                if (test.error) output += ` (${test.error})`;
                output += '\n';
            });
            
            resultDiv.textContent = output;
            resultDiv.className = 'result';
        }

        // è¿è¡Œæ‰€æœ‰æµ‹è¯•
        async function runAllTests() {
            const resultDiv = document.getElementById('summaryResult');
            resultDiv.textContent = 'æ­£åœ¨è¿è¡Œæ‰€æœ‰æµ‹è¯•...';
            
            const testResults = [];
            
            // ä¾æ¬¡è¿è¡Œæ‰€æœ‰æµ‹è¯•
            testResults.push({ name: 'å¸æœºä¿¡æ¯', success: await testDriverInfo() });
            testResults.push({ name: 'æ”¶å…¥ç»Ÿè®¡API', success: await testEarningsAPI() });
            
            await testMultipleMonths();
            await checkDataIntegrity();
            await performanceTest();
            
            // ç”Ÿæˆæ€»ç»“æŠ¥å‘Š
            const successCount = testResults.filter(r => r.success).length;
            const totalCount = testResults.length;
            
            let summary = `åŠŸèƒ½éªŒè¯æ€»ç»“æŠ¥å‘Š:
æµ‹è¯•æ—¶é—´: ${new Date().toLocaleString()}
å¸æœºID: ${config.driverId}
æŸ¥è¯¢æœˆä»½: ${config.queryMonth}

æ ¸å¿ƒåŠŸèƒ½æµ‹è¯•ç»“æœ:
`;
            
            testResults.forEach(result => {
                summary += `- ${result.name}: ${result.success ? 'âœ“ é€šè¿‡' : 'âœ— å¤±è´¥'}\n`;
            });
            
            summary += `\næ€»ä½“ç»“æœ: ${successCount}/${totalCount} é¡¹æµ‹è¯•é€šè¿‡`;
            
            if (successCount === totalCount) {
                summary += '\n\nğŸ‰ æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½æµ‹è¯•é€šè¿‡ï¼å¸æœºæ”¶å…¥ç»Ÿè®¡æŒ‰æœˆä»½æŸ¥è¯¢åŠŸèƒ½æ­£å¸¸å·¥ä½œã€‚';
                resultDiv.className = 'result success';
            } else {
                summary += '\n\nâš ï¸ éƒ¨åˆ†æµ‹è¯•å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç›¸å…³åŠŸèƒ½ã€‚';
                resultDiv.className = 'result warning';
            }
            
            resultDiv.textContent = summary;
        }
    </script>
</body>
</html>