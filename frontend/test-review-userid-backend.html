<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>评价系统用户ID后端测试</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/element-plus/dist/index.full.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css">
    <style>
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e4e7ed;
            border-radius: 4px;
        }
        .result-box {
            background-color: #f5f7fa;
            padding: 15px;
            border-radius: 4px;
            margin-top: 10px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .user-info {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
        }
        .success { color: #67c23a; }
        .error { color: #f56c6c; }
        .warning { color: #e6a23c; }
    </style>
</head>
<body>
    <div id="app">
        <div class="container">
            <h1>评价系统用户ID后端测试</h1>
            <p>测试修复后的评价创建和查询功能</p>
            
            <!-- 步骤1: 获取用户数据 -->
            <div class="test-section">
                <h3>步骤1: 获取用户数据</h3>
                <el-button type="primary" @click="loadUsers" :loading="loading.users">
                    获取用户数据
                </el-button>
                <div v-if="results.users" class="result-box">
                    {{ results.users }}
                </div>
                
                <div v-if="users.length > 0" style="margin-top: 15px;">
                    <h4>用户列表</h4>
                    <el-table :data="users.slice(0, 10)" style="width: 100%">
                        <el-table-column prop="id" label="用户ID" width="80" />
                        <el-table-column prop="username" label="用户名" width="120" />
                        <el-table-column prop="real_name" label="真实姓名" width="120" />
                        <el-table-column prop="userType" label="用户类型" width="100" />
                        <el-table-column prop="phone" label="手机号" width="120" />
                    </el-table>
                </div>
            </div>

            <!-- 步骤2: 创建测试评价 -->
            <div class="test-section" v-if="users.length > 0">
                <h3>步骤2: 创建测试评价</h3>
                <el-form :model="newReview" inline>
                    <el-form-item label="订单ID">
                        <el-input v-model="newReview.orderId" type="number" style="width: 100px;" />
                    </el-form-item>
                    <el-form-item label="评价者(用户ID)">
                        <el-select v-model="newReview.raterId" placeholder="选择评价者">
                            <el-option 
                                v-for="user in passengers" 
                                :key="user.id" 
                                :label="`${user.real_name || user.username} (ID: ${user.id})`" 
                                :value="user.id" 
                            />
                        </el-select>
                    </el-form-item>
                    <el-form-item label="被评价者(用户ID)">
                        <el-select v-model="newReview.ratedId" placeholder="选择被评价者">
                            <el-option 
                                v-for="user in drivers" 
                                :key="user.id" 
                                :label="`${user.real_name || user.username} (ID: ${user.id})`" 
                                :value="user.id" 
                            />
                        </el-select>
                    </el-form-item>
                    <el-form-item label="评分">
                        <el-rate v-model="newReview.rating" />
                    </el-form-item>
                </el-form>
                <el-form :model="newReview">
                    <el-form-item label="评价内容">
                        <el-input v-model="newReview.comment" type="textarea" />
                    </el-form-item>
                </el-form>
                <el-button type="success" @click="createReview" :loading="loading.create">
                    创建评价
                </el-button>
                <div v-if="results.create" class="result-box" :class="createSuccess ? 'success' : 'error'">
                    {{ results.create }}
                </div>
            </div>

            <!-- 步骤3: 测试评价查询 -->
            <div class="test-section">
                <h3>步骤3: 测试评价查询</h3>
                <el-button type="primary" @click="testQuery" :loading="loading.query">
                    查询所有评价
                </el-button>
                <div v-if="results.query" class="result-box" :class="querySuccess ? 'success' : 'error'">
                    {{ results.query }}
                </div>
            </div>

            <!-- 步骤4: 评价数据展示 -->
            <div class="test-section" v-if="reviews.length > 0">
                <h3>步骤4: 评价数据展示</h3>
                <el-table :data="reviews" style="width: 100%">
                    <el-table-column prop="id" label="ID" width="60" />
                    
                    <el-table-column label="评价者" width="180">
                        <template #default="scope">
                            <div class="user-info">
                                <el-tag size="small" :type="scope.row.reviewerName ? 'success' : 'danger'">
                                    ID: {{ scope.row.reviewerId }}
                                </el-tag>
                                <img 
                                    :src="getAvatarUrl(scope.row.reviewerAvatar)" 
                                    :alt="scope.row.reviewerName"
                                    class="user-avatar"
                                    @error="handleImageError"
                                />
                                <span :class="scope.row.reviewerName ? 'success' : 'error'">
                                    {{ scope.row.reviewerName || '❌ 未找到' }}
                                </span>
                            </div>
                        </template>
                    </el-table-column>
                    
                    <el-table-column label="被评价者" width="180">
                        <template #default="scope">
                            <div class="user-info">
                                <el-tag size="small" :type="scope.row.revieweeName ? 'success' : 'danger'">
                                    ID: {{ scope.row.revieweeId }}
                                </el-tag>
                                <img 
                                    :src="getAvatarUrl(scope.row.revieweeAvatar)" 
                                    :alt="scope.row.revieweeName"
                                    class="user-avatar"
                                    @error="handleImageError"
                                />
                                <span :class="scope.row.revieweeName ? 'success' : 'error'">
                                    {{ scope.row.revieweeName || '❌ 未找到' }}
                                </span>
                            </div>
                        </template>
                    </el-table-column>
                    
                    <el-table-column label="评分" width="120">
                        <template #default="scope">
                            <el-rate v-model="scope.row.rating" disabled show-score />
                        </template>
                    </el-table-column>
                    
                    <el-table-column prop="comment" label="评价内容" min-width="200" />
                    
                    <el-table-column label="创建时间" width="160">
                        <template #default="scope">
                            {{ formatTime(scope.row.createdAt) }}
                        </template>
                    </el-table-column>
                </el-table>
            </div>

            <!-- 步骤5: 测试结果总结 -->
            <div class="test-section" v-if="testSummary.total > 0">
                <h3>步骤5: 测试结果总结</h3>
                <el-row :gutter="20">
                    <el-col :span="6">
                        <el-card>
                            <div style="text-align: center;">
                                <div style="font-size: 20px; font-weight: bold; color: #409eff;">{{ testSummary.total }}</div>
                                <div style="color: #666; font-size: 12px;">总评价数</div>
                            </div>
                        </el-card>
                    </el-col>
                    <el-col :span="6">
                        <el-card>
                            <div style="text-align: center;">
                                <div style="font-size: 20px; font-weight: bold; color: #67c23a;">{{ testSummary.withNames }}</div>
                                <div style="color: #666; font-size: 12px;">有用户名</div>
                            </div>
                        </el-card>
                    </el-col>
                    <el-col :span="6">
                        <el-card>
                            <div style="text-align: center;">
                                <div style="font-size: 20px; font-weight: bold; color: #e6a23c;">{{ testSummary.created }}</div>
                                <div style="color: #666; font-size: 12px;">新创建</div>
                            </div>
                        </el-card>
                    </el-col>
                    <el-col :span="6">
                        <el-card>
                            <div style="text-align: center;">
                                <div style="font-size: 20px; font-weight: bold;" :style="{ color: getSuccessColor() }">
                                    {{ testSummary.successRate }}%
                                </div>
                                <div style="color: #666; font-size: 12px;">成功率</div>
                            </div>
                        </el-card>
                    </el-col>
                </el-row>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, reactive, computed, onMounted } = Vue;
        const { ElMessage } = ElementPlus;

        createApp({
            setup() {
                const loading = reactive({
                    users: false,
                    create: false,
                    query: false
                });

                const results = reactive({
                    users: '',
                    create: '',
                    query: ''
                });

                const users = ref([]);
                const reviews = ref([]);
                const createSuccess = ref(false);
                const querySuccess = ref(false);

                const newReview = reactive({
                    orderId: Math.floor(Math.random() * 1000) + 1,
                    raterId: null,
                    ratedId: null,
                    rating: 5,
                    comment: '这是一个测试评价，用于验证用户ID后端修复效果。'
                });

                const testSummary = reactive({
                    total: 0,
                    withNames: 0,
                    created: 0,
                    successRate: 0
                });

                const passengers = computed(() => users.value.filter(u => u.userType === 'PASSENGER'));
                const drivers = computed(() => users.value.filter(u => u.userType === 'DRIVER'));

                const loadUsers = async () => {
                    loading.users = true;
                    try {
                        const response = await fetch('/api/auth/users');
                        const data = await response.json();
                        
                        if (response.ok && (data.success === true || data.code === 200)) {
                            users.value = data.data || [];
                            
                            results.users = `✅ 成功获取用户数据\n总用户数: ${users.value.length}\n乘客数: ${passengers.value.length}\n司机数: ${drivers.value.length}`;
                            
                            // 自动选择第一个乘客和司机
                            if (passengers.value.length > 0) {
                                newReview.raterId = passengers.value[0].id;
                            }
                            if (drivers.value.length > 0) {
                                newReview.ratedId = drivers.value[0].id;
                            }
                            
                            ElMessage.success(`获取到 ${users.value.length} 个用户`);
                        } else {
                            results.users = `❌ 获取用户数据失败: ${data.message || '未知错误'}`;
                            ElMessage.error('获取用户数据失败');
                        }
                    } catch (error) {
                        results.users = `❌ 请求失败: ${error.message}`;
                        ElMessage.error('请求失败');
                    } finally {
                        loading.users = false;
                    }
                };

                const createReview = async () => {
                    if (!newReview.raterId || !newReview.ratedId) {
                        ElMessage.warning('请选择评价者和被评价者');
                        return;
                    }

                    loading.create = true;
                    try {
                        const reviewData = {
                            orderId: parseInt(newReview.orderId),
                            raterId: newReview.raterId,  // 这里传递的是user_id
                            ratedId: newReview.ratedId,  // 这里传递的是user_id
                            rating: newReview.rating,
                            comment: newReview.comment,
                            tags: '["测试", "用户ID修复"]'
                        };

                        console.log('创建评价数据:', reviewData);

                        const response = await fetch('/api/reviews', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(reviewData)
                        });

                        const data = await response.json();
                        console.log('创建评价响应:', data);

                        if (response.ok && (data.success === true || data.code === 200)) {
                            createSuccess.value = true;
                            testSummary.created++;
                            results.create = `✅ 评价创建成功\n评价ID: ${data.data?.id || '未知'}\n使用的用户ID:\n- 评价者: ${newReview.raterId}\n- 被评价者: ${newReview.ratedId}`;
                            
                            // 生成新的订单ID用于下次测试
                            newReview.orderId = Math.floor(Math.random() * 1000) + 1;
                            
                            ElMessage.success('评价创建成功');
                        } else {
                            createSuccess.value = false;
                            results.create = `❌ 评价创建失败: ${data.message || '未知错误'}`;
                            ElMessage.error('评价创建失败');
                        }
                    } catch (error) {
                        createSuccess.value = false;
                        results.create = `❌ 创建请求失败: ${error.message}`;
                        ElMessage.error('创建请求失败');
                    } finally {
                        loading.create = false;
                    }
                };

                const testQuery = async () => {
                    loading.query = true;
                    try {
                        const response = await fetch('/api/reviews/all');
                        const data = await response.json();
                        
                        console.log('查询评价响应:', data);
                        
                        if (response.ok && (data.success === true || data.code === 200)) {
                            if (data.data && Array.isArray(data.data)) {
                                reviews.value = data.data;
                                querySuccess.value = true;
                                
                                // 更新测试总结
                                testSummary.total = data.data.length;
                                testSummary.withNames = data.data.filter(r => 
                                    r.reviewerName && r.revieweeName && 
                                    r.reviewerName !== 'null' && r.revieweeName !== 'null'
                                ).length;
                                
                                if (testSummary.total > 0) {
                                    testSummary.successRate = Math.round((testSummary.withNames / testSummary.total) * 100);
                                }
                                
                                results.query = `✅ 查询评价成功\n总评价数: ${data.data.length}\n有用户名的: ${testSummary.withNames}\n成功率: ${testSummary.successRate}%\n\n${data.data.length > 0 ? '最新评价:\n' + JSON.stringify(data.data[0], null, 2) : ''}`;
                                
                                ElMessage.success(`查询到 ${data.data.length} 条评价`);
                            } else {
                                querySuccess.value = false;
                                results.query = `⚠️ 查询成功但数据格式异常: ${JSON.stringify(data.data)}`;
                                ElMessage.warning('数据格式异常');
                            }
                        } else {
                            querySuccess.value = false;
                            results.query = `❌ 查询失败: ${data.message || '未知错误'}`;
                            ElMessage.error('查询失败');
                        }
                    } catch (error) {
                        querySuccess.value = false;
                        results.query = `❌ 查询请求失败: ${error.message}`;
                        ElMessage.error('查询请求失败');
                    } finally {
                        loading.query = false;
                    }
                };

                const getSuccessColor = () => {
                    if (testSummary.successRate >= 90) return '#67c23a';
                    if (testSummary.successRate >= 70) return '#e6a23c';
                    return '#f56c6c';
                };

                const getAvatarUrl = (avatar) => {
                    if (!avatar || avatar === 'null' || avatar === 'undefined') {
                        return 'https://cube.elemecdn.com/3/7c/3ea6beec64369c2642b92c6726f1epng.png';
                    }
                    if (avatar.startsWith('http')) return avatar;
                    return `/api/files/avatar/${avatar}`;
                };

                const handleImageError = (event) => {
                    event.target.src = 'https://cube.elemecdn.com/3/7c/3ea6beec64369c2642b92c6726f1epng.png';
                };

                const formatTime = (time) => {
                    if (!time) return '-';
                    return new Date(time).toLocaleString();
                };

                onMounted(() => {
                    console.log('评价系统用户ID后端测试页面已加载');
                    // 自动加载用户数据
                    loadUsers();
                });

                return {
                    loading,
                    results,
                    users,
                    reviews,
                    createSuccess,
                    querySuccess,
                    newReview,
                    testSummary,
                    passengers,
                    drivers,
                    loadUsers,
                    createReview,
                    testQuery,
                    getSuccessColor,
                    getAvatarUrl,
                    handleImageError,
                    formatTime
                };
            }
        }).use(ElementPlus).mount('#app');
    </script>
</body>
</html>