<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>评价系统简单测试</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/element-plus/dist/index.full.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css">
    <style>
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: 20px;
        }
        .test-container {
            max-width: 800px;
            margin: 0 auto;
        }
        .result-box {
            background-color: #f5f7fa;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .success { color: #67c23a; }
        .error { color: #f56c6c; }
    </style>
</head>
<body>
    <div id="app">
        <div class="test-container">
            <h1>评价系统简单测试</h1>
            
            <el-card style="margin-bottom: 20px;">
                <h3>测试评价API</h3>
                <el-button type="primary" @click="testReviewAPI" :loading="loading">
                    测试 /api/reviews/all
                </el-button>
                
                <div v-if="result" class="result-box" :class="success ? 'success' : 'error'">
                    {{ result }}
                </div>
            </el-card>

            <el-card v-if="reviews.length > 0">
                <h3>评价数据 ({{ reviews.length }} 条)</h3>
                <el-table :data="reviews" style="width: 100%">
                    <el-table-column prop="id" label="ID" width="60" />
                    <el-table-column prop="rating" label="评分" width="80" />
                    <el-table-column prop="reviewerName" label="评价者" width="120" />
                    <el-table-column prop="revieweeName" label="被评价者" width="120" />
                    <el-table-column prop="comment" label="评价内容" min-width="200" />
                </el-table>
            </el-card>

            <el-card style="margin-top: 20px;">
                <h3>创建测试评价</h3>
                <p>如果没有评价数据，可以尝试创建一个测试评价</p>
                <el-form :model="newReview" inline>
                    <el-form-item label="订单ID">
                        <el-input v-model="newReview.orderId" type="number" style="width: 100px;" />
                    </el-form-item>
                    <el-form-item label="乘客ID">
                        <el-input v-model="newReview.passengerId" type="number" style="width: 100px;" />
                    </el-form-item>
                    <el-form-item label="司机ID">
                        <el-input v-model="newReview.driverId" type="number" style="width: 100px;" />
                    </el-form-item>
                    <el-form-item label="评分">
                        <el-rate v-model="newReview.rating" />
                    </el-form-item>
                </el-form>
                <el-form :model="newReview">
                    <el-form-item label="评价内容">
                        <el-input v-model="newReview.comment" type="textarea" />
                    </el-form-item>
                </el-form>
                <el-button type="success" @click="createReview" :loading="creating">
                    创建测试评价
                </el-button>
            </el-card>
        </div>
    </div>

    <script>
        const { createApp, ref, reactive, onMounted } = Vue;
        const { ElMessage } = ElementPlus;

        createApp({
            setup() {
                const loading = ref(false);
                const creating = ref(false);
                const result = ref('');
                const success = ref(false);
                const reviews = ref([]);

                const newReview = reactive({
                    orderId: 1,
                    passengerId: 1,
                    driverId: 1,
                    rating: 5,
                    comment: '测试评价内容'
                });

                const testReviewAPI = async () => {
                    loading.value = true;
                    try {
                        console.log('测试评价API...');
                        
                        const response = await fetch('/api/reviews/all');
                        const data = await response.json();
                        
                        console.log('API响应:', data);
                        
                        if (response.ok && (data.success === true || data.code === 200)) {
                            if (data.data && Array.isArray(data.data) && data.data.length > 0) {
                                reviews.value = data.data;
                                result.value = `✅ 成功获取 ${data.data.length} 条评价数据\n\n示例数据:\n${JSON.stringify(data.data[0], null, 2)}`;
                                success.value = true;
                                ElMessage.success('API测试成功');
                            } else {
                                result.value = `⚠️ API调用成功但没有数据\n响应: ${JSON.stringify(data, null, 2)}`;
                                success.value = false;
                                ElMessage.warning('没有评价数据');
                            }
                        } else {
                            result.value = `❌ API调用失败\n状态: ${response.status}\n响应: ${JSON.stringify(data, null, 2)}`;
                            success.value = false;
                            ElMessage.error('API调用失败');
                        }
                    } catch (error) {
                        console.error('API测试失败:', error);
                        result.value = `❌ 请求失败: ${error.message}`;
                        success.value = false;
                        ElMessage.error('请求失败');
                    } finally {
                        loading.value = false;
                    }
                };

                const createReview = async () => {
                    creating.value = true;
                    try {
                        const reviewData = {
                            orderId: parseInt(newReview.orderId),
                            passengerId: parseInt(newReview.passengerId),
                            driverId: parseInt(newReview.driverId),
                            rating: newReview.rating,
                            comment: newReview.comment,
                            tags: '["测试"]'
                        };

                        console.log('创建评价:', reviewData);

                        const response = await fetch('/api/reviews', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(reviewData)
                        });

                        const data = await response.json();
                        console.log('创建评价响应:', data);

                        if (response.ok && (data.success === true || data.code === 200)) {
                            ElMessage.success('评价创建成功');
                            // 重新获取评价列表
                            testReviewAPI();
                        } else {
                            ElMessage.error(`创建失败: ${data.message || '未知错误'}`);
                        }
                    } catch (error) {
                        console.error('创建评价失败:', error);
                        ElMessage.error(`创建失败: ${error.message}`);
                    } finally {
                        creating.value = false;
                    }
                };

                onMounted(() => {
                    console.log('评价系统简单测试页面已加载');
                });

                return {
                    loading,
                    creating,
                    result,
                    success,
                    reviews,
                    newReview,
                    testReviewAPI,
                    createReview
                };
            }
        }).use(ElementPlus).mount('#app');
    </script>
</body>
</html>