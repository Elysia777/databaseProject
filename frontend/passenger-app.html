<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÁΩëÁ∫¶ËΩ¶‰πòÂÆ¢Á´Ø</title>
    <script src="https://webapi.amap.com/maps?v=2.0&key=e78a59e4a55e6634055068f28955d282&plugin=AMap.PlaceSearch,AMap.Autocomplete,AMap.Driving,AMap.Geolocation"></script>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.6.1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@7.0.0/bundles/stomp.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: #f5f5f5;
            height: 100vh;
            overflow: hidden;
        }

        .app-container {
            display: flex;
            height: 100vh;
        }

        .map-container {
            flex: 1;
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .control-panel {
            width: 350px;
            background: white;
            box-shadow: -2px 0 10px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            z-index: 1000;
        }

        .header {
            background: linear-gradient(45deg, #FF6B6B, #4ECDC4);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .section {
            margin-bottom: 25px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #4ECDC4;
        }

        .section h3 {
            margin-bottom: 15px;
            color: #333;
            font-size: 16px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
            font-size: 14px;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-input:focus {
            outline: none;
            border-color: #4ECDC4;
        }

        .search-results {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: white;
            display: none;
        }

        .search-item {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }

        .search-item:hover {
            background: #f0f0f0;
        }

        .btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s;
            margin-bottom: 10px;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .info-box {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .info-item:last-child {
            margin-bottom: 0;
        }

        .price {
            font-size: 18px;
            font-weight: bold;
            color: #FF6B6B;
        }

        .status-indicator {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            color: white;
            text-align: center;
            margin-bottom: 10px;
        }

        .status-waiting {
            background: #ffc107;
            color: #212529;
        }

        .status-assigned {
            background: #17a2b8;
        }

        .status-pickup {
            background: #fd7e14;
        }

        .status-in-progress {
            background: #20c997;
        }

        .status-completed {
            background: #28a745;
        }

        .driver-info {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            display: none;
        }

        .driver-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #4ECDC4;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            margin-right: 15px;
        }

        .driver-details {
            flex: 1;
        }

        .driver-name {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .driver-car {
            color: #666;
            font-size: 12px;
        }

        .location-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: white;
            border: 2px solid #4ECDC4;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: #4ECDC4;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
        }

        .location-btn:hover {
            background: #4ECDC4;
            color: white;
        }

        .floating-panel {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            display: none;
            z-index: 1000;
        }

        .route-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .route-distance {
            font-size: 16px;
            font-weight: bold;
        }

        .route-time {
            color: #666;
        }

        @media (max-width: 768px) {
            .app-container {
                flex-direction: column;
            }
            
            .control-panel {
                width: 100%;
                height: 40%;
                order: 2;
            }
            
            .map-container {
                height: 60%;
                order: 1;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Âú∞ÂõæÂÆπÂô® -->
        <div class="map-container">
            <div id="map"></div>
            
            <!-- ÂÆö‰ΩçÊåâÈíÆ -->
            <div class="location-btn" onclick="locateMe()" title="ÂÆö‰ΩçÂà∞ÊàëÁöÑ‰ΩçÁΩÆ">
                üìç
            </div>

            <!-- ÊµÆÂä®Ë∑ØÁ∫ø‰ø°ÊÅØÈù¢Êùø -->
            <div class="floating-panel" id="routePanel">
                <div class="route-info">
                    <div>
                        <div class="route-distance" id="routeDistance">--</div>
                        <div class="route-time" id="routeTime">È¢ÑËÆ°Êó∂Èó¥: --</div>
                    </div>
                    <div class="price" id="estimatedPrice">¬• --</div>
                </div>
                <button class="btn btn-success" onclick="confirmOrder()">Á°ÆËÆ§‰∏ãÂçï</button>
            </div>
        </div>

        <!-- ÊéßÂà∂Èù¢Êùø -->
        <div class="control-panel">
            <div class="header">
                <h1>üöó ÁΩëÁ∫¶ËΩ¶</h1>
                <p>ÊÇ®ÁöÑ‰∏ìÂ±ûÂá∫Ë°å‰ºô‰º¥</p>
            </div>

            <div class="content">
                <!-- ‰πòÂÆ¢‰ø°ÊÅØ -->
                <div class="section">
                    <h3>üë§ ‰πòÂÆ¢‰ø°ÊÅØ</h3>
                    <div class="form-group">
                        <label>‰πòÂÆ¢ID:</label>
                        <input type="number" id="passengerId" value="1" class="form-input">
                    </div>
                </div>

                <!-- Ë°åÁ®ãËßÑÂàí -->
                <div class="section">
                    <h3>üìç Ë°åÁ®ãËßÑÂàí</h3>
                    <div class="form-group">
                        <label>Âá∫ÂèëÂú∞:</label>
                        <input type="text" id="startLocation" class="form-input" placeholder="ÁÇπÂáªÂú∞ÂõæÈÄâÊã©Âá∫ÂèëÂú∞ÊàñÂΩìÂâç‰ΩçÁΩÆ" readonly>
                    </div>
                    <div class="form-group">
                        <label>ÁõÆÁöÑÂú∞:</label>
                        <input type="text" id="endLocation" class="form-input" placeholder="ÊêúÁ¥¢ÁõÆÁöÑÂú∞">
                        <div class="search-results" id="searchResults"></div>
                    </div>
                    <button class="btn btn-primary" onclick="planRoute()">ËßÑÂàíË∑ØÁ∫ø</button>
                </div>

                <!-- ËÆ¢Âçï‰ø°ÊÅØ -->
                <div class="section" id="orderSection" style="display: none;">
                    <h3>üìã ËÆ¢Âçï‰ø°ÊÅØ</h3>
                    <div class="status-indicator" id="orderStatus">Á≠âÂæÖÊé•Âçï</div>
                    <div class="info-box">
                        <div class="info-item">
                            <span>Ë∑ùÁ¶ª:</span>
                            <span id="orderDistance">--</span>
                        </div>
                        <div class="info-item">
                            <span>È¢Ñ‰º∞Êó∂Èó¥:</span>
                            <span id="orderTime">--</span>
                        </div>
                        <div class="info-item">
                            <span>È¢Ñ‰º∞Ë¥πÁî®:</span>
                            <span class="price" id="orderPrice">¬• --</span>
                        </div>
                    </div>
                    <button class="btn btn-danger" onclick="cancelOrder()" id="cancelBtn">ÂèñÊ∂àËÆ¢Âçï</button>
                </div>

                <!-- Âè∏Êú∫‰ø°ÊÅØ -->
                <div class="driver-info" id="driverInfo">
                    <div style="display: flex; align-items: center;">
                        <div class="driver-avatar" id="driverAvatar">Âè∏</div>
                        <div class="driver-details">
                            <div class="driver-name" id="driverName">--</div>
                            <div class="driver-car" id="driverCar">--</div>
                        </div>
                    </div>
                    <div class="info-item" style="margin-top: 10px;">
                        <span>È¢ÑËÆ°Âà∞Ëææ:</span>
                        <span id="driverETA">--</span>
                    </div>
                </div>

                <!-- ÂÆûÊó∂Áä∂ÊÄÅ -->
                <div class="section" id="statusSection" style="display: none;">
                    <h3>üì± ÂÆûÊó∂Áä∂ÊÄÅ</h3>
                    <div id="statusMessages"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ÂÖ®Â±ÄÂèòÈáè
        let map;
        let geolocation;
        let placeSearch;
        let driving;
        let currentPosition = null;
        let startMarker = null;
        let endMarker = null;
        let driverMarker = null;
        let routePolyline = null;
        let currentOrder = null;
        let websocket = null;
        let stompClient = null;

        // APIÈÖçÁΩÆ
        const API_BASE_URL = 'http://localhost:8080';

        // ÂàùÂßãÂåñÂú∞Âõæ
        function initMap() {
            map = new AMap.Map('map', {
                zoom: 15,
                center: [116.397428, 39.90923], // Âåó‰∫¨Â§©ÂÆâÈó®
                mapStyle: 'amap://styles/normal'
            });

            // ÂàùÂßãÂåñÂÆö‰Ωç
            geolocation = new AMap.Geolocation({
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0,
                convert: true,
                showButton: false,
                showMarker: false,
                showCircle: false
            });

            // ÂàùÂßãÂåñÊêúÁ¥¢
            placeSearch = new AMap.PlaceSearch({
                pageSize: 10,
                pageIndex: 1,
                city: 'ÂÖ®ÂõΩ'
            });

            // ÂàùÂßãÂåñË∑ØÁ∫øËßÑÂàí
            driving = new AMap.Driving({
                map: map,
                showTraffic: true,
                hideMarkers: false
            });

            // Âú∞ÂõæÁÇπÂáª‰∫ã‰ª∂
            map.on('click', function(e) {
                setStartLocation(e.lnglat);
            });

            // Ëá™Âä®ÂÆö‰ΩçÂà∞ÂΩìÂâç‰ΩçÁΩÆ
            locateMe();
        }

        // ÂÆö‰ΩçÂà∞ÂΩìÂâç‰ΩçÁΩÆ
        function locateMe() {
            geolocation.getCurrentPosition(function(status, result) {
                if (status === 'complete') {
                    currentPosition = [result.position.lng, result.position.lat];
                    map.setCenter(currentPosition);
                    setStartLocation(new AMap.LngLat(result.position.lng, result.position.lat));
                    showMessage('‚úÖ ÂÆö‰ΩçÊàêÂäü');
                } else {
                    showMessage('‚ùå ÂÆö‰ΩçÂ§±Ë¥•: ' + result.message, true);
                }
            });
        }

        // ËÆæÁΩÆÂá∫ÂèëÂú∞
        function setStartLocation(lnglat) {
            if (startMarker) {
                map.remove(startMarker);
            }

            startMarker = new AMap.Marker({
                position: lnglat,
                icon: new AMap.Icon({
                    image: 'https://webapi.amap.com/theme/v1.3/markers/n/start.png',
                    size: new AMap.Size(25, 34),
                    imageSize: new AMap.Size(25, 34)
                }),
                title: 'Âá∫ÂèëÂú∞'
            });

            map.add(startMarker);

            // ÈÄÜÂú∞ÁêÜÁºñÁ†ÅËé∑ÂèñÂú∞ÂùÄ
            AMap.plugin('AMap.Geocoder', function() {
                const geocoder = new AMap.Geocoder();
                geocoder.getAddress(lnglat, function(status, result) {
                    if (status === 'complete' && result.regeocode) {
                        document.getElementById('startLocation').value = result.regeocode.formattedAddress;
                    }
                });
            });
        }

        // ÁõÆÁöÑÂú∞ÊêúÁ¥¢
        document.getElementById('endLocation').addEventListener('input', function(e) {
            const keyword = e.target.value;
            if (keyword.length > 1) {
                searchDestination(keyword);
            } else {
                hideSearchResults();
            }
        });

        function searchDestination(keyword) {
            placeSearch.search(keyword, function(status, result) {
                if (status === 'complete' && result.poiList.pois.length > 0) {
                    showSearchResults(result.poiList.pois);
                }
            });
        }

        function showSearchResults(pois) {
            const resultsDiv = document.getElementById('searchResults');
            resultsDiv.innerHTML = '';
            
            pois.slice(0, 5).forEach(poi => {
                const item = document.createElement('div');
                item.className = 'search-item';
                item.innerHTML = `
                    <div style="font-weight: bold;">${poi.name}</div>
                    <div style="font-size: 12px; color: #666;">${poi.address}</div>
                `;
                item.onclick = () => selectDestination(poi);
                resultsDiv.appendChild(item);
            });
            
            resultsDiv.style.display = 'block';
        }

        function hideSearchResults() {
            document.getElementById('searchResults').style.display = 'none';
        }

        function selectDestination(poi) {
            document.getElementById('endLocation').value = poi.name;
            hideSearchResults();
            
            if (endMarker) {
                map.remove(endMarker);
            }

            endMarker = new AMap.Marker({
                position: [poi.location.lng, poi.location.lat],
                icon: new AMap.Icon({
                    image: 'https://webapi.amap.com/theme/v1.3/markers/n/end.png',
                    size: new AMap.Size(25, 34),
                    imageSize: new AMap.Size(25, 34)
                }),
                title: 'ÁõÆÁöÑÂú∞'
            });

            map.add(endMarker);
            
            // Ëá™Âä®ËßÑÂàíË∑ØÁ∫ø
            if (startMarker) {
                planRoute();
            }
        }

        // ËßÑÂàíË∑ØÁ∫ø
        function planRoute() {
            if (!startMarker || !endMarker) {
                showMessage('‚ùå ËØ∑ÂÖàÈÄâÊã©Âá∫ÂèëÂú∞ÂíåÁõÆÁöÑÂú∞', true);
                return;
            }

            const startPos = startMarker.getPosition();
            const endPos = endMarker.getPosition();

            driving.search(startPos, endPos, function(status, result) {
                if (status === 'complete') {
                    const route = result.routes[0];
                    const distance = (route.distance / 1000).toFixed(1);
                    const time = Math.ceil(route.time / 60);
                    const price = calculatePrice(route.distance);

                    // ‰øùÂ≠òË∑ØÁ∫ø‰ø°ÊÅØ‰æõ‰∏ãÂçï‰ΩøÁî®
                    window.routeInfo = {
                        distance: route.distance,  // Á±≥
                        duration: route.time,      // Áßí
                        price: price
                    };

                    // ÊòæÁ§∫Ë∑ØÁ∫ø‰ø°ÊÅØ
                    document.getElementById('routeDistance').textContent = distance + ' ÂÖ¨Èáå';
                    document.getElementById('routeTime').textContent = `È¢ÑËÆ°Êó∂Èó¥: ${time} ÂàÜÈíü`;
                    document.getElementById('estimatedPrice').textContent = `¬• ${price}`;
                    document.getElementById('routePanel').style.display = 'block';

                    console.log('üó∫Ô∏è Ë∑ØÁ∫øËßÑÂàíÊàêÂäü:', window.routeInfo);

                    // Ë∞ÉÊï¥Âú∞ÂõæËßÜÈáé
                    map.setFitView([startMarker, endMarker]);
                } else {
                    showMessage('‚ùå Ë∑ØÁ∫øËßÑÂàíÂ§±Ë¥•', true);
                    window.routeInfo = null;
                }
            });
        }

        // ËÆ°ÁÆó‰ª∑Ê†º
        function calculatePrice(distance) {
            const baseFare = 10; // Ëµ∑Ê≠•‰ª∑
            const perKmFare = 2.5; // ÊØèÂÖ¨Èáå‰ª∑Ê†º
            const distanceKm = distance / 1000;
            return Math.ceil(baseFare + (distanceKm > 3 ? (distanceKm - 3) * perKmFare : 0));
        }

        // Á°ÆËÆ§‰∏ãÂçï
        async function confirmOrder() {
            if (!startMarker || !endMarker) {
                showMessage('‚ùå ËØ∑ÂÖàËßÑÂàíË∑ØÁ∫ø', true);
                return;
            }

            const passengerId = document.getElementById('passengerId').value;
            const startPos = startMarker.getPosition();
            const endPos = endMarker.getPosition();
            const startAddress = document.getElementById('startLocation').value;
            const endAddress = document.getElementById('endLocation').value;

            // Ëé∑ÂèñË∑ØÁ∫ø‰ø°ÊÅØÔºàÂ¶ÇÊûúÂ≠òÂú®Ôºâ
            let estimatedDistance = 0;
            let estimatedDuration = 0;
            let estimatedFare = 0;
            
            if (window.routeInfo) {
                estimatedDistance = parseFloat((window.routeInfo.distance / 1000).toFixed(2));
                estimatedDuration = Math.round(window.routeInfo.duration / 60);
                estimatedFare = parseFloat(document.getElementById('estimatedPrice').textContent.replace('¬• ', '').replace('--', '0'));
            }

            const orderData = {
                passengerId: parseInt(passengerId),
                pickupAddress: startAddress,
                pickupLatitude: startPos.lat,
                pickupLongitude: startPos.lng,
                destinationAddress: endAddress,
                destinationLatitude: endPos.lat,
                destinationLongitude: endPos.lng,
                estimatedDistance: estimatedDistance,
                estimatedDuration: estimatedDuration,
                estimatedFare: estimatedFare,
                orderType: 'REAL_TIME'
            };
            
            console.log('üöÄ ÂèëÈÄÅËÆ¢ÂçïÊï∞ÊçÆ:', orderData);

            try {
                const response = await fetch(`${API_BASE_URL}/api/orders/create`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(orderData)
                });

                const result = await response.json();

                if (response.ok && result.code === 200) {
                    currentOrder = result.data;
                    showOrderCreated();
                    connectWebSocket();
                    showMessage('‚úÖ ËÆ¢ÂçïÂàõÂª∫ÊàêÂäüÔºåÊ≠£Âú®‰∏∫ÊÇ®ÂØªÊâæÂè∏Êú∫...');
                } else {
                    showMessage('‚ùå ‰∏ãÂçïÂ§±Ë¥•: ' + (result.message || 'Êú™Áü•ÈîôËØØ'), true);
                }
            } catch (error) {
                showMessage('‚ùå ÁΩëÁªúÈîôËØØ: ' + error.message, true);
            }
        }

        // ÊòæÁ§∫ËÆ¢ÂçïÂ∑≤ÂàõÂª∫
        function showOrderCreated() {
            document.getElementById('routePanel').style.display = 'none';
            document.getElementById('orderSection').style.display = 'block';
            document.getElementById('statusSection').style.display = 'block';
            
            // Êõ¥Êñ∞ËÆ¢Âçï‰ø°ÊÅØ
            const distance = document.getElementById('routeDistance').textContent;
            const time = document.getElementById('routeTime').textContent;
            const price = document.getElementById('estimatedPrice').textContent;
            
            document.getElementById('orderDistance').textContent = distance;
            document.getElementById('orderTime').textContent = time;
            document.getElementById('orderPrice').textContent = price;
            
            updateOrderStatus('PENDING', 'Á≠âÂæÖÊé•Âçï');
        }

        // Êõ¥Êñ∞ËÆ¢ÂçïÁä∂ÊÄÅ
        function updateOrderStatus(status, text) {
            const statusEl = document.getElementById('orderStatus');
            statusEl.textContent = text;
            statusEl.className = 'status-indicator status-' + status.toLowerCase();
        }

        // ÂèñÊ∂àËÆ¢Âçï
        async function cancelOrder() {
            if (!currentOrder) return;

            try {
                const response = await fetch(`${API_BASE_URL}/api/orders/${currentOrder.id}/cancel`, {
                    method: 'POST'
                });

                const result = await response.json();

                if (response.ok) {
                    showMessage('‚úÖ ËÆ¢ÂçïÂ∑≤ÂèñÊ∂à');
                    resetOrder();
                } else {
                    showMessage('‚ùå ÂèñÊ∂àÂ§±Ë¥•: ' + (result.message || 'Êú™Áü•ÈîôËØØ'), true);
                }
            } catch (error) {
                showMessage('‚ùå ÁΩëÁªúÈîôËØØ: ' + error.message, true);
            }
        }

        // ÈáçÁΩÆËÆ¢Âçï
        function resetOrder() {
            currentOrder = null;
            document.getElementById('orderSection').style.display = 'none';
            document.getElementById('statusSection').style.display = 'none';
            document.getElementById('driverInfo').style.display = 'none';
            document.getElementById('routePanel').style.display = 'none';
            
            if (websocket) {
                websocket.disconnect();
                websocket = null;
            }
            
            // Ê∏ÖÈô§Âú∞ÂõæÊ†áËÆ∞
            if (routePolyline) {
                map.remove(routePolyline);
            }
            if (driverMarker) {
                map.remove(driverMarker);
            }
        }

        // WebSocketËøûÊé•
        function connectWebSocket() {
            try {
                const socket = new SockJS(`${API_BASE_URL}/ws`);
                stompClient = new StompJs.Client({
                    webSocketFactory: () => socket,
                    debug: () => {}
                });

                stompClient.onConnect = function(frame) {
                    console.log('WebSocketËøûÊé•ÊàêÂäü');
                    
                    // ËÆ¢ÈòÖ‰πòÂÆ¢Ê∂àÊÅØ
                    stompClient.subscribe(`/user/${currentOrder.passengerId}/queue/orders`, function(message) {
                        const data = JSON.parse(message.body);
                        handleOrderUpdate(data);
                    });
                };

                stompClient.onStompError = function(frame) {
                    console.error('WebSocketËøûÊé•Â§±Ë¥•:', frame);
                };

                stompClient.activate();
            } catch (error) {
                console.error('WebSocketËøûÊé•ÈîôËØØ:', error);
            }
        }

        // Â§ÑÁêÜËÆ¢ÂçïÊõ¥Êñ∞
        function handleOrderUpdate(data) {
            console.log('Êî∂Âà∞ËÆ¢ÂçïÊõ¥Êñ∞:', data);
            
            switch (data.type) {
                case 'ORDER_ASSIGNED':
                    handleOrderAssigned(data);
                    break;
                case 'DRIVER_LOCATION':
                    updateDriverLocation(data);
                    break;
                case 'ORDER_STATUS_CHANGE':
                    handleStatusChange(data);
                    break;
            }
        }

        // Â§ÑÁêÜËÆ¢ÂçïË¢´Êé•Âçï
        function handleOrderAssigned(data) {
            updateOrderStatus('ASSIGNED', 'Âè∏Êú∫Â∑≤Êé•Âçï');
            showDriverInfo(data.driver);
            showMessage('‚úÖ Âè∏Êú∫Â∑≤Êé•ÂçïÔºåÊ≠£Âú®ÂâçÂæÄÊé•ÊÇ®');
        }

        // ÊòæÁ§∫Âè∏Êú∫‰ø°ÊÅØ
        function showDriverInfo(driver) {
            document.getElementById('driverInfo').style.display = 'block';
            document.getElementById('driverName').textContent = driver.name || `Âè∏Êú∫${driver.id}`;
            document.getElementById('driverCar').textContent = driver.carModel || 'ËΩ¶ÁâåÂè∑: ‰∫¨A12345';
            document.getElementById('driverAvatar').textContent = (driver.name || 'Âè∏Êú∫').charAt(0);
            
            // Âú®Âú∞Âõæ‰∏äÊòæÁ§∫Âè∏Êú∫‰ΩçÁΩÆ
            if (driver.latitude && driver.longitude) {
                showDriverOnMap(driver.latitude, driver.longitude);
            }
        }

        // Âú®Âú∞Âõæ‰∏äÊòæÁ§∫Âè∏Êú∫
        function showDriverOnMap(lat, lng) {
            if (driverMarker) {
                map.remove(driverMarker);
            }

            driverMarker = new AMap.Marker({
                position: [lng, lat],
                icon: new AMap.Icon({
                    image: 'üöó',
                    size: new AMap.Size(30, 30)
                }),
                title: 'Âè∏Êú∫‰ΩçÁΩÆ'
            });

            map.add(driverMarker);
        }

        // Êõ¥Êñ∞Âè∏Êú∫‰ΩçÁΩÆ
        function updateDriverLocation(data) {
            if (driverMarker && data.latitude && data.longitude) {
                driverMarker.setPosition([data.longitude, data.latitude]);
                
                // ËÆ°ÁÆóÈ¢ÑËÆ°Âà∞ËææÊó∂Èó¥
                const startPos = startMarker.getPosition();
                const driverPos = [data.longitude, data.latitude];
                
                // ËøôÈáåÂèØ‰ª•Ë∞ÉÁî®Ë∑ØÁ∫øËßÑÂàíAPIËÆ°ÁÆóÂÆûÈôÖÂà∞ËææÊó∂Èó¥
                // ÁÆÄÂåñÂ§ÑÁêÜÔºå‰ΩøÁî®Áõ¥Á∫øË∑ùÁ¶ª‰º∞ÁÆó
                const distance = AMap.GeometryUtil.distance(startPos, driverPos);
                const eta = Math.ceil(distance / 500); // ÂÅáËÆæÂπ≥ÂùáÈÄüÂ∫¶500Á±≥/ÂàÜÈíü
                
                document.getElementById('driverETA').textContent = `${eta} ÂàÜÈíü`;
            }
        }

        // Â§ÑÁêÜÁä∂ÊÄÅÂèòÂåñ
        function handleStatusChange(data) {
            switch (data.status) {
                case 'PICKUP':
                    updateOrderStatus('PICKUP', 'Âè∏Êú∫Â∑≤Âà∞Ëææ');
                    showMessage('‚úÖ Âè∏Êú∫Â∑≤Âà∞ËææÔºåËØ∑‰∏äËΩ¶');
                    break;
                case 'IN_PROGRESS':
                    updateOrderStatus('IN_PROGRESS', 'Ë°åÁ®ã‰∏≠');
                    showMessage('‚úÖ Ë°åÁ®ãÂºÄÂßã');
                    break;
                case 'COMPLETED':
                    updateOrderStatus('COMPLETED', 'Ë°åÁ®ãÂÆåÊàê');
                    showMessage('‚úÖ Ë°åÁ®ãÂÆåÊàêÔºåËØ∑ÊîØ‰ªòË¥πÁî®');
                    showPayment(data.fare);
                    break;
            }
        }

        // ÊòæÁ§∫ÊîØ‰ªò‰ø°ÊÅØ
        function showPayment(fare) {
            const paymentHtml = `
                <div class="info-box">
                    <h4>üí∞ ÊîØ‰ªò‰ø°ÊÅØ</h4>
                    <div class="info-item">
                        <span>ÂÆûÈôÖË¥πÁî®:</span>
                        <span class="price">¬• ${fare}</span>
                    </div>
                    <button class="btn btn-success" onclick="confirmPayment(${fare})">Á°ÆËÆ§ÊîØ‰ªò</button>
                </div>
            `;
            
            document.getElementById('statusMessages').innerHTML = paymentHtml;
        }

        // Á°ÆËÆ§ÊîØ‰ªò
        function confirmPayment(fare) {
            showMessage(`‚úÖ ÊîØ‰ªòÊàêÂäüÔºÅË¥πÁî®: ¬•${fare}`);
            setTimeout(() => {
                resetOrder();
            }, 3000);
        }

        // ÊòæÁ§∫Ê∂àÊÅØ
        function showMessage(message, isError = false) {
            const statusDiv = document.getElementById('statusMessages');
            const messageEl = document.createElement('div');
            messageEl.style.cssText = `
                padding: 10px;
                margin-bottom: 10px;
                border-radius: 5px;
                background: ${isError ? '#f8d7da' : '#d4edda'};
                color: ${isError ? '#721c24' : '#155724'};
                border: 1px solid ${isError ? '#f5c6cb' : '#c3e6cb'};
            `;
            messageEl.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            
            statusDiv.appendChild(messageEl);
            statusDiv.scrollTop = statusDiv.scrollHeight;
        }

        // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÂàùÂßãÂåñ
        window.onload = function() {
            initMap();
        };
    </script>
</body>
</html>