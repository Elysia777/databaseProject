<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç½‘çº¦è½¦ä¹˜å®¢ç«¯</title>
    <script src="https://webapi.amap.com/maps?v=2.0&key=e78a59e4a55e6634055068f28955d282&plugin=AMap.PlaceSearch,AMap.Autocomplete,AMap.Driving,AMap.Geolocation"></script>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.6.1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@7.0.0/bundles/stomp.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: #f5f5f5;
            height: 100vh;
            overflow: hidden;
        }

        .app-container {
            display: flex;
            height: 100vh;
        }

        .map-container {
            flex: 1;
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .control-panel {
            width: 350px;
            background: white;
            box-shadow: -2px 0 10px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            z-index: 1000;
        }

        .header {
            background: linear-gradient(45deg, #FF6B6B, #4ECDC4);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .section {
            margin-bottom: 25px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #4ECDC4;
        }

        .section h3 {
            margin-bottom: 15px;
            color: #333;
            font-size: 16px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
            font-size: 14px;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-input:focus {
            outline: none;
            border-color: #4ECDC4;
        }

        .search-results {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: white;
            display: none;
        }

        .search-item {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }

        .search-item:hover {
            background: #f0f0f0;
        }

        .btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s;
            margin-bottom: 10px;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .info-box {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .info-item:last-child {
            margin-bottom: 0;
        }

        .price {
            font-size: 18px;
            font-weight: bold;
            color: #FF6B6B;
        }

        .status-indicator {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            color: white;
            text-align: center;
            margin-bottom: 10px;
        }

        .status-waiting {
            background: #ffc107;
            color: #212529;
        }

        .status-assigned {
            background: #17a2b8;
        }

        .status-pickup {
            background: #fd7e14;
        }

        .status-in-progress {
            background: #20c997;
        }

        .status-completed {
            background: #28a745;
        }

        .driver-info {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            display: none;
        }

        .driver-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #4ECDC4;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            margin-right: 15px;
        }

        .driver-details {
            flex: 1;
        }

        .driver-name {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .driver-car {
            color: #666;
            font-size: 12px;
        }

        .location-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: white;
            border: 2px solid #4ECDC4;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: #4ECDC4;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
        }

        .location-btn:hover {
            background: #4ECDC4;
            color: white;
        }

        .floating-panel {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            display: none;
            z-index: 1000;
        }

        .route-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .route-distance {
            font-size: 16px;
            font-weight: bold;
        }

        .route-time {
            color: #666;
        }

        @media (max-width: 768px) {
            .app-container {
                flex-direction: column;
            }
            
            .control-panel {
                width: 100%;
                height: 40%;
                order: 2;
            }
            
            .map-container {
                height: 60%;
                order: 1;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- åœ°å›¾å®¹å™¨ -->
        <div class="map-container">
            <div id="map"></div>
            
            <!-- å®šä½æŒ‰é’® -->
            <div class="location-btn" onclick="locateMe()" title="å®šä½åˆ°æˆ‘çš„ä½ç½®">
                ğŸ“
            </div>

            <!-- æµ®åŠ¨è·¯çº¿ä¿¡æ¯é¢æ¿ -->
            <div class="floating-panel" id="routePanel">
                <div class="route-info">
                    <div>
                        <div class="route-distance" id="routeDistance">--</div>
                        <div class="route-time" id="routeTime">é¢„è®¡æ—¶é—´: --</div>
                    </div>
                    <div class="price" id="estimatedPrice">Â¥ --</div>
                </div>
                <button class="btn btn-success" onclick="confirmOrder()">ç¡®è®¤ä¸‹å•</button>
            </div>
        </div>

        <!-- æ§åˆ¶é¢æ¿ -->
        <div class="control-panel">
            <div class="header">
                <h1>ğŸš— ç½‘çº¦è½¦</h1>
                <p>æ‚¨çš„ä¸“å±å‡ºè¡Œä¼™ä¼´</p>
            </div>

            <div class="content">
                <!-- ä¹˜å®¢ä¿¡æ¯ -->
                <div class="section">
                    <h3>ğŸ‘¤ ä¹˜å®¢ä¿¡æ¯</h3>
                    <div class="form-group">
                        <label>ä¹˜å®¢ID:</label>
                        <input type="number" id="passengerId" value="1" class="form-input">
                    </div>
                </div>

                <!-- è¡Œç¨‹è§„åˆ’ -->
                <div class="section">
                    <h3>ğŸ“ è¡Œç¨‹è§„åˆ’</h3>
                    <div class="form-group">
                        <label>å‡ºå‘åœ°:</label>
                        <input type="text" id="startLocation" class="form-input" placeholder="ç‚¹å‡»åœ°å›¾é€‰æ‹©å‡ºå‘åœ°æˆ–å½“å‰ä½ç½®" readonly>
                    </div>
                    <div class="form-group">
                        <label>ç›®çš„åœ°:</label>
                        <input type="text" id="endLocation" class="form-input" placeholder="æœç´¢ç›®çš„åœ°">
                        <div class="search-results" id="searchResults"></div>
                    </div>
                    <button class="btn btn-primary" onclick="planRoute()">è§„åˆ’è·¯çº¿</button>
                </div>

                <!-- è®¢å•ä¿¡æ¯ -->
                <div class="section" id="orderSection" style="display: none;">
                    <h3>ğŸ“‹ è®¢å•ä¿¡æ¯</h3>
                    <div class="status-indicator" id="orderStatus">ç­‰å¾…æ¥å•</div>
                    <div class="info-box">
                        <div class="info-item">
                            <span>è·ç¦»:</span>
                            <span id="orderDistance">--</span>
                        </div>
                        <div class="info-item">
                            <span>é¢„ä¼°æ—¶é—´:</span>
                            <span id="orderTime">--</span>
                        </div>
                        <div class="info-item">
                            <span>é¢„ä¼°è´¹ç”¨:</span>
                            <span class="price" id="orderPrice">Â¥ --</span>
                        </div>
                    </div>
                    <button class="btn btn-danger" onclick="cancelOrder()" id="cancelBtn">å–æ¶ˆè®¢å•</button>
                </div>

                <!-- å¸æœºä¿¡æ¯ -->
                <div class="driver-info" id="driverInfo">
                    <div style="display: flex; align-items: center;">
                        <div class="driver-avatar" id="driverAvatar">å¸</div>
                        <div class="driver-details">
                            <div class="driver-name" id="driverName">--</div>
                            <div class="driver-car" id="driverCar">--</div>
                        </div>
                    </div>
                    <div class="info-item" style="margin-top: 10px;">
                        <span>é¢„è®¡åˆ°è¾¾:</span>
                        <span id="driverETA">--</span>
                    </div>
                </div>

                <!-- å®æ—¶çŠ¶æ€ -->
                <div class="section" id="statusSection" style="display: none;">
                    <h3>ğŸ“± å®æ—¶çŠ¶æ€</h3>
                    <div id="statusMessages"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let map;
        let geolocation;
        let placeSearch;
        let driving;
        let currentPosition = null;
        let startMarker = null;
        let endMarker = null;
        let driverMarker = null;
        let routePolyline = null;
        let currentOrder = null;
        let websocket = null;
        let stompClient = null;

        // APIé…ç½®
        const API_BASE_URL = 'http://localhost:8080';

        // åˆå§‹åŒ–åœ°å›¾
        function initMap() {
            map = new AMap.Map('map', {
                zoom: 15,
                center: [116.397428, 39.90923], // åŒ—äº¬å¤©å®‰é—¨
                mapStyle: 'amap://styles/normal'
            });

            // åˆå§‹åŒ–å®šä½
            geolocation = new AMap.Geolocation({
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0,
                convert: true,
                showButton: false,
                showMarker: false,
                showCircle: false
            });

            // åˆå§‹åŒ–æœç´¢
            placeSearch = new AMap.PlaceSearch({
                pageSize: 10,
                pageIndex: 1,
                city: 'å…¨å›½'
            });

            // åˆå§‹åŒ–è·¯çº¿è§„åˆ’
            driving = new AMap.Driving({
                map: map,
                showTraffic: true,
                hideMarkers: false
            });

            // åœ°å›¾ç‚¹å‡»äº‹ä»¶
            map.on('click', function(e) {
                setStartLocation(e.lnglat);
            });

            // è‡ªåŠ¨å®šä½åˆ°å½“å‰ä½ç½®
            locateMe();
        }

        // å®šä½åˆ°å½“å‰ä½ç½®
        function locateMe() {
            geolocation.getCurrentPosition(function(status, result) {
                if (status === 'complete') {
                    currentPosition = [result.position.lng, result.position.lat];
                    map.setCenter(currentPosition);
                    setStartLocation(new AMap.LngLat(result.position.lng, result.position.lat));
                    showMessage('âœ… å®šä½æˆåŠŸ');
                } else {
                    showMessage('âŒ å®šä½å¤±è´¥: ' + result.message, true);
                }
            });
        }

        // è®¾ç½®å‡ºå‘åœ°
        function setStartLocation(lnglat) {
            if (startMarker) {
                map.remove(startMarker);
            }

            startMarker = new AMap.Marker({
                position: lnglat,
                icon: new AMap.Icon({
                    image: 'https://webapi.amap.com/theme/v1.3/markers/n/start.png',
                    size: new AMap.Size(25, 34),
                    imageSize: new AMap.Size(25, 34)
                }),
                title: 'å‡ºå‘åœ°'
            });

            map.add(startMarker);

            // é€†åœ°ç†ç¼–ç è·å–åœ°å€
            AMap.plugin('AMap.Geocoder', function() {
                const geocoder = new AMap.Geocoder();
                geocoder.getAddress(lnglat, function(status, result) {
                    if (status === 'complete' && result.regeocode) {
                        document.getElementById('startLocation').value = result.regeocode.formattedAddress;
                    }
                });
            });
        }

        // ç›®çš„åœ°æœç´¢
        document.getElementById('endLocation').addEventListener('input', function(e) {
            const keyword = e.target.value;
            if (keyword.length > 1) {
                searchDestination(keyword);
            } else {
                hideSearchResults();
            }
        });

        function searchDestination(keyword) {
            placeSearch.search(keyword, function(status, result) {
                if (status === 'complete' && result.poiList.pois.length > 0) {
                    showSearchResults(result.poiList.pois);
                }
            });
        }

        function showSearchResults(pois) {
            const resultsDiv = document.getElementById('searchResults');
            resultsDiv.innerHTML = '';
            
            pois.slice(0, 5).forEach(poi => {
                const item = document.createElement('div');
                item.className = 'search-item';
                item.innerHTML = `
                    <div style="font-weight: bold;">${poi.name}</div>
                    <div style="font-size: 12px; color: #666;">${poi.address}</div>
                `;
                item.onclick = () => selectDestination(poi);
                resultsDiv.appendChild(item);
            });
            
            resultsDiv.style.display = 'block';
        }

        function hideSearchResults() {
            document.getElementById('searchResults').style.display = 'none';
        }

        function selectDestination(poi) {
            document.getElementById('endLocation').value = poi.name;
            hideSearchResults();
            
            if (endMarker) {
                map.remove(endMarker);
            }

            endMarker = new AMap.Marker({
                position: [poi.location.lng, poi.location.lat],
                icon: new AMap.Icon({
                    image: 'https://webapi.amap.com/theme/v1.3/markers/n/end.png',
                    size: new AMap.Size(25, 34),
                    imageSize: new AMap.Size(25, 34)
                }),
                title: 'ç›®çš„åœ°'
            });

            map.add(endMarker);
            
            // è‡ªåŠ¨è§„åˆ’è·¯çº¿
            if (startMarker) {
                planRoute();
            }
        }

        // è§„åˆ’è·¯çº¿
        function planRoute() {
            if (!startMarker || !endMarker) {
                showMessage('âŒ è¯·å…ˆé€‰æ‹©å‡ºå‘åœ°å’Œç›®çš„åœ°', true);
                return;
            }

            const startPos = startMarker.getPosition();
            const endPos = endMarker.getPosition();

            driving.search(startPos, endPos, function(status, result) {
                if (status === 'complete') {
                    const route = result.routes[0];
                    const distance = (route.distance / 1000).toFixed(1);
                    const time = Math.ceil(route.time / 60);
                    const price = calculatePrice(route.distance);

                    // ä¿å­˜è·¯çº¿ä¿¡æ¯ä¾›ä¸‹å•ä½¿ç”¨
                    window.routeInfo = {
                        distance: route.distance,  // ç±³
                        duration: route.time,      // ç§’
                        price: price
                    };

                    // æ˜¾ç¤ºè·¯çº¿ä¿¡æ¯
                    document.getElementById('routeDistance').textContent = distance + ' å…¬é‡Œ';
                    document.getElementById('routeTime').textContent = `é¢„è®¡æ—¶é—´: ${time} åˆ†é’Ÿ`;
                    document.getElementById('estimatedPrice').textContent = `Â¥ ${price}`;
                    document.getElementById('routePanel').style.display = 'block';

                    console.log('ğŸ—ºï¸ è·¯çº¿è§„åˆ’æˆåŠŸ:', window.routeInfo);

                    // è°ƒæ•´åœ°å›¾è§†é‡
                    map.setFitView([startMarker, endMarker]);
                } else {
                    showMessage('âŒ è·¯çº¿è§„åˆ’å¤±è´¥', true);
                    window.routeInfo = null;
                }
            });
        }

        // è®¡ç®—ä»·æ ¼
        function calculatePrice(distance) {
            const baseFare = 10; // èµ·æ­¥ä»·
            const perKmFare = 2.5; // æ¯å…¬é‡Œä»·æ ¼
            const distanceKm = distance / 1000;
            return Math.ceil(baseFare + (distanceKm > 3 ? (distanceKm - 3) * perKmFare : 0));
        }

        // ç¡®è®¤ä¸‹å•
        async function confirmOrder() {
            if (!startMarker || !endMarker) {
                showMessage('âŒ è¯·å…ˆè§„åˆ’è·¯çº¿', true);
                return;
            }

            const passengerId = document.getElementById('passengerId').value;
            const startPos = startMarker.getPosition();
            const endPos = endMarker.getPosition();
            const startAddress = document.getElementById('startLocation').value;
            const endAddress = document.getElementById('endLocation').value;

            // è·å–è·¯çº¿ä¿¡æ¯ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            let estimatedDistance = 0;
            let estimatedDuration = 0;
            let estimatedFare = 0;
            
            if (window.routeInfo) {
                estimatedDistance = parseFloat((window.routeInfo.distance / 1000).toFixed(2));
                estimatedDuration = Math.round(window.routeInfo.duration / 60);
                estimatedFare = parseFloat(document.getElementById('estimatedPrice').textContent.replace('Â¥ ', '').replace('--', '0'));
            }

            const orderData = {
                passengerId: parseInt(passengerId),
                pickupAddress: startAddress,
                pickupLatitude: startPos.lat,
                pickupLongitude: startPos.lng,
                destinationAddress: endAddress,
                destinationLatitude: endPos.lat,
                destinationLongitude: endPos.lng,
                estimatedDistance: estimatedDistance,
                estimatedDuration: estimatedDuration,
                estimatedFare: estimatedFare,
                orderType: 'REAL_TIME'
            };
            
            console.log('ğŸš€ å‘é€è®¢å•æ•°æ®:', orderData);

            try {
                const response = await fetch(`${API_BASE_URL}/api/orders/create`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(orderData)
                });

                const result = await response.json();

                if (response.ok && result.code === 200) {
                    currentOrder = result.data;
                    showOrderCreated();
                    connectWebSocket();
                    showMessage('âœ… è®¢å•åˆ›å»ºæˆåŠŸï¼Œæ­£åœ¨ä¸ºæ‚¨å¯»æ‰¾å¸æœº...');
                } else {
                    showMessage('âŒ ä¸‹å•å¤±è´¥: ' + (result.message || 'æœªçŸ¥é”™è¯¯'), true);
                }
            } catch (error) {
                showMessage('âŒ ç½‘ç»œé”™è¯¯: ' + error.message, true);
            }
        }

        // æ˜¾ç¤ºè®¢å•å·²åˆ›å»º
        function showOrderCreated() {
            document.getElementById('routePanel').style.display = 'none';
            document.getElementById('orderSection').style.display = 'block';
            document.getElementById('statusSection').style.display = 'block';
            
            // æ›´æ–°è®¢å•ä¿¡æ¯
            const distance = document.getElementById('routeDistance').textContent;
            const time = document.getElementById('routeTime').textContent;
            const price = document.getElementById('estimatedPrice').textContent;
            
            document.getElementById('orderDistance').textContent = distance;
            document.getElementById('orderTime').textContent = time;
            document.getElementById('orderPrice').textContent = price;
            
            updateOrderStatus('PENDING', 'ç­‰å¾…æ¥å•');
        }

        // æ›´æ–°è®¢å•çŠ¶æ€
        function updateOrderStatus(status, text) {
            const statusEl = document.getElementById('orderStatus');
            statusEl.textContent = text;
            statusEl.className = 'status-indicator status-' + status.toLowerCase();
        }

        // å–æ¶ˆè®¢å•
        async function cancelOrder() {
            if (!currentOrder) return;

            try {
                const response = await fetch(`${API_BASE_URL}/api/orders/${currentOrder.id}/cancel`, {
                    method: 'POST'
                });

                const result = await response.json();

                if (response.ok) {
                    showMessage('âœ… è®¢å•å·²å–æ¶ˆ');
                    resetOrder();
                } else {
                    showMessage('âŒ å–æ¶ˆå¤±è´¥: ' + (result.message || 'æœªçŸ¥é”™è¯¯'), true);
                }
            } catch (error) {
                showMessage('âŒ ç½‘ç»œé”™è¯¯: ' + error.message, true);
            }
        }

        // é‡ç½®è®¢å•
        function resetOrder() {
            currentOrder = null;
            document.getElementById('orderSection').style.display = 'none';
            document.getElementById('statusSection').style.display = 'none';
            document.getElementById('driverInfo').style.display = 'none';
            document.getElementById('routePanel').style.display = 'none';
            
            if (websocket) {
                websocket.disconnect();
                websocket = null;
            }
            
            // æ¸…é™¤åœ°å›¾æ ‡è®°
            if (routePolyline) {
                map.remove(routePolyline);
            }
            if (driverMarker) {
                map.remove(driverMarker);
            }
        }

        // WebSocketè¿æ¥
        function connectWebSocket() {
            try {
                const socket = new SockJS(`${API_BASE_URL}/ws`);
                stompClient = new StompJs.Client({
                    webSocketFactory: () => socket,
                    debug: () => {}
                });

                stompClient.onConnect = function(frame) {
                    console.log('WebSocketè¿æ¥æˆåŠŸ');
                    
                    // è®¢é˜…ä¹˜å®¢æ¶ˆæ¯
                    stompClient.subscribe(`/user/${currentOrder.passengerId}/queue/orders`, function(message) {
                        const data = JSON.parse(message.body);
                        handleOrderUpdate(data);
                    });
                };

                stompClient.onStompError = function(frame) {
                    console.error('WebSocketè¿æ¥å¤±è´¥:', frame);
                };

                stompClient.activate();
            } catch (error) {
                console.error('WebSocketè¿æ¥é”™è¯¯:', error);
            }
        }

        // å¤„ç†è®¢å•æ›´æ–°
        function handleOrderUpdate(data) {
            console.log('æ”¶åˆ°è®¢å•æ›´æ–°:', data);
            
            switch (data.type) {
                case 'ORDER_ASSIGNED':
                    handleOrderAssigned(data);
                    break;
                case 'DRIVER_LOCATION':
                    updateDriverLocation(data);
                    break;
                case 'ORDER_STATUS_CHANGE':
                    handleStatusChange(data);
                    break;
            }
        }

        // å¤„ç†è®¢å•è¢«æ¥å•
        function handleOrderAssigned(data) {
            updateOrderStatus('ASSIGNED', 'å¸æœºå·²æ¥å•');
            showDriverInfo(data.driver);
            showMessage('âœ… å¸æœºå·²æ¥å•ï¼Œæ­£åœ¨å‰å¾€æ¥æ‚¨');
        }

        // æ˜¾ç¤ºå¸æœºä¿¡æ¯
        function showDriverInfo(driver) {
            document.getElementById('driverInfo').style.display = 'block';
            document.getElementById('driverName').textContent = driver.name || `å¸æœº${driver.id}`;
            document.getElementById('driverCar').textContent = driver.carModel || 'è½¦ç‰Œå·: äº¬A12345';
            document.getElementById('driverAvatar').textContent = (driver.name || 'å¸æœº').charAt(0);
            
            // åœ¨åœ°å›¾ä¸Šæ˜¾ç¤ºå¸æœºä½ç½®
            if (driver.latitude && driver.longitude) {
                showDriverOnMap(driver.latitude, driver.longitude);
            }
        }

        // åœ¨åœ°å›¾ä¸Šæ˜¾ç¤ºå¸æœº
        function showDriverOnMap(lat, lng) {
            if (driverMarker) {
                map.remove(driverMarker);
            }

            driverMarker = new AMap.Marker({
                position: [lng, lat],
                icon: new AMap.Icon({
                    image: 'ğŸš—',
                    size: new AMap.Size(30, 30)
                }),
                title: 'å¸æœºä½ç½®'
            });

            map.add(driverMarker);
        }

        // æ›´æ–°å¸æœºä½ç½®
        function updateDriverLocation(data) {
            if (driverMarker && data.latitude && data.longitude) {
                driverMarker.setPosition([data.longitude, data.latitude]);
                
                // è®¡ç®—é¢„è®¡åˆ°è¾¾æ—¶é—´
                const startPos = startMarker.getPosition();
                const driverPos = [data.longitude, data.latitude];
                
                // è¿™é‡Œå¯ä»¥è°ƒç”¨è·¯çº¿è§„åˆ’APIè®¡ç®—å®é™…åˆ°è¾¾æ—¶é—´
                // ç®€åŒ–å¤„ç†ï¼Œä½¿ç”¨ç›´çº¿è·ç¦»ä¼°ç®—
                const distance = AMap.GeometryUtil.distance(startPos, driverPos);
                const eta = Math.ceil(distance / 500); // å‡è®¾å¹³å‡é€Ÿåº¦500ç±³/åˆ†é’Ÿ
                
                document.getElementById('driverETA').textContent = `${eta} åˆ†é’Ÿ`;
            }
        }

        // å¤„ç†çŠ¶æ€å˜åŒ–
        function handleStatusChange(data) {
            switch (data.status) {
                case 'PICKUP':
                    updateOrderStatus('PICKUP', 'å¸æœºå·²åˆ°è¾¾');
                    showMessage('âœ… å¸æœºå·²åˆ°è¾¾ï¼Œè¯·ä¸Šè½¦');
                    break;
                case 'IN_PROGRESS':
                    updateOrderStatus('IN_PROGRESS', 'è¡Œç¨‹ä¸­');
                    showMessage('âœ… è¡Œç¨‹å¼€å§‹');
                    break;
                case 'COMPLETED':
                    updateOrderStatus('COMPLETED', 'è¡Œç¨‹å®Œæˆ');
                    showMessage('âœ… è¡Œç¨‹å®Œæˆï¼Œè¯·æ”¯ä»˜è´¹ç”¨');
                    showPayment(data.fare);
                    break;
            }
        }

        // æ˜¾ç¤ºæ”¯ä»˜ä¿¡æ¯
        function showPayment(fare) {
            const paymentHtml = `
                <div class="info-box">
                    <h4>ğŸ’° æ”¯ä»˜ä¿¡æ¯</h4>
                    <div class="info-item">
                        <span>å®é™…è´¹ç”¨:</span>
                        <span class="price">Â¥ ${fare}</span>
                    </div>
                    <button class="btn btn-success" onclick="confirmPayment(${fare})">ç¡®è®¤æ”¯ä»˜</button>
                </div>
            `;
            
            document.getElementById('statusMessages').innerHTML = paymentHtml;
        }

        // ç¡®è®¤æ”¯ä»˜
        function confirmPayment(fare) {
            showMessage(`âœ… æ”¯ä»˜æˆåŠŸï¼è´¹ç”¨: Â¥${fare}`);
            setTimeout(() => {
                resetOrder();
            }, 3000);
        }

        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(message, isError = false) {
            const statusDiv = document.getElementById('statusMessages');
            const messageEl = document.createElement('div');
            messageEl.style.cssText = `
                padding: 10px;
                margin-bottom: 10px;
                border-radius: 5px;
                background: ${isError ? '#f8d7da' : '#d4edda'};
                color: ${isError ? '#721c24' : '#155724'};
                border: 1px solid ${isError ? '#f5c6cb' : '#c3e6cb'};
            `;
            messageEl.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            
            statusDiv.appendChild(messageEl);
            statusDiv.scrollTop = statusDiv.scrollHeight;
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.onload = function() {
            initMap();
        };
    </script>
</body>
</html>