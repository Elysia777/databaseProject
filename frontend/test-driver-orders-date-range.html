<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¸æœºè®¢å•æ—¥æœŸèŒƒå›´æŸ¥è¯¢æµ‹è¯•</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/element-plus/dist/index.full.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-controls {
            margin: 10px 0;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        .api-result {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 10px;
        }
        .success { color: #67C23A; }
        .error { color: #F56C6C; }
        .warning { color: #E6A23C; }
        .orders-table {
            margin-top: 15px;
        }
        .route-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .route-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
        }
        .earnings-amount {
            color: #67C23A;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="container">
            <div class="header">
                <h1>å¸æœºè®¢å•æ—¥æœŸèŒƒå›´æŸ¥è¯¢æµ‹è¯•</h1>
                <div>
                    <el-input v-model="driverId" placeholder="å¸æœºID" style="width: 100px;"></el-input>
                </div>
            </div>

            <!-- åŸºç¡€æŸ¥è¯¢æµ‹è¯• -->
            <div class="test-section">
                <h3>1. åŸºç¡€è®¢å•æŸ¥è¯¢ï¼ˆæ— æ—¥æœŸèŒƒå›´ï¼‰</h3>
                <div class="test-controls">
                    <el-select v-model="status" placeholder="é€‰æ‹©çŠ¶æ€" clearable style="width: 120px;">
                        <el-option label="å…¨éƒ¨" value=""></el-option>
                        <el-option label="å·²å®Œæˆ" value="COMPLETED"></el-option>
                        <el-option label="å·²å–æ¶ˆ" value="CANCELLED"></el-option>
                        <el-option label="è¿›è¡Œä¸­" value="IN_PROGRESS"></el-option>
                    </el-select>
                    <el-button type="primary" @click="testBasicQuery" :loading="loading">æŸ¥è¯¢è®¢å•</el-button>
                </div>
                <div class="api-result" v-if="basicResult">{{ basicResult }}</div>
            </div>

            <!-- æ—¥æœŸèŒƒå›´æŸ¥è¯¢æµ‹è¯• -->
            <div class="test-section">
                <h3>2. æ—¥æœŸèŒƒå›´æŸ¥è¯¢æµ‹è¯•</h3>
                <div class="test-controls">
                    <el-date-picker
                        v-model="startDate"
                        type="date"
                        placeholder="å¼€å§‹æ—¥æœŸ"
                        value-format="YYYY-MM-DD"
                        style="width: 140px;">
                    </el-date-picker>
                    <el-date-picker
                        v-model="endDate"
                        type="date"
                        placeholder="ç»“æŸæ—¥æœŸ"
                        value-format="YYYY-MM-DD"
                        style="width: 140px;">
                    </el-date-picker>
                    <el-select v-model="dateRangeStatus" placeholder="çŠ¶æ€" clearable style="width: 120px;">
                        <el-option label="å…¨éƒ¨" value=""></el-option>
                        <el-option label="å·²å®Œæˆ" value="COMPLETED"></el-option>
                        <el-option label="å·²å–æ¶ˆ" value="CANCELLED"></el-option>
                    </el-select>
                    <el-button type="primary" @click="testDateRangeQuery" :loading="loading">æŒ‰æ—¥æœŸæŸ¥è¯¢</el-button>
                </div>
                <div class="api-result" v-if="dateRangeResult">{{ dateRangeResult }}</div>
            </div>

            <!-- æœˆä»½æŸ¥è¯¢æµ‹è¯• -->
            <div class="test-section">
                <h3>3. æœˆä»½æŸ¥è¯¢æµ‹è¯•</h3>
                <div class="test-controls">
                    <el-date-picker
                        v-model="selectedMonth"
                        type="month"
                        placeholder="é€‰æ‹©æœˆä»½"
                        format="YYYYå¹´MMæœˆ"
                        value-format="YYYY-MM"
                        style="width: 160px;">
                    </el-date-picker>
                    <el-button type="primary" @click="testMonthQuery" :loading="loading">æŒ‰æœˆä»½æŸ¥è¯¢</el-button>
                </div>
                <div class="api-result" v-if="monthResult">{{ monthResult }}</div>
            </div>

            <!-- è®¢å•åˆ—è¡¨æ˜¾ç¤º -->
            <div class="orders-table" v-if="ordersList.length > 0">
                <h3>æŸ¥è¯¢ç»“æœ ({{ ordersList.length }} æ¡è®°å½•)</h3>
                <el-table :data="ordersList" style="width: 100%" stripe>
                    <el-table-column prop="id" label="è®¢å•ID" width="80"></el-table-column>
                    <el-table-column prop="orderNumber" label="è®¢å•å·" width="120">
                        <template #default="{ row }">
                            #{{ row.orderNumber || row.id }}
                        </template>
                    </el-table-column>
                    <el-table-column prop="status" label="çŠ¶æ€" width="100">
                        <template #default="{ row }">
                            <el-tag :type="getStatusTagType(row.status)" size="small">
                                {{ getStatusText(row.status) }}
                            </el-tag>
                        </template>
                    </el-table-column>
                    <el-table-column label="è·¯çº¿" min-width="200">
                        <template #default="{ row }">
                            <div class="route-info">
                                <div class="route-item">
                                    ğŸŸ¢ {{ row.pickupAddress || 'èµ·ç‚¹åœ°å€' }}
                                </div>
                                <div class="route-item">
                                    ğŸ”´ {{ row.destinationAddress || 'ç»ˆç‚¹åœ°å€' }}
                                </div>
                            </div>
                        </template>
                    </el-table-column>
                    <el-table-column prop="estimatedFare" label="è´¹ç”¨" width="100" align="center">
                        <template #default="{ row }">
                            <span class="earnings-amount">
                                Â¥{{ (row.actualFare || row.totalFare || row.estimatedFare || 0).toFixed(2) }}
                            </span>
                        </template>
                    </el-table-column>
                    <el-table-column prop="createdAt" label="åˆ›å»ºæ—¶é—´" width="160">
                        <template #default="{ row }">
                            {{ formatDateTime(row.createdAt) }}
                        </template>
                    </el-table-column>
                    <el-table-column prop="completionTime" label="å®Œæˆæ—¶é—´" width="160">
                        <template #default="{ row }">
                            {{ formatDateTime(row.completionTime) }}
                        </template>
                    </el-table-column>
                </el-table>
            </div>

            <!-- APIå¯¹æ¯”æµ‹è¯• -->
            <div class="test-section">
                <h3>4. APIå¯¹æ¯”æµ‹è¯•</h3>
                <div class="test-controls">
                    <el-button @click="compareAPIs">å¯¹æ¯”æ–°æ—§API</el-button>
                </div>
                <div class="api-result" v-if="compareResult">{{ compareResult }}</div>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, onMounted } = Vue;
        
        createApp({
            setup() {
                const loading = ref(false);
                const driverId = ref('1');
                const status = ref('');
                const dateRangeStatus = ref('');
                const startDate = ref('');
                const endDate = ref('');
                const selectedMonth = ref(new Date().toISOString().slice(0, 7));
                
                const ordersList = ref([]);
                const basicResult = ref('');
                const dateRangeResult = ref('');
                const monthResult = ref('');
                const compareResult = ref('');
                
                // åŸºç¡€æŸ¥è¯¢æµ‹è¯•
                const testBasicQuery = async () => {
                    loading.value = true;
                    try {
                        const params = new URLSearchParams({
                            page: '1',
                            size: '20'
                        });
                        
                        if (status.value) {
                            params.append('status', status.value);
                        }
                        
                        console.log('åŸºç¡€æŸ¥è¯¢å‚æ•°:', params.toString());
                        
                        const response = await fetch(`/api/drivers/${driverId.value}/orders?${params}`);
                        const result = await response.json();
                        
                        basicResult.value = `åŸºç¡€æŸ¥è¯¢ç»“æœ:\n${JSON.stringify(result, null, 2)}`;
                        
                        if (result.code === 200) {
                            ordersList.value = result.data || [];
                            ElementPlus.ElMessage.success(`æŸ¥è¯¢æˆåŠŸï¼Œæ‰¾åˆ° ${ordersList.value.length} æ¡è®°å½•`);
                        } else {
                            ElementPlus.ElMessage.error(result.message || 'æŸ¥è¯¢å¤±è´¥');
                        }
                    } catch (error) {
                        basicResult.value = `è¯·æ±‚å¤±è´¥: ${error.message}`;
                        ElementPlus.ElMessage.error('ç½‘ç»œè¯·æ±‚å¤±è´¥');
                    } finally {
                        loading.value = false;
                    }
                };
                
                // æ—¥æœŸèŒƒå›´æŸ¥è¯¢æµ‹è¯•
                const testDateRangeQuery = async () => {
                    if (!startDate.value || !endDate.value) {
                        ElementPlus.ElMessage.warning('è¯·é€‰æ‹©å¼€å§‹å’Œç»“æŸæ—¥æœŸ');
                        return;
                    }
                    
                    loading.value = true;
                    try {
                        const params = new URLSearchParams({
                            page: '1',
                            size: '50',
                            startDate: startDate.value,
                            endDate: endDate.value
                        });
                        
                        if (dateRangeStatus.value) {
                            params.append('status', dateRangeStatus.value);
                        }
                        
                        console.log('æ—¥æœŸèŒƒå›´æŸ¥è¯¢å‚æ•°:', params.toString());
                        
                        const response = await fetch(`/api/drivers/${driverId.value}/orders?${params}`);
                        const result = await response.json();
                        
                        dateRangeResult.value = `æ—¥æœŸèŒƒå›´æŸ¥è¯¢ç»“æœ:\næŸ¥è¯¢èŒƒå›´: ${startDate.value} åˆ° ${endDate.value}\n${JSON.stringify(result, null, 2)}`;
                        
                        if (result.code === 200) {
                            ordersList.value = result.data || [];
                            ElementPlus.ElMessage.success(`æ—¥æœŸèŒƒå›´æŸ¥è¯¢æˆåŠŸï¼Œæ‰¾åˆ° ${ordersList.value.length} æ¡è®°å½•`);
                        } else {
                            ElementPlus.ElMessage.error(result.message || 'æŸ¥è¯¢å¤±è´¥');
                        }
                    } catch (error) {
                        dateRangeResult.value = `è¯·æ±‚å¤±è´¥: ${error.message}`;
                        ElementPlus.ElMessage.error('ç½‘ç»œè¯·æ±‚å¤±è´¥');
                    } finally {
                        loading.value = false;
                    }
                };
                
                // æœˆä»½æŸ¥è¯¢æµ‹è¯•
                const testMonthQuery = async () => {
                    if (!selectedMonth.value) {
                        ElementPlus.ElMessage.warning('è¯·é€‰æ‹©æœˆä»½');
                        return;
                    }
                    
                    loading.value = true;
                    try {
                        // è®¡ç®—æœˆä»½çš„å¼€å§‹å’Œç»“æŸæ—¥æœŸ
                        const startOfMonth = `${selectedMonth.value}-01`;
                        const endOfMonth = new Date(selectedMonth.value + '-01');
                        endOfMonth.setMonth(endOfMonth.getMonth() + 1);
                        endOfMonth.setDate(0);
                        const endOfMonthStr = endOfMonth.toISOString().slice(0, 10);
                        
                        const params = new URLSearchParams({
                            page: '1',
                            size: '100',
                            startDate: startOfMonth,
                            endDate: endOfMonthStr,
                            status: 'COMPLETED'
                        });
                        
                        console.log('æœˆä»½æŸ¥è¯¢å‚æ•°:', params.toString());
                        console.log('æŸ¥è¯¢æ—¥æœŸèŒƒå›´:', startOfMonth, 'åˆ°', endOfMonthStr);
                        
                        const response = await fetch(`/api/drivers/${driverId.value}/orders?${params}`);
                        const result = await response.json();
                        
                        monthResult.value = `æœˆä»½æŸ¥è¯¢ç»“æœ:\næŸ¥è¯¢æœˆä»½: ${selectedMonth.value}\næ—¥æœŸèŒƒå›´: ${startOfMonth} åˆ° ${endOfMonthStr}\n${JSON.stringify(result, null, 2)}`;
                        
                        if (result.code === 200) {
                            ordersList.value = result.data || [];
                            ElementPlus.ElMessage.success(`${selectedMonth.value} æœˆæŸ¥è¯¢æˆåŠŸï¼Œæ‰¾åˆ° ${ordersList.value.length} æ¡è®°å½•`);
                        } else {
                            ElementPlus.ElMessage.error(result.message || 'æŸ¥è¯¢å¤±è´¥');
                        }
                    } catch (error) {
                        monthResult.value = `è¯·æ±‚å¤±è´¥: ${error.message}`;
                        ElementPlus.ElMessage.error('ç½‘ç»œè¯·æ±‚å¤±è´¥');
                    } finally {
                        loading.value = false;
                    }
                };
                
                // APIå¯¹æ¯”æµ‹è¯•
                const compareAPIs = async () => {
                    loading.value = true;
                    try {
                        compareResult.value = 'æ­£åœ¨å¯¹æ¯”æ–°æ—§API...\n\n';
                        
                        // æµ‹è¯•1: åŸºç¡€æŸ¥è¯¢
                        const basicParams = new URLSearchParams({
                            page: '1',
                            size: '10'
                        });
                        
                        const basicResponse = await fetch(`/api/drivers/${driverId.value}/orders?${basicParams}`);
                        const basicData = await basicResponse.json();
                        
                        compareResult.value += `1. åŸºç¡€æŸ¥è¯¢æµ‹è¯•:\n`;
                        compareResult.value += `   çŠ¶æ€: ${basicData.code === 200 ? 'æˆåŠŸ' : 'å¤±è´¥'}\n`;
                        compareResult.value += `   è®°å½•æ•°: ${basicData.data?.length || 0}\n\n`;
                        
                        // æµ‹è¯•2: æ—¥æœŸèŒƒå›´æŸ¥è¯¢
                        const today = new Date();
                        const lastMonth = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                        const startOfLastMonth = lastMonth.toISOString().slice(0, 10);
                        const endOfLastMonth = new Date(today.getFullYear(), today.getMonth(), 0).toISOString().slice(0, 10);
                        
                        const dateParams = new URLSearchParams({
                            page: '1',
                            size: '10',
                            startDate: startOfLastMonth,
                            endDate: endOfLastMonth
                        });
                        
                        const dateResponse = await fetch(`/api/drivers/${driverId.value}/orders?${dateParams}`);
                        const dateData = await dateResponse.json();
                        
                        compareResult.value += `2. æ—¥æœŸèŒƒå›´æŸ¥è¯¢æµ‹è¯•:\n`;
                        compareResult.value += `   æŸ¥è¯¢èŒƒå›´: ${startOfLastMonth} åˆ° ${endOfLastMonth}\n`;
                        compareResult.value += `   çŠ¶æ€: ${dateData.code === 200 ? 'æˆåŠŸ' : 'å¤±è´¥'}\n`;
                        compareResult.value += `   è®°å½•æ•°: ${dateData.data?.length || 0}\n\n`;
                        
                        // æµ‹è¯•3: æ”¶å…¥ç»Ÿè®¡API
                        const earningsParams = new URLSearchParams({
                            month: selectedMonth.value,
                            page: '1',
                            size: '10'
                        });
                        
                        const earningsResponse = await fetch(`/api/drivers/${driverId.value}/earnings?${earningsParams}`);
                        const earningsData = await earningsResponse.json();
                        
                        compareResult.value += `3. æ”¶å…¥ç»Ÿè®¡APIæµ‹è¯•:\n`;
                        compareResult.value += `   æŸ¥è¯¢æœˆä»½: ${selectedMonth.value}\n`;
                        compareResult.value += `   çŠ¶æ€: ${earningsData.code === 200 ? 'æˆåŠŸ' : 'å¤±è´¥'}\n`;
                        compareResult.value += `   æ€»æ”¶å…¥: Â¥${earningsData.data?.summary?.totalEarnings || 0}\n`;
                        compareResult.value += `   è®¢å•æ•°: ${earningsData.data?.summary?.totalOrders || 0}\n\n`;
                        
                        compareResult.value += 'å¯¹æ¯”æµ‹è¯•å®Œæˆï¼';
                        
                    } catch (error) {
                        compareResult.value += `å¯¹æ¯”æµ‹è¯•å¤±è´¥: ${error.message}`;
                    } finally {
                        loading.value = false;
                    }
                };
                
                // è·å–çŠ¶æ€æ ‡ç­¾ç±»å‹
                const getStatusTagType = (status) => {
                    const statusMap = {
                        'COMPLETED': 'success',
                        'CANCELLED': 'danger',
                        'IN_PROGRESS': 'primary',
                        'ASSIGNED': 'warning',
                        'PICKUP': 'info',
                        'PENDING': 'warning',
                        'SCHEDULED': 'info'
                    };
                    return statusMap[status] || 'info';
                };
                
                // è·å–çŠ¶æ€æ–‡æœ¬
                const getStatusText = (status) => {
                    const statusMap = {
                        'SCHEDULED': 'å·²é¢„çº¦',
                        'PENDING': 'å¾…æ¥å•',
                        'ASSIGNED': 'å·²æ¥å•',
                        'PICKUP': 'å·²åˆ°è¾¾',
                        'IN_PROGRESS': 'è¿›è¡Œä¸­',
                        'COMPLETED': 'å·²å®Œæˆ',
                        'CANCELLED': 'å·²å–æ¶ˆ'
                    };
                    return statusMap[status] || status;
                };
                
                // æ ¼å¼åŒ–æ—¥æœŸæ—¶é—´
                const formatDateTime = (dateTime) => {
                    if (!dateTime) return '--';
                    return new Date(dateTime).toLocaleString('zh-CN', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                };
                
                onMounted(() => {
                    console.log('å¸æœºè®¢å•æ—¥æœŸèŒƒå›´æŸ¥è¯¢æµ‹è¯•é¡µé¢å·²åŠ è½½');
                    // è®¾ç½®é»˜è®¤çš„æ—¥æœŸèŒƒå›´ä¸ºä¸Šä¸ªæœˆ
                    const today = new Date();
                    const lastMonth = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                    startDate.value = lastMonth.toISOString().slice(0, 10);
                    const endOfLastMonth = new Date(today.getFullYear(), today.getMonth(), 0);
                    endDate.value = endOfLastMonth.toISOString().slice(0, 10);
                });
                
                return {
                    loading,
                    driverId,
                    status,
                    dateRangeStatus,
                    startDate,
                    endDate,
                    selectedMonth,
                    ordersList,
                    basicResult,
                    dateRangeResult,
                    monthResult,
                    compareResult,
                    testBasicQuery,
                    testDateRangeQuery,
                    testMonthQuery,
                    compareAPIs,
                    getStatusTagType,
                    getStatusText,
                    formatDateTime
                };
            }
        }).use(ElementPlus).mount('#app');
    </script>
</body>
</html>