<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>司机订单日期范围查询测试</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/element-plus/dist/index.full.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-controls {
            margin: 10px 0;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        .api-result {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 10px;
        }
        .success { color: #67C23A; }
        .error { color: #F56C6C; }
        .warning { color: #E6A23C; }
        .orders-table {
            margin-top: 15px;
        }
        .route-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .route-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
        }
        .earnings-amount {
            color: #67C23A;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="container">
            <div class="header">
                <h1>司机订单日期范围查询测试</h1>
                <div>
                    <el-input v-model="driverId" placeholder="司机ID" style="width: 100px;"></el-input>
                </div>
            </div>

            <!-- 基础查询测试 -->
            <div class="test-section">
                <h3>1. 基础订单查询（无日期范围）</h3>
                <div class="test-controls">
                    <el-select v-model="status" placeholder="选择状态" clearable style="width: 120px;">
                        <el-option label="全部" value=""></el-option>
                        <el-option label="已完成" value="COMPLETED"></el-option>
                        <el-option label="已取消" value="CANCELLED"></el-option>
                        <el-option label="进行中" value="IN_PROGRESS"></el-option>
                    </el-select>
                    <el-button type="primary" @click="testBasicQuery" :loading="loading">查询订单</el-button>
                </div>
                <div class="api-result" v-if="basicResult">{{ basicResult }}</div>
            </div>

            <!-- 日期范围查询测试 -->
            <div class="test-section">
                <h3>2. 日期范围查询测试</h3>
                <div class="test-controls">
                    <el-date-picker
                        v-model="startDate"
                        type="date"
                        placeholder="开始日期"
                        value-format="YYYY-MM-DD"
                        style="width: 140px;">
                    </el-date-picker>
                    <el-date-picker
                        v-model="endDate"
                        type="date"
                        placeholder="结束日期"
                        value-format="YYYY-MM-DD"
                        style="width: 140px;">
                    </el-date-picker>
                    <el-select v-model="dateRangeStatus" placeholder="状态" clearable style="width: 120px;">
                        <el-option label="全部" value=""></el-option>
                        <el-option label="已完成" value="COMPLETED"></el-option>
                        <el-option label="已取消" value="CANCELLED"></el-option>
                    </el-select>
                    <el-button type="primary" @click="testDateRangeQuery" :loading="loading">按日期查询</el-button>
                </div>
                <div class="api-result" v-if="dateRangeResult">{{ dateRangeResult }}</div>
            </div>

            <!-- 月份查询测试 -->
            <div class="test-section">
                <h3>3. 月份查询测试</h3>
                <div class="test-controls">
                    <el-date-picker
                        v-model="selectedMonth"
                        type="month"
                        placeholder="选择月份"
                        format="YYYY年MM月"
                        value-format="YYYY-MM"
                        style="width: 160px;">
                    </el-date-picker>
                    <el-button type="primary" @click="testMonthQuery" :loading="loading">按月份查询</el-button>
                </div>
                <div class="api-result" v-if="monthResult">{{ monthResult }}</div>
            </div>

            <!-- 订单列表显示 -->
            <div class="orders-table" v-if="ordersList.length > 0">
                <h3>查询结果 ({{ ordersList.length }} 条记录)</h3>
                <el-table :data="ordersList" style="width: 100%" stripe>
                    <el-table-column prop="id" label="订单ID" width="80"></el-table-column>
                    <el-table-column prop="orderNumber" label="订单号" width="120">
                        <template #default="{ row }">
                            #{{ row.orderNumber || row.id }}
                        </template>
                    </el-table-column>
                    <el-table-column prop="status" label="状态" width="100">
                        <template #default="{ row }">
                            <el-tag :type="getStatusTagType(row.status)" size="small">
                                {{ getStatusText(row.status) }}
                            </el-tag>
                        </template>
                    </el-table-column>
                    <el-table-column label="路线" min-width="200">
                        <template #default="{ row }">
                            <div class="route-info">
                                <div class="route-item">
                                    🟢 {{ row.pickupAddress || '起点地址' }}
                                </div>
                                <div class="route-item">
                                    🔴 {{ row.destinationAddress || '终点地址' }}
                                </div>
                            </div>
                        </template>
                    </el-table-column>
                    <el-table-column prop="estimatedFare" label="费用" width="100" align="center">
                        <template #default="{ row }">
                            <span class="earnings-amount">
                                ¥{{ (row.actualFare || row.totalFare || row.estimatedFare || 0).toFixed(2) }}
                            </span>
                        </template>
                    </el-table-column>
                    <el-table-column prop="createdAt" label="创建时间" width="160">
                        <template #default="{ row }">
                            {{ formatDateTime(row.createdAt) }}
                        </template>
                    </el-table-column>
                    <el-table-column prop="completionTime" label="完成时间" width="160">
                        <template #default="{ row }">
                            {{ formatDateTime(row.completionTime) }}
                        </template>
                    </el-table-column>
                </el-table>
            </div>

            <!-- API对比测试 -->
            <div class="test-section">
                <h3>4. API对比测试</h3>
                <div class="test-controls">
                    <el-button @click="compareAPIs">对比新旧API</el-button>
                </div>
                <div class="api-result" v-if="compareResult">{{ compareResult }}</div>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, onMounted } = Vue;
        
        createApp({
            setup() {
                const loading = ref(false);
                const driverId = ref('1');
                const status = ref('');
                const dateRangeStatus = ref('');
                const startDate = ref('');
                const endDate = ref('');
                const selectedMonth = ref(new Date().toISOString().slice(0, 7));
                
                const ordersList = ref([]);
                const basicResult = ref('');
                const dateRangeResult = ref('');
                const monthResult = ref('');
                const compareResult = ref('');
                
                // 基础查询测试
                const testBasicQuery = async () => {
                    loading.value = true;
                    try {
                        const params = new URLSearchParams({
                            page: '1',
                            size: '20'
                        });
                        
                        if (status.value) {
                            params.append('status', status.value);
                        }
                        
                        console.log('基础查询参数:', params.toString());
                        
                        const response = await fetch(`/api/drivers/${driverId.value}/orders?${params}`);
                        const result = await response.json();
                        
                        basicResult.value = `基础查询结果:\n${JSON.stringify(result, null, 2)}`;
                        
                        if (result.code === 200) {
                            ordersList.value = result.data || [];
                            ElementPlus.ElMessage.success(`查询成功，找到 ${ordersList.value.length} 条记录`);
                        } else {
                            ElementPlus.ElMessage.error(result.message || '查询失败');
                        }
                    } catch (error) {
                        basicResult.value = `请求失败: ${error.message}`;
                        ElementPlus.ElMessage.error('网络请求失败');
                    } finally {
                        loading.value = false;
                    }
                };
                
                // 日期范围查询测试
                const testDateRangeQuery = async () => {
                    if (!startDate.value || !endDate.value) {
                        ElementPlus.ElMessage.warning('请选择开始和结束日期');
                        return;
                    }
                    
                    loading.value = true;
                    try {
                        const params = new URLSearchParams({
                            page: '1',
                            size: '50',
                            startDate: startDate.value,
                            endDate: endDate.value
                        });
                        
                        if (dateRangeStatus.value) {
                            params.append('status', dateRangeStatus.value);
                        }
                        
                        console.log('日期范围查询参数:', params.toString());
                        
                        const response = await fetch(`/api/drivers/${driverId.value}/orders?${params}`);
                        const result = await response.json();
                        
                        dateRangeResult.value = `日期范围查询结果:\n查询范围: ${startDate.value} 到 ${endDate.value}\n${JSON.stringify(result, null, 2)}`;
                        
                        if (result.code === 200) {
                            ordersList.value = result.data || [];
                            ElementPlus.ElMessage.success(`日期范围查询成功，找到 ${ordersList.value.length} 条记录`);
                        } else {
                            ElementPlus.ElMessage.error(result.message || '查询失败');
                        }
                    } catch (error) {
                        dateRangeResult.value = `请求失败: ${error.message}`;
                        ElementPlus.ElMessage.error('网络请求失败');
                    } finally {
                        loading.value = false;
                    }
                };
                
                // 月份查询测试
                const testMonthQuery = async () => {
                    if (!selectedMonth.value) {
                        ElementPlus.ElMessage.warning('请选择月份');
                        return;
                    }
                    
                    loading.value = true;
                    try {
                        // 计算月份的开始和结束日期
                        const startOfMonth = `${selectedMonth.value}-01`;
                        const endOfMonth = new Date(selectedMonth.value + '-01');
                        endOfMonth.setMonth(endOfMonth.getMonth() + 1);
                        endOfMonth.setDate(0);
                        const endOfMonthStr = endOfMonth.toISOString().slice(0, 10);
                        
                        const params = new URLSearchParams({
                            page: '1',
                            size: '100',
                            startDate: startOfMonth,
                            endDate: endOfMonthStr,
                            status: 'COMPLETED'
                        });
                        
                        console.log('月份查询参数:', params.toString());
                        console.log('查询日期范围:', startOfMonth, '到', endOfMonthStr);
                        
                        const response = await fetch(`/api/drivers/${driverId.value}/orders?${params}`);
                        const result = await response.json();
                        
                        monthResult.value = `月份查询结果:\n查询月份: ${selectedMonth.value}\n日期范围: ${startOfMonth} 到 ${endOfMonthStr}\n${JSON.stringify(result, null, 2)}`;
                        
                        if (result.code === 200) {
                            ordersList.value = result.data || [];
                            ElementPlus.ElMessage.success(`${selectedMonth.value} 月查询成功，找到 ${ordersList.value.length} 条记录`);
                        } else {
                            ElementPlus.ElMessage.error(result.message || '查询失败');
                        }
                    } catch (error) {
                        monthResult.value = `请求失败: ${error.message}`;
                        ElementPlus.ElMessage.error('网络请求失败');
                    } finally {
                        loading.value = false;
                    }
                };
                
                // API对比测试
                const compareAPIs = async () => {
                    loading.value = true;
                    try {
                        compareResult.value = '正在对比新旧API...\n\n';
                        
                        // 测试1: 基础查询
                        const basicParams = new URLSearchParams({
                            page: '1',
                            size: '10'
                        });
                        
                        const basicResponse = await fetch(`/api/drivers/${driverId.value}/orders?${basicParams}`);
                        const basicData = await basicResponse.json();
                        
                        compareResult.value += `1. 基础查询测试:\n`;
                        compareResult.value += `   状态: ${basicData.code === 200 ? '成功' : '失败'}\n`;
                        compareResult.value += `   记录数: ${basicData.data?.length || 0}\n\n`;
                        
                        // 测试2: 日期范围查询
                        const today = new Date();
                        const lastMonth = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                        const startOfLastMonth = lastMonth.toISOString().slice(0, 10);
                        const endOfLastMonth = new Date(today.getFullYear(), today.getMonth(), 0).toISOString().slice(0, 10);
                        
                        const dateParams = new URLSearchParams({
                            page: '1',
                            size: '10',
                            startDate: startOfLastMonth,
                            endDate: endOfLastMonth
                        });
                        
                        const dateResponse = await fetch(`/api/drivers/${driverId.value}/orders?${dateParams}`);
                        const dateData = await dateResponse.json();
                        
                        compareResult.value += `2. 日期范围查询测试:\n`;
                        compareResult.value += `   查询范围: ${startOfLastMonth} 到 ${endOfLastMonth}\n`;
                        compareResult.value += `   状态: ${dateData.code === 200 ? '成功' : '失败'}\n`;
                        compareResult.value += `   记录数: ${dateData.data?.length || 0}\n\n`;
                        
                        // 测试3: 收入统计API
                        const earningsParams = new URLSearchParams({
                            month: selectedMonth.value,
                            page: '1',
                            size: '10'
                        });
                        
                        const earningsResponse = await fetch(`/api/drivers/${driverId.value}/earnings?${earningsParams}`);
                        const earningsData = await earningsResponse.json();
                        
                        compareResult.value += `3. 收入统计API测试:\n`;
                        compareResult.value += `   查询月份: ${selectedMonth.value}\n`;
                        compareResult.value += `   状态: ${earningsData.code === 200 ? '成功' : '失败'}\n`;
                        compareResult.value += `   总收入: ¥${earningsData.data?.summary?.totalEarnings || 0}\n`;
                        compareResult.value += `   订单数: ${earningsData.data?.summary?.totalOrders || 0}\n\n`;
                        
                        compareResult.value += '对比测试完成！';
                        
                    } catch (error) {
                        compareResult.value += `对比测试失败: ${error.message}`;
                    } finally {
                        loading.value = false;
                    }
                };
                
                // 获取状态标签类型
                const getStatusTagType = (status) => {
                    const statusMap = {
                        'COMPLETED': 'success',
                        'CANCELLED': 'danger',
                        'IN_PROGRESS': 'primary',
                        'ASSIGNED': 'warning',
                        'PICKUP': 'info',
                        'PENDING': 'warning',
                        'SCHEDULED': 'info'
                    };
                    return statusMap[status] || 'info';
                };
                
                // 获取状态文本
                const getStatusText = (status) => {
                    const statusMap = {
                        'SCHEDULED': '已预约',
                        'PENDING': '待接单',
                        'ASSIGNED': '已接单',
                        'PICKUP': '已到达',
                        'IN_PROGRESS': '进行中',
                        'COMPLETED': '已完成',
                        'CANCELLED': '已取消'
                    };
                    return statusMap[status] || status;
                };
                
                // 格式化日期时间
                const formatDateTime = (dateTime) => {
                    if (!dateTime) return '--';
                    return new Date(dateTime).toLocaleString('zh-CN', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                };
                
                onMounted(() => {
                    console.log('司机订单日期范围查询测试页面已加载');
                    // 设置默认的日期范围为上个月
                    const today = new Date();
                    const lastMonth = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                    startDate.value = lastMonth.toISOString().slice(0, 10);
                    const endOfLastMonth = new Date(today.getFullYear(), today.getMonth(), 0);
                    endDate.value = endOfLastMonth.toISOString().slice(0, 10);
                });
                
                return {
                    loading,
                    driverId,
                    status,
                    dateRangeStatus,
                    startDate,
                    endDate,
                    selectedMonth,
                    ordersList,
                    basicResult,
                    dateRangeResult,
                    monthResult,
                    compareResult,
                    testBasicQuery,
                    testDateRangeQuery,
                    testMonthQuery,
                    compareAPIs,
                    getStatusTagType,
                    getStatusText,
                    formatDateTime
                };
            }
        }).use(ElementPlus).mount('#app');
    </script>
</body>
</html>