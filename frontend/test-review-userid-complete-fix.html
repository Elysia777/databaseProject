<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>评价系统用户ID完整修复测试</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/element-plus/dist/index.full.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css">
    <style>
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #333;
            border-bottom: 2px solid #409EFF;
            padding-bottom: 8px;
        }
        .test-item {
            margin-bottom: 15px;
            padding: 15px;
            border: 1px solid #e4e7ed;
            border-radius: 6px;
            background: #fafafa;
        }
        .test-result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
        }
        .success {
            background: #f0f9ff;
            border: 1px solid #67c23a;
            color: #67c23a;
        }
        .error {
            background: #fef0f0;
            border: 1px solid #f56c6c;
            color: #f56c6c;
        }
        .warning {
            background: #fdf6ec;
            border: 1px solid #e6a23c;
            color: #e6a23c;
        }
        .data-display {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
        }
        .button-group {
            margin: 15px 0;
        }
        .button-group button {
            margin-right: 10px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="container">
            <h1>评价系统用户ID完整修复测试</h1>
            
            <!-- 测试数据准备 -->
            <div class="test-section">
                <div class="section-title">1. 测试数据准备</div>
                <div class="button-group">
                    <el-button type="primary" @click="prepareTestData">准备测试数据</el-button>
                    <el-button @click="checkDatabaseStructure">检查数据库结构</el-button>
                </div>
                <div v-if="testDataResult" class="test-result" :class="testDataResult.type">
                    {{ testDataResult.message }}
                </div>
                <div v-if="testData" class="data-display">{{ JSON.stringify(testData, null, 2) }}</div>
            </div>

            <!-- 订单数据验证 -->
            <div class="test-section">
                <div class="section-title">2. 订单数据验证（包含用户ID）</div>
                <div class="button-group">
                    <el-button type="primary" @click="testOrdersWithUserIds">测试订单数据</el-button>
                    <el-button @click="testMyTripsAPI">测试MyTrips API</el-button>
                </div>
                <div v-if="orderResult" class="test-result" :class="orderResult.type">
                    {{ orderResult.message }}
                </div>
                <div v-if="orderData" class="data-display">{{ JSON.stringify(orderData, null, 2) }}</div>
            </div>

            <!-- 评价提交测试 -->
            <div class="test-section">
                <div class="section-title">3. 评价提交测试（使用用户ID）</div>
                <div class="test-item">
                    <h4>模拟评价数据</h4>
                    <el-form :model="reviewForm" label-width="120px">
                        <el-form-item label="订单ID">
                            <el-input v-model="reviewForm.orderId" type="number"></el-input>
                        </el-form-item>
                        <el-form-item label="评价人用户ID">
                            <el-input v-model="reviewForm.raterId" type="number"></el-input>
                        </el-form-item>
                        <el-form-item label="被评价人用户ID">
                            <el-input v-model="reviewForm.ratedId" type="number"></el-input>
                        </el-form-item>
                        <el-form-item label="评分">
                            <el-rate v-model="reviewForm.rating" :max="5"></el-rate>
                        </el-form-item>
                        <el-form-item label="评价内容">
                            <el-input v-model="reviewForm.comment" type="textarea"></el-input>
                        </el-form-item>
                    </el-form>
                    <div class="button-group">
                        <el-button type="primary" @click="submitReview">提交评价</el-button>
                        <el-button @click="fillSampleData">填充示例数据</el-button>
                    </div>
                </div>
                <div v-if="reviewResult" class="test-result" :class="reviewResult.type">
                    {{ reviewResult.message }}
                </div>
            </div>

            <!-- 评价查询测试 -->
            <div class="test-section">
                <div class="section-title">4. 评价查询测试</div>
                <div class="button-group">
                    <el-button type="primary" @click="testReviewQueries">测试评价查询</el-button>
                    <el-button @click="testDriverStats">测试司机统计</el-button>
                    <el-button @click="testAllReviewsWithNames">测试管理员评价列表</el-button>
                </div>
                <div v-if="queryResult" class="test-result" :class="queryResult.type">
                    {{ queryResult.message }}
                </div>
                <div v-if="queryData" class="data-display">{{ JSON.stringify(queryData, null, 2) }}</div>
            </div>

            <!-- 数据库验证 -->
            <div class="test-section">
                <div class="section-title">5. 数据库数据验证</div>
                <div class="button-group">
                    <el-button type="primary" @click="verifyDatabaseData">验证数据库数据</el-button>
                    <el-button @click="checkUserIdConsistency">检查用户ID一致性</el-button>
                </div>
                <div v-if="dbResult" class="test-result" :class="dbResult.type">
                    {{ dbResult.message }}
                </div>
                <div v-if="dbData" class="data-display">{{ JSON.stringify(dbData, null, 2) }}</div>
            </div>

            <!-- 完整流程测试 -->
            <div class="test-section">
                <div class="section-title">6. 完整流程测试</div>
                <div class="button-group">
                    <el-button type="success" @click="runCompleteTest" :loading="testing">运行完整测试</el-button>
                    <el-button @click="clearTestResults">清除测试结果</el-button>
                </div>
                <div v-if="completeTestResult" class="test-result" :class="completeTestResult.type">
                    {{ completeTestResult.message }}
                </div>
                <div v-if="completeTestData" class="data-display">{{ JSON.stringify(completeTestData, null, 2) }}</div>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, reactive } = Vue;
        const { ElMessage, ElMessageBox } = ElementPlus;

        createApp({
            setup() {
                // 响应式数据
                const testDataResult = ref(null);
                const testData = ref(null);
                const orderResult = ref(null);
                const orderData = ref(null);
                const reviewResult = ref(null);
                const queryResult = ref(null);
                const queryData = ref(null);
                const dbResult = ref(null);
                const dbData = ref(null);
                const completeTestResult = ref(null);
                const completeTestData = ref(null);
                const testing = ref(false);

                // 评价表单
                const reviewForm = reactive({
                    orderId: '',
                    raterId: '',
                    ratedId: '',
                    rating: 5,
                    comment: '测试评价内容'
                });

                // 准备测试数据
                const prepareTestData = async () => {
                    try {
                        testDataResult.value = { type: 'warning', message: '正在准备测试数据...' };
                        
                        // 获取一些基础数据用于测试
                        const [usersRes, ordersRes] = await Promise.all([
                            fetch('/api/users'),
                            fetch('/api/orders/with-names')
                        ]);

                        const users = await usersRes.json();
                        const orders = await ordersRes.json();

                        testData.value = {
                            users: users.data?.slice(0, 5) || [],
                            orders: orders.data?.slice(0, 3) || [],
                            timestamp: new Date().toISOString()
                        };

                        testDataResult.value = { 
                            type: 'success', 
                            message: `测试数据准备完成！用户: ${testData.value.users.length}个，订单: ${testData.value.orders.length}个` 
                        };
                    } catch (error) {
                        testDataResult.value = { type: 'error', message: '准备测试数据失败: ' + error.message };
                        console.error('准备测试数据失败:', error);
                    }
                };

                // 检查数据库结构
                const checkDatabaseStructure = async () => {
                    try {
                        testDataResult.value = { type: 'warning', message: '正在检查数据库结构...' };
                        
                        // 这里可以添加检查数据库表结构的逻辑
                        const response = await fetch('/api/reviews/all');
                        const result = await response.json();
                        
                        if (result.success) {
                            testDataResult.value = { 
                                type: 'success', 
                                message: '数据库结构检查完成，ratings表可正常访问' 
                            };
                        } else {
                            testDataResult.value = { 
                                type: 'error', 
                                message: '数据库结构检查失败: ' + result.message 
                            };
                        }
                    } catch (error) {
                        testDataResult.value = { type: 'error', message: '检查数据库结构失败: ' + error.message };
                    }
                };

                // 测试订单数据（包含用户ID）
                const testOrdersWithUserIds = async () => {
                    try {
                        orderResult.value = { type: 'warning', message: '正在测试订单数据...' };
                        
                        const response = await fetch('/api/orders/with-names');
                        const result = await response.json();
                        
                        if (result.success && result.data) {
                            const orders = result.data;
                            const hasUserIds = orders.some(order => 
                                order.passengerUserId && order.driverUserId
                            );
                            
                            orderData.value = {
                                totalOrders: orders.length,
                                ordersWithUserIds: orders.filter(order => 
                                    order.passengerUserId && order.driverUserId
                                ).length,
                                sampleOrder: orders[0] || null,
                                hasUserIds
                            };
                            
                            if (hasUserIds) {
                                orderResult.value = { 
                                    type: 'success', 
                                    message: '订单数据包含用户ID，修复成功！' 
                                };
                            } else {
                                orderResult.value = { 
                                    type: 'error', 
                                    message: '订单数据缺少用户ID，需要检查修复' 
                                };
                            }
                        } else {
                            orderResult.value = { type: 'error', message: '获取订单数据失败' };
                        }
                    } catch (error) {
                        orderResult.value = { type: 'error', message: '测试订单数据失败: ' + error.message };
                    }
                };

                // 测试MyTrips API
                const testMyTripsAPI = async () => {
                    try {
                        orderResult.value = { type: 'warning', message: '正在测试MyTrips API...' };
                        
                        // 模拟乘客和司机的API调用
                        const testUserId = 1; // 使用测试用户ID
                        
                        const [passengerRes, driverRes] = await Promise.all([
                            fetch(`/api/orders/passenger/${testUserId}/with-names`),
                            fetch(`/api/orders/driver/${testUserId}/with-names`)
                        ]);
                        
                        const passengerData = await passengerRes.json();
                        const driverData = await driverRes.json();
                        
                        orderData.value = {
                            passengerOrders: passengerData.data || [],
                            driverOrders: driverData.data || [],
                            testUserId
                        };
                        
                        orderResult.value = { 
                            type: 'success', 
                            message: `MyTrips API测试完成！乘客订单: ${orderData.value.passengerOrders.length}个，司机订单: ${orderData.value.driverOrders.length}个` 
                        };
                    } catch (error) {
                        orderResult.value = { type: 'error', message: 'MyTrips API测试失败: ' + error.message };
                    }
                };

                // 填充示例数据
                const fillSampleData = () => {
                    if (testData.value && testData.value.orders.length > 0) {
                        const sampleOrder = testData.value.orders[0];
                        reviewForm.orderId = sampleOrder.id;
                        reviewForm.raterId = sampleOrder.passengerUserId || sampleOrder.passengerId;
                        reviewForm.ratedId = sampleOrder.driverUserId || sampleOrder.driverId;
                        ElMessage.success('已填充示例数据');
                    } else {
                        ElMessage.warning('请先准备测试数据');
                    }
                };

                // 提交评价
                const submitReview = async () => {
                    try {
                        if (!reviewForm.orderId || !reviewForm.raterId || !reviewForm.ratedId) {
                            ElMessage.warning('请填写完整的评价信息');
                            return;
                        }

                        reviewResult.value = { type: 'warning', message: '正在提交评价...' };
                        
                        const reviewData = {
                            orderId: parseInt(reviewForm.orderId),
                            raterId: parseInt(reviewForm.raterId),
                            ratedId: parseInt(reviewForm.ratedId),
                            rating: reviewForm.rating,
                            comment: reviewForm.comment,
                            tags: JSON.stringify(['测试标签'])
                        };

                        const response = await fetch('/api/reviews', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(reviewData)
                        });

                        const result = await response.json();
                        
                        if (result.code === 200) {
                            reviewResult.value = { 
                                type: 'success', 
                                message: '评价提交成功！ID: ' + result.data.id 
                            };
                        } else {
                            reviewResult.value = { 
                                type: 'error', 
                                message: '评价提交失败: ' + result.message 
                            };
                        }
                    } catch (error) {
                        reviewResult.value = { type: 'error', message: '提交评价失败: ' + error.message };
                    }
                };

                // 测试评价查询
                const testReviewQueries = async () => {
                    try {
                        queryResult.value = { type: 'warning', message: '正在测试评价查询...' };
                        
                        const response = await fetch('/api/reviews/all');
                        const result = await response.json();
                        
                        if (result.success) {
                            queryData.value = {
                                totalReviews: result.data.length,
                                reviews: result.data.slice(0, 5), // 只显示前5个
                                hasUserNames: result.data.some(review => 
                                    review.reviewerName && review.revieweeName
                                )
                            };
                            
                            queryResult.value = { 
                                type: 'success', 
                                message: `评价查询成功！共${result.data.length}条评价` 
                            };
                        } else {
                            queryResult.value = { type: 'error', message: '评价查询失败' };
                        }
                    } catch (error) {
                        queryResult.value = { type: 'error', message: '测试评价查询失败: ' + error.message };
                    }
                };

                // 测试司机统计
                const testDriverStats = async () => {
                    try {
                        queryResult.value = { type: 'warning', message: '正在测试司机统计...' };
                        
                        const testDriverId = 1; // 使用测试司机ID
                        const response = await fetch(`/api/reviews/driver/${testDriverId}/stats`);
                        const result = await response.json();
                        
                        if (result.success) {
                            queryData.value = {
                                driverId: testDriverId,
                                stats: result.data
                            };
                            
                            queryResult.value = { 
                                type: 'success', 
                                message: '司机统计查询成功！' 
                            };
                        } else {
                            queryResult.value = { type: 'error', message: '司机统计查询失败' };
                        }
                    } catch (error) {
                        queryResult.value = { type: 'error', message: '测试司机统计失败: ' + error.message };
                    }
                };

                // 测试管理员评价列表
                const testAllReviewsWithNames = async () => {
                    try {
                        queryResult.value = { type: 'warning', message: '正在测试管理员评价列表...' };
                        
                        const response = await fetch('/api/reviews/all');
                        const result = await response.json();
                        
                        if (result.success) {
                            const reviews = result.data;
                            const hasCorrectUserIds = reviews.every(review => 
                                review.reviewerId && review.revieweeId &&
                                review.reviewerName && review.revieweeName
                            );
                            
                            queryData.value = {
                                totalReviews: reviews.length,
                                sampleReviews: reviews.slice(0, 3),
                                hasCorrectUserIds,
                                userIdCheck: reviews.map(review => ({
                                    id: review.id,
                                    reviewerId: review.reviewerId,
                                    revieweeId: review.revieweeId,
                                    hasNames: !!(review.reviewerName && review.revieweeName)
                                })).slice(0, 5)
                            };
                            
                            if (hasCorrectUserIds) {
                                queryResult.value = { 
                                    type: 'success', 
                                    message: '管理员评价列表测试成功！所有评价都包含正确的用户ID和姓名' 
                                };
                            } else {
                                queryResult.value = { 
                                    type: 'warning', 
                                    message: '管理员评价列表部分数据缺少用户信息' 
                                };
                            }
                        } else {
                            queryResult.value = { type: 'error', message: '管理员评价列表查询失败' };
                        }
                    } catch (error) {
                        queryResult.value = { type: 'error', message: '测试管理员评价列表失败: ' + error.message };
                    }
                };

                // 验证数据库数据
                const verifyDatabaseData = async () => {
                    try {
                        dbResult.value = { type: 'warning', message: '正在验证数据库数据...' };
                        
                        // 获取评价数据并验证
                        const response = await fetch('/api/reviews/all');
                        const result = await response.json();
                        
                        if (result.success) {
                            const reviews = result.data;
                            const analysis = {
                                totalReviews: reviews.length,
                                withUserIds: reviews.filter(r => r.reviewerId && r.revieweeId).length,
                                withNames: reviews.filter(r => r.reviewerName && r.revieweeName).length,
                                missingData: reviews.filter(r => !r.reviewerId || !r.revieweeId || !r.reviewerName || !r.revieweeName),
                                sampleData: reviews.slice(0, 3)
                            };
                            
                            dbData.value = analysis;
                            
                            if (analysis.withUserIds === analysis.totalReviews && analysis.withNames === analysis.totalReviews) {
                                dbResult.value = { 
                                    type: 'success', 
                                    message: '数据库数据验证成功！所有评价都包含正确的用户ID和姓名' 
                                };
                            } else {
                                dbResult.value = { 
                                    type: 'warning', 
                                    message: `数据库数据部分缺失：${analysis.missingData.length}条记录缺少完整信息` 
                                };
                            }
                        } else {
                            dbResult.value = { type: 'error', message: '验证数据库数据失败' };
                        }
                    } catch (error) {
                        dbResult.value = { type: 'error', message: '验证数据库数据失败: ' + error.message };
                    }
                };

                // 检查用户ID一致性
                const checkUserIdConsistency = async () => {
                    try {
                        dbResult.value = { type: 'warning', message: '正在检查用户ID一致性...' };
                        
                        // 获取用户、乘客、司机、订单和评价数据
                        const [usersRes, ordersRes, reviewsRes] = await Promise.all([
                            fetch('/api/users'),
                            fetch('/api/orders/with-names'),
                            fetch('/api/reviews/all')
                        ]);
                        
                        const users = await usersRes.json();
                        const orders = await ordersRes.json();
                        const reviews = await reviewsRes.json();
                        
                        const consistency = {
                            users: users.data?.length || 0,
                            orders: orders.data?.length || 0,
                            reviews: reviews.data?.length || 0,
                            ordersWithUserIds: orders.data?.filter(o => o.passengerUserId && o.driverUserId).length || 0,
                            reviewsWithUserIds: reviews.data?.filter(r => r.reviewerId && r.revieweeId).length || 0,
                            userIdMapping: {
                                orderUserIds: [...new Set([
                                    ...(orders.data?.map(o => o.passengerUserId).filter(Boolean) || []),
                                    ...(orders.data?.map(o => o.driverUserId).filter(Boolean) || [])
                                ])],
                                reviewUserIds: [...new Set([
                                    ...(reviews.data?.map(r => r.reviewerId).filter(Boolean) || []),
                                    ...(reviews.data?.map(r => r.revieweeId).filter(Boolean) || [])
                                ])]
                            }
                        };
                        
                        dbData.value = consistency;
                        
                        const isConsistent = 
                            consistency.ordersWithUserIds === consistency.orders &&
                            consistency.reviewsWithUserIds === consistency.reviews;
                        
                        if (isConsistent) {
                            dbResult.value = { 
                                type: 'success', 
                                message: '用户ID一致性检查通过！所有数据都使用正确的用户ID' 
                            };
                        } else {
                            dbResult.value = { 
                                type: 'warning', 
                                message: '用户ID一致性检查发现问题，部分数据可能需要修复' 
                            };
                        }
                    } catch (error) {
                        dbResult.value = { type: 'error', message: '检查用户ID一致性失败: ' + error.message };
                    }
                };

                // 运行完整测试
                const runCompleteTest = async () => {
                    testing.value = true;
                    completeTestResult.value = { type: 'warning', message: '正在运行完整测试...' };
                    
                    try {
                        const testResults = [];
                        
                        // 1. 准备测试数据
                        await prepareTestData();
                        testResults.push({ step: '准备测试数据', success: testDataResult.value.type === 'success' });
                        
                        // 2. 测试订单数据
                        await testOrdersWithUserIds();
                        testResults.push({ step: '订单数据测试', success: orderResult.value.type === 'success' });
                        
                        // 3. 测试MyTrips API
                        await testMyTripsAPI();
                        testResults.push({ step: 'MyTrips API测试', success: orderResult.value.type === 'success' });
                        
                        // 4. 测试评价查询
                        await testReviewQueries();
                        testResults.push({ step: '评价查询测试', success: queryResult.value.type === 'success' });
                        
                        // 5. 验证数据库数据
                        await verifyDatabaseData();
                        testResults.push({ step: '数据库数据验证', success: dbResult.value.type === 'success' });
                        
                        // 6. 检查用户ID一致性
                        await checkUserIdConsistency();
                        testResults.push({ step: '用户ID一致性检查', success: dbResult.value.type === 'success' });
                        
                        const successCount = testResults.filter(r => r.success).length;
                        const totalCount = testResults.length;
                        
                        completeTestData.value = {
                            testResults,
                            summary: {
                                total: totalCount,
                                success: successCount,
                                failed: totalCount - successCount,
                                successRate: Math.round((successCount / totalCount) * 100)
                            },
                            timestamp: new Date().toISOString()
                        };
                        
                        if (successCount === totalCount) {
                            completeTestResult.value = { 
                                type: 'success', 
                                message: `完整测试通过！所有${totalCount}项测试都成功` 
                            };
                        } else {
                            completeTestResult.value = { 
                                type: 'warning', 
                                message: `完整测试部分通过：${successCount}/${totalCount}项成功` 
                            };
                        }
                    } catch (error) {
                        completeTestResult.value = { type: 'error', message: '完整测试失败: ' + error.message };
                    } finally {
                        testing.value = false;
                    }
                };

                // 清除测试结果
                const clearTestResults = () => {
                    testDataResult.value = null;
                    testData.value = null;
                    orderResult.value = null;
                    orderData.value = null;
                    reviewResult.value = null;
                    queryResult.value = null;
                    queryData.value = null;
                    dbResult.value = null;
                    dbData.value = null;
                    completeTestResult.value = null;
                    completeTestData.value = null;
                    
                    // 重置表单
                    Object.assign(reviewForm, {
                        orderId: '',
                        raterId: '',
                        ratedId: '',
                        rating: 5,
                        comment: '测试评价内容'
                    });
                    
                    ElMessage.success('测试结果已清除');
                };

                return {
                    testDataResult,
                    testData,
                    orderResult,
                    orderData,
                    reviewResult,
                    queryResult,
                    queryData,
                    dbResult,
                    dbData,
                    completeTestResult,
                    completeTestData,
                    testing,
                    reviewForm,
                    prepareTestData,
                    checkDatabaseStructure,
                    testOrdersWithUserIds,
                    testMyTripsAPI,
                    fillSampleData,
                    submitReview,
                    testReviewQueries,
                    testDriverStats,
                    testAllReviewsWithNames,
                    verifyDatabaseData,
                    checkUserIdConsistency,
                    runCompleteTest,
                    clearTestResults
                };
            }
        }).use(ElementPlus).mount('#app');
    </script>
</body>
</html>