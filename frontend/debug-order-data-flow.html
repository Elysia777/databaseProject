<!DOCTYPE html>
<html lang=\"zh-CN\">
<head>
    <meta charset=\"UTF-8\">
    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">
    <title>è®¢å•æ•°æ®æµè°ƒè¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .debug-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 3px;
        }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .info { background-color: #d1ecf1; color: #0c5460; }
        .warning { background-color: #fff3cd; color: #856404; }
        .code-block {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 14px;
            border: 1px solid #e9ecef;
            overflow-x: auto;
            margin: 10px 0;
            white-space: pre-wrap;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 3px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background-color: #0056b3; }
        .step {
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
            border-left: 4px solid #007bff;
        }
        .data-display {
            background: white;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 3px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>ğŸ” è®¢å•æ•°æ®æµè°ƒè¯•</h1>

    <div class=\"debug-section\">
        <h3>ğŸ“‹ æµ‹è¯•æ­¥éª¤</h3>
        <div class=\"step\">
            <strong>æ­¥éª¤1ï¼š</strong> æ¨¡æ‹Ÿåˆ›å»ºè®¢å•æ•°æ®
            <button onclick=\"createTestOrder()\">åˆ›å»ºæµ‹è¯•è®¢å•</button>
            <div id=\"step1-result\" class=\"data-display\"></div>
        </div>

        <div class=\"step\">
            <strong>æ­¥éª¤2ï¼š</strong> å‘é€åˆ°åç«¯
            <button onclick=\"sendToBackend()\">å‘é€åˆ°åç«¯</button>
            <div id=\"step2-result\" class=\"data-display\"></div>
        </div>

        <div class=\"step\">
            <strong>æ­¥éª¤3ï¼š</strong> æŸ¥è¯¢æ•°æ®åº“è®°å½•
            <button onclick=\"queryDatabase()\">æŸ¥è¯¢æ•°æ®åº“</button>
            <div id=\"step3-result\" class=\"data-display\"></div>
        </div>

        <div class=\"step\">
            <strong>æ­¥éª¤4ï¼š</strong> æ¨¡æ‹Ÿå¸æœºé€šçŸ¥
            <button onclick=\"simulateDriverNotification()\">æ¨¡æ‹Ÿå¸æœºé€šçŸ¥</button>
            <div id=\"step4-result\" class=\"data-display\"></div>
        </div>
    </div>

    <div class=\"debug-section\">
        <h3>ğŸ“Š å®æ—¶æ•°æ®ç›‘æ§</h3>
        <div id=\"realtime-data\" class=\"data-display\">
            ç­‰å¾…æ•°æ®...
        </div>
    </div>

    <script>
        let testOrderData = null;
        let createdOrderId = null;

        // æ­¥éª¤1ï¼šåˆ›å»ºæµ‹è¯•è®¢å•æ•°æ®
        function createTestOrder() {
            // æ¨¡æ‹Ÿè·¯çº¿ä¿¡æ¯
            const routeInfo = {
                distance: 8500,  // 8.5å…¬é‡Œï¼ˆç±³ï¼‰
                duration: 1200   // 20åˆ†é’Ÿï¼ˆç§’ï¼‰
            };

            testOrderData = {
                passengerId: 1,
                pickupAddress: \"æµ‹è¯•èµ·ç‚¹åœ°å€\",
                pickupLatitude: 39.044237,
                pickupLongitude: 121.749849,
                destinationAddress: \"æµ‹è¯•ç»ˆç‚¹åœ°å€\",
                destinationLatitude: 39.054237,
                destinationLongitude: 121.759849,
                estimatedDistance: (routeInfo.distance / 1000).toFixed(2), // 8.50
                estimatedDuration: Math.round(routeInfo.duration / 60),     // 20
                estimatedFare: 25.00
            };

            document.getElementById('step1-result').innerHTML = `
                <strong>âœ… æµ‹è¯•è®¢å•æ•°æ®åˆ›å»ºæˆåŠŸï¼š</strong>
                <div class=\"code-block\">${JSON.stringify(testOrderData, null, 2)}</div>
            `;

            updateRealtimeData('æ­¥éª¤1å®Œæˆ', testOrderData);
        }

        // æ­¥éª¤2ï¼šå‘é€åˆ°åç«¯
        async function sendToBackend() {
            if (!testOrderData) {
                alert('è¯·å…ˆåˆ›å»ºæµ‹è¯•è®¢å•æ•°æ®');
                return;
            }

            try {
                console.log('ğŸš€ å‘é€è®¢å•æ•°æ®åˆ°åç«¯:', testOrderData);

                const response = await fetch('/api/orders', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer test-token'
                    },
                    body: JSON.stringify(testOrderData)
                });

                const result = await response.json();
                console.log('ğŸ“¡ åç«¯å“åº”:', result);

                if (result.code === 200) {
                    createdOrderId = result.data;
                    document.getElementById('step2-result').innerHTML = `
                        <strong>âœ… è®¢å•åˆ›å»ºæˆåŠŸï¼š</strong>
                        <div class=\"code-block\">è®¢å•ID: ${createdOrderId}
å“åº”æ•°æ®: ${JSON.stringify(result, null, 2)}</div>
                    `;
                    updateRealtimeData('æ­¥éª¤2å®Œæˆ', { orderId: createdOrderId, response: result });
                } else {
                    document.getElementById('step2-result').innerHTML = `
                        <strong>âŒ è®¢å•åˆ›å»ºå¤±è´¥ï¼š</strong>
                        <div class=\"code-block\">${JSON.stringify(result, null, 2)}</div>
                    `;
                }
            } catch (error) {
                console.error('âŒ å‘é€å¤±è´¥:', error);
                document.getElementById('step2-result').innerHTML = `
                    <strong>âŒ å‘é€å¤±è´¥ï¼š</strong>
                    <div class=\"code-block\">${error.message}</div>
                `;
            }
        }

        // æ­¥éª¤3ï¼šæŸ¥è¯¢æ•°æ®åº“è®°å½•
        async function queryDatabase() {
            if (!createdOrderId) {
                alert('è¯·å…ˆåˆ›å»ºè®¢å•');
                return;
            }

            try {
                console.log('ğŸ” æŸ¥è¯¢è®¢å•è¯¦æƒ…:', createdOrderId);

                const response = await fetch(`/api/orders/${createdOrderId}`, {
                    headers: {
                        'Authorization': 'Bearer test-token'
                    }
                });

                const result = await response.json();
                console.log('ğŸ“‹ è®¢å•è¯¦æƒ…:', result);

                if (result.code === 200) {
                    const order = result.data;
                    document.getElementById('step3-result').innerHTML = `
                        <strong>âœ… æ•°æ®åº“è®°å½•æŸ¥è¯¢æˆåŠŸï¼š</strong>
                        <div class=\"code-block\">è®¢å•ID: ${order.id}
é¢„ä¼°è·ç¦»: ${order.estimatedDistance} å…¬é‡Œ
é¢„ä¼°æ—¶é•¿: ${order.estimatedDuration} åˆ†é’Ÿ
é¢„ä¼°è´¹ç”¨: ${order.estimatedFare} å…ƒ
å®Œæ•´æ•°æ®: ${JSON.stringify(order, null, 2)}</div>
                    `;
                    updateRealtimeData('æ­¥éª¤3å®Œæˆ', order);
                } else {
                    document.getElementById('step3-result').innerHTML = `
                        <strong>âŒ æŸ¥è¯¢å¤±è´¥ï¼š</strong>
                        <div class=\"code-block\">${JSON.stringify(result, null, 2)}</div>
                    `;
                }
            } catch (error) {
                console.error('âŒ æŸ¥è¯¢å¤±è´¥:', error);
                document.getElementById('step3-result').innerHTML = `
                    <strong>âŒ æŸ¥è¯¢å¤±è´¥ï¼š</strong>
                    <div class=\"code-block\">${error.message}</div>
                `;
            }
        }

        // æ­¥éª¤4ï¼šæ¨¡æ‹Ÿå¸æœºé€šçŸ¥
        function simulateDriverNotification() {
            if (!createdOrderId) {
                alert('è¯·å…ˆåˆ›å»ºè®¢å•');
                return;
            }

            // æ¨¡æ‹ŸWebSocketé€šçŸ¥æ•°æ®
            const notificationData = {
                type: \"NEW_ORDER\",
                orderId: createdOrderId,
                orderNumber: `ORDER${createdOrderId}`,
                orderType: \"REAL_TIME\",
                pickupAddress: testOrderData.pickupAddress,
                destinationAddress: testOrderData.destinationAddress,
                pickupLatitude: testOrderData.pickupLatitude,
                pickupLongitude: testOrderData.pickupLongitude,
                destinationLatitude: testOrderData.destinationLatitude,
                destinationLongitude: testOrderData.destinationLongitude,
                passengerId: testOrderData.passengerId,
                distance: testOrderData.estimatedDistance,
                estimatedDistance: testOrderData.estimatedDistance,
                estimatedDuration: testOrderData.estimatedDuration,
                estimatedFare: testOrderData.estimatedFare,
                timestamp: Date.now()
            };

            document.getElementById('step4-result').innerHTML = `
                <strong>âœ… å¸æœºé€šçŸ¥æ•°æ®æ¨¡æ‹Ÿï¼š</strong>
                <div class=\"code-block\">${JSON.stringify(notificationData, null, 2)}</div>
                <div style=\"margin-top: 10px; padding: 10px; background: #e7f3ff; border-radius: 3px;\">
                    <strong>å¸æœºç«¯æ˜¾ç¤ºæ•ˆæœï¼š</strong><br>
                    ğŸ“ ä¸Šè½¦åœ°ç‚¹: ${notificationData.pickupAddress}<br>
                    ğŸ¯ ç›®çš„åœ°: ${notificationData.destinationAddress}<br>
                    ğŸ“ è·ç¦»: ${notificationData.distance} å…¬é‡Œ<br>
                    â±ï¸ æ—¶é•¿: ${notificationData.estimatedDuration} åˆ†é’Ÿ<br>
                    ğŸ’° é¢„ä¼°è´¹ç”¨: ${notificationData.estimatedFare} å…ƒ
                </div>
            `;

            updateRealtimeData('æ­¥éª¤4å®Œæˆ', notificationData);
        }

        // æ›´æ–°å®æ—¶æ•°æ®æ˜¾ç¤º
        function updateRealtimeData(step, data) {
            const realtimeDiv = document.getElementById('realtime-data');
            const timestamp = new Date().toLocaleTimeString();
            
            realtimeDiv.innerHTML = `
                <strong>ğŸ“Š æœ€æ–°çŠ¶æ€ï¼š</strong> ${step} (${timestamp})<br>
                <div class=\"code-block\">${JSON.stringify(data, null, 2)}</div>
            `;
        }

        // é¡µé¢åŠ è½½æ—¶çš„åˆå§‹åŒ–
        window.onload = function() {
            console.log('ğŸ” è®¢å•æ•°æ®æµè°ƒè¯•é¡µé¢å·²åŠ è½½');
            updateRealtimeData('é¡µé¢å·²åŠ è½½', { message: 'å‡†å¤‡å¼€å§‹è°ƒè¯•' });
        };
    </script>
</body>
</html>