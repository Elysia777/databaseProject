<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>评价系统测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        button {
            background: #409EFF;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #66b1ff;
        }
        .result-display {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 14px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .status-good {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .status-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .review-form {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .star-rating {
            display: flex;
            gap: 5px;
            margin: 10px 0;
        }
        .star {
            font-size: 24px;
            color: #ddd;
            cursor: pointer;
            transition: color 0.2s;
        }
        .star:hover,
        .star.active {
            color: #ffd700;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🌟 评价系统测试</h1>
        <p>测试乘客评价功能的完整流程</p>
    </div>

    <div class="grid">
        <div class="container">
            <h3>步骤1: 创建测试数据</h3>
            <button onclick="createTestData()">创建测试订单</button>
            <div id="createResult" class="result-display">
                点击创建测试数据...
            </div>
        </div>

        <div class="container">
            <h3>步骤2: 测试评价API</h3>
            <button onclick="testReviewAPI()">测试评价接口</button>
            <div id="apiResult" class="result-display">
                点击测试评价API...
            </div>
        </div>

        <div class="container">
            <h3>步骤3: 创建评价</h3>
            <div class="review-form">
                <div class="form-group">
                    <label>订单ID:</label>
                    <input type="number" id="orderId" placeholder="输入订单ID">
                </div>
                <div class="form-group">
                    <label>评分:</label>
                    <div class="star-rating" id="starRating">
                        <span class="star" data-rating="1">★</span>
                        <span class="star" data-rating="2">★</span>
                        <span class="star" data-rating="3">★</span>
                        <span class="star" data-rating="4">★</span>
                        <span class="star" data-rating="5">★</span>
                    </div>
                    <span id="ratingText">请选择评分</span>
                </div>
                <div class="form-group">
                    <label>评价内容:</label>
                    <textarea id="comment" placeholder="分享您的乘车体验..." rows="3"></textarea>
                </div>

                <button onclick="submitReview()">提交评价</button>
            </div>
            <div id="reviewResult" class="result-display">
                填写表单并提交评价...
            </div>
        </div>

        <div class="container">
            <h3>步骤4: 查看评价统计</h3>
            <button onclick="viewDriverStats()">查看司机评分统计</button>
            <div id="statsResult" class="result-display">
                点击查看司机评分统计...
            </div>
        </div>
    </div>

    <script>
        let selectedRating = 0;
        let testOrderId = null;

        function log(message, containerId = 'result') {
            const container = document.getElementById(containerId);
            const timestamp = new Date().toLocaleTimeString();
            container.textContent += `[${timestamp}] ${message}\n`;
            container.scrollTop = container.scrollHeight;
            console.log(message);
        }

        // 初始化星级评分
        document.addEventListener('DOMContentLoaded', function() {
            const stars = document.querySelectorAll('.star');
            const ratingText = document.getElementById('ratingText');
            
            stars.forEach(star => {
                star.addEventListener('click', function() {
                    selectedRating = parseInt(this.dataset.rating);
                    updateStars();
                    updateRatingText();
                });
                
                star.addEventListener('mouseover', function() {
                    const hoverRating = parseInt(this.dataset.rating);
                    updateStars(hoverRating);
                });
            });
            
            document.getElementById('starRating').addEventListener('mouseleave', function() {
                updateStars();
            });
            
            function updateStars(hoverRating = null) {
                const rating = hoverRating || selectedRating;
                stars.forEach((star, index) => {
                    if (index < rating) {
                        star.classList.add('active');
                    } else {
                        star.classList.remove('active');
                    }
                });
            }
            
            function updateRatingText() {
                const texts = ['请选择评分', '很不满意', '不满意', '一般', '满意', '非常满意'];
                ratingText.textContent = texts[selectedRating] || '请选择评分';
            }
        });

        async function createTestData() {
            const resultDiv = document.getElementById('createResult');
            resultDiv.textContent = '';
            resultDiv.className = 'result-display';
            
            log('🚗 创建测试订单...', 'createResult');
            
            try {
                // 1. 创建订单
                const orderData = {
                    passengerId: 1,
                    pickupAddress: '评价测试 - 上车点',
                    pickupLatitude: 39.044237,
                    pickupLongitude: 121.749849,
                    destinationAddress: '评价测试 - 目的地',
                    destinationLatitude: 39.054237,
                    destinationLongitude: 121.759849
                };
                
                const createResponse = await fetch('/api/orders/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(orderData)
                });
                
                if (createResponse.ok) {
                    const createResult = await createResponse.json();
                    if (createResult.code === 200) {
                        testOrderId = createResult.data;
                        log(`✅ 订单创建成功: ${testOrderId}`, 'createResult');
                        document.getElementById('orderId').value = testOrderId;
                        
                        // 2. 司机接单
                        const acceptResponse = await fetch(`/api/drivers/1/accept-order/${testOrderId}`, {
                            method: 'POST'
                        });
                        
                        if (acceptResponse.ok) {
                            log('✅ 司机接单成功', 'createResult');
                            
                            // 3. 完成订单
                            const completeResponse = await fetch(`/api/drivers/1/complete-order/${testOrderId}`, {
                                method: 'POST'
                            });
                            
                            if (completeResponse.ok) {
                                log('✅ 订单完成，可以进行评价了', 'createResult');
                                resultDiv.className = 'result-display status-good';
                            } else {
                                log('❌ 完成订单失败', 'createResult');
                                resultDiv.className = 'result-display status-error';
                            }
                        } else {
                            log('❌ 司机接单失败', 'createResult');
                            resultDiv.className = 'result-display status-error';
                        }
                    } else {
                        log(`❌ 订单创建失败: ${createResult.message}`, 'createResult');
                        resultDiv.className = 'result-display status-error';
                    }
                } else {
                    log('❌ 创建订单请求失败', 'createResult');
                    resultDiv.className = 'result-display status-error';
                }
            } catch (error) {
                log(`❌ 创建测试数据失败: ${error.message}`, 'createResult');
                resultDiv.className = 'result-display status-error';
            }
        }

        async function testReviewAPI() {
            const resultDiv = document.getElementById('apiResult');
            resultDiv.textContent = '';
            resultDiv.className = 'result-display';
            
            log('🧪 测试评价API接口...', 'apiResult');
            
            try {
                // 测试获取司机评价列表
                log('1. 测试获取司机评价列表...', 'apiResult');
                const driverReviewsResponse = await fetch('/api/reviews/driver/1');
                if (driverReviewsResponse.ok) {
                    const result = await response.json();
                    log(`✅ 司机评价列表: ${result.data.length}条`, 'apiResult');
                } else {
                    log('⚠️ 司机评价列表为空或获取失败', 'apiResult');
                }
                
                // 测试获取司机评分统计
                log('2. 测试获取司机评分统计...', 'apiResult');
                const statsResponse = await fetch('/api/reviews/driver/1/stats');
                if (statsResponse.ok) {
                    const statsResult = await statsResponse.json();
                    if (statsResult.code === 200) {
                        log('✅ 司机评分统计:', 'apiResult');
                        log(`  总评价数: ${statsResult.data.totalReviews}`, 'apiResult');
                        log(`  平均评分: ${statsResult.data.averageRating}`, 'apiResult');
                        log(`  5星: ${statsResult.data.fiveStars}个`, 'apiResult');
                        log(`  4星: ${statsResult.data.fourStars}个`, 'apiResult');
                        log(`  3星: ${statsResult.data.threeStars}个`, 'apiResult');
                        log(`  2星: ${statsResult.data.twoStars}个`, 'apiResult');
                        log(`  1星: ${statsResult.data.oneStars}个`, 'apiResult');
                    }
                }
                
                resultDiv.className = 'result-display status-good';
            } catch (error) {
                log(`❌ API测试失败: ${error.message}`, 'apiResult');
                resultDiv.className = 'result-display status-error';
            }
        }

        async function submitReview() {
            const resultDiv = document.getElementById('reviewResult');
            resultDiv.textContent = '';
            resultDiv.className = 'result-display';
            
            const orderId = document.getElementById('orderId').value;
            const comment = document.getElementById('comment').value;

            
            if (!orderId) {
                log('❌ 请输入订单ID', 'reviewResult');
                resultDiv.className = 'result-display status-error';
                return;
            }
            
            if (selectedRating === 0) {
                log('❌ 请选择评分', 'reviewResult');
                resultDiv.className = 'result-display status-error';
                return;
            }
            
            log('📝 提交评价...', 'reviewResult');
            
            try {
                const reviewData = {
                    orderId: parseInt(orderId),
                    raterId: 1,
                    ratedId: 1,
                    rating: selectedRating,
                    comment: comment.trim(),
                    tags: JSON.stringify(['服务好', '准时'])
                };
                
                log(`评价数据: ${JSON.stringify(reviewData, null, 2)}`, 'reviewResult');
                
                const response = await fetch('/api/reviews', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(reviewData)
                });
                
                const result = await response.json();
                log(`响应: ${JSON.stringify(result, null, 2)}`, 'reviewResult');
                
                if (response.ok && result.code === 200) {
                    log('✅ 评价提交成功！', 'reviewResult');
                    log(`评价ID: ${result.data.id}`, 'reviewResult');
                    resultDiv.className = 'result-display status-good';
                } else {
                    log(`❌ 评价提交失败: ${result.message}`, 'reviewResult');
                    resultDiv.className = 'result-display status-error';
                }
            } catch (error) {
                log(`❌ 提交评价失败: ${error.message}`, 'reviewResult');
                resultDiv.className = 'result-display status-error';
            }
        }

        async function viewDriverStats() {
            const resultDiv = document.getElementById('statsResult');
            resultDiv.textContent = '';
            resultDiv.className = 'result-display';
            
            log('📊 查看司机评分统计...', 'statsResult');
            
            try {
                const response = await fetch('/api/reviews/driver/1/stats');
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.code === 200) {
                        const stats = result.data;
                        log('✅ 司机评分统计:', 'statsResult');
                        log(`总评价数: ${stats.totalReviews}`, 'statsResult');
                        log(`平均评分: ${parseFloat(stats.averageRating).toFixed(1)}分`, 'statsResult');
                        log('', 'statsResult');
                        log('评分分布:', 'statsResult');
                        log(`⭐⭐⭐⭐⭐ ${stats.fiveStars}个 (${((stats.fiveStars/stats.totalReviews)*100).toFixed(1)}%)`, 'statsResult');
                        log(`⭐⭐⭐⭐ ${stats.fourStars}个 (${((stats.fourStars/stats.totalReviews)*100).toFixed(1)}%)`, 'statsResult');
                        log(`⭐⭐⭐ ${stats.threeStars}个 (${((stats.threeStars/stats.totalReviews)*100).toFixed(1)}%)`, 'statsResult');
                        log(`⭐⭐ ${stats.twoStars}个 (${((stats.twoStars/stats.totalReviews)*100).toFixed(1)}%)`, 'statsResult');
                        log(`⭐ ${stats.oneStars}个 (${((stats.oneStars/stats.totalReviews)*100).toFixed(1)}%)`, 'statsResult');
                        
                        resultDiv.className = 'result-display status-good';
                    } else {
                        log(`❌ 获取统计失败: ${result.message}`, 'statsResult');
                        resultDiv.className = 'result-display status-error';
                    }
                } else {
                    log('❌ 获取统计请求失败', 'statsResult');
                    resultDiv.className = 'result-display status-error';
                }
            } catch (error) {
                log(`❌ 获取统计失败: ${error.message}`, 'statsResult');
                resultDiv.className = 'result-display status-error';
            }
        }

        // 页面加载时的说明
        window.onload = function() {
            log('评价系统测试页面加载完成', 'createResult');
            log('按顺序执行测试步骤:', 'createResult');
            log('1. 创建测试数据', 'createResult');
            log('2. 测试API接口', 'createResult');
            log('3. 提交评价', 'createResult');
            log('4. 查看统计', 'createResult');
        };
    </script>
</body>
</html>