<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é€€å‡ºç™»å½•å¸æœºçŠ¶æ€æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #333;
        }
        button {
            background: #409EFF;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #66b1ff;
        }
        button.danger {
            background: #f56c6c;
        }
        button.success {
            background: #67c23a;
        }
        button.warning {
            background: #e6a23c;
        }
        .result-display {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 14px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .status-good {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .status-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .status-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        .flow-diagram {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
            margin: 10px 0;
        }
        .flow-step {
            text-align: center;
            flex: 1;
            padding: 10px;
            background: white;
            border-radius: 5px;
            margin: 0 5px;
        }
        .flow-arrow {
            font-size: 20px;
            color: #409EFF;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸšª é€€å‡ºç™»å½•å¸æœºçŠ¶æ€æµ‹è¯•</h1>
        <p>æµ‹è¯•é€€å‡ºç™»å½•æ—¶å¸æœºçŠ¶æ€çš„æ­£ç¡®å¤„ç†</p>
    </div>

    <div class="container">
        <h2>ğŸ”§ é—®é¢˜æè¿°ä¸ä¿®å¤</h2>
        <div class="test-section">
            <h3>é—®é¢˜ç°è±¡</h3>
            <ul>
                <li>é€€å‡ºç™»å½•æ—¶å¸æœºæ²¡æœ‰è‡ªåŠ¨ä¸‹çº¿</li>
                <li>é‡æ–°ç™»å½•æ—¶å¸æœºæŒ‰é’®æ˜¾ç¤ºä¸Šçº¿çŠ¶æ€</li>
                <li>ä½†å®é™…ä¸Šæ¥ä¸åˆ°è®¢å•ï¼ˆå‰åç«¯çŠ¶æ€ä¸ä¸€è‡´ï¼‰</li>
            </ul>
            
            <h3>ä¿®å¤æ–¹æ¡ˆ</h3>
            <ul>
                <li>é€€å‡ºç™»å½•æ—¶è‡ªåŠ¨è°ƒç”¨å¸æœºä¸‹çº¿API</li>
                <li>æ¸…é™¤å¸æœºstoreä¸­çš„æ‰€æœ‰çŠ¶æ€</li>
                <li>é‡æ–°ç™»å½•æ—¶æ£€æŸ¥å‰åç«¯çŠ¶æ€ä¸€è‡´æ€§</li>
                <li>å¦‚æœçŠ¶æ€ä¸ä¸€è‡´ï¼Œå¼ºåˆ¶åŒæ­¥åˆ°ä¸‹çº¿çŠ¶æ€</li>
            </ul>
        </div>
    </div>

    <div class="container">
        <h2>ğŸ“‹ æµ‹è¯•æµç¨‹</h2>
        <div class="flow-diagram">
            <div class="flow-step">
                <div><strong>1. å¸æœºä¸Šçº¿</strong></div>
                <small>æ­£å¸¸ä¸Šçº¿æ¥å•</small>
            </div>
            <div class="flow-arrow">â†’</div>
            <div class="flow-step">
                <div><strong>2. é€€å‡ºç™»å½•</strong></div>
                <small>åº”è¯¥è‡ªåŠ¨ä¸‹çº¿</small>
            </div>
            <div class="flow-arrow">â†’</div>
            <div class="flow-step">
                <div><strong>3. é‡æ–°ç™»å½•</strong></div>
                <small>çŠ¶æ€åº”è¯¥æ˜¯ä¸‹çº¿</small>
            </div>
            <div class="flow-arrow">â†’</div>
            <div class="flow-step">
                <div><strong>4. éªŒè¯çŠ¶æ€</strong></div>
                <small>å‰åç«¯ä¸€è‡´</small>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="test-section">
            <h3>1. æ£€æŸ¥å½“å‰çŠ¶æ€</h3>
            <button onclick="checkCurrentStatus()">æ£€æŸ¥å½“å‰çŠ¶æ€</button>
            <button onclick="checkBackendStatus()">æ£€æŸ¥åç«¯çŠ¶æ€</button>
            
            <div id="statusResult" class="result-display">
                ç‚¹å‡»æŒ‰é’®æ£€æŸ¥å½“å‰çŠ¶æ€...
            </div>
        </div>

        <div class="test-section">
            <h3>2. æ¨¡æ‹Ÿå¸æœºä¸Šçº¿</h3>
            <button onclick="simulateDriverOnline()" class="success">å¸æœºä¸Šçº¿</button>
            <button onclick="checkOnlineStatus()">éªŒè¯ä¸Šçº¿çŠ¶æ€</button>
            
            <div id="onlineResult" class="result-display">
                ç‚¹å‡»æŒ‰é’®æ¨¡æ‹Ÿå¸æœºä¸Šçº¿...
            </div>
        </div>

        <div class="test-section">
            <h3>3. æµ‹è¯•é€€å‡ºç™»å½•</h3>
            <button onclick="testLogout()" class="danger">æ¨¡æ‹Ÿé€€å‡ºç™»å½•</button>
            <button onclick="checkLogoutEffect()">æ£€æŸ¥é€€å‡ºæ•ˆæœ</button>
            
            <div id="logoutResult" class="result-display">
                ç‚¹å‡»æŒ‰é’®æµ‹è¯•é€€å‡ºç™»å½•...
            </div>
        </div>

        <div class="test-section">
            <h3>4. æµ‹è¯•é‡æ–°ç™»å½•</h3>
            <button onclick="simulateRelogin()" class="warning">æ¨¡æ‹Ÿé‡æ–°ç™»å½•</button>
            <button onclick="checkStateConsistency()">æ£€æŸ¥çŠ¶æ€ä¸€è‡´æ€§</button>
            
            <div id="reloginResult" class="result-display">
                ç‚¹å‡»æŒ‰é’®æµ‹è¯•é‡æ–°ç™»å½•...
            </div>
        </div>
    </div>

    <div class="container">
        <h2>ğŸ§ª localStorageçŠ¶æ€æ£€æŸ¥</h2>
        <div class="test-section">
            <h3>å­˜å‚¨çŠ¶æ€</h3>
            <button onclick="checkLocalStorage()">æ£€æŸ¥localStorage</button>
            <button onclick="clearAllStorage()">æ¸…é™¤æ‰€æœ‰å­˜å‚¨</button>
            
            <div id="storageResult" class="result-display">
                ç‚¹å‡»æŒ‰é’®æ£€æŸ¥localStorageçŠ¶æ€...
            </div>
        </div>
    </div>

    <script>
        function log(message, containerId) {
            const container = document.getElementById(containerId);
            const timestamp = new Date().toLocaleTimeString();
            container.textContent += `[${timestamp}] ${message}\\n`;
            container.scrollTop = container.scrollHeight;
            console.log(message);
        }

        async function checkCurrentStatus() {
            const resultDiv = document.getElementById('statusResult');
            resultDiv.textContent = '';
            resultDiv.className = 'result-display';
            
            log('ğŸ” æ£€æŸ¥å½“å‰çŠ¶æ€...', 'statusResult');
            
            // æ£€æŸ¥localStorage
            const driverState = localStorage.getItem('driverState');
            const token = localStorage.getItem('token');
            
            log(`Tokenå­˜åœ¨: ${!!token}`, 'statusResult');
            log(`å¸æœºçŠ¶æ€å­˜åœ¨: ${!!driverState}`, 'statusResult');
            
            if (driverState) {
                try {
                    const state = JSON.parse(driverState);
                    log(`å¸æœºåœ¨çº¿çŠ¶æ€: ${state.isOnline}`, 'statusResult');
                    log(`å¸æœºID: ${state.driverId}`, 'statusResult');
                    log(`å½“å‰è®¢å•: ${state.currentOrder ? state.currentOrder.orderNumber : 'æ— '}`, 'statusResult');
                } catch (error) {
                    log(`è§£æå¸æœºçŠ¶æ€å¤±è´¥: ${error.message}`, 'statusResult');
                }
            }
            
            resultDiv.className = 'result-display status-good';
        }

        async function checkBackendStatus() {
            log('\\nğŸ” æ£€æŸ¥åç«¯çŠ¶æ€...', 'statusResult');
            
            try {
                const response = await fetch('/api/drivers/1/status-detail');
                if (response.ok) {
                    const result = await response.json();
                    const detail = result.data;
                    
                    log(`åç«¯åœ¨çº¿çŠ¶æ€: ${detail.isOnlineAndFree}`, 'statusResult');
                    log(`æ•°æ®åº“å­˜åœ¨: ${detail.consistency.dbExists}`, 'statusResult');
                    log(`Rediså­˜åœ¨: ${detail.consistency.redisExists}`, 'statusResult');
                } else {
                    log(`åç«¯çŠ¶æ€æ£€æŸ¥å¤±è´¥: ${response.status}`, 'statusResult');
                }
            } catch (error) {
                log(`åç«¯çŠ¶æ€æ£€æŸ¥å¼‚å¸¸: ${error.message}`, 'statusResult');
            }
        }

        async function simulateDriverOnline() {
            const resultDiv = document.getElementById('onlineResult');
            resultDiv.textContent = '';
            resultDiv.className = 'result-display';
            
            log('ğŸš— æ¨¡æ‹Ÿå¸æœºä¸Šçº¿...', 'onlineResult');
            
            try {
                const response = await fetch('/api/drivers/1/online?latitude=39.044237&longitude=121.749849', {
                    method: 'POST'
                });
                
                if (response.ok) {
                    log('âœ… å¸æœºä¸Šçº¿æˆåŠŸ', 'onlineResult');
                    
                    // æ¨¡æ‹Ÿæ›´æ–°localStorage
                    const driverState = {
                        isOnline: true,
                        currentPosition: { lng: 121.749849, lat: 39.044237 },
                        todayEarnings: 0,
                        completedOrders: 0,
                        currentOrder: null,
                        navigationInfo: null,
                        driverId: 1,
                        timestamp: Date.now()
                    };
                    
                    localStorage.setItem('driverState', JSON.stringify(driverState));
                    localStorage.setItem('driverUserId', '1');
                    
                    log('âœ… æœ¬åœ°çŠ¶æ€å·²æ›´æ–°', 'onlineResult');
                    resultDiv.className = 'result-display status-good';
                } else {
                    log(`âŒ å¸æœºä¸Šçº¿å¤±è´¥: ${response.status}`, 'onlineResult');
                    resultDiv.className = 'result-display status-error';
                }
            } catch (error) {
                log(`âŒ ä¸Šçº¿æ“ä½œå¼‚å¸¸: ${error.message}`, 'onlineResult');
                resultDiv.className = 'result-display status-error';
            }
        }

        async function checkOnlineStatus() {
            log('\\nğŸ” éªŒè¯ä¸Šçº¿çŠ¶æ€...', 'onlineResult');
            
            try {
                // æ£€æŸ¥åç«¯çŠ¶æ€
                const response = await fetch('/api/drivers/1/status-detail');
                if (response.ok) {
                    const result = await response.json();
                    const detail = result.data;
                    
                    if (detail.isOnlineAndFree) {
                        log('âœ… åç«¯ç¡®è®¤å¸æœºåœ¨çº¿', 'onlineResult');
                    } else {
                        log('âŒ åç«¯æ˜¾ç¤ºå¸æœºä¸åœ¨çº¿', 'onlineResult');
                    }
                }
                
                // æ£€æŸ¥æœ¬åœ°çŠ¶æ€
                const driverState = localStorage.getItem('driverState');
                if (driverState) {
                    const state = JSON.parse(driverState);
                    if (state.isOnline) {
                        log('âœ… æœ¬åœ°çŠ¶æ€æ˜¾ç¤ºåœ¨çº¿', 'onlineResult');
                    } else {
                        log('âŒ æœ¬åœ°çŠ¶æ€æ˜¾ç¤ºä¸‹çº¿', 'onlineResult');
                    }
                }
                
            } catch (error) {
                log(`éªŒè¯çŠ¶æ€å¼‚å¸¸: ${error.message}`, 'onlineResult');
            }
        }

        function testLogout() {
            const resultDiv = document.getElementById('logoutResult');
            resultDiv.textContent = '';
            resultDiv.className = 'result-display';
            
            log('ğŸšª æ¨¡æ‹Ÿé€€å‡ºç™»å½•...', 'logoutResult');
            
            // æ¨¡æ‹Ÿé€€å‡ºç™»å½•çš„æ¸…ç†è¿‡ç¨‹
            log('1. è°ƒç”¨å¸æœºä¸‹çº¿API...', 'logoutResult');
            
            fetch('/api/drivers/1/offline', {
                method: 'POST'
            }).then(response => {
                if (response.ok) {
                    log('âœ… å¸æœºä¸‹çº¿APIè°ƒç”¨æˆåŠŸ', 'logoutResult');
                } else {
                    log(`âŒ å¸æœºä¸‹çº¿APIè°ƒç”¨å¤±è´¥: ${response.status}`, 'logoutResult');
                }
            }).catch(error => {
                log(`âŒ å¸æœºä¸‹çº¿APIå¼‚å¸¸: ${error.message}`, 'logoutResult');
            });
            
            log('2. æ¸…é™¤localStorage...', 'logoutResult');
            
            // æ¸…é™¤ç›¸å…³çš„localStorageé¡¹
            localStorage.removeItem('token');
            localStorage.removeItem('driverState');
            localStorage.removeItem('driverUserId');
            localStorage.removeItem('currentOrder');
            localStorage.removeItem('orderStatus');
            localStorage.removeItem('driverInfo');
            localStorage.removeItem('orderUserId');
            
            log('âœ… localStorageå·²æ¸…é™¤', 'logoutResult');
            log('3. å¸æœºstoreçŠ¶æ€åº”è¯¥è¢«æ¸…é™¤', 'logoutResult');
            log('4. WebSocketè¿æ¥åº”è¯¥æ–­å¼€', 'logoutResult');
            
            resultDiv.className = 'result-display status-good';
        }

        async function checkLogoutEffect() {
            log('\\nğŸ” æ£€æŸ¥é€€å‡ºç™»å½•æ•ˆæœ...', 'logoutResult');
            
            // æ£€æŸ¥localStorage
            const driverState = localStorage.getItem('driverState');
            const token = localStorage.getItem('token');
            
            if (!driverState && !token) {
                log('âœ… localStorageå·²æ­£ç¡®æ¸…é™¤', 'logoutResult');
            } else {
                log('âŒ localStorageæ¸…é™¤ä¸å®Œæ•´', 'logoutResult');
                log(`driverStateå­˜åœ¨: ${!!driverState}`, 'logoutResult');
                log(`tokenå­˜åœ¨: ${!!token}`, 'logoutResult');
            }
            
            // æ£€æŸ¥åç«¯çŠ¶æ€
            try {
                const response = await fetch('/api/drivers/1/status-detail');
                if (response.ok) {
                    const result = await response.json();
                    const detail = result.data;
                    
                    if (!detail.isOnlineAndFree) {
                        log('âœ… åç«¯ç¡®è®¤å¸æœºå·²ä¸‹çº¿', 'logoutResult');
                    } else {
                        log('âŒ åç«¯ä»æ˜¾ç¤ºå¸æœºåœ¨çº¿', 'logoutResult');
                    }
                }
            } catch (error) {
                log(`æ£€æŸ¥åç«¯çŠ¶æ€å¼‚å¸¸: ${error.message}`, 'logoutResult');
            }
        }

        function simulateRelogin() {
            const resultDiv = document.getElementById('reloginResult');
            resultDiv.textContent = '';
            resultDiv.className = 'result-display';
            
            log('ğŸ”„ æ¨¡æ‹Ÿé‡æ–°ç™»å½•...', 'reloginResult');
            
            // æ¨¡æ‹Ÿé‡æ–°è®¾ç½®token
            localStorage.setItem('token', 'mock-token-12345');
            log('âœ… Tokenå·²è®¾ç½®', 'reloginResult');
            
            log('2. æ¨¡æ‹ŸçŠ¶æ€æ¢å¤è¿‡ç¨‹...', 'reloginResult');
            log('- æ£€æŸ¥localStorageä¸­çš„å¸æœºçŠ¶æ€', 'reloginResult');
            log('- ä»åç«¯è·å–çœŸå®çŠ¶æ€', 'reloginResult');
            log('- æ¯”è¾ƒå‰åç«¯çŠ¶æ€ä¸€è‡´æ€§', 'reloginResult');
            
            // æ¨¡æ‹ŸçŠ¶æ€æ¢å¤é€»è¾‘
            const driverState = localStorage.getItem('driverState');
            if (!driverState) {
                log('âœ… æœ¬åœ°æ— å¸æœºçŠ¶æ€ï¼Œåº”è¯¥æ˜¾ç¤ºä¸‹çº¿', 'reloginResult');
                resultDiv.className = 'result-display status-good';
            } else {
                log('âš ï¸ æœ¬åœ°ä»æœ‰å¸æœºçŠ¶æ€ï¼Œéœ€è¦éªŒè¯', 'reloginResult');
                resultDiv.className = 'result-display status-warning';
            }
        }

        async function checkStateConsistency() {
            log('\\nğŸ” æ£€æŸ¥çŠ¶æ€ä¸€è‡´æ€§...', 'reloginResult');
            
            try {
                // æ£€æŸ¥åç«¯çŠ¶æ€
                const response = await fetch('/api/drivers/1/status-detail');
                if (response.ok) {
                    const result = await response.json();
                    const detail = result.data;
                    
                    // æ£€æŸ¥æœ¬åœ°çŠ¶æ€
                    const driverState = localStorage.getItem('driverState');
                    
                    log('çŠ¶æ€å¯¹æ¯”:', 'reloginResult');
                    log(`åç«¯åœ¨çº¿: ${detail.isOnlineAndFree}`, 'reloginResult');
                    log(`æœ¬åœ°çŠ¶æ€å­˜åœ¨: ${!!driverState}`, 'reloginResult');
                    
                    if (driverState) {
                        const state = JSON.parse(driverState);
                        log(`æœ¬åœ°åœ¨çº¿: ${state.isOnline}`, 'reloginResult');
                        
                        if (detail.isOnlineAndFree !== state.isOnline) {
                            log('âŒ çŠ¶æ€ä¸ä¸€è‡´ï¼', 'reloginResult');
                            log('ä¿®å¤æ–¹æ¡ˆ: å¼ºåˆ¶åŒæ­¥åˆ°ä¸‹çº¿çŠ¶æ€', 'reloginResult');
                            document.getElementById('reloginResult').className = 'result-display status-error';
                        } else {
                            log('âœ… çŠ¶æ€ä¸€è‡´', 'reloginResult');
                            document.getElementById('reloginResult').className = 'result-display status-good';
                        }
                    } else {
                        if (!detail.isOnlineAndFree) {
                            log('âœ… çŠ¶æ€ä¸€è‡´ï¼ˆéƒ½æ˜¯ä¸‹çº¿ï¼‰', 'reloginResult');
                            document.getElementById('reloginResult').className = 'result-display status-good';
                        } else {
                            log('âŒ çŠ¶æ€ä¸ä¸€è‡´ï¼ˆåç«¯åœ¨çº¿ï¼Œæœ¬åœ°æ— çŠ¶æ€ï¼‰', 'reloginResult');
                            document.getElementById('reloginResult').className = 'result-display status-error';
                        }
                    }
                }
            } catch (error) {
                log(`çŠ¶æ€æ£€æŸ¥å¼‚å¸¸: ${error.message}`, 'reloginResult');
            }
        }

        function checkLocalStorage() {
            const resultDiv = document.getElementById('storageResult');
            resultDiv.textContent = '';
            resultDiv.className = 'result-display';
            
            log('ğŸ—„ï¸ æ£€æŸ¥localStorageçŠ¶æ€...', 'storageResult');
            
            const keys = [
                'token', 'driverState', 'driverUserId', 'currentOrder', 
                'orderStatus', 'driverInfo', 'orderUserId'
            ];
            
            keys.forEach(key => {
                const value = localStorage.getItem(key);
                if (value) {
                    log(`${key}: å­˜åœ¨ (${value.length} å­—ç¬¦)`, 'storageResult');
                    if (key === 'driverState') {
                        try {
                            const state = JSON.parse(value);
                            log(`  - åœ¨çº¿çŠ¶æ€: ${state.isOnline}`, 'storageResult');
                            log(`  - å¸æœºID: ${state.driverId}`, 'storageResult');
                        } catch (e) {
                            log(`  - è§£æå¤±è´¥: ${e.message}`, 'storageResult');
                        }
                    }
                } else {
                    log(`${key}: ä¸å­˜åœ¨`, 'storageResult');
                }
            });
            
            resultDiv.className = 'result-display status-good';
        }

        function clearAllStorage() {
            log('\\nğŸ§¹ æ¸…é™¤æ‰€æœ‰localStorage...', 'storageResult');
            
            const keys = [
                'token', 'driverState', 'driverUserId', 'currentOrder', 
                'orderStatus', 'driverInfo', 'orderUserId'
            ];
            
            keys.forEach(key => {
                localStorage.removeItem(key);
                log(`âœ… å·²æ¸…é™¤: ${key}`, 'storageResult');
            });
            
            log('\\nâœ… æ‰€æœ‰å­˜å‚¨å·²æ¸…é™¤', 'storageResult');
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥çŠ¶æ€
        window.onload = function() {
            setTimeout(() => {
                checkCurrentStatus();
            }, 500);
        };
    </script>
</body>
</html>