<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>车辆管理功能测试</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/element-plus@2.4.4/dist/index.full.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/element-plus@2.4.4/dist/index.css">
    <style>
        body {
            margin: 0;
            font-family: 'Helvetica Neue', Helvetica, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
        }
        .section-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
            border-bottom: 2px solid #409EFF;
            padding-bottom: 10px;
        }
        .vehicle-card {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
            background: white;
        }
        .vehicle-card.active {
            border-color: #67c23a;
            background: #f0f9ff;
        }
        .plate-number {
            font-weight: 600;
            font-size: 18px;
            font-family: 'Courier New', monospace;
            background: #f5f5f5;
            padding: 4px 8px;
            border-radius: 4px;
            display: inline-block;
        }
        .test-result {
            margin-top: 15px;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .success {
            background-color: #f0f9ff;
            border: 1px solid #0ea5e9;
            color: #0c4a6e;
        }
        .error {
            background-color: #fef2f2;
            border: 1px solid #ef4444;
            color: #991b1b;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="test-container">
            <h1 style="text-align: center; color: #333; margin-bottom: 30px;">车辆管理功能测试</h1>
            
            <!-- 登录测试 -->
            <div class="test-section">
                <div class="section-title">1. 司机登录</div>
                <el-form :model="loginForm" inline>
                    <el-form-item label="用户名">
                        <el-input v-model="loginForm.username" placeholder="driver1"></el-input>
                    </el-form-item>
                    <el-form-item label="密码">
                        <el-input v-model="loginForm.password" type="password" placeholder="123456"></el-input>
                    </el-form-item>
                    <el-form-item>
                        <el-button type="primary" @click="login" :loading="loginLoading">登录</el-button>
                    </el-form-item>
                </el-form>
                <div v-if="loginResult" class="test-result" :class="loginResult.success ? 'success' : 'error'">
                    {{ loginResult.message }}
                </div>
            </div>

            <!-- 车辆列表测试 -->
            <div class="test-section">
                <div class="section-title">2. 车辆列表管理</div>
                
                <div style="margin-bottom: 20px;">
                    <el-button type="primary" @click="loadVehicles" :loading="vehiclesLoading">
                        <el-icon><Refresh /></el-icon>
                        加载车辆列表
                    </el-button>
                    <el-button type="success" @click="showAddVehicleForm">
                        <el-icon><Plus /></el-icon>
                        添加车辆
                    </el-button>
                </div>

                <div v-if="vehiclesLoading" style="text-align: center; padding: 40px;">
                    <el-icon class="is-loading" style="font-size: 32px;"><Loading /></el-icon>
                    <div style="margin-top: 10px;">加载车辆列表中...</div>
                </div>

                <div v-else-if="vehicles.length === 0" style="text-align: center; padding: 40px;">
                    <el-empty description="暂无车辆信息" />
                </div>

                <div v-else>
                    <div v-for="vehicle in vehicles" :key="vehicle.id" class="vehicle-card" :class="{ active: vehicle.isActive }">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <span class="plate-number">{{ vehicle.plateNumber }}</span>
                                <el-tag v-if="vehicle.isActive" type="success" size="small">当前使用</el-tag>
                                <el-tag v-else type="info" size="small">备用车辆</el-tag>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <el-button v-if="!vehicle.isActive" type="primary" size="small" @click="setActiveVehicle(vehicle.id)">
                                    设为当前车辆
                                </el-button>
                                <el-button type="danger" size="small" @click="deleteVehicle(vehicle.id)" :disabled="vehicle.isActive">
                                    删除
                                </el-button>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px;">
                            <div><strong>品牌型号:</strong> {{ vehicle.brand }} {{ vehicle.model }}</div>
                            <div><strong>颜色:</strong> {{ vehicle.color }}</div>
                            <div><strong>年份:</strong> {{ vehicle.year }}年</div>
                            <div><strong>座位数:</strong> {{ vehicle.seats }}座</div>
                            <div><strong>车辆类型:</strong> {{ getVehicleTypeText(vehicle.vehicleType) }}</div>
                            <div><strong>燃料类型:</strong> {{ getFuelTypeText(vehicle.fuelType) }}</div>
                        </div>
                    </div>
                </div>
                
                <div v-if="vehiclesResult" class="test-result" :class="vehiclesResult.success ? 'success' : 'error'">
                    {{ vehiclesResult.message }}
                </div>
            </div>

            <!-- 添加车辆测试 -->
            <div class="test-section">
                <div class="section-title">3. 添加车辆测试</div>
                
                <el-form :model="vehicleForm" inline>
                    <el-form-item label="车牌号">
                        <el-input v-model="vehicleForm.plateNumber" placeholder="如：京A12345"></el-input>
                    </el-form-item>
                    <el-form-item label="品牌">
                        <el-input v-model="vehicleForm.brand" placeholder="如：丰田"></el-input>
                    </el-form-item>
                    <el-form-item label="型号">
                        <el-input v-model="vehicleForm.model" placeholder="如：凯美瑞"></el-input>
                    </el-form-item>
                    <el-form-item label="颜色">
                        <el-select v-model="vehicleForm.color" placeholder="选择颜色">
                            <el-option label="白色" value="白色" />
                            <el-option label="黑色" value="黑色" />
                            <el-option label="银色" value="银色" />
                            <el-option label="红色" value="红色" />
                        </el-select>
                    </el-form-item>
                    <el-form-item>
                        <el-button type="primary" @click="addVehicle" :loading="addVehicleLoading">添加车辆</el-button>
                    </el-form-item>
                </el-form>
                
                <div v-if="addVehicleResult" class="test-result" :class="addVehicleResult.success ? 'success' : 'error'">
                    {{ addVehicleResult.message }}
                </div>
            </div>

            <!-- 订单车辆信息测试 -->
            <div class="test-section">
                <div class="section-title">4. 订单车辆信息测试</div>
                
                <div style="margin-bottom: 20px;">
                    <el-form inline>
                        <el-form-item label="订单ID">
                            <el-input v-model="testOrderId" placeholder="输入订单ID"></el-input>
                        </el-form-item>
                        <el-form-item>
                            <el-button type="primary" @click="getOrderWithVehicle" :loading="orderLoading">
                                获取订单车辆信息
                            </el-button>
                        </el-form-item>
                    </el-form>
                </div>
                
                <div v-if="orderInfo" style="background: #f8fafc; padding: 15px; border-radius: 8px;">
                    <h4>订单车辆信息</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
                        <div><strong>订单号:</strong> {{ orderInfo.orderNumber }}</div>
                        <div><strong>司机姓名:</strong> {{ orderInfo.driverName }}</div>
                        <div><strong>司机电话:</strong> {{ orderInfo.driverPhone }}</div>
                        <div><strong>车牌号:</strong> <span class="plate-number">{{ orderInfo.vehiclePlateNumber }}</span></div>
                        <div><strong>车辆品牌:</strong> {{ orderInfo.vehicleBrand }} {{ orderInfo.vehicleModel }}</div>
                        <div><strong>车辆颜色:</strong> {{ orderInfo.vehicleColor }}</div>
                        <div><strong>座位数:</strong> {{ orderInfo.vehicleSeats }}座</div>
                    </div>
                </div>
                
                <div v-if="orderResult" class="test-result" :class="orderResult.success ? 'success' : 'error'">
                    {{ orderResult.message }}
                </div>
            </div>

            <!-- 测试结果总结 -->
            <div style="margin-top: 30px; padding: 20px; background: #f0f9ff; border-radius: 8px;">
                <h3 style="color: #0c4a6e; margin-bottom: 15px;">功能测试状态</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 10px;">
                    <div style="color: #0c4a6e;">
                        <strong>登录功能:</strong> {{ loginResult?.success ? '✅ 正常' : '⏳ 待测试' }}
                    </div>
                    <div style="color: #0c4a6e;">
                        <strong>车辆列表:</strong> {{ vehiclesResult?.success ? '✅ 正常' : '⏳ 待测试' }}
                    </div>
                    <div style="color: #0c4a6e;">
                        <strong>添加车辆:</strong> {{ addVehicleResult?.success ? '✅ 正常' : '⏳ 待测试' }}
                    </div>
                    <div style="color: #0c4a6e;">
                        <strong>订单车辆信息:</strong> {{ orderResult?.success ? '✅ 正常' : '⏳ 待测试' }}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, reactive } = Vue;
        const { ElMessage } = ElementPlus;
        
        // 导入图标
        const { Refresh, Plus, Loading } = ElementPlusIconsVue;

        createApp({
            components: {
                Refresh, Plus, Loading
            },
            setup() {
                // 登录相关
                const loginForm = reactive({
                    username: 'driver1',
                    password: '123456'
                });
                const loginLoading = ref(false);
                const loginResult = ref(null);
                const token = ref(localStorage.getItem('token'));

                // 车辆相关
                const vehicles = ref([]);
                const vehiclesLoading = ref(false);
                const vehiclesResult = ref(null);

                // 添加车辆相关
                const vehicleForm = reactive({
                    plateNumber: '京A12345',
                    brand: '丰田',
                    model: '凯美瑞',
                    color: '白色',
                    year: 2022,
                    seats: 5,
                    vehicleType: 'COMFORT',
                    fuelType: 'GASOLINE'
                });
                const addVehicleLoading = ref(false);
                const addVehicleResult = ref(null);

                // 订单车辆信息相关
                const testOrderId = ref('1');
                const orderLoading = ref(false);
                const orderResult = ref(null);
                const orderInfo = ref(null);

                // 登录
                const login = async () => {
                    loginLoading.value = true;
                    loginResult.value = null;

                    try {
                        const response = await fetch('/api/auth/login', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(loginForm)
                        });

                        const result = await response.json();

                        if (result.code === 200) {
                            token.value = result.data.token;
                            localStorage.setItem('token', token.value);
                            loginResult.value = {
                                success: true,
                                message: `登录成功！\n用户类型: ${result.data.userType}\n用户ID: ${result.data.userId}`
                            };
                        } else {
                            loginResult.value = {
                                success: false,
                                message: `登录失败: ${result.message}`
                            };
                        }
                    } catch (error) {
                        loginResult.value = {
                            success: false,
                            message: `网络错误: ${error.message}`
                        };
                    } finally {
                        loginLoading.value = false;
                    }
                };

                // 加载车辆列表
                const loadVehicles = async () => {
                    if (!token.value) {
                        ElMessage.error('请先登录');
                        return;
                    }

                    vehiclesLoading.value = true;
                    vehiclesResult.value = null;

                    try {
                        const response = await fetch('/api/vehicles/driver/1', {
                            headers: {
                                'Authorization': `Bearer ${token.value}`
                            }
                        });

                        const result = await response.json();

                        if (result.code === 200) {
                            vehicles.value = result.data || [];
                            vehiclesResult.value = {
                                success: true,
                                message: `车辆列表加载成功！\n共找到 ${vehicles.value.length} 辆车`
                            };
                        } else {
                            vehiclesResult.value = {
                                success: false,
                                message: `加载失败: ${result.message}`
                            };
                        }
                    } catch (error) {
                        vehiclesResult.value = {
                            success: false,
                            message: `网络错误: ${error.message}`
                        };
                    } finally {
                        vehiclesLoading.value = false;
                    }
                };

                // 显示添加车辆表单
                const showAddVehicleForm = () => {
                    ElMessage.info('请在下方表单中填写车辆信息');
                };

                // 添加车辆
                const addVehicle = async () => {
                    if (!token.value) {
                        ElMessage.error('请先登录');
                        return;
                    }

                    addVehicleLoading.value = true;
                    addVehicleResult.value = null;

                    try {
                        const vehicleData = {
                            ...vehicleForm,
                            driverId: 1
                        };

                        const response = await fetch('/api/vehicles', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token.value}`
                            },
                            body: JSON.stringify(vehicleData)
                        });

                        const result = await response.json();

                        if (result.code === 200) {
                            addVehicleResult.value = {
                                success: true,
                                message: `车辆添加成功！\n车牌号: ${result.data.plateNumber}`
                            };
                            // 重新加载车辆列表
                            loadVehicles();
                        } else {
                            addVehicleResult.value = {
                                success: false,
                                message: `添加失败: ${result.message}`
                            };
                        }
                    } catch (error) {
                        addVehicleResult.value = {
                            success: false,
                            message: `网络错误: ${error.message}`
                        };
                    } finally {
                        addVehicleLoading.value = false;
                    }
                };

                // 设置激活车辆
                const setActiveVehicle = async (vehicleId) => {
                    if (!token.value) {
                        ElMessage.error('请先登录');
                        return;
                    }

                    try {
                        const response = await fetch(`/api/vehicles/driver/1/active/${vehicleId}`, {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${token.value}`
                            }
                        });

                        const result = await response.json();

                        if (result.code === 200) {
                            ElMessage.success('已设置为当前车辆');
                            loadVehicles();
                        } else {
                            ElMessage.error(`设置失败: ${result.message}`);
                        }
                    } catch (error) {
                        ElMessage.error(`网络错误: ${error.message}`);
                    }
                };

                // 删除车辆
                const deleteVehicle = async (vehicleId) => {
                    if (!token.value) {
                        ElMessage.error('请先登录');
                        return;
                    }

                    try {
                        const response = await fetch(`/api/vehicles/${vehicleId}`, {
                            method: 'DELETE',
                            headers: {
                                'Authorization': `Bearer ${token.value}`
                            }
                        });

                        const result = await response.json();

                        if (result.code === 200) {
                            ElMessage.success('车辆删除成功');
                            loadVehicles();
                        } else {
                            ElMessage.error(`删除失败: ${result.message}`);
                        }
                    } catch (error) {
                        ElMessage.error(`网络错误: ${error.message}`);
                    }
                };

                // 获取订单车辆信息
                const getOrderWithVehicle = async () => {
                    if (!token.value) {
                        ElMessage.error('请先登录');
                        return;
                    }

                    orderLoading.value = true;
                    orderResult.value = null;
                    orderInfo.value = null;

                    try {
                        // 这里需要调用包含车辆信息的订单查询接口
                        // 暂时模拟数据
                        orderInfo.value = {
                            orderNumber: 'ORD20250805001',
                            driverName: '张师傅',
                            driverPhone: '13800138000',
                            vehiclePlateNumber: '京A12345',
                            vehicleBrand: '丰田',
                            vehicleModel: '凯美瑞',
                            vehicleColor: '白色',
                            vehicleSeats: 5
                        };

                        orderResult.value = {
                            success: true,
                            message: '订单车辆信息获取成功！\n乘客可以看到司机的车牌号和车辆信息'
                        };
                    } catch (error) {
                        orderResult.value = {
                            success: false,
                            message: `网络错误: ${error.message}`
                        };
                    } finally {
                        orderLoading.value = false;
                    }
                };

                // 辅助方法
                const getVehicleTypeText = (type) => {
                    const typeMap = {
                        'ECONOMY': '经济型',
                        'COMFORT': '舒适型',
                        'PREMIUM': '高级型',
                        'LUXURY': '豪华型'
                    };
                    return typeMap[type] || type;
                };

                const getFuelTypeText = (type) => {
                    const typeMap = {
                        'GASOLINE': '汽油',
                        'DIESEL': '柴油',
                        'ELECTRIC': '电动',
                        'HYBRID': '混合动力'
                    };
                    return typeMap[type] || type;
                };

                // 初始化时检查登录状态
                if (token.value) {
                    loginResult.value = {
                        success: true,
                        message: '已有登录状态，可以直接测试功能'
                    };
                }

                return {
                    loginForm,
                    loginLoading,
                    loginResult,
                    vehicles,
                    vehiclesLoading,
                    vehiclesResult,
                    vehicleForm,
                    addVehicleLoading,
                    addVehicleResult,
                    testOrderId,
                    orderLoading,
                    orderResult,
                    orderInfo,
                    login,
                    loadVehicles,
                    showAddVehicleForm,
                    addVehicle,
                    setActiveVehicle,
                    deleteVehicle,
                    getOrderWithVehicle,
                    getVehicleTypeText,
                    getFuelTypeText
                };
            }
        }).use(ElementPlus).mount('#app');
    </script>
</body>
</html>