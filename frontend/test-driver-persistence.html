<!DOCTYPE html>
<html lang=\"zh-CN\">
<head>
    <meta charset=\"UTF-8\">
    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">
    <title>司机端状态持久化测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #333;
        }
        button {
            background: #409EFF;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #66b1ff;
        }
        button.success {
            background: #67c23a;
        }
        button.warning {
            background: #e6a23c;
        }
        button.danger {
            background: #f56c6c;
        }
        .status-display {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 14px;
            white-space: pre-wrap;
        }
        .status-good {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .status-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .feature-list {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .test-scenario {
            background: #fff3e0;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 4px solid #ff9800;
        }
    </style>
</head>
<body>
    <div class=\"container\">
        <h1>🚗 司机端状态持久化测试</h1>
        <p>测试司机端切换页面后订单状态不会消失的功能</p>
    </div>

    <div class=\"container\">
        <div class=\"test-section\">
            <h3>1. 功能特性</h3>
            <div class=\"feature-list\">
                <h4>✅ 已实现的功能：</h4>
                <ul>
                    <li><strong>司机状态持久化</strong>: 在线状态、位置信息、收入统计</li>
                    <li><strong>订单状态持久化</strong>: 当前订单、待处理订单队列</li>
                    <li><strong>导航信息持久化</strong>: 导航状态和路线信息</li>
                    <li><strong>WebSocket自动重连</strong>: 页面重新加载时自动重新建立连接</li>
                    <li><strong>用户隔离</strong>: 不同司机的状态完全隔离</li>
                    <li><strong>状态过期机制</strong>: 24小时后自动清除过期状态</li>
                </ul>
            </div>
        </div>

        <div class=\"test-section\">
            <h3>2. 数据结构</h3>
            <div class=\"status-display\">
司机状态数据结构:
{
  driverId: 司机ID,
  isOnline: 在线状态,
  currentPosition: { lng: 经度, lat: 纬度 },
  todayEarnings: 今日收入,
  completedOrders: 完成订单数,
  currentOrder: {
    id: 订单ID,
    orderNumber: 订单号,
    status: 订单状态,
    pickupAddress: 上车地址,
    destinationAddress: 目的地地址,
    // ... 其他订单信息
  },
  navigationInfo: 导航信息,
  timestamp: 保存时间戳
}
            </div>
        </div>

        <div class=\"test-section\">
            <h3>3. 测试场景</h3>
            
            <div class=\"test-scenario\">
                <h4>场景1: 司机上线状态持久化</h4>
                <ol>
                    <li>司机登录并上线</li>
                    <li>切换到其他页面或刷新页面</li>
                    <li>重新进入司机地图页面</li>
                    <li>预期结果: 司机仍然显示为在线状态</li>
                </ol>
            </div>

            <div class=\"test-scenario\">
                <h4>场景2: 进行中订单持久化</h4>
                <ol>
                    <li>司机接单并开始执行订单</li>
                    <li>订单状态为ASSIGNED、PICKUP或IN_PROGRESS</li>
                    <li>切换页面或刷新浏览器</li>
                    <li>重新进入司机地图页面</li>
                    <li>预期结果: 当前订单信息完整恢复，WebSocket自动重连</li>
                </ol>
            </div>

            <div class=\"test-scenario\">
                <h4>场景3: 待处理订单队列</h4>
                <ol>
                    <li>司机在线，收到多个新订单推送</li>
                    <li>订单在倒计时队列中</li>
                    <li>切换页面后重新进入</li>
                    <li>预期结果: 待处理订单队列恢复（注意：倒计时会重置）</li>
                </ol>
            </div>

            <div class=\"test-scenario\">
                <h4>场景4: 用户隔离测试</h4>
                <ol>
                    <li>司机A登录并设置状态</li>
                    <li>登出司机A，登录司机B</li>
                    <li>司机B进入地图页面</li>
                    <li>预期结果: 司机B看不到司机A的任何状态信息</li>
                </ol>
            </div>
        </div>

        <div class=\"test-section\">
            <h3>4. WebSocket重连机制</h3>
            <div class=\"status-display\">
WebSocket重连逻辑:

1. 页面加载时检查司机状态
2. 如果司机在线 OR 有进行中的订单
3. 自动建立WebSocket连接
4. 订阅司机专用消息队列: /user/{driverId}/queue/orders
5. 处理订单推送、状态变化等消息

连接时机:
- 司机上线时
- 页面重新加载且有进行中订单时
- 状态恢复后检测到需要连接时
            </div>
        </div>

        <div class=\"test-section\">
            <h3>5. 调试命令</h3>
            <p>在浏览器控制台执行以下命令来调试状态持久化：</p>
            
            <div class=\"status-display\">
// 检查localStorage中的司机状态
console.log(\"司机状态:\", JSON.parse(localStorage.getItem('driverState') || '{}'));
console.log(\"司机用户ID:\", localStorage.getItem('driverUserId'));

// 检查当前store状态
if (window.driverStore) {
    console.log(\"在线状态:\", window.driverStore.isOnline);
    console.log(\"当前订单:\", window.driverStore.currentOrder);
    console.log(\"待处理订单:\", window.driverStore.pendingOrders);
}

// 手动触发状态保存
if (window.driverStore) {
    window.driverStore.saveDriverState();
    console.log(\"状态已保存\");
}

// 手动触发状态恢复
if (window.driverStore) {
    window.driverStore.restoreDriverState();
    console.log(\"状态已恢复\");
}

// 清除所有状态（测试用）
if (window.driverStore) {
    window.driverStore.clearDriverState();
    console.log(\"状态已清除\");
}
            </div>
            <button onclick=\"copyToClipboard(this.previousElementSibling.textContent)\">复制调试命令</button>
        </div>

        <div class=\"test-section\">
            <h3>6. 预期效果</h3>
            <div class=\"status-display status-good\">
✅ 司机端状态持久化应该实现：

1. 页面刷新后司机在线状态保持
2. 进行中的订单信息完整恢复
3. 导航状态和路线信息恢复
4. WebSocket连接自动重新建立
5. 今日收入和完成订单数保持
6. 不同司机之间状态完全隔离
7. 过期状态自动清理（24小时）

如果以上功能正常工作，说明司机端状态持久化实现成功！
            </div>
        </div>
    </div>

    <div class=\"container\">
        <h3>🔧 技术实现</h3>
        <div class=\"status-display\">
技术架构:

1. Pinia Store (stores/driver.js)
   - 集中管理司机状态
   - 提供状态持久化方法
   - 处理WebSocket连接管理

2. localStorage持久化
   - 保存司机状态到本地存储
   - 用户ID隔离机制
   - 状态过期检查

3. 组件集成 (DriverMap.vue)
   - 使用computed属性绑定store状态
   - onMounted时恢复状态
   - onUnmounted时清理资源

4. WebSocket管理
   - 自动重连机制
   - 消息路由和处理
   - 全局函数通信机制
        </div>
    </div>

    <script>
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('调试命令已复制到剪贴板！');
            }).catch(err => {
                console.error('复制失败:', err);
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('调试命令已复制到剪贴板！');
            });
        }

        window.onload = function() {
            console.log('🚗 司机端状态持久化测试页面已加载');
            console.log('请按照测试场景进行功能验证');
        };
    </script>
</body>
</html>"