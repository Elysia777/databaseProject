<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>订单状态调试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .debug-section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .debug-section h3 {
            margin-top: 0;
            color: #333;
        }
        button {
            background: #409EFF;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #66b1ff;
        }
        button.danger {
            background: #f56c6c;
        }
        button.success {
            background: #67c23a;
        }
        .result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
            background: #f8f9fa;
            border-left: 4px solid #409EFF;
        }
        .error {
            border-left-color: #f56c6c;
            background: #fef0f0;
        }
        .success {
            border-left-color: #67c23a;
            background: #f0f9ff;
        }
        .debug-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 14px;
            white-space: pre-wrap;
        }
        .api-test {
            background: #fff3cd;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        input {
            padding: 8px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 200px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🐛 订单状态调试工具</h1>
        <p>诊断"没有未支付以及进行中的订单登入的时候还是显示行程进行中"的问题</p>
    </div>

    <div class="container">
        <div class="debug-section">
            <h3>1. 用户信息检查</h3>
            <p>检查当前用户的基本信息：</p>
            <input type="number" id="userIdInput" placeholder="输入用户ID" value="1">
            <button onclick="checkUserInfo()">检查用户信息</button>
            <div id="userInfoResult" class="debug-info">用户信息将在这里显示...</div>
        </div>

        <div class="debug-section">
            <h3>2. localStorage状态检查</h3>
            <p>检查localStorage中的订单相关数据：</p>
            <button onclick="checkLocalStorage()">检查localStorage</button>
            <button onclick="clearLocalStorage()" class="danger">清除localStorage</button>
            <div id="localStorageResult" class="debug-info">localStorage内容将在这里显示...</div>
        </div>

        <div class="debug-section">
            <h3>3. 后端API测试</h3>
            <p>直接测试后端API接口：</p>
            <div class="api-test">
                <h4>测试获取当前订单API</h4>
                <input type="number" id="passengerIdInput" placeholder="乘客ID" value="1">
                <button onclick="testCurrentOrderAPI()">测试 /api/orders/passenger/{id}/current</button>
                <div id="currentOrderAPIResult" class="debug-info">API结果将在这里显示...</div>
            </div>
            
            <div class="api-test">
                <h4>测试未支付订单API</h4>
                <button onclick="testUnpaidOrdersAPI()">测试 /api/orders/unpaid</button>
                <div id="unpaidOrdersAPIResult" class="debug-info">API结果将在这里显示...</div>
            </div>
        </div>

        <div class="debug-section">
            <h3>4. 数据库订单查询</h3>
            <p>查询数据库中的订单数据：</p>
            <button onclick="queryUserOrders()">查询用户所有订单</button>
            <button onclick="queryActiveOrders()">查询活跃订单</button>
            <div id="databaseResult" class="debug-info">数据库查询结果将在这里显示...</div>
        </div>

        <div class="debug-section">
            <h3>5. 状态重置测试</h3>
            <p>测试各种状态重置场景：</p>
            <button onclick="simulateLogin()">模拟用户登录</button>
            <button onclick="simulateLogout()" class="danger">模拟用户登出</button>
            <button onclick="simulatePageRefresh()">模拟页面刷新</button>
            <div id="resetTestResult" class="result" style="display:none;"></div>
        </div>
    </div>

    <div class="container">
        <h3>📋 调试日志</h3>
        <div id="debugLog" style="background: #f8f9fa; padding: 15px; border-radius: 5px; font-family: monospace; font-size: 12px; max-height: 500px; overflow-y: auto;"></div>
    </div>

    <script>
        function log(message, type = 'info') {
            const logDiv = document.getElementById('debugLog');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}\n`;
            logDiv.textContent += logEntry;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(logEntry);
        }

        function showResult(elementId, message, isError = false) {
            const element = document.getElementById(elementId);
            element.style.display = 'block';
            element.textContent = message;
            element.className = isError ? 'result error' : 'result success';
        }

        function checkUserInfo() {
            const userId = document.getElementById('userIdInput').value;
            log(`检查用户信息: ID=${userId}`);
            
            // 模拟用户信息
            const mockUser = {
                id: parseInt(userId),
                passengerId: parseInt(userId),
                realName: `测试用户${userId}`,
                phone: `1380013800${userId}`,
                userType: 'PASSENGER'
            };
            
            const userInfo = `用户信息:
ID: ${mockUser.id}
乘客ID: ${mockUser.passengerId}
姓名: ${mockUser.realName}
电话: ${mockUser.phone}
类型: ${mockUser.userType}
登录状态: 已登录
Token: test-token-${userId}`;
            
            document.getElementById('userInfoResult').textContent = userInfo;
            log(`用户信息检查完成: ${mockUser.realName}`);
        }

        function checkLocalStorage() {
            log('检查localStorage状态');
            
            const keys = [
                'currentOrder',
                'orderStatus', 
                'driverInfo',
                'orderUserId',
                'token'
            ];
            
            let content = 'localStorage内容:\n';
            let hasOrderData = false;
            
            keys.forEach(key => {
                const value = localStorage.getItem(key);
                if (value) {
                    content += `${key}: ${value}\n`;
                    if (key.includes('order') || key.includes('driver')) {
                        hasOrderData = true;
                    }
                } else {
                    content += `${key}: null\n`;
                }
            });
            
            if (hasOrderData) {
                content += '\n⚠️ 发现订单相关数据，可能导致状态显示问题';
            } else {
                content += '\n✅ 没有订单相关数据';
            }
            
            document.getElementById('localStorageResult').textContent = content;
            log('localStorage检查完成');
        }

        function clearLocalStorage() {
            log('清除localStorage');
            
            const orderKeys = [
                'currentOrder',
                'orderStatus',
                'driverInfo', 
                'orderUserId'
            ];
            
            orderKeys.forEach(key => {
                localStorage.removeItem(key);
            });
            
            checkLocalStorage();
            showResult('resetTestResult', '✅ localStorage已清除');
            log('localStorage清除完成');
        }

        async function testCurrentOrderAPI() {
            const passengerId = document.getElementById('passengerIdInput').value;
            log(`测试当前订单API: passengerId=${passengerId}`);
            
            try {
                const response = await fetch(`/api/orders/passenger/${passengerId}/current`, {
                    headers: {
                        'Authorization': 'Bearer test-token'
                    }
                });
                
                log(`API响应状态: ${response.status}`);
                
                if (response.ok) {
                    const result = await response.json();
                    log(`API响应数据: ${JSON.stringify(result)}`);
                    
                    let content = `API响应 (${response.status}):
${JSON.stringify(result, null, 2)}

分析:`;
                    
                    if (result.code === 200) {
                        if (result.data) {
                            content += `\n✅ 找到进行中的订单: ${result.data.id}`;
                            content += `\n📊 订单状态: ${result.data.status}`;
                            content += `\n🆔 订单乘客ID: ${result.data.passengerId}`;
                        } else {
                            content += `\n✅ 没有进行中的订单 (正常)`;
                        }
                    } else {
                        content += `\n❌ API返回错误: ${result.message}`;
                    }
                    
                    document.getElementById('currentOrderAPIResult').textContent = content;
                } else {
                    const errorText = await response.text();
                    log(`API错误: ${errorText}`, 'error');
                    document.getElementById('currentOrderAPIResult').textContent = `API错误 (${response.status}):
${errorText}`;
                }
            } catch (error) {
                log(`API调用异常: ${error.message}`, 'error');
                document.getElementById('currentOrderAPIResult').textContent = `调用异常: ${error.message}`;
            }
        }

        async function testUnpaidOrdersAPI() {
            const passengerId = document.getElementById('passengerIdInput').value;
            log(`测试未支付订单API: passengerId=${passengerId}`);
            
            try {
                const response = await fetch(`/api/orders/unpaid?passengerId=${passengerId}`, {
                    headers: {
                        'Authorization': 'Bearer test-token'
                    }
                });
                
                log(`未支付订单API响应状态: ${response.status}`);
                
                if (response.ok) {
                    const result = await response.json();
                    log(`未支付订单API响应: ${JSON.stringify(result)}`);
                    
                    let content = `未支付订单API响应 (${response.status}):
${JSON.stringify(result, null, 2)}

分析:`;
                    
                    if (result.code === 200) {
                        const unpaidCount = result.data ? result.data.length : 0;
                        content += `\n📋 未支付订单数量: ${unpaidCount}`;
                        if (unpaidCount > 0) {
                            content += `\n⚠️ 有未支付订单，可能影响下单`;
                        } else {
                            content += `\n✅ 没有未支付订单`;
                        }
                    } else {
                        content += `\n❌ API返回错误: ${result.message}`;
                    }
                    
                    document.getElementById('unpaidOrdersAPIResult').textContent = content;
                } else {
                    const errorText = await response.text();
                    document.getElementById('unpaidOrdersAPIResult').textContent = `API错误 (${response.status}):
${errorText}`;
                }
            } catch (error) {
                log(`未支付订单API异常: ${error.message}`, 'error');
                document.getElementById('unpaidOrdersAPIResult').textContent = `调用异常: ${error.message}`;
            }
        }

        function queryUserOrders() {
            const passengerId = document.getElementById('passengerIdInput').value;
            log(`查询用户所有订单: passengerId=${passengerId}`);
            
            // 模拟数据库查询结果
            const mockOrders = [
                {
                    id: 1,
                    orderNumber: 'ORDER001',
                    status: 'COMPLETED',
                    paymentStatus: 'PAID',
                    passengerId: parseInt(passengerId),
                    createdAt: '2025-01-26 10:00:00'
                },
                {
                    id: 2,
                    orderNumber: 'ORDER002', 
                    status: 'COMPLETED',
                    paymentStatus: 'UNPAID',
                    passengerId: parseInt(passengerId),
                    createdAt: '2025-01-27 09:00:00'
                }
            ];
            
            let content = `用户 ${passengerId} 的所有订单:
${JSON.stringify(mockOrders, null, 2)}

分析:`;
            
            const activeOrders = mockOrders.filter(order => 
                ['PENDING', 'ASSIGNED', 'PICKUP', 'IN_PROGRESS'].includes(order.status)
            );
            
            const unpaidOrders = mockOrders.filter(order => 
                order.status === 'COMPLETED' && order.paymentStatus === 'UNPAID'
            );
            
            content += `\n📊 总订单数: ${mockOrders.length}`;
            content += `\n🔄 活跃订单数: ${activeOrders.length}`;
            content += `\n💰 未支付订单数: ${unpaidOrders.length}`;
            
            if (activeOrders.length === 0 && unpaidOrders.length === 0) {
                content += `\n✅ 用户状态正常，不应该显示进行中订单`;
            } else {
                content += `\n⚠️ 用户有活跃或未支付订单`;
            }
            
            document.getElementById('databaseResult').textContent = content;
            log('数据库查询完成');
        }

        function queryActiveOrders() {
            log('查询所有活跃订单');
            
            // 模拟查询活跃订单
            const mockActiveOrders = [];
            
            let content = `所有活跃订单:
${JSON.stringify(mockActiveOrders, null, 2)}

分析:
📊 活跃订单总数: ${mockActiveOrders.length}`;
            
            if (mockActiveOrders.length === 0) {
                content += `\n✅ 系统中没有活跃订单`;
            } else {
                content += `\n⚠️ 系统中有活跃订单`;
            }
            
            document.getElementById('databaseResult').textContent = content;
            log('活跃订单查询完成');
        }

        function simulateLogin() {
            log('模拟用户登录流程');
            
            // 清除旧数据
            clearLocalStorage();
            
            // 模拟登录
            const userId = document.getElementById('userIdInput').value;
            localStorage.setItem('token', `test-token-${userId}`);
            
            // 模拟初始化订单状态
            setTimeout(() => {
                checkLocalStorage();
                showResult('resetTestResult', '✅ 用户登录模拟完成');
                log('用户登录模拟完成');
            }, 500);
        }

        function simulateLogout() {
            log('模拟用户登出流程');
            
            // 清除所有数据
            localStorage.clear();
            
            checkLocalStorage();
            showResult('resetTestResult', '✅ 用户登出模拟完成');
            log('用户登出模拟完成');
        }

        function simulatePageRefresh() {
            log('模拟页面刷新');
            
            // 检查刷新前的状态
            checkLocalStorage();
            
            // 模拟页面刷新后的状态恢复
            setTimeout(() => {
                log('页面刷新后状态恢复');
                checkLocalStorage();
                showResult('resetTestResult', '✅ 页面刷新模拟完成');
            }, 1000);
        }

        // 页面加载时的初始化
        window.onload = function() {
            log('订单状态调试工具已加载');
            checkUserInfo();
            checkLocalStorage();
            log('调试说明:');
            log('1. 检查用户信息和localStorage状态');
            log('2. 测试后端API接口响应');
            log('3. 查询数据库中的订单数据');
            log('4. 模拟各种状态重置场景');
        };
    </script>
</body>
</html>