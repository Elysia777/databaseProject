<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è®¢å•çŠ¶æ€è°ƒè¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .debug-section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .debug-section h3 {
            margin-top: 0;
            color: #333;
        }
        button {
            background: #409EFF;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #66b1ff;
        }
        button.danger {
            background: #f56c6c;
        }
        button.success {
            background: #67c23a;
        }
        .result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
            background: #f8f9fa;
            border-left: 4px solid #409EFF;
        }
        .error {
            border-left-color: #f56c6c;
            background: #fef0f0;
        }
        .success {
            border-left-color: #67c23a;
            background: #f0f9ff;
        }
        .debug-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 14px;
            white-space: pre-wrap;
        }
        .api-test {
            background: #fff3cd;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        input {
            padding: 8px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 200px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ› è®¢å•çŠ¶æ€è°ƒè¯•å·¥å…·</h1>
        <p>è¯Šæ–­"æ²¡æœ‰æœªæ”¯ä»˜ä»¥åŠè¿›è¡Œä¸­çš„è®¢å•ç™»å…¥çš„æ—¶å€™è¿˜æ˜¯æ˜¾ç¤ºè¡Œç¨‹è¿›è¡Œä¸­"çš„é—®é¢˜</p>
    </div>

    <div class="container">
        <div class="debug-section">
            <h3>1. ç”¨æˆ·ä¿¡æ¯æ£€æŸ¥</h3>
            <p>æ£€æŸ¥å½“å‰ç”¨æˆ·çš„åŸºæœ¬ä¿¡æ¯ï¼š</p>
            <input type="number" id="userIdInput" placeholder="è¾“å…¥ç”¨æˆ·ID" value="1">
            <button onclick="checkUserInfo()">æ£€æŸ¥ç”¨æˆ·ä¿¡æ¯</button>
            <div id="userInfoResult" class="debug-info">ç”¨æˆ·ä¿¡æ¯å°†åœ¨è¿™é‡Œæ˜¾ç¤º...</div>
        </div>

        <div class="debug-section">
            <h3>2. localStorageçŠ¶æ€æ£€æŸ¥</h3>
            <p>æ£€æŸ¥localStorageä¸­çš„è®¢å•ç›¸å…³æ•°æ®ï¼š</p>
            <button onclick="checkLocalStorage()">æ£€æŸ¥localStorage</button>
            <button onclick="clearLocalStorage()" class="danger">æ¸…é™¤localStorage</button>
            <div id="localStorageResult" class="debug-info">localStorageå†…å®¹å°†åœ¨è¿™é‡Œæ˜¾ç¤º...</div>
        </div>

        <div class="debug-section">
            <h3>3. åç«¯APIæµ‹è¯•</h3>
            <p>ç›´æ¥æµ‹è¯•åç«¯APIæ¥å£ï¼š</p>
            <div class="api-test">
                <h4>æµ‹è¯•è·å–å½“å‰è®¢å•API</h4>
                <input type="number" id="passengerIdInput" placeholder="ä¹˜å®¢ID" value="1">
                <button onclick="testCurrentOrderAPI()">æµ‹è¯• /api/orders/passenger/{id}/current</button>
                <div id="currentOrderAPIResult" class="debug-info">APIç»“æœå°†åœ¨è¿™é‡Œæ˜¾ç¤º...</div>
            </div>
            
            <div class="api-test">
                <h4>æµ‹è¯•æœªæ”¯ä»˜è®¢å•API</h4>
                <button onclick="testUnpaidOrdersAPI()">æµ‹è¯• /api/orders/unpaid</button>
                <div id="unpaidOrdersAPIResult" class="debug-info">APIç»“æœå°†åœ¨è¿™é‡Œæ˜¾ç¤º...</div>
            </div>
        </div>

        <div class="debug-section">
            <h3>4. æ•°æ®åº“è®¢å•æŸ¥è¯¢</h3>
            <p>æŸ¥è¯¢æ•°æ®åº“ä¸­çš„è®¢å•æ•°æ®ï¼š</p>
            <button onclick="queryUserOrders()">æŸ¥è¯¢ç”¨æˆ·æ‰€æœ‰è®¢å•</button>
            <button onclick="queryActiveOrders()">æŸ¥è¯¢æ´»è·ƒè®¢å•</button>
            <div id="databaseResult" class="debug-info">æ•°æ®åº“æŸ¥è¯¢ç»“æœå°†åœ¨è¿™é‡Œæ˜¾ç¤º...</div>
        </div>

        <div class="debug-section">
            <h3>5. çŠ¶æ€é‡ç½®æµ‹è¯•</h3>
            <p>æµ‹è¯•å„ç§çŠ¶æ€é‡ç½®åœºæ™¯ï¼š</p>
            <button onclick="simulateLogin()">æ¨¡æ‹Ÿç”¨æˆ·ç™»å½•</button>
            <button onclick="simulateLogout()" class="danger">æ¨¡æ‹Ÿç”¨æˆ·ç™»å‡º</button>
            <button onclick="simulatePageRefresh()">æ¨¡æ‹Ÿé¡µé¢åˆ·æ–°</button>
            <div id="resetTestResult" class="result" style="display:none;"></div>
        </div>
    </div>

    <div class="container">
        <h3>ğŸ“‹ è°ƒè¯•æ—¥å¿—</h3>
        <div id="debugLog" style="background: #f8f9fa; padding: 15px; border-radius: 5px; font-family: monospace; font-size: 12px; max-height: 500px; overflow-y: auto;"></div>
    </div>

    <script>
        function log(message, type = 'info') {
            const logDiv = document.getElementById('debugLog');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}\n`;
            logDiv.textContent += logEntry;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(logEntry);
        }

        function showResult(elementId, message, isError = false) {
            const element = document.getElementById(elementId);
            element.style.display = 'block';
            element.textContent = message;
            element.className = isError ? 'result error' : 'result success';
        }

        function checkUserInfo() {
            const userId = document.getElementById('userIdInput').value;
            log(`æ£€æŸ¥ç”¨æˆ·ä¿¡æ¯: ID=${userId}`);
            
            // æ¨¡æ‹Ÿç”¨æˆ·ä¿¡æ¯
            const mockUser = {
                id: parseInt(userId),
                passengerId: parseInt(userId),
                realName: `æµ‹è¯•ç”¨æˆ·${userId}`,
                phone: `1380013800${userId}`,
                userType: 'PASSENGER'
            };
            
            const userInfo = `ç”¨æˆ·ä¿¡æ¯:
ID: ${mockUser.id}
ä¹˜å®¢ID: ${mockUser.passengerId}
å§“å: ${mockUser.realName}
ç”µè¯: ${mockUser.phone}
ç±»å‹: ${mockUser.userType}
ç™»å½•çŠ¶æ€: å·²ç™»å½•
Token: test-token-${userId}`;
            
            document.getElementById('userInfoResult').textContent = userInfo;
            log(`ç”¨æˆ·ä¿¡æ¯æ£€æŸ¥å®Œæˆ: ${mockUser.realName}`);
        }

        function checkLocalStorage() {
            log('æ£€æŸ¥localStorageçŠ¶æ€');
            
            const keys = [
                'currentOrder',
                'orderStatus', 
                'driverInfo',
                'orderUserId',
                'token'
            ];
            
            let content = 'localStorageå†…å®¹:\n';
            let hasOrderData = false;
            
            keys.forEach(key => {
                const value = localStorage.getItem(key);
                if (value) {
                    content += `${key}: ${value}\n`;
                    if (key.includes('order') || key.includes('driver')) {
                        hasOrderData = true;
                    }
                } else {
                    content += `${key}: null\n`;
                }
            });
            
            if (hasOrderData) {
                content += '\nâš ï¸ å‘ç°è®¢å•ç›¸å…³æ•°æ®ï¼Œå¯èƒ½å¯¼è‡´çŠ¶æ€æ˜¾ç¤ºé—®é¢˜';
            } else {
                content += '\nâœ… æ²¡æœ‰è®¢å•ç›¸å…³æ•°æ®';
            }
            
            document.getElementById('localStorageResult').textContent = content;
            log('localStorageæ£€æŸ¥å®Œæˆ');
        }

        function clearLocalStorage() {
            log('æ¸…é™¤localStorage');
            
            const orderKeys = [
                'currentOrder',
                'orderStatus',
                'driverInfo', 
                'orderUserId'
            ];
            
            orderKeys.forEach(key => {
                localStorage.removeItem(key);
            });
            
            checkLocalStorage();
            showResult('resetTestResult', 'âœ… localStorageå·²æ¸…é™¤');
            log('localStorageæ¸…é™¤å®Œæˆ');
        }

        async function testCurrentOrderAPI() {
            const passengerId = document.getElementById('passengerIdInput').value;
            log(`æµ‹è¯•å½“å‰è®¢å•API: passengerId=${passengerId}`);
            
            try {
                const response = await fetch(`/api/orders/passenger/${passengerId}/current`, {
                    headers: {
                        'Authorization': 'Bearer test-token'
                    }
                });
                
                log(`APIå“åº”çŠ¶æ€: ${response.status}`);
                
                if (response.ok) {
                    const result = await response.json();
                    log(`APIå“åº”æ•°æ®: ${JSON.stringify(result)}`);
                    
                    let content = `APIå“åº” (${response.status}):
${JSON.stringify(result, null, 2)}

åˆ†æ:`;
                    
                    if (result.code === 200) {
                        if (result.data) {
                            content += `\nâœ… æ‰¾åˆ°è¿›è¡Œä¸­çš„è®¢å•: ${result.data.id}`;
                            content += `\nğŸ“Š è®¢å•çŠ¶æ€: ${result.data.status}`;
                            content += `\nğŸ†” è®¢å•ä¹˜å®¢ID: ${result.data.passengerId}`;
                        } else {
                            content += `\nâœ… æ²¡æœ‰è¿›è¡Œä¸­çš„è®¢å• (æ­£å¸¸)`;
                        }
                    } else {
                        content += `\nâŒ APIè¿”å›é”™è¯¯: ${result.message}`;
                    }
                    
                    document.getElementById('currentOrderAPIResult').textContent = content;
                } else {
                    const errorText = await response.text();
                    log(`APIé”™è¯¯: ${errorText}`, 'error');
                    document.getElementById('currentOrderAPIResult').textContent = `APIé”™è¯¯ (${response.status}):
${errorText}`;
                }
            } catch (error) {
                log(`APIè°ƒç”¨å¼‚å¸¸: ${error.message}`, 'error');
                document.getElementById('currentOrderAPIResult').textContent = `è°ƒç”¨å¼‚å¸¸: ${error.message}`;
            }
        }

        async function testUnpaidOrdersAPI() {
            const passengerId = document.getElementById('passengerIdInput').value;
            log(`æµ‹è¯•æœªæ”¯ä»˜è®¢å•API: passengerId=${passengerId}`);
            
            try {
                const response = await fetch(`/api/orders/unpaid?passengerId=${passengerId}`, {
                    headers: {
                        'Authorization': 'Bearer test-token'
                    }
                });
                
                log(`æœªæ”¯ä»˜è®¢å•APIå“åº”çŠ¶æ€: ${response.status}`);
                
                if (response.ok) {
                    const result = await response.json();
                    log(`æœªæ”¯ä»˜è®¢å•APIå“åº”: ${JSON.stringify(result)}`);
                    
                    let content = `æœªæ”¯ä»˜è®¢å•APIå“åº” (${response.status}):
${JSON.stringify(result, null, 2)}

åˆ†æ:`;
                    
                    if (result.code === 200) {
                        const unpaidCount = result.data ? result.data.length : 0;
                        content += `\nğŸ“‹ æœªæ”¯ä»˜è®¢å•æ•°é‡: ${unpaidCount}`;
                        if (unpaidCount > 0) {
                            content += `\nâš ï¸ æœ‰æœªæ”¯ä»˜è®¢å•ï¼Œå¯èƒ½å½±å“ä¸‹å•`;
                        } else {
                            content += `\nâœ… æ²¡æœ‰æœªæ”¯ä»˜è®¢å•`;
                        }
                    } else {
                        content += `\nâŒ APIè¿”å›é”™è¯¯: ${result.message}`;
                    }
                    
                    document.getElementById('unpaidOrdersAPIResult').textContent = content;
                } else {
                    const errorText = await response.text();
                    document.getElementById('unpaidOrdersAPIResult').textContent = `APIé”™è¯¯ (${response.status}):
${errorText}`;
                }
            } catch (error) {
                log(`æœªæ”¯ä»˜è®¢å•APIå¼‚å¸¸: ${error.message}`, 'error');
                document.getElementById('unpaidOrdersAPIResult').textContent = `è°ƒç”¨å¼‚å¸¸: ${error.message}`;
            }
        }

        function queryUserOrders() {
            const passengerId = document.getElementById('passengerIdInput').value;
            log(`æŸ¥è¯¢ç”¨æˆ·æ‰€æœ‰è®¢å•: passengerId=${passengerId}`);
            
            // æ¨¡æ‹Ÿæ•°æ®åº“æŸ¥è¯¢ç»“æœ
            const mockOrders = [
                {
                    id: 1,
                    orderNumber: 'ORDER001',
                    status: 'COMPLETED',
                    paymentStatus: 'PAID',
                    passengerId: parseInt(passengerId),
                    createdAt: '2025-01-26 10:00:00'
                },
                {
                    id: 2,
                    orderNumber: 'ORDER002', 
                    status: 'COMPLETED',
                    paymentStatus: 'UNPAID',
                    passengerId: parseInt(passengerId),
                    createdAt: '2025-01-27 09:00:00'
                }
            ];
            
            let content = `ç”¨æˆ· ${passengerId} çš„æ‰€æœ‰è®¢å•:
${JSON.stringify(mockOrders, null, 2)}

åˆ†æ:`;
            
            const activeOrders = mockOrders.filter(order => 
                ['PENDING', 'ASSIGNED', 'PICKUP', 'IN_PROGRESS'].includes(order.status)
            );
            
            const unpaidOrders = mockOrders.filter(order => 
                order.status === 'COMPLETED' && order.paymentStatus === 'UNPAID'
            );
            
            content += `\nğŸ“Š æ€»è®¢å•æ•°: ${mockOrders.length}`;
            content += `\nğŸ”„ æ´»è·ƒè®¢å•æ•°: ${activeOrders.length}`;
            content += `\nğŸ’° æœªæ”¯ä»˜è®¢å•æ•°: ${unpaidOrders.length}`;
            
            if (activeOrders.length === 0 && unpaidOrders.length === 0) {
                content += `\nâœ… ç”¨æˆ·çŠ¶æ€æ­£å¸¸ï¼Œä¸åº”è¯¥æ˜¾ç¤ºè¿›è¡Œä¸­è®¢å•`;
            } else {
                content += `\nâš ï¸ ç”¨æˆ·æœ‰æ´»è·ƒæˆ–æœªæ”¯ä»˜è®¢å•`;
            }
            
            document.getElementById('databaseResult').textContent = content;
            log('æ•°æ®åº“æŸ¥è¯¢å®Œæˆ');
        }

        function queryActiveOrders() {
            log('æŸ¥è¯¢æ‰€æœ‰æ´»è·ƒè®¢å•');
            
            // æ¨¡æ‹ŸæŸ¥è¯¢æ´»è·ƒè®¢å•
            const mockActiveOrders = [];
            
            let content = `æ‰€æœ‰æ´»è·ƒè®¢å•:
${JSON.stringify(mockActiveOrders, null, 2)}

åˆ†æ:
ğŸ“Š æ´»è·ƒè®¢å•æ€»æ•°: ${mockActiveOrders.length}`;
            
            if (mockActiveOrders.length === 0) {
                content += `\nâœ… ç³»ç»Ÿä¸­æ²¡æœ‰æ´»è·ƒè®¢å•`;
            } else {
                content += `\nâš ï¸ ç³»ç»Ÿä¸­æœ‰æ´»è·ƒè®¢å•`;
            }
            
            document.getElementById('databaseResult').textContent = content;
            log('æ´»è·ƒè®¢å•æŸ¥è¯¢å®Œæˆ');
        }

        function simulateLogin() {
            log('æ¨¡æ‹Ÿç”¨æˆ·ç™»å½•æµç¨‹');
            
            // æ¸…é™¤æ—§æ•°æ®
            clearLocalStorage();
            
            // æ¨¡æ‹Ÿç™»å½•
            const userId = document.getElementById('userIdInput').value;
            localStorage.setItem('token', `test-token-${userId}`);
            
            // æ¨¡æ‹Ÿåˆå§‹åŒ–è®¢å•çŠ¶æ€
            setTimeout(() => {
                checkLocalStorage();
                showResult('resetTestResult', 'âœ… ç”¨æˆ·ç™»å½•æ¨¡æ‹Ÿå®Œæˆ');
                log('ç”¨æˆ·ç™»å½•æ¨¡æ‹Ÿå®Œæˆ');
            }, 500);
        }

        function simulateLogout() {
            log('æ¨¡æ‹Ÿç”¨æˆ·ç™»å‡ºæµç¨‹');
            
            // æ¸…é™¤æ‰€æœ‰æ•°æ®
            localStorage.clear();
            
            checkLocalStorage();
            showResult('resetTestResult', 'âœ… ç”¨æˆ·ç™»å‡ºæ¨¡æ‹Ÿå®Œæˆ');
            log('ç”¨æˆ·ç™»å‡ºæ¨¡æ‹Ÿå®Œæˆ');
        }

        function simulatePageRefresh() {
            log('æ¨¡æ‹Ÿé¡µé¢åˆ·æ–°');
            
            // æ£€æŸ¥åˆ·æ–°å‰çš„çŠ¶æ€
            checkLocalStorage();
            
            // æ¨¡æ‹Ÿé¡µé¢åˆ·æ–°åçš„çŠ¶æ€æ¢å¤
            setTimeout(() => {
                log('é¡µé¢åˆ·æ–°åçŠ¶æ€æ¢å¤');
                checkLocalStorage();
                showResult('resetTestResult', 'âœ… é¡µé¢åˆ·æ–°æ¨¡æ‹Ÿå®Œæˆ');
            }, 1000);
        }

        // é¡µé¢åŠ è½½æ—¶çš„åˆå§‹åŒ–
        window.onload = function() {
            log('è®¢å•çŠ¶æ€è°ƒè¯•å·¥å…·å·²åŠ è½½');
            checkUserInfo();
            checkLocalStorage();
            log('è°ƒè¯•è¯´æ˜:');
            log('1. æ£€æŸ¥ç”¨æˆ·ä¿¡æ¯å’ŒlocalStorageçŠ¶æ€');
            log('2. æµ‹è¯•åç«¯APIæ¥å£å“åº”');
            log('3. æŸ¥è¯¢æ•°æ®åº“ä¸­çš„è®¢å•æ•°æ®');
            log('4. æ¨¡æ‹Ÿå„ç§çŠ¶æ€é‡ç½®åœºæ™¯');
        };
    </script>
</body>
</html>