<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¸æœºWebSocketä¼šè¯ä¿®å¤æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 3px;
        }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .info { background-color: #d1ecf1; color: #0c5460; }
        .warning { background-color: #fff3cd; color: #856404; }
        .problem-analysis {
            background: #fff3cd;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #ffc107;
            margin: 15px 0;
        }
        .solution {
            background: #d4edda;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #28a745;
            margin: 15px 0;
        }
        .test-steps {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #e9ecef;
        }
        .code-block {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 14px;
            border: 1px solid #e9ecef;
            overflow-x: auto;
            margin: 10px 0;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 3px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background-color: #0056b3; }
        .timeline {
            border-left: 3px solid #007bff;
            padding-left: 20px;
            margin: 20px 0;
        }
        .timeline-item {
            margin: 15px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <h1>ğŸ”§ å¸æœºWebSocketä¼šè¯ä¿®å¤æµ‹è¯•</h1>

    <div class=\"test-section\">
        <h3>ğŸ› é—®é¢˜æè¿°</h3>
        <div class=\"problem-analysis\">
            <strong>ç°è±¡ï¼š</strong><br>
            å¸æœº2æ¥å•åé€€å‡ºç™»å½•ï¼Œç„¶åç™»å½•å¸æœº1ï¼Œå†é‡æ–°ç™»å½•å¸æœº2æ—¶ï¼Œä¹˜å®¢ç«¯å–æ¶ˆè®¢å•å¸æœº2æ”¶ä¸åˆ°é€šçŸ¥ã€‚
            <br><br>
            <strong>é—®é¢˜åˆ†æï¼š</strong><br>
            1. WebSocketä¼šè¯æ²¡æœ‰æ­£ç¡®åœ°ä¸å¸æœºIDç»‘å®š<br>
            2. å¸æœºé‡æ–°ç™»å½•æ—¶WebSocketä¼šè¯å¯èƒ½è¢«å…¶ä»–å¸æœºçš„ä¼šè¯è¦†ç›–<br>
            3. åç«¯WebSocketä¼šè¯ç®¡ç†å­˜åœ¨å¹¶å‘é—®é¢˜
        </div>
    </div>

    <div class=\"test-section\">
        <h3>ğŸ” é—®é¢˜é‡ç°æ­¥éª¤</h3>
        <div class=\"timeline\">
            <div class=\"timeline-item\">
                <strong>æ­¥éª¤1ï¼š</strong> å¸æœº2ç™»å½•å¹¶æ¥å•ï¼ˆWebSocketè¿æ¥æ­£å¸¸ï¼‰
            </div>
            <div class=\"timeline-item\">
                <strong>æ­¥éª¤2ï¼š</strong> å¸æœº2é€€å‡ºç™»å½•ï¼ˆWebSocketè¿æ¥æ–­å¼€ï¼‰
            </div>
            <div class=\"timeline-item\">
                <strong>æ­¥éª¤3ï¼š</strong> å¸æœº1ç™»å½•ï¼ˆå»ºç«‹æ–°çš„WebSocketè¿æ¥ï¼‰
            </div>
            <div class=\"timeline-item\">
                <strong>æ­¥éª¤4ï¼š</strong> å¸æœº2é‡æ–°ç™»å½•ï¼ˆé‡æ–°å»ºç«‹WebSocketè¿æ¥ï¼‰
            </div>
            <div class=\"timeline-item\">
                <strong>æ­¥éª¤5ï¼š</strong> ä¹˜å®¢å–æ¶ˆè®¢å•ï¼ˆé€šçŸ¥å¯èƒ½å‘é€åˆ°é”™è¯¯çš„ä¼šè¯ï¼‰
            </div>
            <div class=\"timeline-item\">
                <strong>ç»“æœï¼š</strong> å¸æœº2æ”¶ä¸åˆ°å–æ¶ˆé€šçŸ¥ âŒ
            </div>
        </div>
    </div>

    <div class=\"test-section\">
        <h3>ğŸ”§ ä¿®å¤æ–¹æ¡ˆ</h3>
        <div class=\"solution\">
            <strong>æ–¹æ¡ˆ1ï¼šå¢å¼ºWebSocketä¼šè¯ç®¡ç†</strong><br>
            â€¢ åœ¨WebSocketè¿æ¥æ—¶å¼ºåˆ¶æ¸…é™¤æ—§ä¼šè¯<br>
            â€¢ ä½¿ç”¨å¸æœºIDä½œä¸ºå”¯ä¸€æ ‡è¯†ç¬¦ç®¡ç†ä¼šè¯<br>
            â€¢ æ·»åŠ ä¼šè¯éªŒè¯æœºåˆ¶
        </div>
        <div class=\"solution\">
            <strong>æ–¹æ¡ˆ2ï¼šå¢åŠ è¿æ¥ç¡®è®¤æœºåˆ¶</strong><br>
            â€¢ å¸æœºç™»å½•åå‘é€è¿æ¥ç¡®è®¤æ¶ˆæ¯<br>
            â€¢ åç«¯éªŒè¯å¹¶ç¡®è®¤ä¼šè¯ç»‘å®š<br>
            â€¢ å®šæœŸå‘é€å¿ƒè·³æ£€æµ‹ä¼šè¯çŠ¶æ€
        </div>
        <div class=\"solution\">
            <strong>æ–¹æ¡ˆ3ï¼šè®¢å•å–æ¶ˆé€šçŸ¥å¢å¼º</strong><br>
            â€¢ ä½¿ç”¨å¤šç§æ–¹å¼å‘é€å–æ¶ˆé€šçŸ¥<br>
            â€¢ æ·»åŠ é€šçŸ¥ç¡®è®¤æœºåˆ¶<br>
            â€¢ å¤±è´¥æ—¶é‡è¯•å‘é€
        </div>
    </div>

    <div class=\"test-section\">
        <h3>ğŸ› ï¸ å…·ä½“ä¿®å¤ä»£ç </h3>
        
        <h4>1. åç«¯WebSocketæ§åˆ¶å™¨å¢å¼º</h4>
        <div class=\"code-block\">
@MessageMapping(\"/driver/connect\")
public void handleDriverConnect(@Payload Map&lt;String, Object&gt; message, SimpMessageHeaderAccessor headerAccessor) {
    String driverId = message.get(\"driverId\").toString();
    
    // å¼ºåˆ¶æ¸…é™¤è¯¥å¸æœºçš„æ—§ä¼šè¯
    clearOldDriverSessions(driverId);
    
    // å»ºç«‹æ–°ä¼šè¯
    headerAccessor.getSessionAttributes().put(\"driverId\", driverId);
    headerAccessor.getSessionAttributes().put(\"userType\", \"DRIVER\");
    headerAccessor.getSessionAttributes().put(\"sessionId\", headerAccessor.getSessionId());
    
    // è®°å½•ä¼šè¯æ˜ å°„
    driverSessionMap.put(driverId, headerAccessor.getSessionId());
    
    // å‘é€è¿æ¥ç¡®è®¤
    messagingTemplate.convertAndSendToUser(driverId, \"/queue/connection\", 
        Map.of(\"status\", \"connected\", \"sessionId\", headerAccessor.getSessionId()));
}
        </div>

        <h4>2. å‰ç«¯WebSocketè¿æ¥å¢å¼º</h4>
        <div class=\"code-block\">
const connectWebSocket = () => {
  // å¦‚æœå·²æœ‰è¿æ¥ï¼Œå¼ºåˆ¶æ–­å¼€
  if (stompClient && stompClient.connected) {
    console.log(\"ğŸ”Œ å¼ºåˆ¶æ–­å¼€ç°æœ‰WebSocketè¿æ¥\");
    stompClient.deactivate();
    stompClient = null;
  }

  const socket = new SockJS(\"/ws\");
  stompClient = new Client({
    webSocketFactory: () => socket,
    reconnectDelay: 5000,
    heartbeatIncoming: 4000,
    heartbeatOutgoing: 4000,
  });

  stompClient.onConnect = () => {
    const driverId = userStore.user.driverId || userStore.user.id;
    
    // å‘é€è¿æ¥è¯·æ±‚ï¼ŒåŒ…å«æ—¶é—´æˆ³ç¡®ä¿å”¯ä¸€æ€§
    stompClient.publish({
      destination: \"/app/driver/connect\",
      body: JSON.stringify({
        driverId: driverId.toString(),
        timestamp: Date.now(),
        sessionType: \"DRIVER_SESSION\"
      }),
    });

    // è®¢é˜…å¸æœºä¸“ç”¨é˜Ÿåˆ—
    stompClient.subscribe(`/user/${driverId}/queue/orders`, handleOrderMessage);
    stompClient.subscribe(`/user/${driverId}/queue/notifications`, handleNotificationMessage);
    
    console.log(\"âœ… å¸æœºWebSocketè¿æ¥å’Œè®¢é˜…å®Œæˆ\");
  };
};
        </div>

        <h4>3. è®¢å•å–æ¶ˆé€šçŸ¥å¢å¼º</h4>
        <div class=\"code-block\">
public void notifyDriverOrderCancelled(Long driverId, Long orderId, String reason) {
    try {
        Map&lt;String, Object&gt; notification = new HashMap&lt;&gt;();
        notification.put(\"type\", \"ORDER_CANCELLED\");
        notification.put(\"orderId\", orderId);
        notification.put(\"reason\", reason);
        notification.put(\"timestamp\", System.currentTimeMillis());
        notification.put(\"priority\", \"HIGH\"); // é«˜ä¼˜å…ˆçº§é€šçŸ¥
        
        // æ–¹å¼1ï¼šå‘é€åˆ°å¸æœºä¸“ç”¨é˜Ÿåˆ—
        messagingTemplate.convertAndSendToUser(
            driverId.toString(), 
            \"/queue/notifications\", 
            notification
        );
        
        // æ–¹å¼2ï¼šå‘é€åˆ°è®¢å•é˜Ÿåˆ—ï¼ˆå¤‡ç”¨ï¼‰
        messagingTemplate.convertAndSendToUser(
            driverId.toString(), 
            \"/queue/orders\", 
            notification
        );
        
        // æ–¹å¼3ï¼šå¹¿æ’­åˆ°å¸æœºä¸»é¢˜ï¼ˆæœ€åå¤‡ç”¨ï¼‰
        messagingTemplate.convertAndSend(
            \"/topic/driver/\" + driverId, 
            notification
        );
        
        System.out.println(\"âœ… å·²é€šè¿‡å¤šç§æ–¹å¼é€šçŸ¥å¸æœºè®¢å•å–æ¶ˆ\");
        
    } catch (Exception e) {
        System.err.println(\"âŒ é€šçŸ¥å¸æœºè®¢å•å–æ¶ˆå¤±è´¥: \" + e.getMessage());
        // å¯ä»¥è€ƒè™‘ä½¿ç”¨å…¶ä»–é€šçŸ¥æ–¹å¼ï¼Œå¦‚çŸ­ä¿¡æˆ–æ¨é€
    }
}
        </div>
    </div>

    <div class=\"test-section\">
        <h3>ğŸ§ª æµ‹è¯•éªŒè¯æ­¥éª¤</h3>
        <div class=\"test-steps\">
            <h4>æµ‹è¯•åœºæ™¯1ï¼šæ­£å¸¸æµç¨‹</h4>
            <ol>
                <li>å¸æœº2ç™»å½•å¹¶æ¥å•</li>
                <li>ä¹˜å®¢å–æ¶ˆè®¢å•</li>
                <li>éªŒè¯å¸æœº2æ”¶åˆ°å–æ¶ˆé€šçŸ¥ âœ…</li>
            </ol>

            <h4>æµ‹è¯•åœºæ™¯2ï¼šé‡æ–°ç™»å½•æµç¨‹</h4>
            <ol>
                <li>å¸æœº2ç™»å½•å¹¶æ¥å•</li>
                <li>å¸æœº2é€€å‡ºç™»å½•</li>
                <li>å¸æœº2é‡æ–°ç™»å½•</li>
                <li>ä¹˜å®¢å–æ¶ˆè®¢å•</li>
                <li>éªŒè¯å¸æœº2æ”¶åˆ°å–æ¶ˆé€šçŸ¥ âœ…</li>
            </ol>

            <h4>æµ‹è¯•åœºæ™¯3ï¼šå¤šå¸æœºåˆ‡æ¢æµç¨‹ï¼ˆé—®é¢˜åœºæ™¯ï¼‰</h4>
            <ol>
                <li>å¸æœº2ç™»å½•å¹¶æ¥å•</li>
                <li>å¸æœº2é€€å‡ºç™»å½•</li>
                <li>å¸æœº1ç™»å½•</li>
                <li>å¸æœº2é‡æ–°ç™»å½•</li>
                <li>ä¹˜å®¢å–æ¶ˆè®¢å•</li>
                <li>éªŒè¯å¸æœº2æ”¶åˆ°å–æ¶ˆé€šçŸ¥ âœ…</li>
            </ol>
        </div>
    </div>

    <div class=\"test-section\">
        <h3>ğŸ” è°ƒè¯•å·¥å…·</h3>
        <div class=\"result info\">
            <strong>æµè§ˆå™¨æ§åˆ¶å°æ£€æŸ¥ï¼š</strong><br>
            â€¢ æ£€æŸ¥WebSocketè¿æ¥çŠ¶æ€<br>
            â€¢ æŸ¥çœ‹è®¢é˜…çš„é˜Ÿåˆ—åç§°<br>
            â€¢ ç›‘æ§æ”¶åˆ°çš„æ¶ˆæ¯ç±»å‹
        </div>
        <div class=\"result info\">
            <strong>åç«¯æ—¥å¿—æ£€æŸ¥ï¼š</strong><br>
            â€¢ WebSocketè¿æ¥å’Œæ–­å¼€æ—¥å¿—<br>
            â€¢ ä¼šè¯ç®¡ç†æ—¥å¿—<br>
            â€¢ æ¶ˆæ¯å‘é€æ—¥å¿—
        </div>
        <div class=\"result info\">
            <strong>Redisæ£€æŸ¥ï¼š</strong><br>
            â€¢ å¸æœºåœ¨çº¿çŠ¶æ€<br>
            â€¢ ä¼šè¯æ˜ å°„å…³ç³»<br>
            â€¢ è®¢å•çŠ¶æ€
        </div>
    </div>

    <div class=\"test-section\">
        <h3>ğŸš€ æµ‹è¯•é“¾æ¥</h3>
        <p>ä½¿ç”¨ä»¥ä¸‹é“¾æ¥è¿›è¡Œæµ‹è¯•ï¼š</p>
        <a href=\"/driver-app.html\" target=\"_blank\">
            <button>å¸æœºç«¯æµ‹è¯•</button>
        </a>
        <a href=\"/passenger-app.html\" target=\"_blank\">
            <button>ä¹˜å®¢ç«¯æµ‹è¯•</button>
        </a>
        <a href=\"/multi-driver-test.html\" target=\"_blank\">
            <button>å¤šå¸æœºæµ‹è¯•</button>
        </a>
    </div>

    <div class=\"test-section\">
        <h3>ğŸ“‹ é¢„æœŸä¿®å¤æ•ˆæœ</h3>
        <div class=\"result success\">
            <strong>âœ… ä¿®å¤ååº”è¯¥å®ç°ï¼š</strong><br>
            â€¢ å¸æœºé‡æ–°ç™»å½•åWebSocketä¼šè¯æ­£ç¡®ç»‘å®š<br>
            â€¢ å¤šå¸æœºåˆ‡æ¢ä¸ä¼šå½±å“å…¶ä»–å¸æœºçš„ä¼šè¯<br>
            â€¢ è®¢å•å–æ¶ˆé€šçŸ¥èƒ½å¤Ÿå‡†ç¡®é€è¾¾å¯¹åº”å¸æœº<br>
            â€¢ WebSocketè¿æ¥æ›´åŠ ç¨³å®šå’Œå¯é 
        </div>
    </div>
</body>
</html>