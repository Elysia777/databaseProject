<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è®¢å•çŠ¶æ€å˜åŒ–æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #333;
        }
        button {
            background: #409EFF;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #66b1ff;
        }
        button.success {
            background: #67c23a;
        }
        button.warning {
            background: #e6a23c;
        }
        button.danger {
            background: #f56c6c;
        }
        .status-display {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 14px;
            white-space: pre-wrap;
        }
        .status-good {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .status-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .message-log {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            max-height: 300px;
            overflow-y: auto;
        }
        .message-item {
            padding: 8px;
            margin: 5px 0;
            border-radius: 3px;
            border-left: 4px solid #2196f3;
        }
        .message-item.assigned {
            border-left-color: #4caf50;
            background: #f1f8e9;
        }
        .message-item.pickup {
            border-left-color: #ff9800;
            background: #fff3e0;
        }
        .message-item.in-progress {
            border-left-color: #2196f3;
            background: #e3f2fd;
        }
        .message-item.completed {
            border-left-color: #9c27b0;
            background: #f3e5f5;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“Š è®¢å•çŠ¶æ€å˜åŒ–æµ‹è¯•</h1>
        <p>æµ‹è¯•ä¹˜å®¢åˆ‡æ¢é¡µé¢é‡æ–°è¿›å…¥åï¼Œå¸æœºçŠ¶æ€å˜åŒ–çš„é€šçŸ¥åŠŸèƒ½</p>
    </div>

    <div class="container">
        <div class="test-section">
            <h3>1. æ¨¡æ‹Ÿç¯å¢ƒè®¾ç½®</h3>
            <button onclick="setupTestEnvironment()">è®¾ç½®æµ‹è¯•ç¯å¢ƒ</button>
            <button onclick="clearTestEnvironment()" class="danger">æ¸…é™¤ç¯å¢ƒ</button>
            
            <div id="environmentStatus" class="status-display">
                æµ‹è¯•ç¯å¢ƒçŠ¶æ€: æœªè®¾ç½®
            </div>
        </div>

        <div class="test-section">
            <h3>2. WebSocketè¿æ¥æµ‹è¯•</h3>
            <button onclick="testWebSocketConnection()">æµ‹è¯•WebSocketè¿æ¥</button>
            <button onclick="simulateReconnection()">æ¨¡æ‹Ÿé‡æ–°è¿æ¥</button>
            
            <div id="websocketStatus" class="status-display">
                WebSocketçŠ¶æ€: æœªè¿æ¥
            </div>
        </div>

        <div class="test-section">
            <h3>3. è®¢å•çŠ¶æ€å˜åŒ–æ¨¡æ‹Ÿ</h3>
            <button onclick="simulateStatusChange('ASSIGNED')" class="success">å¸æœºæ¥å•</button>
            <button onclick="simulateStatusChange('PICKUP')" class="warning">å¸æœºåˆ°è¾¾</button>
            <button onclick="simulateStatusChange('IN_PROGRESS')">å¼€å§‹è¡Œç¨‹</button>
            <button onclick="simulateStatusChange('COMPLETED')" class="success">å®Œæˆè¡Œç¨‹</button>
            
            <div id="currentStatus" class="status-display">
                å½“å‰è®¢å•çŠ¶æ€: æ— è®¢å•
            </div>
        </div>

        <div class="test-section">
            <h3>4. é¡µé¢åˆ‡æ¢æ¨¡æ‹Ÿ</h3>
            <button onclick="simulatePageSwitch()">æ¨¡æ‹Ÿé¡µé¢åˆ‡æ¢</button>
            <button onclick="simulatePageReturn()">æ¨¡æ‹Ÿé‡æ–°è¿›å…¥</button>
            
            <div id="pageSwitchStatus" class="status-display">
                é¡µé¢çŠ¶æ€: æ­£å¸¸
            </div>
        </div>

        <div class="test-section">
            <h3>5. æ¶ˆæ¯å¤„ç†éªŒè¯</h3>
            <button onclick="verifyMessageHandling()">éªŒè¯æ¶ˆæ¯å¤„ç†</button>
            <button onclick="clearMessageLog()" class="danger">æ¸…é™¤æ—¥å¿—</button>
            
            <div id="messageLog" class="message-log">
                <div class="message-item">ç­‰å¾…æ¶ˆæ¯...</div>
            </div>
        </div>
    </div>

    <div class="container">
        <h3>ğŸ“‹ æµ‹è¯•æ—¥å¿—</h3>
        <div id="testLog" style="background: #f8f9fa; padding: 15px; border-radius: 5px; font-family: monospace; font-size: 12px; max-height: 400px; overflow-y: auto;"></div>
    </div>

    <script>
        let mockOrder = null;
        let mockDriver = null;
        let websocketConnected = false;
        let messageHistory = [];
        let pageVisible = true;

        function log(message, type = 'info') {
            const logDiv = document.getElementById('testLog');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}\\n`;
            logDiv.textContent += logEntry;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(logEntry);
        }

        function setupTestEnvironment() {
            // æ¨¡æ‹Ÿç”¨æˆ·å’Œè®¢å•æ•°æ®
            mockOrder = {
                id: 12345,
                orderNumber: 'ORDER12345',
                status: 'ASSIGNED',
                passengerId: 1,
                pickupAddress: 'åŒ—äº¬å¸‚æœé˜³åŒºä¸‰é‡Œå±¯',
                destinationAddress: 'åŒ—äº¬å¸‚æµ·æ·€åŒºä¸­å…³æ‘',
                pickupLatitude: 39.93428,
                pickupLongitude: 116.44857,
                destinationLatitude: 39.98279,
                destinationLongitude: 116.31038
            };

            mockDriver = {
                id: 1,
                name: 'å¼ å¸ˆå‚…',
                phone: '13900139000',
                latitude: 39.93128,
                longitude: 116.44557,
                rating: 4.8
            };

            // æ¨¡æ‹Ÿè®¾ç½®åˆ°localStorage
            localStorage.setItem('currentOrder', JSON.stringify(mockOrder));
            localStorage.setItem('driverInfo', JSON.stringify(mockDriver));
            localStorage.setItem('orderStatus', 'ASSIGNED');

            // æ¨¡æ‹Ÿå…¨å±€store
            window.mockOrderStore = {
                currentOrder: mockOrder,
                driverInfo: mockDriver,
                orderStatus: 'ASSIGNED',
                updateOrderStatus: (status) => {
                    window.mockOrderStore.orderStatus = status;
                    localStorage.setItem('orderStatus', status);
                    log(`è®¢å•çŠ¶æ€æ›´æ–°: ${status}`);
                }
            };

            const statusDiv = document.getElementById('environmentStatus');
            statusDiv.innerHTML = `æµ‹è¯•ç¯å¢ƒå·²è®¾ç½®:
è®¢å•ID: ${mockOrder.id}
è®¢å•çŠ¶æ€: ${mockOrder.status}
å¸æœº: ${mockDriver.name}
å¸æœºä½ç½®: (${mockDriver.latitude}, ${mockDriver.longitude})`;
            statusDiv.className = 'status-display status-good';

            log('æµ‹è¯•ç¯å¢ƒè®¾ç½®å®Œæˆ');
        }

        function clearTestEnvironment() {
            mockOrder = null;
            mockDriver = null;
            websocketConnected = false;
            messageHistory = [];

            localStorage.removeItem('currentOrder');
            localStorage.removeItem('driverInfo');
            localStorage.removeItem('orderStatus');

            if (window.mockOrderStore) {
                delete window.mockOrderStore;
            }

            const statusDiv = document.getElementById('environmentStatus');
            statusDiv.textContent = 'æµ‹è¯•ç¯å¢ƒçŠ¶æ€: å·²æ¸…é™¤';
            statusDiv.className = 'status-display';

            updateCurrentStatus();
            updateWebSocketStatus();
            clearMessageLog();

            log('æµ‹è¯•ç¯å¢ƒå·²æ¸…é™¤');
        }

        function testWebSocketConnection() {
            websocketConnected = true;
            
            // æ¨¡æ‹ŸWebSocketè¿æ¥æˆåŠŸ
            setTimeout(() => {
                log('æ¨¡æ‹ŸWebSocketè¿æ¥æˆåŠŸ');
                updateWebSocketStatus();
                
                // æ¨¡æ‹Ÿæ³¨å†Œå…¨å±€æ¶ˆæ¯å¤„ç†å‡½æ•°
                window.handleMapOrderUpdate = function(data) {
                    log(`åœ°å›¾ç»„ä»¶æ”¶åˆ°æ¶ˆæ¯: ${data.type}`);
                    addMessageToLog(data);
                    
                    // æ¨¡æ‹Ÿåœ°å›¾ç»„ä»¶çš„å¤„ç†é€»è¾‘
                    switch (data.type) {
                        case 'ORDER_STATUS_CHANGE':
                            handleMockStatusChange(data);
                            break;
                        case 'DRIVER_LOCATION':
                            log(`å¸æœºä½ç½®æ›´æ–°: (${data.latitude}, ${data.longitude})`);
                            break;
                        case 'ORDER_ASSIGNED':
                            log('å¸æœºæ¥å•ï¼Œæ›´æ–°åœ°å›¾æ˜¾ç¤º');
                            break;
                    }
                };
                
                log('âœ… å…¨å±€æ¶ˆæ¯å¤„ç†å‡½æ•°å·²æ³¨å†Œ');
            }, 1000);
        }

        function simulateReconnection() {
            websocketConnected = false;
            updateWebSocketStatus();
            log('æ¨¡æ‹ŸWebSocketè¿æ¥æ–­å¼€');
            
            setTimeout(() => {
                websocketConnected = true;
                updateWebSocketStatus();
                log('æ¨¡æ‹ŸWebSocketé‡æ–°è¿æ¥æˆåŠŸ');
                
                // æ¨¡æ‹Ÿæ¢å¤è®¢å•çŠ¶æ€
                if (mockOrder) {
                    log('æ¢å¤è®¢å•çŠ¶æ€å’ŒWebSocketè®¢é˜…');
                }
            }, 2000);
        }

        function simulateStatusChange(newStatus) {
            if (!mockOrder) {
                alert('è¯·å…ˆè®¾ç½®æµ‹è¯•ç¯å¢ƒ');
                return;
            }

            const statusMessage = {
                'ASSIGNED': 'å¸æœºå·²æ¥å•ï¼Œæ­£åœ¨å‰å¾€æ¥æ‚¨',
                'PICKUP': 'å¸æœºå·²åˆ°è¾¾ä¸Šè½¦ç‚¹ï¼Œè¯·å‡†å¤‡ä¸Šè½¦',
                'IN_PROGRESS': 'è¡Œç¨‹å·²å¼€å§‹ï¼Œè¯·ç³»å¥½å®‰å…¨å¸¦',
                'COMPLETED': 'è¡Œç¨‹å·²å®Œæˆï¼Œæ„Ÿè°¢æ‚¨çš„ä½¿ç”¨'
            };

            // æ¨¡æ‹ŸWebSocketæ¶ˆæ¯
            const message = {
                type: 'ORDER_STATUS_CHANGE',
                orderId: mockOrder.id,
                status: newStatus,
                message: statusMessage[newStatus],
                timestamp: Date.now()
            };

            log(`æ¨¡æ‹Ÿå‘é€çŠ¶æ€å˜åŒ–æ¶ˆæ¯: ${newStatus}`);

            // æ¨¡æ‹Ÿstoreå¤„ç†
            if (window.mockOrderStore) {
                window.mockOrderStore.updateOrderStatus(newStatus);
            }

            // æ¨¡æ‹Ÿé€šçŸ¥åœ°å›¾ç»„ä»¶
            if (window.handleMapOrderUpdate) {
                window.handleMapOrderUpdate(message);
            } else {
                log('âŒ è­¦å‘Š: å…¨å±€æ¶ˆæ¯å¤„ç†å‡½æ•°ä¸å­˜åœ¨');
            }

            mockOrder.status = newStatus;
            updateCurrentStatus();
        }

        function simulatePageSwitch() {
            pageVisible = false;
            
            // æ¨¡æ‹Ÿé¡µé¢åˆ‡æ¢æ—¶çš„æ¸…ç†
            if (window.handleMapOrderUpdate) {
                delete window.handleMapOrderUpdate;
                log('é¡µé¢åˆ‡æ¢ï¼Œæ¸…ç†å…¨å±€æ¶ˆæ¯å¤„ç†å‡½æ•°');
            }

            const statusDiv = document.getElementById('pageSwitchStatus');
            statusDiv.textContent = 'é¡µé¢çŠ¶æ€: å·²åˆ‡æ¢åˆ°å…¶ä»–é¡µé¢';
            statusDiv.className = 'status-display status-error';

            log('æ¨¡æ‹Ÿé¡µé¢åˆ‡æ¢');
        }

        function simulatePageReturn() {
            pageVisible = true;
            
            // æ¨¡æ‹Ÿé¡µé¢é‡æ–°è¿›å…¥æ—¶çš„åˆå§‹åŒ–
            setTimeout(() => {
                log('æ¨¡æ‹Ÿé¡µé¢é‡æ–°è¿›å…¥');
                
                // é‡æ–°æ³¨å†Œå…¨å±€å‡½æ•°
                window.handleMapOrderUpdate = function(data) {
                    log(`åœ°å›¾ç»„ä»¶æ”¶åˆ°æ¶ˆæ¯: ${data.type}`);
                    addMessageToLog(data);
                    handleMockStatusChange(data);
                };
                
                log('âœ… é‡æ–°æ³¨å†Œå…¨å±€æ¶ˆæ¯å¤„ç†å‡½æ•°');
                
                // æ¨¡æ‹ŸWebSocketé‡è¿
                if (!websocketConnected) {
                    testWebSocketConnection();
                }

                const statusDiv = document.getElementById('pageSwitchStatus');
                statusDiv.textContent = 'é¡µé¢çŠ¶æ€: å·²é‡æ–°è¿›å…¥';
                statusDiv.className = 'status-display status-good';
            }, 1000);
        }

        function verifyMessageHandling() {
            let result = 'æ¶ˆæ¯å¤„ç†éªŒè¯ç»“æœ:\\n\\n';
            let allGood = true;

            // æ£€æŸ¥å…³é”®ç»„ä»¶
            const checks = [
                {
                    name: 'æµ‹è¯•ç¯å¢ƒ',
                    check: () => mockOrder && mockDriver,
                    fix: 'è¯·å…ˆè®¾ç½®æµ‹è¯•ç¯å¢ƒ'
                },
                {
                    name: 'WebSocketè¿æ¥',
                    check: () => websocketConnected,
                    fix: 'è¯·å…ˆæµ‹è¯•WebSocketè¿æ¥'
                },
                {
                    name: 'å…¨å±€æ¶ˆæ¯å¤„ç†å‡½æ•°',
                    check: () => typeof window.handleMapOrderUpdate === 'function',
                    fix: 'å…¨å±€æ¶ˆæ¯å¤„ç†å‡½æ•°æœªæ³¨å†Œ'
                },
                {
                    name: 'è®¢å•çŠ¶æ€æ•°æ®',
                    check: () => localStorage.getItem('orderStatus'),
                    fix: 'è®¢å•çŠ¶æ€æ•°æ®ç¼ºå¤±'
                },
                {
                    name: 'æ¶ˆæ¯å†å²è®°å½•',
                    check: () => messageHistory.length > 0,
                    fix: 'è¯·å…ˆæ¨¡æ‹Ÿä¸€äº›çŠ¶æ€å˜åŒ–'
                }
            ];

            checks.forEach(check => {
                const passed = check.check();
                result += `${passed ? 'âœ…' : 'âŒ'} ${check.name}: ${passed ? 'æ­£å¸¸' : check.fix}\\n`;
                if (!passed) allGood = false;
            });

            result += `\\næ€»ä½“çŠ¶æ€: ${allGood ? 'âœ… æ¶ˆæ¯å¤„ç†æ­£å¸¸' : 'âŒ å­˜åœ¨é—®é¢˜'}`;

            const statusDiv = document.getElementById('currentStatus');
            statusDiv.textContent = result;
            statusDiv.className = allGood ? 'status-display status-good' : 'status-display status-error';

            log(`æ¶ˆæ¯å¤„ç†éªŒè¯å®Œæˆ: ${allGood ? 'é€šè¿‡' : 'å¤±è´¥'}`);
        }

        function handleMockStatusChange(data) {
            if (data.type === 'ORDER_STATUS_CHANGE') {
                // æ¨¡æ‹ŸUIæ¶ˆæ¯æ˜¾ç¤º
                const statusMessages = {
                    'PICKUP': 'å¸æœºå·²åˆ°è¾¾ä¸Šè½¦ç‚¹ï¼Œè¯·å‡†å¤‡ä¸Šè½¦',
                    'IN_PROGRESS': 'è¡Œç¨‹å·²å¼€å§‹ï¼Œè¯·ç³»å¥½å®‰å…¨å¸¦',
                    'COMPLETED': 'è¡Œç¨‹å·²å®Œæˆï¼Œæ„Ÿè°¢æ‚¨çš„ä½¿ç”¨'
                };

                if (statusMessages[data.status]) {
                    log(`UIæ¶ˆæ¯: ${statusMessages[data.status]}`);
                    
                    // æ¨¡æ‹Ÿåœ°å›¾å…ƒç´ æ›´æ–°
                    switch (data.status) {
                        case 'PICKUP':
                            log('åœ°å›¾æ›´æ–°: å¸æœºåˆ°è¾¾ä¸Šè½¦ç‚¹ï¼Œç»§ç»­æ˜¾ç¤ºå¸æœºä½ç½®');
                            break;
                        case 'IN_PROGRESS':
                            log('åœ°å›¾æ›´æ–°: æ¸…é™¤å¸æœºåˆ°ä¸Šè½¦ç‚¹è·¯çº¿ï¼Œæ˜¾ç¤ºåˆ°ç›®çš„åœ°è·¯çº¿');
                            break;
                        case 'COMPLETED':
                            log('åœ°å›¾æ›´æ–°: æ¸…é™¤æ‰€æœ‰è·¯çº¿å’Œæ ‡è®°');
                            break;
                    }
                }
            }
        }

        function addMessageToLog(data) {
            messageHistory.push({
                timestamp: new Date().toLocaleTimeString(),
                type: data.type,
                status: data.status,
                data: data
            });

            updateMessageLog();
        }

        function updateMessageLog() {
            const logDiv = document.getElementById('messageLog');
            if (messageHistory.length === 0) {
                logDiv.innerHTML = '<div class="message-item">ç­‰å¾…æ¶ˆæ¯...</div>';
                return;
            }

            let content = '';
            messageHistory.forEach((msg, index) => {
                const statusClass = msg.status ? msg.status.toLowerCase().replace('_', '-') : 'default';
                content += `<div class="message-item ${statusClass}">
                    [${msg.timestamp}] ${msg.type}
                    ${msg.status ? ` - ${msg.status}` : ''}
                </div>`;
            });

            logDiv.innerHTML = content;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearMessageLog() {
            messageHistory = [];
            updateMessageLog();
            log('æ¶ˆæ¯æ—¥å¿—å·²æ¸…é™¤');
        }

        function updateCurrentStatus() {
            const statusDiv = document.getElementById('currentStatus');
            if (mockOrder) {
                statusDiv.innerHTML = `å½“å‰è®¢å•çŠ¶æ€:
è®¢å•å·: ${mockOrder.orderNumber}
çŠ¶æ€: ${mockOrder.status}
ä¸Šè½¦ç‚¹: ${mockOrder.pickupAddress}
ç›®çš„åœ°: ${mockOrder.destinationAddress}`;
                statusDiv.className = 'status-display status-good';
            } else {
                statusDiv.textContent = 'å½“å‰è®¢å•çŠ¶æ€: æ— è®¢å•';
                statusDiv.className = 'status-display';
            }
        }

        function updateWebSocketStatus() {
            const statusDiv = document.getElementById('websocketStatus');
            if (websocketConnected) {
                statusDiv.textContent = 'WebSocketçŠ¶æ€: âœ… å·²è¿æ¥';
                statusDiv.className = 'status-display status-good';
            } else {
                statusDiv.textContent = 'WebSocketçŠ¶æ€: âŒ æœªè¿æ¥';
                statusDiv.className = 'status-display status-error';
            }
        }

        // é¡µé¢åŠ è½½æ—¶çš„åˆå§‹åŒ–
        window.onload = function() {
            log('è®¢å•çŠ¶æ€å˜åŒ–æµ‹è¯•å·¥å…·å·²åŠ è½½');
            updateCurrentStatus();
            updateWebSocketStatus();
            updateMessageLog();
            
            log('æµ‹è¯•è¯´æ˜:');
            log('1. è®¾ç½®æµ‹è¯•ç¯å¢ƒï¼ˆæ¨¡æ‹Ÿè®¢å•å’Œå¸æœºæ•°æ®ï¼‰');
            log('2. æµ‹è¯•WebSocketè¿æ¥');
            log('3. æ¨¡æ‹Ÿå„ç§è®¢å•çŠ¶æ€å˜åŒ–');
            log('4. æµ‹è¯•é¡µé¢åˆ‡æ¢å’Œé‡æ–°è¿›å…¥');
            log('5. éªŒè¯æ¶ˆæ¯å¤„ç†æ˜¯å¦æ­£å¸¸');
        };
    </script>
</body>
</html>"