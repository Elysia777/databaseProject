<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Â§öÂè∏Êú∫ËÆ¢ÂçïÊµãËØïÈ°µÈù¢</title>
    <!-- WebSocketÁõ∏ÂÖ≥Â∫ì -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.6.1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@7.0.0/bundles/stomp.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(45deg, #FF6B6B, #4ECDC4);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .main-content {
            display: flex;
            min-height: 700px;
        }

        .passenger-panel {
            flex: 0 0 300px;
            padding: 20px;
            border-right: 1px solid #eee;
            background: #f8f9fa;
        }

        .drivers-container {
            flex: 1;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            padding: 20px;
            overflow-y: auto;
        }

        .driver-panel {
            flex: 0 0 calc(50% - 5px);
            min-width: 350px;
            background: white;
            border: 2px solid #ddd;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .driver-panel.online {
            border-color: #28a745;
            background: #f8fff9;
        }

        .driver-panel.offline {
            border-color: #dc3545;
            background: #fff8f8;
        }

        .panel h2, .panel h3 {
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #4ECDC4;
        }

        .driver-panel h3 {
            font-size: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .driver-status {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: bold;
        }

        .status-online {
            background: #28a745;
            color: white;
        }

        .status-offline {
            background: #dc3545;
            color: white;
        }

        .form-group {
            margin-bottom: 12px;
        }

        .form-group label {
            display: block;
            margin-bottom: 4px;
            font-weight: bold;
            color: #555;
            font-size: 12px;
        }

        .form-input {
            width: 100%;
            padding: 8px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 12px;
            transition: border-color 0.3s;
        }

        .form-input:focus {
            outline: none;
            border-color: #4ECDC4;
        }

        .button-group {
            margin: 10px 0;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 11px;
            font-weight: bold;
            transition: all 0.3s;
            flex: 1;
            min-width: 80px;
        }

        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-warning { background: #ffc107; color: #212529; }
        .btn-info { background: #17a2b8; color: white; }
        .btn-secondary { background: #6c757d; color: white; }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .result-box {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 10px;
            margin-top: 10px;
            max-height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 10px;
            line-height: 1.3;
        }

        /* ËÆ¢ÂçïÈÄöÁü•Âå∫Âüü */
        .notification-area {
            margin: 15px 0;
            border: 2px solid #4ECDC4;
            border-radius: 8px;
            padding: 10px;
            background: #f0fdff;
        }

        .notification-area h4 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 14px;
        }

        .notifications-container {
            max-height: 250px;
            overflow-y: auto;
        }

        .no-notifications {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 15px;
            font-size: 11px;
        }

        .order-notification {
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            animation: slideIn 0.3s ease-out;
        }

        .order-notification.new {
            border-left: 4px solid #FF6B6B;
            animation: pulse 1s ease-in-out;
        }

        .order-notification.accepted {
            background: #d4edda;
            border-color: #28a745;
        }

        .order-notification.removed {
            background: #f8d7da;
            border-color: #dc3545;
            opacity: 0.7;
        }

        @keyframes slideIn {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes pulse {
            0%, 100% { background-color: white; }
            50% { background-color: #fff5f5; }
        }

        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .notification-title {
            font-weight: bold;
            color: #333;
            font-size: 12px;
        }

        .notification-time {
            font-size: 10px;
            color: #666;
        }

        .notification-content {
            margin: 8px 0;
            font-size: 11px;
            line-height: 1.3;
        }

        .notification-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .notification-btn {
            padding: 6px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 10px;
            font-weight: bold;
            transition: all 0.3s;
            flex: 1;
        }

        .notification-btn.accept {
            background: #28a745;
            color: white;
        }

        .notification-btn.reject {
            background: #dc3545;
            color: white;
        }

        .notification-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        .notification-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* ÂÖ®Â±ÄËÆ¢ÂçïÁä∂ÊÄÅÈù¢Êùø */
        .global-orders {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 300px;
            background: white;
            border: 2px solid #4ECDC4;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            max-height: 400px;
            overflow-y: auto;
        }

        .global-orders h3 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 14px;
            border-bottom: 1px solid #ddd;
            padding-bottom: 5px;
        }

        .order-item {
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 8px;
            margin-bottom: 8px;
            font-size: 11px;
        }

        .order-status {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: bold;
            color: white;
        }

        .status-pending { background: #ffc107; color: #212529; }
        .status-assigned { background: #17a2b8; }
        .status-pickup { background: #fd7e14; }
        .status-in-progress { background: #20c997; }
        .status-completed { background: #28a745; }
        .status-cancelled { background: #dc3545; }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>üöó Â§öÂè∏Êú∫ËÆ¢ÂçïÊµãËØïÁ≥ªÁªü</h1>
            <p>ÊµãËØïÂ§ö‰∏™Âè∏Êú∫ÂêåÊó∂Êé•Êî∂ÂíåÂ§ÑÁêÜËÆ¢ÂçïÁöÑÂú∫ÊôØ</p>
        </div>

        <div class="main-content">
            <!-- ‰πòÂÆ¢Èù¢Êùø -->
            <div class="passenger-panel">
                <h2>üë§ ‰πòÂÆ¢Êìç‰Ωú</h2>

                <div class="form-group">
                    <label>‰πòÂÆ¢ID:</label>
                    <input type="number" id="passengerId" value="1" class="form-input">
                </div>

                <div class="form-group">
                    <label>‰∏äËΩ¶Âú∞ÂùÄ:</label>
                    <input type="text" id="pickupAddress" value="Âåó‰∫¨Â∏ÇÊúùÈò≥Âå∫‰∏âÈáåÂ±Ø" class="form-input">
                </div>

                <div class="form-group">
                    <label>‰∏äËΩ¶ÂùêÊ†á:</label>
                    <input type="text" id="pickupCoords" value="39.9365,116.4477" class="form-input" placeholder="Á∫¨Â∫¶,ÁªèÂ∫¶">
                </div>

                <div class="form-group">
                    <label>ÁõÆÁöÑÂú∞Âú∞ÂùÄ:</label>
                    <input type="text" id="destinationAddress" value="Âåó‰∫¨Â∏ÇÊµ∑Ê∑ÄÂå∫‰∏≠ÂÖ≥Êùë" class="form-input">
                </div>

                <div class="form-group">
                    <label>ÁõÆÁöÑÂú∞ÂùêÊ†á:</label>
                    <input type="text" id="destinationCoords" value="39.9851,116.3058" class="form-input" placeholder="Á∫¨Â∫¶,ÁªèÂ∫¶">
                </div>

                <div class="button-group">
                    <button onclick="createOrder()" class="btn btn-primary">üì± ‰∏ãÂçï</button>
                    <button onclick="cancelOrder()" class="btn btn-danger">‚ùå ÂèñÊ∂àËÆ¢Âçï</button>
                </div>

                <div class="button-group">
                    <button onclick="initializeAllDrivers()" class="btn btn-success">üöÄ ÂàùÂßãÂåñÊâÄÊúâÂè∏Êú∫</button>
                    <button onclick="connectAllDrivers()" class="btn btn-info">üîó ËøûÊé•ÊâÄÊúâÊé®ÈÄÅ</button>
                    <button onclick="disconnectAllDrivers()" class="btn btn-secondary">üîå Êñ≠ÂºÄÊâÄÊúâËøûÊé•</button>
                </div>

                <div id="passengerResult" class="result-box"></div>
            </div>

            <!-- Âè∏Êú∫Èù¢ÊùøÂÆπÂô® -->
            <div class="drivers-container" id="driversContainer">
                <!-- Âè∏Êú∫Èù¢ÊùøÂ∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÁîüÊàê -->
            </div>
        </div>
    </div>

    <!-- ÂÖ®Â±ÄËÆ¢ÂçïÁä∂ÊÄÅÈù¢Êùø -->
    <div class="global-orders">
        <h3>üìã ÂÖ®Â±ÄËÆ¢ÂçïÁä∂ÊÄÅ</h3>
        <button onclick="refreshGlobalOrders()" class="btn btn-info" style="width: 100%; margin-bottom: 10px;">üîÑ Âà∑Êñ∞</button>
        <div id="globalOrdersList"></div>
    </div>

    <script>
        // APIÂü∫Á°ÄURL
        const API_BASE_URL = 'http://localhost:8080';
        
        // Âè∏Êú∫ÈÖçÁΩÆ
        const DRIVERS_CONFIG = [
            { id: 1, name: 'Âº†Â∏àÂÇÖ', coords: '39.9042,116.4074', color: '#FF6B6B' },
            { id: 2, name: 'ÊùéÂ∏àÂÇÖ', coords: '39.9365,116.4477', color: '#4ECDC4' },
            { id: 3, name: 'ÁéãÂ∏àÂÇÖ', coords: '39.9851,116.3058', color: '#45B7D1' },
            { id: 4, name: 'ËµµÂ∏àÂÇÖ', coords: '39.9200,116.4500', color: '#96CEB4' }
        ];

        // ÂÖ®Â±ÄÁä∂ÊÄÅ
        let currentOrderId = null;
        let driverStates = {};
        let globalOrders = [];

        // ÂàùÂßãÂåñÈ°µÈù¢
        document.addEventListener('DOMContentLoaded', function() {
            initializeDriverPanels();
            refreshGlobalOrders();
            
            // ÂÆöÊúüÂà∑Êñ∞ÂÖ®Â±ÄËÆ¢ÂçïÁä∂ÊÄÅ
            setInterval(refreshGlobalOrders, 5000);
        });

        // ==================== Âè∏Êú∫Èù¢ÊùøÁÆ°ÁêÜ ====================

        function initializeDriverPanels() {
            const container = document.getElementById('driversContainer');
            container.innerHTML = '';

            DRIVERS_CONFIG.forEach(driver => {
                const panel = createDriverPanel(driver);
                container.appendChild(panel);
                
                // ÂàùÂßãÂåñÂè∏Êú∫Áä∂ÊÄÅ
                driverStates[driver.id] = {
                    online: false,
                    connected: false,
                    websocket: null,
                    stompClient: null,
                    notifications: []
                };
            });
        }

        function createDriverPanel(driver) {
            const panel = document.createElement('div');
            panel.className = 'driver-panel offline';
            panel.id = `driver-panel-${driver.id}`;
            
            panel.innerHTML = `
                <h3>
                    üöï ${driver.name} (ID: ${driver.id})
                    <span class="driver-status status-offline" id="status-${driver.id}">Á¶ªÁ∫ø</span>
                </h3>

                <div class="form-group">
                    <label>Âè∏Êú∫‰ΩçÁΩÆ:</label>
                    <input type="text" id="coords-${driver.id}" value="${driver.coords}" class="form-input" placeholder="Á∫¨Â∫¶,ÁªèÂ∫¶">
                </div>

                <div class="button-group">
                    <button onclick="driverGoOnline(${driver.id})" class="btn btn-success">üü¢ ‰∏äÁ∫ø</button>
                    <button onclick="driverGoOffline(${driver.id})" class="btn btn-secondary">üî¥ ‰∏ãÁ∫ø</button>
                </div>

                <div class="button-group">
                    <button onclick="connectDriverWebSocket(${driver.id})" class="btn btn-info">üîó ËøûÊé•Êé®ÈÄÅ</button>
                    <button onclick="disconnectDriverWebSocket(${driver.id})" class="btn btn-warning">üîå Êñ≠ÂºÄ</button>
                </div>

                <div class="notification-area">
                    <h4>üì¢ ËÆ¢ÂçïÈÄöÁü•</h4>
                    <div id="notifications-${driver.id}" class="notifications-container">
                        <div class="no-notifications">ÊöÇÊó†ËÆ¢ÂçïÊé®ÈÄÅ</div>
                    </div>
                </div>

                <div id="result-${driver.id}" class="result-box"></div>
            `;

            return panel;
        }

        // ==================== Âè∏Êú∫Êìç‰ΩúÂáΩÊï∞ ====================

        async function driverGoOnline(driverId) {
            const coords = document.getElementById(`coords-${driverId}`).value.split(',');
            
            if (coords.length !== 2) {
                showDriverResult(driverId, '‚ùå ÂùêÊ†áÊ†ºÂºèÈîôËØØ', true);
                return;
            }

            const latitude = parseFloat(coords[0]);
            const longitude = parseFloat(coords[1]);

            showDriverResult(driverId, 'üü¢ Ê≠£Âú®‰∏äÁ∫ø...');

            // ‰ΩøÁî®Êü•ËØ¢ÂèÇÊï∞ËÄå‰∏çÊòØËØ∑Ê±Ç‰Ωì
            const url = `/api/drivers/${driverId}/online?latitude=${latitude}&longitude=${longitude}`;
            const result = await apiCall(url, 'POST');

            if (result.success) {
                driverStates[driverId].online = true;
                updateDriverStatus(driverId, true);
                showDriverResult(driverId, '‚úÖ ‰∏äÁ∫øÊàêÂäü');
                
                // Âè∏Êú∫‰∏äÁ∫øÊàêÂäüÂêéÔºåËá™Âä®Âª∫Á´ãWebSocketËøûÊé•
                showDriverResult(driverId, 'üîó Ëá™Âä®ËøûÊé•WebSocket...');
                setTimeout(() => {
                    connectDriverWebSocket(driverId);
                }, 500); // Âª∂Ëøü500msÁ°Æ‰øù‰∏äÁ∫øÁä∂ÊÄÅÂ∑≤‰øùÂ≠ò
                
            } else {
                showDriverResult(driverId, `‚ùå ‰∏äÁ∫øÂ§±Ë¥•: ${result.data?.message || result.error}`, true);
            }
        }

        async function driverGoOffline(driverId) {
            showDriverResult(driverId, 'üî¥ Ê≠£Âú®‰∏ãÁ∫ø...');

            const result = await apiCall(`/api/drivers/${driverId}/offline`, 'POST');

            if (result.success) {
                driverStates[driverId].online = false;
                updateDriverStatus(driverId, false);
                showDriverResult(driverId, '‚úÖ ‰∏ãÁ∫øÊàêÂäü');
                
                // Êñ≠ÂºÄWebSocketËøûÊé•
                disconnectDriverWebSocket(driverId);
            } else {
                showDriverResult(driverId, `‚ùå ‰∏ãÁ∫øÂ§±Ë¥•: ${result.data?.message || result.error}`, true);
            }
        }

        function connectDriverWebSocket(driverId) {
            if (driverStates[driverId].connected) {
                showDriverResult(driverId, '‚ö†Ô∏è Â∑≤ËøûÊé•WebSocket');
                return;
            }

            showDriverResult(driverId, 'üîó Ê≠£Âú®ËøûÊé•WebSocket...');

            try {
                const websocket = new SockJS(API_BASE_URL + '/ws');
                
                let stompClient;
                if (typeof StompJs !== 'undefined') {
                    stompClient = new StompJs.Client({
                        webSocketFactory: () => new SockJS(API_BASE_URL + '/ws'),
                        debug: () => {}
                    });

                    stompClient.onConnect = function(frame) {
                        driverStates[driverId].connected = true;
                        driverStates[driverId].stompClient = stompClient;
                        updateDriverConnectionStatus(driverId, true);
                        showDriverResult(driverId, '‚úÖ WebSocketËøûÊé•ÊàêÂäü');

                        // ÂèëÈÄÅÂè∏Êú∫ËøûÊé•Ê∂àÊÅØ
                        stompClient.publish({
                            destination: '/app/driver/connect',
                            body: JSON.stringify({ driverId: driverId })
                        });

                        // ËÆ¢ÈòÖËÆ¢ÂçïÈòüÂàó
                        stompClient.subscribe(`/user/${driverId}/queue/orders`, function(message) {
                            const orderData = JSON.parse(message.body);
                            handleDriverOrderPush(driverId, orderData);
                        });

                        // ËÆ¢ÈòÖÈÄöÁü•ÈòüÂàó
                        stompClient.subscribe(`/user/${driverId}/queue/notifications`, function(message) {
                            const data = JSON.parse(message.body);
                            showDriverResult(driverId, `üì¢ ${data.message}`);
                            
                            // Â¶ÇÊûúÊòØËÆ¢ÂçïË¢´ÂÖ∂‰ªñÂè∏Êú∫Êé•ÂèóÁöÑÈÄöÁü•ÔºåÁßªÈô§ÂØπÂ∫îÁöÑÈÄöÁü•
                            if (data.type === 'ORDER_ACCEPTED_BY_OTHER') {
                                removeOrderNotification(driverId, data.orderId);
                            }
                        });
                    };

                    stompClient.onStompError = function(frame) {
                        driverStates[driverId].connected = false;
                        updateDriverConnectionStatus(driverId, false);
                        showDriverResult(driverId, `‚ùå WebSocketËøûÊé•Â§±Ë¥•: ${frame.headers['message']}`, true);
                    };

                    stompClient.activate();
                }

            } catch (error) {
                showDriverResult(driverId, `‚ùå WebSocketËøûÊé•Â§±Ë¥•: ${error.message}`, true);
                updateDriverConnectionStatus(driverId, false);
            }
        }

        function disconnectDriverWebSocket(driverId) {
            const state = driverStates[driverId];
            
            if (state.stompClient && state.connected) {
                state.stompClient.deactivate();
                state.connected = false;
                state.stompClient = null;
                updateDriverConnectionStatus(driverId, false);
                showDriverResult(driverId, 'üîå WebSocketÂ∑≤Êñ≠ÂºÄ');
            }
        }

        function handleDriverOrderPush(driverId, orderData) {
            showDriverResult(driverId, `üì¢ Êî∂Âà∞ËÆ¢ÂçïÊé®ÈÄÅ: ${orderData.orderId}`);

            const notification = {
                orderId: orderData.orderId,
                orderNumber: orderData.orderNumber,
                pickupAddress: orderData.pickupAddress,
                destinationAddress: orderData.destinationAddress,
                distance: orderData.distance,
                estimatedFare: orderData.estimatedFare || 'ÂæÖËÆ°ÁÆó',
                timestamp: new Date().toLocaleTimeString()
            };

            addDriverOrderNotification(driverId, notification);
            playNotificationSound();
        }

        function addDriverOrderNotification(driverId, notification) {
            const container = document.getElementById(`notifications-${driverId}`);

            // ÁßªÈô§"ÊöÇÊó†ËÆ¢ÂçïÊé®ÈÄÅ"ÊèêÁ§∫
            const noNotifications = container.querySelector('.no-notifications');
            if (noNotifications) {
                noNotifications.remove();
            }

            // ÂàõÂª∫ËÆ¢ÂçïÈÄöÁü•Âç°Áâá
            const notificationCard = document.createElement('div');
            notificationCard.className = 'order-notification new';
            notificationCard.id = `notification-${driverId}-${notification.orderId}`;

            notificationCard.innerHTML = `
                <div class="notification-header">
                    <div class="notification-title">üöó ËÆ¢Âçï #${notification.orderId}</div>
                    <div class="notification-time">${notification.timestamp}</div>
                </div>
                <div class="notification-content">
                    <div><strong>üìç ‰∏äËΩ¶:</strong> ${notification.pickupAddress}</div>
                    <div><strong>üéØ ÁõÆÁöÑÂú∞:</strong> ${notification.destinationAddress}</div>
                    <div><strong>üìè Ë∑ùÁ¶ª:</strong> ${notification.distance} ÂÖ¨Èáå</div>
                    <div><strong>üí∞ È¢Ñ‰º∞:</strong> ${notification.estimatedFare} ÂÖÉ</div>
                </div>
                <div class="notification-actions">
                    <button class="notification-btn accept" onclick="acceptOrderFromNotification(${driverId}, ${notification.orderId})">
                        ‚úÖ Êé•Âçï
                    </button>
                    <button class="notification-btn reject" onclick="rejectOrderFromNotification(${driverId}, ${notification.orderId})">
                        ‚ùå ÊãíÂçï
                    </button>
                </div>
            `;

            container.insertBefore(notificationCard, container.firstChild);

            // 3ÁßíÂêéÁßªÈô§"new"Á±ª
            setTimeout(() => {
                notificationCard.classList.remove('new');
            }, 3000);

            // Â≠òÂÇ®ÈÄöÁü•Âà∞Âè∏Êú∫Áä∂ÊÄÅ
            driverStates[driverId].notifications.push(notification);
        }

        function removeOrderNotification(driverId, orderId) {
            const notification = document.getElementById(`notification-${driverId}-${orderId}`);
            if (notification) {
                notification.classList.add('removed');
                notification.innerHTML += '<div style="color: #721c24; font-weight: bold; margin-top: 8px; font-size: 10px;">‚ùå ËÆ¢ÂçïÂ∑≤Ë¢´ÂÖ∂‰ªñÂè∏Êú∫Êé•Âèó</div>';
                
                // Á¶ÅÁî®ÊåâÈíÆ
                const buttons = notification.querySelectorAll('.notification-btn');
                buttons.forEach(btn => btn.disabled = true);

                // 3ÁßíÂêéÁßªÈô§ÈÄöÁü•
                setTimeout(() => {
                    notification.remove();
                    
                    // ‰ªéÁä∂ÊÄÅ‰∏≠ÁßªÈô§
                    driverStates[driverId].notifications = driverStates[driverId].notifications.filter(
                        n => n.orderId !== orderId
                    );

                    // Â¶ÇÊûúÊ≤°ÊúâÈÄöÁü•‰∫ÜÔºåÊòæÁ§∫ÊèêÁ§∫
                    const container = document.getElementById(`notifications-${driverId}`);
                    if (container.children.length === 0) {
                        container.innerHTML = '<div class="no-notifications">ÊöÇÊó†ËÆ¢ÂçïÊé®ÈÄÅ</div>';
                    }
                }, 3000);
            }
        }

        async function acceptOrderFromNotification(driverId, orderId) {
            const notification = document.getElementById(`notification-${driverId}-${orderId}`);
            const buttons = notification.querySelectorAll('.notification-btn');
            buttons.forEach(btn => btn.disabled = true);

            showDriverResult(driverId, `‚úÖ Ê≠£Âú®Êé•Âçï ${orderId}...`);

            const result = await apiCall(`/api/drivers/${driverId}/accept-order/${orderId}`, 'POST');

            if (result.success) {
                showDriverResult(driverId, `‚úÖ Êé•ÂçïÊàêÂäüÔºÅËÆ¢Âçï ${orderId}`);

                // Êõ¥Êñ∞ÈÄöÁü•Âç°ÁâáÁä∂ÊÄÅ
                notification.classList.add('accepted');
                notification.innerHTML += '<div style="color: #155724; font-weight: bold; margin-top: 8px; font-size: 10px;">‚úÖ Êé•ÂçïÊàêÂäü</div>';

                // ÈÄöÁü•ÊâÄÊúâÂÖ∂‰ªñÂè∏Êú∫ÁßªÈô§Ê≠§ËÆ¢Âçï
                broadcastOrderAccepted(orderId, driverId);

                setTimeout(refreshGlobalOrders, 1000);
            } else {
                showDriverResult(driverId, `‚ùå Êé•ÂçïÂ§±Ë¥•: ${result.data?.message || result.error}`, true);
                buttons.forEach(btn => btn.disabled = false);
            }
        }

        async function rejectOrderFromNotification(driverId, orderId) {
            const notification = document.getElementById(`notification-${driverId}-${orderId}`);
            
            showDriverResult(driverId, `‚ùå ÊãíÁªùËÆ¢Âçï ${orderId}`);
            
            // ÁßªÈô§ÈÄöÁü•
            notification.remove();
            
            // ‰ªéÁä∂ÊÄÅ‰∏≠ÁßªÈô§
            driverStates[driverId].notifications = driverStates[driverId].notifications.filter(
                n => n.orderId !== orderId
            );

            // Â¶ÇÊûúÊ≤°ÊúâÈÄöÁü•‰∫ÜÔºåÊòæÁ§∫ÊèêÁ§∫
            const container = document.getElementById(`notifications-${driverId}`);
            if (container.children.length === 0) {
                container.innerHTML = '<div class="no-notifications">ÊöÇÊó†ËÆ¢ÂçïÊé®ÈÄÅ</div>';
            }
        }

        function broadcastOrderAccepted(orderId, acceptedDriverId) {
            // ÁßªÈô§ÊâÄÊúâÂÖ∂‰ªñÂè∏Êú∫ÁöÑÁõ∏ÂêåËÆ¢ÂçïÈÄöÁü•
            DRIVERS_CONFIG.forEach(driver => {
                if (driver.id !== acceptedDriverId) {
                    removeOrderNotification(driver.id, orderId);
                }
            });
        }

        // ==================== ÊâπÈáèÊìç‰ΩúÂáΩÊï∞ ====================

        function initializeAllDrivers() {
            showPassengerResult('üöÄ Ê≠£Âú®ÂàùÂßãÂåñÊâÄÊúâÂè∏Êú∫...');
            
            DRIVERS_CONFIG.forEach(async (driver, index) => {
                setTimeout(() => {
                    driverGoOnline(driver.id);
                }, index * 500); // ÈîôÂºÄ500msÊâßË°å
            });
        }

        function connectAllDrivers() {
            showPassengerResult('üîó Ê≠£Âú®ËøûÊé•ÊâÄÊúâÂè∏Êú∫ÁöÑWebSocket...');
            
            DRIVERS_CONFIG.forEach((driver, index) => {
                setTimeout(() => {
                    connectDriverWebSocket(driver.id);
                }, index * 300); // ÈîôÂºÄ300msÊâßË°å
            });
        }

        function disconnectAllDrivers() {
            showPassengerResult('üîå Ê≠£Âú®Êñ≠ÂºÄÊâÄÊúâÂè∏Êú∫ÁöÑWebSocket...');
            
            DRIVERS_CONFIG.forEach(driver => {
                disconnectDriverWebSocket(driver.id);
            });
        }

        // ==================== ‰πòÂÆ¢ÂäüËÉΩ ====================

        async function createOrder() {
            const passengerId = document.getElementById('passengerId').value;
            const pickupAddress = document.getElementById('pickupAddress').value;
            const pickupCoords = document.getElementById('pickupCoords').value.split(',');
            const destinationAddress = document.getElementById('destinationAddress').value;
            const destinationCoords = document.getElementById('destinationCoords').value.split(',');

            if (pickupCoords.length !== 2 || destinationCoords.length !== 2) {
                showPassengerResult('‚ùå ÂùêÊ†áÊ†ºÂºèÈîôËØØÔºåËØ∑‰ΩøÁî®"Á∫¨Â∫¶,ÁªèÂ∫¶"Ê†ºÂºè', true);
                return;
            }

            const orderData = {
                passengerId: parseInt(passengerId),
                pickupAddress: pickupAddress,
                pickupLatitude: parseFloat(pickupCoords[0]),
                pickupLongitude: parseFloat(pickupCoords[1]),
                destinationAddress: destinationAddress,
                destinationLatitude: parseFloat(destinationCoords[0]),
                destinationLongitude: parseFloat(destinationCoords[1]),
                orderType: 'REAL_TIME'
            };

            showPassengerResult('üì± Ê≠£Âú®ÂàõÂª∫ËÆ¢Âçï...');

            const result = await apiCall('/api/orders/create', 'POST', orderData);

            if (result.success) {
                currentOrderId = result.data.data.id;
                showPassengerResult(`‚úÖ ËÆ¢ÂçïÂàõÂª∫ÊàêÂäüÔºÅËÆ¢ÂçïID: ${currentOrderId}`);
                showPassengerResult(`üì° ËÆ¢ÂçïÂ∑≤Êé®ÈÄÅÁªôÁ¨¶ÂêàÊù°‰ª∂ÁöÑÂè∏Êú∫`);

                setTimeout(refreshGlobalOrders, 1000);
            } else {
                showPassengerResult(`‚ùå ËÆ¢ÂçïÂàõÂª∫Â§±Ë¥•: ${result.data?.message || result.error}`, true);
            }
        }

        async function cancelOrder() {
            const orderId = currentOrderId || prompt('ËØ∑ËæìÂÖ•Ë¶ÅÂèñÊ∂àÁöÑËÆ¢ÂçïID:');

            if (!orderId) {
                showPassengerResult('‚ùå ËØ∑ÂÖàÂàõÂª∫ËÆ¢ÂçïÊàñËæìÂÖ•ËÆ¢ÂçïID', true);
                return;
            }

            showPassengerResult(`üö´ Ê≠£Âú®ÂèñÊ∂àËÆ¢Âçï ${orderId}...`);

            const result = await apiCall(`/api/orders/${orderId}/cancel`, 'POST');

            if (result.success) {
                showPassengerResult(`‚úÖ ËÆ¢Âçï ${orderId} ÂèñÊ∂àÊàêÂäü`);
                currentOrderId = null;
                setTimeout(refreshGlobalOrders, 1000);
            } else {
                showPassengerResult(`‚ùå ÂèñÊ∂àËÆ¢ÂçïÂ§±Ë¥•: ${result.data?.message || result.error}`, true);
            }
        }

        // ==================== ÂÖ®Â±ÄËÆ¢ÂçïÁä∂ÊÄÅ ====================

        async function refreshGlobalOrders() {
            const result = await apiCall('/api/orders');

            if (result.success) {
                globalOrders = result.data.data || [];
                displayGlobalOrders();
            }
        }

        function displayGlobalOrders() {
            const container = document.getElementById('globalOrdersList');
            
            if (globalOrders.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #666; font-style: italic;">ÊöÇÊó†ËÆ¢Âçï</div>';
                return;
            }

            container.innerHTML = globalOrders.map(order => `
                <div class="order-item">
                    <div><strong>ËÆ¢Âçï #${order.id}</strong> <span class="order-status status-${order.status.toLowerCase()}">${getStatusText(order.status)}</span></div>
                    <div>üìç ${order.pickupAddress}</div>
                    <div>üéØ ${order.destinationAddress}</div>
                    ${order.driverId ? `<div>üöï Âè∏Êú∫: ${order.driverId}</div>` : ''}
                    <div style="font-size: 10px; color: #666;">${new Date(order.createTime).toLocaleString()}</div>
                </div>
            `).join('');
        }

        function getStatusText(status) {
            const statusMap = {
                'PENDING': 'ÂæÖÊé•Âçï',
                'ASSIGNED': 'Â∑≤Êé•Âçï',
                'PICKUP': 'ÂâçÂæÄÊé•ÂÆ¢',
                'IN_PROGRESS': 'Ë°åÁ®ã‰∏≠',
                'COMPLETED': 'Â∑≤ÂÆåÊàê',
                'CANCELLED': 'Â∑≤ÂèñÊ∂à'
            };
            return statusMap[status] || status;
        }

        // ==================== Â∑•ÂÖ∑ÂáΩÊï∞ ====================

        function updateDriverStatus(driverId, online) {
            const panel = document.getElementById(`driver-panel-${driverId}`);
            const status = document.getElementById(`status-${driverId}`);
            
            if (online) {
                panel.className = 'driver-panel online';
                status.textContent = 'Âú®Á∫ø';
                status.className = 'driver-status status-online';
            } else {
                panel.className = 'driver-panel offline';
                status.textContent = 'Á¶ªÁ∫ø';
                status.className = 'driver-status status-offline';
            }
        }

        function updateDriverConnectionStatus(driverId, connected) {
            // ÂèØ‰ª•Âú®ËøôÈáåÊ∑ªÂä†ËøûÊé•Áä∂ÊÄÅÁöÑËßÜËßâÊåáÁ§∫
            if (connected) {
                showDriverResult(driverId, 'üü¢ WebSocketÂ∑≤ËøûÊé•');
            } else {
                showDriverResult(driverId, 'üî¥ WebSocketÂ∑≤Êñ≠ÂºÄ');
            }
        }

        function showDriverResult(driverId, message, isError = false) {
            const element = document.getElementById(`result-${driverId}`);
            const timestamp = new Date().toLocaleTimeString();
            const color = isError ? '#dc3545' : '#28a745';
            element.innerHTML += `<div style="color: ${color}; margin-bottom: 5px;">
                [${timestamp}] ${message}
            </div>`;
            element.scrollTop = element.scrollHeight;
        }

        function showPassengerResult(message, isError = false) {
            const element = document.getElementById('passengerResult');
            const timestamp = new Date().toLocaleTimeString();
            const color = isError ? '#dc3545' : '#28a745';
            element.innerHTML += `<div style="color: ${color}; margin-bottom: 5px;">
                [${timestamp}] ${message}
            </div>`;
            element.scrollTop = element.scrollHeight;
        }

        async function apiCall(url, method = 'GET', data = null) {
            try {
                const options = {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    }
                };

                if (data) {
                    options.body = JSON.stringify(data);
                }

                const response = await fetch(API_BASE_URL + url, options);
                const result = await response.json();

                return { success: response.ok, data: result };
            } catch (error) {
                return { success: false, error: error.message };
            }
        }

        function playNotificationSound() {
            // ÂàõÂª∫ÁÆÄÂçïÁöÑÊèêÁ§∫Èü≥
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 800;
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);
            } catch (error) {
                console.log('Êó†Ê≥ïÊí≠ÊîæÊèêÁ§∫Èü≥:', error);
            }
        }
    </script>
</body>
</html>