<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤šå¸æœºè®¢å•æµ‹è¯•é¡µé¢</title>
    <!-- WebSocketç›¸å…³åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.6.1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@7.0.0/bundles/stomp.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(45deg, #FF6B6B, #4ECDC4);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .main-content {
            display: flex;
            min-height: 700px;
        }

        .passenger-panel {
            flex: 0 0 300px;
            padding: 20px;
            border-right: 1px solid #eee;
            background: #f8f9fa;
        }

        .drivers-container {
            flex: 1;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            padding: 20px;
            overflow-y: auto;
        }

        .driver-panel {
            flex: 0 0 calc(50% - 5px);
            min-width: 350px;
            background: white;
            border: 2px solid #ddd;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .driver-panel.online {
            border-color: #28a745;
            background: #f8fff9;
        }

        .driver-panel.offline {
            border-color: #dc3545;
            background: #fff8f8;
        }

        .panel h2, .panel h3 {
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #4ECDC4;
        }

        .driver-panel h3 {
            font-size: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .driver-status {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: bold;
        }

        .status-online {
            background: #28a745;
            color: white;
        }

        .status-offline {
            background: #dc3545;
            color: white;
        }

        .form-group {
            margin-bottom: 12px;
        }

        .form-group label {
            display: block;
            margin-bottom: 4px;
            font-weight: bold;
            color: #555;
            font-size: 12px;
        }

        .form-input {
            width: 100%;
            padding: 8px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 12px;
            transition: border-color 0.3s;
        }

        .form-input:focus {
            outline: none;
            border-color: #4ECDC4;
        }

        .button-group {
            margin: 10px 0;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 11px;
            font-weight: bold;
            transition: all 0.3s;
            flex: 1;
            min-width: 80px;
        }

        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-warning { background: #ffc107; color: #212529; }
        .btn-info { background: #17a2b8; color: white; }
        .btn-secondary { background: #6c757d; color: white; }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .result-box {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 10px;
            margin-top: 10px;
            max-height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 10px;
            line-height: 1.3;
        }

        /* è®¢å•é€šçŸ¥åŒºåŸŸ */
        .notification-area {
            margin: 15px 0;
            border: 2px solid #4ECDC4;
            border-radius: 8px;
            padding: 10px;
            background: #f0fdff;
        }

        .notification-area h4 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 14px;
        }

        .notifications-container {
            max-height: 250px;
            overflow-y: auto;
        }

        .no-notifications {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 15px;
            font-size: 11px;
        }

        .order-notification {
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            animation: slideIn 0.3s ease-out;
        }

        .order-notification.new {
            border-left: 4px solid #FF6B6B;
            animation: pulse 1s ease-in-out;
        }

        .order-notification.accepted {
            background: #d4edda;
            border-color: #28a745;
        }

        .order-notification.removed {
            background: #f8d7da;
            border-color: #dc3545;
            opacity: 0.7;
        }

        @keyframes slideIn {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes pulse {
            0%, 100% { background-color: white; }
            50% { background-color: #fff5f5; }
        }

        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .notification-title {
            font-weight: bold;
            color: #333;
            font-size: 12px;
        }

        .notification-time {
            font-size: 10px;
            color: #666;
        }

        .notification-content {
            margin: 8px 0;
            font-size: 11px;
            line-height: 1.3;
        }

        .notification-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .notification-btn {
            padding: 6px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 10px;
            font-weight: bold;
            transition: all 0.3s;
            flex: 1;
        }

        .notification-btn.accept {
            background: #28a745;
            color: white;
        }

        .notification-btn.reject {
            background: #dc3545;
            color: white;
        }

        .notification-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        .notification-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* å…¨å±€è®¢å•çŠ¶æ€é¢æ¿ */
        .global-orders {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 300px;
            background: white;
            border: 2px solid #4ECDC4;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            max-height: 400px;
            overflow-y: auto;
        }

        .global-orders h3 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 14px;
            border-bottom: 1px solid #ddd;
            padding-bottom: 5px;
        }

        .order-item {
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 8px;
            margin-bottom: 8px;
            font-size: 11px;
        }

        .order-status {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: bold;
            color: white;
        }

        .status-pending { background: #ffc107; color: #212529; }
        .status-assigned { background: #17a2b8; }
        .status-pickup { background: #fd7e14; }
        .status-in-progress { background: #20c997; }
        .status-completed { background: #28a745; }
        .status-cancelled { background: #dc3545; }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>ğŸš— å¤šå¸æœºè®¢å•æµ‹è¯•ç³»ç»Ÿ</h1>
            <p>æµ‹è¯•å¤šä¸ªå¸æœºåŒæ—¶æ¥æ”¶å’Œå¤„ç†è®¢å•çš„åœºæ™¯</p>
        </div>

        <div class="main-content">
            <!-- ä¹˜å®¢é¢æ¿ -->
            <div class="passenger-panel">
                <h2>ğŸ‘¤ ä¹˜å®¢æ“ä½œ</h2>

                <div class="form-group">
                    <label>ä¹˜å®¢ID:</label>
                    <input type="number" id="passengerId" value="1" class="form-input">
                </div>

                <div class="form-group">
                    <label>ä¸Šè½¦åœ°å€:</label>
                    <input type="text" id="pickupAddress" value="åŒ—äº¬å¸‚æœé˜³åŒºä¸‰é‡Œå±¯" class="form-input">
                </div>

                <div class="form-group">
                    <label>ä¸Šè½¦åæ ‡:</label>
                    <input type="text" id="pickupCoords" value="39.9365,116.4477" class="form-input" placeholder="çº¬åº¦,ç»åº¦">
                </div>

                <div class="form-group">
                    <label>ç›®çš„åœ°åœ°å€:</label>
                    <input type="text" id="destinationAddress" value="åŒ—äº¬å¸‚æµ·æ·€åŒºä¸­å…³æ‘" class="form-input">
                </div>

                <div class="form-group">
                    <label>ç›®çš„åœ°åæ ‡:</label>
                    <input type="text" id="destinationCoords" value="39.9851,116.3058" class="form-input" placeholder="çº¬åº¦,ç»åº¦">
                </div>

                <div class="button-group">
                    <button onclick="createOrder()" class="btn btn-primary">ğŸ“± ä¸‹å•</button>
                    <button onclick="cancelOrder()" class="btn btn-danger">âŒ å–æ¶ˆè®¢å•</button>
                </div>

                <div class="button-group">
                    <button onclick="initializeAllDrivers()" class="btn btn-success">ğŸš€ åˆå§‹åŒ–æ‰€æœ‰å¸æœº</button>
                    <button onclick="connectAllDrivers()" class="btn btn-info">ğŸ”— è¿æ¥æ‰€æœ‰æ¨é€</button>
                    <button onclick="disconnectAllDrivers()" class="btn btn-secondary">ğŸ”Œ æ–­å¼€æ‰€æœ‰è¿æ¥</button>
                </div>

                <div id="passengerResult" class="result-box"></div>
            </div>

            <!-- å¸æœºé¢æ¿å®¹å™¨ -->
            <div class="drivers-container" id="driversContainer">
                <!-- å¸æœºé¢æ¿å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
    </div>

    <!-- å…¨å±€è®¢å•çŠ¶æ€é¢æ¿ -->
    <div class="global-orders">
        <h3>ğŸ“‹ å…¨å±€è®¢å•çŠ¶æ€</h3>
        <button onclick="refreshGlobalOrders()" class="btn btn-info" style="width: 100%; margin-bottom: 10px;">ğŸ”„ åˆ·æ–°</button>
        <div id="globalOrdersList"></div>
    </div>

    <script>
        // APIåŸºç¡€URL
        const API_BASE_URL = 'http://localhost:8080';
        
        // å¸æœºé…ç½®
        const DRIVERS_CONFIG = [
            { id: 1, name: 'å¼ å¸ˆå‚…', coords: '39.9042,116.4074', color: '#FF6B6B' },
            { id: 2, name: 'æå¸ˆå‚…', coords: '39.9365,116.4477', color: '#4ECDC4' },
            { id: 3, name: 'ç‹å¸ˆå‚…', coords: '39.9851,116.3058', color: '#45B7D1' },
            { id: 4, name: 'èµµå¸ˆå‚…', coords: '39.9200,116.4500', color: '#96CEB4' }
        ];

        // å…¨å±€çŠ¶æ€
        let currentOrderId = null;
        let driverStates = {};
        let globalOrders = [];

        // åˆå§‹åŒ–é¡µé¢
        document.addEventListener('DOMContentLoaded', function() {
            initializeDriverPanels();
            refreshGlobalOrders();
            
            // å®šæœŸåˆ·æ–°å…¨å±€è®¢å•çŠ¶æ€
            setInterval(refreshGlobalOrders, 5000);
        });

        // ==================== å¸æœºé¢æ¿ç®¡ç† ====================

        function initializeDriverPanels() {
            const container = document.getElementById('driversContainer');
            container.innerHTML = '';

            DRIVERS_CONFIG.forEach(driver => {
                const panel = createDriverPanel(driver);
                container.appendChild(panel);
                
                // åˆå§‹åŒ–å¸æœºçŠ¶æ€
                driverStates[driver.id] = {
                    online: false,
                    connected: false,
                    websocket: null,
                    stompClient: null,
                    notifications: []
                };
            });
        }

        function createDriverPanel(driver) {
            const panel = document.createElement('div');
            panel.className = 'driver-panel offline';
            panel.id = `driver-panel-${driver.id}`;
            
            panel.innerHTML = `
                <h3>
                    ğŸš• ${driver.name} (ID: ${driver.id})
                    <span class="driver-status status-offline" id="status-${driver.id}">ç¦»çº¿</span>
                </h3>

                <div class="form-group">
                    <label>å¸æœºä½ç½®:</label>
                    <input type="text" id="coords-${driver.id}" value="${driver.coords}" class="form-input" placeholder="çº¬åº¦,ç»åº¦">
                </div>

                <div class="button-group">
                    <button onclick="driverGoOnline(${driver.id})" class="btn btn-success">ğŸŸ¢ ä¸Šçº¿</button>
                    <button onclick="driverGoOffline(${driver.id})" class="btn btn-secondary">ğŸ”´ ä¸‹çº¿</button>
                </div>

                <div class="button-group">
                    <button onclick="connectDriverWebSocket(${driver.id})" class="btn btn-info">ğŸ”— è¿æ¥æ¨é€</button>
                    <button onclick="disconnectDriverWebSocket(${driver.id})" class="btn btn-warning">ğŸ”Œ æ–­å¼€</button>
                </div>

                <div class="notification-area">
                    <h4>ğŸ“¢ è®¢å•é€šçŸ¥</h4>
                    <div id="notifications-${driver.id}" class="notifications-container">
                        <div class="no-notifications">æš‚æ— è®¢å•æ¨é€</div>
                    </div>
                </div>

                <div id="result-${driver.id}" class="result-box"></div>
            `;

            return panel;
        }

        // ==================== å¸æœºæ“ä½œå‡½æ•° ====================

        async function driverGoOnline(driverId) {
            const coords = document.getElementById(`coords-${driverId}`).value.split(',');
            
            if (coords.length !== 2) {
                showDriverResult(driverId, 'âŒ åæ ‡æ ¼å¼é”™è¯¯', true);
                return;
            }

            const latitude = parseFloat(coords[0]);
            const longitude = parseFloat(coords[1]);

            showDriverResult(driverId, 'ğŸŸ¢ æ­£åœ¨ä¸Šçº¿...');

            // ä½¿ç”¨æŸ¥è¯¢å‚æ•°è€Œä¸æ˜¯è¯·æ±‚ä½“
            const url = `/api/drivers/${driverId}/online?latitude=${latitude}&longitude=${longitude}`;
            const result = await apiCall(url, 'POST');

            if (result.success) {
                driverStates[driverId].online = true;
                updateDriverStatus(driverId, true);
                showDriverResult(driverId, 'âœ… ä¸Šçº¿æˆåŠŸ');
                
                // å¸æœºä¸Šçº¿æˆåŠŸåï¼Œè‡ªåŠ¨å»ºç«‹WebSocketè¿æ¥
                showDriverResult(driverId, 'ğŸ”— è‡ªåŠ¨è¿æ¥WebSocket...');
                setTimeout(() => {
                    connectDriverWebSocket(driverId);
                }, 500); // å»¶è¿Ÿ500msç¡®ä¿ä¸Šçº¿çŠ¶æ€å·²ä¿å­˜
                
            } else {
                showDriverResult(driverId, `âŒ ä¸Šçº¿å¤±è´¥: ${result.data?.message || result.error}`, true);
            }
        }

        async function driverGoOffline(driverId) {
            showDriverResult(driverId, 'ğŸ”´ æ­£åœ¨ä¸‹çº¿...');

            const result = await apiCall(`/api/drivers/${driverId}/offline`, 'POST');

            if (result.success) {
                driverStates[driverId].online = false;
                updateDriverStatus(driverId, false);
                showDriverResult(driverId, 'âœ… ä¸‹çº¿æˆåŠŸ');
                
                // æ–­å¼€WebSocketè¿æ¥
                disconnectDriverWebSocket(driverId);
            } else {
                showDriverResult(driverId, `âŒ ä¸‹çº¿å¤±è´¥: ${result.data?.message || result.error}`, true);
            }
        }

        function connectDriverWebSocket(driverId) {
            if (driverStates[driverId].connected) {
                showDriverResult(driverId, 'âš ï¸ å·²è¿æ¥WebSocket');
                return;
            }

            showDriverResult(driverId, 'ğŸ”— æ­£åœ¨è¿æ¥WebSocket...');

            try {
                const websocket = new SockJS(API_BASE_URL + '/ws');
                
                let stompClient;
                if (typeof StompJs !== 'undefined') {
                    stompClient = new StompJs.Client({
                        webSocketFactory: () => new SockJS(API_BASE_URL + '/ws'),
                        debug: () => {}
                    });

                    stompClient.onConnect = function(frame) {
                        driverStates[driverId].connected = true;
                        driverStates[driverId].stompClient = stompClient;
                        updateDriverConnectionStatus(driverId, true);
                        showDriverResult(driverId, 'âœ… WebSocketè¿æ¥æˆåŠŸ');

                        // å‘é€å¸æœºè¿æ¥æ¶ˆæ¯
                        stompClient.publish({
                            destination: '/app/driver/connect',
                            body: JSON.stringify({ driverId: driverId })
                        });

                        // è®¢é˜…è®¢å•é˜Ÿåˆ—
                        stompClient.subscribe(`/user/${driverId}/queue/orders`, function(message) {
                            const orderData = JSON.parse(message.body);
                            handleDriverOrderPush(driverId, orderData);
                        });

                        // è®¢é˜…é€šçŸ¥é˜Ÿåˆ—
                        stompClient.subscribe(`/user/${driverId}/queue/notifications`, function(message) {
                            const data = JSON.parse(message.body);
                            showDriverResult(driverId, `ğŸ“¢ ${data.message}`);
                            
                            // å¦‚æœæ˜¯è®¢å•è¢«å…¶ä»–å¸æœºæ¥å—çš„é€šçŸ¥ï¼Œç§»é™¤å¯¹åº”çš„é€šçŸ¥
                            if (data.type === 'ORDER_ACCEPTED_BY_OTHER') {
                                removeOrderNotification(driverId, data.orderId);
                            }
                        });
                    };

                    stompClient.onStompError = function(frame) {
                        driverStates[driverId].connected = false;
                        updateDriverConnectionStatus(driverId, false);
                        showDriverResult(driverId, `âŒ WebSocketè¿æ¥å¤±è´¥: ${frame.headers['message']}`, true);
                    };

                    stompClient.activate();
                }

            } catch (error) {
                showDriverResult(driverId, `âŒ WebSocketè¿æ¥å¤±è´¥: ${error.message}`, true);
                updateDriverConnectionStatus(driverId, false);
            }
        }

        function disconnectDriverWebSocket(driverId) {
            const state = driverStates[driverId];
            
            if (state.stompClient && state.connected) {
                state.stompClient.deactivate();
                state.connected = false;
                state.stompClient = null;
                updateDriverConnectionStatus(driverId, false);
                showDriverResult(driverId, 'ğŸ”Œ WebSocketå·²æ–­å¼€');
            }
        }

        function handleDriverOrderPush(driverId, orderData) {
            showDriverResult(driverId, `ğŸ“¢ æ”¶åˆ°è®¢å•æ¨é€: ${orderData.orderId}`);

            const notification = {
                orderId: orderData.orderId,
                orderNumber: orderData.orderNumber,
                pickupAddress: orderData.pickupAddress,
                destinationAddress: orderData.destinationAddress,
                distance: orderData.distance,
                estimatedFare: orderData.estimatedFare || 'å¾…è®¡ç®—',
                timestamp: new Date().toLocaleTimeString()
            };

            addDriverOrderNotification(driverId, notification);
            playNotificationSound();
        }

        function addDriverOrderNotification(driverId, notification) {
            const container = document.getElementById(`notifications-${driverId}`);

            // ç§»é™¤"æš‚æ— è®¢å•æ¨é€"æç¤º
            const noNotifications = container.querySelector('.no-notifications');
            if (noNotifications) {
                noNotifications.remove();
            }

            // åˆ›å»ºè®¢å•é€šçŸ¥å¡ç‰‡
            const notificationCard = document.createElement('div');
            notificationCard.className = 'order-notification new';
            notificationCard.id = `notification-${driverId}-${notification.orderId}`;

            notificationCard.innerHTML = `
                <div class="notification-header">
                    <div class="notification-title">ğŸš— è®¢å• #${notification.orderId}</div>
                    <div class="notification-time">${notification.timestamp}</div>
                </div>
                <div class="notification-content">
                    <div><strong>ğŸ“ ä¸Šè½¦:</strong> ${notification.pickupAddress}</div>
                    <div><strong>ğŸ¯ ç›®çš„åœ°:</strong> ${notification.destinationAddress}</div>
                    <div><strong>ğŸ“ è·ç¦»:</strong> ${notification.distance} å…¬é‡Œ</div>
                    <div><strong>ğŸ’° é¢„ä¼°:</strong> ${notification.estimatedFare} å…ƒ</div>
                </div>
                <div class="notification-actions">
                    <button class="notification-btn accept" onclick="acceptOrderFromNotification(${driverId}, ${notification.orderId})">
                        âœ… æ¥å•
                    </button>
                    <button class="notification-btn reject" onclick="rejectOrderFromNotification(${driverId}, ${notification.orderId})">
                        âŒ æ‹’å•
                    </button>
                </div>
            `;

            container.insertBefore(notificationCard, container.firstChild);

            // 3ç§’åç§»é™¤"new"ç±»
            setTimeout(() => {
                notificationCard.classList.remove('new');
            }, 3000);

            // å­˜å‚¨é€šçŸ¥åˆ°å¸æœºçŠ¶æ€
            driverStates[driverId].notifications.push(notification);
        }

        function removeOrderNotification(driverId, orderId) {
            const notification = document.getElementById(`notification-${driverId}-${orderId}`);
            if (notification) {
                notification.classList.add('removed');
                notification.innerHTML += '<div style="color: #721c24; font-weight: bold; margin-top: 8px; font-size: 10px;">âŒ è®¢å•å·²è¢«å…¶ä»–å¸æœºæ¥å—</div>';
                
                // ç¦ç”¨æŒ‰é’®
                const buttons = notification.querySelectorAll('.notification-btn');
                buttons.forEach(btn => btn.disabled = true);

                // 3ç§’åç§»é™¤é€šçŸ¥
                setTimeout(() => {
                    notification.remove();
                    
                    // ä»çŠ¶æ€ä¸­ç§»é™¤
                    driverStates[driverId].notifications = driverStates[driverId].notifications.filter(
                        n => n.orderId !== orderId
                    );

                    // å¦‚æœæ²¡æœ‰é€šçŸ¥äº†ï¼Œæ˜¾ç¤ºæç¤º
                    const container = document.getElementById(`notifications-${driverId}`);
                    if (container.children.length === 0) {
                        container.innerHTML = '<div class="no-notifications">æš‚æ— è®¢å•æ¨é€</div>';
                    }
                }, 3000);
            }
        }

        async function acceptOrderFromNotification(driverId, orderId) {
            const notification = document.getElementById(`notification-${driverId}-${orderId}`);
            const buttons = notification.querySelectorAll('.notification-btn');
            buttons.forEach(btn => btn.disabled = true);

            showDriverResult(driverId, `âœ… æ­£åœ¨æ¥å• ${orderId}...`);

            const result = await apiCall(`/api/drivers/${driverId}/accept-order/${orderId}`, 'POST');

            if (result.success) {
                showDriverResult(driverId, `âœ… æ¥å•æˆåŠŸï¼è®¢å• ${orderId}`);

                // æ›´æ–°é€šçŸ¥å¡ç‰‡çŠ¶æ€
                notification.classList.add('accepted');
                notification.innerHTML += '<div style="color: #155724; font-weight: bold; margin-top: 8px; font-size: 10px;">âœ… æ¥å•æˆåŠŸ</div>';

                // é€šçŸ¥æ‰€æœ‰å…¶ä»–å¸æœºç§»é™¤æ­¤è®¢å•
                broadcastOrderAccepted(orderId, driverId);

                setTimeout(refreshGlobalOrders, 1000);
            } else {
                showDriverResult(driverId, `âŒ æ¥å•å¤±è´¥: ${result.data?.message || result.error}`, true);
                buttons.forEach(btn => btn.disabled = false);
            }
        }

        async function rejectOrderFromNotification(driverId, orderId) {
            const notification = document.getElementById(`notification-${driverId}-${orderId}`);
            
            showDriverResult(driverId, `âŒ æ‹’ç»è®¢å• ${orderId}`);
            
            // ç§»é™¤é€šçŸ¥
            notification.remove();
            
            // ä»çŠ¶æ€ä¸­ç§»é™¤
            driverStates[driverId].notifications = driverStates[driverId].notifications.filter(
                n => n.orderId !== orderId
            );

            // å¦‚æœæ²¡æœ‰é€šçŸ¥äº†ï¼Œæ˜¾ç¤ºæç¤º
            const container = document.getElementById(`notifications-${driverId}`);
            if (container.children.length === 0) {
                container.innerHTML = '<div class="no-notifications">æš‚æ— è®¢å•æ¨é€</div>';
            }
        }

        function broadcastOrderAccepted(orderId, acceptedDriverId) {
            // ç§»é™¤æ‰€æœ‰å…¶ä»–å¸æœºçš„ç›¸åŒè®¢å•é€šçŸ¥
            DRIVERS_CONFIG.forEach(driver => {
                if (driver.id !== acceptedDriverId) {
                    removeOrderNotification(driver.id, orderId);
                }
            });
        }

        // ==================== æ‰¹é‡æ“ä½œå‡½æ•° ====================

        function initializeAllDrivers() {
            showPassengerResult('ğŸš€ æ­£åœ¨åˆå§‹åŒ–æ‰€æœ‰å¸æœº...');
            
            DRIVERS_CONFIG.forEach(async (driver, index) => {
                setTimeout(() => {
                    driverGoOnline(driver.id);
                }, index * 500); // é”™å¼€500msæ‰§è¡Œ
            });
        }

        function connectAllDrivers() {
            showPassengerResult('ğŸ”— æ­£åœ¨è¿æ¥æ‰€æœ‰å¸æœºçš„WebSocket...');
            
            DRIVERS_CONFIG.forEach((driver, index) => {
                setTimeout(() => {
                    connectDriverWebSocket(driver.id);
                }, index * 300); // é”™å¼€300msæ‰§è¡Œ
            });
        }

        function disconnectAllDrivers() {
            showPassengerResult('ğŸ”Œ æ­£åœ¨æ–­å¼€æ‰€æœ‰å¸æœºçš„WebSocket...');
            
            DRIVERS_CONFIG.forEach(driver => {
                disconnectDriverWebSocket(driver.id);
            });
        }

        // ==================== ä¹˜å®¢åŠŸèƒ½ ====================

        async function createOrder() {
            const passengerId = document.getElementById('passengerId').value;
            const pickupAddress = document.getElementById('pickupAddress').value;
            const pickupCoords = document.getElementById('pickupCoords').value.split(',');
            const destinationAddress = document.getElementById('destinationAddress').value;
            const destinationCoords = document.getElementById('destinationCoords').value.split(',');

            if (pickupCoords.length !== 2 || destinationCoords.length !== 2) {
                showPassengerResult('âŒ åæ ‡æ ¼å¼é”™è¯¯ï¼Œè¯·ä½¿ç”¨"çº¬åº¦,ç»åº¦"æ ¼å¼', true);
                return;
            }

            const orderData = {
                passengerId: parseInt(passengerId),
                pickupAddress: pickupAddress,
                pickupLatitude: parseFloat(pickupCoords[0]),
                pickupLongitude: parseFloat(pickupCoords[1]),
                destinationAddress: destinationAddress,
                destinationLatitude: parseFloat(destinationCoords[0]),
                destinationLongitude: parseFloat(destinationCoords[1]),
                orderType: 'REAL_TIME'
            };

            showPassengerResult('ğŸ“± æ­£åœ¨åˆ›å»ºè®¢å•...');

            const result = await apiCall('/api/orders/create', 'POST', orderData);

            if (result.success) {
                currentOrderId = result.data.data.id;
                showPassengerResult(`âœ… è®¢å•åˆ›å»ºæˆåŠŸï¼è®¢å•ID: ${currentOrderId}`);
                showPassengerResult(`ğŸ“¡ è®¢å•å·²æ¨é€ç»™ç¬¦åˆæ¡ä»¶çš„å¸æœº`);

                setTimeout(refreshGlobalOrders, 1000);
            } else {
                showPassengerResult(`âŒ è®¢å•åˆ›å»ºå¤±è´¥: ${result.data?.message || result.error}`, true);
            }
        }

        async function cancelOrder() {
            const orderId = currentOrderId || prompt('è¯·è¾“å…¥è¦å–æ¶ˆçš„è®¢å•ID:');

            if (!orderId) {
                showPassengerResult('âŒ è¯·å…ˆåˆ›å»ºè®¢å•æˆ–è¾“å…¥è®¢å•ID', true);
                return;
            }

            showPassengerResult(`ğŸš« æ­£åœ¨å–æ¶ˆè®¢å• ${orderId}...`);

            const result = await apiCall(`/api/orders/${orderId}/cancel`, 'POST');

            if (result.success) {
                showPassengerResult(`âœ… è®¢å• ${orderId} å–æ¶ˆæˆåŠŸ`);
                currentOrderId = null;
                setTimeout(refreshGlobalOrders, 1000);
            } else {
                showPassengerResult(`âŒ å–æ¶ˆè®¢å•å¤±è´¥: ${result.data?.message || result.error}`, true);
            }
        }

        // ==================== å…¨å±€è®¢å•çŠ¶æ€ ====================

        async function refreshGlobalOrders() {
            const result = await apiCall('/api/orders');

            if (result.success) {
                globalOrders = result.data.data || [];
                displayGlobalOrders();
            }
        }

        function displayGlobalOrders() {
            const container = document.getElementById('globalOrdersList');
            
            if (globalOrders.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #666; font-style: italic;">æš‚æ— è®¢å•</div>';
                return;
            }

            container.innerHTML = globalOrders.map(order => `
                <div class="order-item">
                    <div><strong>è®¢å• #${order.id}</strong> <span class="order-status status-${order.status.toLowerCase()}">${getStatusText(order.status)}</span></div>
                    <div>ğŸ“ ${order.pickupAddress}</div>
                    <div>ğŸ¯ ${order.destinationAddress}</div>
                    ${order.driverId ? `<div>ğŸš• å¸æœº: ${order.driverId}</div>` : ''}
                    <div style="font-size: 10px; color: #666;">${new Date(order.createTime).toLocaleString()}</div>
                </div>
            `).join('');
        }

        function getStatusText(status) {
            const statusMap = {
                'PENDING': 'å¾…æ¥å•',
                'ASSIGNED': 'å·²æ¥å•',
                'PICKUP': 'å‰å¾€æ¥å®¢',
                'IN_PROGRESS': 'è¡Œç¨‹ä¸­',
                'COMPLETED': 'å·²å®Œæˆ',
                'CANCELLED': 'å·²å–æ¶ˆ'
            };
            return statusMap[status] || status;
        }

        // ==================== å·¥å…·å‡½æ•° ====================

        function updateDriverStatus(driverId, online) {
            const panel = document.getElementById(`driver-panel-${driverId}`);
            const status = document.getElementById(`status-${driverId}`);
            
            if (online) {
                panel.className = 'driver-panel online';
                status.textContent = 'åœ¨çº¿';
                status.className = 'driver-status status-online';
            } else {
                panel.className = 'driver-panel offline';
                status.textContent = 'ç¦»çº¿';
                status.className = 'driver-status status-offline';
            }
        }

        function updateDriverConnectionStatus(driverId, connected) {
            // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ è¿æ¥çŠ¶æ€çš„è§†è§‰æŒ‡ç¤º
            if (connected) {
                showDriverResult(driverId, 'ğŸŸ¢ WebSocketå·²è¿æ¥');
            } else {
                showDriverResult(driverId, 'ğŸ”´ WebSocketå·²æ–­å¼€');
            }
        }

        function showDriverResult(driverId, message, isError = false) {
            const element = document.getElementById(`result-${driverId}`);
            const timestamp = new Date().toLocaleTimeString();
            const color = isError ? '#dc3545' : '#28a745';
            element.innerHTML += `<div style="color: ${color}; margin-bottom: 5px;">
                [${timestamp}] ${message}
            </div>`;
            element.scrollTop = element.scrollHeight;
        }

        function showPassengerResult(message, isError = false) {
            const element = document.getElementById('passengerResult');
            const timestamp = new Date().toLocaleTimeString();
            const color = isError ? '#dc3545' : '#28a745';
            element.innerHTML += `<div style="color: ${color}; margin-bottom: 5px;">
                [${timestamp}] ${message}
            </div>`;
            element.scrollTop = element.scrollHeight;
        }

        async function apiCall(url, method = 'GET', data = null) {
            try {
                const options = {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    }
                };

                if (data) {
                    options.body = JSON.stringify(data);
                }

                const response = await fetch(API_BASE_URL + url, options);
                const result = await response.json();

                return { success: response.ok, data: result };
            } catch (error) {
                return { success: false, error: error.message };
            }
        }

        function playNotificationSound() {
            // åˆ›å»ºç®€å•çš„æç¤ºéŸ³
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 800;
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);
            } catch (error) {
                console.log('æ— æ³•æ’­æ”¾æç¤ºéŸ³:', error);
            }
        }
    </script>
</body>
</html>