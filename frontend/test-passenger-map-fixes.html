<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>乘客端地图修复测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #409eff 0%, #337ecc 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .content {
            padding: 20px;
        }
        
        .fix-section {
            margin-bottom: 25px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: #fafafa;
        }
        
        .fix-section h3 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 16px;
        }
        
        .problem-card {
            background: #fef2f2;
            border: 1px solid #fca5a5;
            border-radius: 4px;
            padding: 12px;
            margin: 10px 0;
            color: #dc2626;
        }
        
        .solution-card {
            background: #f0f9ff;
            border: 1px solid #7dd3fc;
            border-radius: 4px;
            padding: 12px;
            margin: 10px 0;
            color: #0369a1;
        }
        
        .code-block {
            background: #f4f4f4;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            margin: 10px 0;
            overflow-x: auto;
            white-space: pre-wrap;
        }
        
        .test-button {
            background: #409eff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 12px;
        }
        
        .test-button:hover {
            background: #337ecc;
        }
        
        .test-button.success {
            background: #67c23a;
        }
        
        .test-button.success:hover {
            background: #5daf34;
        }
        
        .test-button.warning {
            background: #e6a23c;
        }
        
        .test-button.warning:hover {
            background: #cf9236;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🗺️ 乘客端地图修复测试</h1>
            <p>修复页面切换、订单取消和司机位置更新的问题</p>
        </div>
        
        <div class="content">
            <!-- 问题1: 页面切换后标记消失 -->
            <div class="fix-section">
                <h3>🔧 修复1: 页面切换后起始点和终点图标消失</h3>
                
                <div class="problem-card">
                    <strong>问题描述:</strong><br>
                    从其他页面切换回乘客地图页面时，上车点和目的地标记消失，只剩下路线。
                </div>
                
                <div class="solution-card">
                    <strong>解决方案:</strong><br>
                    在页面激活时检查并恢复所有地图标记，确保标记状态与订单状态一致。
                </div>
                
                <div class="code-block">// 修复代码 - 在initializePassengerMap中添加标记恢复逻辑
const restoreMapMarkers = () => {
  console.log('🔄 恢复地图标记...');
  
  // 恢复上车点标记
  if (currentPosition.value && !pickupMarker) {
    pickupMarker = new window.AMap.Marker({
      position: [currentPosition.value.lng, currentPosition.value.lat],
      map,
      icon: new window.AMap.Icon({
        image: 'https://webapi.amap.com/theme/v1.3/markers/n/start.png',
        size: new window.AMap.Size(25, 34),
        imageSize: new window.AMap.Size(25, 34)
      }),
      title: '上车点',
      draggable: !currentOrder.value
    });
    
    // 重新绑定拖拽事件
    pickupMarker.on("dragend", handlePickupDrag);
  }
  
  // 恢复目的地标记
  if (destinationPosition.value && !destMarker) {
    destMarker = new window.AMap.Marker({
      position: [destinationPosition.value.lng, destinationPosition.value.lat],
      map,
      icon: new window.AMap.Icon({
        image: 'https://webapi.amap.com/theme/v1.3/markers/n/end.png',
        size: new window.AMap.Size(25, 34),
        imageSize: new window.AMap.Size(25, 34)
      }),
      title: '目的地'
    });
  }
  
  // 恢复司机标记（如果有当前订单）
  if (currentOrder.value && driverInfo.value && !driverMarker) {
    driverMarker = new window.AMap.Marker({
      position: [driverInfo.value.longitude, driverInfo.value.latitude],
      map,
      icon: new window.AMap.Icon({
        image: 'https://webapi.amap.com/theme/v1.3/markers/n/mark_b.png',
        size: new window.AMap.Size(25, 34),
        imageSize: new window.AMap.Size(25, 34)
      }),
      title: '司机位置'
    });
  }
  
  console.log('✅ 地图标记恢复完成');
};</div>
                
                <button class="test-button" onclick="testMarkerRestore()">测试标记恢复</button>
            </div>
            
            <!-- 问题2: 订单取消后路径没有清除 -->
            <div class="fix-section">
                <h3>🔧 修复2: 取消订单后旧路径没有清除</h3>
                
                <div class="problem-card">
                    <strong>问题描述:</strong><br>
                    取消订单后，地图上仍然显示司机路径和乘客路径，没有被清理干净。
                </div>
                
                <div class="solution-card">
                    <strong>解决方案:</strong><br>
                    增强resetOrderState函数，确保清理所有路径和司机相关标记。
                </div>
                
                <div class="code-block">// 修复代码 - 增强resetOrderState函数
const resetOrderState = () => {
  console.log("🔄 重置订单状态");

  orderStore.clearOrderState();
  stopDriverTracking();

  // 清理司机标记
  if (driverMarker) {
    map.remove(driverMarker);
    driverMarker = null;
    console.log('🗑️ 已清理司机标记');
  }

  // 清理司机路径
  if (window.driverRouteLine) {
    map.remove(window.driverRouteLine);
    window.driverRouteLine = null;
    console.log('🗑️ 已清理司机路径');
  }

  // 清理所有红色路径（司机路径）
  const allOverlays = map.getAllOverlays();
  allOverlays.forEach(overlay => {
    if (overlay.CLASS_NAME === 'AMap.Polyline') {
      try {
        const options = overlay.getOptions();
        if (options && options.strokeColor === '#FF6B6B') {
          map.remove(overlay);
          console.log('🗑️ 清理了红色司机路径');
        }
      } catch (error) {
        // 忽略错误
      }
    }
  });

  // 恢复乘客路径为蓝色
  if (routeLine) {
    routeLine.setOptions({
      strokeColor: "#409EFF",
      strokeWeight: 6,
      strokeOpacity: 0.8,
    });
    console.log('🔄 乘客路径已恢复为蓝色');
  }

  // 重置状态
  window.routeInitialized = false;
  canOrder.value = true;
  isCalling.value = false;

  // 恢复上车点标记的可拖拽状态
  updatePickupMarkerDraggable();

  // 重新检查未支付订单
  orderStore.checkUnpaidOrders();
  
  console.log('✅ 订单状态重置完成');
};</div>
                
                <button class="test-button" onclick="testOrderReset()">测试订单重置</button>
            </div>
            
            <!-- 问题3: 司机位置更新后旧路径没有清除 -->
            <div class="fix-section">
                <h3>🔧 修复3: 司机位置更新后旧路径没有清除</h3>
                
                <div class="problem-card">
                    <strong>问题描述:</strong><br>
                    司机位置更新时，旧的司机路径没有被清除，导致地图上出现多条路径。
                </div>
                
                <div class="solution-card">
                    <strong>解决方案:</strong><br>
                    在司机位置更新时，先清除所有旧的司机路径，再规划新路径。
                </div>
                
                <div class="code-block">// 修复代码 - 增强司机位置更新处理
const updateDriverLocation = (data) => {
  console.log("📍 更新司机位置:", data);

  // 先清理所有旧的司机路径
  clearAllDriverRoutes();

  // 更新司机标记位置
  if (driverMarker) {
    driverMarker.setPosition([data.longitude, data.latitude]);
    driverMarker.setAnimation("AMAP_ANIMATION_BOUNCE");
    setTimeout(() => {
      if (driverMarker) {
        driverMarker.setAnimation("AMAP_ANIMATION_NONE");
      }
    }, 1000);
  } else {
    // 创建司机标记
    driverMarker = new window.AMap.Marker({
      position: [data.longitude, data.latitude],
      map,
      icon: new window.AMap.Icon({
        image: 'https://webapi.amap.com/theme/v1.3/markers/n/mark_b.png',
        size: new window.AMap.Size(25, 34),
        imageSize: new window.AMap.Size(25, 34)
      }),
      title: '司机位置'
    });
  }

  // 根据订单状态规划新路径
  if (currentOrder.value) {
    if (currentOrder.value.status === 'ASSIGNED' || currentOrder.value.status === 'PICKUP') {
      // 司机前往上车点
      updateDriverRoute(
        data.longitude, data.latitude,
        currentOrder.value.pickupLongitude, currentOrder.value.pickupLatitude
      );
    } else if (currentOrder.value.status === 'IN_PROGRESS') {
      // 司机前往目的地
      updateDriverRoute(
        data.longitude, data.latitude,
        currentOrder.value.destinationLongitude, currentOrder.value.destinationLatitude
      );
    }
  }
};

// 清理所有司机路径的函数
const clearAllDriverRoutes = () => {
  console.log('🧹 清理所有司机路径...');
  
  // 清理全局司机路径变量
  if (window.driverRouteLine) {
    map.remove(window.driverRouteLine);
    window.driverRouteLine = null;
  }
  
  // 清理所有红色路径
  const allOverlays = map.getAllOverlays();
  let cleanedCount = 0;
  
  allOverlays.forEach(overlay => {
    if (overlay.CLASS_NAME === 'AMap.Polyline') {
      try {
        const options = overlay.getOptions();
        if (options && options.strokeColor === '#FF6B6B') {
          map.remove(overlay);
          cleanedCount++;
        }
      } catch (error) {
        // 忽略错误
      }
    }
  });
  
  console.log(`🗑️ 清理了 ${cleanedCount} 条司机路径`);
};</div>
                
                <button class="test-button" onclick="testDriverLocationUpdate()">测试司机位置更新</button>
            </div>
            
            <!-- 综合测试 -->
            <div class="fix-section">
                <h3>🧪 综合测试</h3>
                
                <div class="solution-card">
                    <strong>测试场景:</strong><br>
                    1. 页面切换测试 - 切换到其他页面再回来<br>
                    2. 订单取消测试 - 取消订单后检查路径清理<br>
                    3. 司机位置更新测试 - 模拟司机位置变化<br>
                    4. 综合场景测试 - 组合多个操作
                </div>
                
                <button class="test-button success" onclick="runComprehensiveTest()">运行综合测试</button>
                <button class="test-button warning" onclick="simulatePageSwitch()">模拟页面切换</button>
                <button class="test-button warning" onclick="simulateOrderCancel()">模拟订单取消</button>
                <button class="test-button warning" onclick="simulateDriverMove()">模拟司机移动</button>
            </div>
            
            <!-- 调试工具 -->
            <div class="fix-section">
                <h3>🔧 调试工具</h3>
                
                <button class="test-button" onclick="checkMapState()">检查地图状态</button>
                <button class="test-button" onclick="listAllOverlays()">列出所有覆盖物</button>
                <button class="test-button" onclick="forceCleanMap()">强制清理地图</button>
                
                <div id="debugOutput" class="code-block" style="display: none; margin-top: 10px;">
                    调试信息将显示在这里...
                </div>
            </div>
        </div>
    </div>

    <script>
        // 测试函数
        function testMarkerRestore() {
            console.log('🧪 测试标记恢复功能');
            
            // 检查标记是否存在
            const markers = {
                pickup: window.pickupMarker,
                destination: window.destMarker,
                driver: window.driverMarker
            };
            
            console.log('当前标记状态:', markers);
            
            // 如果有恢复函数，调用它
            if (typeof window.restoreMapMarkers === 'function') {
                window.restoreMapMarkers();
                console.log('✅ 标记恢复函数已调用');
            } else {
                console.log('❌ 标记恢复函数不存在');
            }
        }
        
        function testOrderReset() {
            console.log('🧪 测试订单重置功能');
            
            // 如果有重置函数，调用它
            if (typeof window.resetOrderState === 'function') {
                window.resetOrderState();
                console.log('✅ 订单重置函数已调用');
            } else {
                console.log('❌ 订单重置函数不存在');
            }
        }
        
        function testDriverLocationUpdate() {
            console.log('🧪 测试司机位置更新功能');
            
            // 模拟司机位置数据
            const mockDriverData = {
                longitude: 116.397428 + (Math.random() - 0.5) * 0.01,
                latitude: 39.90923 + (Math.random() - 0.5) * 0.01,
                timestamp: Date.now()
            };
            
            console.log('模拟司机位置:', mockDriverData);
            
            // 如果有位置更新函数，调用它
            if (typeof window.updateDriverLocation === 'function') {
                window.updateDriverLocation(mockDriverData);
                console.log('✅ 司机位置更新函数已调用');
            } else {
                console.log('❌ 司机位置更新函数不存在');
            }
        }
        
        function runComprehensiveTest() {
            console.log('🧪 开始综合测试');
            
            // 测试序列
            const tests = [
                { name: '标记恢复', func: testMarkerRestore, delay: 0 },
                { name: '司机位置更新', func: testDriverLocationUpdate, delay: 2000 },
                { name: '订单重置', func: testOrderReset, delay: 4000 },
                { name: '地图状态检查', func: checkMapState, delay: 6000 }
            ];
            
            tests.forEach(test => {
                setTimeout(() => {
                    console.log(`🔄 执行测试: ${test.name}`);
                    test.func();
                }, test.delay);
            });
            
            setTimeout(() => {
                console.log('✅ 综合测试完成');
            }, 8000);
        }
        
        function simulatePageSwitch() {
            console.log('🧪 模拟页面切换');
            
            // 模拟页面失活
            console.log('📱 模拟页面失活...');
            
            // 延迟模拟页面激活
            setTimeout(() => {
                console.log('📱 模拟页面激活...');
                
                // 如果有初始化函数，调用它
                if (typeof window.initializePassengerMap === 'function') {
                    window.initializePassengerMap(true);
                    console.log('✅ 页面重新激活完成');
                } else {
                    console.log('❌ 页面初始化函数不存在');
                }
            }, 1000);
        }
        
        function simulateOrderCancel() {
            console.log('🧪 模拟订单取消');
            
            // 先创建一些测试路径
            console.log('📍 创建测试路径...');
            
            // 延迟执行取消
            setTimeout(() => {
                testOrderReset();
                console.log('✅ 订单取消模拟完成');
            }, 1000);
        }
        
        function simulateDriverMove() {
            console.log('🧪 模拟司机移动');
            
            // 连续更新司机位置
            for (let i = 0; i < 3; i++) {
                setTimeout(() => {
                    testDriverLocationUpdate();
                }, i * 1000);
            }
        }
        
        function checkMapState() {
            console.log('🔍 检查地图状态');
            
            const state = {
                mapExists: !!window.map,
                pickupMarker: !!window.pickupMarker,
                destMarker: !!window.destMarker,
                driverMarker: !!window.driverMarker,
                routeLine: !!window.routeLine,
                driverRouteLine: !!window.driverRouteLine,
                currentOrder: !!window.currentOrder?.value
            };
            
            console.log('地图状态:', state);
            
            const output = document.getElementById('debugOutput');
            output.style.display = 'block';
            output.textContent = JSON.stringify(state, null, 2);
        }
        
        function listAllOverlays() {
            console.log('📋 列出所有覆盖物');
            
            if (window.map && window.map.getAllOverlays) {
                const overlays = window.map.getAllOverlays();
                console.log(`总覆盖物数量: ${overlays.length}`);
                
                const overlayInfo = overlays.map((overlay, index) => {
                    try {
                        const info = {
                            index: index,
                            type: overlay.CLASS_NAME,
                            options: overlay.getOptions ? overlay.getOptions() : 'N/A'
                        };
                        return info;
                    } catch (error) {
                        return { index: index, type: 'Unknown', error: error.message };
                    }
                });
                
                console.log('覆盖物详情:', overlayInfo);
                
                const output = document.getElementById('debugOutput');
                output.style.display = 'block';
                output.textContent = JSON.stringify(overlayInfo, null, 2);
            } else {
                console.log('❌ 地图对象不存在或不支持getAllOverlays');
            }
        }
        
        function forceCleanMap() {
            console.log('🧹 强制清理地图');
            
            if (window.map) {
                // 清理所有覆盖物
                const overlays = window.map.getAllOverlays();
                overlays.forEach(overlay => {
                    try {
                        window.map.remove(overlay);
                    } catch (error) {
                        console.warn('清理覆盖物时出错:', error);
                    }
                });
                
                // 重置全局变量
                window.pickupMarker = null;
                window.destMarker = null;
                window.driverMarker = null;
                window.routeLine = null;
                window.driverRouteLine = null;
                
                console.log('✅ 地图强制清理完成');
            } else {
                console.log('❌ 地图对象不存在');
            }
        }
        
        // 页面加载完成后的初始化
        window.onload = function() {
            console.log('🚀 乘客端地图修复测试页面加载完成');
            console.log('💡 请在乘客端页面打开此测试页面进行调试');
        };
    </script>
</body>
</html>