<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¢„çº¦å•çŠ¶æ€æ˜¾ç¤ºä¿®å¤æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 3px;
        }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .info { background-color: #d1ecf1; color: #0c5460; }
        .warning { background-color: #fff3cd; color: #856404; }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 3px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background-color: #0056b3; }
        .status-preview {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 4px solid #007bff;
        }
    </style>
</head>
<body>
    <h1>é¢„çº¦å•çŠ¶æ€æ˜¾ç¤ºä¿®å¤æµ‹è¯•</h1>

    <div class="test-section">
        <h3>ğŸ¯ ä¿®å¤å†…å®¹</h3>
        <ul>
            <li>âœ… ä¹˜å®¢ç«¯æ˜¾ç¤ºå…·ä½“çš„é¢„çº¦æ—¶é—´ï¼Œè€Œä¸æ˜¯åªè¯´"é¢„çº¦æ—¶é—´å·²åˆ°"</li>
            <li>âœ… ä¿®å¤å¸æœºç«¯é€šçŸ¥å€’è®¡æ—¶æ˜¾ç¤ºNaNçš„é—®é¢˜</li>
            <li>âœ… ä¼˜åŒ–é¢„çº¦å•çŠ¶æ€æ–‡æœ¬çš„æ˜¾ç¤º</li>
        </ul>
    </div>

    <div class="test-section">
        <h3>ğŸ“± ä¹˜å®¢ç«¯çŠ¶æ€æ–‡æœ¬é¢„è§ˆ</h3>
        <div class="status-preview">
            <strong>ASSIGNEDçŠ¶æ€ï¼š</strong><br>
            å¸æœºå·²æ¥å•ï¼Œå°†äºé¢„çº¦æ—¶é—´ï¼ˆ2025-07-31 14:30:00ï¼‰å‰åˆ°è¾¾ä¸Šè½¦ç‚¹
        </div>
        <div class="status-preview">
            <strong>PICKUPçŠ¶æ€ï¼š</strong><br>
            å¸æœºå·²åˆ°è¾¾ä¸Šè½¦ç‚¹ï¼Œé¢„çº¦æ—¶é—´ï¼š2025-07-31 14:30:00ï¼Œè¯·å‡†å¤‡ä¸Šè½¦
        </div>
    </div>

    <div class="test-section">
        <h3>ğŸš— å¸æœºç«¯é€šçŸ¥ä¿®å¤</h3>
        <div class="status-preview">
            <strong>ä¿®å¤å‰ï¼š</strong> å€’è®¡æ—¶æ˜¾ç¤º NaN<br>
            <strong>ä¿®å¤åï¼š</strong> å€’è®¡æ—¶æ­£å¸¸æ˜¾ç¤º 30s, 29s, 28s...
        </div>
    </div>

    <div class="test-section">
        <h3>ğŸ§ª å®Œæ•´æµ‹è¯•æµç¨‹</h3>
        <button onclick="runCompleteTest()">è¿è¡Œå®Œæ•´æµ‹è¯•</button>
        <div id="testResult" class="result"></div>
    </div>

    <div class="test-section">
        <h3>ğŸ“‹ æ‰‹åŠ¨æµ‹è¯•æ­¥éª¤</h3>
        <ol>
            <li>åˆ›å»ºä¸€ä¸ªé¢„çº¦å•</li>
            <li>ç­‰å¾…é¢„çº¦å•æ¿€æ´»ï¼ˆæˆ–æ‰‹åŠ¨æ¿€æ´»ï¼‰</li>
            <li>å¸æœºä¸Šçº¿æ¥æ”¶é€šçŸ¥ï¼ˆæ£€æŸ¥å€’è®¡æ—¶æ˜¯å¦æ­£å¸¸ï¼‰</li>
            <li>å¸æœºæ¥å•ï¼ˆæ£€æŸ¥ä¹˜å®¢ç«¯çŠ¶æ€æ˜¾ç¤ºï¼‰</li>
            <li>å¸æœºç¡®è®¤åˆ°è¾¾ï¼ˆæ£€æŸ¥ä¹˜å®¢ç«¯çŠ¶æ€æ˜¾ç¤ºï¼‰</li>
        </ol>
        <div style="margin-top: 15px;">
            <a href="/passenger-app.html" target="_blank">
                <button>æ‰“å¼€ä¹˜å®¢ç«¯</button>
            </a>
            <a href="/driver-app.html" target="_blank">
                <button>æ‰“å¼€å¸æœºç«¯</button>
            </a>
        </div>
    </div>

    <script>
        async function runCompleteTest() {
            const resultDiv = document.getElementById('testResult');
            resultDiv.innerHTML = '<div class="info">ğŸ”„ å¼€å§‹å®Œæ•´æµ‹è¯•...</div>';

            try {
                // æ­¥éª¤1: åˆ›å»ºé¢„çº¦å•
                resultDiv.innerHTML = '<div class="info">ğŸ”„ æ­¥éª¤1: åˆ›å»ºé¢„çº¦å•...</div>';
                
                const scheduledTime = new Date();
                scheduledTime.setTime(scheduledTime.getTime() + 30 * 60 * 1000);
                
                const orderData = {
                    passengerId: 1,
                    pickupAddress: "çŠ¶æ€æµ‹è¯•ä¸Šè½¦åœ°å€",
                    pickupLatitude: 38.914677,
                    pickupLongitude: 121.619643,
                    destinationAddress: "çŠ¶æ€æµ‹è¯•ç›®çš„åœ°",
                    destinationLatitude: 38.924677,
                    destinationLongitude: 121.629643,
                    scheduledTime: formatDateTime(scheduledTime),
                    estimatedFare: 50.00
                };
                
                const createResponse = await fetch('/api/orders/scheduled', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(orderData)
                });
                
                const createResult = await createResponse.json();
                
                if (!createResponse.ok || createResult.code !== 200) {
                    throw new Error('åˆ›å»ºé¢„çº¦å•å¤±è´¥: ' + createResult.message);
                }
                
                const orderId = createResult.data.id;
                
                // æ­¥éª¤2: æ‰‹åŠ¨æ¿€æ´»é¢„çº¦å•
                resultDiv.innerHTML = '<div class="info">ğŸ”„ æ­¥éª¤2: æ¿€æ´»é¢„çº¦å•...</div>';
                
                // è¿™é‡Œæˆ‘ä»¬é€šè¿‡ç›´æ¥è°ƒç”¨æ´¾å•æœåŠ¡æ¥æ¿€æ´»
                const activateResponse = await fetch(`/api/orders/${orderId}/dispatch`, {
                    method: 'POST'
                });
                
                if (activateResponse.ok) {
                    resultDiv.innerHTML = '<div class="success">âœ… æµ‹è¯•å®Œæˆï¼<br><br>' +
                        '<strong>è¯·æ‰‹åŠ¨éªŒè¯ä»¥ä¸‹å†…å®¹ï¼š</strong><br>' +
                        '1. å¸æœºç«¯é€šçŸ¥å€’è®¡æ—¶æ˜¯å¦æ­£å¸¸æ˜¾ç¤º<br>' +
                        '2. å¸æœºæ¥å•åä¹˜å®¢ç«¯æ˜¯å¦æ˜¾ç¤ºå…·ä½“é¢„çº¦æ—¶é—´<br>' +
                        '3. å¸æœºåˆ°è¾¾åä¹˜å®¢ç«¯æ˜¯å¦æ˜¾ç¤ºå…·ä½“é¢„çº¦æ—¶é—´<br><br>' +
                        `<strong>æµ‹è¯•è®¢å•ID:</strong> ${orderId}<br>` +
                        `<strong>é¢„çº¦æ—¶é—´:</strong> ${scheduledTime.toLocaleString()}` +
                        '</div>';
                } else {
                    resultDiv.innerHTML = '<div class="warning">âš ï¸ é¢„çº¦å•åˆ›å»ºæˆåŠŸï¼Œä½†æ¿€æ´»å¤±è´¥<br>' +
                        'è¯·æ‰‹åŠ¨ç­‰å¾…20åˆ†é’Ÿåè‡ªåŠ¨æ¿€æ´»ï¼Œæˆ–åœ¨å¸æœºç«¯æµ‹è¯•é€šçŸ¥æ˜¾ç¤º</div>';
                }
                
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">âŒ æµ‹è¯•å¤±è´¥: ${error.message}</div>`;
            }
        }

        function formatDateTime(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');
            return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
        }
    </script>
</body>
</html>