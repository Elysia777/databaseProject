<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>评价对话框头像测试</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/element-plus/dist/index.full.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .driver-preview {
            display: flex;
            align-items: center;
            gap: 15px;
            margin: 10px 0;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 8px;
        }
        .driver-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            overflow: hidden;
            border: 2px solid #ddd;
        }
        .driver-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .driver-details {
            flex: 1;
        }
        .driver-name {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 5px;
        }
        .vehicle-info {
            color: #666;
            font-size: 14px;
        }
        .test-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .test-btn:hover {
            background: #0056b3;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .warning { color: #ffc107; }
    </style>
</head>
<body>
    <div id="app">
        <div class="container">
            <h1>📝 评价对话框头像测试</h1>
            
            <div class="test-section">
                <h3>🎯 测试说明</h3>
                <div class="log">
<strong>测试目的：</strong> 验证评价对话框中司机头像是否正确显示
<strong>修复内容：</strong> 
- 添加 buildAvatarUrl() 方法构建完整头像URL
- 修改头像显示逻辑使用完整URL
- 头像加载失败时显示默认头像

<strong>测试场景：</strong>
1. 有头像的司机 - 显示真实头像
2. 无头像的司机 - 显示默认头像  
3. 头像URL错误 - 自动降级到默认头像
                </div>
            </div>

            <div class="test-section">
                <h3>👨‍💼 司机信息预览</h3>
                <div v-for="driver in testDrivers" :key="driver.id" class="driver-preview">
                    <div class="driver-avatar">
                        <img 
                            :src="buildAvatarUrl(driver.avatar) || getDefaultAvatar(driver.name)" 
                            :alt="driver.name"
                            @error="handleAvatarError($event, driver.name)"
                        />
                    </div>
                    <div class="driver-details">
                        <div class="driver-name">{{ driver.name }}</div>
                        <div class="vehicle-info">{{ driver.plateNumber }} · {{ driver.carModel }}</div>
                        <small style="color: #999;">
                            头像路径: {{ driver.avatar || '无头像' }}
                        </small>
                    </div>
                    <el-button 
                        type="primary" 
                        size="small"
                        @click="openReviewDialog(driver)"
                    >
                        打开评价
                    </el-button>
                </div>
            </div>

            <div class="test-section">
                <h3>🧪 测试操作</h3>
                <el-button @click="loadRealDrivers">加载真实司机数据</el-button>
                <el-button @click="testAvatarUrls">测试头像URL访问</el-button>
                <el-button @click="clearLog">清空日志</el-button>
            </div>

            <div class="test-section">
                <h3>📝 测试日志</h3>
                <div ref="testLog" class="log" v-html="logContent"></div>
            </div>

            <!-- 评价对话框 (简化版本用于测试) -->
            <el-dialog
                v-model="reviewDialogVisible"
                title="评价此次行程"
                width="400px"
                :close-on-click-modal="false"
            >
                <div class="review-dialog">
                    <!-- 司机信息 -->
                    <div class="driver-info" style="display: flex; align-items: center; margin-bottom: 24px; padding: 16px; background: #f8f9fa; border-radius: 8px;">
                        <div class="driver-avatar" style="width: 50px; height: 50px; border-radius: 50%; overflow: hidden; margin-right: 12px;">
                            <img 
                                :src="buildAvatarUrl(currentDriver?.avatar) || getDefaultAvatar(currentDriver?.name)" 
                                :alt="currentDriver?.name"
                                @error="handleAvatarError($event, currentDriver?.name)"
                                style="width: 100%; height: 100%; object-fit: cover;"
                            />
                        </div>
                        <div class="driver-details" style="flex: 1;">
                            <div class="driver-name" style="font-size: 16px; font-weight: 600; color: #333; margin-bottom: 4px;">
                                {{ currentDriver?.name || '司机' }}
                            </div>
                            <div class="vehicle-info" style="font-size: 14px; color: #666;">
                                {{ currentDriver?.plateNumber }} · {{ currentDriver?.carModel }}
                            </div>
                        </div>
                    </div>

                    <!-- 评分 -->
                    <div class="rating-section" style="margin-bottom: 24px; text-align: center;">
                        <div class="section-title" style="font-size: 14px; font-weight: 600; color: #333; margin-bottom: 12px;">
                            请为此次行程打分
                        </div>
                        <div class="star-rating" style="margin: 16px 0;">
                            <span 
                                v-for="i in 5" 
                                :key="i"
                                class="star"
                                :class="{ active: i <= rating }"
                                @click="rating = i"
                                style="font-size: 32px; color: #ddd; cursor: pointer; margin: 0 4px; transition: color 0.2s;"
                                :style="{ color: i <= rating ? '#ffd700' : '#ddd' }"
                            >
                                ★
                            </span>
                        </div>
                        <div class="rating-text" style="font-size: 14px; color: #666; margin-top: 8px;">
                            {{ getRatingText(rating) }}
                        </div>
                    </div>
                </div>

                <template #footer>
                    <div class="dialog-footer">
                        <el-button @click="reviewDialogVisible = false">取消</el-button>
                        <el-button type="primary" @click="submitReview">提交评价</el-button>
                    </div>
                </template>
            </el-dialog>
        </div>
    </div>

    <script>
        const { createApp, ref, onMounted } = Vue;
        const { ElMessage, ElButton, ElDialog } = ElementPlus;

        createApp({
            components: {
                ElButton,
                ElDialog
            },
            setup() {
                const testDrivers = ref([
                    {
                        id: 1,
                        name: '张师傅',
                        plateNumber: '京A12345',
                        carModel: '大众朗逸',
                        avatar: '/uploads/avatars/driver1.jpg'
                    },
                    {
                        id: 2,
                        name: '李师傅', 
                        plateNumber: '京B67890',
                        carModel: '丰田卡罗拉',
                        avatar: '/uploads/avatars/driver2.jpg'
                    },
                    {
                        id: 3,
                        name: '王师傅',
                        plateNumber: '京C11111',
                        carModel: '本田雅阁',
                        avatar: null // 无头像
                    },
                    {
                        id: 4,
                        name: '赵师傅',
                        plateNumber: '京D22222',
                        carModel: '别克英朗',
                        avatar: '/uploads/avatars/nonexistent.jpg' // 不存在的头像
                    }
                ]);

                const reviewDialogVisible = ref(false);
                const currentDriver = ref(null);
                const rating = ref(0);
                const logContent = ref('');

                // 构建完整的头像URL
                const buildAvatarUrl = (avatarPath) => {
                    if (!avatarPath) return null;
                    if (avatarPath.startsWith('http')) return avatarPath;
                    return `http://localhost:8080${avatarPath}`;
                };

                // 获取默认头像
                const getDefaultAvatar = (name) => {
                    return `https://ui-avatars.com/api/?name=${encodeURIComponent(name || '司机')}&background=409EFF&color=fff&size=50`;
                };

                // 处理头像加载错误
                const handleAvatarError = (event, name) => {
                    log(`头像加载失败，使用默认头像: ${name}`, 'warning');
                    event.target.src = getDefaultAvatar(name);
                };

                // 日志记录
                const log = (message, type = 'info') => {
                    const timestamp = new Date().toLocaleTimeString();
                    const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : '';
                    logContent.value += `<div class="${className}">[${timestamp}] ${message}</div>`;
                };

                const clearLog = () => {
                    logContent.value = '';
                };

                // 打开评价对话框
                const openReviewDialog = (driver) => {
                    currentDriver.value = driver;
                    reviewDialogVisible.value = true;
                    rating.value = 0;
                    log(`打开司机 ${driver.name} 的评价对话框`);
                    
                    // 测试头像URL
                    const avatarUrl = buildAvatarUrl(driver.avatar);
                    if (avatarUrl) {
                        log(`司机头像URL: ${avatarUrl}`);
                    } else {
                        log(`司机 ${driver.name} 没有头像，将使用默认头像`, 'warning');
                    }
                };

                // 获取评分文本
                const getRatingText = (value) => {
                    const texts = {
                        0: '请选择评分',
                        1: '很不满意',
                        2: '不满意', 
                        3: '一般',
                        4: '满意',
                        5: '非常满意'
                    };
                    return texts[value] || '';
                };

                // 提交评价
                const submitReview = () => {
                    if (rating.value === 0) {
                        ElMessage.warning('请先选择评分');
                        return;
                    }
                    log(`提交评价: 司机 ${currentDriver.value.name}, 评分 ${rating.value}`, 'success');
                    ElMessage.success('评价提交成功');
                    reviewDialogVisible.value = false;
                };

                // 加载真实司机数据
                const loadRealDrivers = async () => {
                    log('开始加载真实司机数据...');
                    
                    try {
                        const response = await fetch('http://localhost:8080/api/users');
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }
                        
                        const result = await response.json();
                        
                        if (result.code === 200 && result.data) {
                            const users = result.data;
                            const drivers = users.filter(user => user.userType === 'DRIVER');
                            
                            log(`加载到 ${drivers.length} 个真实司机`, 'success');
                            
                            testDrivers.value = drivers.map(user => ({
                                id: user.id,
                                name: user.realName || user.username,
                                plateNumber: '京A' + String(user.id).padStart(5, '0'),
                                carModel: '测试车辆',
                                avatar: user.avatar
                            }));
                        } else {
                            log(`API返回错误: ${result.message}`, 'error');
                        }
                        
                    } catch (error) {
                        log(`加载司机数据失败: ${error.message}`, 'error');
                    }
                };

                // 测试头像URL访问
                const testAvatarUrls = async () => {
                    log('开始测试头像URL访问...');
                    
                    for (const driver of testDrivers.value) {
                        if (driver.avatar) {
                            const avatarUrl = buildAvatarUrl(driver.avatar);
                            log(`测试司机 ${driver.name} 头像: ${avatarUrl}`);
                            
                            try {
                                const response = await fetch(avatarUrl, { method: 'HEAD' });
                                if (response.ok) {
                                    log(`✅ 司机 ${driver.name} 头像访问成功`, 'success');
                                } else {
                                    log(`❌ 司机 ${driver.name} 头像访问失败: ${response.status}`, 'error');
                                }
                            } catch (error) {
                                log(`❌ 司机 ${driver.name} 头像网络错误: ${error.message}`, 'error');
                            }
                        } else {
                            log(`⚠️ 司机 ${driver.name} 没有设置头像`, 'warning');
                        }
                    }
                };

                onMounted(() => {
                    log('评价对话框头像测试工具已加载');
                    log('点击"打开评价"按钮测试头像显示效果');
                });

                return {
                    testDrivers,
                    reviewDialogVisible,
                    currentDriver,
                    rating,
                    logContent,
                    buildAvatarUrl,
                    getDefaultAvatar,
                    handleAvatarError,
                    log,
                    clearLog,
                    openReviewDialog,
                    getRatingText,
                    submitReview,
                    loadRealDrivers,
                    testAvatarUrls
                };
            }
        }).use(ElementPlus).mount('#app');
    </script>
</body>
</html>