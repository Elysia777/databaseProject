<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è®¢å•æ¢å¤æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #333;
        }
        button {
            background: #409EFF;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #66b1ff;
        }
        button.danger {
            background: #f56c6c;
        }
        button.success {
            background: #67c23a;
        }
        button.warning {
            background: #e6a23c;
        }
        .result-display {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 14px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .status-good {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .status-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .status-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        .scenario {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 4px solid #2196f3;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”„ è®¢å•æ¢å¤æµ‹è¯•</h1>
        <p>æµ‹è¯•å¸æœºé‡æ–°ç™»å½•æ—¶è¿›è¡Œä¸­è®¢å•çš„æ¢å¤åŠŸèƒ½</p>
    </div>

    <div class="container">
        <h2>ğŸ”§ ä¿®å¤è¯´æ˜</h2>
        <div class="test-section">
            <h3>é—®é¢˜æè¿°</h3>
            <p>ä¿®å¤é€€å‡ºç™»å½•é€»è¾‘åï¼Œå¸æœºé‡æ–°ç™»å½•æ—¶æ— æ³•åŠ è½½åŸæ¥çš„è®¢å•ã€‚</p>
            
            <h3>ä¿®å¤æ–¹æ¡ˆ</h3>
            <div class="scenario">
                <h4>åœºæ™¯1ï¼šå¸æœºæœ‰è¿›è¡Œä¸­è®¢å•æ—¶é‡æ–°ç™»å½•</h4>
                <ul>
                    <li>âœ… æ£€æµ‹åˆ°åç«¯åœ¨çº¿ä½†æœ¬åœ°æ— çŠ¶æ€</li>
                    <li>âœ… ä»åç«¯è·å–å½“å‰è®¢å•ä¿¡æ¯</li>
                    <li>âœ… å¦‚æœæœ‰è¿›è¡Œä¸­è®¢å•ï¼Œæ¢å¤å¸æœºçŠ¶æ€</li>
                    <li>âœ… é‡æ–°å»ºç«‹WebSocketè¿æ¥</li>
                    <li>âœ… æ¢å¤è®¢å•æ˜¾ç¤ºå’Œå¯¼èˆª</li>
                </ul>
            </div>
            
            <div class="scenario">
                <h4>åœºæ™¯2ï¼šå¸æœºæ— è¿›è¡Œä¸­è®¢å•æ—¶é‡æ–°ç™»å½•</h4>
                <ul>
                    <li>âœ… æ£€æµ‹åˆ°åç«¯åœ¨çº¿ä½†æœ¬åœ°æ— çŠ¶æ€</li>
                    <li>âœ… ç¡®è®¤æ— è¿›è¡Œä¸­è®¢å•</li>
                    <li>âœ… å¼ºåˆ¶ä¸‹çº¿ä¿æŒçŠ¶æ€ä¸€è‡´</li>
                    <li>âœ… æ˜¾ç¤ºä¸‹çº¿çŠ¶æ€</li>
                </ul>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="test-section">
            <h3>1. åˆ›å»ºè¿›è¡Œä¸­è®¢å•</h3>
            <button onclick="createAndAcceptOrder()">åˆ›å»ºè®¢å•å¹¶æ¥å•</button>
            <button onclick="updateOrderStatus()">æ›´æ–°è®¢å•çŠ¶æ€</button>
            
            <div id="orderResult" class="result-display">
                ç‚¹å‡»æŒ‰é’®åˆ›å»ºè¿›è¡Œä¸­çš„è®¢å•...
            </div>
        </div>

        <div class="test-section">
            <h3>2. æ£€æŸ¥åç«¯å½“å‰è®¢å•</h3>
            <button onclick="checkCurrentOrder()">æ£€æŸ¥å½“å‰è®¢å•</button>
            <button onclick="checkDriverStatus()">æ£€æŸ¥å¸æœºçŠ¶æ€</button>
            
            <div id="backendResult" class="result-display">
                ç‚¹å‡»æŒ‰é’®æ£€æŸ¥åç«¯çŠ¶æ€...
            </div>
        </div>

        <div class="test-section">
            <h3>3. æ¨¡æ‹ŸlocalStorageæ¸…é™¤</h3>
            <button onclick="clearLocalState()" class="warning">æ¸…é™¤æœ¬åœ°çŠ¶æ€</button>
            <button onclick="checkLocalState()">æ£€æŸ¥æœ¬åœ°çŠ¶æ€</button>
            
            <div id="localResult" class="result-display">
                ç‚¹å‡»æŒ‰é’®æ¸…é™¤æœ¬åœ°çŠ¶æ€...
            </div>
        </div>

        <div class="test-section">
            <h3>4. æµ‹è¯•çŠ¶æ€æ¢å¤</h3>
            <button onclick="testStateRecovery()" class="success">æµ‹è¯•çŠ¶æ€æ¢å¤</button>
            <button onclick="verifyRecovery()">éªŒè¯æ¢å¤ç»“æœ</button>
            
            <div id="recoveryResult" class="result-display">
                ç‚¹å‡»æŒ‰é’®æµ‹è¯•çŠ¶æ€æ¢å¤...
            </div>
        </div>
    </div>

    <div class="container">
        <h2>ğŸ“‹ æµ‹è¯•æ£€æŸ¥æ¸…å•</h2>
        <div class="test-section">
            <h3>éªŒè¯è¦ç‚¹</h3>
            <ul>
                <li>â–¡ å¸æœºæœ‰è¿›è¡Œä¸­è®¢å•æ—¶ï¼Œé‡æ–°ç™»å½•èƒ½æ¢å¤è®¢å•</li>
                <li>â–¡ æ¢å¤åçš„è®¢å•ä¿¡æ¯å®Œæ•´ï¼ˆçŠ¶æ€ã€åœ°å€ã€åæ ‡ç­‰ï¼‰</li>
                <li>â–¡ WebSocketè¿æ¥æ­£ç¡®é‡æ–°å»ºç«‹</li>
                <li>â–¡ è®¢å•å¯¼èˆªå’Œè·¯å¾„è§„åˆ’æ­£ç¡®æ¢å¤</li>
                <li>â–¡ å¸æœºæ— è®¢å•æ—¶ï¼Œé‡æ–°ç™»å½•æ˜¾ç¤ºä¸‹çº¿çŠ¶æ€</li>
                <li>â–¡ çŠ¶æ€æ¢å¤ä¸å½±å“æ­£å¸¸çš„ç™»å½•ç™»å‡ºæµç¨‹</li>
            </ul>
        </div>
    </div>

    <script>
        let testOrderId = null;

        function log(message, containerId) {
            const container = document.getElementById(containerId);
            const timestamp = new Date().toLocaleTimeString();
            container.textContent += `[${timestamp}] ${message}\\n`;
            container.scrollTop = container.scrollHeight;
            console.log(message);
        }

        async function createAndAcceptOrder() {
            const resultDiv = document.getElementById('orderResult');
            resultDiv.textContent = '';
            resultDiv.className = 'result-display';
            
            log('ğŸ“‹ åˆ›å»ºæµ‹è¯•è®¢å•...', 'orderResult');
            
            try {
                // 1. åˆ›å»ºè®¢å•
                const orderData = {
                    passengerId: 1,
                    pickupAddress: 'è®¢å•æ¢å¤æµ‹è¯• - å¤§è¿ç†å·¥å¤§å­¦',
                    pickupLatitude: 39.044237,
                    pickupLongitude: 121.749849,
                    destinationAddress: 'æµ‹è¯•ç›®çš„åœ° - å¤§è¿ç«è½¦ç«™',
                    destinationLatitude: 39.054237,
                    destinationLongitude: 121.759849
                };
                
                const orderResponse = await fetch('/api/orders/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(orderData)
                });
                
                if (orderResponse.ok) {
                    const orderResult = await orderResponse.json();
                    testOrderId = orderResult.data;
                    log(`âœ… è®¢å•åˆ›å»ºæˆåŠŸï¼ŒID: ${testOrderId}`, 'orderResult');
                    
                    // 2. å¸æœºæ¥å•
                    log('ğŸš— å¸æœºæ¥å•...', 'orderResult');
                    const acceptResponse = await fetch(`/api/drivers/1/accept-order/${testOrderId}`, {
                        method: 'POST'
                    });
                    
                    if (acceptResponse.ok) {
                        log('âœ… å¸æœºæ¥å•æˆåŠŸ', 'orderResult');
                        log('è®¢å•çŠ¶æ€: ASSIGNED', 'orderResult');
                        resultDiv.className = 'result-display status-good';
                    } else {
                        log(`âŒ å¸æœºæ¥å•å¤±è´¥: ${acceptResponse.status}`, 'orderResult');
                        resultDiv.className = 'result-display status-error';
                    }
                } else {
                    log(`âŒ è®¢å•åˆ›å»ºå¤±è´¥: ${orderResponse.status}`, 'orderResult');
                    resultDiv.className = 'result-display status-error';
                }
            } catch (error) {
                log(`âŒ æ“ä½œå¼‚å¸¸: ${error.message}`, 'orderResult');
                resultDiv.className = 'result-display status-error';
            }
        }

        async function updateOrderStatus() {
            if (!testOrderId) {
                log('âŒ è¯·å…ˆåˆ›å»ºå¹¶æ¥å•', 'orderResult');
                return;
            }
            
            log('\\nğŸ”„ æ›´æ–°è®¢å•çŠ¶æ€åˆ°IN_PROGRESS...', 'orderResult');
            
            try {
                // å…ˆç¡®è®¤åˆ°è¾¾
                const pickupResponse = await fetch(`/api/orders/${testOrderId}/pickup`, {
                    method: 'POST'
                });
                
                if (pickupResponse.ok) {
                    log('âœ… è®¢å•çŠ¶æ€æ›´æ–°ä¸ºPICKUP', 'orderResult');
                    
                    // å†å¼€å§‹è¡Œç¨‹
                    setTimeout(async () => {
                        const startResponse = await fetch(`/api/orders/${testOrderId}/start`, {
                            method: 'POST'
                        });
                        
                        if (startResponse.ok) {
                            log('âœ… è®¢å•çŠ¶æ€æ›´æ–°ä¸ºIN_PROGRESS', 'orderResult');
                            log('ç°åœ¨æœ‰ä¸€ä¸ªè¿›è¡Œä¸­çš„è®¢å•', 'orderResult');
                        } else {
                            log(`âŒ å¼€å§‹è¡Œç¨‹å¤±è´¥: ${startResponse.status}`, 'orderResult');
                        }
                    }, 1000);
                } else {
                    log(`âŒ ç¡®è®¤åˆ°è¾¾å¤±è´¥: ${pickupResponse.status}`, 'orderResult');
                }
            } catch (error) {
                log(`âŒ æ›´æ–°çŠ¶æ€å¼‚å¸¸: ${error.message}`, 'orderResult');
            }
        }

        async function checkCurrentOrder() {
            const resultDiv = document.getElementById('backendResult');
            resultDiv.textContent = '';
            resultDiv.className = 'result-display';
            
            log('ğŸ” æ£€æŸ¥å¸æœºå½“å‰è®¢å•...', 'backendResult');
            
            try {
                const response = await fetch('/api/drivers/1/current-order');
                if (response.ok) {
                    const result = await response.json();
                    const order = result.data;
                    
                    if (order) {
                        log('âœ… æ‰¾åˆ°å½“å‰è®¢å•', 'backendResult');
                        log(`è®¢å•ID: ${order.id}`, 'backendResult');
                        log(`è®¢å•å·: ${order.orderNumber}`, 'backendResult');
                        log(`è®¢å•çŠ¶æ€: ${order.status}`, 'backendResult');
                        log(`ä¸Šè½¦åœ°å€: ${order.pickupAddress}`, 'backendResult');
                        log(`ç›®çš„åœ°å€: ${order.destinationAddress}`, 'backendResult');
                        log(`ä¸Šè½¦åæ ‡: ${order.pickupLatitude}, ${order.pickupLongitude}`, 'backendResult');
                        log(`ç›®çš„åæ ‡: ${order.destinationLatitude}, ${order.destinationLongitude}`, 'backendResult');
                        resultDiv.className = 'result-display status-good';
                    } else {
                        log('âš ï¸ æ²¡æœ‰å½“å‰è®¢å•', 'backendResult');
                        resultDiv.className = 'result-display status-warning';
                    }
                } else {
                    log(`âŒ æ£€æŸ¥å½“å‰è®¢å•å¤±è´¥: ${response.status}`, 'backendResult');
                    resultDiv.className = 'result-display status-error';
                }
            } catch (error) {
                log(`âŒ æ£€æŸ¥å½“å‰è®¢å•å¼‚å¸¸: ${error.message}`, 'backendResult');
                resultDiv.className = 'result-display status-error';
            }
        }

        async function checkDriverStatus() {
            log('\\nğŸ” æ£€æŸ¥å¸æœºçŠ¶æ€è¯¦æƒ…...', 'backendResult');
            
            try {
                const response = await fetch('/api/drivers/1/status-detail');
                if (response.ok) {
                    const result = await response.json();
                    const detail = result.data;
                    
                    log(`å¸æœºåœ¨çº¿ä¸”ç©ºé—²: ${detail.isOnlineAndFree}`, 'backendResult');
                    log(`æ•°æ®åº“å­˜åœ¨: ${detail.consistency.dbExists}`, 'backendResult');
                    log(`Rediså­˜åœ¨: ${detail.consistency.redisExists}`, 'backendResult');
                } else {
                    log(`âŒ æ£€æŸ¥å¸æœºçŠ¶æ€å¤±è´¥: ${response.status}`, 'backendResult');
                }
            } catch (error) {
                log(`âŒ æ£€æŸ¥å¸æœºçŠ¶æ€å¼‚å¸¸: ${error.message}`, 'backendResult');
            }
        }

        function clearLocalState() {
            const resultDiv = document.getElementById('localResult');
            resultDiv.textContent = '';
            resultDiv.className = 'result-display';
            
            log('ğŸ§¹ æ¸…é™¤æœ¬åœ°çŠ¶æ€...', 'localResult');
            
            // æ¸…é™¤å¸æœºç›¸å…³çš„localStorage
            localStorage.removeItem('driverState');
            localStorage.removeItem('driverUserId');
            localStorage.removeItem('currentOrder');
            localStorage.removeItem('orderStatus');
            localStorage.removeItem('driverInfo');
            localStorage.removeItem('orderUserId');
            
            log('âœ… æœ¬åœ°çŠ¶æ€å·²æ¸…é™¤', 'localResult');
            log('æ¨¡æ‹Ÿå¸æœºé‡æ–°ç™»å½•åçš„çŠ¶æ€', 'localResult');
            resultDiv.className = 'result-display status-good';
        }

        function checkLocalState() {
            log('\\nğŸ” æ£€æŸ¥æœ¬åœ°çŠ¶æ€...', 'localResult');
            
            const driverState = localStorage.getItem('driverState');
            const token = localStorage.getItem('token');
            
            log(`Tokenå­˜åœ¨: ${!!token}`, 'localResult');
            log(`å¸æœºçŠ¶æ€å­˜åœ¨: ${!!driverState}`, 'localResult');
            
            if (driverState) {
                try {
                    const state = JSON.parse(driverState);
                    log(`å¸æœºåœ¨çº¿: ${state.isOnline}`, 'localResult');
                    log(`å½“å‰è®¢å•: ${state.currentOrder ? state.currentOrder.orderNumber : 'æ— '}`, 'localResult');
                } catch (error) {
                    log(`è§£æçŠ¶æ€å¤±è´¥: ${error.message}`, 'localResult');
                }
            } else {
                log('æœ¬åœ°æ— å¸æœºçŠ¶æ€ï¼Œæ¨¡æ‹Ÿé‡æ–°ç™»å½•åœºæ™¯', 'localResult');
            }
        }

        async function testStateRecovery() {
            const resultDiv = document.getElementById('recoveryResult');
            resultDiv.textContent = '';
            resultDiv.className = 'result-display';
            
            log('ğŸ”„ æµ‹è¯•çŠ¶æ€æ¢å¤é€»è¾‘...', 'recoveryResult');
            
            try {
                // æ¨¡æ‹ŸçŠ¶æ€æ¢å¤è¿‡ç¨‹
                log('1. æ£€æŸ¥localStorageä¸­çš„å¸æœºçŠ¶æ€...', 'recoveryResult');
                const savedState = localStorage.getItem('driverState');
                
                if (!savedState) {
                    log('âœ… æœ¬åœ°æ— çŠ¶æ€ï¼Œç»§ç»­æ£€æŸ¥åç«¯', 'recoveryResult');
                    
                    log('2. ä»åç«¯è·å–å¸æœºçŠ¶æ€...', 'recoveryResult');
                    const statusResponse = await fetch('/api/drivers/1/status-detail');
                    
                    if (statusResponse.ok) {
                        const statusResult = await statusResponse.json();
                        const backendStatus = statusResult.data;
                        
                        log(`åç«¯åœ¨çº¿çŠ¶æ€: ${backendStatus.isOnlineAndFree}`, 'recoveryResult');
                        
                        if (backendStatus.isOnlineAndFree) {
                            log('3. æ£€æŸ¥æ˜¯å¦æœ‰è¿›è¡Œä¸­çš„è®¢å•...', 'recoveryResult');
                            
                            const orderResponse = await fetch('/api/drivers/1/current-order');
                            if (orderResponse.ok) {
                                const orderResult = await orderResponse.json();
                                const currentOrderData = orderResult.data;
                                
                                if (currentOrderData && ['ASSIGNED', 'PICKUP', 'IN_PROGRESS'].includes(currentOrderData.status)) {
                                    log('âœ… å‘ç°è¿›è¡Œä¸­çš„è®¢å•ï¼Œåº”è¯¥æ¢å¤çŠ¶æ€', 'recoveryResult');
                                    log(`è®¢å•çŠ¶æ€: ${currentOrderData.status}`, 'recoveryResult');
                                    log(`è®¢å•å·: ${currentOrderData.orderNumber}`, 'recoveryResult');
                                    
                                    // æ¨¡æ‹Ÿæ¢å¤çŠ¶æ€
                                    const recoveredState = {
                                        isOnline: true,
                                        currentPosition: { lng: 121.749849, lat: 39.044237 },
                                        todayEarnings: 0,
                                        completedOrders: 0,
                                        currentOrder: currentOrderData,
                                        navigationInfo: null,
                                        pendingOrders: [],
                                        driverId: 1,
                                        timestamp: Date.now()
                                    };
                                    
                                    localStorage.setItem('driverState', JSON.stringify(recoveredState));
                                    localStorage.setItem('driverUserId', '1');
                                    
                                    log('âœ… çŠ¶æ€æ¢å¤æˆåŠŸ', 'recoveryResult');
                                    resultDiv.className = 'result-display status-good';
                                } else {
                                    log('âš ï¸ æ— è¿›è¡Œä¸­è®¢å•ï¼Œåº”è¯¥å¼ºåˆ¶ä¸‹çº¿', 'recoveryResult');
                                    resultDiv.className = 'result-display status-warning';
                                }
                            }
                        } else {
                            log('âœ… åç«¯æ˜¾ç¤ºä¸‹çº¿ï¼ŒçŠ¶æ€ä¸€è‡´', 'recoveryResult');
                            resultDiv.className = 'result-display status-good';
                        }
                    }
                } else {
                    log('âœ… æœ¬åœ°æœ‰çŠ¶æ€ï¼Œæ­£å¸¸æ¢å¤', 'recoveryResult');
                    resultDiv.className = 'result-display status-good';
                }
            } catch (error) {
                log(`âŒ çŠ¶æ€æ¢å¤æµ‹è¯•å¼‚å¸¸: ${error.message}`, 'recoveryResult');
                resultDiv.className = 'result-display status-error';
            }
        }

        function verifyRecovery() {
            log('\\nğŸ” éªŒè¯æ¢å¤ç»“æœ...', 'recoveryResult');
            
            const driverState = localStorage.getItem('driverState');
            
            if (driverState) {
                try {
                    const state = JSON.parse(driverState);
                    log('âœ… çŠ¶æ€å·²æ¢å¤', 'recoveryResult');
                    log(`åœ¨çº¿çŠ¶æ€: ${state.isOnline}`, 'recoveryResult');
                    log(`å½“å‰è®¢å•: ${state.currentOrder ? state.currentOrder.orderNumber : 'æ— '}`, 'recoveryResult');
                    
                    if (state.currentOrder) {
                        log(`è®¢å•çŠ¶æ€: ${state.currentOrder.status}`, 'recoveryResult');
                        log(`ä¸Šè½¦åœ°å€: ${state.currentOrder.pickupAddress}`, 'recoveryResult');
                        log(`ç›®çš„åœ°å€: ${state.currentOrder.destinationAddress}`, 'recoveryResult');
                        
                        if (state.currentOrder.pickupLatitude && state.currentOrder.pickupLongitude) {
                            log('âœ… è®¢å•åæ ‡ä¿¡æ¯å®Œæ•´', 'recoveryResult');
                        } else {
                            log('âŒ è®¢å•åæ ‡ä¿¡æ¯ç¼ºå¤±', 'recoveryResult');
                        }
                    }
                    
                    document.getElementById('recoveryResult').className = 'result-display status-good';
                } catch (error) {
                    log(`âŒ è§£ææ¢å¤çŠ¶æ€å¤±è´¥: ${error.message}`, 'recoveryResult');
                    document.getElementById('recoveryResult').className = 'result-display status-error';
                }
            } else {
                log('âš ï¸ æ²¡æœ‰æ¢å¤çŠ¶æ€', 'recoveryResult');
                document.getElementById('recoveryResult').className = 'result-display status-warning';
            }
        }

        // é¡µé¢åŠ è½½æ—¶çš„è¯´æ˜
        window.onload = function() {
            log('é¡µé¢åŠ è½½å®Œæˆï¼Œè¯·æŒ‰é¡ºåºè¿›è¡Œæµ‹è¯•', 'orderResult');
            log('1. å…ˆåˆ›å»ºè®¢å•å¹¶æ¥å•', 'orderResult');
            log('2. æ›´æ–°è®¢å•çŠ¶æ€åˆ°è¿›è¡Œä¸­', 'orderResult');
            log('3. æ¸…é™¤æœ¬åœ°çŠ¶æ€æ¨¡æ‹Ÿé‡æ–°ç™»å½•', 'orderResult');
            log('4. æµ‹è¯•çŠ¶æ€æ¢å¤åŠŸèƒ½', 'orderResult');
        };
    </script>
</body>
</html>