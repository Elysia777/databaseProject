<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>订单恢复测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #333;
        }
        button {
            background: #409EFF;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #66b1ff;
        }
        button.danger {
            background: #f56c6c;
        }
        button.success {
            background: #67c23a;
        }
        button.warning {
            background: #e6a23c;
        }
        .result-display {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 14px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .status-good {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .status-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .status-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        .scenario {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 4px solid #2196f3;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔄 订单恢复测试</h1>
        <p>测试司机重新登录时进行中订单的恢复功能</p>
    </div>

    <div class="container">
        <h2>🔧 修复说明</h2>
        <div class="test-section">
            <h3>问题描述</h3>
            <p>修复退出登录逻辑后，司机重新登录时无法加载原来的订单。</p>
            
            <h3>修复方案</h3>
            <div class="scenario">
                <h4>场景1：司机有进行中订单时重新登录</h4>
                <ul>
                    <li>✅ 检测到后端在线但本地无状态</li>
                    <li>✅ 从后端获取当前订单信息</li>
                    <li>✅ 如果有进行中订单，恢复司机状态</li>
                    <li>✅ 重新建立WebSocket连接</li>
                    <li>✅ 恢复订单显示和导航</li>
                </ul>
            </div>
            
            <div class="scenario">
                <h4>场景2：司机无进行中订单时重新登录</h4>
                <ul>
                    <li>✅ 检测到后端在线但本地无状态</li>
                    <li>✅ 确认无进行中订单</li>
                    <li>✅ 强制下线保持状态一致</li>
                    <li>✅ 显示下线状态</li>
                </ul>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="test-section">
            <h3>1. 创建进行中订单</h3>
            <button onclick="createAndAcceptOrder()">创建订单并接单</button>
            <button onclick="updateOrderStatus()">更新订单状态</button>
            
            <div id="orderResult" class="result-display">
                点击按钮创建进行中的订单...
            </div>
        </div>

        <div class="test-section">
            <h3>2. 检查后端当前订单</h3>
            <button onclick="checkCurrentOrder()">检查当前订单</button>
            <button onclick="checkDriverStatus()">检查司机状态</button>
            
            <div id="backendResult" class="result-display">
                点击按钮检查后端状态...
            </div>
        </div>

        <div class="test-section">
            <h3>3. 模拟localStorage清除</h3>
            <button onclick="clearLocalState()" class="warning">清除本地状态</button>
            <button onclick="checkLocalState()">检查本地状态</button>
            
            <div id="localResult" class="result-display">
                点击按钮清除本地状态...
            </div>
        </div>

        <div class="test-section">
            <h3>4. 测试状态恢复</h3>
            <button onclick="testStateRecovery()" class="success">测试状态恢复</button>
            <button onclick="verifyRecovery()">验证恢复结果</button>
            
            <div id="recoveryResult" class="result-display">
                点击按钮测试状态恢复...
            </div>
        </div>
    </div>

    <div class="container">
        <h2>📋 测试检查清单</h2>
        <div class="test-section">
            <h3>验证要点</h3>
            <ul>
                <li>□ 司机有进行中订单时，重新登录能恢复订单</li>
                <li>□ 恢复后的订单信息完整（状态、地址、坐标等）</li>
                <li>□ WebSocket连接正确重新建立</li>
                <li>□ 订单导航和路径规划正确恢复</li>
                <li>□ 司机无订单时，重新登录显示下线状态</li>
                <li>□ 状态恢复不影响正常的登录登出流程</li>
            </ul>
        </div>
    </div>

    <script>
        let testOrderId = null;

        function log(message, containerId) {
            const container = document.getElementById(containerId);
            const timestamp = new Date().toLocaleTimeString();
            container.textContent += `[${timestamp}] ${message}\\n`;
            container.scrollTop = container.scrollHeight;
            console.log(message);
        }

        async function createAndAcceptOrder() {
            const resultDiv = document.getElementById('orderResult');
            resultDiv.textContent = '';
            resultDiv.className = 'result-display';
            
            log('📋 创建测试订单...', 'orderResult');
            
            try {
                // 1. 创建订单
                const orderData = {
                    passengerId: 1,
                    pickupAddress: '订单恢复测试 - 大连理工大学',
                    pickupLatitude: 39.044237,
                    pickupLongitude: 121.749849,
                    destinationAddress: '测试目的地 - 大连火车站',
                    destinationLatitude: 39.054237,
                    destinationLongitude: 121.759849
                };
                
                const orderResponse = await fetch('/api/orders/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(orderData)
                });
                
                if (orderResponse.ok) {
                    const orderResult = await orderResponse.json();
                    testOrderId = orderResult.data;
                    log(`✅ 订单创建成功，ID: ${testOrderId}`, 'orderResult');
                    
                    // 2. 司机接单
                    log('🚗 司机接单...', 'orderResult');
                    const acceptResponse = await fetch(`/api/drivers/1/accept-order/${testOrderId}`, {
                        method: 'POST'
                    });
                    
                    if (acceptResponse.ok) {
                        log('✅ 司机接单成功', 'orderResult');
                        log('订单状态: ASSIGNED', 'orderResult');
                        resultDiv.className = 'result-display status-good';
                    } else {
                        log(`❌ 司机接单失败: ${acceptResponse.status}`, 'orderResult');
                        resultDiv.className = 'result-display status-error';
                    }
                } else {
                    log(`❌ 订单创建失败: ${orderResponse.status}`, 'orderResult');
                    resultDiv.className = 'result-display status-error';
                }
            } catch (error) {
                log(`❌ 操作异常: ${error.message}`, 'orderResult');
                resultDiv.className = 'result-display status-error';
            }
        }

        async function updateOrderStatus() {
            if (!testOrderId) {
                log('❌ 请先创建并接单', 'orderResult');
                return;
            }
            
            log('\\n🔄 更新订单状态到IN_PROGRESS...', 'orderResult');
            
            try {
                // 先确认到达
                const pickupResponse = await fetch(`/api/orders/${testOrderId}/pickup`, {
                    method: 'POST'
                });
                
                if (pickupResponse.ok) {
                    log('✅ 订单状态更新为PICKUP', 'orderResult');
                    
                    // 再开始行程
                    setTimeout(async () => {
                        const startResponse = await fetch(`/api/orders/${testOrderId}/start`, {
                            method: 'POST'
                        });
                        
                        if (startResponse.ok) {
                            log('✅ 订单状态更新为IN_PROGRESS', 'orderResult');
                            log('现在有一个进行中的订单', 'orderResult');
                        } else {
                            log(`❌ 开始行程失败: ${startResponse.status}`, 'orderResult');
                        }
                    }, 1000);
                } else {
                    log(`❌ 确认到达失败: ${pickupResponse.status}`, 'orderResult');
                }
            } catch (error) {
                log(`❌ 更新状态异常: ${error.message}`, 'orderResult');
            }
        }

        async function checkCurrentOrder() {
            const resultDiv = document.getElementById('backendResult');
            resultDiv.textContent = '';
            resultDiv.className = 'result-display';
            
            log('🔍 检查司机当前订单...', 'backendResult');
            
            try {
                const response = await fetch('/api/drivers/1/current-order');
                if (response.ok) {
                    const result = await response.json();
                    const order = result.data;
                    
                    if (order) {
                        log('✅ 找到当前订单', 'backendResult');
                        log(`订单ID: ${order.id}`, 'backendResult');
                        log(`订单号: ${order.orderNumber}`, 'backendResult');
                        log(`订单状态: ${order.status}`, 'backendResult');
                        log(`上车地址: ${order.pickupAddress}`, 'backendResult');
                        log(`目的地址: ${order.destinationAddress}`, 'backendResult');
                        log(`上车坐标: ${order.pickupLatitude}, ${order.pickupLongitude}`, 'backendResult');
                        log(`目的坐标: ${order.destinationLatitude}, ${order.destinationLongitude}`, 'backendResult');
                        resultDiv.className = 'result-display status-good';
                    } else {
                        log('⚠️ 没有当前订单', 'backendResult');
                        resultDiv.className = 'result-display status-warning';
                    }
                } else {
                    log(`❌ 检查当前订单失败: ${response.status}`, 'backendResult');
                    resultDiv.className = 'result-display status-error';
                }
            } catch (error) {
                log(`❌ 检查当前订单异常: ${error.message}`, 'backendResult');
                resultDiv.className = 'result-display status-error';
            }
        }

        async function checkDriverStatus() {
            log('\\n🔍 检查司机状态详情...', 'backendResult');
            
            try {
                const response = await fetch('/api/drivers/1/status-detail');
                if (response.ok) {
                    const result = await response.json();
                    const detail = result.data;
                    
                    log(`司机在线且空闲: ${detail.isOnlineAndFree}`, 'backendResult');
                    log(`数据库存在: ${detail.consistency.dbExists}`, 'backendResult');
                    log(`Redis存在: ${detail.consistency.redisExists}`, 'backendResult');
                } else {
                    log(`❌ 检查司机状态失败: ${response.status}`, 'backendResult');
                }
            } catch (error) {
                log(`❌ 检查司机状态异常: ${error.message}`, 'backendResult');
            }
        }

        function clearLocalState() {
            const resultDiv = document.getElementById('localResult');
            resultDiv.textContent = '';
            resultDiv.className = 'result-display';
            
            log('🧹 清除本地状态...', 'localResult');
            
            // 清除司机相关的localStorage
            localStorage.removeItem('driverState');
            localStorage.removeItem('driverUserId');
            localStorage.removeItem('currentOrder');
            localStorage.removeItem('orderStatus');
            localStorage.removeItem('driverInfo');
            localStorage.removeItem('orderUserId');
            
            log('✅ 本地状态已清除', 'localResult');
            log('模拟司机重新登录后的状态', 'localResult');
            resultDiv.className = 'result-display status-good';
        }

        function checkLocalState() {
            log('\\n🔍 检查本地状态...', 'localResult');
            
            const driverState = localStorage.getItem('driverState');
            const token = localStorage.getItem('token');
            
            log(`Token存在: ${!!token}`, 'localResult');
            log(`司机状态存在: ${!!driverState}`, 'localResult');
            
            if (driverState) {
                try {
                    const state = JSON.parse(driverState);
                    log(`司机在线: ${state.isOnline}`, 'localResult');
                    log(`当前订单: ${state.currentOrder ? state.currentOrder.orderNumber : '无'}`, 'localResult');
                } catch (error) {
                    log(`解析状态失败: ${error.message}`, 'localResult');
                }
            } else {
                log('本地无司机状态，模拟重新登录场景', 'localResult');
            }
        }

        async function testStateRecovery() {
            const resultDiv = document.getElementById('recoveryResult');
            resultDiv.textContent = '';
            resultDiv.className = 'result-display';
            
            log('🔄 测试状态恢复逻辑...', 'recoveryResult');
            
            try {
                // 模拟状态恢复过程
                log('1. 检查localStorage中的司机状态...', 'recoveryResult');
                const savedState = localStorage.getItem('driverState');
                
                if (!savedState) {
                    log('✅ 本地无状态，继续检查后端', 'recoveryResult');
                    
                    log('2. 从后端获取司机状态...', 'recoveryResult');
                    const statusResponse = await fetch('/api/drivers/1/status-detail');
                    
                    if (statusResponse.ok) {
                        const statusResult = await statusResponse.json();
                        const backendStatus = statusResult.data;
                        
                        log(`后端在线状态: ${backendStatus.isOnlineAndFree}`, 'recoveryResult');
                        
                        if (backendStatus.isOnlineAndFree) {
                            log('3. 检查是否有进行中的订单...', 'recoveryResult');
                            
                            const orderResponse = await fetch('/api/drivers/1/current-order');
                            if (orderResponse.ok) {
                                const orderResult = await orderResponse.json();
                                const currentOrderData = orderResult.data;
                                
                                if (currentOrderData && ['ASSIGNED', 'PICKUP', 'IN_PROGRESS'].includes(currentOrderData.status)) {
                                    log('✅ 发现进行中的订单，应该恢复状态', 'recoveryResult');
                                    log(`订单状态: ${currentOrderData.status}`, 'recoveryResult');
                                    log(`订单号: ${currentOrderData.orderNumber}`, 'recoveryResult');
                                    
                                    // 模拟恢复状态
                                    const recoveredState = {
                                        isOnline: true,
                                        currentPosition: { lng: 121.749849, lat: 39.044237 },
                                        todayEarnings: 0,
                                        completedOrders: 0,
                                        currentOrder: currentOrderData,
                                        navigationInfo: null,
                                        pendingOrders: [],
                                        driverId: 1,
                                        timestamp: Date.now()
                                    };
                                    
                                    localStorage.setItem('driverState', JSON.stringify(recoveredState));
                                    localStorage.setItem('driverUserId', '1');
                                    
                                    log('✅ 状态恢复成功', 'recoveryResult');
                                    resultDiv.className = 'result-display status-good';
                                } else {
                                    log('⚠️ 无进行中订单，应该强制下线', 'recoveryResult');
                                    resultDiv.className = 'result-display status-warning';
                                }
                            }
                        } else {
                            log('✅ 后端显示下线，状态一致', 'recoveryResult');
                            resultDiv.className = 'result-display status-good';
                        }
                    }
                } else {
                    log('✅ 本地有状态，正常恢复', 'recoveryResult');
                    resultDiv.className = 'result-display status-good';
                }
            } catch (error) {
                log(`❌ 状态恢复测试异常: ${error.message}`, 'recoveryResult');
                resultDiv.className = 'result-display status-error';
            }
        }

        function verifyRecovery() {
            log('\\n🔍 验证恢复结果...', 'recoveryResult');
            
            const driverState = localStorage.getItem('driverState');
            
            if (driverState) {
                try {
                    const state = JSON.parse(driverState);
                    log('✅ 状态已恢复', 'recoveryResult');
                    log(`在线状态: ${state.isOnline}`, 'recoveryResult');
                    log(`当前订单: ${state.currentOrder ? state.currentOrder.orderNumber : '无'}`, 'recoveryResult');
                    
                    if (state.currentOrder) {
                        log(`订单状态: ${state.currentOrder.status}`, 'recoveryResult');
                        log(`上车地址: ${state.currentOrder.pickupAddress}`, 'recoveryResult');
                        log(`目的地址: ${state.currentOrder.destinationAddress}`, 'recoveryResult');
                        
                        if (state.currentOrder.pickupLatitude && state.currentOrder.pickupLongitude) {
                            log('✅ 订单坐标信息完整', 'recoveryResult');
                        } else {
                            log('❌ 订单坐标信息缺失', 'recoveryResult');
                        }
                    }
                    
                    document.getElementById('recoveryResult').className = 'result-display status-good';
                } catch (error) {
                    log(`❌ 解析恢复状态失败: ${error.message}`, 'recoveryResult');
                    document.getElementById('recoveryResult').className = 'result-display status-error';
                }
            } else {
                log('⚠️ 没有恢复状态', 'recoveryResult');
                document.getElementById('recoveryResult').className = 'result-display status-warning';
            }
        }

        // 页面加载时的说明
        window.onload = function() {
            log('页面加载完成，请按顺序进行测试', 'orderResult');
            log('1. 先创建订单并接单', 'orderResult');
            log('2. 更新订单状态到进行中', 'orderResult');
            log('3. 清除本地状态模拟重新登录', 'orderResult');
            log('4. 测试状态恢复功能', 'orderResult');
        };
    </script>
</body>
</html>