<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>简化版司机页面测试</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/element-plus@2.4.4/dist/index.full.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/element-plus@2.4.4/dist/index.css">
    <style>
        body {
            margin: 0;
            font-family: 'Helvetica Neue', Helvetica, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .page-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
        }
        .test-section {
            margin-bottom: 40px;
            padding: 20px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
        }
        .section-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #333;
            border-bottom: 2px solid #409EFF;
            padding-bottom: 10px;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="page-container">
            <h1 style="text-align: center; color: #333; margin-bottom: 30px;">司机端页面简化测试</h1>
            
            <!-- 登录区域 -->
            <div class="test-section">
                <div class="section-title">登录测试</div>
                <el-form :model="loginForm" inline>
                    <el-form-item label="用户名">
                        <el-input v-model="loginForm.username" placeholder="driver1"></el-input>
                    </el-form-item>
                    <el-form-item label="密码">
                        <el-input v-model="loginForm.password" type="password" placeholder="123456"></el-input>
                    </el-form-item>
                    <el-form-item>
                        <el-button type="primary" @click="login" :loading="loginLoading">登录</el-button>
                    </el-form-item>
                </el-form>
                <div v-if="loginMessage" style="margin-top: 10px;">
                    <el-alert :title="loginMessage" :type="loginSuccess ? 'success' : 'error'" show-icon />
                </div>
            </div>

            <!-- 简化版订单页面 -->
            <div class="test-section">
                <div class="section-title">我的订单 (简化版)</div>
                
                <div style="margin-bottom: 20px;">
                    <el-button @click="loadSimpleOrders" :loading="ordersLoading">
                        <el-icon><Refresh /></el-icon>
                        加载订单
                    </el-button>
                </div>

                <div v-if="ordersLoading" style="text-align: center; padding: 40px;">
                    <el-icon class="is-loading" style="font-size: 32px;"><Loading /></el-icon>
                    <div style="margin-top: 10px;">加载中...</div>
                </div>

                <div v-else-if="orders.length === 0" style="text-align: center; padding: 40px;">
                    <el-empty description="暂无订单记录" />
                </div>

                <div v-else>
                    <el-card v-for="order in orders" :key="order.id" style="margin-bottom: 16px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span style="font-weight: 600; font-size: 16px;">#{{ order.orderNumber || order.id }}</span>
                                <el-tag type="success" size="small">已完成</el-tag>
                            </div>
                            <span style="color: #666; font-size: 14px;">{{ formatTime(order.createdAt) }}</span>
                        </div>
                        
                        <div style="display: flex; gap: 20px;">
                            <div style="flex: 1;">
                                <div style="margin-bottom: 8px;">
                                    <el-icon style="color: #67c23a; margin-right: 5px;"><LocationFilled /></el-icon>
                                    <span>{{ order.pickupAddress || '上车地点' }}</span>
                                </div>
                                <div>
                                    <el-icon style="color: #e6a23c; margin-right: 5px;"><Location /></el-icon>
                                    <span>{{ order.destinationAddress || '目的地' }}</span>
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="color: #f56c6c; font-weight: 600; font-size: 16px;">
                                    ¥{{ (order.actualFare || order.estimatedFare || 0).toFixed(2) }}
                                </div>
                                <div style="color: #666; font-size: 12px;">
                                    {{ (order.estimatedDistance || 0).toFixed(1) }}km
                                </div>
                            </div>
                        </div>
                    </el-card>
                </div>
            </div>

            <!-- 简化版收入统计 -->
            <div class="test-section">
                <div class="section-title">收入统计 (简化版)</div>
                
                <div style="margin-bottom: 20px;">
                    <el-date-picker
                        v-model="selectedMonth"
                        type="month"
                        placeholder="选择月份"
                        format="YYYY年MM月"
                        value-format="YYYY-MM"
                        style="margin-right: 10px;">
                    </el-date-picker>
                    <el-button type="primary" @click="loadSimpleEarnings" :loading="earningsLoading">
                        <el-icon><Refresh /></el-icon>
                        加载收入数据
                    </el-button>
                </div>

                <div v-if="earningsLoading" style="text-align: center; padding: 40px;">
                    <el-icon class="is-loading" style="font-size: 32px;"><Loading /></el-icon>
                    <div style="margin-top: 10px;">加载收入数据中...</div>
                </div>

                <div v-else>
                    <!-- 收入卡片 -->
                    <el-row :gutter="20" style="margin-bottom: 20px;">
                        <el-col :span="6">
                            <el-card style="text-align: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                                <el-icon style="font-size: 32px; margin-bottom: 10px;"><Money /></el-icon>
                                <div style="font-size: 24px; font-weight: bold; margin-bottom: 5px;">
                                    ¥{{ earnings.totalEarnings.toFixed(2) }}
                                </div>
                                <div style="opacity: 0.9;">总收入</div>
                            </el-card>
                        </el-col>
                        <el-col :span="6">
                            <el-card style="text-align: center; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white;">
                                <el-icon style="font-size: 32px; margin-bottom: 10px;"><Document /></el-icon>
                                <div style="font-size: 24px; font-weight: bold; margin-bottom: 5px;">
                                    {{ earnings.totalOrders }}
                                </div>
                                <div style="opacity: 0.9;">完成订单</div>
                            </el-card>
                        </el-col>
                        <el-col :span="6">
                            <el-card style="text-align: center; background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white;">
                                <el-icon style="font-size: 32px; margin-bottom: 10px;"><TrendCharts /></el-icon>
                                <div style="font-size: 24px; font-weight: bold; margin-bottom: 5px;">
                                    ¥{{ earnings.averageEarnings.toFixed(2) }}
                                </div>
                                <div style="opacity: 0.9;">平均单价</div>
                            </el-card>
                        </el-col>
                        <el-col :span="6">
                            <el-card style="text-align: center; background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white;">
                                <el-icon style="font-size: 32px; margin-bottom: 10px;"><Location /></el-icon>
                                <div style="font-size: 24px; font-weight: bold; margin-bottom: 5px;">
                                    {{ earnings.totalDistance.toFixed(1) }}km
                                </div>
                                <div style="opacity: 0.9;">总里程</div>
                            </el-card>
                        </el-col>
                    </el-row>

                    <!-- 简化表格 -->
                    <el-card>
                        <template #header>
                            <span>{{ selectedMonth }} 月收入明细</span>
                        </template>
                        <el-table :data="orders.slice(0, 5)" stripe style="width: 100%">
                            <el-table-column label="订单号" width="150">
                                <template #default="{ row }">
                                    #{{ row.orderNumber || row.id }}
                                </template>
                            </el-table-column>
                            <el-table-column label="上车地点" min-width="150">
                                <template #default="{ row }">
                                    {{ row.pickupAddress || '上车地点' }}
                                </template>
                            </el-table-column>
                            <el-table-column label="目的地" min-width="150">
                                <template #default="{ row }">
                                    {{ row.destinationAddress || '目的地' }}
                                </template>
                            </el-table-column>
                            <el-table-column label="距离" width="100" align="center">
                                <template #default="{ row }">
                                    {{ (row.estimatedDistance || 0).toFixed(1) }}km
                                </template>
                            </el-table-column>
                            <el-table-column label="收入" width="100" align="center">
                                <template #default="{ row }">
                                    <span style="color: #67C23A; font-weight: bold;">
                                        ¥{{ (row.actualFare || row.estimatedFare || 0).toFixed(2) }}
                                    </span>
                                </template>
                            </el-table-column>
                        </el-table>
                    </el-card>
                </div>
            </div>

            <!-- 测试结果 -->
            <div style="margin-top: 30px; padding: 20px; background: #f0f9ff; border-radius: 8px;">
                <h3 style="color: #0c4a6e; margin-bottom: 15px;">测试状态</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                    <div style="color: #0c4a6e;">
                        <strong>登录状态:</strong> {{ loginSuccess ? '✅ 已登录' : '❌ 未登录' }}
                    </div>
                    <div style="color: #0c4a6e;">
                        <strong>订单加载:</strong> {{ ordersLoaded ? '✅ 成功' : '⏳ 待测试' }}
                    </div>
                    <div style="color: #0c4a6e;">
                        <strong>收入统计:</strong> {{ earningsLoaded ? '✅ 成功' : '⏳ 待测试' }}
                    </div>
                    <div style="color: #0c4a6e;">
                        <strong>图标显示:</strong> ✅ 正常
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, reactive } = Vue;
        const { ElMessage } = ElementPlus;
        
        // 导入图标
        const { Refresh, Loading, LocationFilled, Location, Money, Document, TrendCharts } = ElementPlusIconsVue;

        createApp({
            components: {
                Refresh, Loading, LocationFilled, Location, Money, Document, TrendCharts
            },
            setup() {
                // 登录相关
                const loginForm = reactive({
                    username: 'driver1',
                    password: '123456'
                });
                const loginLoading = ref(false);
                const loginSuccess = ref(false);
                const loginMessage = ref('');
                const token = ref(localStorage.getItem('token'));

                // 订单相关
                const orders = ref([]);
                const ordersLoading = ref(false);
                const ordersLoaded = ref(false);

                // 收入相关
                const selectedMonth = ref(new Date().toISOString().slice(0, 7));
                const earnings = reactive({
                    totalEarnings: 0,
                    totalOrders: 0,
                    averageEarnings: 0,
                    totalDistance: 0
                });
                const earningsLoading = ref(false);
                const earningsLoaded = ref(false);

                // 登录
                const login = async () => {
                    loginLoading.value = true;
                    loginMessage.value = '';

                    try {
                        const response = await fetch('/api/auth/login', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(loginForm)
                        });

                        const result = await response.json();

                        if (result.code === 200) {
                            token.value = result.data.token;
                            localStorage.setItem('token', token.value);
                            loginSuccess.value = true;
                            loginMessage.value = `登录成功！用户类型: ${result.data.userType}`;
                        } else {
                            loginSuccess.value = false;
                            loginMessage.value = `登录失败: ${result.message}`;
                        }
                    } catch (error) {
                        loginSuccess.value = false;
                        loginMessage.value = `网络错误: ${error.message}`;
                    } finally {
                        loginLoading.value = false;
                    }
                };

                // 加载简单订单数据
                const loadSimpleOrders = async () => {
                    if (!token.value) {
                        ElMessage.error('请先登录');
                        return;
                    }

                    ordersLoading.value = true;
                    try {
                        const response = await fetch('/api/drivers/1/orders?page=1&size=10', {
                            headers: {
                                'Authorization': `Bearer ${token.value}`
                            }
                        });

                        const result = await response.json();

                        if (result.code === 200) {
                            orders.value = result.data || [];
                            ordersLoaded.value = true;
                            ElMessage.success(`成功加载 ${orders.value.length} 条订单记录`);
                        } else {
                            ElMessage.error(`加载失败: ${result.message}`);
                        }
                    } catch (error) {
                        ElMessage.error(`网络错误: ${error.message}`);
                    } finally {
                        ordersLoading.value = false;
                    }
                };

                // 加载简单收入数据
                const loadSimpleEarnings = async () => {
                    if (!token.value) {
                        ElMessage.error('请先登录');
                        return;
                    }

                    earningsLoading.value = true;
                    try {
                        const response = await fetch(`/api/drivers/1/earnings?month=${selectedMonth.value}`, {
                            headers: {
                                'Authorization': `Bearer ${token.value}`
                            }
                        });

                        const result = await response.json();

                        if (result.code === 200) {
                            const summary = result.data?.summary || {};
                            Object.assign(earnings, {
                                totalEarnings: summary.totalEarnings || 0,
                                totalOrders: summary.totalOrders || 0,
                                averageEarnings: summary.averageEarnings || 0,
                                totalDistance: summary.totalDistance || 0
                            });
                            earningsLoaded.value = true;
                            ElMessage.success('收入数据加载成功');
                        } else {
                            ElMessage.error(`加载失败: ${result.message}`);
                        }
                    } catch (error) {
                        ElMessage.error(`网络错误: ${error.message}`);
                    } finally {
                        earningsLoading.value = false;
                    }
                };

                // 格式化时间
                const formatTime = (dateTime) => {
                    if (!dateTime) return '--';
                    return new Date(dateTime).toLocaleString('zh-CN', {
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                };

                // 初始化时检查登录状态
                if (token.value) {
                    loginSuccess.value = true;
                    loginMessage.value = '已有登录状态';
                }

                return {
                    loginForm,
                    loginLoading,
                    loginSuccess,
                    loginMessage,
                    orders,
                    ordersLoading,
                    ordersLoaded,
                    selectedMonth,
                    earnings,
                    earningsLoading,
                    earningsLoaded,
                    login,
                    loadSimpleOrders,
                    loadSimpleEarnings,
                    formatTime
                };
            }
        }).use(ElementPlus).mount('#app');
    </script>
</body>
</html>