<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ratings IDè½¬æ¢æµ‹è¯•</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/element-plus/dist/index.full.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css">
    <style>
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e4e7ed;
            border-radius: 4px;
        }
        .result-box {
            background-color: #f5f7fa;
            padding: 15px;
            border-radius: 4px;
            margin-top: 10px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .user-info {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
        }
        .success { color: #67c23a; }
        .error { color: #f56c6c; }
        .warning { color: #e6a23c; }
        .info { color: #409eff; }
    </style>
</head>
<body>
    <div id="app">
        <div class="container">
            <h1>Ratings IDè½¬æ¢æµ‹è¯•</h1>
            <p>æµ‹è¯•å°†ratingsè¡¨ä¸­çš„passenger_idå’Œdriver_idè½¬æ¢ä¸ºuser_idåçš„æ•ˆæœ</p>
            
            <!-- è½¬æ¢å‰åå¯¹æ¯” -->
            <div class="test-section">
                <h3>è½¬æ¢æ•ˆæœæµ‹è¯•</h3>
                <el-button type="primary" @click="testConversion" :loading="loading.test">
                    æµ‹è¯•è½¬æ¢æ•ˆæœ
                </el-button>
                <div v-if="results.test" class="result-box" :class="testStatus">
                    {{ results.test }}
                </div>
            </div>

            <!-- è¯„ä»·æ•°æ®å±•ç¤º -->
            <div class="test-section" v-if="reviews.length > 0">
                <h3>è½¬æ¢åçš„è¯„ä»·æ•°æ®</h3>
                <el-table :data="reviews" style="width: 100%">
                    <el-table-column prop="id" label="ID" width="60" />
                    
                    <el-table-column label="è¯„ä»·è€…" width="180">
                        <template #default="scope">
                            <div class="user-info">
                                <el-tag size="small" :type="scope.row.reviewerName && scope.row.reviewerName !== 'null' ? 'success' : 'danger'">
                                    ID: {{ scope.row.reviewerId }}
                                </el-tag>
                                <img 
                                    :src="getAvatarUrl(scope.row.reviewerAvatar)" 
                                    :alt="scope.row.reviewerName"
                                    class="user-avatar"
                                    @error="handleImageError"
                                />
                                <span :class="scope.row.reviewerName && scope.row.reviewerName !== 'null' ? 'success' : 'error'">
                                    {{ scope.row.reviewerName || 'âŒ æœªæ‰¾åˆ°' }}
                                </span>
                            </div>
                        </template>
                    </el-table-column>
                    
                    <el-table-column label="è¢«è¯„ä»·è€…" width="180">
                        <template #default="scope">
                            <div class="user-info">
                                <el-tag size="small" :type="scope.row.revieweeName && scope.row.revieweeName !== 'null' ? 'success' : 'danger'">
                                    ID: {{ scope.row.revieweeId }}
                                </el-tag>
                                <img 
                                    :src="getAvatarUrl(scope.row.revieweeAvatar)" 
                                    :alt="scope.row.revieweeName"
                                    class="user-avatar"
                                    @error="handleImageError"
                                />
                                <span :class="scope.row.revieweeName && scope.row.revieweeName !== 'null' ? 'success' : 'error'">
                                    {{ scope.row.revieweeName || 'âŒ æœªæ‰¾åˆ°' }}
                                </span>
                            </div>
                        </template>
                    </el-table-column>
                    
                    <el-table-column label="è¯„åˆ†" width="120">
                        <template #default="scope">
                            <el-rate v-model="scope.row.rating" disabled show-score />
                        </template>
                    </el-table-column>
                    
                    <el-table-column prop="comment" label="è¯„ä»·å†…å®¹" min-width="200">
                        <template #default="scope">
                            {{ scope.row.comment || 'æ— è¯„ä»·å†…å®¹' }}
                        </template>
                    </el-table-column>
                    
                    <el-table-column label="çŠ¶æ€" width="100">
                        <template #default="scope">
                            <el-tag :type="getStatusType(scope.row)">
                                {{ getStatusText(scope.row) }}
                            </el-tag>
                        </template>
                    </el-table-column>
                </el-table>
            </div>

            <!-- è½¬æ¢ç»Ÿè®¡ -->
            <div class="test-section" v-if="stats.total > 0">
                <h3>è½¬æ¢ç»Ÿè®¡</h3>
                <el-row :gutter="20">
                    <el-col :span="4">
                        <el-card>
                            <div style="text-align: center;">
                                <div style="font-size: 20px; font-weight: bold; color: #409eff;">{{ stats.total }}</div>
                                <div style="color: #666; font-size: 12px;">æ€»è¯„ä»·æ•°</div>
                            </div>
                        </el-card>
                    </el-col>
                    <el-col :span="4">
                        <el-card>
                            <div style="text-align: center;">
                                <div style="font-size: 20px; font-weight: bold; color: #67c23a;">{{ stats.withBothNames }}</div>
                                <div style="color: #666; font-size: 12px;">å®Œæ•´ç”¨æˆ·å</div>
                            </div>
                        </el-card>
                    </el-col>
                    <el-col :span="4">
                        <el-card>
                            <div style="text-align: center;">
                                <div style="font-size: 20px; font-weight: bold; color: #e6a23c;">{{ stats.missingRater }}</div>
                                <div style="color: #666; font-size: 12px;">ç¼ºå¤±è¯„ä»·è€…</div>
                            </div>
                        </el-card>
                    </el-col>
                    <el-col :span="4">
                        <el-card>
                            <div style="text-align: center;">
                                <div style="font-size: 20px; font-weight: bold; color: #f56c6c;">{{ stats.missingRated }}</div>
                                <div style="color: #666; font-size: 12px;">ç¼ºå¤±è¢«è¯„ä»·è€…</div>
                            </div>
                        </el-card>
                    </el-col>
                    <el-col :span="4">
                        <el-card>
                            <div style="text-align: center;">
                                <div style="font-size: 20px; font-weight: bold; color: #909399;">{{ stats.successRate }}%</div>
                                <div style="color: #666; font-size: 12px;">æˆåŠŸç‡</div>
                            </div>
                        </el-card>
                    </el-col>
                    <el-col :span="4">
                        <el-card>
                            <div style="text-align: center;">
                                <div style="font-size: 20px; font-weight: bold;" :style="{ color: getSuccessRateColor() }">
                                    {{ getSuccessRateText() }}
                                </div>
                                <div style="color: #666; font-size: 12px;">è½¬æ¢çŠ¶æ€</div>
                            </div>
                        </el-card>
                    </el-col>
                </el-row>
            </div>

            <!-- æ“ä½œå»ºè®® -->
            <div class="test-section" v-if="suggestions.length > 0">
                <h3>æ“ä½œå»ºè®®</h3>
                <el-alert
                    v-for="(suggestion, index) in suggestions"
                    :key="index"
                    :title="suggestion.title"
                    :description="suggestion.description"
                    :type="suggestion.type"
                    style="margin-bottom: 10px;"
                    show-icon
                />
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, reactive, computed, onMounted } = Vue;
        const { ElMessage } = ElementPlus;

        createApp({
            setup() {
                const loading = reactive({
                    test: false
                });

                const results = reactive({
                    test: ''
                });

                const reviews = ref([]);
                const suggestions = ref([]);

                const stats = reactive({
                    total: 0,
                    withBothNames: 0,
                    missingRater: 0,
                    missingRated: 0,
                    successRate: 0
                });

                const testStatus = computed(() => {
                    if (stats.successRate >= 90) return 'success';
                    if (stats.successRate >= 70) return 'warning';
                    return 'error';
                });

                const testConversion = async () => {
                    loading.test = true;
                    try {
                        const response = await fetch('/api/reviews/all');
                        const data = await response.json();
                        
                        console.log('APIå“åº”:', data);
                        
                        if (response.ok && (data.success === true || data.code === 200)) {
                            if (data.data && Array.isArray(data.data)) {
                                reviews.value = data.data;
                                analyzeConversion(data.data);
                                
                                const summary = `ğŸ”„ IDè½¬æ¢æ•ˆæœæµ‹è¯•å®Œæˆ\n\nğŸ“Š è½¬æ¢ç»Ÿè®¡:\n- æ€»è¯„ä»·æ•°: ${stats.total}\n- æˆåŠŸå…³è”ç”¨æˆ·: ${stats.withBothNames}\n- ç¼ºå¤±è¯„ä»·è€…: ${stats.missingRater}\n- ç¼ºå¤±è¢«è¯„ä»·è€…: ${stats.missingRated}\n- è½¬æ¢æˆåŠŸç‡: ${stats.successRate}%\n\n${getConversionAnalysis()}\n\n${data.data.length > 0 ? 'ğŸ“ ç¤ºä¾‹æ•°æ®:\n' + JSON.stringify(data.data[0], null, 2) : ''}`;
                                
                                results.test = summary;
                                generateSuggestions();
                                
                                ElMessage.success(`è½¬æ¢æµ‹è¯•å®Œæˆï¼ŒæˆåŠŸç‡: ${stats.successRate}%`);
                            } else {
                                results.test = `âš ï¸ æ•°æ®æ ¼å¼å¼‚å¸¸\ndataå­—æ®µ: ${JSON.stringify(data.data)}`;
                                ElMessage.warning('æ•°æ®æ ¼å¼å¼‚å¸¸');
                            }
                        } else {
                            results.test = `âŒ APIè°ƒç”¨å¤±è´¥\nçŠ¶æ€: ${response.status}\né”™è¯¯: ${data.message || 'æœªçŸ¥é”™è¯¯'}`;
                            ElMessage.error('APIè°ƒç”¨å¤±è´¥');
                        }
                    } catch (error) {
                        results.test = `âŒ è¯·æ±‚å¤±è´¥: ${error.message}`;
                        ElMessage.error('è¯·æ±‚å¤±è´¥');
                    } finally {
                        loading.test = false;
                    }
                };

                const analyzeConversion = (data) => {
                    stats.total = data.length;
                    stats.withBothNames = data.filter(r => 
                        r.reviewerName && r.revieweeName && 
                        r.reviewerName !== 'null' && r.revieweeName !== 'null'
                    ).length;
                    stats.missingRater = data.filter(r => 
                        !r.reviewerName || r.reviewerName === 'null'
                    ).length;
                    stats.missingRated = data.filter(r => 
                        !r.revieweeName || r.revieweeName === 'null'
                    ).length;
                    
                    if (stats.total > 0) {
                        stats.successRate = Math.round((stats.withBothNames / stats.total) * 100);
                    } else {
                        stats.successRate = 0;
                    }
                };

                const getConversionAnalysis = () => {
                    if (stats.successRate >= 90) {
                        return 'âœ… è½¬æ¢æ•ˆæœä¼˜ç§€ï¼å¤§éƒ¨åˆ†è¯„ä»·éƒ½èƒ½æ­£ç¡®å…³è”åˆ°ç”¨æˆ·ä¿¡æ¯ã€‚';
                    } else if (stats.successRate >= 70) {
                        return 'âš ï¸ è½¬æ¢æ•ˆæœä¸€èˆ¬ï¼Œéƒ¨åˆ†è¯„ä»·æ— æ³•å…³è”åˆ°ç”¨æˆ·ä¿¡æ¯ã€‚';
                    } else if (stats.successRate >= 50) {
                        return 'âŒ è½¬æ¢æ•ˆæœè¾ƒå·®ï¼Œå¤§é‡è¯„ä»·æ— æ³•å…³è”åˆ°ç”¨æˆ·ä¿¡æ¯ã€‚';
                    } else {
                        return 'ğŸ’¥ è½¬æ¢å¤±è´¥ï¼å¤§éƒ¨åˆ†è¯„ä»·éƒ½æ— æ³•å…³è”åˆ°ç”¨æˆ·ä¿¡æ¯ï¼Œéœ€è¦æ‰§è¡ŒIDè½¬æ¢è„šæœ¬ã€‚';
                    }
                };

                const generateSuggestions = () => {
                    suggestions.value = [];
                    
                    if (stats.successRate < 50) {
                        suggestions.value.push({
                            title: 'éœ€è¦æ‰§è¡ŒIDè½¬æ¢',
                            description: `è½¬æ¢æˆåŠŸç‡åªæœ‰ ${stats.successRate}%ï¼Œå»ºè®®æ‰§è¡Œ convert_ratings_to_user_ids.sql è„šæœ¬å°† passenger_id å’Œ driver_id è½¬æ¢ä¸º user_idã€‚`,
                            type: 'error'
                        });
                    } else if (stats.successRate < 80) {
                        suggestions.value.push({
                            title: 'éƒ¨åˆ†æ•°æ®éœ€è¦ä¿®å¤',
                            description: `è½¬æ¢æˆåŠŸç‡ä¸º ${stats.successRate}%ï¼Œå»ºè®®æ£€æŸ¥å¹¶ä¿®å¤ç¼ºå¤±çš„ç”¨æˆ·è®°å½•ã€‚`,
                            type: 'warning'
                        });
                    } else {
                        suggestions.value.push({
                            title: 'è½¬æ¢æ•ˆæœè‰¯å¥½',
                            description: `è½¬æ¢æˆåŠŸç‡ä¸º ${stats.successRate}%ï¼Œç³»ç»Ÿè¿è¡Œæ­£å¸¸ã€‚`,
                            type: 'success'
                        });
                    }
                    
                    if (stats.missingRater > 0) {
                        suggestions.value.push({
                            title: 'ç¼ºå¤±è¯„ä»·è€…ä¿¡æ¯',
                            description: `${stats.missingRater} æ¡è¯„ä»·ç¼ºå¤±è¯„ä»·è€…å§“åã€‚æ£€æŸ¥ rater_id æ˜¯å¦æ­£ç¡®è½¬æ¢ä¸º user_idã€‚`,
                            type: 'warning'
                        });
                    }
                    
                    if (stats.missingRated > 0) {
                        suggestions.value.push({
                            title: 'ç¼ºå¤±è¢«è¯„ä»·è€…ä¿¡æ¯',
                            description: `${stats.missingRated} æ¡è¯„ä»·ç¼ºå¤±è¢«è¯„ä»·è€…å§“åã€‚æ£€æŸ¥ rated_id æ˜¯å¦æ­£ç¡®è½¬æ¢ä¸º user_idã€‚`,
                            type: 'warning'
                        });
                    }
                    
                    suggestions.value.push({
                        title: 'SQLè½¬æ¢è„šæœ¬',
                        description: 'ä½¿ç”¨ convert_ratings_to_user_ids.sql è„šæœ¬å¯ä»¥è‡ªåŠ¨å°† ratings è¡¨ä¸­çš„ passenger_id å’Œ driver_id è½¬æ¢ä¸ºå¯¹åº”çš„ user_idã€‚',
                        type: 'info'
                    });
                };

                const getStatusType = (review) => {
                    if (review.reviewerName && review.revieweeName && 
                        review.reviewerName !== 'null' && review.revieweeName !== 'null') {
                        return 'success';
                    }
                    return 'danger';
                };

                const getStatusText = (review) => {
                    if (review.reviewerName && review.revieweeName && 
                        review.reviewerName !== 'null' && review.revieweeName !== 'null') {
                        return 'æ­£å¸¸';
                    }
                    if (!review.reviewerName || review.reviewerName === 'null') {
                        return 'ç¼ºå¤±è¯„ä»·è€…';
                    }
                    if (!review.revieweeName || review.revieweeName === 'null') {
                        return 'ç¼ºå¤±è¢«è¯„ä»·è€…';
                    }
                    return 'å¼‚å¸¸';
                };

                const getSuccessRateColor = () => {
                    if (stats.successRate >= 90) return '#67c23a';
                    if (stats.successRate >= 70) return '#e6a23c';
                    return '#f56c6c';
                };

                const getSuccessRateText = () => {
                    if (stats.successRate >= 90) return 'ä¼˜ç§€';
                    if (stats.successRate >= 70) return 'è‰¯å¥½';
                    if (stats.successRate >= 50) return 'ä¸€èˆ¬';
                    return 'è¾ƒå·®';
                };

                const getAvatarUrl = (avatar) => {
                    if (!avatar || avatar === 'null' || avatar === 'undefined') {
                        return 'https://cube.elemecdn.com/3/7c/3ea6beec64369c2642b92c6726f1epng.png';
                    }
                    if (avatar.startsWith('http')) return avatar;
                    return `/api/files/avatar/${avatar}`;
                };

                const handleImageError = (event) => {
                    event.target.src = 'https://cube.elemecdn.com/3/7c/3ea6beec64369c2642b92c6726f1epng.png';
                };

                onMounted(() => {
                    console.log('Ratings IDè½¬æ¢æµ‹è¯•é¡µé¢å·²åŠ è½½');
                    // è‡ªåŠ¨æµ‹è¯•è½¬æ¢æ•ˆæœ
                    testConversion();
                });

                return {
                    loading,
                    results,
                    reviews,
                    suggestions,
                    stats,
                    testStatus,
                    testConversion,
                    getStatusType,
                    getStatusText,
                    getSuccessRateColor,
                    getSuccessRateText,
                    getAvatarUrl,
                    handleImageError
                };
            }
        }).use(ElementPlus).mount('#app');
    </script>
</body>
</html>