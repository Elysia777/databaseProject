<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>司机收入统计优化版测试</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/element-plus/dist/index.full.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        .quick-months {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        .date-picker-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            transition: opacity 0.3s;
        }
        .stat-card.no-data {
            opacity: 0.6;
        }
        .stat-card.earnings { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .stat-card.orders { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .stat-card.average { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .stat-card.distance { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
        .stat-value {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .api-result {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px;
        }
        .success { color: #67C23A; }
        .error { color: #F56C6C; }
        .warning { color: #E6A23C; }
        .no-data-message {
            text-align: center;
            padding: 40px;
            color: #999;
            font-size: 16px;
        }
        .orders-table {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="container">
            <div class="header">
                <h1>司机收入统计优化版测试</h1>
                <div>
                    <el-input v-model="driverId" placeholder="司机ID" style="width: 100px; margin-right: 10px;"></el-input>
                </div>
            </div>

            <!-- 月份选择 -->
            <div class="test-section">
                <h3>月份选择</h3>
                <div class="quick-months">
                    <el-button 
                        v-for="month in quickMonths" 
                        :key="month.value"
                        :type="selectedMonth === month.value ? 'primary' : 'default'"
                        size="small"
                        @click="selectMonth(month.value)"
                    >
                        {{ month.label }}
                    </el-button>
                </div>
                <div class="date-picker-group">
                    <el-date-picker
                        v-model="selectedMonth"
                        type="month"
                        placeholder="选择月份"
                        format="YYYY年MM月"
                        value-format="YYYY-MM"
                        @change="loadEarnings"
                        style="width: 160px;"
                    />
                    <el-button type="primary" @click="loadEarnings" :loading="loading">
                        查询收入
                    </el-button>
                </div>
            </div>

            <!-- 收入统计卡片 -->
            <div class="stats-grid">
                <div class="stat-card earnings" :class="{ 'no-data': earnings.totalOrders === 0 }">
                    <div class="stat-value">¥{{ earnings.totalEarnings.toFixed(2) }}</div>
                    <div class="stat-label">{{ formatMonthDisplay(selectedMonth) }}总收入</div>
                </div>
                <div class="stat-card orders" :class="{ 'no-data': earnings.totalOrders === 0 }">
                    <div class="stat-value">{{ earnings.totalOrders }}</div>
                    <div class="stat-label">{{ formatMonthDisplay(selectedMonth) }}完成订单</div>
                </div>
                <div class="stat-card average" :class="{ 'no-data': earnings.totalOrders === 0 }">
                    <div class="stat-value">¥{{ earnings.averageEarnings.toFixed(2) }}</div>
                    <div class="stat-label">{{ formatMonthDisplay(selectedMonth) }}平均单价</div>
                </div>
                <div class="stat-card distance" :class="{ 'no-data': earnings.totalOrders === 0 }">
                    <div class="stat-value">{{ earnings.totalDistance.toFixed(1) }}km</div>
                    <div class="stat-label">{{ formatMonthDisplay(selectedMonth) }}总里程</div>
                </div>
            </div>

            <!-- 无数据提示 -->
            <div v-if="!loading && earnings.totalOrders === 0 && hasQueried" class="no-data-message">
                <el-empty 
                    :image-size="120"
                    description="暂无收入记录"
                >
                    <template #description>
                        <p>{{ formatMonthDisplay(selectedMonth) }}暂无完成的订单</p>
                        <p>选择其他月份查看收入统计</p>
                    </template>
                </el-empty>
            </div>

            <!-- 订单列表 (只在有数据时显示) -->
            <div v-if="!loading && earnings.totalOrders > 0" class="orders-table">
                <h3>{{ formatMonthDisplay(selectedMonth) }}收入明细</h3>
                <p>共 {{ earnings.totalOrders }} 单，总收入 ¥{{ earnings.totalEarnings.toFixed(2) }}</p>
                <el-table :data="dailyRecords" style="width: 100%">
                    <el-table-column prop="date" label="日期" width="120"></el-table-column>
                    <el-table-column prop="orderCount" label="订单数" width="80" align="center"></el-table-column>
                    <el-table-column prop="totalDistance" label="里程(km)" width="100" align="center">
                        <template #default="{ row }">
                            {{ parseFloat(row.totalDistance || 0).toFixed(1) }}
                        </template>
                    </el-table-column>
                    <el-table-column prop="totalEarnings" label="收入" width="100" align="center">
                        <template #default="{ row }">
                            <span style="color: #67C23A; font-weight: bold;">
                                ¥{{ parseFloat(row.totalEarnings || 0).toFixed(2) }}
                            </span>
                        </template>
                    </el-table-column>
                    <el-table-column prop="averageEarnings" label="平均单价" width="100" align="center">
                        <template #default="{ row }">
                            ¥{{ parseFloat(row.averageEarnings || 0).toFixed(2) }}
                        </template>
                    </el-table-column>
                </el-table>
            </div>

            <!-- API测试结果 -->
            <div class="test-section">
                <h3>API调用结果</h3>
                <div>
                    <span>司机ID: {{ driverId }}</span>
                    <span style="margin-left: 20px;">查询月份: {{ selectedMonth }}</span>
                    <span style="margin-left: 20px;" :class="apiStatus">状态: {{ statusText }}</span>
                </div>
                <div class="api-result" v-if="apiResult">{{ apiResult }}</div>
            </div>

            <!-- 功能测试 -->
            <div class="test-section">
                <h3>功能测试</h3>
                <div style="margin: 10px 0;">
                    <el-button @click="testNoDataMonth">测试无数据月份</el-button>
                    <el-button @click="testHasDataMonth">测试有数据月份</el-button>
                    <el-button @click="testMultipleMonths">测试多个月份</el-button>
                </div>
                <div class="api-result" v-if="testResult">{{ testResult }}</div>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, reactive, computed, onMounted } = Vue;
        
        createApp({
            setup() {
                const loading = ref(false);
                const driverId = ref('1');
                const selectedMonth = ref(new Date().toISOString().slice(0, 7));
                const hasQueried = ref(false);
                const apiResult = ref('');
                const testResult = ref('');
                const statusText = ref('未查询');
                const apiStatus = ref('');
                
                const earnings = reactive({
                    totalEarnings: 0,
                    totalOrders: 0,
                    averageEarnings: 0,
                    totalDistance: 0
                });
                
                const dailyRecords = ref([]);
                
                // 快速月份选择
                const quickMonths = computed(() => {
                    const months = [];
                    const now = new Date();
                    
                    // 当前月
                    months.push({
                        label: '本月',
                        value: now.toISOString().slice(0, 7)
                    });
                    
                    // 上个月
                    const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                    months.push({
                        label: '上月',
                        value: lastMonth.toISOString().slice(0, 7)
                    });
                    
                    // 前几个月
                    for (let i = 2; i <= 5; i++) {
                        const month = new Date(now.getFullYear(), now.getMonth() - i, 1);
                        months.push({
                            label: `${month.getMonth() + 1}月`,
                            value: month.toISOString().slice(0, 7)
                        });
                    }
                    
                    return months;
                });
                
                // 格式化月份显示
                const formatMonthDisplay = (monthValue) => {
                    if (!monthValue) return '';
                    const [year, month] = monthValue.split('-');
                    return `${year}年${month}月`;
                };
                
                // 重置数据
                const resetEarnings = () => {
                    Object.assign(earnings, {
                        totalEarnings: 0,
                        totalOrders: 0,
                        averageEarnings: 0,
                        totalDistance: 0
                    });
                    dailyRecords.value = [];
                };
                
                // 选择月份
                const selectMonth = (monthValue) => {
                    selectedMonth.value = monthValue;
                    loadEarnings();
                };
                
                // 加载收入数据
                const loadEarnings = async () => {
                    if (!driverId.value || !selectedMonth.value) {
                        ElementPlus.ElMessage.warning('请输入司机ID和选择月份');
                        return;
                    }
                    
                    loading.value = true;
                    hasQueried.value = true;
                    statusText.value = '查询中...';
                    apiStatus.value = '';
                    
                    // 重置数据
                    resetEarnings();
                    
                    try {
                        const params = new URLSearchParams({
                            month: selectedMonth.value,
                            page: '1',
                            size: '31'
                        });
                        
                        console.log(`查询司机 ${driverId.value} 在 ${selectedMonth.value} 的收入统计`);
                        
                        const response = await fetch(`/api/drivers/${driverId.value}/earnings?${params}`);
                        const result = await response.json();
                        
                        apiResult.value = JSON.stringify(result, null, 2);
                        
                        if (result.code === 200 && result.data && result.data.summary) {
                            const summary = result.data.summary;
                            const hasData = summary.totalOrders > 0 || summary.totalEarnings > 0;
                            
                            if (hasData) {
                                // 更新汇总数据
                                Object.assign(earnings, {
                                    totalEarnings: summary.totalEarnings || 0,
                                    totalOrders: summary.totalOrders || 0,
                                    averageEarnings: summary.averageEarnings || 0,
                                    totalDistance: summary.totalDistance || 0
                                });
                                
                                // 更新每日明细
                                dailyRecords.value = result.data.records || [];
                                
                                statusText.value = '查询成功';
                                apiStatus.value = 'success';
                                ElementPlus.ElMessage.success(`成功加载 ${formatMonthDisplay(selectedMonth.value)} 的收入数据`);
                            } else {
                                statusText.value = '无数据';
                                apiStatus.value = 'warning';
                                ElementPlus.ElMessage.info(`${formatMonthDisplay(selectedMonth.value)} 暂无收入记录`);
                            }
                        } else {
                            statusText.value = '查询失败';
                            apiStatus.value = 'error';
                            ElementPlus.ElMessage.error(result.message || '查询失败');
                        }
                    } catch (error) {
                        console.error('查询收入失败:', error);
                        statusText.value = '网络错误';
                        apiStatus.value = 'error';
                        apiResult.value = '请求失败: ' + error.message;
                        ElementPlus.ElMessage.error('网络请求失败');
                    } finally {
                        loading.value = false;
                    }
                };
                
                // 测试无数据月份
                const testNoDataMonth = () => {
                    // 选择一个很早的月份，通常没有数据
                    selectedMonth.value = '2020-01';
                    loadEarnings();
                    testResult.value = '测试无数据月份: 2020年1月';
                };
                
                // 测试有数据月份
                const testHasDataMonth = () => {
                    // 选择当前月份，可能有数据
                    selectedMonth.value = new Date().toISOString().slice(0, 7);
                    loadEarnings();
                    testResult.value = '测试有数据月份: 当前月份';
                };
                
                // 测试多个月份
                const testMultipleMonths = async () => {
                    testResult.value = '正在测试多个月份...\n';
                    
                    const testMonths = [
                        '2024-12',
                        '2024-11', 
                        '2024-10',
                        '2020-01'  // 通常无数据的月份
                    ];
                    
                    for (const month of testMonths) {
                        selectedMonth.value = month;
                        await loadEarnings();
                        
                        const hasData = earnings.totalOrders > 0;
                        testResult.value += `${formatMonthDisplay(month)}: ${hasData ? '有数据' : '无数据'} (${earnings.totalOrders}单)\n`;
                        
                        // 等待一下再测试下一个
                        await new Promise(resolve => setTimeout(resolve, 1000));
                    }
                    
                    testResult.value += '\n多月份测试完成';
                };
                
                onMounted(() => {
                    console.log('司机收入统计优化版测试页面已加载');
                });
                
                return {
                    loading,
                    driverId,
                    selectedMonth,
                    hasQueried,
                    quickMonths,
                    earnings,
                    dailyRecords,
                    apiResult,
                    testResult,
                    statusText,
                    apiStatus,
                    formatMonthDisplay,
                    selectMonth,
                    loadEarnings,
                    testNoDataMonth,
                    testHasDataMonth,
                    testMultipleMonths
                };
            }
        }).use(ElementPlus).mount('#app');
    </script>
</body>
</html>