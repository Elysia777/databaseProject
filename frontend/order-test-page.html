<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç½‘çº¦è½¦è®¢å•æµ‹è¯•é¡µé¢</title>
    <!-- WebSocketç›¸å…³åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.6.1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@7.0.0/bundles/stomp.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(45deg, #FF6B6B, #4ECDC4);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .main-content {
            display: flex;
            min-height: 600px;
        }

        .panel {
            flex: 1;
            padding: 20px;
            border-right: 1px solid #eee;
        }

        .panel:last-child {
            border-right: none;
        }

        .panel h2 {
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #4ECDC4;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }

        .form-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-input:focus {
            outline: none;
            border-color: #4ECDC4;
        }

        .button-group {
            margin: 15px 0;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s;
            flex: 1;
            min-width: 120px;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .result-box {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.4;
        }

        .order-item {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .order-status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            color: white;
        }

        .status-pending {
            background: #ffc107;
            color: #212529;
        }

        .status-assigned {
            background: #17a2b8;
        }

        .status-pickup {
            background: #fd7e14;
        }

        .status-in-progress {
            background: #20c997;
        }

        .status-completed {
            background: #28a745;
        }

        .status-cancelled {
            background: #dc3545;
        }

        /* è¿æ¥çŠ¶æ€æ ·å¼ */
        .connection-status {
            margin: 15px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
        }

        .status-online {
            color: #28a745;
            font-weight: bold;
        }

        .status-offline {
            color: #dc3545;
            font-weight: bold;
        }

        /* è®¢å•é€šçŸ¥åŒºåŸŸæ ·å¼ */
        .notification-area {
            margin: 20px 0;
            border: 2px solid #4ECDC4;
            border-radius: 10px;
            padding: 15px;
            background: #f0fdff;
        }

        .notification-area h3 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 16px;
        }

        .notifications-container {
            max-height: 300px;
            overflow-y: auto;
        }

        .no-notifications {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 20px;
        }

        /* è®¢å•é€šçŸ¥å¡ç‰‡æ ·å¼ */
        .order-notification {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            animation: slideIn 0.3s ease-out;
        }

        .order-notification.new {
            border-left: 4px solid #FF6B6B;
            animation: pulse 1s ease-in-out;
        }

        @keyframes slideIn {
            from {
                transform: translateX(-100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes pulse {

            0%,
            100% {
                background-color: white;
            }

            50% {
                background-color: #fff5f5;
            }
        }

        .notification-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 10px;
        }

        .notification-title {
            font-weight: bold;
            color: #333;
            font-size: 14px;
        }

        .notification-time {
            font-size: 12px;
            color: #666;
        }

        .notification-content {
            margin: 10px 0;
            font-size: 13px;
            line-height: 1.4;
        }

        .notification-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .notification-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
            transition: all 0.3s;
        }

        .notification-btn.accept {
            background: #28a745;
            color: white;
        }

        .notification-btn.reject {
            background: #dc3545;
            color: white;
        }

        .notification-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .notification-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>ğŸš— ç½‘çº¦è½¦è®¢å•æµ‹è¯•ç³»ç»Ÿ</h1>
            <p>æµ‹è¯•ä¹˜å®¢ä¸‹å•ã€å¸æœºæ¥å•ç­‰åŠŸèƒ½</p>
        </div>

        <div class="main-content">
            <!-- ä¹˜å®¢é¢æ¿ -->
            <div class="panel">
                <h2>ğŸ‘¤ ä¹˜å®¢æ“ä½œ</h2>

                <div class="form-group">
                    <label>ä¹˜å®¢ID:</label>
                    <input type="number" id="passengerId" value="1" class="form-input">
                </div>

                <div class="form-group">
                    <label>ä¸Šè½¦åœ°å€:</label>
                    <input type="text" id="pickupAddress" value="åŒ—äº¬å¸‚æœé˜³åŒºä¸‰é‡Œå±¯" class="form-input">
                </div>

                <div class="form-group">
                    <label>ä¸Šè½¦åæ ‡:</label>
                    <input type="text" id="pickupCoords" value="39.9365,116.4477" class="form-input"
                        placeholder="çº¬åº¦,ç»åº¦">
                </div>

                <div class="form-group">
                    <label>ç›®çš„åœ°åœ°å€:</label>
                    <input type="text" id="destinationAddress" value="åŒ—äº¬å¸‚æµ·æ·€åŒºä¸­å…³æ‘" class="form-input">
                </div>

                <div class="form-group">
                    <label>ç›®çš„åœ°åæ ‡:</label>
                    <input type="text" id="destinationCoords" value="39.9851,116.3058" class="form-input"
                        placeholder="çº¬åº¦,ç»åº¦">
                </div>

                <div class="button-group">
                    <button onclick="createOrder()" class="btn btn-primary">ğŸ“± ä¸‹å•</button>
                    <button onclick="cancelOrder()" class="btn btn-danger">âŒ å–æ¶ˆè®¢å•</button>
                </div>

                <div id="passengerResult" class="result-box"></div>
            </div>

            <!-- å¸æœºé¢æ¿ -->
            <div class="panel">
                <h2>ğŸš• å¸æœºæ“ä½œ</h2>

                <div class="form-group">
                    <label>å¸æœºID:</label>
                    <input type="number" id="driverId" value="1" class="form-input">
                </div>

                <div class="form-group">
                    <label>å¸æœºä½ç½®:</label>
                    <input type="text" id="driverCoords" value="39.9042,116.4074" class="form-input"
                        placeholder="çº¬åº¦,ç»åº¦">
                </div>

                <div class="button-group">
                    <button onclick="driverGoOnline()" class="btn btn-success">ğŸŸ¢ ä¸Šçº¿</button>
                    <button onclick="driverGoOffline()" class="btn btn-secondary">ğŸ”´ ä¸‹çº¿</button>
                    <button onclick="connectWebSocket()" class="btn btn-info">ğŸ”— è¿æ¥æ¨é€</button>
                </div>

                <div class="connection-status">
                    <span id="connectionStatus" class="status-offline">ğŸ”´ æœªè¿æ¥</span>
                    <span id="driverStatus" class="status-offline">ğŸ“± ç¦»çº¿</span>
                </div>

                <!-- è®¢å•æ¨é€é€šçŸ¥åŒºåŸŸ -->
                <div class="notification-area">
                    <h3>ğŸ“¢ è®¢å•æ¨é€é€šçŸ¥</h3>
                    <div id="orderNotifications" class="notifications-container">
                        <div class="no-notifications">æš‚æ— è®¢å•æ¨é€</div>
                    </div>
                </div>

                <div class="button-group">
                    <button onclick="getOnlineDrivers()" class="btn btn-info">ğŸ‘¥ æŸ¥çœ‹åœ¨çº¿å¸æœº</button>
                    <button onclick="getNearbyDrivers()" class="btn btn-info">ğŸ“ æŸ¥çœ‹é™„è¿‘å¸æœº</button>
                </div>

                <div id="driverResult" class="result-box"></div>
            </div>

            <!-- è®¢å•çŠ¶æ€é¢æ¿ -->
            <div class="panel">
                <h2>ğŸ“‹ è®¢å•çŠ¶æ€</h2>

                <div class="button-group">
                    <button onclick="getAllOrders()" class="btn btn-info">ğŸ”„ åˆ·æ–°è®¢å•</button>
                    <button onclick="clearResults()" class="btn btn-secondary">ğŸ—‘ï¸ æ¸…ç©ºç»“æœ</button>
                </div>

                <div class="form-group">
                    <label>æŸ¥è¯¢è®¢å•ID:</label>
                    <input type="number" id="queryOrderId" value="" class="form-input" placeholder="è¾“å…¥è®¢å•IDæŸ¥è¯¢">
                    <button onclick="getOrderById()" class="btn btn-info" style="margin-top: 5px;">ğŸ” æŸ¥è¯¢è®¢å•</button>
                </div>

                <div id="orderResult" class="result-box"></div>
            </div>
        </div>
    </div>

    <script>
        // APIåŸºç¡€URL
        const API_BASE_URL = 'http://localhost:8080';
        const WS_BASE_URL = 'ws://localhost:8080';

        // å½“å‰è®¢å•IDï¼ˆç”¨äºå–æ¶ˆè®¢å•ï¼‰
        let currentOrderId = null;

        // WebSocketè¿æ¥
        let websocket = null;
        let isConnected = false;

        // ==================== å·¥å…·å‡½æ•° ====================

        function showResult(elementId, message, isError = false) {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const color = isError ? '#dc3545' : '#28a745';
            element.innerHTML += `<div style="color: ${color}; margin-bottom: 10px;">
                [${timestamp}] ${message}
            </div>`;
            element.scrollTop = element.scrollHeight;
        }

        function clearResults() {
            document.getElementById('passengerResult').innerHTML = '';
            document.getElementById('driverResult').innerHTML = '';
            document.getElementById('orderResult').innerHTML = '';
        }

        async function apiCall(url, method = 'GET', data = null) {
            try {
                const options = {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    }
                };

                if (data) {
                    options.body = JSON.stringify(data);
                }

                const response = await fetch(API_BASE_URL + url, options);
                const result = await response.json();

                return { success: response.ok, data: result };
            } catch (error) {
                return { success: false, error: error.message };
            }
        }

        // ==================== ä¹˜å®¢åŠŸèƒ½ ====================

        async function createOrder() {
            const passengerId = document.getElementById('passengerId').value;
            const pickupAddress = document.getElementById('pickupAddress').value;
            const pickupCoords = document.getElementById('pickupCoords').value.split(',');
            const destinationAddress = document.getElementById('destinationAddress').value;
            const destinationCoords = document.getElementById('destinationCoords').value.split(',');

            if (pickupCoords.length !== 2 || destinationCoords.length !== 2) {
                showResult('passengerResult', 'âŒ åæ ‡æ ¼å¼é”™è¯¯ï¼Œè¯·ä½¿ç”¨"çº¬åº¦,ç»åº¦"æ ¼å¼', true);
                return;
            }

            const orderData = {
                passengerId: parseInt(passengerId),
                pickupAddress: pickupAddress,
                pickupLatitude: parseFloat(pickupCoords[0]),
                pickupLongitude: parseFloat(pickupCoords[1]),
                destinationAddress: destinationAddress,
                destinationLatitude: parseFloat(destinationCoords[0]),
                destinationLongitude: parseFloat(destinationCoords[1]),
                orderType: 'REAL_TIME'
            };

            showResult('passengerResult', 'ğŸ“± æ­£åœ¨åˆ›å»ºè®¢å•...');

            const result = await apiCall('/api/orders/create', 'POST', orderData);

            if (result.success) {
                currentOrderId = result.data.data.id;
                showResult('passengerResult', `âœ… è®¢å•åˆ›å»ºæˆåŠŸï¼è®¢å•ID: ${currentOrderId}`);
                showResult('passengerResult', `ğŸ“‹ è®¢å•è¯¦æƒ…: ${JSON.stringify(result.data.data, null, 2)}`);
                showResult('passengerResult', `ğŸ“¡ è®¢å•å·²æäº¤åˆ°åç«¯åˆ†é…ç³»ç»Ÿï¼Œç¬¦åˆè·ç¦»æ¡ä»¶çš„å¸æœºå°†æ”¶åˆ°æ¨é€`);

                // è‡ªåŠ¨åˆ·æ–°è®¢å•çŠ¶æ€
                setTimeout(getAllOrders, 1000);
            } else {
                showResult('passengerResult', `âŒ è®¢å•åˆ›å»ºå¤±è´¥: ${result.data?.message || result.error}`, true);
            }
        }

        async function cancelOrder() {
            const orderId = currentOrderId || document.getElementById('queryOrderId').value;

            if (!orderId) {
                showResult('passengerResult', 'âŒ è¯·å…ˆåˆ›å»ºè®¢å•æˆ–è¾“å…¥è®¢å•ID', true);
                return;
            }

            showResult('passengerResult', `ğŸš« æ­£åœ¨å–æ¶ˆè®¢å• ${orderId}...`);

            const result = await apiCall(`/api/orders/${orderId}/cancel`, 'POST');

            if (result.success) {
                showResult('passengerResult', `âœ… è®¢å• ${orderId} å–æ¶ˆæˆåŠŸ`);
                currentOrderId = null;
                setTimeout(getAllOrders, 1000);
            } else {
                showResult('passengerResult', `âŒ å–æ¶ˆè®¢å•å¤±è´¥: ${result.data?.message || result.error}`, true);
            }
        }

        // ==================== WebSocket å®æ—¶æ¨é€åŠŸèƒ½ ====================

        function connectWebSocket() {
            const driverId = document.getElementById('driverId').value;

            if (websocket && websocket.readyState === WebSocket.OPEN) {
                showResult('driverResult', 'âš ï¸ WebSocketå·²è¿æ¥ï¼Œæ— éœ€é‡å¤è¿æ¥');
                return;
            }

            // æ£€æŸ¥å¿…è¦çš„åº“æ˜¯å¦åŠ è½½
            if (typeof SockJS === 'undefined') {
                showResult('driverResult', 'âŒ SockJSåº“æœªåŠ è½½ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥', true);
                return;
            }

            if (typeof StompJs === 'undefined' && typeof Stomp === 'undefined') {
                showResult('driverResult', 'âŒ STOMPåº“æœªåŠ è½½ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥', true);
                return;
            }

            try {
                showResult('driverResult', `ğŸ”— æ­£åœ¨è¿æ¥WebSocketæ¨é€æœåŠ¡...`);

                // è¿æ¥åˆ°åç«¯çš„WebSocketæœåŠ¡
                websocket = new SockJS(API_BASE_URL + '/ws');

                // ä½¿ç”¨æ­£ç¡®çš„STOMPå®¢æˆ·ç«¯
                let stompClient;

                if (typeof StompJs !== 'undefined') {
                    // ä½¿ç”¨æ–°ç‰ˆæœ¬çš„ @stomp/stompjs
                    stompClient = new StompJs.Client({
                        webSocketFactory: () => new SockJS(API_BASE_URL + '/ws'),
                        debug: () => { } // ç¦ç”¨è°ƒè¯•æ—¥å¿—
                    });

                    stompClient.onConnect = function (frame) {
                        isConnected = true;
                        updateConnectionStatus(true);
                        showResult('driverResult', `âœ… WebSocketè¿æ¥æˆåŠŸï¼Œå¸æœº ${driverId} å¯ä»¥æ¥æ”¶è®¢å•æ¨é€`);
                        console.log('WebSocketè¿æ¥æˆåŠŸï¼Œframe:', frame);

                        // å‘é€å¸æœºè¿æ¥æ¶ˆæ¯
                        console.log('å‡†å¤‡å‘é€å¸æœºè¿æ¥æ¶ˆæ¯ï¼Œå¸æœºID:', driverId);
                        stompClient.publish({
                            destination: '/app/driver/connect',
                            body: JSON.stringify({ driverId: driverId })
                        });
                        showResult('driverResult', `ğŸ“¤ å·²å‘é€å¸æœºè¿æ¥æ¶ˆæ¯åˆ°åç«¯ (å¸æœºID: ${driverId})`);

                        // è®¢é˜…å¸æœºä¸“ç”¨çš„è®¢å•é˜Ÿåˆ—
                        const orderSubscription = stompClient.subscribe('/user/' + driverId + '/queue/orders', function (message) {
                            console.log('ğŸš— æ”¶åˆ°è®¢å•æ¨é€æ¶ˆæ¯:', message);
                            showResult('driverResult', `ğŸ“¨ æ”¶åˆ°è®¢å•æ¨é€: ${message.body}`);
                            try {
                                const orderData = JSON.parse(message.body);
                                console.log('è§£æåçš„è®¢å•æ•°æ®:', orderData);
                                handleRealOrderPush(orderData);
                            } catch (error) {
                                console.error('è§£æè®¢å•æ¶ˆæ¯å¤±è´¥:', error);
                                showResult('driverResult', `âŒ è§£æè®¢å•æ¶ˆæ¯å¤±è´¥: ${error.message}`, true);
                            }
                        });
                        showResult('driverResult', `ğŸ“¡ å·²è®¢é˜…è®¢å•é˜Ÿåˆ—: /user/${driverId}/queue/orders`);

                        // è®¢é˜…è¿æ¥çŠ¶æ€é˜Ÿåˆ—
                        stompClient.subscribe('/user/' + driverId + '/queue/connection', function (message) {
                            console.log('ğŸ“¡ æ”¶åˆ°è¿æ¥çŠ¶æ€æ¶ˆæ¯:', message);
                            const data = JSON.parse(message.body);
                            showResult('driverResult', `ğŸ“¡ ${data.message}`);
                        });
                        showResult('driverResult', `ğŸ“¡ å·²è®¢é˜…è¿æ¥é˜Ÿåˆ—: /user/${driverId}/queue/connection`);

                        // è®¢é˜…é€šçŸ¥é˜Ÿåˆ—
                        stompClient.subscribe('/user/' + driverId + '/queue/notifications', function (message) {
                            console.log('ğŸ“¢ æ”¶åˆ°é€šçŸ¥æ¶ˆæ¯:', message);
                            const data = JSON.parse(message.body);
                            showResult('driverResult', `ğŸ“¢ ${data.message}`);
                        });
                        showResult('driverResult', `ğŸ“¡ å·²è®¢é˜…é€šçŸ¥é˜Ÿåˆ—: /user/${driverId}/queue/notifications`);

                        // å­˜å‚¨stompClientä»¥ä¾¿åç»­ä½¿ç”¨
                        window.stompClient = stompClient;
                    };

                    stompClient.onStompError = function (frame) {
                        isConnected = false;
                        updateConnectionStatus(false);
                        showResult('driverResult', `âŒ WebSocketè¿æ¥å¤±è´¥: ${frame.headers['message']}`, true);
                    };

                    // æ¿€æ´»è¿æ¥
                    stompClient.activate();
                } else {
                    // ä½¿ç”¨æ—§ç‰ˆæœ¬çš„ Stomp
                    stompClient = Stomp.over(websocket);
                    stompClient.debug = null;

                    stompClient.connect({}, function (frame) {
                        isConnected = true;
                        updateConnectionStatus(true);
                        showResult('driverResult', `âœ… WebSocketè¿æ¥æˆåŠŸï¼Œå¸æœº ${driverId} å¯ä»¥æ¥æ”¶è®¢å•æ¨é€`);

                        // å‘é€å¸æœºè¿æ¥æ¶ˆæ¯
                        stompClient.send('/app/driver/connect', {}, JSON.stringify({
                            driverId: driverId
                        }));

                        // è®¢é˜…å¸æœºä¸“ç”¨çš„è®¢å•é˜Ÿåˆ—
                        stompClient.subscribe('/user/' + driverId + '/queue/orders', function (message) {
                            const orderData = JSON.parse(message.body);
                            handleRealOrderPush(orderData);
                        });

                        // è®¢é˜…è¿æ¥çŠ¶æ€é˜Ÿåˆ—
                        stompClient.subscribe('/user/' + driverId + '/queue/connection', function (message) {
                            const data = JSON.parse(message.body);
                            showResult('driverResult', `ğŸ“¡ ${data.message}`);
                        });

                        // è®¢é˜…é€šçŸ¥é˜Ÿåˆ—
                        stompClient.subscribe('/user/' + driverId + '/queue/notifications', function (message) {
                            const data = JSON.parse(message.body);
                            showResult('driverResult', `ğŸ“¢ ${data.message}`);
                        });

                        // å­˜å‚¨stompClientä»¥ä¾¿åç»­ä½¿ç”¨
                        window.stompClient = stompClient;

                    }, function (error) {
                        isConnected = false;
                        updateConnectionStatus(false);
                        showResult('driverResult', `âŒ WebSocketè¿æ¥å¤±è´¥: ${error}`, true);
                    });
                }

            } catch (error) {
                showResult('driverResult', `âŒ WebSocketè¿æ¥å¤±è´¥: ${error.message}`, true);
                updateConnectionStatus(false);
            }
        }

        function handleRealOrderPush(orderData) {
            // å¤„ç†çœŸå®çš„åç«¯è®¢å•æ¨é€
            showResult('driverResult', `ğŸ“¢ æ”¶åˆ°åç«¯æ¨é€çš„è®¢å•: ${orderData.orderId}`);

            const notification = {
                orderId: orderData.orderId,
                orderNumber: orderData.orderNumber,
                pickupAddress: orderData.pickupAddress,
                destinationAddress: orderData.destinationAddress,
                distance: orderData.distance, // åç«¯å·²ç»è®¡ç®—å¥½çš„è·ç¦»
                estimatedFare: orderData.estimatedFare || 'å¾…è®¡ç®—',
                timestamp: new Date().toLocaleTimeString()
            };

            addOrderNotification(notification);
            playNotificationSound();
        }

        function updateConnectionStatus(connected) {
            const connectionStatus = document.getElementById('connectionStatus');
            const driverStatus = document.getElementById('driverStatus');

            if (connected) {
                connectionStatus.textContent = 'ğŸŸ¢ å·²è¿æ¥';
                connectionStatus.className = 'status-online';
                driverStatus.textContent = 'ğŸ“± åœ¨çº¿';
                driverStatus.className = 'status-online';
            } else {
                connectionStatus.textContent = 'ğŸ”´ æœªè¿æ¥';
                connectionStatus.className = 'status-offline';
                driverStatus.textContent = 'ğŸ“± ç¦»çº¿';
                driverStatus.className = 'status-offline';
            }
        }

        function startOrderPushSimulation() {
            // æ¨¡æ‹Ÿæ¥æ”¶è®¢å•æ¨é€
            // å®é™…é¡¹ç›®ä¸­è¿™é‡Œåº”è¯¥æ˜¯WebSocketçš„onmessageäº‹ä»¶å¤„ç†
            showResult('driverResult', 'ğŸ“¡ å¼€å§‹ç›‘å¬è®¢å•æ¨é€...');
        }

        function simulateOrderPush(orderData) {
            // æ¨¡æ‹Ÿæ”¶åˆ°è®¢å•æ¨é€
            const notification = {
                orderId: orderData.id,
                orderNumber: orderData.orderNumber,
                pickupAddress: orderData.pickupAddress,
                destinationAddress: orderData.destinationAddress,
                distance: calculateDistance(
                    parseFloat(document.getElementById('driverCoords').value.split(',')[0]),
                    parseFloat(document.getElementById('driverCoords').value.split(',')[1]),
                    orderData.pickupLatitude,
                    orderData.pickupLongitude
                ).toFixed(2),
                estimatedFare: orderData.estimatedFare || 'å¾…è®¡ç®—',
                timestamp: new Date().toLocaleTimeString()
            };

            addOrderNotification(notification);

            // æ’­æ”¾é€šçŸ¥éŸ³æ•ˆï¼ˆå¯é€‰ï¼‰
            playNotificationSound();
        }

        function addOrderNotification(notification) {
            const container = document.getElementById('orderNotifications');

            // ç§»é™¤"æš‚æ— è®¢å•æ¨é€"æç¤º
            const noNotifications = container.querySelector('.no-notifications');
            if (noNotifications) {
                noNotifications.remove();
            }

            // åˆ›å»ºè®¢å•é€šçŸ¥å¡ç‰‡
            const notificationCard = document.createElement('div');
            notificationCard.className = 'order-notification new';
            notificationCard.id = `notification-${notification.orderId}`;

            notificationCard.innerHTML = `
                <div class="notification-header">
                    <div class="notification-title">ğŸš— æ–°è®¢å•é€šçŸ¥ #${notification.orderId}</div>
                    <div class="notification-time">${notification.timestamp}</div>
                </div>
                <div class="notification-content">
                    <div><strong>ğŸ“ ä¸Šè½¦åœ°ç‚¹:</strong> ${notification.pickupAddress}</div>
                    <div><strong>ğŸ¯ ç›®çš„åœ°:</strong> ${notification.destinationAddress}</div>
                    <div><strong>ğŸ“ è·ç¦»:</strong> ${notification.distance} å…¬é‡Œ</div>
                    <div><strong>ğŸ’° é¢„ä¼°è´¹ç”¨:</strong> ${notification.estimatedFare} å…ƒ</div>
                </div>
                <div class="notification-actions">
                    <button class="notification-btn accept" onclick="acceptOrderFromNotification(${notification.orderId})">
                        âœ… æ¥å•
                    </button>
                    <button class="notification-btn reject" onclick="rejectOrderFromNotification(${notification.orderId})">
                        âŒ æ‹’å•
                    </button>
                </div>
            `;

            // æ’å…¥åˆ°å®¹å™¨é¡¶éƒ¨
            container.insertBefore(notificationCard, container.firstChild);

            // 3ç§’åç§»é™¤"new"ç±»ï¼Œåœæ­¢åŠ¨ç”»
            setTimeout(() => {
                notificationCard.classList.remove('new');
            }, 3000);

            showResult('driverResult', `ğŸ“¢ æ”¶åˆ°æ–°è®¢å•æ¨é€: è®¢å• ${notification.orderId}`);
        }

        async function acceptOrderFromNotification(orderId) {
            const driverId = document.getElementById('driverId').value;

            // ç¦ç”¨é€šçŸ¥å¡ç‰‡ä¸­çš„æŒ‰é’®
            const notification = document.getElementById(`notification-${orderId}`);
            const buttons = notification.querySelectorAll('.notification-btn');
            buttons.forEach(btn => btn.disabled = true);

            showResult('driverResult', `âœ… æ­£åœ¨æ¥å• ${orderId}...`);

            const result = await apiCall(`/api/drivers/${driverId}/accept-order/${orderId}`, 'POST');

            if (result.success) {
                showResult('driverResult', `âœ… æ¥å•æˆåŠŸï¼è®¢å• ${orderId}`);

                // æ›´æ–°é€šçŸ¥å¡ç‰‡çŠ¶æ€
                notification.style.background = '#d4edda';
                notification.innerHTML += '<div style="color: #155724; font-weight: bold; margin-top: 10px;">âœ… å·²æ¥å•</div>';

                setTimeout(getAllOrders, 1000);
            } else {
                showResult('driverResult', `âŒ æ¥å•å¤±è´¥: ${result.data?.message || result.error}`, true);

                // é‡æ–°å¯ç”¨æŒ‰é’®
                buttons.forEach(btn => btn.disabled = false);
            }
        }

        async function rejectOrderFromNotification(orderId) {
            const driverId = document.getElementById('driverId').value;

            // ç¦ç”¨é€šçŸ¥å¡ç‰‡ä¸­çš„æŒ‰é’®
            const notification = document.getElementById(`notification-${orderId}`);
            const buttons = notification.querySelectorAll('.notification-btn');
            buttons.forEach(btn => btn.disabled = true);

            showResult('driverResult', `âŒ æ­£åœ¨æ‹’å• ${orderId}...`);

            const result = await apiCall(`/api/drivers/${driverId}/reject-order/${orderId}?reason=è·ç¦»å¤ªè¿œ`, 'POST');

            if (result.success) {
                showResult('driverResult', `âœ… æ‹’å•æˆåŠŸï¼è®¢å• ${orderId}`);

                // æ›´æ–°é€šçŸ¥å¡ç‰‡çŠ¶æ€
                notification.style.background = '#f8d7da';
                notification.innerHTML += '<div style="color: #721c24; font-weight: bold; margin-top: 10px;">âŒ å·²æ‹’å•</div>';

                setTimeout(getAllOrders, 1000);
            } else {
                showResult('driverResult', `âŒ æ‹’å•å¤±è´¥: ${result.data?.message || result.error}`, true);

                // é‡æ–°å¯ç”¨æŒ‰é’®
                buttons.forEach(btn => btn.disabled = false);
            }
        }

        function playNotificationSound() {
            // æ’­æ”¾é€šçŸ¥éŸ³æ•ˆï¼ˆå¯é€‰ï¼‰
            try {
                const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUarm7blmGgU7k9n1unEiBC13yO/eizEIHWq+8+OWT');
                audio.play().catch(() => {
                    // å¿½ç•¥éŸ³é¢‘æ’­æ”¾é”™è¯¯
                });
            } catch (error) {
                // å¿½ç•¥éŸ³é¢‘ç›¸å…³é”™è¯¯
            }
        }

        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371; // åœ°çƒåŠå¾„ï¼ˆå…¬é‡Œï¼‰
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLng / 2) * Math.sin(dLng / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        // ==================== å¸æœºåŠŸèƒ½ ====================

        async function driverGoOnline() {
            const driverId = document.getElementById('driverId').value;
            const coords = document.getElementById('driverCoords').value.split(',');

            if (coords.length !== 2) {
                showResult('driverResult', 'âŒ åæ ‡æ ¼å¼é”™è¯¯ï¼Œè¯·ä½¿ç”¨"çº¬åº¦,ç»åº¦"æ ¼å¼', true);
                return;
            }

            showResult('driverResult', `ğŸŸ¢ å¸æœº ${driverId} æ­£åœ¨ä¸Šçº¿...`);

            const url = `/api/drivers/${driverId}/online?latitude=${coords[0]}&longitude=${coords[1]}`;
            const result = await apiCall(url, 'POST');

            if (result.success) {
                showResult('driverResult', `âœ… å¸æœº ${driverId} ä¸Šçº¿æˆåŠŸ`);
            } else {
                showResult('driverResult', `âŒ å¸æœºä¸Šçº¿å¤±è´¥: ${result.data?.message || result.error}`, true);
            }
        }

        async function driverGoOffline() {
            const driverId = document.getElementById('driverId').value;

            showResult('driverResult', `ğŸ”´ å¸æœº ${driverId} æ­£åœ¨ä¸‹çº¿...`);

            const result = await apiCall(`/api/drivers/${driverId}/offline`, 'POST');

            if (result.success) {
                showResult('driverResult', `âœ… å¸æœº ${driverId} ä¸‹çº¿æˆåŠŸ`);
            } else {
                showResult('driverResult', `âŒ å¸æœºä¸‹çº¿å¤±è´¥: ${result.data?.message || result.error}`, true);
            }
        }

        async function acceptOrder() {
            const driverId = document.getElementById('driverId').value;
            const orderId = document.getElementById('orderIdForDriver').value;

            if (!orderId) {
                showResult('driverResult', 'âŒ è¯·è¾“å…¥è®¢å•ID', true);
                return;
            }

            showResult('driverResult', `âœ… å¸æœº ${driverId} æ­£åœ¨æ¥å• ${orderId}...`);

            const result = await apiCall(`/api/drivers/${driverId}/accept-order/${orderId}`, 'POST');

            if (result.success) {
                showResult('driverResult', `âœ… æ¥å•æˆåŠŸï¼è®¢å• ${orderId}`);
                setTimeout(getAllOrders, 1000);
            } else {
                showResult('driverResult', `âŒ æ¥å•å¤±è´¥: ${result.data?.message || result.error}`, true);
            }
        }

        async function rejectOrder() {
            const driverId = document.getElementById('driverId').value;
            const orderId = document.getElementById('orderIdForDriver').value;

            if (!orderId) {
                showResult('driverResult', 'âŒ è¯·è¾“å…¥è®¢å•ID', true);
                return;
            }

            showResult('driverResult', `âŒ å¸æœº ${driverId} æ­£åœ¨æ‹’å• ${orderId}...`);

            const result = await apiCall(`/api/drivers/${driverId}/reject-order/${orderId}?reason=è·ç¦»å¤ªè¿œ`, 'POST');

            if (result.success) {
                showResult('driverResult', `âœ… æ‹’å•æˆåŠŸï¼è®¢å• ${orderId}`);
                setTimeout(getAllOrders, 1000);
            } else {
                showResult('driverResult', `âŒ æ‹’å•å¤±è´¥: ${result.data?.message || result.error}`, true);
            }
        }

        async function completeOrder() {
            const driverId = document.getElementById('driverId').value;
            const orderId = document.getElementById('orderIdForDriver').value;

            if (!orderId) {
                showResult('driverResult', 'âŒ è¯·è¾“å…¥è®¢å•ID', true);
                return;
            }

            showResult('driverResult', `ğŸ å¸æœº ${driverId} æ­£åœ¨å®Œæˆè®¢å• ${orderId}...`);

            const result = await apiCall(`/api/drivers/${driverId}/complete-order/${orderId}`, 'POST');

            if (result.success) {
                showResult('driverResult', `âœ… è®¢å•å®Œæˆï¼è®¢å• ${orderId}`);
                setTimeout(getAllOrders, 1000);
            } else {
                showResult('driverResult', `âŒ å®Œæˆè®¢å•å¤±è´¥: ${result.data?.message || result.error}`, true);
            }
        }

        async function getOnlineDrivers() {
            showResult('driverResult', 'ğŸ‘¥ æ­£åœ¨æŸ¥è¯¢åœ¨çº¿å¸æœº...');

            const result = await apiCall('/api/drivers/online');

            if (result.success) {
                const drivers = result.data.data;
                showResult('driverResult', `âœ… æ‰¾åˆ° ${drivers.length} ä¸ªåœ¨çº¿å¸æœº:`);
                drivers.forEach(driver => {
                    showResult('driverResult', `ğŸš• å¸æœºID: ${driver.id}, ä½ç½®: (${driver.currentLatitude}, ${driver.currentLongitude})`);
                });
            } else {
                showResult('driverResult', `âŒ æŸ¥è¯¢å¤±è´¥: ${result.data?.message || result.error}`, true);
            }
        }

        async function getNearbyDrivers() {
            const coords = document.getElementById('driverCoords').value.split(',');

            if (coords.length !== 2) {
                showResult('driverResult', 'âŒ è¯·å…ˆè®¾ç½®å¸æœºä½ç½®', true);
                return;
            }

            showResult('driverResult', 'ğŸ“ æ­£åœ¨æŸ¥è¯¢é™„è¿‘å¸æœº...');

            const url = `/api/drivers/nearby?latitude=${coords[0]}&longitude=${coords[1]}&radiusKm=5.0`;
            const result = await apiCall(url);

            if (result.success) {
                const drivers = result.data.data;
                showResult('driverResult', `âœ… 5å…¬é‡Œå†…æ‰¾åˆ° ${drivers.length} ä¸ªå¸æœº:`);
                drivers.forEach(driver => {
                    showResult('driverResult', `ğŸš• å¸æœºID: ${driver.id}, ä½ç½®: (${driver.currentLatitude}, ${driver.currentLongitude})`);
                });
            } else {
                showResult('driverResult', `âŒ æŸ¥è¯¢å¤±è´¥: ${result.data?.message || result.error}`, true);
            }
        }

        // ==================== è®¢å•çŠ¶æ€åŠŸèƒ½ ====================

        async function getAllOrders() {
            showResult('orderResult', 'ğŸ”„ æ­£åœ¨åˆ·æ–°è®¢å•çŠ¶æ€...');

            const result = await apiCall('/api/orders');

            if (result.success) {
                const orders = result.data.data;
                showResult('orderResult', `âœ… æ‰¾åˆ° ${orders.length} ä¸ªè®¢å•:`);

                orders.forEach(order => {
                    const statusClass = `status-${order.status.toLowerCase()}`;
                    showResult('orderResult',
                        `ğŸ“‹ è®¢å•ID: ${order.id} | çŠ¶æ€: <span class="order-status ${statusClass}">${order.status}</span> | ` +
                        `ä¹˜å®¢ID: ${order.passengerId} | å¸æœºID: ${order.driverId || 'æœªåˆ†é…'} | ` +
                        `${order.pickupAddress} â†’ ${order.destinationAddress}`
                    );
                });
            } else {
                showResult('orderResult', `âŒ æŸ¥è¯¢å¤±è´¥: ${result.data?.message || result.error}`, true);
            }
        }

        async function getOrderById() {
            const orderId = document.getElementById('queryOrderId').value;

            if (!orderId) {
                showResult('orderResult', 'âŒ è¯·è¾“å…¥è®¢å•ID', true);
                return;
            }

            showResult('orderResult', `ğŸ” æ­£åœ¨æŸ¥è¯¢è®¢å• ${orderId}...`);

            const result = await apiCall(`/api/orders/${orderId}`);

            if (result.success) {
                const order = result.data.data;
                showResult('orderResult', `âœ… è®¢å•è¯¦æƒ…:`);
                showResult('orderResult', `ğŸ“‹ ${JSON.stringify(order, null, 2)}`);

                // è‡ªåŠ¨å¡«å……åˆ°å¸æœºæ“ä½œé¢æ¿
                document.getElementById('orderIdForDriver').value = order.id;
            } else {
                showResult('orderResult', `âŒ æŸ¥è¯¢å¤±è´¥: ${result.data?.message || result.error}`, true);
            }
        }

        // ==================== é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ– ====================

        window.onload = function () {
            showResult('orderResult', 'ğŸš— ç½‘çº¦è½¦è®¢å•æµ‹è¯•ç³»ç»Ÿå·²å¯åŠ¨');
            showResult('orderResult', 'ğŸ’¡ æç¤º: è¯·å…ˆè®©å¸æœºä¸Šçº¿ï¼Œç„¶ååˆ›å»ºè®¢å•è¿›è¡Œæµ‹è¯•');

            // è‡ªåŠ¨åŠ è½½è®¢å•çŠ¶æ€
            getAllOrders();
        };
    </script>
</body>

</html>