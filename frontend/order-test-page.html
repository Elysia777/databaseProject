<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÁΩëÁ∫¶ËΩ¶ËÆ¢ÂçïÊµãËØïÈ°µÈù¢</title>
    <!-- WebSocketÁõ∏ÂÖ≥Â∫ì -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.6.1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@7.0.0/bundles/stomp.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(45deg, #FF6B6B, #4ECDC4);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .main-content {
            display: flex;
            min-height: 600px;
        }

        .panel {
            flex: 1;
            padding: 20px;
            border-right: 1px solid #eee;
        }

        .panel:last-child {
            border-right: none;
        }

        .panel h2 {
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #4ECDC4;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }

        .form-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-input:focus {
            outline: none;
            border-color: #4ECDC4;
        }

        .button-group {
            margin: 15px 0;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s;
            flex: 1;
            min-width: 120px;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .result-box {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.4;
        }

        .order-item {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .order-status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            color: white;
        }

        .status-pending {
            background: #ffc107;
            color: #212529;
        }

        .status-assigned {
            background: #17a2b8;
        }

        .status-pickup {
            background: #fd7e14;
        }

        .status-in-progress {
            background: #20c997;
        }

        .status-completed {
            background: #28a745;
        }

        .status-cancelled {
            background: #dc3545;
        }

        /* ËøûÊé•Áä∂ÊÄÅÊ†∑Âºè */
        .connection-status {
            margin: 15px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
        }

        .status-online {
            color: #28a745;
            font-weight: bold;
        }

        .status-offline {
            color: #dc3545;
            font-weight: bold;
        }

        /* ËÆ¢ÂçïÈÄöÁü•Âå∫ÂüüÊ†∑Âºè */
        .notification-area {
            margin: 20px 0;
            border: 2px solid #4ECDC4;
            border-radius: 10px;
            padding: 15px;
            background: #f0fdff;
        }

        .notification-area h3 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 16px;
        }

        .notifications-container {
            max-height: 300px;
            overflow-y: auto;
        }

        .no-notifications {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 20px;
        }

        /* ËÆ¢ÂçïÈÄöÁü•Âç°ÁâáÊ†∑Âºè */
        .order-notification {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            animation: slideIn 0.3s ease-out;
        }

        .order-notification.new {
            border-left: 4px solid #FF6B6B;
            animation: pulse 1s ease-in-out;
        }

        @keyframes slideIn {
            from {
                transform: translateX(-100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes pulse {

            0%,
            100% {
                background-color: white;
            }

            50% {
                background-color: #fff5f5;
            }
        }

        .notification-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 10px;
        }

        .notification-title {
            font-weight: bold;
            color: #333;
            font-size: 14px;
        }

        .notification-time {
            font-size: 12px;
            color: #666;
        }

        .notification-content {
            margin: 10px 0;
            font-size: 13px;
            line-height: 1.4;
        }

        .notification-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .notification-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
            transition: all 0.3s;
        }

        .notification-btn.accept {
            background: #28a745;
            color: white;
        }

        .notification-btn.reject {
            background: #dc3545;
            color: white;
        }

        .notification-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .notification-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>üöó ÁΩëÁ∫¶ËΩ¶ËÆ¢ÂçïÊµãËØïÁ≥ªÁªü</h1>
            <p>ÊµãËØï‰πòÂÆ¢‰∏ãÂçï„ÄÅÂè∏Êú∫Êé•ÂçïÁ≠âÂäüËÉΩ</p>
        </div>

        <div class="main-content">
            <!-- ‰πòÂÆ¢Èù¢Êùø -->
            <div class="panel">
                <h2>üë§ ‰πòÂÆ¢Êìç‰Ωú</h2>

                <div class="form-group">
                    <label>‰πòÂÆ¢ID:</label>
                    <input type="number" id="passengerId" value="1" class="form-input">
                </div>

                <div class="form-group">
                    <label>‰∏äËΩ¶Âú∞ÂùÄ:</label>
                    <input type="text" id="pickupAddress" value="Âåó‰∫¨Â∏ÇÊúùÈò≥Âå∫‰∏âÈáåÂ±Ø" class="form-input">
                </div>

                <div class="form-group">
                    <label>‰∏äËΩ¶ÂùêÊ†á:</label>
                    <input type="text" id="pickupCoords" value="39.9365,116.4477" class="form-input"
                        placeholder="Á∫¨Â∫¶,ÁªèÂ∫¶">
                </div>

                <div class="form-group">
                    <label>ÁõÆÁöÑÂú∞Âú∞ÂùÄ:</label>
                    <input type="text" id="destinationAddress" value="Âåó‰∫¨Â∏ÇÊµ∑Ê∑ÄÂå∫‰∏≠ÂÖ≥Êùë" class="form-input">
                </div>

                <div class="form-group">
                    <label>ÁõÆÁöÑÂú∞ÂùêÊ†á:</label>
                    <input type="text" id="destinationCoords" value="39.9851,116.3058" class="form-input"
                        placeholder="Á∫¨Â∫¶,ÁªèÂ∫¶">
                </div>

                <div class="button-group">
                    <button onclick="createOrder()" class="btn btn-primary">üì± ‰∏ãÂçï</button>
                    <button onclick="cancelOrder()" class="btn btn-danger">‚ùå ÂèñÊ∂àËÆ¢Âçï</button>
                </div>

                <div id="passengerResult" class="result-box"></div>
            </div>

            <!-- Âè∏Êú∫Èù¢Êùø -->
            <div class="panel">
                <h2>üöï Âè∏Êú∫Êìç‰Ωú</h2>

                <div class="form-group">
                    <label>Âè∏Êú∫ID:</label>
                    <input type="number" id="driverId" value="1" class="form-input">
                </div>

                <div class="form-group">
                    <label>Âè∏Êú∫‰ΩçÁΩÆ:</label>
                    <input type="text" id="driverCoords" value="39.9042,116.4074" class="form-input"
                        placeholder="Á∫¨Â∫¶,ÁªèÂ∫¶">
                </div>

                <div class="button-group">
                    <button onclick="driverGoOnline()" class="btn btn-success">üü¢ ‰∏äÁ∫ø</button>
                    <button onclick="driverGoOffline()" class="btn btn-secondary">üî¥ ‰∏ãÁ∫ø</button>
                    <button onclick="connectWebSocket()" class="btn btn-info">üîó ËøûÊé•Êé®ÈÄÅ</button>
                </div>

                <div class="connection-status">
                    <span id="connectionStatus" class="status-offline">üî¥ Êú™ËøûÊé•</span>
                    <span id="driverStatus" class="status-offline">üì± Á¶ªÁ∫ø</span>
                </div>

                <!-- ËÆ¢ÂçïÊé®ÈÄÅÈÄöÁü•Âå∫Âüü -->
                <div class="notification-area">
                    <h3>üì¢ ËÆ¢ÂçïÊé®ÈÄÅÈÄöÁü•</h3>
                    <div id="orderNotifications" class="notifications-container">
                        <div class="no-notifications">ÊöÇÊó†ËÆ¢ÂçïÊé®ÈÄÅ</div>
                    </div>
                </div>

                <div class="button-group">
                    <button onclick="getOnlineDrivers()" class="btn btn-info">üë• Êü•ÁúãÂú®Á∫øÂè∏Êú∫</button>
                    <button onclick="getNearbyDrivers()" class="btn btn-info">üìç Êü•ÁúãÈôÑËøëÂè∏Êú∫</button>
                </div>

                <div id="driverResult" class="result-box"></div>
            </div>

            <!-- ËÆ¢ÂçïÁä∂ÊÄÅÈù¢Êùø -->
            <div class="panel">
                <h2>üìã ËÆ¢ÂçïÁä∂ÊÄÅ</h2>

                <div class="button-group">
                    <button onclick="getAllOrders()" class="btn btn-info">üîÑ Âà∑Êñ∞ËÆ¢Âçï</button>
                    <button onclick="clearResults()" class="btn btn-secondary">üóëÔ∏è Ê∏ÖÁ©∫ÁªìÊûú</button>
                </div>

                <div class="form-group">
                    <label>Êü•ËØ¢ËÆ¢ÂçïID:</label>
                    <input type="number" id="queryOrderId" value="" class="form-input" placeholder="ËæìÂÖ•ËÆ¢ÂçïIDÊü•ËØ¢">
                    <button onclick="getOrderById()" class="btn btn-info" style="margin-top: 5px;">üîç Êü•ËØ¢ËÆ¢Âçï</button>
                </div>

                <div id="orderResult" class="result-box"></div>
            </div>
        </div>
    </div>

    <script>
        // APIÂü∫Á°ÄURL
        const API_BASE_URL = 'http://localhost:8080';
        const WS_BASE_URL = 'ws://localhost:8080';

        // ÂΩìÂâçËÆ¢ÂçïIDÔºàÁî®‰∫éÂèñÊ∂àËÆ¢ÂçïÔºâ
        let currentOrderId = null;

        // WebSocketËøûÊé•
        let websocket = null;
        let isConnected = false;

        // ==================== Â∑•ÂÖ∑ÂáΩÊï∞ ====================

        function showResult(elementId, message, isError = false) {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const color = isError ? '#dc3545' : '#28a745';
            element.innerHTML += `<div style="color: ${color}; margin-bottom: 10px;">
                [${timestamp}] ${message}
            </div>`;
            element.scrollTop = element.scrollHeight;
        }

        function clearResults() {
            document.getElementById('passengerResult').innerHTML = '';
            document.getElementById('driverResult').innerHTML = '';
            document.getElementById('orderResult').innerHTML = '';
        }

        async function apiCall(url, method = 'GET', data = null) {
            try {
                const options = {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    }
                };

                if (data) {
                    options.body = JSON.stringify(data);
                }

                const response = await fetch(API_BASE_URL + url, options);
                const result = await response.json();

                return { success: response.ok, data: result };
            } catch (error) {
                return { success: false, error: error.message };
            }
        }

        // ==================== ‰πòÂÆ¢ÂäüËÉΩ ====================

        async function createOrder() {
            const passengerId = document.getElementById('passengerId').value;
            const pickupAddress = document.getElementById('pickupAddress').value;
            const pickupCoords = document.getElementById('pickupCoords').value.split(',');
            const destinationAddress = document.getElementById('destinationAddress').value;
            const destinationCoords = document.getElementById('destinationCoords').value.split(',');

            if (pickupCoords.length !== 2 || destinationCoords.length !== 2) {
                showResult('passengerResult', '‚ùå ÂùêÊ†áÊ†ºÂºèÈîôËØØÔºåËØ∑‰ΩøÁî®"Á∫¨Â∫¶,ÁªèÂ∫¶"Ê†ºÂºè', true);
                return;
            }

            const orderData = {
                passengerId: parseInt(passengerId),
                pickupAddress: pickupAddress,
                pickupLatitude: parseFloat(pickupCoords[0]),
                pickupLongitude: parseFloat(pickupCoords[1]),
                destinationAddress: destinationAddress,
                destinationLatitude: parseFloat(destinationCoords[0]),
                destinationLongitude: parseFloat(destinationCoords[1]),
                orderType: 'REAL_TIME'
            };

            showResult('passengerResult', 'üì± Ê≠£Âú®ÂàõÂª∫ËÆ¢Âçï...');

            const result = await apiCall('/api/orders/create', 'POST', orderData);

            if (result.success) {
                currentOrderId = result.data.data.id;
                showResult('passengerResult', `‚úÖ ËÆ¢ÂçïÂàõÂª∫ÊàêÂäüÔºÅËÆ¢ÂçïID: ${currentOrderId}`);
                showResult('passengerResult', `üìã ËÆ¢ÂçïËØ¶ÊÉÖ: ${JSON.stringify(result.data.data, null, 2)}`);
                showResult('passengerResult', `üì° ËÆ¢ÂçïÂ∑≤Êèê‰∫§Âà∞ÂêéÁ´ØÂàÜÈÖçÁ≥ªÁªüÔºåÁ¨¶ÂêàË∑ùÁ¶ªÊù°‰ª∂ÁöÑÂè∏Êú∫Â∞ÜÊî∂Âà∞Êé®ÈÄÅ`);

                // Ëá™Âä®Âà∑Êñ∞ËÆ¢ÂçïÁä∂ÊÄÅ
                setTimeout(getAllOrders, 1000);
            } else {
                showResult('passengerResult', `‚ùå ËÆ¢ÂçïÂàõÂª∫Â§±Ë¥•: ${result.data?.message || result.error}`, true);
            }
        }

        async function cancelOrder() {
            const orderId = currentOrderId || document.getElementById('queryOrderId').value;

            if (!orderId) {
                showResult('passengerResult', '‚ùå ËØ∑ÂÖàÂàõÂª∫ËÆ¢ÂçïÊàñËæìÂÖ•ËÆ¢ÂçïID', true);
                return;
            }

            showResult('passengerResult', `üö´ Ê≠£Âú®ÂèñÊ∂àËÆ¢Âçï ${orderId}...`);

            const result = await apiCall(`/api/orders/${orderId}/cancel`, 'POST');

            if (result.success) {
                showResult('passengerResult', `‚úÖ ËÆ¢Âçï ${orderId} ÂèñÊ∂àÊàêÂäü`);
                currentOrderId = null;
                setTimeout(getAllOrders, 1000);
            } else {
                showResult('passengerResult', `‚ùå ÂèñÊ∂àËÆ¢ÂçïÂ§±Ë¥•: ${result.data?.message || result.error}`, true);
            }
        }

        // ==================== WebSocket ÂÆûÊó∂Êé®ÈÄÅÂäüËÉΩ ====================

        function connectWebSocket() {
            const driverId = document.getElementById('driverId').value;

            if (websocket && websocket.readyState === WebSocket.OPEN) {
                showResult('driverResult', '‚ö†Ô∏è WebSocketÂ∑≤ËøûÊé•ÔºåÊó†ÈúÄÈáçÂ§çËøûÊé•');
                return;
            }

            // Ê£ÄÊü•ÂøÖË¶ÅÁöÑÂ∫ìÊòØÂê¶Âä†ËΩΩ
            if (typeof SockJS === 'undefined') {
                showResult('driverResult', '‚ùå SockJSÂ∫ìÊú™Âä†ËΩΩÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•', true);
                return;
            }

            if (typeof StompJs === 'undefined' && typeof Stomp === 'undefined') {
                showResult('driverResult', '‚ùå STOMPÂ∫ìÊú™Âä†ËΩΩÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•', true);
                return;
            }

            try {
                showResult('driverResult', `üîó Ê≠£Âú®ËøûÊé•WebSocketÊé®ÈÄÅÊúçÂä°...`);

                // ËøûÊé•Âà∞ÂêéÁ´ØÁöÑWebSocketÊúçÂä°
                websocket = new SockJS(API_BASE_URL + '/ws');

                // ‰ΩøÁî®Ê≠£Á°ÆÁöÑSTOMPÂÆ¢Êà∑Á´Ø
                let stompClient;

                if (typeof StompJs !== 'undefined') {
                    // ‰ΩøÁî®Êñ∞ÁâàÊú¨ÁöÑ @stomp/stompjs
                    stompClient = new StompJs.Client({
                        webSocketFactory: () => new SockJS(API_BASE_URL + '/ws'),
                        debug: () => { } // Á¶ÅÁî®Ë∞ÉËØïÊó•Âøó
                    });

                    stompClient.onConnect = function (frame) {
                        isConnected = true;
                        updateConnectionStatus(true);
                        showResult('driverResult', `‚úÖ WebSocketËøûÊé•ÊàêÂäüÔºåÂè∏Êú∫ ${driverId} ÂèØ‰ª•Êé•Êî∂ËÆ¢ÂçïÊé®ÈÄÅ`);
                        console.log('WebSocketËøûÊé•ÊàêÂäüÔºåframe:', frame);

                        // ÂèëÈÄÅÂè∏Êú∫ËøûÊé•Ê∂àÊÅØ
                        console.log('ÂáÜÂ§áÂèëÈÄÅÂè∏Êú∫ËøûÊé•Ê∂àÊÅØÔºåÂè∏Êú∫ID:', driverId);
                        stompClient.publish({
                            destination: '/app/driver/connect',
                            body: JSON.stringify({ driverId: driverId })
                        });
                        showResult('driverResult', `üì§ Â∑≤ÂèëÈÄÅÂè∏Êú∫ËøûÊé•Ê∂àÊÅØÂà∞ÂêéÁ´Ø (Âè∏Êú∫ID: ${driverId})`);

                        // ËÆ¢ÈòÖÂè∏Êú∫‰∏ìÁî®ÁöÑËÆ¢ÂçïÈòüÂàó
                        const orderSubscription = stompClient.subscribe('/user/' + driverId + '/queue/orders', function (message) {
                            console.log('üöó Êî∂Âà∞ËÆ¢ÂçïÊé®ÈÄÅÊ∂àÊÅØ:', message);
                            showResult('driverResult', `üì® Êî∂Âà∞ËÆ¢ÂçïÊé®ÈÄÅ: ${message.body}`);
                            try {
                                const orderData = JSON.parse(message.body);
                                console.log('Ëß£ÊûêÂêéÁöÑËÆ¢ÂçïÊï∞ÊçÆ:', orderData);
                                handleRealOrderPush(orderData);
                            } catch (error) {
                                console.error('Ëß£ÊûêËÆ¢ÂçïÊ∂àÊÅØÂ§±Ë¥•:', error);
                                showResult('driverResult', `‚ùå Ëß£ÊûêËÆ¢ÂçïÊ∂àÊÅØÂ§±Ë¥•: ${error.message}`, true);
                            }
                        });
                        showResult('driverResult', `üì° Â∑≤ËÆ¢ÈòÖËÆ¢ÂçïÈòüÂàó: /user/${driverId}/queue/orders`);

                        // ËÆ¢ÈòÖËøûÊé•Áä∂ÊÄÅÈòüÂàó
                        stompClient.subscribe('/user/' + driverId + '/queue/connection', function (message) {
                            console.log('üì° Êî∂Âà∞ËøûÊé•Áä∂ÊÄÅÊ∂àÊÅØ:', message);
                            const data = JSON.parse(message.body);
                            showResult('driverResult', `üì° ${data.message}`);
                        });
                        showResult('driverResult', `üì° Â∑≤ËÆ¢ÈòÖËøûÊé•ÈòüÂàó: /user/${driverId}/queue/connection`);

                        // ËÆ¢ÈòÖÈÄöÁü•ÈòüÂàó
                        stompClient.subscribe('/user/' + driverId + '/queue/notifications', function (message) {
                            console.log('üì¢ Êî∂Âà∞ÈÄöÁü•Ê∂àÊÅØ:', message);
                            const data = JSON.parse(message.body);
                            showResult('driverResult', `üì¢ ${data.message}`);
                        });
                        showResult('driverResult', `üì° Â∑≤ËÆ¢ÈòÖÈÄöÁü•ÈòüÂàó: /user/${driverId}/queue/notifications`);

                        // Â≠òÂÇ®stompClient‰ª•‰æøÂêéÁª≠‰ΩøÁî®
                        window.stompClient = stompClient;
                    };

                    stompClient.onStompError = function (frame) {
                        isConnected = false;
                        updateConnectionStatus(false);
                        showResult('driverResult', `‚ùå WebSocketËøûÊé•Â§±Ë¥•: ${frame.headers['message']}`, true);
                    };

                    // ÊøÄÊ¥ªËøûÊé•
                    stompClient.activate();
                } else {
                    // ‰ΩøÁî®ÊóßÁâàÊú¨ÁöÑ Stomp
                    stompClient = Stomp.over(websocket);
                    stompClient.debug = null;

                    stompClient.connect({}, function (frame) {
                        isConnected = true;
                        updateConnectionStatus(true);
                        showResult('driverResult', `‚úÖ WebSocketËøûÊé•ÊàêÂäüÔºåÂè∏Êú∫ ${driverId} ÂèØ‰ª•Êé•Êî∂ËÆ¢ÂçïÊé®ÈÄÅ`);

                        // ÂèëÈÄÅÂè∏Êú∫ËøûÊé•Ê∂àÊÅØ
                        stompClient.send('/app/driver/connect', {}, JSON.stringify({
                            driverId: driverId
                        }));

                        // ËÆ¢ÈòÖÂè∏Êú∫‰∏ìÁî®ÁöÑËÆ¢ÂçïÈòüÂàó
                        stompClient.subscribe('/user/' + driverId + '/queue/orders', function (message) {
                            const orderData = JSON.parse(message.body);
                            handleRealOrderPush(orderData);
                        });

                        // ËÆ¢ÈòÖËøûÊé•Áä∂ÊÄÅÈòüÂàó
                        stompClient.subscribe('/user/' + driverId + '/queue/connection', function (message) {
                            const data = JSON.parse(message.body);
                            showResult('driverResult', `üì° ${data.message}`);
                        });

                        // ËÆ¢ÈòÖÈÄöÁü•ÈòüÂàó
                        stompClient.subscribe('/user/' + driverId + '/queue/notifications', function (message) {
                            const data = JSON.parse(message.body);
                            showResult('driverResult', `üì¢ ${data.message}`);
                        });

                        // Â≠òÂÇ®stompClient‰ª•‰æøÂêéÁª≠‰ΩøÁî®
                        window.stompClient = stompClient;

                    }, function (error) {
                        isConnected = false;
                        updateConnectionStatus(false);
                        showResult('driverResult', `‚ùå WebSocketËøûÊé•Â§±Ë¥•: ${error}`, true);
                    });
                }

            } catch (error) {
                showResult('driverResult', `‚ùå WebSocketËøûÊé•Â§±Ë¥•: ${error.message}`, true);
                updateConnectionStatus(false);
            }
        }

        function handleRealOrderPush(orderData) {
            // Â§ÑÁêÜÁúüÂÆûÁöÑÂêéÁ´ØËÆ¢ÂçïÊé®ÈÄÅ
            showResult('driverResult', `üì¢ Êî∂Âà∞ÂêéÁ´ØÊé®ÈÄÅÁöÑËÆ¢Âçï: ${orderData.orderId}`);

            const notification = {
                orderId: orderData.orderId,
                orderNumber: orderData.orderNumber,
                pickupAddress: orderData.pickupAddress,
                destinationAddress: orderData.destinationAddress,
                distance: orderData.distance, // ÂêéÁ´ØÂ∑≤ÁªèËÆ°ÁÆóÂ•ΩÁöÑË∑ùÁ¶ª
                estimatedFare: orderData.estimatedFare || 'ÂæÖËÆ°ÁÆó',
                timestamp: new Date().toLocaleTimeString()
            };

            addOrderNotification(notification);
            playNotificationSound();
        }

        function updateConnectionStatus(connected) {
            const connectionStatus = document.getElementById('connectionStatus');
            const driverStatus = document.getElementById('driverStatus');

            if (connected) {
                connectionStatus.textContent = 'üü¢ Â∑≤ËøûÊé•';
                connectionStatus.className = 'status-online';
                driverStatus.textContent = 'üì± Âú®Á∫ø';
                driverStatus.className = 'status-online';
            } else {
                connectionStatus.textContent = 'üî¥ Êú™ËøûÊé•';
                connectionStatus.className = 'status-offline';
                driverStatus.textContent = 'üì± Á¶ªÁ∫ø';
                driverStatus.className = 'status-offline';
            }
        }

        function startOrderPushSimulation() {
            // Ê®°ÊãüÊé•Êî∂ËÆ¢ÂçïÊé®ÈÄÅ
            // ÂÆûÈôÖÈ°πÁõÆ‰∏≠ËøôÈáåÂ∫îËØ•ÊòØWebSocketÁöÑonmessage‰∫ã‰ª∂Â§ÑÁêÜ
            showResult('driverResult', 'üì° ÂºÄÂßãÁõëÂê¨ËÆ¢ÂçïÊé®ÈÄÅ...');
        }

        function simulateOrderPush(orderData) {
            // Ê®°ÊãüÊî∂Âà∞ËÆ¢ÂçïÊé®ÈÄÅ
            const notification = {
                orderId: orderData.id,
                orderNumber: orderData.orderNumber,
                pickupAddress: orderData.pickupAddress,
                destinationAddress: orderData.destinationAddress,
                distance: calculateDistance(
                    parseFloat(document.getElementById('driverCoords').value.split(',')[0]),
                    parseFloat(document.getElementById('driverCoords').value.split(',')[1]),
                    orderData.pickupLatitude,
                    orderData.pickupLongitude
                ).toFixed(2),
                estimatedFare: orderData.estimatedFare || 'ÂæÖËÆ°ÁÆó',
                timestamp: new Date().toLocaleTimeString()
            };

            addOrderNotification(notification);

            // Êí≠ÊîæÈÄöÁü•Èü≥ÊïàÔºàÂèØÈÄâÔºâ
            playNotificationSound();
        }

        function addOrderNotification(notification) {
            const container = document.getElementById('orderNotifications');

            // ÁßªÈô§"ÊöÇÊó†ËÆ¢ÂçïÊé®ÈÄÅ"ÊèêÁ§∫
            const noNotifications = container.querySelector('.no-notifications');
            if (noNotifications) {
                noNotifications.remove();
            }

            // ÂàõÂª∫ËÆ¢ÂçïÈÄöÁü•Âç°Áâá
            const notificationCard = document.createElement('div');
            notificationCard.className = 'order-notification new';
            notificationCard.id = `notification-${notification.orderId}`;

            notificationCard.innerHTML = `
                <div class="notification-header">
                    <div class="notification-title">üöó Êñ∞ËÆ¢ÂçïÈÄöÁü• #${notification.orderId}</div>
                    <div class="notification-time">${notification.timestamp}</div>
                </div>
                <div class="notification-content">
                    <div><strong>üìç ‰∏äËΩ¶Âú∞ÁÇπ:</strong> ${notification.pickupAddress}</div>
                    <div><strong>üéØ ÁõÆÁöÑÂú∞:</strong> ${notification.destinationAddress}</div>
                    <div><strong>üìè Ë∑ùÁ¶ª:</strong> ${notification.distance} ÂÖ¨Èáå</div>
                    <div><strong>üí∞ È¢Ñ‰º∞Ë¥πÁî®:</strong> ${notification.estimatedFare} ÂÖÉ</div>
                </div>
                <div class="notification-actions">
                    <button class="notification-btn accept" onclick="acceptOrderFromNotification(${notification.orderId})">
                        ‚úÖ Êé•Âçï
                    </button>
                    <button class="notification-btn reject" onclick="rejectOrderFromNotification(${notification.orderId})">
                        ‚ùå ÊãíÂçï
                    </button>
                </div>
            `;

            // ÊèíÂÖ•Âà∞ÂÆπÂô®È°∂ÈÉ®
            container.insertBefore(notificationCard, container.firstChild);

            // 3ÁßíÂêéÁßªÈô§"new"Á±ªÔºåÂÅúÊ≠¢Âä®Áîª
            setTimeout(() => {
                notificationCard.classList.remove('new');
            }, 3000);

            showResult('driverResult', `üì¢ Êî∂Âà∞Êñ∞ËÆ¢ÂçïÊé®ÈÄÅ: ËÆ¢Âçï ${notification.orderId}`);
        }

        async function acceptOrderFromNotification(orderId) {
            const driverId = document.getElementById('driverId').value;

            // Á¶ÅÁî®ÈÄöÁü•Âç°Áâá‰∏≠ÁöÑÊåâÈíÆ
            const notification = document.getElementById(`notification-${orderId}`);
            const buttons = notification.querySelectorAll('.notification-btn');
            buttons.forEach(btn => btn.disabled = true);

            showResult('driverResult', `‚úÖ Ê≠£Âú®Êé•Âçï ${orderId}...`);

            const result = await apiCall(`/api/drivers/${driverId}/accept-order/${orderId}`, 'POST');

            if (result.success) {
                showResult('driverResult', `‚úÖ Êé•ÂçïÊàêÂäüÔºÅËÆ¢Âçï ${orderId}`);

                // Êõ¥Êñ∞ÈÄöÁü•Âç°ÁâáÁä∂ÊÄÅ
                notification.style.background = '#d4edda';
                notification.innerHTML += '<div style="color: #155724; font-weight: bold; margin-top: 10px;">‚úÖ Â∑≤Êé•Âçï</div>';

                setTimeout(getAllOrders, 1000);
            } else {
                showResult('driverResult', `‚ùå Êé•ÂçïÂ§±Ë¥•: ${result.data?.message || result.error}`, true);

                // ÈáçÊñ∞ÂêØÁî®ÊåâÈíÆ
                buttons.forEach(btn => btn.disabled = false);
            }
        }

        async function rejectOrderFromNotification(orderId) {
            const driverId = document.getElementById('driverId').value;

            // Á¶ÅÁî®ÈÄöÁü•Âç°Áâá‰∏≠ÁöÑÊåâÈíÆ
            const notification = document.getElementById(`notification-${orderId}`);
            const buttons = notification.querySelectorAll('.notification-btn');
            buttons.forEach(btn => btn.disabled = true);

            showResult('driverResult', `‚ùå Ê≠£Âú®ÊãíÂçï ${orderId}...`);

            const result = await apiCall(`/api/drivers/${driverId}/reject-order/${orderId}?reason=Ë∑ùÁ¶ªÂ§™Ëøú`, 'POST');

            if (result.success) {
                showResult('driverResult', `‚úÖ ÊãíÂçïÊàêÂäüÔºÅËÆ¢Âçï ${orderId}`);

                // Êõ¥Êñ∞ÈÄöÁü•Âç°ÁâáÁä∂ÊÄÅ
                notification.style.background = '#f8d7da';
                notification.innerHTML += '<div style="color: #721c24; font-weight: bold; margin-top: 10px;">‚ùå Â∑≤ÊãíÂçï</div>';

                setTimeout(getAllOrders, 1000);
            } else {
                showResult('driverResult', `‚ùå ÊãíÂçïÂ§±Ë¥•: ${result.data?.message || result.error}`, true);

                // ÈáçÊñ∞ÂêØÁî®ÊåâÈíÆ
                buttons.forEach(btn => btn.disabled = false);
            }
        }

        function playNotificationSound() {
            // Êí≠ÊîæÈÄöÁü•Èü≥ÊïàÔºàÂèØÈÄâÔºâ
            try {
                const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUarm7blmGgU7k9n1unEiBC13yO/eizEIHWq+8+OWT');
                audio.play().catch(() => {
                    // ÂøΩÁï•Èü≥È¢ëÊí≠ÊîæÈîôËØØ
                });
            } catch (error) {
                // ÂøΩÁï•Èü≥È¢ëÁõ∏ÂÖ≥ÈîôËØØ
            }
        }

        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371; // Âú∞ÁêÉÂçäÂæÑÔºàÂÖ¨ÈáåÔºâ
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLng / 2) * Math.sin(dLng / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        // ==================== Âè∏Êú∫ÂäüËÉΩ ====================

        async function driverGoOnline() {
            const driverId = document.getElementById('driverId').value;
            const coords = document.getElementById('driverCoords').value.split(',');

            if (coords.length !== 2) {
                showResult('driverResult', '‚ùå ÂùêÊ†áÊ†ºÂºèÈîôËØØÔºåËØ∑‰ΩøÁî®"Á∫¨Â∫¶,ÁªèÂ∫¶"Ê†ºÂºè', true);
                return;
            }

            showResult('driverResult', `üü¢ Âè∏Êú∫ ${driverId} Ê≠£Âú®‰∏äÁ∫ø...`);

            const url = `/api/drivers/${driverId}/online?latitude=${coords[0]}&longitude=${coords[1]}`;
            const result = await apiCall(url, 'POST');

            if (result.success) {
                showResult('driverResult', `‚úÖ Âè∏Êú∫ ${driverId} ‰∏äÁ∫øÊàêÂäü`);
            } else {
                showResult('driverResult', `‚ùå Âè∏Êú∫‰∏äÁ∫øÂ§±Ë¥•: ${result.data?.message || result.error}`, true);
            }
        }

        async function driverGoOffline() {
            const driverId = document.getElementById('driverId').value;

            showResult('driverResult', `üî¥ Âè∏Êú∫ ${driverId} Ê≠£Âú®‰∏ãÁ∫ø...`);

            const result = await apiCall(`/api/drivers/${driverId}/offline`, 'POST');

            if (result.success) {
                showResult('driverResult', `‚úÖ Âè∏Êú∫ ${driverId} ‰∏ãÁ∫øÊàêÂäü`);
            } else {
                showResult('driverResult', `‚ùå Âè∏Êú∫‰∏ãÁ∫øÂ§±Ë¥•: ${result.data?.message || result.error}`, true);
            }
        }

        async function acceptOrder() {
            const driverId = document.getElementById('driverId').value;
            const orderId = document.getElementById('orderIdForDriver').value;

            if (!orderId) {
                showResult('driverResult', '‚ùå ËØ∑ËæìÂÖ•ËÆ¢ÂçïID', true);
                return;
            }

            showResult('driverResult', `‚úÖ Âè∏Êú∫ ${driverId} Ê≠£Âú®Êé•Âçï ${orderId}...`);

            const result = await apiCall(`/api/drivers/${driverId}/accept-order/${orderId}`, 'POST');

            if (result.success) {
                showResult('driverResult', `‚úÖ Êé•ÂçïÊàêÂäüÔºÅËÆ¢Âçï ${orderId}`);
                setTimeout(getAllOrders, 1000);
            } else {
                showResult('driverResult', `‚ùå Êé•ÂçïÂ§±Ë¥•: ${result.data?.message || result.error}`, true);
            }
        }

        async function rejectOrder() {
            const driverId = document.getElementById('driverId').value;
            const orderId = document.getElementById('orderIdForDriver').value;

            if (!orderId) {
                showResult('driverResult', '‚ùå ËØ∑ËæìÂÖ•ËÆ¢ÂçïID', true);
                return;
            }

            showResult('driverResult', `‚ùå Âè∏Êú∫ ${driverId} Ê≠£Âú®ÊãíÂçï ${orderId}...`);

            const result = await apiCall(`/api/drivers/${driverId}/reject-order/${orderId}?reason=Ë∑ùÁ¶ªÂ§™Ëøú`, 'POST');

            if (result.success) {
                showResult('driverResult', `‚úÖ ÊãíÂçïÊàêÂäüÔºÅËÆ¢Âçï ${orderId}`);
                setTimeout(getAllOrders, 1000);
            } else {
                showResult('driverResult', `‚ùå ÊãíÂçïÂ§±Ë¥•: ${result.data?.message || result.error}`, true);
            }
        }

        async function completeOrder() {
            const driverId = document.getElementById('driverId').value;
            const orderId = document.getElementById('orderIdForDriver').value;

            if (!orderId) {
                showResult('driverResult', '‚ùå ËØ∑ËæìÂÖ•ËÆ¢ÂçïID', true);
                return;
            }

            showResult('driverResult', `üèÅ Âè∏Êú∫ ${driverId} Ê≠£Âú®ÂÆåÊàêËÆ¢Âçï ${orderId}...`);

            const result = await apiCall(`/api/drivers/${driverId}/complete-order/${orderId}`, 'POST');

            if (result.success) {
                showResult('driverResult', `‚úÖ ËÆ¢ÂçïÂÆåÊàêÔºÅËÆ¢Âçï ${orderId}`);
                setTimeout(getAllOrders, 1000);
            } else {
                showResult('driverResult', `‚ùå ÂÆåÊàêËÆ¢ÂçïÂ§±Ë¥•: ${result.data?.message || result.error}`, true);
            }
        }

        async function getOnlineDrivers() {
            showResult('driverResult', 'üë• Ê≠£Âú®Êü•ËØ¢Âú®Á∫øÂè∏Êú∫...');

            const result = await apiCall('/api/drivers/online');

            if (result.success) {
                const drivers = result.data.data;
                showResult('driverResult', `‚úÖ ÊâæÂà∞ ${drivers.length} ‰∏™Âú®Á∫øÂè∏Êú∫:`);
                drivers.forEach(driver => {
                    showResult('driverResult', `üöï Âè∏Êú∫ID: ${driver.id}, ‰ΩçÁΩÆ: (${driver.currentLatitude}, ${driver.currentLongitude})`);
                });
            } else {
                showResult('driverResult', `‚ùå Êü•ËØ¢Â§±Ë¥•: ${result.data?.message || result.error}`, true);
            }
        }

        async function getNearbyDrivers() {
            const coords = document.getElementById('driverCoords').value.split(',');

            if (coords.length !== 2) {
                showResult('driverResult', '‚ùå ËØ∑ÂÖàËÆæÁΩÆÂè∏Êú∫‰ΩçÁΩÆ', true);
                return;
            }

            showResult('driverResult', 'üìç Ê≠£Âú®Êü•ËØ¢ÈôÑËøëÂè∏Êú∫...');

            const url = `/api/drivers/nearby?latitude=${coords[0]}&longitude=${coords[1]}&radiusKm=5.0`;
            const result = await apiCall(url);

            if (result.success) {
                const drivers = result.data.data;
                showResult('driverResult', `‚úÖ 5ÂÖ¨ÈáåÂÜÖÊâæÂà∞ ${drivers.length} ‰∏™Âè∏Êú∫:`);
                drivers.forEach(driver => {
                    showResult('driverResult', `üöï Âè∏Êú∫ID: ${driver.id}, ‰ΩçÁΩÆ: (${driver.currentLatitude}, ${driver.currentLongitude})`);
                });
            } else {
                showResult('driverResult', `‚ùå Êü•ËØ¢Â§±Ë¥•: ${result.data?.message || result.error}`, true);
            }
        }

        // ==================== ËÆ¢ÂçïÁä∂ÊÄÅÂäüËÉΩ ====================

        async function getAllOrders() {
            showResult('orderResult', 'üîÑ Ê≠£Âú®Âà∑Êñ∞ËÆ¢ÂçïÁä∂ÊÄÅ...');

            const result = await apiCall('/api/orders');

            if (result.success) {
                const orders = result.data.data;
                showResult('orderResult', `‚úÖ ÊâæÂà∞ ${orders.length} ‰∏™ËÆ¢Âçï:`);

                orders.forEach(order => {
                    const statusClass = `status-${order.status.toLowerCase()}`;
                    showResult('orderResult',
                        `üìã ËÆ¢ÂçïID: ${order.id} | Áä∂ÊÄÅ: <span class="order-status ${statusClass}">${order.status}</span> | ` +
                        `‰πòÂÆ¢ID: ${order.passengerId} | Âè∏Êú∫ID: ${order.driverId || 'Êú™ÂàÜÈÖç'} | ` +
                        `${order.pickupAddress} ‚Üí ${order.destinationAddress}`
                    );
                });
            } else {
                showResult('orderResult', `‚ùå Êü•ËØ¢Â§±Ë¥•: ${result.data?.message || result.error}`, true);
            }
        }

        async function getOrderById() {
            const orderId = document.getElementById('queryOrderId').value;

            if (!orderId) {
                showResult('orderResult', '‚ùå ËØ∑ËæìÂÖ•ËÆ¢ÂçïID', true);
                return;
            }

            showResult('orderResult', `üîç Ê≠£Âú®Êü•ËØ¢ËÆ¢Âçï ${orderId}...`);

            const result = await apiCall(`/api/orders/${orderId}`);

            if (result.success) {
                const order = result.data.data;
                showResult('orderResult', `‚úÖ ËÆ¢ÂçïËØ¶ÊÉÖ:`);
                showResult('orderResult', `üìã ${JSON.stringify(order, null, 2)}`);

                // Ëá™Âä®Â°´ÂÖÖÂà∞Âè∏Êú∫Êìç‰ΩúÈù¢Êùø
                document.getElementById('orderIdForDriver').value = order.id;
            } else {
                showResult('orderResult', `‚ùå Êü•ËØ¢Â§±Ë¥•: ${result.data?.message || result.error}`, true);
            }
        }

        // ==================== È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÁöÑÂàùÂßãÂåñ ====================

        window.onload = function () {
            showResult('orderResult', 'üöó ÁΩëÁ∫¶ËΩ¶ËÆ¢ÂçïÊµãËØïÁ≥ªÁªüÂ∑≤ÂêØÂä®');
            showResult('orderResult', 'üí° ÊèêÁ§∫: ËØ∑ÂÖàËÆ©Âè∏Êú∫‰∏äÁ∫øÔºåÁÑ∂ÂêéÂàõÂª∫ËÆ¢ÂçïËøõË°åÊµãËØï');

            // Ëá™Âä®Âä†ËΩΩËÆ¢ÂçïÁä∂ÊÄÅ
            getAllOrders();
        };
    </script>
</body>

</html>