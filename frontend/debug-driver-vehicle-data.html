<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¸æœºè½¦è¾†æ•°æ®è°ƒè¯•</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/element-plus@2.4.4/dist/index.full.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/element-plus@2.4.4/dist/index.css">
    <style>
        body {
            font-family: 'Helvetica Neue', Helvetica, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
            margin: 0;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }
        .debug-banner {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 30px;
        }
        .debug-section {
            margin-bottom: 25px;
            padding: 20px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            background: #fafafa;
        }
        .debug-section.error {
            border-color: #ef4444;
            background: linear-gradient(135deg, #fef2f2 0%, #fef2f2 100%);
        }
        .debug-section.success {
            border-color: #10b981;
            background: linear-gradient(135deg, #ecfdf5 0%, #f0fdf4 100%);
        }
        .debug-section h3 {
            margin-top: 0;
            color: #1f2937;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .code-block {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            margin: 10px 0;
            overflow-x: auto;
            white-space: pre-wrap;
        }
        .websocket-data {
            background: #1f2937;
            color: #f9fafb;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            margin: 10px 0;
            overflow-x: auto;
            white-space: pre-wrap;
        }
        .problem-highlight {
            background: #fef2f2;
            border: 2px solid #fca5a5;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        .solution-highlight {
            background: #ecfdf5;
            border: 2px solid #6ee7b7;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="container">
            <div class="debug-banner">
                <h1 style="margin: 0; font-size: 28px;">ğŸ” å¸æœºè½¦è¾†æ•°æ®è°ƒè¯•</h1>
                <p style="margin: 10px 0 0 0; font-size: 16px;">è¯Šæ–­ä¸ºä»€ä¹ˆå¸æœºè½¦è¾†ä¿¡æ¯æ˜¾ç¤ºä¸ºé»˜è®¤å€¼</p>
            </div>
            
            <div class="debug-section error">
                <h3>
                    <span style="font-size: 24px;">âŒ</span>
                    é—®é¢˜åˆ†æ
                </h3>
                <p>ä»WebSocketæ¶ˆæ¯å¯ä»¥çœ‹å‡ºï¼Œåç«¯è¿”å›çš„å¸æœºè½¦è¾†ä¿¡æ¯éƒ½æ˜¯é»˜è®¤å€¼ï¼š</p>
                <div class="websocket-data">{{ receivedData }}</div>
                
                <div class="problem-highlight">
                    <h4 style="color: #dc2626; margin-top: 0;">ğŸš¨ å‘ç°çš„é—®é¢˜</h4>
                    <ul style="color: #7f1d1d;">
                        <li><strong>plateNumber:</strong> "æš‚æ— è½¦ç‰Œ" - åº”è¯¥æ˜¾ç¤ºçœŸå®è½¦ç‰Œå·</li>
                        <li><strong>vehicleBrand:</strong> "æœªçŸ¥" - åº”è¯¥æ˜¾ç¤ºè½¦è¾†å“ç‰Œ</li>
                        <li><strong>vehicleModel:</strong> "æœªçŸ¥" - åº”è¯¥æ˜¾ç¤ºè½¦è¾†å‹å·</li>
                        <li><strong>vehicleColor:</strong> "æœªçŸ¥" - åº”è¯¥æ˜¾ç¤ºè½¦è¾†é¢œè‰²</li>
                        <li><strong>vehicleInfo:</strong> "è½¦è¾†ä¿¡æ¯æš‚æ— " - åº”è¯¥æ˜¾ç¤ºå®Œæ•´ä¿¡æ¯</li>
                    </ul>
                </div>
            </div>

            <div class="debug-section">
                <h3>
                    <span style="font-size: 24px;">ğŸ”</span>
                    åŸå› åˆ†æ
                </h3>
                <p>è¿™ç§æƒ…å†µé€šå¸¸ç”±ä»¥ä¸‹åŸå› é€ æˆï¼š</p>
                <ol>
                    <li><strong>å¸æœºæ²¡æœ‰æ·»åŠ è½¦è¾†ï¼š</strong> å¸æœºIDä¸º1çš„å¸æœºå¯èƒ½æ²¡æœ‰åœ¨ç³»ç»Ÿä¸­æ·»åŠ ä»»ä½•è½¦è¾†</li>
                    <li><strong>æ²¡æœ‰æ¿€æ´»è½¦è¾†ï¼š</strong> å¸æœºæ·»åŠ äº†è½¦è¾†ä½†æ²¡æœ‰è®¾ç½®ä¸ºæ¿€æ´»çŠ¶æ€</li>
                    <li><strong>æ•°æ®åº“æŸ¥è¯¢å¤±è´¥ï¼š</strong> VehicleMapper.selectActiveByDriverId(1) è¿”å›null</li>
                    <li><strong>å¸æœºIDä¸åŒ¹é…ï¼š</strong> æ•°æ®åº“ä¸­çš„å¸æœºIDä¸ä¼ å…¥çš„IDä¸ä¸€è‡´</li>
                </ol>
            </div>

            <div class="debug-section">
                <h3>
                    <span style="font-size: 24px;">ğŸ§ª</span>
                    æ•°æ®æ£€æŸ¥
                </h3>
                <div style="margin-bottom: 15px;">
                    <el-button @click="checkDriverVehicles" :loading="checkLoading" type="primary">
                        æ£€æŸ¥å¸æœºè½¦è¾†æ•°æ®
                    </el-button>
                    <el-button @click="checkAllDrivers" :loading="allDriversLoading">
                        æ£€æŸ¥æ‰€æœ‰å¸æœº
                    </el-button>
                </div>
                
                <div v-if="driverVehicleData">
                    <h4>å¸æœºID=1çš„è½¦è¾†æ•°æ®ï¼š</h4>
                    <div class="code-block">{{ JSON.stringify(driverVehicleData, null, 2) }}</div>
                </div>
                
                <div v-if="allDriversData">
                    <h4>æ‰€æœ‰å¸æœºæ•°æ®ï¼š</h4>
                    <div class="code-block">{{ JSON.stringify(allDriversData, null, 2) }}</div>
                </div>
            </div>

            <div class="debug-section success">
                <h3>
                    <span style="font-size: 24px;">âœ…</span>
                    è§£å†³æ–¹æ¡ˆ
                </h3>
                <div class="solution-highlight">
                    <h4 style="color: #059669; margin-top: 0;">ğŸ”§ ä¿®å¤æ­¥éª¤</h4>
                    <ol style="color: #065f46;">
                        <li><strong>ç¡®ä¿å¸æœºå·²ç™»å½•ï¼š</strong> ä½¿ç”¨driver1/123456ç™»å½•å¸æœºç«¯</li>
                        <li><strong>æ·»åŠ è½¦è¾†ä¿¡æ¯ï¼š</strong> åœ¨å¸æœºç«¯æ·»åŠ è‡³å°‘ä¸€è¾†è½¦è¾†</li>
                        <li><strong>è®¾ç½®æ¿€æ´»è½¦è¾†ï¼š</strong> å°†æ·»åŠ çš„è½¦è¾†è®¾ç½®ä¸ºæ¿€æ´»çŠ¶æ€</li>
                        <li><strong>é‡æ–°æµ‹è¯•ï¼š</strong> åˆ›å»ºæ–°è®¢å•æµ‹è¯•å¸æœºä¿¡æ¯æ˜¾ç¤º</li>
                    </ol>
                </div>
                
                <div style="text-align: center; margin: 20px 0;">
                    <a href="http://localhost:3000/login" target="_blank" class="test-button">
                        ğŸ”‘ å¸æœºç™»å½•
                    </a>
                    <a href="http://localhost:3000/dashboard/vehicles" target="_blank" class="test-button primary">
                        ğŸš— æ·»åŠ è½¦è¾†
                    </a>
                    <a href="test-clean-vehicle-data.html" target="_blank" class="test-button">
                        ğŸ§¹ æ•°æ®ç®¡ç†å·¥å…·
                    </a>
                </div>
            </div>

            <div class="debug-section">
                <h3>
                    <span style="font-size: 24px;">ğŸ“‹</span>
                    åç«¯ä»£ç æ£€æŸ¥
                </h3>
                <p>WebSocketNotificationService.javaä¸­çš„é€»è¾‘ï¼š</p>
                <div class="code-block">
// è·å–å¸æœºçš„æ¿€æ´»è½¦è¾†ä¿¡æ¯
Vehicle activeVehicle = vehicleMapper.selectActiveByDriverId(driver.getId());
if (activeVehicle != null) {
    // è¿”å›çœŸå®è½¦è¾†ä¿¡æ¯
    driverInfo.put("plateNumber", activeVehicle.getPlateNumber());
    driverInfo.put("vehicleBrand", activeVehicle.getBrand());
    // ...
} else {
    // è¿”å›é»˜è®¤å€¼ - è¿™å°±æ˜¯å½“å‰çš„æƒ…å†µ
    driverInfo.put("plateNumber", "æš‚æ— è½¦ç‰Œ");
    driverInfo.put("vehicleBrand", "æœªçŸ¥");
    // ...
}
                </div>
                <p><strong>ç»“è®ºï¼š</strong> activeVehicle ä¸º nullï¼Œè¯´æ˜å¸æœºID=1æ²¡æœ‰æ¿€æ´»çš„è½¦è¾†ã€‚</p>
            </div>

            <div class="debug-section">
                <h3>
                    <span style="font-size: 24px;">ğŸ¯</span>
                    å¿«é€Ÿä¿®å¤
                </h3>
                <p>æœ€å¿«çš„è§£å†³æ–¹æ³•ï¼š</p>
                <ol>
                    <li>ä»¥å¸æœºèº«ä»½ç™»å½•ï¼ˆdriver1/123456ï¼‰</li>
                    <li>è¿›å…¥"æˆ‘çš„è½¦è¾†"é¡µé¢</li>
                    <li>æ·»åŠ ä¸€è¾†è½¦è¾†ï¼ˆå¡«å†™è½¦ç‰Œå·ã€å“ç‰Œã€å‹å·ç­‰ï¼‰</li>
                    <li>ç¡®ä¿è¯¥è½¦è¾†è¢«è®¾ç½®ä¸º"å½“å‰ä½¿ç”¨"</li>
                    <li>é‡æ–°åˆ›å»ºè®¢å•æµ‹è¯•</li>
                </ol>
                
                <div style="background: #fef3c7; padding: 15px; border-radius: 8px; margin: 15px 0;">
                    <p style="color: #92400e; margin: 0;">
                        <strong>ğŸ’¡ æç¤ºï¼š</strong> 
                        å¦‚æœå¸æœºå·²ç»æ·»åŠ äº†è½¦è¾†ä½†ä»æ˜¾ç¤ºé»˜è®¤å€¼ï¼Œå¯èƒ½æ˜¯æ•°æ®åº“ä¸­çš„is_activeå­—æ®µæ²¡æœ‰æ­£ç¡®è®¾ç½®ã€‚
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, reactive } = Vue;
        const { ElMessage } = ElementPlus;

        createApp({
            setup() {
                const checkLoading = ref(false);
                const allDriversLoading = ref(false);
                const driverVehicleData = ref(null);
                const allDriversData = ref(null);
                
                // æ¥æ”¶åˆ°çš„WebSocketæ•°æ®
                const receivedData = `{
  "driver": {
    "vehicleColor": "æœªçŸ¥",
    "latitude": 39.04170548630136,
    "rating": 5,
    "vehicleInfo": "è½¦è¾†ä¿¡æ¯æš‚æ— ",
    "avatar": null,
    "plateNumber": "æš‚æ— è½¦ç‰Œ",
    "vehicleBrand": "æœªçŸ¥",
    "phoneNumber": "13164586598",
    "vehicleYear": null,
    "driverId": 1,
    "phone": "13164586598",
    "vehicleSeats": 5,
    "name": "qyj",
    "vehicleModel": "æœªçŸ¥",
    "driverName": "qyj",
    "id": 1,
    "vehicleType": "ECONOMY",
    "carModel": "è½¦è¾†ä¿¡æ¯æš‚æ— ",
    "longitude": 121.79689317941666
  },
  "type": "ORDER_ASSIGNED",
  "order": {
    "orderNumber": "ORDER1754425579517b6ccab95",
    "destinationAddress": "å±±ä¸œå¤§å­¦(åœ°é“ç«™)",
    "pickupAddress": "ä½ç½® (39.041706, 121.796893)",
    "pickupLongitude": 121.796893,
    "estimatedFare": 3143,
    "id": 360,
    "destinationLatitude": 36.368994,
    "destinationLongitude": 120.678584,
    "pickupLatitude": 39.041706,
    "status": "ASSIGNED"
  },
  "timestamp": 1754425581373
}`;

                // æ£€æŸ¥å¸æœºè½¦è¾†æ•°æ®
                const checkDriverVehicles = async () => {
                    checkLoading.value = true;
                    try {
                        const token = localStorage.getItem('token');
                        if (!token) {
                            ElMessage.error('è¯·å…ˆç™»å½•');
                            return;
                        }

                        const response = await fetch('/api/vehicles/driver/1', {
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            }
                        });

                        const result = await response.json();
                        driverVehicleData.value = result;
                        
                        if (result.code === 200) {
                            if (result.data && result.data.length > 0) {
                                ElMessage.success(`æ‰¾åˆ°${result.data.length}è¾†è½¦è¾†`);
                            } else {
                                ElMessage.warning('å¸æœºæ²¡æœ‰æ·»åŠ ä»»ä½•è½¦è¾†');
                            }
                        } else {
                            ElMessage.error(result.message || 'æŸ¥è¯¢å¤±è´¥');
                        }
                    } catch (error) {
                        ElMessage.error('ç½‘ç»œé”™è¯¯: ' + error.message);
                        driverVehicleData.value = { error: error.message };
                    } finally {
                        checkLoading.value = false;
                    }
                };

                // æ£€æŸ¥æ‰€æœ‰å¸æœº
                const checkAllDrivers = async () => {
                    allDriversLoading.value = true;
                    try {
                        const token = localStorage.getItem('token');
                        if (!token) {
                            ElMessage.error('è¯·å…ˆç™»å½•');
                            return;
                        }

                        const response = await fetch('/api/drivers', {
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            }
                        });

                        const result = await response.json();
                        allDriversData.value = result;
                        
                        if (result.code === 200) {
                            ElMessage.success(`æ‰¾åˆ°${result.data?.length || 0}ä¸ªå¸æœº`);
                        } else {
                            ElMessage.error(result.message || 'æŸ¥è¯¢å¤±è´¥');
                        }
                    } catch (error) {
                        ElMessage.error('ç½‘ç»œé”™è¯¯: ' + error.message);
                        allDriversData.value = { error: error.message };
                    } finally {
                        allDriversLoading.value = false;
                    }
                };

                return {
                    checkLoading,
                    allDriversLoading,
                    driverVehicleData,
                    allDriversData,
                    receivedData,
                    checkDriverVehicles,
                    checkAllDrivers
                };
            }
        }).use(ElementPlus).mount('#app');
    </script>
    
    <style>
        .test-button {
            display: inline-block;
            padding: 12px 24px;
            background: #3b82f6;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            margin: 8px;
            transition: all 0.3s ease;
            font-weight: 500;
            border: none;
            cursor: pointer;
        }
        .test-button:hover {
            background: #2563eb;
            transform: translateY(-1px);
        }
        .test-button.primary {
            background: #10b981;
        }
        .test-button.primary:hover {
            background: #059669;
        }
    </style>
</body>
</html>