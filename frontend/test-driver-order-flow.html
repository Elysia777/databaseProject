<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¸æœºè®¢å•æµç¨‹æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #333;
        }
        button {
            background: #409EFF;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #66b1ff;
        }
        button.success {
            background: #67c23a;
        }
        button.danger {
            background: #f56c6c;
        }
        .status-display {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 14px;
            white-space: pre-wrap;
        }
        .status-good {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .status-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .flow-step {
            background: #e3f2fd;
            padding: 10px;
            margin: 5px 0;
            border-left: 4px solid #2196f3;
            border-radius: 3px;
        }
        .flow-step.success {
            background: #e8f5e8;
            border-left-color: #4caf50;
        }
        .flow-step.error {
            background: #ffebee;
            border-left-color: #f44336;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš— å¸æœºè®¢å•æµç¨‹æµ‹è¯•</h1>
        <p>æµ‹è¯•å¸æœºæ¥æ”¶è®¢å•é€šçŸ¥çš„å®Œæ•´æµç¨‹</p>
    </div>

    <div class="container">
        <div class="test-section">
            <h3>1. é—®é¢˜åˆ†æ</h3>
            <div class="status-display">
å¸æœºæ— æ³•æ”¶åˆ°è®¢å•çš„å¯èƒ½åŸå› :

1. å¸æœºæ²¡æœ‰æ­£ç¡®ä¸Šçº¿
   - å‰ç«¯æ˜¾ç¤ºä¸Šçº¿ï¼Œä½†åç«¯RedisçŠ¶æ€æœªæ›´æ–°
   - å¸æœºä½ç½®ä¿¡æ¯ç¼ºå¤±

2. WebSocketè¿æ¥é—®é¢˜
   - è¿æ¥æœªå»ºç«‹æˆ–è¿æ¥æ–­å¼€
   - è®¢é˜…è·¯å¾„ä¸åŒ¹é…
   - æ¶ˆæ¯å¤„ç†å‡½æ•°æœªæ³¨å†Œ

3. åç«¯æ£€æŸ¥å¤±è´¥
   - isDriverOnlineAndFree() è¿”å›false
   - å¸æœºçŠ¶æ€ä¸ºbusyæˆ–offline

4. é€€å‡ºç™»å½•é—®é¢˜
   - å¸æœºé€€å‡ºæ—¶æ²¡æœ‰è‡ªåŠ¨ä¸‹çº¿
   - çŠ¶æ€æ®‹ç•™å¯¼è‡´é—®é¢˜
            </div>
        </div>

        <div class="test-section">
            <h3>2. å®Œæ•´æµç¨‹æµ‹è¯•</h3>
            <button onclick="testCompleteFlow()">æµ‹è¯•å®Œæ•´æµç¨‹</button>
            
            <div id="flowResult" class="status-display">
                ç‚¹å‡»æŒ‰é’®å¼€å§‹æµ‹è¯•å®Œæ•´æµç¨‹...
            </div>
        </div>

        <div class="test-section">
            <h3>3. å¸æœºçŠ¶æ€æ£€æŸ¥</h3>
            <button onclick="checkDriverOnlineStatus()">æ£€æŸ¥å¸æœºåœ¨çº¿çŠ¶æ€</button>
            <button onclick="forceDriverOnline()" class="success">å¼ºåˆ¶å¸æœºä¸Šçº¿</button>
            
            <div id="driverStatusResult" class="status-display">
                ç‚¹å‡»æŒ‰é’®æ£€æŸ¥å¸æœºçŠ¶æ€...
            </div>
        </div>

        <div class="test-section">
            <h3>4. WebSocketè¿æ¥æµ‹è¯•</h3>
            <button onclick="testWebSocketConnection()">æµ‹è¯•WebSocketè¿æ¥</button>
            <button onclick="reconnectWebSocket()">é‡æ–°è¿æ¥WebSocket</button>
            
            <div id="websocketResult" class="status-display">
                ç‚¹å‡»æŒ‰é’®æµ‹è¯•WebSocketè¿æ¥...
            </div>
        </div>

        <div class="test-section">
            <h3>5. ä¿®å¤å»ºè®®</h3>
            <div class="status-display status-good">
ä¿®å¤æ­¥éª¤:

1. ç¡®ä¿å¸æœºæ­£ç¡®ä¸Šçº¿
   - æ£€æŸ¥å‰ç«¯isOnlineçŠ¶æ€
   - éªŒè¯åç«¯RedisçŠ¶æ€
   - ç¡®è®¤ä½ç½®ä¿¡æ¯æ­£ç¡®

2. éªŒè¯WebSocketè¿æ¥
   - æ£€æŸ¥è¿æ¥çŠ¶æ€
   - éªŒè¯è®¢é˜…è·¯å¾„
   - ç¡®è®¤æ¶ˆæ¯å¤„ç†å‡½æ•°

3. æµ‹è¯•æ¶ˆæ¯æ¥æ”¶
   - æ¨¡æ‹Ÿè®¢å•æ¨é€
   - æ£€æŸ¥æ¶ˆæ¯å¤„ç†
   - éªŒè¯UIæ›´æ–°

4. ä¿®å¤é€€å‡ºç™»å½•
   - æ·»åŠ è‡ªåŠ¨ä¸‹çº¿é€»è¾‘
   - æ¸…ç†çŠ¶æ€æ•°æ®
   - æ–­å¼€WebSocketè¿æ¥
            </div>
        </div>
    </div>

    <div class="container">
        <h3>ğŸ“‹ è°ƒè¯•å‘½ä»¤</h3>
        <div class="status-display">
// æ£€æŸ¥å¸æœºçŠ¶æ€
console.log("å¸æœºåœ¨çº¿:", window.driverStore?.isOnline);
console.log("ç”¨æˆ·ä¿¡æ¯:", window.userStore?.user);
console.log("å¸æœºID:", window.userStore?.user?.driverId);

// æ£€æŸ¥WebSocketè¿æ¥
console.log("æ¶ˆæ¯å¤„ç†å‡½æ•°:", typeof window.handleDriverMapUpdate);

// æ‰‹åŠ¨ä¸Šçº¿å¸æœº
if (window.driverStore) {
    window.driverStore.setOnlineStatus(true);
    window.driverStore.connectWebSocket();
}

// æµ‹è¯•æ¶ˆæ¯æ¥æ”¶
if (window.handleDriverMapUpdate) {
    window.handleDriverMapUpdate({
        type: 'NEW_ORDER',
        orderId: '12345',
        orderNumber: 'TEST001',
        pickupAddress: 'æµ‹è¯•åœ°å€',
        destinationAddress: 'æµ‹è¯•ç›®çš„åœ°'
    });
}
        </div>
        <button onclick="copyToClipboard(this.previousElementSibling.textContent)">å¤åˆ¶è°ƒè¯•å‘½ä»¤</button>
    </div>

    <div class="container">
        <h3>ğŸ“‹ æµ‹è¯•æ—¥å¿—</h3>
        <div id="testLog" style="background: #f8f9fa; padding: 15px; border-radius: 5px; font-family: monospace; font-size: 12px; max-height: 400px; overflow-y: auto;"></div>
    </div>

    <script>
        function log(message, type = 'info') {
            const logDiv = document.getElementById('testLog');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}\\n`;
            logDiv.textContent += logEntry;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(logEntry);
        }

        function testCompleteFlow() {
            const resultDiv = document.getElementById('flowResult');
            let content = '';

            const flowSteps = [
                {
                    step: '1. å¸æœºç™»å½•',
                    check: () => window.userStore && window.userStore.user && window.userStore.isDriver,
                    status: 'unknown'
                },
                {
                    step: '2. å¸æœºä¸Šçº¿',
                    check: () => window.driverStore && window.driverStore.isOnline,
                    status: 'unknown'
                },
                {
                    step: '3. WebSocketè¿æ¥',
                    check: () => typeof window.handleDriverMapUpdate === 'function',
                    status: 'unknown'
                },
                {
                    step: '4. RedisçŠ¶æ€åŒæ­¥',
                    check: () => true, // éœ€è¦åç«¯éªŒè¯
                    status: 'unknown'
                },
                {
                    step: '5. è®¢å•æ¨é€æ¥æ”¶',
                    check: () => window.driverStore && window.driverStore.pendingOrders.length >= 0,
                    status: 'unknown'
                }
            ];

            flowSteps.forEach(step => {
                try {
                    const passed = step.check();
                    step.status = passed ? 'success' : 'error';
                } catch (error) {
                    step.status = 'error';
                }

                const stepClass = step.status === 'success' ? 'flow-step success' : 'flow-step error';
                const statusIcon = step.status === 'success' ? 'âœ…' : 'âŒ';
                
                content += `<div class="${stepClass}">
                    ${statusIcon} ${step.step}
                </div>`;
            });

            const allPassed = flowSteps.every(step => step.status === 'success');
            
            content += `<div class="flow-step ${allPassed ? 'success' : 'error'}">
                ${allPassed ? 'âœ…' : 'âŒ'} æ€»ä½“çŠ¶æ€: ${allPassed ? 'æµç¨‹æ­£å¸¸' : 'å­˜åœ¨é—®é¢˜'}
            </div>`;

            resultDiv.innerHTML = content;
            log(`å®Œæ•´æµç¨‹æµ‹è¯•å®Œæˆ: ${allPassed ? 'é€šè¿‡' : 'å¤±è´¥'}`);
        }

        function checkDriverOnlineStatus() {
            const resultDiv = document.getElementById('driverStatusResult');
            let status = 'å¸æœºåœ¨çº¿çŠ¶æ€æ£€æŸ¥:\\n\\n';

            try {
                if (window.driverStore) {
                    status += `å‰ç«¯çŠ¶æ€:\\n`;
                    status += `- åœ¨çº¿çŠ¶æ€: ${window.driverStore.isOnline ? 'âœ… åœ¨çº¿' : 'âŒ ç¦»çº¿'}\\n`;
                    status += `- å½“å‰ä½ç½®: ${JSON.stringify(window.driverStore.currentPosition)}\\n`;
                    
                    if (window.userStore && window.userStore.user) {
                        status += `\\nç”¨æˆ·ä¿¡æ¯:\\n`;
                        status += `- å¸æœºID: ${window.userStore.user.driverId || window.userStore.user.id}\\n`;
                        status += `- ç”¨æˆ·ç±»å‹: ${window.userStore.user.userType}\\n`;
                    }
                    
                    status += `\\nå»ºè®®æ£€æŸ¥:\\n`;
                    status += `1. åç«¯Redisä¸­çš„å¸æœºçŠ¶æ€\\n`;
                    status += `2. å¸æœºä½ç½®ä¿¡æ¯æ˜¯å¦æ­£ç¡®\\n`;
                    status += `3. isDriverOnlineAndFree()æ–¹æ³•è¿”å›å€¼\\n`;
                } else {
                    status += 'âŒ driverStoreæœªåˆå§‹åŒ–';
                }
            } catch (error) {
                status += `âŒ æ£€æŸ¥å¤±è´¥: ${error.message}`;
            }

            resultDiv.textContent = status;
            resultDiv.className = window.driverStore?.isOnline ? 'status-display status-good' : 'status-display status-error';
            log('å¸æœºåœ¨çº¿çŠ¶æ€æ£€æŸ¥å®Œæˆ');
        }

        function forceDriverOnline() {
            try {
                if (window.driverStore) {
                    window.driverStore.setOnlineStatus(true);
                    log('âœ… å·²å¼ºåˆ¶è®¾ç½®å¸æœºä¸ºåœ¨çº¿çŠ¶æ€');
                    
                    // åŒæ—¶å»ºç«‹WebSocketè¿æ¥
                    window.driverStore.connectWebSocket();
                    log('âœ… å·²é‡æ–°å»ºç«‹WebSocketè¿æ¥');
                    
                    checkDriverOnlineStatus();
                } else {
                    log('âŒ driverStoreæœªæ‰¾åˆ°');
                }
            } catch (error) {
                log(`âŒ å¼ºåˆ¶ä¸Šçº¿å¤±è´¥: ${error.message}`);
            }
        }

        function testWebSocketConnection() {
            const resultDiv = document.getElementById('websocketResult');
            let status = 'WebSocketè¿æ¥æµ‹è¯•:\\n\\n';

            try {
                status += `è¿æ¥çŠ¶æ€æ£€æŸ¥:\\n`;
                status += `- æ¶ˆæ¯å¤„ç†å‡½æ•°: ${typeof window.handleDriverMapUpdate === 'function' ? 'âœ… å·²æ³¨å†Œ' : 'âŒ æœªæ³¨å†Œ'}\\n`;
                
                if (window.driverStore && window.userStore) {
                    const driverId = window.userStore.user?.driverId || window.userStore.user?.id;
                    status += `- å¸æœºID: ${driverId}\\n`;
                    status += `- è®¢é˜…è·¯å¾„: /user/${driverId}/queue/orders\\n`;
                    status += `- å¸æœºåœ¨çº¿: ${window.driverStore.isOnline ? 'âœ… æ˜¯' : 'âŒ å¦'}\\n`;
                }
                
                // æµ‹è¯•æ¶ˆæ¯å¤„ç†
                if (window.handleDriverMapUpdate) {
                    status += `\\næµ‹è¯•æ¶ˆæ¯å¤„ç†:\\n`;
                    try {
                        window.handleDriverMapUpdate({
                            type: 'NEW_ORDER',
                            orderId: '12345',
                            orderNumber: 'TEST001',
                            pickupAddress: 'æµ‹è¯•ä¸Šè½¦ç‚¹',
                            destinationAddress: 'æµ‹è¯•ç›®çš„åœ°',
                            distance: '2.5',
                            estimatedFare: '25.00'
                        });
                        status += `- æ¶ˆæ¯å¤„ç†: âœ… æˆåŠŸ\\n`;
                    } catch (error) {
                        status += `- æ¶ˆæ¯å¤„ç†: âŒ å¤±è´¥ - ${error.message}\\n`;
                    }
                }
                
                status += `\\nå»ºè®®æ“ä½œ:\\n`;
                status += `1. ç¡®ä¿å¸æœºå·²ä¸Šçº¿\\n`;
                status += `2. æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°çš„WebSocketæ—¥å¿—\\n`;
                status += `3. éªŒè¯åç«¯æ˜¯å¦å‘é€æ¶ˆæ¯\\n`;
            } catch (error) {
                status += `âŒ æµ‹è¯•å¤±è´¥: ${error.message}`;
            }

            resultDiv.textContent = status;
            log('WebSocketè¿æ¥æµ‹è¯•å®Œæˆ');
        }

        function reconnectWebSocket() {
            try {
                if (window.driverStore) {
                    window.driverStore.disconnectWebSocket();
                    log('ğŸ”Œ å·²æ–­å¼€WebSocketè¿æ¥');
                    
                    setTimeout(() => {
                        window.driverStore.connectWebSocket();
                        log('ğŸ”Œ å·²é‡æ–°å»ºç«‹WebSocketè¿æ¥');
                        testWebSocketConnection();
                    }, 1000);
                } else {
                    log('âŒ driverStoreæœªæ‰¾åˆ°');
                }
            } catch (error) {
                log(`âŒ é‡è¿å¤±è´¥: ${error.message}`);
            }
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('è°ƒè¯•å‘½ä»¤å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
            }).catch(err => {
                console.error('å¤åˆ¶å¤±è´¥:', err);
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('è°ƒè¯•å‘½ä»¤å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
            });
        }

        // é¡µé¢åŠ è½½æ—¶çš„åˆå§‹åŒ–
        window.onload = function() {
            log('å¸æœºè®¢å•æµç¨‹æµ‹è¯•å·¥å…·å·²åŠ è½½');
            
            log('æµ‹è¯•ç›®æ ‡:');
            log('1. éªŒè¯å¸æœºä¸Šçº¿çŠ¶æ€');
            log('2. æ£€æŸ¥WebSocketè¿æ¥');
            log('3. æµ‹è¯•è®¢å•æ¶ˆæ¯æ¥æ”¶');
            log('4. ç¡®è®¤é€€å‡ºç™»å½•è‡ªåŠ¨ä¸‹çº¿');
        };
    </script>
</body>
</html>"