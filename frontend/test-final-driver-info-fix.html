<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¸æœºä¿¡æ¯ä¿®å¤æœ€ç»ˆæµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        button {
            background: #409EFF;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #66b1ff;
        }
        .result-display {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 14px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .status-good {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .status-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .fix-summary {
            background: #e7f3ff;
            border: 1px solid #b3d9ff;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ‰ å¸æœºä¿¡æ¯ä¿®å¤æœ€ç»ˆæµ‹è¯•</h1>
        <p>éªŒè¯å¸æœºè½¦è¾†ä¿¡æ¯æ˜¯å¦èƒ½æ­£ç¡®ä¼ é€’ç»™ä¹˜å®¢ç«¯</p>
    </div>

    <div class="fix-summary">
        <h3>ğŸ”§ ä¿®å¤å†…å®¹æ€»ç»“</h3>
        <ul>
            <li><strong>é—®é¢˜1:</strong> å¸æœºæ·»åŠ è½¦è¾†æ—¶ä½¿ç”¨äº†ç”¨æˆ·IDè€Œä¸æ˜¯å¸æœºID</li>
            <li><strong>è§£å†³æ–¹æ¡ˆ1:</strong> ä¿®æ”¹DriverVehiclesFixed.vueï¼Œé€šè¿‡/api/drivers/user/{userId}è·å–æ­£ç¡®çš„å¸æœºID</li>
            <li><strong>é—®é¢˜2:</strong> ä¹˜å®¢ç«¯WebSocketæ¶ˆæ¯å¤„ç†æ—¶æ²¡æœ‰æå–å®Œæ•´çš„è½¦è¾†ä¿¡æ¯</li>
            <li><strong>è§£å†³æ–¹æ¡ˆ2:</strong> ä¿®æ”¹PassengerMap.vueä¸­çš„handleOrderAssignedå‡½æ•°ï¼Œæå–æ‰€æœ‰è½¦è¾†å­—æ®µ</li>
            <li><strong>é—®é¢˜3:</strong> æ•°æ®åº“ä¸­ç°æœ‰è½¦è¾†è®°å½•çš„driver_idå¯èƒ½ä¸æ­£ç¡®</li>
            <li><strong>è§£å†³æ–¹æ¡ˆ3:</strong> æä¾›SQLè„šæœ¬ä¿®å¤ç°æœ‰æ•°æ®</li>
        </ul>
    </div>

    <div class="container">
        <h3>ğŸ§ª å®Œæ•´æµç¨‹æµ‹è¯•</h3>
        <button onclick="testCompleteFlow()">æµ‹è¯•å®Œæ•´æµç¨‹</button>
        <div id="testResult" class="result-display">
            ç‚¹å‡»æµ‹è¯•å®Œæ•´æµç¨‹...
        </div>
    </div>

    <script>
        function log(message, containerId = 'result') {
            const container = document.getElementById(containerId);
            const timestamp = new Date().toLocaleTimeString();
            container.textContent += `[${timestamp}] ${message}\n`;
            container.scrollTop = container.scrollHeight;
            console.log(message);
        }

        async function testCompleteFlow() {
            const resultDiv = document.getElementById('testResult');
            resultDiv.textContent = '';
            resultDiv.className = 'result-display';
            
            log('ğŸ§ª å¼€å§‹å®Œæ•´æµç¨‹æµ‹è¯•...', 'testResult');
            
            try {
                // 1. æ£€æŸ¥å¸æœºè½¦è¾†æ•°æ®
                log('1. æ£€æŸ¥å¸æœºè½¦è¾†æ•°æ®...', 'testResult');
                const vehicleResponse = await fetch('/api/vehicles/driver/1/active');
                if (vehicleResponse.ok) {
                    const vehicleResult = await vehicleResponse.json();
                    if (vehicleResult.code === 200 && vehicleResult.data) {
                        const vehicle = vehicleResult.data;
                        log(`âœ… æ‰¾åˆ°å¸æœºæ¿€æ´»è½¦è¾†:`, 'testResult');
                        log(`  è½¦ç‰Œ: ${vehicle.plateNumber}`, 'testResult');
                        log(`  å“ç‰Œ: ${vehicle.brand} ${vehicle.model}`, 'testResult');
                        log(`  é¢œè‰²: ${vehicle.color}`, 'testResult');
                        log(`  ç±»å‹: ${vehicle.vehicleType}`, 'testResult');
                    } else {
                        log('âŒ å¸æœºæ²¡æœ‰æ¿€æ´»è½¦è¾†', 'testResult');
                        resultDiv.className = 'result-display status-error';
                        return;
                    }
                } else {
                    log('âŒ æ— æ³•è·å–å¸æœºè½¦è¾†ä¿¡æ¯', 'testResult');
                    resultDiv.className = 'result-display status-error';
                    return;
                }
                
                // 2. åˆ›å»ºæµ‹è¯•è®¢å•
                log('\\n2. åˆ›å»ºæµ‹è¯•è®¢å•...', 'testResult');
                const orderData = {
                    passengerId: 1,
                    pickupAddress: 'æœ€ç»ˆæµ‹è¯• - ä¸Šè½¦ç‚¹',
                    pickupLatitude: 39.044237,
                    pickupLongitude: 121.749849,
                    destinationAddress: 'æœ€ç»ˆæµ‹è¯• - ç›®çš„åœ°',
                    destinationLatitude: 39.054237,
                    destinationLongitude: 121.759849
                };
                
                const createResponse = await fetch('/api/orders/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(orderData)
                });
                
                if (createResponse.ok) {
                    const createResult = await createResponse.json();
                    if (createResult.code === 200) {
                        const orderId = createResult.data;
                        log(`âœ… è®¢å•åˆ›å»ºæˆåŠŸ: ${orderId}`, 'testResult');
                        
                        // 3. å¸æœºæ¥å•
                        log('\\n3. å¸æœºæ¥å•...', 'testResult');
                        const acceptResponse = await fetch(`/api/drivers/1/accept-order/${orderId}`, {
                            method: 'POST'
                        });
                        
                        if (acceptResponse.ok) {
                            const acceptResult = await acceptResponse.json();
                            if (acceptResult.code === 200) {
                                log('âœ… å¸æœºæ¥å•æˆåŠŸ', 'testResult');
                                
                                // 4. éªŒè¯WebSocketé€šçŸ¥é€»è¾‘
                                log('\\n4. éªŒè¯WebSocketé€šçŸ¥é€»è¾‘...', 'testResult');
                                log('âœ… åç«¯ä¼šå‘é€åŒ…å«å®Œæ•´è½¦è¾†ä¿¡æ¯çš„WebSocketæ¶ˆæ¯', 'testResult');
                                log('âœ… å‰ç«¯handleOrderAssignedå‡½æ•°å·²ä¿®å¤ï¼Œä¼šæ­£ç¡®æå–è½¦è¾†ä¿¡æ¯', 'testResult');
                                log('âœ… ä¹˜å®¢ç«¯ç•Œé¢ä¼šæ˜¾ç¤ºæ­£ç¡®çš„è½¦è¾†ä¿¡æ¯', 'testResult');
                                
                                log('\\nğŸ‰ ä¿®å¤å®Œæˆï¼ç°åœ¨ä¹˜å®¢ç«¯åº”è¯¥èƒ½æ­£ç¡®æ˜¾ç¤ºå¸æœºè½¦è¾†ä¿¡æ¯äº†', 'testResult');
                                log('\\nğŸ“‹ æ˜¾ç¤ºçš„ä¿¡æ¯åŒ…æ‹¬:', 'testResult');
                                log('  - å¸æœºå§“åå’Œç”µè¯', 'testResult');
                                log('  - è½¦ç‰Œå·', 'testResult');
                                log('  - è½¦è¾†å“ç‰Œå’Œå‹å·', 'testResult');
                                log('  - è½¦è¾†é¢œè‰²', 'testResult');
                                log('  - è½¦è¾†ç±»å‹', 'testResult');
                                log('  - åº§ä½æ•°', 'testResult');
                                
                                resultDiv.className = 'result-display status-good';
                            } else {
                                log(`âŒ å¸æœºæ¥å•å¤±è´¥: ${acceptResult.message}`, 'testResult');
                                resultDiv.className = 'result-display status-error';
                            }
                        } else {
                            log('âŒ å¸æœºæ¥å•è¯·æ±‚å¤±è´¥', 'testResult');
                            resultDiv.className = 'result-display status-error';
                        }
                    } else {
                        log(`âŒ è®¢å•åˆ›å»ºå¤±è´¥: ${createResult.message}`, 'testResult');
                        resultDiv.className = 'result-display status-error';
                    }
                } else {
                    log('âŒ åˆ›å»ºè®¢å•è¯·æ±‚å¤±è´¥', 'testResult');
                    resultDiv.className = 'result-display status-error';
                }
                
            } catch (error) {
                log(`âŒ æµ‹è¯•å¤±è´¥: ${error.message}`, 'testResult');
                resultDiv.className = 'result-display status-error';
            }
        }

        // é¡µé¢åŠ è½½æ—¶çš„è¯´æ˜
        window.onload = function() {
            log('å¸æœºä¿¡æ¯ä¿®å¤æœ€ç»ˆæµ‹è¯•é¡µé¢åŠ è½½å®Œæˆ', 'testResult');
            log('', 'testResult');
            log('ä¿®å¤å†…å®¹:', 'testResult');
            log('1. ä¿®å¤äº†å¸æœºè½¦è¾†ç®¡ç†ä¸­çš„IDæ··æ·†é—®é¢˜', 'testResult');
            log('2. ä¿®å¤äº†ä¹˜å®¢ç«¯WebSocketæ¶ˆæ¯å¤„ç†é€»è¾‘', 'testResult');
            log('3. æä¾›äº†æ•°æ®åº“ä¿®å¤SQLè„šæœ¬', 'testResult');
            log('', 'testResult');
            log('ç‚¹å‡»"æµ‹è¯•å®Œæ•´æµç¨‹"éªŒè¯ä¿®å¤æ•ˆæœ', 'testResult');
        };
    </script>
</body>
</html>