<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ”¯ä»˜çŠ¶æ€ä¿®å¤éªŒè¯æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-section {
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            background: #fafafa;
        }
        .test-section h3 {
            margin-top: 0;
            color: #333;
        }
        .result {
            background: #e8f5e8;
            border: 1px solid #4caf50;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
        }
        .error {
            background: #ffebee;
            border: 1px solid #f44336;
            color: #c62828;
        }
        .warning {
            background: #fff3e0;
            border: 1px solid #ff9800;
            color: #e65100;
        }
        .success {
            background: #e8f5e8;
            border: 1px solid #4caf50;
            color: #2e7d32;
        }
        .btn {
            background: #2196f3;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover {
            background: #1976d2;
        }
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .code-block {
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            font-family: monospace;
            white-space: pre-wrap;
            margin: 10px 0;
        }
        .order-flow {
            display: flex;
            justify-content: space-between;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        .flow-step {
            background: white;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin: 10px;
            text-align: center;
            min-width: 150px;
            flex: 1;
        }
        .flow-step.active {
            border-color: #2196f3;
            background: #e3f2fd;
        }
        .flow-step.completed {
            border-color: #4caf50;
            background: #e8f5e8;
        }
        .flow-arrow {
            font-size: 24px;
            color: #666;
            margin: 20px 10px;
        }
    </style>
</head>
<body>
    <h1>ğŸ”§ æ”¯ä»˜çŠ¶æ€ä¿®å¤éªŒè¯æµ‹è¯•</h1>
    
    <div class="container">
        <h2>é—®é¢˜æè¿°</h2>
        <p>è®¢å•å®Œæˆåæ²¡æœ‰å°† <code>payment_status</code> å±æ€§å†™å…¥æ•°æ®åº“ï¼Œå¯¼è‡´æ–°å®Œæˆçš„è®¢å•éƒ½æ²¡æœ‰ <code>UNPAID</code> å±æ€§ã€‚</p>
        
        <h3>æ ¹æœ¬åŸå› </h3>
        <ul>
            <li><strong>è®¢å•åˆ›å»ºæ—¶</strong>ï¼šæ²¡æœ‰æ˜ç¡®è®¾ç½® <code>paymentStatus</code> å­—æ®µ</li>
            <li><strong>è®¢å•å®Œæˆæ—¶</strong>ï¼šæ²¡æœ‰ç¡®ä¿æ”¯ä»˜çŠ¶æ€ä¸º <code>UNPAID</code></li>
            <li><strong>æ•°æ®åº“é»˜è®¤å€¼</strong>ï¼šè™½ç„¶æœ‰é»˜è®¤å€¼ï¼Œä½†ä»£ç ä¸­åº”è¯¥æ˜ç¡®è®¾ç½®</li>
        </ul>
        
        <h3>ä¿®å¤å†…å®¹</h3>
        <div class="code-block">// 1. è®¢å•åˆ›å»ºæ—¶æ˜ç¡®è®¾ç½®æ”¯ä»˜çŠ¶æ€
order.setPaymentStatus("UNPAID"); // æ˜ç¡®è®¾ç½®æ”¯ä»˜çŠ¶æ€ä¸ºæœªæ”¯ä»˜

// 2. è®¢å•å®Œæˆæ—¶ç¡®ä¿æ”¯ä»˜çŠ¶æ€æ­£ç¡®
if (order.getPaymentStatus() == null || !"UNPAID".equals(order.getPaymentStatus())) {
    order.setPaymentStatus("UNPAID");
}</div>
    </div>

    <div class="container">
        <h2>ğŸ”„ è®¢å•æµç¨‹éªŒè¯</h2>
        
        <div class="order-flow">
            <div class="flow-step" id="step1">
                <h4>1. åˆ›å»ºè®¢å•</h4>
                <p>paymentStatus: <span id="status1">?</span></p>
                <button class="btn" onclick="createOrder()">åˆ›å»ºè®¢å•</button>
            </div>
            
            <div class="flow-arrow">â†’</div>
            
            <div class="flow-step" id="step2">
                <h4>2. å¸æœºæ¥å•</h4>
                <p>status: <span id="status2">?</span></p>
                <button class="btn" onclick="acceptOrder()" disabled>å¸æœºæ¥å•</button>
            </div>
            
            <div class="flow-arrow">â†’</div>
            
            <div class="flow-step" id="step3">
                <h4>3. å¼€å§‹è¡Œç¨‹</h4>
                <p>status: <span id="status3">?</span></p>
                <button class="btn" onclick="startTrip()" disabled>å¼€å§‹è¡Œç¨‹</button>
            </div>
            
            <div class="flow-arrow">â†’</div>
            
            <div class="flow-step" id="step4">
                <h4>4. å®Œæˆè®¢å•</h4>
                <p>status: <span id="status4">?</span><br>
                paymentStatus: <span id="payment4">?</span></p>
                <button class="btn" onclick="completeOrder()" disabled>å®Œæˆè®¢å•</button>
            </div>
        </div>
        
        <div id="orderResult" class="result" style="display: none;"></div>
    </div>

    <div class="container">
        <h2>ğŸ§ª æµ‹è¯•éªŒè¯</h2>
        
        <div class="test-section">
            <h3>æµ‹è¯•1: æ”¯ä»˜çŠ¶æ€æ£€æŸ¥</h3>
            <p>éªŒè¯è®¢å•åœ¨ä¸åŒé˜¶æ®µçš„æ”¯ä»˜çŠ¶æ€æ˜¯å¦æ­£ç¡®è®¾ç½®</p>
            
            <button class="btn" onclick="checkPaymentStatus()">æ£€æŸ¥æ”¯ä»˜çŠ¶æ€</button>
            <button class="btn" onclick="resetTest()">é‡ç½®æµ‹è¯•</button>
            
            <div id="testResult1" class="result" style="display: none;"></div>
        </div>
        
        <div class="test-section">
            <h3>æµ‹è¯•2: æœªæ”¯ä»˜è®¢å•éªŒè¯</h3>
            <p>éªŒè¯å®Œæˆçš„è®¢å•æ˜¯å¦è¢«æ­£ç¡®è¯†åˆ«ä¸ºæœªæ”¯ä»˜è®¢å•</p>
            
            <button class="btn" onclick="testUnpaidOrderDetection()">æµ‹è¯•æœªæ”¯ä»˜è®¢å•è¯†åˆ«</button>
            
            <div id="testResult2" class="result" style="display: none;"></div>
        </div>
        
        <div class="test-section">
            <h3>æµ‹è¯•3: æ–°è®¢å•åˆ›å»ºéªŒè¯</h3>
            <p>éªŒè¯æœ‰æœªæ”¯ä»˜è®¢å•æ—¶æ˜¯å¦é˜»æ­¢æ–°è®¢å•åˆ›å»º</p>
            
            <button class="btn" onclick="testNewOrderCreation()">æµ‹è¯•æ–°è®¢å•åˆ›å»º</button>
            
            <div id="testResult2" class="result" style="display: none;"></div>
        </div>
    </div>

    <div class="container">
        <h2>ğŸ“‹ æµ‹è¯•æ­¥éª¤</h2>
        <ol>
            <li>ç‚¹å‡»"åˆ›å»ºè®¢å•"å¼€å§‹æµ‹è¯•æµç¨‹</li>
            <li>æŒ‰é¡ºåºæ‰§è¡Œæ¯ä¸ªæ­¥éª¤ï¼Œè§‚å¯ŸçŠ¶æ€å˜åŒ–</li>
            <li>éªŒè¯è®¢å•å®Œæˆåçš„æ”¯ä»˜çŠ¶æ€æ˜¯å¦ä¸º UNPAID</li>
            <li>æµ‹è¯•æœªæ”¯ä»˜è®¢å•è¯†åˆ«é€»è¾‘</li>
            <li>éªŒè¯æ–°è®¢å•åˆ›å»ºæ˜¯å¦è¢«æ­£ç¡®é˜»æ­¢</li>
        </ol>
    </div>

    <script>
        // æ¨¡æ‹Ÿè®¢å•æ•°æ®
        let currentOrder = null;
        let currentStep = 0;
        
        // åˆ›å»ºè®¢å•
        function createOrder() {
            currentOrder = {
                id: Date.now(),
                orderNumber: 'TEST' + Date.now(),
                status: 'PENDING',
                paymentStatus: 'UNPAID', // ä¿®å¤åï¼šæ˜ç¡®è®¾ç½®æ”¯ä»˜çŠ¶æ€
                passengerId: 1,
                estimatedFare: 25.50,
                createdAt: new Date()
            };
            
            updateStep(1, 'PENDING', 'UNPAID');
            enableStep(2);
            showResult('âœ… è®¢å•åˆ›å»ºæˆåŠŸï¼Œæ”¯ä»˜çŠ¶æ€å·²è®¾ç½®ä¸º UNPAID');
        }
        
        // å¸æœºæ¥å•
        function acceptOrder() {
            if (!currentOrder) return;
            
            currentOrder.status = 'ASSIGNED';
            currentOrder.driverId = 1;
            updateStep(2, 'ASSIGNED');
            enableStep(3);
            showResult('âœ… å¸æœºå·²æ¥å•ï¼Œè®¢å•çŠ¶æ€ï¼šASSIGNED');
        }
        
        // å¼€å§‹è¡Œç¨‹
        function startTrip() {
            if (!currentOrder) return;
            
            currentOrder.status = 'IN_PROGRESS';
            updateStep(3, 'IN_PROGRESS');
            enableStep(4);
            showResult('âœ… è¡Œç¨‹å·²å¼€å§‹ï¼Œè®¢å•çŠ¶æ€ï¼šIN_PROGRESS');
        }
        
        // å®Œæˆè®¢å•
        function completeOrder() {
            if (!currentOrder) return;
            
            currentOrder.status = 'COMPLETED';
            currentOrder.completionTime = new Date();
            
            // ä¿®å¤åï¼šç¡®ä¿æ”¯ä»˜çŠ¶æ€ä¸ºæœªæ”¯ä»˜
            if (currentOrder.paymentStatus === null || currentOrder.paymentStatus !== 'UNPAID') {
                currentOrder.paymentStatus = 'UNPAID';
            }
            
            updateStep(4, 'COMPLETED', 'UNPAID');
            showResult('âœ… è®¢å•å·²å®Œæˆï¼Œæ”¯ä»˜çŠ¶æ€ï¼šUNPAIDï¼ˆç­‰å¾…ä¹˜å®¢æ”¯ä»˜ï¼‰');
        }
        
        // æ£€æŸ¥æ”¯ä»˜çŠ¶æ€
        function checkPaymentStatus() {
            if (!currentOrder) {
                showResult('âŒ è¯·å…ˆåˆ›å»ºè®¢å•', 'error');
                return;
            }
            
            const result = `ğŸ“Š è®¢å•æ”¯ä»˜çŠ¶æ€æ£€æŸ¥:\n\n` +
                          `è®¢å•å·: ${currentOrder.orderNumber}\n` +
                          `è®¢å•çŠ¶æ€: ${currentOrder.status}\n` +
                          `æ”¯ä»˜çŠ¶æ€: ${currentOrder.paymentStatus}\n` +
                          `åˆ›å»ºæ—¶é—´: ${currentOrder.createdAt.toLocaleString()}\n` +
                          `${currentOrder.completionTime ? 'å®Œæˆæ—¶é—´: ' + currentOrder.completionTime.toLocaleString() : ''}\n\n` +
                          `${currentOrder.paymentStatus === 'UNPAID' ? 'âœ… æ”¯ä»˜çŠ¶æ€æ­£ç¡®è®¾ç½®ä¸º UNPAID' : 'âŒ æ”¯ä»˜çŠ¶æ€è®¾ç½®é”™è¯¯'}`;
            
            showResult(result, currentOrder.paymentStatus === 'UNPAID' ? 'success' : 'error');
        }
        
        // æµ‹è¯•æœªæ”¯ä»˜è®¢å•è¯†åˆ«
        function testUnpaidOrderDetection() {
            if (!currentOrder || currentOrder.status !== 'COMPLETED') {
                showResult('âŒ è¯·å…ˆå®Œæˆè®¢å•', 'error');
                return;
            }
            
            // æ¨¡æ‹Ÿä¿®å¤åçš„åç«¯é€»è¾‘
            const isUnpaid = currentOrder.status === 'COMPLETED' && 
                            currentOrder.paymentStatus === 'UNPAID' &&
                            currentOrder.paymentStatus !== 'REFUNDED';
            
            const result = `ğŸ§ª æœªæ”¯ä»˜è®¢å•è¯†åˆ«æµ‹è¯•:\n\n` +
                          `è®¢å•çŠ¶æ€: ${currentOrder.status}\n` +
                          `æ”¯ä»˜çŠ¶æ€: ${currentOrder.paymentStatus}\n` +
                          `æ˜¯å¦è¯†åˆ«ä¸ºæœªæ”¯ä»˜: ${isUnpaid ? 'æ˜¯' : 'å¦'}\n\n` +
                          `${isUnpaid ? 'âœ… æ­£ç¡®è¯†åˆ«ä¸ºæœªæ”¯ä»˜è®¢å•' : 'âŒ æœªæ­£ç¡®è¯†åˆ«ä¸ºæœªæ”¯ä»˜è®¢å•'}`;
            
            showResult(result, isUnpaid ? 'success' : 'error');
        }
        
        // æµ‹è¯•æ–°è®¢å•åˆ›å»º
        function testNewOrderCreation() {
            if (!currentOrder || currentOrder.status !== 'COMPLETED') {
                showResult('âŒ è¯·å…ˆå®Œæˆè®¢å•', 'error');
                return;
            }
            
            const hasUnpaidOrder = currentOrder.status === 'COMPLETED' && 
                                  currentOrder.paymentStatus === 'UNPAID';
            
            const result = `ğŸš— æ–°è®¢å•åˆ›å»ºæµ‹è¯•:\n\n` +
                          `å½“å‰æœ‰æœªæ”¯ä»˜è®¢å•: ${hasUnpaidOrder ? 'æ˜¯' : 'å¦'}\n` +
                          `æ˜¯å¦åº”è¯¥é˜»æ­¢æ–°è®¢å•: ${hasUnpaidOrder ? 'æ˜¯' : 'å¦'}\n\n` +
                          `${hasUnpaidOrder ? 'âŒ ç”¨æˆ·ä¸èƒ½åˆ›å»ºæ–°è®¢å•ï¼Œéœ€è¦å…ˆå®Œæˆæ”¯ä»˜' : 'âœ… ç”¨æˆ·å¯ä»¥åˆ›å»ºæ–°è®¢å•'}`;
            
            showResult(result, hasUnpaidOrder ? 'warning' : 'success');
        }
        
        // é‡ç½®æµ‹è¯•
        function resetTest() {
            currentOrder = null;
            currentStep = 0;
            
            // é‡ç½®æ‰€æœ‰æ­¥éª¤
            for (let i = 1; i <= 4; i++) {
                const step = document.getElementById(`step${i}`);
                step.className = 'flow-step';
                step.querySelector('button').disabled = i > 1;
                
                if (i === 1) {
                    step.querySelector('#status1').textContent = '?';
                } else {
                    step.querySelector(`#status${i}`).textContent = '?';
                    if (i === 4) {
                        step.querySelector('#payment4').textContent = '?';
                    }
                }
            }
            
            showResult('ğŸ”„ æµ‹è¯•å·²é‡ç½®ï¼Œè¯·é‡æ–°å¼€å§‹');
        }
        
        // æ›´æ–°æ­¥éª¤çŠ¶æ€
        function updateStep(stepNum, status, paymentStatus = null) {
            const step = document.getElementById(`step${stepNum}`);
            step.className = 'flow-step completed';
            
            if (stepNum === 1) {
                step.querySelector('#status1').textContent = paymentStatus || status;
            } else {
                step.querySelector(`#status${stepNum}`).textContent = status;
                if (stepNum === 4 && paymentStatus) {
                    step.querySelector('#payment4').textContent = paymentStatus;
                }
            }
        }
        
        // å¯ç”¨æ­¥éª¤
        function enableStep(stepNum) {
            const step = document.getElementById(`step${stepNum}`);
            step.querySelector('button').disabled = false;
        }
        
        // æ˜¾ç¤ºç»“æœ
        function showResult(message, type = 'success') {
            const resultDiv = document.getElementById('orderResult');
            resultDiv.textContent = message;
            resultDiv.className = `result ${type}`;
            resultDiv.style.display = 'block';
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // åˆå§‹åŒ–ç¬¬ä¸€ä¸ªæ­¥éª¤ä¸ºæ¿€æ´»çŠ¶æ€
            document.getElementById('step1').className = 'flow-step active';
        });
    </script>
</body>
</html>
