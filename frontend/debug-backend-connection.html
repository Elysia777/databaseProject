<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>后端连接诊断</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .debug-section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .debug-section h3 {
            margin-top: 0;
            color: #333;
        }
        button {
            background: #409EFF;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #66b1ff;
        }
        button.success {
            background: #67c23a;
        }
        button.danger {
            background: #f56c6c;
        }
        .status-display {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 14px;
            white-space: pre-wrap;
        }
        .status-good {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .status-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .status-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        .solution {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 4px solid #2196f3;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔧 后端连接诊断工具</h1>
        <p>诊断前端无法连接后端和司机状态问题</p>
    </div>

    <div class="container">
        <div class="debug-section">
            <h3>1. 后端服务检查</h3>
            <button onclick="checkBackendService()">检查后端服务</button>
            <button onclick="testApiEndpoints()">测试API端点</button>
            
            <div id="backendStatus" class="status-display">
                点击按钮检查后端服务状态...
            </div>
        </div>

        <div class="debug-section">
            <h3>2. 司机数据检查</h3>
            <button onclick="checkDriverData()">检查司机数据</button>
            <button onclick="createTestDriver()">创建测试司机</button>
            <button onclick="checkDriverDetail()">检查司机详情</button>
            
            <div id="driverDataStatus" class="status-display">
                点击按钮检查司机数据...
            </div>
        </div>

        <div class="debug-section">
            <h3>3. Redis状态检查</h3>
            <button onclick="checkRedisStatus()">检查Redis状态</button>
            <button onclick="fixDriverRedisStatus()">修复司机Redis状态</button>
            
            <div id="redisStatus" class="status-display">
                点击按钮检查Redis状态...
            </div>
        </div>

        <div class="debug-section">
            <h3>4. 一键修复</h3>
            <button onclick="autoFix()" style="background: #f56c6c; font-size: 16px; padding: 15px 30px;">🚀 一键修复所有问题</button>
            
            <div id="autoFixStatus" class="status-display">
                点击一键修复按钮开始自动修复...
            </div>
        </div>
    </div>

    <div class="container">
        <h3>📋 诊断日志</h3>
        <div id="debugLog" style="background: #f8f9fa; padding: 15px; border-radius: 5px; font-family: monospace; font-size: 12px; max-height: 400px; overflow-y: auto;"></div>
    </div>

    <script>
        function log(message, type = 'info') {
            const logDiv = document.getElementById('debugLog');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}\\n`;
            logDiv.textContent += logEntry;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(logEntry);
        }

        async function checkBackendService() {
            const statusDiv = document.getElementById('backendStatus');
            let status = '后端服务检查结果:\\n\\n';
            
            log('开始检查后端服务...');
            
            // 检查基本连接
            try {
                const response = await fetch('/api/drivers/online', {
                    method: 'GET',
                    timeout: 5000
                });
                
                if (response.ok) {
                    status += '✅ 后端服务正常运行\\n';
                    status += `状态码: ${response.status}\\n`;
                    log('✅ 后端服务连接成功');
                } else {
                    status += `❌ 后端服务响应异常: ${response.status}\\n`;
                    log(`❌ 后端服务响应异常: ${response.status}`);
                }
            } catch (error) {
                status += `❌ 无法连接到后端服务\\n`;
                status += `错误信息: ${error.message}\\n`;
                status += `\\n可能的原因:\\n`;
                status += `1. 后端服务未启动\\n`;
                status += `2. 端口8080被占用\\n`;
                status += `3. 防火墙阻止连接\\n`;
                status += `4. 代理配置错误\\n`;
                
                log(`❌ 后端连接失败: ${error.message}`);
            }
            
            statusDiv.textContent = status;
            statusDiv.className = status.includes('✅') ? 'status-display status-good' : 'status-display status-error';
        }

        async function testApiEndpoints() {
            const statusDiv = document.getElementById('backendStatus');
            let status = 'API端点测试结果:\\n\\n';
            
            const endpoints = [
                { path: '/api/drivers/online', name: '在线司机列表' },
                { path: '/api/drivers/1', name: '司机信息' },
                { path: '/api/drivers/online/redis', name: 'Redis在线司机' },
                { path: '/api/drivers/connections/stats', name: '连接统计' }
            ];
            
            for (const endpoint of endpoints) {
                try {
                    const response = await fetch(endpoint.path, {
                        method: 'GET',
                        timeout: 3000
                    });
                    
                    if (response.ok) {
                        status += `✅ ${endpoint.name}: 正常 (${response.status})\\n`;
                        log(`✅ ${endpoint.name} 测试通过`);
                    } else {
                        status += `❌ ${endpoint.name}: 异常 (${response.status})\\n`;
                        log(`❌ ${endpoint.name} 测试失败: ${response.status}`);
                    }
                } catch (error) {
                    status += `❌ ${endpoint.name}: 连接失败\\n`;
                    log(`❌ ${endpoint.name} 连接失败: ${error.message}`);
                }
            }
            
            statusDiv.textContent = status;
            statusDiv.className = status.includes('❌') ? 'status-display status-error' : 'status-display status-good';
        }

        async function checkDriverData() {
            const statusDiv = document.getElementById('driverDataStatus');
            let status = '司机数据检查结果:\\n\\n';
            
            log('开始检查司机数据...');
            
            try {
                // 检查司机信息
                const response = await fetch('/api/drivers/1', {
                    method: 'GET'
                });
                
                if (response.ok) {
                    const driverData = await response.json();
                    status += '✅ 司机数据存在\\n';
                    status += `司机ID: ${driverData.data?.id || '未知'}\\n`;
                    status += `司机姓名: ${driverData.data?.name || '未知'}\\n`;
                    status += `司机状态: ${driverData.data?.status || '未知'}\\n`;
                    log('✅ 司机数据检查通过');
                } else if (response.status === 404) {
                    status += '❌ 司机数据不存在\\n';
                    status += '需要在数据库中创建司机记录\\n';
                    log('❌ 司机数据不存在');
                } else {
                    status += `❌ 司机数据检查失败: ${response.status}\\n`;
                    log(`❌ 司机数据检查失败: ${response.status}`);
                }
            } catch (error) {
                status += `❌ 无法检查司机数据\\n`;
                status += `错误信息: ${error.message}\\n`;
                log(`❌ 司机数据检查异常: ${error.message}`);
            }
            
            statusDiv.textContent = status;
            statusDiv.className = status.includes('✅') ? 'status-display status-good' : 'status-display status-error';
        }

        async function checkDriverDetail() {
            const statusDiv = document.getElementById('driverDataStatus');
            let status = '司机详细状态检查结果:\\n\\n';
            
            log('开始检查司机详细状态...');
            
            try {
                const response = await fetch('/api/drivers/1/status-detail', {
                    method: 'GET'
                });
                
                if (response.ok) {
                    const result = await response.json();
                    const detail = result.data;
                    
                    status += '=== 数据库状态 ===\\n';
                    if (detail.database) {
                        status += `✅ 数据库中存在司机记录\\n`;
                        status += `姓名: ${detail.database.name}\\n`;
                        status += `状态: ${detail.database.status}\\n`;
                        status += `位置: ${detail.database.currentLatitude}, ${detail.database.currentLongitude}\\n`;
                    } else {
                        status += `❌ 数据库中不存在司机记录\\n`;
                    }
                    
                    status += '\\n=== Redis状态 ===\\n';
                    if (detail.redis) {
                        status += `✅ Redis中存在司机信息\\n`;
                        status += `姓名: ${detail.redis.name}\\n`;
                        status += `状态: ${detail.redis.status}\\n`;
                    } else {
                        status += `❌ Redis中不存在司机信息\\n`;
                    }
                    
                    status += `\\n在线且空闲: ${detail.isOnlineAndFree ? '✅ 是' : '❌ 否'}\\n`;
                    
                    if (detail.geoPosition) {
                        status += `GEO位置: ${detail.geoPosition.x}, ${detail.geoPosition.y}\\n`;
                    } else {
                        status += `❌ GEO位置不存在\\n`;
                    }
                    
                    status += '\\n=== 一致性检查 ===\\n';
                    status += `数据库存在: ${detail.consistency.dbExists ? '✅' : '❌'}\\n`;
                    status += `Redis存在: ${detail.consistency.redisExists ? '✅' : '❌'}\\n`;
                    status += `状态匹配: ${detail.consistency.statusMatch ? '✅' : '❌'}\\n`;
                    
                    log('✅ 司机详细状态检查完成');
                } else {
                    status += `❌ 检查失败: ${response.status}\\n`;
                    log(`❌ 司机详细状态检查失败: ${response.status}`);
                }
            } catch (error) {
                status += `❌ 检查异常: ${error.message}\\n`;
                log(`❌ 司机详细状态检查异常: ${error.message}`);
            }
            
            statusDiv.textContent = status;
            statusDiv.className = status.includes('❌') ? 'status-display status-error' : 'status-display status-good';
        }

        async function createTestDriver() {
            const statusDiv = document.getElementById('driverDataStatus');
            let status = '创建测试司机结果:\\n\\n';
            
            log('开始创建测试司机...');
            
            try {
                const driverData = {
                    name: '测试司机',
                    phone: '13800138000',
                    licenseNumber: 'TEST001',
                    vehicleInfo: '测试车辆',
                    status: 'AVAILABLE'
                };
                
                const response = await fetch('/api/drivers', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(driverData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    status += '✅ 测试司机创建成功\\n';
                    status += `司机ID: ${result.data?.id || '未知'}\\n`;
                    log('✅ 测试司机创建成功');
                } else {
                    status += `❌ 测试司机创建失败: ${response.status}\\n`;
                    log(`❌ 测试司机创建失败: ${response.status}`);
                }
            } catch (error) {
                status += `❌ 创建测试司机异常\\n`;
                status += `错误信息: ${error.message}\\n`;
                log(`❌ 创建测试司机异常: ${error.message}`);
            }
            
            statusDiv.textContent = status;
            statusDiv.className = status.includes('✅') ? 'status-display status-good' : 'status-display status-error';
        }

        async function checkRedisStatus() {
            const statusDiv = document.getElementById('redisStatus');
            let status = 'Redis状态检查结果:\\n\\n';
            
            log('开始检查Redis状态...');
            
            try {
                // 检查在线司机
                const response = await fetch('/api/drivers/online/redis', {
                    method: 'GET'
                });
                
                if (response.ok) {
                    const result = await response.json();
                    const drivers = result.data || [];
                    status += `✅ Redis连接正常\\n`;
                    status += `在线司机数量: ${drivers.length}\\n`;
                    
                    if (drivers.length > 0) {
                        status += '\\n在线司机列表:\\n';
                        drivers.forEach(driver => {
                            status += `- 司机${driver.id}: ${driver.name}\\n`;
                        });
                    } else {
                        status += '\\n❌ 没有在线司机\\n';
                        status += '需要司机重新上线\\n';
                    }
                    
                    log('✅ Redis状态检查通过');
                } else {
                    status += `❌ Redis状态检查失败: ${response.status}\\n`;
                    log(`❌ Redis状态检查失败: ${response.status}`);
                }
            } catch (error) {
                status += `❌ 无法检查Redis状态\\n`;
                status += `错误信息: ${error.message}\\n`;
                log(`❌ Redis状态检查异常: ${error.message}`);
            }
            
            statusDiv.textContent = status;
            statusDiv.className = status.includes('✅') && !status.includes('没有在线司机') ? 'status-display status-good' : 'status-display status-warning';
        }

        async function fixDriverRedisStatus() {
            const statusDiv = document.getElementById('redisStatus');
            let status = '修复司机Redis状态结果:\\n\\n';
            
            log('开始修复司机Redis状态...');
            
            try {
                // 使用新的修复接口
                const response = await fetch('/api/drivers/fix-redis-status', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        status += '✅ Redis状态修复成功\\n\\n';
                        status += result.data;
                        log('✅ Redis状态修复成功');
                    } else {
                        status += `❌ Redis状态修复失败: ${result.message}\\n`;
                        log(`❌ Redis状态修复失败: ${result.message}`);
                    }
                    
                    // 重新检查状态
                    setTimeout(() => {
                        checkRedisStatus();
                    }, 2000);
                } else {
                    status += `❌ 修复请求失败: ${response.status}\\n`;
                    log(`❌ 修复请求失败: ${response.status}`);
                }
            } catch (error) {
                status += `❌ 修复司机Redis状态异常\\n`;
                status += `错误信息: ${error.message}\\n`;
                log(`❌ 修复司机Redis状态异常: ${error.message}`);
            }
            
            statusDiv.textContent = status;
            statusDiv.className = status.includes('✅') ? 'status-display status-good' : 'status-display status-error';
        }

        async function autoFix() {
            const statusDiv = document.getElementById('autoFixStatus');
            let status = '🚀 一键修复进行中...\\n\\n';
            statusDiv.textContent = status;
            statusDiv.className = 'status-display status-warning';
            
            log('开始一键修复...');
            
            try {
                // 步骤1: 检查后端服务
                status += '步骤1: 检查后端服务...\\n';
                statusDiv.textContent = status;
                await checkBackendService();
                
                // 步骤2: 检查并创建司机数据
                status += '步骤2: 检查司机数据...\\n';
                statusDiv.textContent = status;
                await checkDriverData();
                
                // 如果司机不存在，创建测试司机
                try {
                    const driverResponse = await fetch('/api/drivers/1');
                    if (!driverResponse.ok) {
                        status += '步骤2.1: 创建测试司机...\\n';
                        statusDiv.textContent = status;
                        await createTestDriver();
                    }
                } catch (e) {
                    status += '步骤2.1: 创建测试司机...\\n';
                    statusDiv.textContent = status;
                    await createTestDriver();
                }
                
                // 步骤3: 修复Redis状态
                status += '步骤3: 修复Redis状态...\\n';
                statusDiv.textContent = status;
                await fixDriverRedisStatus();
                
                // 步骤4: 最终验证
                status += '步骤4: 最终验证...\\n';
                statusDiv.textContent = status;
                
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                const finalCheck = await fetch('/api/drivers/online/redis');
                if (finalCheck.ok) {
                    const result = await finalCheck.json();
                    const drivers = result.data || [];
                    
                    if (drivers.length > 0) {
                        status += '\\n✅ 修复完成！\\n';
                        status += `发现 ${drivers.length} 个在线司机\\n`;
                        status += '\\n现在可以测试订单推送功能了！\\n';
                        statusDiv.className = 'status-display status-good';
                        log('✅ 一键修复完成');
                    } else {
                        status += '\\n⚠️  修复部分完成\\n';
                        status += '司机数据已修复，但可能需要手动上线\\n';
                        statusDiv.className = 'status-display status-warning';
                        log('⚠️  一键修复部分完成');
                    }
                } else {
                    status += '\\n❌ 最终验证失败\\n';
                    status += '请手动检查各个组件状态\\n';
                    statusDiv.className = 'status-display status-error';
                    log('❌ 一键修复验证失败');
                }
                
            } catch (error) {
                status += `\\n❌ 修复过程中出现异常\\n`;
                status += `错误信息: ${error.message}\\n`;
                statusDiv.className = 'status-display status-error';
                log(`❌ 一键修复异常: ${error.message}`);
            }
            
            statusDiv.textContent = status;
        }

        // 页面加载时的初始化
        window.onload = function() {
            log('后端连接诊断工具已加载');
            
            log('检测到的问题:');
            log('1. ECONNREFUSED - 无法连接后端');
            log('2. 司机信息不完整');
            log('3. 司机未建立连接');
            
            // 自动开始基本检查
            setTimeout(() => {
                checkBackendService();
            }, 1000);
        };
    </script>
</body>
</html>