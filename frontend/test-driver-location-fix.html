<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¸æœºä½ç½®ä¿®å¤æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #333;
        }
        button {
            background: #409EFF;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #66b1ff;
        }
        button.success {
            background: #67c23a;
        }
        button.danger {
            background: #f56c6c;
        }
        .result-display {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 14px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .status-good {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .status-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .status-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        .location-info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 4px solid #2196f3;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ—ºï¸ å¸æœºä½ç½®ä¿®å¤æµ‹è¯•</h1>
        <p>æµ‹è¯•å¸æœºä½ç½®è·å–å’Œå¯¼èˆªåŠŸèƒ½çš„ä¿®å¤</p>
    </div>

    <div class="container">
        <div class="test-section">
            <h3>1. æµè§ˆå™¨åœ°ç†ä½ç½®æµ‹è¯•</h3>
            <button onclick="testBrowserGeolocation()">æµ‹è¯•æµè§ˆå™¨å®šä½</button>
            <button onclick="useDefaultLocation()">ä½¿ç”¨é»˜è®¤ä½ç½®</button>
            
            <div id="locationStatus" class="result-display">
                ç‚¹å‡»æŒ‰é’®æµ‹è¯•åœ°ç†ä½ç½®åŠŸèƒ½...
            </div>
        </div>

        <div class="test-section">
            <h3>2. å½“å‰ä½ç½®ä¿¡æ¯</h3>
            <div id="currentLocationInfo" class="location-info">
                <p><strong>ç»åº¦:</strong> <span id="currentLng">æœªè·å–</span></p>
                <p><strong>çº¬åº¦:</strong> <span id="currentLat">æœªè·å–</span></p>
                <p><strong>è·å–æ—¶é—´:</strong> <span id="locationTime">-</span></p>
                <p><strong>å®šä½æ–¹å¼:</strong> <span id="locationType">-</span></p>
            </div>
        </div>

        <div class="test-section">
            <h3>3. å¸æœºä¸Šçº¿æµ‹è¯•</h3>
            <button onclick="testDriverOnline()">å¸æœºä¸Šçº¿</button>
            <button onclick="testLocationReport()">ä¸ŠæŠ¥ä½ç½®</button>
            
            <div id="onlineStatus" class="result-display">
                ç‚¹å‡»æŒ‰é’®æµ‹è¯•å¸æœºä¸Šçº¿åŠŸèƒ½...
            </div>
        </div>

        <div class="test-section">
            <h3>4. å¯¼èˆªåŠŸèƒ½æµ‹è¯•</h3>
            <button onclick="testNavigationPrerequisites()">æ£€æŸ¥å¯¼èˆªå‰ç½®æ¡ä»¶</button>
            <button onclick="simulateNavigation()">æ¨¡æ‹Ÿå¯¼èˆª</button>
            
            <div id="navigationStatus" class="result-display">
                ç‚¹å‡»æŒ‰é’®æµ‹è¯•å¯¼èˆªåŠŸèƒ½...
            </div>
        </div>
    </div>

    <script>
        let currentPosition = { lng: null, lat: null };

        function log(message, containerId = 'locationStatus') {
            const container = document.getElementById(containerId);
            const timestamp = new Date().toLocaleTimeString();
            container.textContent += `[${timestamp}] ${message}\\n`;
            container.scrollTop = container.scrollHeight;
            console.log(message);
        }

        function updateLocationDisplay(lng, lat, type = 'æµè§ˆå™¨å®šä½') {
            document.getElementById('currentLng').textContent = lng || 'æœªè·å–';
            document.getElementById('currentLat').textContent = lat || 'æœªè·å–';
            document.getElementById('locationTime').textContent = new Date().toLocaleTimeString();
            document.getElementById('locationType').textContent = type;
            
            currentPosition = { lng, lat };
        }

        function testBrowserGeolocation() {
            const statusDiv = document.getElementById('locationStatus');
            statusDiv.textContent = '';
            statusDiv.className = 'result-display';
            
            log('ğŸŒ å¼€å§‹æµ‹è¯•æµè§ˆå™¨åœ°ç†ä½ç½®...');
            
            if (!navigator.geolocation) {
                log('âŒ æµè§ˆå™¨ä¸æ”¯æŒåœ°ç†ä½ç½®æœåŠ¡');
                statusDiv.className = 'result-display status-error';
                return;
            }
            
            log('âœ… æµè§ˆå™¨æ”¯æŒåœ°ç†ä½ç½®æœåŠ¡');
            log('æ­£åœ¨è¯·æ±‚ä½ç½®æƒé™...');
            
            const options = {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 60000
            };
            
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const { longitude, latitude } = position.coords;
                    log(`âœ… ä½ç½®è·å–æˆåŠŸ:`);
                    log(`ç»åº¦: ${longitude}`);
                    log(`çº¬åº¦: ${latitude}`);
                    log(`ç²¾åº¦: ${position.coords.accuracy} ç±³`);
                    
                    updateLocationDisplay(longitude, latitude, 'æµè§ˆå™¨å®šä½');
                    statusDiv.className = 'result-display status-good';
                },
                (error) => {
                    log(`âŒ ä½ç½®è·å–å¤±è´¥:`);
                    log(`é”™è¯¯ä»£ç : ${error.code}`);
                    log(`é”™è¯¯ä¿¡æ¯: ${error.message}`);
                    
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            log('ç”¨æˆ·æ‹’ç»äº†åœ°ç†ä½ç½®è¯·æ±‚');
                            break;
                        case error.POSITION_UNAVAILABLE:
                            log('ä½ç½®ä¿¡æ¯ä¸å¯ç”¨');
                            break;
                        case error.TIMEOUT:
                            log('è¯·æ±‚ä½ç½®ä¿¡æ¯è¶…æ—¶');
                            break;
                        default:
                            log('æœªçŸ¥é”™è¯¯');
                            break;
                    }
                    
                    log('\\nå»ºè®®ä½¿ç”¨é»˜è®¤ä½ç½®');
                    statusDiv.className = 'result-display status-error';
                },
                options
            );
        }

        function useDefaultLocation() {
            const statusDiv = document.getElementById('locationStatus');
            statusDiv.textContent = '';
            statusDiv.className = 'result-display';
            
            log('ğŸ”„ ä½¿ç”¨é»˜è®¤ä½ç½®ï¼ˆå¤§è¿ç†å·¥å¤§å­¦ï¼‰');
            
            const defaultLng = 121.749849;
            const defaultLat = 39.044237;
            
            log(`é»˜è®¤ç»åº¦: ${defaultLng}`);
            log(`é»˜è®¤çº¬åº¦: ${defaultLat}`);
            
            updateLocationDisplay(defaultLng, defaultLat, 'é»˜è®¤ä½ç½®');
            statusDiv.className = 'result-display status-good';
            
            log('âœ… é»˜è®¤ä½ç½®è®¾ç½®æˆåŠŸ');
        }

        async function testDriverOnline() {
            const statusDiv = document.getElementById('onlineStatus');
            statusDiv.textContent = '';
            statusDiv.className = 'result-display';
            
            log('ğŸš— æµ‹è¯•å¸æœºä¸Šçº¿åŠŸèƒ½...', 'onlineStatus');
            
            if (!currentPosition.lng || !currentPosition.lat) {
                log('âŒ å½“å‰ä½ç½®æœªè·å–ï¼Œè¯·å…ˆè·å–ä½ç½®', 'onlineStatus');
                statusDiv.className = 'result-display status-error';
                return;
            }
            
            try {
                const response = await fetch(`/api/drivers/1/online?latitude=${currentPosition.lat}&longitude=${currentPosition.lng}`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    const result = await response.json();
                    log('âœ… å¸æœºä¸Šçº¿æˆåŠŸ', 'onlineStatus');
                    log(`å“åº”: ${result.message}`, 'onlineStatus');
                    statusDiv.className = 'result-display status-good';
                } else {
                    log(`âŒ å¸æœºä¸Šçº¿å¤±è´¥: ${response.status}`, 'onlineStatus');
                    statusDiv.className = 'result-display status-error';
                }
            } catch (error) {
                log(`âŒ å¸æœºä¸Šçº¿å¼‚å¸¸: ${error.message}`, 'onlineStatus');
                statusDiv.className = 'result-display status-error';
            }
        }

        async function testLocationReport() {
            const statusDiv = document.getElementById('onlineStatus');
            
            log('ğŸ“ æµ‹è¯•ä½ç½®ä¸ŠæŠ¥åŠŸèƒ½...', 'onlineStatus');
            
            if (!currentPosition.lng || !currentPosition.lat) {
                log('âŒ å½“å‰ä½ç½®æœªè·å–ï¼Œè¯·å…ˆè·å–ä½ç½®', 'onlineStatus');
                return;
            }
            
            try {
                const response = await fetch('/api/drivers/1/location', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        latitude: currentPosition.lat,
                        longitude: currentPosition.lng
                    })
                });
                
                if (response.ok) {
                    log('âœ… ä½ç½®ä¸ŠæŠ¥æˆåŠŸ', 'onlineStatus');
                } else {
                    log(`âŒ ä½ç½®ä¸ŠæŠ¥å¤±è´¥: ${response.status}`, 'onlineStatus');
                }
            } catch (error) {
                log(`âŒ ä½ç½®ä¸ŠæŠ¥å¼‚å¸¸: ${error.message}`, 'onlineStatus');
            }
        }

        function testNavigationPrerequisites() {
            const statusDiv = document.getElementById('navigationStatus');
            statusDiv.textContent = '';
            statusDiv.className = 'result-display';
            
            log('ğŸ§­ æ£€æŸ¥å¯¼èˆªå‰ç½®æ¡ä»¶...', 'navigationStatus');
            
            // æ£€æŸ¥å½“å‰ä½ç½®
            if (!currentPosition.lng || !currentPosition.lat) {
                log('âŒ å¸æœºå½“å‰ä½ç½®æœªè·å–', 'navigationStatus');
                log('è§£å†³æ–¹æ¡ˆ: è¯·å…ˆè·å–ä½ç½®ä¿¡æ¯', 'navigationStatus');
                statusDiv.className = 'result-display status-error';
                return;
            }
            
            log('âœ… å¸æœºå½“å‰ä½ç½®å·²è·å–', 'navigationStatus');
            log(`å½“å‰ä½ç½®: ${currentPosition.lng}, ${currentPosition.lat}`, 'navigationStatus');
            
            // æ¨¡æ‹Ÿè®¢å•ä¿¡æ¯
            const mockOrder = {
                id: 'TEST_ORDER',
                pickupLatitude: 39.044237,
                pickupLongitude: 121.749849,
                destinationLatitude: 39.054237,
                destinationLongitude: 121.759849,
                pickupAddress: 'æµ‹è¯•ä¸Šè½¦ç‚¹',
                destinationAddress: 'æµ‹è¯•ç›®çš„åœ°'
            };
            
            log('âœ… æ¨¡æ‹Ÿè®¢å•ä¿¡æ¯å®Œæ•´', 'navigationStatus');
            log(`ä¸Šè½¦ç‚¹: ${mockOrder.pickupAddress}`, 'navigationStatus');
            log(`ç›®çš„åœ°: ${mockOrder.destinationAddress}`, 'navigationStatus');
            log(`ä¸Šè½¦åæ ‡: ${mockOrder.pickupLongitude}, ${mockOrder.pickupLatitude}`, 'navigationStatus');
            log(`ç›®çš„åæ ‡: ${mockOrder.destinationLongitude}, ${mockOrder.destinationLatitude}`, 'navigationStatus');
            
            // è®¡ç®—è·ç¦»
            const distance = calculateDistance(
                currentPosition.lat, currentPosition.lng,
                mockOrder.pickupLatitude, mockOrder.pickupLongitude
            );
            
            log(`\\nğŸ“ åˆ°ä¸Šè½¦ç‚¹è·ç¦»: ${distance.toFixed(2)} å…¬é‡Œ`, 'navigationStatus');
            
            if (distance < 10) {
                log('âœ… è·ç¦»åˆç†ï¼Œå¯ä»¥å¼€å§‹å¯¼èˆª', 'navigationStatus');
                statusDiv.className = 'result-display status-good';
            } else {
                log('âš ï¸  è·ç¦»è¾ƒè¿œï¼Œä½†ä»å¯å¯¼èˆª', 'navigationStatus');
                statusDiv.className = 'result-display status-warning';
            }
            
            log('\\nğŸ¯ å¯¼èˆªå‰ç½®æ¡ä»¶æ£€æŸ¥å®Œæˆ', 'navigationStatus');
        }

        function simulateNavigation() {
            const statusDiv = document.getElementById('navigationStatus');
            
            log('\\nğŸš€ æ¨¡æ‹Ÿå¼€å§‹å¯¼èˆª...', 'navigationStatus');
            
            if (!currentPosition.lng || !currentPosition.lat) {
                log('âŒ æ— æ³•å¼€å§‹å¯¼èˆªï¼šå¸æœºä½ç½®æœªè·å–', 'navigationStatus');
                statusDiv.className = 'result-display status-error';
                return;
            }
            
            log('âœ… å¸æœºä½ç½®æ£€æŸ¥é€šè¿‡', 'navigationStatus');
            log('âœ… è®¢å•ä¿¡æ¯æ£€æŸ¥é€šè¿‡', 'navigationStatus');
            log('âœ… å¼€å§‹è§„åˆ’è·¯çº¿...', 'navigationStatus');
            
            // æ¨¡æ‹Ÿå¯¼èˆªè¿‡ç¨‹
            setTimeout(() => {
                log('âœ… è·¯çº¿è§„åˆ’å®Œæˆ', 'navigationStatus');
                log('ğŸ§­ å¯¼èˆªå·²å¼€å§‹', 'navigationStatus');
                log('ğŸ“± è¯·æŒ‰ç…§å¯¼èˆªæŒ‡ç¤ºå‰å¾€ç›®çš„åœ°', 'navigationStatus');
                statusDiv.className = 'result-display status-good';
            }, 1000);
        }

        // è®¡ç®—ä¸¤ç‚¹é—´è·ç¦»ï¼ˆç®€åŒ–ç‰ˆï¼‰
        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371; // åœ°çƒåŠå¾„ï¼ˆå…¬é‡Œï¼‰
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æµ‹è¯•
        window.onload = function() {
            log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹è‡ªåŠ¨æµ‹è¯•...');
            
            // å…ˆä½¿ç”¨é»˜è®¤ä½ç½®
            setTimeout(() => {
                useDefaultLocation();
            }, 500);
            
            // ç„¶åå°è¯•è·å–çœŸå®ä½ç½®
            setTimeout(() => {
                testBrowserGeolocation();
            }, 1000);
        };
    </script>
</body>
</html>