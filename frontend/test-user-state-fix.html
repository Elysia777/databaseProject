<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”¨æˆ·çŠ¶æ€ä¿®å¤æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
        }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover {
            background: #0056b3;
        }
        .success {
            color: #155724;
            background: #d4edda;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .error {
            color: #721c24;
            background: #f8d7da;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ ç”¨æˆ·çŠ¶æ€ä¿®å¤æµ‹è¯•</h1>
        
        <div class="test-section">
            <h3>æ­¥éª¤1: æµ‹è¯•æ–°çš„/auth/user API</h3>
            <button class="btn" onclick="testAuthUserAPI()">æµ‹è¯• /auth/user API</button>
            <div id="authUserResult"></div>
        </div>

        <div class="test-section">
            <h3>æ­¥éª¤2: æ¨¡æ‹Ÿé¡µé¢åˆ‡æ¢åœºæ™¯</h3>
            <button class="btn" onclick="simulatePageSwitch()">æ¨¡æ‹Ÿé¡µé¢åˆ‡æ¢</button>
            <div id="pageSwitchResult"></div>
        </div>

        <div class="test-section">
            <h3>æ­¥éª¤3: æµ‹è¯•ensureUserInfoä¿®å¤</h3>
            <button class="btn" onclick="testEnsureUserInfo()">æµ‹è¯•ç”¨æˆ·ä¿¡æ¯ç¡®ä¿</button>
            <div id="ensureUserInfoResult"></div>
        </div>

        <div class="test-section">
            <h3>æ­¥éª¤4: æµ‹è¯•è®¢å•åˆ›å»ºæ•°æ®</h3>
            <button class="btn" onclick="testOrderData()">æµ‹è¯•è®¢å•æ•°æ®å‡†å¤‡</button>
            <div id="orderDataResult"></div>
        </div>
    </div>

    <script>
        async function testAuthUserAPI() {
            const container = document.getElementById('authUserResult');
            container.innerHTML = '<div>ğŸ”„ æµ‹è¯•ä¸­...</div>';

            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    throw new Error('æ²¡æœ‰æ‰¾åˆ°tokenï¼Œè¯·å…ˆç™»å½•');
                }

                const response = await fetch('/api/auth/user', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const result = await response.json();
                
                container.innerHTML = `
                    <div class="success">âœ… APIè°ƒç”¨æˆåŠŸ</div>
                    <h4>å“åº”æ•°æ®:</h4>
                    <pre>${JSON.stringify(result, null, 2)}</pre>
                    <p><strong>å…³é”®æ£€æŸ¥:</strong></p>
                    <ul>
                        <li>passengerId: ${result.data?.passengerId || 'âŒ æœªè®¾ç½®'}</li>
                        <li>driverId: ${result.data?.driverId || 'âŒ æœªè®¾ç½®'}</li>
                        <li>ç”¨æˆ·ç±»å‹: ${result.data?.userType}</li>
                    </ul>
                `;
            } catch (error) {
                container.innerHTML = `<div class="error">âŒ APIæµ‹è¯•å¤±è´¥: ${error.message}</div>`;
            }
        }

        async function simulatePageSwitch() {
            const container = document.getElementById('pageSwitchResult');
            container.innerHTML = '<div>ğŸ”„ æ¨¡æ‹Ÿé¡µé¢åˆ‡æ¢...</div>';

            try {
                // è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
                const originalUser = JSON.parse(localStorage.getItem('user') || 'null');
                
                container.innerHTML = `
                    <h4>åŸå§‹ç”¨æˆ·ä¿¡æ¯:</h4>
                    <pre>${JSON.stringify(originalUser, null, 2)}</pre>
                `;

                // æ¨¡æ‹Ÿç”¨æˆ·ä¿¡æ¯è¢«éƒ¨åˆ†è¦†ç›–çš„æƒ…å†µ
                const corruptedUser = {
                    ...originalUser,
                    passengerId: null, // æ¨¡æ‹Ÿä¸¢å¤±
                    driverId: null     // æ¨¡æ‹Ÿä¸¢å¤±
                };

                localStorage.setItem('user', JSON.stringify(corruptedUser));

                container.innerHTML += `
                    <div class="error">âš ï¸ æ¨¡æ‹Ÿç”¨æˆ·ä¿¡æ¯æŸåï¼ˆpassengerIdå’ŒdriverIdè¢«æ¸…ç©ºï¼‰</div>
                    <h4>æŸååçš„ç”¨æˆ·ä¿¡æ¯:</h4>
                    <pre>${JSON.stringify(corruptedUser, null, 2)}</pre>
                `;

            } catch (error) {
                container.innerHTML = `<div class="error">âŒ æ¨¡æ‹Ÿå¤±è´¥: ${error.message}</div>`;
            }
        }

        async function testEnsureUserInfo() {
            const container = document.getElementById('ensureUserInfoResult');
            container.innerHTML = '<div>ğŸ”„ æµ‹è¯•ç”¨æˆ·ä¿¡æ¯ä¿®å¤...</div>';

            try {
                const token = localStorage.getItem('token');
                const currentUser = JSON.parse(localStorage.getItem('user') || 'null');

                // æ¨¡æ‹ŸensureUserInfoçš„é€»è¾‘
                if (currentUser && currentUser.userType === 'PASSENGER' && !currentUser.passengerId) {
                    container.innerHTML += '<div class="error">âŒ æ£€æµ‹åˆ°passengerIdç¼ºå¤±ï¼Œå°è¯•ä¿®å¤...</div>';

                    // è°ƒç”¨/auth/user APIè·å–å®Œæ•´ä¿¡æ¯
                    const response = await fetch('/api/auth/user', {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    const result = await response.json();

                    if (result.code === 200) {
                        // åˆå¹¶ç”¨æˆ·ä¿¡æ¯ï¼Œä¿ç•™é‡è¦å­—æ®µ
                        const fixedUser = {
                            ...currentUser,
                            ...result.data,
                            token: currentUser.token || token
                        };

                        localStorage.setItem('user', JSON.stringify(fixedUser));

                        container.innerHTML += `
                            <div class="success">âœ… ç”¨æˆ·ä¿¡æ¯ä¿®å¤æˆåŠŸ</div>
                            <h4>ä¿®å¤åçš„ç”¨æˆ·ä¿¡æ¯:</h4>
                            <pre>${JSON.stringify(fixedUser, null, 2)}</pre>
                            <p><strong>ä¿®å¤ç»“æœ:</strong></p>
                            <ul>
                                <li>passengerId: ${fixedUser.passengerId ? 'âœ… å·²æ¢å¤' : 'âŒ ä»ç„¶ç¼ºå¤±'}</li>
                                <li>token: ${fixedUser.token ? 'âœ… å·²ä¿ç•™' : 'âŒ ä¸¢å¤±'}</li>
                            </ul>
                        `;
                    } else {
                        throw new Error(result.message);
                    }
                } else {
                    container.innerHTML = '<div class="success">âœ… ç”¨æˆ·ä¿¡æ¯å®Œæ•´ï¼Œæ— éœ€ä¿®å¤</div>';
                }

            } catch (error) {
                container.innerHTML = `<div class="error">âŒ ä¿®å¤å¤±è´¥: ${error.message}</div>`;
            }
        }

        async function testOrderData() {
            const container = document.getElementById('orderDataResult');
            container.innerHTML = '<div>ğŸ”„ æµ‹è¯•è®¢å•æ•°æ®å‡†å¤‡...</div>';

            try {
                const user = JSON.parse(localStorage.getItem('user') || 'null');
                
                if (!user) {
                    throw new Error('ç”¨æˆ·ä¿¡æ¯ä¸å­˜åœ¨');
                }

                const passengerId = user.passengerId || user.id;
                
                const orderData = {
                    passengerId: passengerId,
                    pickupAddress: "æµ‹è¯•èµ·ç‚¹",
                    pickupLatitude: 39.9042,
                    pickupLongitude: 116.4074,
                    destinationAddress: "æµ‹è¯•ç»ˆç‚¹",
                    destinationLatitude: 39.9142,
                    destinationLongitude: 116.4174,
                    estimatedDistance: 5.0,
                    estimatedDuration: 15,
                    estimatedFare: 25.0
                };

                const riskLevel = user.passengerId ? 'âœ… å®‰å…¨' : 'âš ï¸ æœ‰é£é™©';
                const riskDescription = user.passengerId ? 
                    'ä½¿ç”¨æ­£ç¡®çš„passengerIdï¼Œä¸ä¼šå‡ºç°å¤–é”®çº¦æŸé”™è¯¯' : 
                    'ä½¿ç”¨ç”¨æˆ·IDä½œä¸ºpassengerIdï¼Œå¯èƒ½å¯¼è‡´å¤–é”®çº¦æŸé”™è¯¯';

                container.innerHTML = `
                    <h4>è®¢å•æ•°æ®å‡†å¤‡ç»“æœ:</h4>
                    <pre>${JSON.stringify(orderData, null, 2)}</pre>
                    <p><strong>é£é™©è¯„ä¼°:</strong> ${riskLevel}</p>
                    <p><strong>è¯´æ˜:</strong> ${riskDescription}</p>
                    <p><strong>ç”¨æˆ·ä¿¡æ¯:</strong></p>
                    <ul>
                        <li>ç”¨æˆ·ID: ${user.id}</li>
                        <li>ç”¨æˆ·ç±»å‹: ${user.userType}</li>
                        <li>passengerId: ${user.passengerId || 'æœªè®¾ç½®'}</li>
                        <li>å°†ä½¿ç”¨çš„ID: ${passengerId}</li>
                    </ul>
                `;

            } catch (error) {
                container.innerHTML = `<div class="error">âŒ æµ‹è¯•å¤±è´¥: ${error.message}</div>`;
            }
        }
    </script>
</body>
</html>