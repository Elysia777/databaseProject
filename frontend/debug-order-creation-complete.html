<!DOCTYPE html>
<html lang=\"zh-CN\">
<head>
    <meta charset=\"UTF-8\">
    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">
    <title>è®¢å•åˆ›å»ºå®Œæ•´è°ƒè¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .debug-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 3px;
        }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .info { background-color: #d1ecf1; color: #0c5460; }
        .warning { background-color: #fff3cd; color: #856404; }
        .code-block {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 14px;
            border: 1px solid #e9ecef;
            overflow-x: auto;
            margin: 10px 0;
            white-space: pre-wrap;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 3px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background-color: #0056b3; }
        .step {
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
            border-left: 4px solid #007bff;
        }
        .data-display {
            background: white;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 3px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>ğŸ” è®¢å•åˆ›å»ºå®Œæ•´è°ƒè¯•</h1>

    <div class=\"debug-section\">
        <h3>ğŸ§ª å®Œæ•´æµ‹è¯•æµç¨‹</h3>
        
        <div class=\"step\">
            <strong>æ­¥éª¤1ï¼š</strong> åˆ›å»ºå®æ—¶è®¢å•
            <button onclick=\"createRealTimeOrder()\">åˆ›å»ºå®æ—¶è®¢å•</button>
            <div id=\"realtime-result\" class=\"data-display\"></div>
        </div>

        <div class=\"step\">
            <strong>æ­¥éª¤2ï¼š</strong> åˆ›å»ºé¢„çº¦è®¢å•
            <button onclick=\"createScheduledOrder()\">åˆ›å»ºé¢„çº¦è®¢å•</button>
            <div id=\"scheduled-result\" class=\"data-display\"></div>
        </div>

        <div class=\"step\">
            <strong>æ­¥éª¤3ï¼š</strong> æŸ¥è¯¢è®¢å•è¯¦æƒ…
            <button onclick=\"queryOrderDetails()\">æŸ¥è¯¢æœ€æ–°è®¢å•</button>
            <div id=\"query-result\" class=\"data-display\"></div>
        </div>
    </div>

    <div class=\"debug-section\">
        <h3>ğŸ“Š æ•°æ®éªŒè¯</h3>
        <div id=\"validation-result\" class=\"data-display\">
            ç­‰å¾…æµ‹è¯•æ•°æ®...
        </div>
    </div>

    <script>
        let lastOrderId = null;

        // åˆ›å»ºå®æ—¶è®¢å•
        async function createRealTimeOrder() {
            const orderData = {
                passengerId: 1,
                pickupAddress: \"æµ‹è¯•èµ·ç‚¹åœ°å€\",
                pickupLatitude: 39.044237,
                pickupLongitude: 121.749849,
                destinationAddress: \"æµ‹è¯•ç»ˆç‚¹åœ°å€\",
                destinationLatitude: 39.054237,
                destinationLongitude: 121.759849,
                estimatedDistance: 8.5,  // æ•°å­—ç±»å‹
                estimatedDuration: 20,   // æ•°å­—ç±»å‹
                estimatedFare: 25.0      // æ•°å­—ç±»å‹
            };

            try {
                console.log('ğŸš€ åˆ›å»ºå®æ—¶è®¢å•:', orderData);

                const response = await fetch('/api/orders', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(orderData)
                });

                const result = await response.json();
                console.log('ğŸ“¡ å®æ—¶è®¢å•å“åº”:', result);

                if (result.code === 200) {
                    lastOrderId = result.data;
                    document.getElementById('realtime-result').innerHTML = `
                        <div class=\"result success\">
                            <strong>âœ… å®æ—¶è®¢å•åˆ›å»ºæˆåŠŸï¼š</strong><br>
                            è®¢å•ID: ${lastOrderId}<br>
                            å‘é€æ•°æ®ç±»å‹æ£€æŸ¥:<br>
                            - estimatedDistance: ${orderData.estimatedDistance} (${typeof orderData.estimatedDistance})<br>
                            - estimatedDuration: ${orderData.estimatedDuration} (${typeof orderData.estimatedDuration})<br>
                            - estimatedFare: ${orderData.estimatedFare} (${typeof orderData.estimatedFare})
                        </div>
                        <div class=\"code-block\">è¯·æ±‚æ•°æ®: ${JSON.stringify(orderData, null, 2)}

å“åº”æ•°æ®: ${JSON.stringify(result, null, 2)}</div>
                    `;
                } else {
                    document.getElementById('realtime-result').innerHTML = `
                        <div class=\"result error\">
                            <strong>âŒ å®æ—¶è®¢å•åˆ›å»ºå¤±è´¥ï¼š</strong>
                        </div>
                        <div class=\"code-block\">${JSON.stringify(result, null, 2)}</div>
                    `;
                }
            } catch (error) {
                console.error('âŒ åˆ›å»ºå®æ—¶è®¢å•å¤±è´¥:', error);
                document.getElementById('realtime-result').innerHTML = `
                    <div class=\"result error\">
                        <strong>âŒ è¯·æ±‚å¤±è´¥ï¼š</strong> ${error.message}
                    </div>
                `;
            }
        }

        // åˆ›å»ºé¢„çº¦è®¢å•
        async function createScheduledOrder() {
            // åˆ›å»ºä¸€ä¸ª1å°æ—¶åçš„é¢„çº¦æ—¶é—´
            const scheduledTime = new Date();
            scheduledTime.setHours(scheduledTime.getHours() + 1);
            
            const orderData = {
                passengerId: 1,
                pickupAddress: \"é¢„çº¦èµ·ç‚¹åœ°å€\",
                pickupLatitude: 39.044237,
                pickupLongitude: 121.749849,
                destinationAddress: \"é¢„çº¦ç»ˆç‚¹åœ°å€\",
                destinationLatitude: 39.054237,
                destinationLongitude: 121.759849,
                scheduledTime: scheduledTime.toISOString().slice(0, 19).replace('T', ' '),
                estimatedDistance: 12.3,  // æ•°å­—ç±»å‹
                estimatedDuration: 30,    // æ•°å­—ç±»å‹
                estimatedFare: 35.0       // æ•°å­—ç±»å‹
            };

            try {
                console.log('ğŸš€ åˆ›å»ºé¢„çº¦è®¢å•:', orderData);

                const response = await fetch('/api/orders/scheduled', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(orderData)
                });

                const result = await response.json();
                console.log('ğŸ“¡ é¢„çº¦è®¢å•å“åº”:', result);

                if (result.code === 200) {
                    lastOrderId = result.data.id;
                    document.getElementById('scheduled-result').innerHTML = `
                        <div class=\"result success\">
                            <strong>âœ… é¢„çº¦è®¢å•åˆ›å»ºæˆåŠŸï¼š</strong><br>
                            è®¢å•ID: ${lastOrderId}<br>
                            å‘é€æ•°æ®ç±»å‹æ£€æŸ¥:<br>
                            - estimatedDistance: ${orderData.estimatedDistance} (${typeof orderData.estimatedDistance})<br>
                            - estimatedDuration: ${orderData.estimatedDuration} (${typeof orderData.estimatedDuration})<br>
                            - estimatedFare: ${orderData.estimatedFare} (${typeof orderData.estimatedFare})
                        </div>
                        <div class=\"code-block\">è¯·æ±‚æ•°æ®: ${JSON.stringify(orderData, null, 2)}

å“åº”æ•°æ®: ${JSON.stringify(result, null, 2)}</div>
                    `;
                } else {
                    document.getElementById('scheduled-result').innerHTML = `
                        <div class=\"result error\">
                            <strong>âŒ é¢„çº¦è®¢å•åˆ›å»ºå¤±è´¥ï¼š</strong>
                        </div>
                        <div class=\"code-block\">${JSON.stringify(result, null, 2)}</div>
                    `;
                }
            } catch (error) {
                console.error('âŒ åˆ›å»ºé¢„çº¦è®¢å•å¤±è´¥:', error);
                document.getElementById('scheduled-result').innerHTML = `
                    <div class=\"result error\">
                        <strong>âŒ è¯·æ±‚å¤±è´¥ï¼š</strong> ${error.message}
                    </div>
                `;
            }
        }

        // æŸ¥è¯¢è®¢å•è¯¦æƒ…
        async function queryOrderDetails() {
            if (!lastOrderId) {
                alert('è¯·å…ˆåˆ›å»ºè®¢å•');
                return;
            }

            try {
                console.log('ğŸ” æŸ¥è¯¢è®¢å•è¯¦æƒ…:', lastOrderId);

                const response = await fetch(`/api/orders/${lastOrderId}`);
                const result = await response.json();
                console.log('ğŸ“‹ è®¢å•è¯¦æƒ…:', result);

                if (result.code === 200) {
                    const order = result.data;
                    
                    // éªŒè¯å…³é”®å­—æ®µ
                    const hasDistance = order.estimatedDistance !== null && order.estimatedDistance !== undefined;
                    const hasDuration = order.estimatedDuration !== null && order.estimatedDuration !== undefined;
                    const hasFare = order.estimatedFare !== null && order.estimatedFare !== undefined;

                    document.getElementById('query-result').innerHTML = `
                        <div class=\"result ${hasDistance && hasDuration && hasFare ? 'success' : 'error'}\">
                            <strong>ğŸ“‹ æ•°æ®åº“è®°å½•éªŒè¯ï¼š</strong><br>
                            è®¢å•ID: ${order.id}<br>
                            ä¼°ç®—è·ç¦»: ${order.estimatedDistance} å…¬é‡Œ ${hasDistance ? 'âœ…' : 'âŒ'}<br>
                            ä¼°ç®—æ—¶é•¿: ${order.estimatedDuration} åˆ†é’Ÿ ${hasDuration ? 'âœ…' : 'âŒ'}<br>
                            ä¼°ç®—è´¹ç”¨: ${order.estimatedFare} å…ƒ ${hasFare ? 'âœ…' : 'âŒ'}
                        </div>
                        <div class=\"code-block\">å®Œæ•´è®¢å•æ•°æ®: ${JSON.stringify(order, null, 2)}</div>
                    `;

                    // æ›´æ–°éªŒè¯ç»“æœ
                    updateValidationResult(order);
                } else {
                    document.getElementById('query-result').innerHTML = `
                        <div class=\"result error\">
                            <strong>âŒ æŸ¥è¯¢å¤±è´¥ï¼š</strong>
                        </div>
                        <div class=\"code-block\">${JSON.stringify(result, null, 2)}</div>
                    `;
                }
            } catch (error) {
                console.error('âŒ æŸ¥è¯¢è®¢å•è¯¦æƒ…å¤±è´¥:', error);
                document.getElementById('query-result').innerHTML = `
                    <div class=\"result error\">
                        <strong>âŒ æŸ¥è¯¢å¤±è´¥ï¼š</strong> ${error.message}
                    </div>
                `;
            }
        }

        // æ›´æ–°éªŒè¯ç»“æœ
        function updateValidationResult(order) {
            const hasDistance = order.estimatedDistance !== null && order.estimatedDistance !== undefined;
            const hasDuration = order.estimatedDuration !== null && order.estimatedDuration !== undefined;
            const hasFare = order.estimatedFare !== null && order.estimatedFare !== undefined;

            const allFieldsPresent = hasDistance && hasDuration && hasFare;

            document.getElementById('validation-result').innerHTML = `
                <div class=\"result ${allFieldsPresent ? 'success' : 'error'}\">
                    <strong>ğŸ” æ•°æ®å®Œæ•´æ€§éªŒè¯ï¼š</strong><br>
                    ${allFieldsPresent ? 'âœ… æ‰€æœ‰å­—æ®µéƒ½å·²æ­£ç¡®ä¿å­˜åˆ°æ•°æ®åº“' : 'âŒ éƒ¨åˆ†å­—æ®µç¼ºå¤±'}
                </div>
                <div class=\"code-block\">å­—æ®µæ£€æŸ¥ç»“æœ:
- estimatedDistance: ${order.estimatedDistance} ${hasDistance ? 'âœ…' : 'âŒ ç¼ºå¤±'}
- estimatedDuration: ${order.estimatedDuration} ${hasDuration ? 'âœ…' : 'âŒ ç¼ºå¤±'}  
- estimatedFare: ${order.estimatedFare} ${hasFare ? 'âœ…' : 'âŒ ç¼ºå¤±'}

${allFieldsPresent ? 
'æ•°æ®åº“ä¿å­˜æ­£å¸¸ï¼Œå¦‚æœå¸æœºç«¯ä¸æ˜¾ç¤ºï¼Œé—®é¢˜å¯èƒ½åœ¨ï¼š
1. WebSocketé€šçŸ¥æ•°æ®
2. å¸æœºç«¯æ˜¾ç¤ºé€»è¾‘
3. å‰ç«¯æ•°æ®è§£æ' : 
'æ•°æ®åº“ä¿å­˜å¼‚å¸¸ï¼Œé—®é¢˜å¯èƒ½åœ¨ï¼š
1. å‰ç«¯å‘é€çš„æ•°æ®æ ¼å¼
2. åç«¯DTOæ˜ å°„
3. æ•°æ®åº“å­—æ®µæ˜ å°„'}
                </div>
            `;
        }

        // é¡µé¢åŠ è½½æ—¶çš„åˆå§‹åŒ–
        window.onload = function() {
            console.log('ğŸ” è®¢å•åˆ›å»ºè°ƒè¯•é¡µé¢å·²åŠ è½½');
        };
    </script>
</body>
</html>