<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¸æœºä½ç½®æ˜¾ç¤ºæµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #333;
        }
        button {
            background: #409EFF;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #66b1ff;
        }
        button.success {
            background: #67c23a;
        }
        button.danger {
            background: #f56c6c;
        }
        .status-display {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 14px;
            white-space: pre-wrap;
        }
        .status-good {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .status-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .checklist {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .checklist-item {
            margin: 5px 0;
            padding: 5px;
        }
        .checklist-item.pass {
            color: #155724;
        }
        .checklist-item.fail {
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš— å¸æœºä½ç½®æ˜¾ç¤ºæµ‹è¯•</h1>
        <p>ç”¨äºæµ‹è¯•ä¹˜å®¢ç«¯å¸æœºä½ç½®å’Œè·¯çº¿æ˜¾ç¤ºåŠŸèƒ½</p>
    </div>

    <div class="container">
        <div class="test-section">
            <h3>1. æµ‹è¯•ç¯å¢ƒæ£€æŸ¥</h3>
            <button onclick="checkEnvironment()">æ£€æŸ¥æµ‹è¯•ç¯å¢ƒ</button>
            
            <div id="environmentStatus" class="status-display">
                ç‚¹å‡»æŒ‰é’®æ£€æŸ¥æµ‹è¯•ç¯å¢ƒ...
            </div>
        </div>

        <div class="test-section">
            <h3>2. æ¨¡æ‹Ÿæ•°æ®è®¾ç½®</h3>
            <button onclick="setupMockData()">è®¾ç½®æ¨¡æ‹Ÿæ•°æ®</button>
            <button onclick="clearMockData()" class="danger">æ¸…é™¤æ•°æ®</button>
            
            <div id="mockDataStatus" class="status-display">
                æ¨¡æ‹Ÿæ•°æ®çŠ¶æ€: æœªè®¾ç½®
            </div>
        </div>

        <div class="test-section">
            <h3>3. å¸æœºä½ç½®æ˜¾ç¤ºæµ‹è¯•</h3>
            <button onclick="testDriverMarker()">æµ‹è¯•å¸æœºæ ‡è®°</button>
            <button onclick="testDriverRoute()">æµ‹è¯•å¸æœºè·¯çº¿</button>
            <button onclick="testDriverTracking()">æµ‹è¯•ä½ç½®è¿½è¸ª</button>
            
            <div id="driverTestResult" class="status-display">
                å¸æœºæ˜¾ç¤ºæµ‹è¯•ç»“æœ: æœªå¼€å§‹
            </div>
        </div>

        <div class="test-section">
            <h3>4. é—®é¢˜è¯Šæ–­</h3>
            <button onclick="diagnoseIssues()">è¯Šæ–­é—®é¢˜</button>
            
            <div id="diagnosisResult" class="checklist">
                <h4>è¯Šæ–­æ£€æŸ¥æ¸…å•:</h4>
                <div id="checklistItems">
                    ç‚¹å‡»è¯Šæ–­æŒ‰é’®å¼€å§‹æ£€æŸ¥...
                </div>
            </div>
        </div>

        <div class="test-section">
            <h3>5. ä¿®å¤å»ºè®®</h3>
            <div id="fixSuggestions" class="status-display">
                å®Œæˆè¯Šæ–­åå°†æ˜¾ç¤ºä¿®å¤å»ºè®®...
            </div>
        </div>
    </div>

    <div class="container">
        <h3>ğŸ“‹ æµ‹è¯•æ—¥å¿—</h3>
        <div id="testLog" style="background: #f8f9fa; padding: 15px; border-radius: 5px; font-family: monospace; font-size: 12px; max-height: 400px; overflow-y: auto;"></div>
    </div>

    <script>
        let mockOrder = null;
        let mockDriver = null;
        let testResults = {};

        function log(message, type = 'info') {
            const logDiv = document.getElementById('testLog');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}\\n`;
            logDiv.textContent += logEntry;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(logEntry);
        }

        function checkEnvironment() {
            const statusDiv = document.getElementById('environmentStatus');
            let status = 'æµ‹è¯•ç¯å¢ƒæ£€æŸ¥ç»“æœ:\\n\\n';
            let allGood = true;

            // æ£€æŸ¥å¿…è¦çš„å…¨å±€å˜é‡å’Œå‡½æ•°
            const checks = [
                { name: 'window.AMap', check: () => typeof window.AMap !== 'undefined' },
                { name: 'mapå®ä¾‹', check: () => typeof window.map !== 'undefined' && window.map },
                { name: 'showDriverOnMapå‡½æ•°', check: () => typeof window.showDriverOnMap === 'function' },
                { name: 'updateDriverRouteå‡½æ•°', check: () => typeof window.updateDriverRoute === 'function' },
                { name: 'startDriverTrackingå‡½æ•°', check: () => typeof window.startDriverTracking === 'function' },
                { name: 'restoreOrderMapElementså‡½æ•°', check: () => typeof window.restoreOrderMapElements === 'function' }
            ];

            checks.forEach(check => {
                const result = check.check();
                status += `${result ? 'âœ…' : 'âŒ'} ${check.name}: ${result ? 'æ­£å¸¸' : 'ç¼ºå¤±'}\\n`;
                if (!result) allGood = false;
            });

            status += `\\næ€»ä½“çŠ¶æ€: ${allGood ? 'âœ… ç¯å¢ƒæ­£å¸¸' : 'âŒ ç¯å¢ƒæœ‰é—®é¢˜'}`;
            
            statusDiv.textContent = status;
            statusDiv.className = allGood ? 'status-display status-good' : 'status-display status-error';
            
            testResults.environment = allGood;
            log(`ç¯å¢ƒæ£€æŸ¥å®Œæˆ: ${allGood ? 'é€šè¿‡' : 'å¤±è´¥'}`);
        }

        function setupMockData() {
            mockOrder = {
                id: 12345,
                orderNumber: 'ORDER12345',
                status: 'ASSIGNED',
                pickupAddress: 'åŒ—äº¬å¸‚æœé˜³åŒºä¸‰é‡Œå±¯',
                destinationAddress: 'åŒ—äº¬å¸‚æµ·æ·€åŒºä¸­å…³æ‘',
                pickupLatitude: 39.93428,
                pickupLongitude: 116.44857,
                destinationLatitude: 39.98279,
                destinationLongitude: 116.31038
            };

            mockDriver = {
                id: 1,
                driverId: 1,
                name: 'å¼ å¸ˆå‚…',
                phone: '13900139000',
                latitude: 39.93128,  // å¸æœºå½“å‰ä½ç½®ï¼ˆæ¥è¿‘ä¸Šè½¦ç‚¹ï¼‰
                longitude: 116.44557,
                rating: 4.8,
                vehicleInfo: 'äº¬A12345',
                carModel: 'å¤§ä¼—æœ—é€¸'
            };

            // æ¨¡æ‹Ÿè®¾ç½®åˆ°å…¨å±€storeï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            if (window.orderStore) {
                window.orderStore.setCurrentOrder(mockOrder);
                window.orderStore.setDriverInfo(mockDriver);
                window.orderStore.updateOrderStatus('ASSIGNED');
            }

            // æ¨¡æ‹Ÿè®¾ç½®åˆ°localStorage
            localStorage.setItem('currentOrder', JSON.stringify(mockOrder));
            localStorage.setItem('driverInfo', JSON.stringify(mockDriver));
            localStorage.setItem('orderStatus', 'ASSIGNED');

            const statusDiv = document.getElementById('mockDataStatus');
            statusDiv.innerHTML = `æ¨¡æ‹Ÿæ•°æ®å·²è®¾ç½®:
è®¢å•ID: ${mockOrder.id}
è®¢å•çŠ¶æ€: ${mockOrder.status}
å¸æœº: ${mockDriver.name}
å¸æœºä½ç½®: (${mockDriver.latitude}, ${mockDriver.longitude})`;
            statusDiv.className = 'status-display status-good';

            testResults.mockData = true;
            log('æ¨¡æ‹Ÿæ•°æ®è®¾ç½®å®Œæˆ');
        }

        function clearMockData() {
            mockOrder = null;
            mockDriver = null;

            // æ¸…é™¤localStorage
            localStorage.removeItem('currentOrder');
            localStorage.removeItem('driverInfo');
            localStorage.removeItem('orderStatus');

            // æ¸…é™¤å…¨å±€storeï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            if (window.orderStore) {
                window.orderStore.clearOrderState();
            }

            const statusDiv = document.getElementById('mockDataStatus');
            statusDiv.textContent = 'æ¨¡æ‹Ÿæ•°æ®çŠ¶æ€: å·²æ¸…é™¤';
            statusDiv.className = 'status-display';

            testResults.mockData = false;
            log('æ¨¡æ‹Ÿæ•°æ®å·²æ¸…é™¤');
        }

        function testDriverMarker() {
            const resultDiv = document.getElementById('driverTestResult');
            let result = 'å¸æœºæ ‡è®°æµ‹è¯•:\\n';

            if (!mockDriver) {
                result += 'âŒ é”™è¯¯: è¯·å…ˆè®¾ç½®æ¨¡æ‹Ÿæ•°æ®';
                resultDiv.textContent = result;
                resultDiv.className = 'status-display status-error';
                return;
            }

            try {
                if (typeof window.showDriverOnMap === 'function') {
                    window.showDriverOnMap(mockDriver.latitude, mockDriver.longitude);
                    result += 'âœ… showDriverOnMapå‡½æ•°è°ƒç”¨æˆåŠŸ\\n';
                    
                    // æ£€æŸ¥å¸æœºæ ‡è®°æ˜¯å¦åˆ›å»º
                    setTimeout(() => {
                        if (window.driverMarker) {
                            result += 'âœ… å¸æœºæ ‡è®°å·²åˆ›å»º\\n';
                            result += `ğŸ“ æ ‡è®°ä½ç½®: (${mockDriver.latitude}, ${mockDriver.longitude})\\n`;
                            testResults.driverMarker = true;
                        } else {
                            result += 'âŒ å¸æœºæ ‡è®°åˆ›å»ºå¤±è´¥\\n';
                            testResults.driverMarker = false;
                        }
                        
                        result += `\\næµ‹è¯•ç»“æœ: ${testResults.driverMarker ? 'âœ… é€šè¿‡' : 'âŒ å¤±è´¥'}`;
                        resultDiv.textContent = result;
                        resultDiv.className = testResults.driverMarker ? 'status-display status-good' : 'status-display status-error';
                    }, 1000);
                } else {
                    result += 'âŒ showDriverOnMapå‡½æ•°ä¸å­˜åœ¨';
                    testResults.driverMarker = false;
                }
            } catch (error) {
                result += `âŒ æµ‹è¯•å¼‚å¸¸: ${error.message}`;
                testResults.driverMarker = false;
            }

            if (!testResults.driverMarker) {
                resultDiv.textContent = result;
                resultDiv.className = 'status-display status-error';
            }

            log('å¸æœºæ ‡è®°æµ‹è¯•å®Œæˆ');
        }

        function testDriverRoute() {
            const resultDiv = document.getElementById('driverTestResult');
            let result = 'å¸æœºè·¯çº¿æµ‹è¯•:\\n';

            if (!mockDriver || !mockOrder) {
                result += 'âŒ é”™è¯¯: è¯·å…ˆè®¾ç½®æ¨¡æ‹Ÿæ•°æ®';
                resultDiv.textContent = result;
                resultDiv.className = 'status-display status-error';
                return;
            }

            try {
                if (typeof window.updateDriverRoute === 'function') {
                    window.updateDriverRoute(mockDriver.latitude, mockDriver.longitude);
                    result += 'âœ… updateDriverRouteå‡½æ•°è°ƒç”¨æˆåŠŸ\\n';
                    
                    // æ£€æŸ¥å¸æœºè·¯çº¿æ˜¯å¦åˆ›å»º
                    setTimeout(() => {
                        if (window.driverRouteLine) {
                            result += 'âœ… å¸æœºè·¯çº¿å·²åˆ›å»º\\n';
                            result += `ğŸ›£ï¸ è·¯çº¿: å¸æœº(${mockDriver.latitude}, ${mockDriver.longitude}) â†’ ä¸Šè½¦ç‚¹(${mockOrder.pickupLatitude}, ${mockOrder.pickupLongitude})\\n`;
                            testResults.driverRoute = true;
                        } else {
                            result += 'âŒ å¸æœºè·¯çº¿åˆ›å»ºå¤±è´¥\\n';
                            testResults.driverRoute = false;
                        }
                        
                        result += `\\næµ‹è¯•ç»“æœ: ${testResults.driverRoute ? 'âœ… é€šè¿‡' : 'âŒ å¤±è´¥'}`;
                        resultDiv.textContent = result;
                        resultDiv.className = testResults.driverRoute ? 'status-display status-good' : 'status-display status-error';
                    }, 2000);
                } else {
                    result += 'âŒ updateDriverRouteå‡½æ•°ä¸å­˜åœ¨';
                    testResults.driverRoute = false;
                }
            } catch (error) {
                result += `âŒ æµ‹è¯•å¼‚å¸¸: ${error.message}`;
                testResults.driverRoute = false;
            }

            if (!testResults.driverRoute) {
                resultDiv.textContent = result;
                resultDiv.className = 'status-display status-error';
            }

            log('å¸æœºè·¯çº¿æµ‹è¯•å®Œæˆ');
        }

        function testDriverTracking() {
            const resultDiv = document.getElementById('driverTestResult');
            let result = 'å¸æœºä½ç½®è¿½è¸ªæµ‹è¯•:\\n';

            if (!mockDriver) {
                result += 'âŒ é”™è¯¯: è¯·å…ˆè®¾ç½®æ¨¡æ‹Ÿæ•°æ®';
                resultDiv.textContent = result;
                resultDiv.className = 'status-display status-error';
                return;
            }

            try {
                if (typeof window.startDriverTracking === 'function') {
                    window.startDriverTracking();
                    result += 'âœ… startDriverTrackingå‡½æ•°è°ƒç”¨æˆåŠŸ\\n';
                    result += 'ğŸ”„ ä½ç½®è¿½è¸ªå·²å¯åŠ¨\\n';
                    
                    // æ¨¡æ‹Ÿä½ç½®æ›´æ–°
                    setTimeout(() => {
                        if (typeof window.updateDriverLocation === 'function') {
                            const newLocation = {
                                driverId: mockDriver.id,
                                latitude: mockDriver.latitude + 0.001,
                                longitude: mockDriver.longitude + 0.001
                            };
                            window.updateDriverLocation(newLocation);
                            result += 'âœ… æ¨¡æ‹Ÿä½ç½®æ›´æ–°æˆåŠŸ\\n';
                            testResults.driverTracking = true;
                        } else {
                            result += 'âŒ updateDriverLocationå‡½æ•°ä¸å­˜åœ¨\\n';
                            testResults.driverTracking = false;
                        }
                        
                        result += `\\næµ‹è¯•ç»“æœ: ${testResults.driverTracking ? 'âœ… é€šè¿‡' : 'âŒ å¤±è´¥'}`;
                        resultDiv.textContent = result;
                        resultDiv.className = testResults.driverTracking ? 'status-display status-good' : 'status-display status-error';
                    }, 1000);
                } else {
                    result += 'âŒ startDriverTrackingå‡½æ•°ä¸å­˜åœ¨';
                    testResults.driverTracking = false;
                    resultDiv.textContent = result;
                    resultDiv.className = 'status-display status-error';
                }
            } catch (error) {
                result += `âŒ æµ‹è¯•å¼‚å¸¸: ${error.message}`;
                testResults.driverTracking = false;
                resultDiv.textContent = result;
                resultDiv.className = 'status-display status-error';
            }

            log('å¸æœºä½ç½®è¿½è¸ªæµ‹è¯•å®Œæˆ');
        }

        function diagnoseIssues() {
            const checklistDiv = document.getElementById('checklistItems');
            let diagnosis = '';
            let issues = [];

            const diagnosticChecks = [
                {
                    name: 'åœ°å›¾APIåŠ è½½',
                    check: () => typeof window.AMap !== 'undefined',
                    fix: 'æ£€æŸ¥ç½‘ç»œè¿æ¥ï¼Œç¡®ä¿é«˜å¾·åœ°å›¾APIæ­£å¸¸åŠ è½½'
                },
                {
                    name: 'åœ°å›¾å®ä¾‹åˆå§‹åŒ–',
                    check: () => typeof window.map !== 'undefined' && window.map,
                    fix: 'æ£€æŸ¥åœ°å›¾å®¹å™¨æ˜¯å¦å­˜åœ¨ï¼ŒinitMapå‡½æ•°æ˜¯å¦æ­£å¸¸æ‰§è¡Œ'
                },
                {
                    name: 'å¸æœºä¿¡æ¯æ•°æ®',
                    check: () => mockDriver && mockDriver.latitude && mockDriver.longitude,
                    fix: 'ç¡®ä¿å¸æœºä¿¡æ¯åŒ…å«æœ‰æ•ˆçš„ç»çº¬åº¦åæ ‡'
                },
                {
                    name: 'è®¢å•çŠ¶æ€æ•°æ®',
                    check: () => mockOrder && mockOrder.pickupLatitude && mockOrder.pickupLongitude,
                    fix: 'ç¡®ä¿è®¢å•ä¿¡æ¯åŒ…å«æœ‰æ•ˆçš„ä¸Šè½¦ç‚¹åæ ‡'
                },
                {
                    name: 'showDriverOnMapå‡½æ•°',
                    check: () => typeof window.showDriverOnMap === 'function',
                    fix: 'æ£€æŸ¥PassengerMap.vueä¸­æ˜¯å¦æ­£ç¡®å®šä¹‰äº†showDriverOnMapå‡½æ•°'
                },
                {
                    name: 'updateDriverRouteå‡½æ•°',
                    check: () => typeof window.updateDriverRoute === 'function',
                    fix: 'æ£€æŸ¥PassengerMap.vueä¸­æ˜¯å¦æ­£ç¡®å®šä¹‰äº†updateDriverRouteå‡½æ•°'
                },
                {
                    name: 'WebSocketè¿æ¥',
                    check: () => window.stompClient && window.stompClient.connected,
                    fix: 'æ£€æŸ¥WebSocketè¿æ¥çŠ¶æ€ï¼Œç¡®ä¿èƒ½æ¥æ”¶å¸æœºä½ç½®æ›´æ–°'
                },
                {
                    name: 'StoreçŠ¶æ€ç®¡ç†',
                    check: () => window.orderStore && typeof window.orderStore.setDriverInfo === 'function',
                    fix: 'æ£€æŸ¥Pinia storeæ˜¯å¦æ­£ç¡®åˆå§‹åŒ–å’Œå¯¼å‡º'
                }
            ];

            diagnosticChecks.forEach(check => {
                const passed = check.check();
                const itemClass = passed ? 'checklist-item pass' : 'checklist-item fail';
                const icon = passed ? 'âœ…' : 'âŒ';
                
                diagnosis += `<div class="${itemClass}">${icon} ${check.name}: ${passed ? 'æ­£å¸¸' : 'å¼‚å¸¸'}</div>`;
                
                if (!passed) {
                    issues.push({
                        name: check.name,
                        fix: check.fix
                    });
                }
            });

            checklistDiv.innerHTML = diagnosis;

            // æ˜¾ç¤ºä¿®å¤å»ºè®®
            const fixDiv = document.getElementById('fixSuggestions');
            if (issues.length === 0) {
                fixDiv.textContent = 'âœ… æ‰€æœ‰æ£€æŸ¥é¡¹éƒ½æ­£å¸¸ï¼Œå¸æœºä½ç½®æ˜¾ç¤ºåº”è¯¥å¯ä»¥æ­£å¸¸å·¥ä½œã€‚';
                fixDiv.className = 'status-display status-good';
            } else {
                let suggestions = 'å‘ç°ä»¥ä¸‹é—®é¢˜ï¼Œå»ºè®®ä¿®å¤:\\n\\n';
                issues.forEach((issue, index) => {
                    suggestions += `${index + 1}. ${issue.name}:\\n   ${issue.fix}\\n\\n`;
                });
                fixDiv.textContent = suggestions;
                fixDiv.className = 'status-display status-error';
            }

            log(`è¯Šæ–­å®Œæˆï¼Œå‘ç° ${issues.length} ä¸ªé—®é¢˜`);
        }

        // é¡µé¢åŠ è½½æ—¶çš„åˆå§‹åŒ–
        window.onload = function() {
            log('å¸æœºä½ç½®æ˜¾ç¤ºæµ‹è¯•å·¥å…·å·²åŠ è½½');
            
            log('æµ‹è¯•è¯´æ˜:');
            log('1. é¦–å…ˆæ£€æŸ¥æµ‹è¯•ç¯å¢ƒ');
            log('2. è®¾ç½®æ¨¡æ‹Ÿæ•°æ®');
            log('3. é€é¡¹æµ‹è¯•å¸æœºæ˜¾ç¤ºåŠŸèƒ½');
            log('4. è¯Šæ–­é—®é¢˜å¹¶æŸ¥çœ‹ä¿®å¤å»ºè®®');
        };
    </script>
</body>
</html>"