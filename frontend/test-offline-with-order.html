<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¸æœºä¸‹çº¿è®¢å•ä¿æŒæµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #333;
        }
        button {
            background: #409EFF;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #66b1ff;
        }
        button.danger {
            background: #f56c6c;
        }
        button.success {
            background: #67c23a;
        }
        button.warning {
            background: #e6a23c;
        }
        .result-display {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 14px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .status-good {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .status-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .status-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        .scenario {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 4px solid #2196f3;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“´ å¸æœºä¸‹çº¿è®¢å•ä¿æŒæµ‹è¯•</h1>
        <p>æµ‹è¯•å¸æœºä¸‹çº¿æ—¶æ˜¯å¦æ­£ç¡®ä¿æŒè¿›è¡Œä¸­çš„è®¢å•</p>
    </div>

    <div class="container">
        <h2>ğŸ”§ ä¿®å¤è¯´æ˜</h2>
        <div class="test-section">
            <h3>é—®é¢˜æè¿°</h3>
            <p>å¸æœºä¸‹çº¿åï¼Œå¸æœºç«¯å°±æ²¡æœ‰è¿™ä¸ªè®¢å•äº†ï¼Œä½†å®é™…ä¸Šå¸æœºä¸‹çº¿åº”è¯¥åªå†³å®šèƒ½å¦æ¥åˆ°æ–°è®¢å•æ¨é€ï¼Œè€Œä¸æ˜¯ç›´æ¥å…³é—­WebSocketè¿æ¥ã€‚</p>
            
            <h3>ä¿®å¤æ–¹æ¡ˆ</h3>
            <ul>
                <li><strong>æœ‰è¿›è¡Œä¸­è®¢å•æ—¶ï¼š</strong>å¸æœºä¸‹çº¿åªæ¸…ç†å¾…å¤„ç†è®¢å•ï¼Œä¿æŒWebSocketè¿æ¥å’Œå½“å‰è®¢å•</li>
                <li><strong>æ— è¿›è¡Œä¸­è®¢å•æ—¶ï¼š</strong>å¸æœºä¸‹çº¿æ­£å¸¸æ–­å¼€WebSocketè¿æ¥</li>
                <li><strong>é¡µé¢åˆ·æ–°æ—¶ï¼š</strong>å¦‚æœæœ‰è¿›è¡Œä¸­è®¢å•ï¼Œå³ä½¿å¸æœºä¸‹çº¿ä¹Ÿè¦è¿æ¥WebSocket</li>
            </ul>
            
            <h3>ä¸šåŠ¡é€»è¾‘</h3>
            <div class="scenario">
                <h4>åœºæ™¯1ï¼šå¸æœºæœ‰è¿›è¡Œä¸­è®¢å•æ—¶ä¸‹çº¿</h4>
                <ul>
                    <li>âœ… ä¿æŒWebSocketè¿æ¥ï¼ˆæ¥æ”¶è®¢å•çŠ¶æ€æ›´æ–°ï¼‰</li>
                    <li>âœ… ä¿æŒå½“å‰è®¢å•æ˜¾ç¤º</li>
                    <li>âœ… æ¸…ç†å¾…å¤„ç†è®¢å•åˆ—è¡¨</li>
                    <li>âœ… åœæ­¢æ¥æ”¶æ–°è®¢å•æ¨é€</li>
                    <li>âœ… æ˜¾ç¤ºè­¦å‘Šæç¤º</li>
                </ul>
            </div>
            
            <div class="scenario">
                <h4>åœºæ™¯2ï¼šå¸æœºæ— è¿›è¡Œä¸­è®¢å•æ—¶ä¸‹çº¿</h4>
                <ul>
                    <li>âœ… æ–­å¼€WebSocketè¿æ¥</li>
                    <li>âœ… æ¸…ç†å¾…å¤„ç†è®¢å•åˆ—è¡¨</li>
                    <li>âœ… åœæ­¢ä½ç½®è¿½è¸ª</li>
                </ul>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="test-section">
            <h3>1. æ¨¡æ‹Ÿå¸æœºæ¥å•</h3>
            <button onclick="createAndAcceptOrder()">åˆ›å»ºè®¢å•å¹¶æ¥å•</button>
            <button onclick="checkCurrentOrder()">æ£€æŸ¥å½“å‰è®¢å•</button>
            
            <div id="orderResult" class="result-display">
                ç‚¹å‡»æŒ‰é’®æ¨¡æ‹Ÿå¸æœºæ¥å•...
            </div>
        </div>

        <div class="test-section">
            <h3>2. æµ‹è¯•æœ‰è®¢å•æ—¶ä¸‹çº¿</h3>
            <button onclick="testOfflineWithOrder()" class="warning">å¸æœºä¸‹çº¿ï¼ˆæœ‰è®¢å•ï¼‰</button>
            <button onclick="checkWebSocketStatus()">æ£€æŸ¥WebSocketçŠ¶æ€</button>
            
            <div id="offlineResult" class="result-display">
                ç‚¹å‡»æŒ‰é’®æµ‹è¯•æœ‰è®¢å•æ—¶ä¸‹çº¿...
            </div>
        </div>

        <div class="test-section">
            <h3>3. æµ‹è¯•è®¢å•çŠ¶æ€æ›´æ–°</h3>
            <button onclick="updateOrderStatus()">æ›´æ–°è®¢å•çŠ¶æ€</button>
            <button onclick="cancelOrderTest()">å–æ¶ˆè®¢å•æµ‹è¯•</button>
            
            <div id="updateResult" class="result-display">
                ç‚¹å‡»æŒ‰é’®æµ‹è¯•è®¢å•çŠ¶æ€æ›´æ–°...
            </div>
        </div>

        <div class="test-section">
            <h3>4. æµ‹è¯•æ— è®¢å•æ—¶ä¸‹çº¿</h3>
            <button onclick="completeOrderAndOffline()">å®Œæˆè®¢å•åä¸‹çº¿</button>
            <button onclick="testOfflineWithoutOrder()" class="danger">å¸æœºä¸‹çº¿ï¼ˆæ— è®¢å•ï¼‰</button>
            
            <div id="noOrderResult" class="result-display">
                ç‚¹å‡»æŒ‰é’®æµ‹è¯•æ— è®¢å•æ—¶ä¸‹çº¿...
            </div>
        </div>
    </div>

    <div class="container">
        <h2>ğŸ“‹ æµ‹è¯•æ£€æŸ¥æ¸…å•</h2>
        <div class="test-section">
            <h3>éªŒè¯è¦ç‚¹</h3>
            <ul>
                <li>â–¡ å¸æœºæœ‰è¿›è¡Œä¸­è®¢å•æ—¶ä¸‹çº¿ï¼Œè®¢å•ä»ç„¶æ˜¾ç¤º</li>
                <li>â–¡ å¸æœºä¸‹çº¿åä»èƒ½æ”¶åˆ°è®¢å•çŠ¶æ€æ›´æ–°é€šçŸ¥</li>
                <li>â–¡ å¸æœºä¸‹çº¿åä»èƒ½æ”¶åˆ°ä¹˜å®¢å–æ¶ˆè®¢å•é€šçŸ¥</li>
                <li>â–¡ å¸æœºä¸‹çº¿åä¸ä¼šæ”¶åˆ°æ–°è®¢å•æ¨é€</li>
                <li>â–¡ å¸æœºæ— è®¢å•æ—¶ä¸‹çº¿ï¼ŒWebSocketæ­£å¸¸æ–­å¼€</li>
                <li>â–¡ é¡µé¢åˆ·æ–°åï¼Œæœ‰è®¢å•çš„ä¸‹çº¿å¸æœºä»èƒ½æ¢å¤è¿æ¥</li>
            </ul>
        </div>
    </div>

    <script>
        let testOrderId = null;
        let wsMonitor = null;

        function log(message, containerId) {
            const container = document.getElementById(containerId);
            const timestamp = new Date().toLocaleTimeString();
            container.textContent += `[${timestamp}] ${message}\\n`;
            container.scrollTop = container.scrollHeight;
            console.log(message);
        }

        async function createAndAcceptOrder() {
            const resultDiv = document.getElementById('orderResult');
            resultDiv.textContent = '';
            resultDiv.className = 'result-display';
            
            log('ğŸ“‹ åˆ›å»ºæµ‹è¯•è®¢å•...', 'orderResult');
            
            try {
                // 1. åˆ›å»ºè®¢å•
                const orderData = {
                    passengerId: 1,
                    pickupAddress: 'ä¸‹çº¿æµ‹è¯•è®¢å• - å¤§è¿ç†å·¥å¤§å­¦',
                    pickupLatitude: 39.044237,
                    pickupLongitude: 121.749849,
                    destinationAddress: 'æµ‹è¯•ç›®çš„åœ° - å¤§è¿ç«è½¦ç«™',
                    destinationLatitude: 39.054237,
                    destinationLongitude: 121.759849
                };
                
                const orderResponse = await fetch('/api/orders/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(orderData)
                });
                
                if (orderResponse.ok) {
                    const orderResult = await orderResponse.json();
                    testOrderId = orderResult.data;
                    log(`âœ… è®¢å•åˆ›å»ºæˆåŠŸï¼ŒID: ${testOrderId}`, 'orderResult');
                    
                    // 2. å¸æœºæ¥å•
                    log('ğŸš— å¸æœºæ¥å•...', 'orderResult');
                    const acceptResponse = await fetch(`/api/drivers/1/accept-order/${testOrderId}`, {
                        method: 'POST'
                    });
                    
                    if (acceptResponse.ok) {
                        log('âœ… å¸æœºæ¥å•æˆåŠŸ', 'orderResult');
                        log('è®¢å•çŠ¶æ€: ASSIGNED', 'orderResult');
                        resultDiv.className = 'result-display status-good';
                    } else {
                        log(`âŒ å¸æœºæ¥å•å¤±è´¥: ${acceptResponse.status}`, 'orderResult');
                        resultDiv.className = 'result-display status-error';
                    }
                } else {
                    log(`âŒ è®¢å•åˆ›å»ºå¤±è´¥: ${orderResponse.status}`, 'orderResult');
                    resultDiv.className = 'result-display status-error';
                }
            } catch (error) {
                log(`âŒ æ“ä½œå¼‚å¸¸: ${error.message}`, 'orderResult');
                resultDiv.className = 'result-display status-error';
            }
        }

        async function checkCurrentOrder() {
            log('ğŸ” æ£€æŸ¥å½“å‰è®¢å•çŠ¶æ€...', 'orderResult');
            
            if (!testOrderId) {
                log('âŒ è¯·å…ˆåˆ›å»ºå¹¶æ¥å•', 'orderResult');
                return;
            }
            
            try {
                const response = await fetch(`/api/orders/${testOrderId}`);
                if (response.ok) {
                    const result = await response.json();
                    const order = result.data;
                    log(`è®¢å•çŠ¶æ€: ${order.status}`, 'orderResult');
                    log(`å¸æœºID: ${order.driverId}`, 'orderResult');
                    log(`è®¢å•å·: ${order.orderNumber}`, 'orderResult');
                } else {
                    log(`âŒ æ£€æŸ¥è®¢å•å¤±è´¥: ${response.status}`, 'orderResult');
                }
            } catch (error) {
                log(`âŒ æ£€æŸ¥è®¢å•å¼‚å¸¸: ${error.message}`, 'orderResult');
            }
        }

        async function testOfflineWithOrder() {
            const resultDiv = document.getElementById('offlineResult');
            resultDiv.textContent = '';
            resultDiv.className = 'result-display';
            
            log('ğŸ“´ æµ‹è¯•æœ‰è®¢å•æ—¶å¸æœºä¸‹çº¿...', 'offlineResult');
            
            if (!testOrderId) {
                log('âŒ è¯·å…ˆåˆ›å»ºå¹¶æ¥å•', 'offlineResult');
                resultDiv.className = 'result-display status-error';
                return;
            }
            
            try {
                // å¸æœºä¸‹çº¿
                const response = await fetch('/api/drivers/1/offline', {
                    method: 'POST'
                });
                
                if (response.ok) {
                    log('âœ… å¸æœºä¸‹çº¿æˆåŠŸ', 'offlineResult');
                    log('\\né¢„æœŸè¡Œä¸º:', 'offlineResult');
                    log('- WebSocketè¿æ¥åº”è¯¥ä¿æŒ', 'offlineResult');
                    log('- å½“å‰è®¢å•åº”è¯¥ä¿ç•™', 'offlineResult');
                    log('- å¾…å¤„ç†è®¢å•åˆ—è¡¨åº”è¯¥æ¸…ç©º', 'offlineResult');
                    log('- åº”è¯¥æ˜¾ç¤ºè­¦å‘Šæç¤º', 'offlineResult');
                    
                    resultDiv.className = 'result-display status-warning';
                } else {
                    log(`âŒ å¸æœºä¸‹çº¿å¤±è´¥: ${response.status}`, 'offlineResult');
                    resultDiv.className = 'result-display status-error';
                }
            } catch (error) {
                log(`âŒ ä¸‹çº¿æ“ä½œå¼‚å¸¸: ${error.message}`, 'offlineResult');
                resultDiv.className = 'result-display status-error';
            }
        }

        function checkWebSocketStatus() {
            log('\\nğŸ”Œ æ£€æŸ¥WebSocketè¿æ¥çŠ¶æ€...', 'offlineResult');
            
            // è¿™é‡Œå¯ä»¥é€šè¿‡å¼€å‘è€…å·¥å…·çš„Networkæ ‡ç­¾æŸ¥çœ‹WebSocketè¿æ¥
            log('è¯·æ£€æŸ¥æµè§ˆå™¨å¼€å‘è€…å·¥å…·çš„Networkæ ‡ç­¾', 'offlineResult');
            log('åº”è¯¥èƒ½çœ‹åˆ°WebSocketè¿æ¥ä»ç„¶å­˜åœ¨', 'offlineResult');
            
            // å°è¯•å»ºç«‹æµ‹è¯•è¿æ¥
            try {
                const testWs = new WebSocket('ws://localhost:8080/ws/driver/1');
                
                testWs.onopen = function() {
                    log('âœ… WebSocketæµ‹è¯•è¿æ¥æˆåŠŸ', 'offlineResult');
                    testWs.close();
                };
                
                testWs.onerror = function() {
                    log('âŒ WebSocketæµ‹è¯•è¿æ¥å¤±è´¥', 'offlineResult');
                };
                
            } catch (error) {
                log(`âŒ WebSocketæµ‹è¯•å¼‚å¸¸: ${error.message}`, 'offlineResult');
            }
        }

        async function updateOrderStatus() {
            const resultDiv = document.getElementById('updateResult');
            resultDiv.textContent = '';
            resultDiv.className = 'result-display';
            
            log('ğŸ”„ æµ‹è¯•è®¢å•çŠ¶æ€æ›´æ–°...', 'updateResult');
            
            if (!testOrderId) {
                log('âŒ è¯·å…ˆåˆ›å»ºå¹¶æ¥å•', 'updateResult');
                resultDiv.className = 'result-display status-error';
                return;
            }
            
            try {
                // æ¨¡æ‹Ÿç¡®è®¤åˆ°è¾¾
                const response = await fetch(`/api/orders/${testOrderId}/pickup`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    log('âœ… è®¢å•çŠ¶æ€æ›´æ–°ä¸ºPICKUP', 'updateResult');
                    log('å¸æœºç«¯åº”è¯¥æ”¶åˆ°çŠ¶æ€æ›´æ–°é€šçŸ¥', 'updateResult');
                    resultDiv.className = 'result-display status-good';
                } else {
                    log(`âŒ çŠ¶æ€æ›´æ–°å¤±è´¥: ${response.status}`, 'updateResult');
                    resultDiv.className = 'result-display status-error';
                }
            } catch (error) {
                log(`âŒ çŠ¶æ€æ›´æ–°å¼‚å¸¸: ${error.message}`, 'updateResult');
                resultDiv.className = 'result-display status-error';
            }
        }

        async function cancelOrderTest() {
            log('\\nâŒ æµ‹è¯•ä¹˜å®¢å–æ¶ˆè®¢å•...', 'updateResult');
            
            if (!testOrderId) {
                log('âŒ è¯·å…ˆåˆ›å»ºå¹¶æ¥å•', 'updateResult');
                return;
            }
            
            try {
                const response = await fetch(`/api/orders/${testOrderId}/cancel`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    log('âœ… ä¹˜å®¢å–æ¶ˆè®¢å•æˆåŠŸ', 'updateResult');
                    log('å¸æœºç«¯åº”è¯¥æ”¶åˆ°å–æ¶ˆé€šçŸ¥', 'updateResult');
                    log('è®¢å•çŠ¶æ€åº”è¯¥è¢«æ¸…ç†', 'updateResult');
                } else {
                    log(`âŒ å–æ¶ˆè®¢å•å¤±è´¥: ${response.status}`, 'updateResult');
                }
            } catch (error) {
                log(`âŒ å–æ¶ˆè®¢å•å¼‚å¸¸: ${error.message}`, 'updateResult');
            }
        }

        async function completeOrderAndOffline() {
            const resultDiv = document.getElementById('noOrderResult');
            resultDiv.textContent = '';
            resultDiv.className = 'result-display';
            
            log('âœ… æ¨¡æ‹Ÿå®Œæˆè®¢å•...', 'noOrderResult');
            
            if (!testOrderId) {
                log('âŒ è¯·å…ˆåˆ›å»ºå¹¶æ¥å•', 'noOrderResult');
                resultDiv.className = 'result-display status-error';
                return;
            }
            
            try {
                // å®Œæˆè®¢å•
                const response = await fetch(`/api/orders/${testOrderId}/complete`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    log('âœ… è®¢å•å®Œæˆ', 'noOrderResult');
                    testOrderId = null; // æ¸…é™¤æµ‹è¯•è®¢å•ID
                    resultDiv.className = 'result-display status-good';
                } else {
                    log(`âŒ å®Œæˆè®¢å•å¤±è´¥: ${response.status}`, 'noOrderResult');
                    resultDiv.className = 'result-display status-error';
                }
            } catch (error) {
                log(`âŒ å®Œæˆè®¢å•å¼‚å¸¸: ${error.message}`, 'noOrderResult');
                resultDiv.className = 'result-display status-error';
            }
        }

        async function testOfflineWithoutOrder() {
            log('\\nğŸ“´ æµ‹è¯•æ— è®¢å•æ—¶å¸æœºä¸‹çº¿...', 'noOrderResult');
            
            try {
                const response = await fetch('/api/drivers/1/offline', {
                    method: 'POST'
                });
                
                if (response.ok) {
                    log('âœ… å¸æœºä¸‹çº¿æˆåŠŸ', 'noOrderResult');
                    log('\\né¢„æœŸè¡Œä¸º:', 'noOrderResult');
                    log('- WebSocketè¿æ¥åº”è¯¥æ–­å¼€', 'noOrderResult');
                    log('- å¾…å¤„ç†è®¢å•åˆ—è¡¨åº”è¯¥æ¸…ç©º', 'noOrderResult');
                    log('- ä½ç½®è¿½è¸ªåº”è¯¥åœæ­¢', 'noOrderResult');
                    
                    document.getElementById('noOrderResult').className = 'result-display status-good';
                } else {
                    log(`âŒ å¸æœºä¸‹çº¿å¤±è´¥: ${response.status}`, 'noOrderResult');
                    document.getElementById('noOrderResult').className = 'result-display status-error';
                }
            } catch (error) {
                log(`âŒ ä¸‹çº¿æ“ä½œå¼‚å¸¸: ${error.message}`, 'noOrderResult');
                document.getElementById('noOrderResult').className = 'result-display status-error';
            }
        }

        // é¡µé¢åŠ è½½æ—¶çš„è¯´æ˜
        window.onload = function() {
            log('é¡µé¢åŠ è½½å®Œæˆï¼Œè¯·æŒ‰é¡ºåºè¿›è¡Œæµ‹è¯•', 'orderResult');
            log('1. å…ˆåˆ›å»ºè®¢å•å¹¶æ¥å•', 'orderResult');
            log('2. ç„¶åæµ‹è¯•æœ‰è®¢å•æ—¶ä¸‹çº¿', 'orderResult');
            log('3. éªŒè¯è®¢å•çŠ¶æ€æ›´æ–°åŠŸèƒ½', 'orderResult');
            log('4. æœ€åæµ‹è¯•æ— è®¢å•æ—¶ä¸‹çº¿', 'orderResult');
        };
    </script>
</body>
</html>