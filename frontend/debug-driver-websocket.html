<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>司机WebSocket调试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .debug-section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .debug-section h3 {
            margin-top: 0;
            color: #333;
        }
        button {
            background: #409EFF;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #66b1ff;
        }
        button.success {
            background: #67c23a;
        }
        button.danger {
            background: #f56c6c;
        }
        .status-display {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 14px;
            white-space: pre-wrap;
        }
        .status-good {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .status-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .checklist {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .checklist-item {
            margin: 8px 0;
            padding: 5px;
        }
        .debug-code {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            margin: 10px 0;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🚗 司机WebSocket连接调试</h1>
        <p>诊断司机端无法收到订单通知的问题</p>
    </div>

    <div class="container">
        <div class="debug-section">
            <h3>1. 问题诊断清单</h3>
            <button onclick="diagnoseIssues()">开始诊断</button>
            
            <div class="checklist">
                <h4>🔍 需要检查的问题点:</h4>
                <div id="diagnosisItems">
                    <div class="checklist-item">📡 司机是否已上线</div>
                    <div class="checklist-item">🔌 WebSocket连接是否建立</div>
                    <div class="checklist-item">📨 订阅路径是否正确</div>
                    <div class="checklist-item">🆔 司机ID是否匹配</div>
                    <div class="checklist-item">🎯 消息处理函数是否注册</div>
                    <div class="checklist-item">🚪 退出登录是否自动下线</div>
                </div>
            </div>
        </div>

        <div class="debug-section">
            <h3>2. 司机状态检查</h3>
            <button onclick="checkDriverStatus()">检查司机状态</button>
            
            <div id="driverStatus" class="status-display">
                点击按钮检查司机状态...
            </div>
        </div>

        <div class="debug-section">
            <h3>3. WebSocket连接检查</h3>
            <button onclick="checkWebSocketConnection()">检查WebSocket连接</button>
            <button onclick="testWebSocketMessage()">测试消息接收</button>
            
            <div id="websocketStatus" class="status-display">
                点击按钮检查WebSocket连接...
            </div>
        </div>

        <div class="debug-section">
            <h3>4. 调试命令</h3>
            <p>在浏览器控制台执行以下命令来调试：</p>
            
            <div class="debug-code">
// 检查司机store状态
if (window.driverStore) {
    console.log("司机在线状态:", window.driverStore.isOnline);
    console.log("司机ID:", window.driverStore.currentPosition);
    console.log("当前订单:", window.driverStore.currentOrder);
    console.log("待处理订单:", window.driverStore.pendingOrders);
} else {
    console.log("❌ driverStore未找到");
}

// 检查用户信息
if (window.userStore) {
    console.log("用户信息:", window.userStore.user);
    console.log("用户类型:", window.userStore.userType);
    console.log("是否司机:", window.userStore.isDriver);
} else {
    console.log("❌ userStore未找到");
}

// 检查WebSocket连接
console.log("全局消息处理函数:", typeof window.handleDriverMapUpdate);

// 手动触发WebSocket连接
if (window.driverStore && typeof window.driverStore.connectWebSocket === 'function') {
    window.driverStore.connectWebSocket();
    console.log("✅ 已手动触发WebSocket连接");
}
            </div>
            <button onclick="copyToClipboard(this.previousElementSibling.textContent)">复制调试命令</button>
        </div>

        <div class="debug-section">
            <h3>5. 修复建议</h3>
            <div id="fixSuggestions" class="status-display">
                完成诊断后将显示修复建议...
            </div>
        </div>
    </div>

    <div class="container">
        <h3>📋 调试日志</h3>
        <div id="debugLog" style="background: #f8f9fa; padding: 15px; border-radius: 5px; font-family: monospace; font-size: 12px; max-height: 400px; overflow-y: auto;"></div>
    </div>

    <script>
        function log(message, type = 'info') {
            const logDiv = document.getElementById('debugLog');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}\\n`;
            logDiv.textContent += logEntry;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(logEntry);
        }

        function diagnoseIssues() {
            log('开始诊断司机WebSocket连接问题...');
            
            const issues = [];
            
            // 检查司机store
            if (typeof window.driverStore === 'undefined') {
                issues.push('❌ driverStore未初始化');
            } else {
                log('✅ driverStore已初始化');
            }
            
            // 检查用户信息
            if (typeof window.userStore === 'undefined' || !window.userStore.user) {
                issues.push('❌ 用户信息缺失');
            } else if (window.userStore.userType !== 'DRIVER') {
                issues.push('❌ 当前用户不是司机');
            } else {
                log('✅ 用户信息正常，用户类型为司机');
            }
            
            // 检查全局消息处理函数
            if (typeof window.handleDriverMapUpdate !== 'function') {
                issues.push('❌ 全局消息处理函数未注册');
            } else {
                log('✅ 全局消息处理函数已注册');
            }
            
            const itemsDiv = document.getElementById('diagnosisItems');
            let content = '<h4>🔍 诊断结果:</h4>';
            
            if (issues.length === 0) {
                content += '<div class="checklist-item" style="color: #155724;">✅ 基础检查通过</div>';
            } else {
                issues.forEach(issue => {
                    content += `<div class="checklist-item" style="color: #721c24;">${issue}</div>`;
                });
            }
            
            itemsDiv.innerHTML = content;
            log(`诊断完成，发现 ${issues.length} 个问题`);
        }

        function checkDriverStatus() {
            const statusDiv = document.getElementById('driverStatus');
            let status = '司机状态检查结果:\\n\\n';
            
            try {
                if (window.driverStore) {
                    status += `在线状态: ${window.driverStore.isOnline ? '✅ 在线' : '❌ 离线'}\\n`;
                    status += `当前位置: ${JSON.stringify(window.driverStore.currentPosition)}\\n`;
                    status += `今日收入: ¥${window.driverStore.todayEarnings}\\n`;
                    status += `完成订单: ${window.driverStore.completedOrders}\\n`;
                    status += `当前订单: ${window.driverStore.currentOrder ? '有' : '无'}\\n`;
                    status += `待处理订单: ${window.driverStore.pendingOrders.length}个\\n`;
                    
                    if (window.userStore && window.userStore.user) {
                        status += `\\n用户信息:\\n`;
                        status += `司机ID: ${window.userStore.user.driverId || window.userStore.user.id}\\n`;
                        status += `用户类型: ${window.userStore.user.userType}\\n`;
                    }
                } else {
                    status += '❌ driverStore未找到';
                }
            } catch (error) {
                status += `❌ 检查失败: ${error.message}`;
            }
            
            statusDiv.textContent = status;
            statusDiv.className = window.driverStore?.isOnline ? 'status-display status-good' : 'status-display status-error';
            log('司机状态检查完成');
        }

        function checkWebSocketConnection() {
            const statusDiv = document.getElementById('websocketStatus');
            let status = 'WebSocket连接检查结果:\\n\\n';
            
            try {
                // 检查连接状态
                status += '连接状态检查:\\n';
                status += `全局消息处理函数: ${typeof window.handleDriverMapUpdate === 'function' ? '✅ 已注册' : '❌ 未注册'}\\n`;
                
                if (window.driverStore) {
                    status += `司机在线状态: ${window.driverStore.isOnline ? '✅ 在线' : '❌ 离线'}\\n`;
                    
                    // 检查用户ID
                    if (window.userStore && window.userStore.user) {
                        const driverId = window.userStore.user.driverId || window.userStore.user.id;
                        status += `司机ID: ${driverId}\\n`;
                        status += `订阅路径: /user/${driverId}/queue/orders\\n`;
                    }
                    
                    status += '\\n建议操作:\\n';
                    if (!window.driverStore.isOnline) {
                        status += '1. 请先上线司机状态\\n';
                    }
                    status += '2. 检查浏览器控制台的WebSocket连接日志\\n';
                    status += '3. 确认后端是否正确发送消息\\n';
                } else {
                    status += '❌ driverStore未初始化';
                }
            } catch (error) {
                status += `❌ 检查失败: ${error.message}`;
            }
            
            statusDiv.textContent = status;
            log('WebSocket连接检查完成');
        }

        function testWebSocketMessage() {
            log('测试WebSocket消息接收...');
            
            if (window.handleDriverMapUpdate) {
                // 模拟一个新订单消息
                const testMessage = {
                    type: 'NEW_ORDER',
                    orderId: '12345',
                    orderNumber: 'TEST001',
                    pickupAddress: '测试上车点',
                    destinationAddress: '测试目的地',
                    distance: '2.5',
                    estimatedFare: '25.00',
                    timestamp: Date.now()
                };
                
                try {
                    window.handleDriverMapUpdate(testMessage);
                    log('✅ 测试消息发送成功');
                } catch (error) {
                    log(`❌ 测试消息处理失败: ${error.message}`);
                }
            } else {
                log('❌ 全局消息处理函数不存在');
            }
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('调试命令已复制到剪贴板！');
            }).catch(err => {
                console.error('复制失败:', err);
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('调试命令已复制到剪贴板！');
            });
        }

        // 页面加载时的初始化
        window.onload = function() {
            log('司机WebSocket调试工具已加载');
            
            log('常见问题排查:');
            log('1. 司机是否已上线？');
            log('2. WebSocket连接是否建立？');
            log('3. 订阅路径是否正确？');
            log('4. 消息处理函数是否注册？');
        };
    </script>
</body>
</html>"