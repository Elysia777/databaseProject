<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¹˜å®¢å–æ¶ˆè®¢å• - å¸æœºç«¯æ¸…ç†æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-section {
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 15px;
            margin: 10px 0;
        }
        .test-section h3 {
            margin-top: 0;
            color: #333;
        }
        .step {
            background: #f8f9fa;
            padding: 10px;
            margin: 8px 0;
            border-left: 4px solid #007bff;
            border-radius: 4px;
        }
        .expected {
            background: #d4edda;
            border-left-color: #28a745;
        }
        .warning {
            background: #fff3cd;
            border-left-color: #ffc107;
            color: #856404;
        }
        .error {
            background: #f8d7da;
            border-left-color: #dc3545;
            color: #721c24;
        }
        .success {
            background: #d1ecf1;
            border-left-color: #17a2b8;
            color: #0c5460;
        }
        .code {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            border: 1px solid #e9ecef;
            margin: 10px 0;
        }
        .highlight {
            background: #fff3cd;
            padding: 2px 4px;
            border-radius: 3px;
        }
        .debug-info {
            background: #e7f3ff;
            border: 1px solid #b3d9ff;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
        }
        .debug-info h4 {
            margin-top: 0;
            color: #0066cc;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-pending { background-color: #ffc107; }
        .status-success { background-color: #28a745; }
        .status-error { background-color: #dc3545; }
        .status-info { background-color: #17a2b8; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš« ä¹˜å®¢å–æ¶ˆè®¢å• - å¸æœºç«¯æ¸…ç†æµ‹è¯•</h1>
        <p>æµ‹è¯•ä¹˜å®¢å–æ¶ˆè®¢å•åï¼Œå¸æœºç«¯æ˜¯å¦æ­£ç¡®æ¥æ”¶é€šçŸ¥å¹¶æ¸…ç†è·¯å¾„è§„åˆ’å’Œåœ°å›¾æ ‡è®°ã€‚</p>
    </div>

    <div class="container">
        <div class="test-section">
            <h3>ğŸ“‹ æµ‹è¯•åœºæ™¯</h3>
            <div class="step">
                <strong>åœºæ™¯æè¿°ï¼š</strong>ä¹˜å®¢å‘èµ·è®¢å•ï¼Œå¸æœºæ¥å•å¹¶å¼€å§‹å¯¼èˆªï¼Œç„¶åä¹˜å®¢å–æ¶ˆè®¢å•
            </div>
            <div class="step">
                <strong>æµ‹è¯•ç›®æ ‡ï¼š</strong>éªŒè¯å¸æœºç«¯èƒ½æ­£ç¡®æ¥æ”¶å–æ¶ˆé€šçŸ¥å¹¶æ¸…ç†æ‰€æœ‰ç›¸å…³çŠ¶æ€
            </div>
        </div>
    </div>

    <div class="container">
        <div class="test-section">
            <h3>ğŸ”§ ä¿®å¤å†…å®¹</h3>
            
            <div class="debug-info">
                <h4>1. ä¹˜å®¢ç«¯å–æ¶ˆè®¢å•å¢å¼º</h4>
                <div class="code">
// ä¹˜å®¢å–æ¶ˆè®¢å•æ—¶çš„å¤„ç†é€»è¾‘
const handleCancelOrder = async () => {
  // ... ç¡®è®¤å¯¹è¯æ¡† ...
  
  console.log("ğŸš« å‡†å¤‡å–æ¶ˆè®¢å•:", currentOrder.value);
  console.log("ğŸ‘¨â€âœˆï¸ å¸æœºID:", currentOrder.value.driverId);
  
  const response = await fetch(cancelUrl, {
    method: "POST",
    headers: { Authorization: `Bearer ${userStore.token}` }
  });

  if (response.ok && result.code === 200) {
    console.log("âœ… è®¢å•å–æ¶ˆæˆåŠŸï¼Œåç«¯å·²é€šçŸ¥å¸æœº");
    
    // ç«‹å³æ¸…ç†ä¹˜å®¢ç«¯çš„è®¢å•çŠ¶æ€å’Œåœ°å›¾å…ƒç´ 
    resetOrderState();
    clearAllDriverRoutes();
    
    // æ¢å¤ä¹˜å®¢è·¯å¾„ä¸ºè“è‰²
    if (routeLine && routeLine.setOptions) {
      routeLine.setOptions({
        strokeColor: '#1890ff',
        strokeWeight: 6,
        strokeOpacity: 0.8
      });
    }
    
    ElMessage.success("è®¢å•å·²å–æ¶ˆï¼Œå¸æœºå·²æ”¶åˆ°é€šçŸ¥");
  }
};
                </div>
            </div>

            <div class="debug-info">
                <h4>2. åç«¯é€šçŸ¥å¸æœºå¢å¼º</h4>
                <div class="code">
// åç«¯OrderController.java - å–æ¶ˆè®¢å•æ¥å£
if (order.getDriverId() != null) {
  System.out.println("âœ… è®¢å•å·²åˆ†é…ç»™å¸æœºï¼Œå¼€å§‹é‡Šæ”¾å¸æœºå¹¶å‘é€é€šçŸ¥");
  
  // é‡Šæ”¾å¸æœºçŠ¶æ€
  driverRedisService.markDriverFree(order.getDriverId());
  
  // é€šçŸ¥å¸æœºè®¢å•å·²è¢«ä¹˜å®¢å–æ¶ˆï¼ˆå¢å¼ºç‰ˆé€šçŸ¥ï¼‰
  webSocketNotificationService.notifyDriverOrderCancelled(
    order.getDriverId(), 
    orderId, 
    "ä¹˜å®¢å·²å–æ¶ˆè®¢å•ï¼Œè¯·æ¸…ç†è·¯çº¿è§„åˆ’"
  );
}
                </div>
            </div>

            <div class="debug-info">
                <h4>3. å¸æœºç«¯åœ°å›¾æ¸…ç†é€»è¾‘</h4>
                <div class="code">
// å¸æœºç«¯DriverMap.vue - è®¢å•å–æ¶ˆå¤„ç†
case "ORDER_CANCELLED":
  console.log("âŒ å¤„ç†è®¢å•å–æ¶ˆ");
  if (data.orderId && currentOrder.value) {
    const currentOrderId = currentOrder.value.orderId || currentOrder.value.id
    const cancelledOrderId = data.orderId
    
    if (currentOrderId == cancelledOrderId) {
      console.log('âœ… å½“å‰è®¢å•è¢«å–æ¶ˆï¼Œé‡ç½®çŠ¶æ€å¹¶æ¸…ç†åœ°å›¾')
      
      // æ¸…ç†åœ°å›¾ä¸Šçš„è®¢å•ç›¸å…³å…ƒç´ 
      clearOrderMapElements();
      
      // é‡ç½®è®¢å•çŠ¶æ€
      resetOrderState();
      
      // åœæ­¢å¯¼èˆª
      stopNavigation();
      
      ElMessage({
        message: `è®¢å•å·²è¢«ä¹˜å®¢å–æ¶ˆï¼š${data.reason || 'ä¹˜å®¢å–æ¶ˆ'}`,
        type: 'warning',
        duration: 5000,
        showClose: true
      });
    }
  }
  break;

case "CLEAR_ROUTE":
  console.log("ğŸ§¹ å¤„ç†æ¸…ç†è·¯çº¿è¯·æ±‚");
  clearOrderMapElements();
  stopNavigation();
  resetOrderState();
  ElMessage({
    message: 'è·¯çº¿å·²æ¸…ç†ï¼Œè®¢å•å·²å–æ¶ˆ',
    type: 'info',
    duration: 3000
  });
  break;
                </div>
            </div>

            <div class="debug-info">
                <h4>4. å¸æœºç«¯æ¸…ç†å‡½æ•°</h4>
                <div class="code">
// æ¸…ç†è®¢å•ç›¸å…³çš„åœ°å›¾å…ƒç´ 
const clearOrderMapElements = () => {
  console.log('ğŸ§¹ æ¸…ç†è®¢å•ç›¸å…³çš„åœ°å›¾å…ƒç´ ')
  
  // æ¸…ç†ä¸Šè½¦ç‚¹æ ‡è®°
  if (pickupMarker) {
    map.remove(pickupMarker)
    pickupMarker = null
  }
  
  // æ¸…ç†ç›®çš„åœ°æ ‡è®°
  if (destinationMarker) {
    map.remove(destinationMarker)
    destinationMarker = null
  }
  
  // æ¸…ç†è·¯çº¿
  if (routeLine) {
    map.remove(routeLine)
    routeLine = null
  }
  
  // æ¸…ç†å¯¼èˆªä¿¡æ¯
  driverStore.clearNavigationInfo()
}

// åœæ­¢å¯¼èˆª
const stopNavigation = () => {
  // æ¸…ç†å¯¼èˆªå®šæ—¶å™¨
  if (navigationTimer) {
    clearInterval(navigationTimer)
    navigationTimer = null
  }
  
  // æ¸…ç†å¯¼èˆªä¿¡æ¯
  driverStore.clearNavigationInfo()
}
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="test-section">
            <h3>ğŸ§ª æµ‹è¯•æ­¥éª¤</h3>
            
            <div class="step">
                <span class="status-indicator status-info"></span>
                <strong>æ­¥éª¤ 1ï¼š</strong>ä¹˜å®¢ç«¯åˆ›å»ºè®¢å•
                <div class="code">
1. æ‰“å¼€ä¹˜å®¢ç«¯åœ°å›¾é¡µé¢
2. è®¾ç½®èµ·ç‚¹å’Œç»ˆç‚¹
3. ç‚¹å‡»"ç«‹å³å«è½¦"åˆ›å»ºè®¢å•
4. ç¡®è®¤è®¢å•çŠ¶æ€ä¸º PENDING
                </div>
            </div>

            <div class="step">
                <span class="status-indicator status-info"></span>
                <strong>æ­¥éª¤ 2ï¼š</strong>å¸æœºæ¥å•å¹¶å¼€å§‹å¯¼èˆª
                <div class="code">
1. æ‰“å¼€å¸æœºç«¯åœ°å›¾é¡µé¢
2. ç¡®ä¿å¸æœºåœ¨çº¿çŠ¶æ€
3. æ¥æ”¶å¹¶æ¥å—è®¢å•
4. ç¡®è®¤åœ°å›¾ä¸Šæ˜¾ç¤ºï¼š
   - ä¸Šè½¦ç‚¹æ ‡è®°ï¼ˆç»¿è‰²ï¼‰
   - ç›®çš„åœ°æ ‡è®°ï¼ˆçº¢è‰²ï¼‰
   - å¯¼èˆªè·¯çº¿ï¼ˆè“è‰²æˆ–çº¢è‰²ï¼‰
5. ç¡®è®¤è®¢å•çŠ¶æ€ä¸º ASSIGNED
                </div>
            </div>

            <div class="step warning">
                <span class="status-indicator status-pending"></span>
                <strong>æ­¥éª¤ 3ï¼š</strong>ä¹˜å®¢å–æ¶ˆè®¢å•
                <div class="code">
1. åœ¨ä¹˜å®¢ç«¯ç‚¹å‡»"å–æ¶ˆè®¢å•"æŒ‰é’®
2. ç¡®è®¤å–æ¶ˆå¯¹è¯æ¡†
3. è§‚å¯Ÿä¹˜å®¢ç«¯ååº”ï¼š
   - æ˜¾ç¤º"è®¢å•å·²å–æ¶ˆï¼Œå¸æœºå·²æ”¶åˆ°é€šçŸ¥"
   - è®¢å•çŠ¶æ€é‡ç½®
   - åœ°å›¾æ¸…ç†å®Œæˆ
                </div>
            </div>

            <div class="step expected">
                <span class="status-indicator status-success"></span>
                <strong>æ­¥éª¤ 4ï¼š</strong>éªŒè¯å¸æœºç«¯ååº”
                <div class="code">
<strong>æœŸæœ›ç»“æœï¼š</strong>
âœ… å¸æœºæ”¶åˆ°æ˜ç¡®çš„å–æ¶ˆé€šçŸ¥æ¶ˆæ¯
âœ… åœ°å›¾ä¸Šçš„ä¸Šè½¦ç‚¹æ ‡è®°è¢«æ¸…é™¤
âœ… åœ°å›¾ä¸Šçš„ç›®çš„åœ°æ ‡è®°è¢«æ¸…é™¤  
âœ… å¯¼èˆªè·¯çº¿è¢«å®Œå…¨æ¸…é™¤
âœ… å¯¼èˆªå®šæ—¶å™¨è¢«åœæ­¢
âœ… è®¢å•çŠ¶æ€è¢«é‡ç½®ä¸ºç©º
âœ… å¸æœºå¯ä»¥æ¥æ”¶æ–°è®¢å•
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="test-section">
            <h3>ğŸ” è°ƒè¯•ä¿¡æ¯</h3>
            
            <div class="debug-info">
                <h4>æµè§ˆå™¨æ§åˆ¶å°æ—¥å¿—å…³é”®è¯</h4>
                <div class="code">
<strong>ä¹˜å®¢ç«¯ï¼š</strong>
- "ğŸš« å‡†å¤‡å–æ¶ˆè®¢å•"
- "âœ… è®¢å•å–æ¶ˆæˆåŠŸï¼Œåç«¯å·²é€šçŸ¥å¸æœº"
- "ğŸ§¹ æ¸…ç†å¸æœºè·¯å¾„"

<strong>å¸æœºç«¯ï¼š</strong>
- "âŒ æ”¶åˆ°è®¢å•å–æ¶ˆé€šçŸ¥"
- "âœ… å½“å‰è®¢å•è¢«å–æ¶ˆï¼Œå¼€å§‹æ¸…ç†çŠ¶æ€å’Œåœ°å›¾"
- "ğŸ§¹ æ¸…ç†è®¢å•ç›¸å…³çš„åœ°å›¾å…ƒç´ "
- "ğŸ›‘ åœæ­¢å¯¼èˆª"
- "ğŸ”„ é‡ç½®å¸æœºè®¢å•çŠ¶æ€"
                </div>
            </div>

            <div class="debug-info">
                <h4>WebSocketæ¶ˆæ¯æ ¼å¼</h4>
                <div class="code">
<strong>å¸æœºæ¥æ”¶çš„å–æ¶ˆé€šçŸ¥ï¼š</strong>
{
  "type": "ORDER_CANCELLED",
  "orderId": "è®¢å•ID",
  "reason": "ä¹˜å®¢å·²å–æ¶ˆè®¢å•ï¼Œè¯·æ¸…ç†è·¯çº¿è§„åˆ’",
  "priority": "HIGH",
  "timestamp": æ—¶é—´æˆ³
}
                </div>
            </div>

            <div class="debug-info">
                <h4>æ•…éšœæ’é™¤</h4>
                <div class="step error">
                    <strong>å¦‚æœå¸æœºæ²¡æœ‰æ”¶åˆ°é€šçŸ¥ï¼š</strong>
                    <ul>
                        <li>æ£€æŸ¥WebSocketè¿æ¥çŠ¶æ€</li>
                        <li>ç¡®è®¤å¸æœºIDåŒ¹é…</li>
                        <li>æŸ¥çœ‹åç«¯æ—¥å¿—ç¡®è®¤é€šçŸ¥å‘é€</li>
                    </ul>
                </div>
                <div class="step error">
                    <strong>å¦‚æœåœ°å›¾æ²¡æœ‰æ¸…ç†ï¼š</strong>
                    <ul>
                        <li>æ£€æŸ¥clearOrderMapElementså‡½æ•°è°ƒç”¨</li>
                        <li>ç¡®è®¤åœ°å›¾å¯¹è±¡å­˜åœ¨</li>
                        <li>æŸ¥çœ‹æ§åˆ¶å°é”™è¯¯ä¿¡æ¯</li>
                    </ul>
                </div>
                <div class="step error">
                    <strong>å¦‚æœè®¢å•çŠ¶æ€æ²¡æœ‰é‡ç½®ï¼š</strong>
                    <ul>
                        <li>æ£€æŸ¥resetOrderStateå‡½æ•°è°ƒç”¨</li>
                        <li>ç¡®è®¤storeçŠ¶æ€æ›´æ–°</li>
                        <li>éªŒè¯localStorageæ¸…ç†</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="test-section success">
            <h3>âœ… æµ‹è¯•å®Œæˆæ ‡å‡†</h3>
            <div class="step expected">
                <strong>æµ‹è¯•é€šè¿‡æ¡ä»¶ï¼š</strong>
                <ul>
                    <li>âœ… ä¹˜å®¢å–æ¶ˆè®¢å•åï¼Œå¸æœºç«‹å³æ”¶åˆ°æ˜ç¡®çš„é€šçŸ¥æ¶ˆæ¯</li>
                    <li>âœ… å¸æœºç«¯åœ°å›¾ä¸Šçš„æ‰€æœ‰è®¢å•ç›¸å…³æ ‡è®°å’Œè·¯çº¿è¢«å®Œå…¨æ¸…é™¤</li>
                    <li>âœ… å¸æœºç«¯è®¢å•çŠ¶æ€è¢«æ­£ç¡®é‡ç½®ï¼Œå¯ä»¥æ¥æ”¶æ–°è®¢å•</li>
                    <li>âœ… å¯¼èˆªåŠŸèƒ½è¢«æ­£ç¡®åœæ­¢ï¼Œä¸å†æ›´æ–°ä½ç½®</li>
                    <li>âœ… æ•´ä¸ªè¿‡ç¨‹ç”¨æˆ·ä½“éªŒæµç•…ï¼Œæ²¡æœ‰æ®‹ç•™çŠ¶æ€</li>
                </ul>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="test-section">
            <h3>ğŸ¯ å…³é”®æ”¹è¿›ç‚¹</h3>
            <div class="step success">
                <strong>1. åŒé‡é€šçŸ¥æœºåˆ¶ï¼š</strong>å¸æœºç«¯åŒæ—¶ç›‘å¬è®¢å•é˜Ÿåˆ—å’Œé€šçŸ¥é˜Ÿåˆ—ï¼Œç¡®ä¿æ¶ˆæ¯é€è¾¾
            </div>
            <div class="step success">
                <strong>2. å®Œæ•´åœ°å›¾æ¸…ç†ï¼š</strong>æ¸…ç†ä¸Šè½¦ç‚¹ã€ç›®çš„åœ°æ ‡è®°å’Œæ‰€æœ‰è·¯çº¿
            </div>
            <div class="step success">
                <strong>3. æ˜ç¡®ç”¨æˆ·åé¦ˆï¼š</strong>æ˜¾ç¤ºè¯¦ç»†çš„å–æ¶ˆåŸå› å’Œæ¸…ç†çŠ¶æ€
            </div>
            <div class="step success">
                <strong>4. çŠ¶æ€åŒæ­¥ï¼š</strong>å‰ç«¯storeå’ŒlocalStorageçŠ¶æ€å®Œå…¨åŒæ­¥
            </div>
            <div class="step success">
                <strong>5. é”™è¯¯å¤„ç†ï¼š</strong>å¢åŠ å¤šç§æ¶ˆæ¯ç±»å‹å¤„ç†ï¼Œæé«˜å®¹é”™æ€§
            </div>
        </div>
    </div>
</body>
</html>