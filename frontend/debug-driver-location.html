<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>司机位置调试工具</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .debug-section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .debug-section h3 {
            margin-top: 0;
            color: #333;
        }
        button {
            background: #409EFF;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #66b1ff;
        }
        button.success {
            background: #67c23a;
        }
        button.danger {
            background: #f56c6c;
        }
        .info-display {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 14px;
            white-space: pre-wrap;
        }
        .status-good {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .status-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        .status-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .websocket-message {
            background: #e3f2fd;
            padding: 10px;
            border-radius: 5px;
            margin: 5px 0;
            border-left: 4px solid #2196f3;
        }
        .driver-location {
            background: #f3e5f5;
            padding: 10px;
            border-radius: 5px;
            margin: 5px 0;
            border-left: 4px solid #9c27b0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🚗 司机位置调试工具</h1>
        <p>用于调试乘客端司机位置显示问题</p>
    </div>

    <div class="container">
        <div class="debug-section">
            <h3>1. 模拟用户登录</h3>
            <button onclick="simulateLogin()">模拟乘客登录</button>
            <button onclick="simulateLogout()" class="danger">登出</button>
            
            <div id="userStatus" class="info-display">
                用户状态: 未登录
            </div>
        </div>

        <div class="debug-section">
            <h3>2. 模拟订单和司机信息</h3>
            <button onclick="simulateOrderAssigned()">模拟司机接单</button>
            <button onclick="simulateDriverLocationUpdate()">模拟司机位置更新</button>
            <button onclick="clearOrderInfo()" class="danger">清除订单信息</button>
            
            <div id="orderInfo" class="info-display">
                订单信息: 无
            </div>
            
            <div id="driverInfo" class="info-display">
                司机信息: 无
            </div>
        </div>

        <div class="debug-section">
            <h3>3. WebSocket消息模拟</h3>
            <button onclick="sendOrderAssignedMessage()">发送ORDER_ASSIGNED消息</button>
            <button onclick="sendDriverLocationMessage()">发送DRIVER_LOCATION消息</button>
            <button onclick="clearMessages()" class="danger">清除消息</button>
            
            <div id="websocketMessages" class="info-display">
                WebSocket消息记录:
            </div>
        </div>

        <div class="debug-section">
            <h3>4. 地图元素检查</h3>
            <button onclick="checkMapElements()">检查地图元素</button>
            <button onclick="testDriverMarker()">测试司机标记</button>
            <button onclick="testDriverRoute()">测试司机路线</button>
            
            <div id="mapElementsStatus" class="info-display">
                地图元素状态: 未检查
            </div>
        </div>

        <div class="debug-section">
            <h3>5. 完整流程测试</h3>
            <button onclick="testCompleteFlow()">测试完整流程</button>
            <div id="flowTestResult" class="info-display">
                流程测试结果: 未开始
            </div>
        </div>
    </div>

    <div class="container">
        <h3>📋 调试日志</h3>
        <div id="debugLog" style="background: #f8f9fa; padding: 15px; border-radius: 5px; font-family: monospace; font-size: 12px; max-height: 400px; overflow-y: auto;"></div>
    </div>

    <script>
        let mockUser = null;
        let mockOrder = null;
        let mockDriver = null;
        let websocketMessages = [];

        function log(message, type = 'info') {
            const logDiv = document.getElementById('debugLog');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}\\n`;
            logDiv.textContent += logEntry;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(logEntry);
        }

        function updateUserStatus() {
            const statusDiv = document.getElementById('userStatus');
            if (mockUser) {
                statusDiv.innerHTML = `用户状态: 已登录
用户ID: ${mockUser.id}
乘客ID: ${mockUser.passengerId}
姓名: ${mockUser.name}`;
                statusDiv.className = 'info-display status-good';
            } else {
                statusDiv.textContent = '用户状态: 未登录';
                statusDiv.className = 'info-display status-error';
            }
        }

        function updateOrderInfo() {
            const orderDiv = document.getElementById('orderInfo');
            if (mockOrder) {
                orderDiv.innerHTML = `订单信息:
订单号: ${mockOrder.orderNumber}
状态: ${mockOrder.status}
上车点: ${mockOrder.pickupAddress}
上车点坐标: (${mockOrder.pickupLatitude}, ${mockOrder.pickupLongitude})
目的地: ${mockOrder.destinationAddress}
目的地坐标: (${mockOrder.destinationLatitude}, ${mockOrder.destinationLongitude})`;
                orderDiv.className = 'info-display status-good';
            } else {
                orderDiv.textContent = '订单信息: 无';
                orderDiv.className = 'info-display status-warning';
            }
        }

        function updateDriverInfo() {
            const driverDiv = document.getElementById('driverInfo');
            if (mockDriver) {
                driverDiv.innerHTML = `司机信息:
司机ID: ${mockDriver.id}
姓名: ${mockDriver.name}
电话: ${mockDriver.phone}
当前位置: (${mockDriver.latitude}, ${mockDriver.longitude})
评分: ${mockDriver.rating}
车辆信息: ${mockDriver.carModel}`;
                
                // 检查关键信息是否完整
                if (mockDriver.latitude && mockDriver.longitude) {
                    driverDiv.className = 'info-display status-good';
                } else {
                    driverDiv.className = 'info-display status-error';
                    driverDiv.innerHTML += '\\n⚠️ 警告: 司机位置信息缺失!';
                }
            } else {
                driverDiv.textContent = '司机信息: 无';
                driverDiv.className = 'info-display status-warning';
            }
        }

        function updateWebSocketMessages() {
            const messagesDiv = document.getElementById('websocketMessages');
            if (websocketMessages.length > 0) {
                let content = 'WebSocket消息记录:\\n';
                websocketMessages.forEach((msg, index) => {
                    content += `\\n[${index + 1}] ${msg.timestamp} - ${msg.type}:\\n`;
                    content += JSON.stringify(msg.data, null, 2) + '\\n';
                });
                messagesDiv.textContent = content;
            } else {
                messagesDiv.textContent = 'WebSocket消息记录: 无消息';
            }
        }

        function simulateLogin() {
            mockUser = {
                id: 1,
                passengerId: 1,
                name: '测试乘客',
                phone: '13800138000'
            };
            
            updateUserStatus();
            log('模拟用户登录成功');
        }

        function simulateLogout() {
            mockUser = null;
            mockOrder = null;
            mockDriver = null;
            websocketMessages = [];
            
            updateUserStatus();
            updateOrderInfo();
            updateDriverInfo();
            updateWebSocketMessages();
            
            log('用户登出，所有状态已清除');
        }

        function simulateOrderAssigned() {
            if (!mockUser) {
                alert('请先模拟用户登录');
                return;
            }
            
            mockOrder = {
                id: Date.now(),
                orderNumber: `ORDER${Date.now()}`,
                status: 'ASSIGNED',
                pickupAddress: '北京市朝阳区三里屯',
                destinationAddress: '北京市海淀区中关村',
                pickupLatitude: 39.93428,
                pickupLongitude: 116.44857,
                destinationLatitude: 39.98279,
                destinationLongitude: 116.31038,
                estimatedFare: 25.50
            };
            
            mockDriver = {
                id: 1,
                driverId: 1,
                name: '张师傅',
                driverName: '张师傅',
                phone: '13900139000',
                phoneNumber: '13900139000',
                latitude: 39.93128,  // 司机当前位置（接近上车点）
                longitude: 116.44557,
                rating: 4.8,
                vehicleInfo: '京A12345',
                carModel: '大众朗逸'
            };
            
            updateOrderInfo();
            updateDriverInfo();
            log('模拟司机接单完成');
        }

        function simulateDriverLocationUpdate() {
            if (!mockDriver) {
                alert('请先模拟司机接单');
                return;
            }
            
            // 模拟司机位置变化（向上车点移动）
            mockDriver.latitude += (Math.random() - 0.5) * 0.001;
            mockDriver.longitude += (Math.random() - 0.5) * 0.001;
            
            updateDriverInfo();
            log(`司机位置更新: (${mockDriver.latitude}, ${mockDriver.longitude})`);
        }

        function clearOrderInfo() {
            mockOrder = null;
            mockDriver = null;
            updateOrderInfo();
            updateDriverInfo();
            log('订单和司机信息已清除');
        }

        function sendOrderAssignedMessage() {
            if (!mockOrder || !mockDriver) {
                alert('请先模拟订单和司机信息');
                return;
            }
            
            const message = {
                timestamp: new Date().toLocaleTimeString(),
                type: 'ORDER_ASSIGNED',
                data: {
                    type: 'ORDER_ASSIGNED',
                    order: mockOrder,
                    driver: mockDriver
                }
            };
            
            websocketMessages.push(message);
            updateWebSocketMessages();
            log('发送ORDER_ASSIGNED消息');
            
            // 模拟消息处理
            processWebSocketMessage(message.data);
        }

        function sendDriverLocationMessage() {
            if (!mockDriver) {
                alert('请先模拟司机信息');
                return;
            }
            
            const message = {
                timestamp: new Date().toLocaleTimeString(),
                type: 'DRIVER_LOCATION',
                data: {
                    type: 'DRIVER_LOCATION',
                    driverId: mockDriver.id,
                    latitude: mockDriver.latitude,
                    longitude: mockDriver.longitude
                }
            };
            
            websocketMessages.push(message);
            updateWebSocketMessages();
            log('发送DRIVER_LOCATION消息');
            
            // 模拟消息处理
            processWebSocketMessage(message.data);
        }

        function clearMessages() {
            websocketMessages = [];
            updateWebSocketMessages();
            log('WebSocket消息已清除');
        }

        function processWebSocketMessage(data) {
            log(`处理WebSocket消息: ${data.type}`);
            
            switch (data.type) {
                case 'ORDER_ASSIGNED':
                    if (data.order) {
                        mockOrder = { ...mockOrder, ...data.order };
                        log('✅ 订单信息已更新');
                    }
                    if (data.driver) {
                        mockDriver = { ...mockDriver, ...data.driver };
                        log('✅ 司机信息已更新');
                        
                        // 检查司机位置信息
                        if (data.driver.latitude && data.driver.longitude) {
                            log(`✅ 司机位置: (${data.driver.latitude}, ${data.driver.longitude})`);
                        } else {
                            log('❌ 警告: 司机位置信息缺失!');
                        }
                    }
                    break;
                    
                case 'DRIVER_LOCATION':
                    if (mockDriver && data.driverId === mockDriver.id) {
                        mockDriver.latitude = data.latitude;
                        mockDriver.longitude = data.longitude;
                        log(`✅ 司机位置已更新: (${data.latitude}, ${data.longitude})`);
                    }
                    break;
            }
            
            updateOrderInfo();
            updateDriverInfo();
        }

        function checkMapElements() {
            const statusDiv = document.getElementById('mapElementsStatus');
            let status = '地图元素检查结果:\\n';
            
            // 检查全局变量
            status += `\\n全局变量检查:`;
            status += `\\n- window.AMap: ${typeof window.AMap !== 'undefined' ? '✅ 已加载' : '❌ 未加载'}`;
            status += `\\n- map实例: ${typeof window.map !== 'undefined' && window.map ? '✅ 已初始化' : '❌ 未初始化'}`;
            
            // 检查司机相关元素
            status += `\\n\\n司机地图元素:`;
            status += `\\n- driverMarker: ${typeof window.driverMarker !== 'undefined' && window.driverMarker ? '✅ 存在' : '❌ 不存在'}`;
            status += `\\n- driverRouteLine: ${typeof window.driverRouteLine !== 'undefined' && window.driverRouteLine ? '✅ 存在' : '❌ 不存在'}`;
            
            // 检查数据完整性
            status += `\\n\\n数据完整性:`;
            status += `\\n- 订单信息: ${mockOrder ? '✅ 存在' : '❌ 缺失'}`;
            status += `\\n- 司机信息: ${mockDriver ? '✅ 存在' : '❌ 缺失'}`;
            if (mockDriver) {
                status += `\\n- 司机位置: ${mockDriver.latitude && mockDriver.longitude ? '✅ 完整' : '❌ 缺失'}`;
            }
            
            statusDiv.textContent = status;
            statusDiv.className = 'info-display';
            
            log('地图元素检查完成');
        }

        function testDriverMarker() {
            if (!mockDriver || !mockDriver.latitude || !mockDriver.longitude) {
                alert('请先设置完整的司机信息');
                return;
            }
            
            log(`测试司机标记: (${mockDriver.latitude}, ${mockDriver.longitude})`);
            
            // 模拟调用showDriverOnMap函数
            if (typeof window.showDriverOnMap === 'function') {
                try {
                    window.showDriverOnMap(mockDriver.latitude, mockDriver.longitude);
                    log('✅ 司机标记测试成功');
                } catch (error) {
                    log(`❌ 司机标记测试失败: ${error.message}`);
                }
            } else {
                log('❌ showDriverOnMap函数不存在');
            }
        }

        function testDriverRoute() {
            if (!mockDriver || !mockDriver.latitude || !mockDriver.longitude) {
                alert('请先设置完整的司机信息');
                return;
            }
            
            if (!mockOrder || !mockOrder.pickupLatitude || !mockOrder.pickupLongitude) {
                alert('请先设置完整的订单信息');
                return;
            }
            
            log(`测试司机路线: 司机(${mockDriver.latitude}, ${mockDriver.longitude}) → 上车点(${mockOrder.pickupLatitude}, ${mockOrder.pickupLongitude})`);
            
            // 模拟调用updateDriverRoute函数
            if (typeof window.updateDriverRoute === 'function') {
                try {
                    window.updateDriverRoute(mockDriver.latitude, mockDriver.longitude);
                    log('✅ 司机路线测试成功');
                } catch (error) {
                    log(`❌ 司机路线测试失败: ${error.message}`);
                }
            } else {
                log('❌ updateDriverRoute函数不存在');
            }
        }

        function testCompleteFlow() {
            const resultDiv = document.getElementById('flowTestResult');
            let result = '完整流程测试:\\n';
            
            log('开始完整流程测试...');
            
            // 步骤1: 用户登录
            simulateLogin();
            result += '\\n✅ 步骤1: 用户登录';
            
            setTimeout(() => {
                // 步骤2: 司机接单
                simulateOrderAssigned();
                result += '\\n✅ 步骤2: 司机接单';
                
                setTimeout(() => {
                    // 步骤3: 发送WebSocket消息
                    sendOrderAssignedMessage();
                    result += '\\n✅ 步骤3: WebSocket消息处理';
                    
                    setTimeout(() => {
                        // 步骤4: 检查数据完整性
                        let dataComplete = true;
                        if (!mockDriver || !mockDriver.latitude || !mockDriver.longitude) {
                            result += '\\n❌ 步骤4: 司机位置数据缺失';
                            dataComplete = false;
                        } else {
                            result += '\\n✅ 步骤4: 司机位置数据完整';
                        }
                        
                        setTimeout(() => {
                            // 步骤5: 测试地图功能
                            if (dataComplete) {
                                result += '\\n✅ 步骤5: 准备测试地图功能';
                                result += '\\n💡 提示: 请在实际页面中测试司机标记和路线显示';
                            } else {
                                result += '\\n❌ 步骤5: 数据不完整，无法测试地图功能';
                            }
                            
                            result += '\\n\\n🎯 测试总结:';
                            result += dataComplete ? '\\n✅ 数据流程正常，问题可能在地图渲染层' : '\\n❌ 数据流程有问题，需要检查WebSocket消息处理';
                            
                            resultDiv.textContent = result;
                            resultDiv.className = dataComplete ? 'info-display status-good' : 'info-display status-error';
                            
                            log('完整流程测试完成');
                        }, 1000);
                    }, 1000);
                }, 1000);
            }, 1000);
        }

        // 页面加载时的初始化
        window.onload = function() {
            log('司机位置调试工具已加载');
            updateUserStatus();
            updateOrderInfo();
            updateDriverInfo();
            updateWebSocketMessages();
            
            log('调试说明:');
            log('1. 模拟用户登录和订单状态');
            log('2. 测试WebSocket消息处理');
            log('3. 检查司机位置数据完整性');
            log('4. 验证地图元素渲染功能');
        };
    </script>
</body>
</html>"