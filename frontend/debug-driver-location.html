<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¸æœºä½ç½®è°ƒè¯•å·¥å…·</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .debug-section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .debug-section h3 {
            margin-top: 0;
            color: #333;
        }
        button {
            background: #409EFF;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #66b1ff;
        }
        button.success {
            background: #67c23a;
        }
        button.danger {
            background: #f56c6c;
        }
        .info-display {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 14px;
            white-space: pre-wrap;
        }
        .status-good {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .status-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        .status-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .websocket-message {
            background: #e3f2fd;
            padding: 10px;
            border-radius: 5px;
            margin: 5px 0;
            border-left: 4px solid #2196f3;
        }
        .driver-location {
            background: #f3e5f5;
            padding: 10px;
            border-radius: 5px;
            margin: 5px 0;
            border-left: 4px solid #9c27b0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš— å¸æœºä½ç½®è°ƒè¯•å·¥å…·</h1>
        <p>ç”¨äºè°ƒè¯•ä¹˜å®¢ç«¯å¸æœºä½ç½®æ˜¾ç¤ºé—®é¢˜</p>
    </div>

    <div class="container">
        <div class="debug-section">
            <h3>1. æ¨¡æ‹Ÿç”¨æˆ·ç™»å½•</h3>
            <button onclick="simulateLogin()">æ¨¡æ‹Ÿä¹˜å®¢ç™»å½•</button>
            <button onclick="simulateLogout()" class="danger">ç™»å‡º</button>
            
            <div id="userStatus" class="info-display">
                ç”¨æˆ·çŠ¶æ€: æœªç™»å½•
            </div>
        </div>

        <div class="debug-section">
            <h3>2. æ¨¡æ‹Ÿè®¢å•å’Œå¸æœºä¿¡æ¯</h3>
            <button onclick="simulateOrderAssigned()">æ¨¡æ‹Ÿå¸æœºæ¥å•</button>
            <button onclick="simulateDriverLocationUpdate()">æ¨¡æ‹Ÿå¸æœºä½ç½®æ›´æ–°</button>
            <button onclick="clearOrderInfo()" class="danger">æ¸…é™¤è®¢å•ä¿¡æ¯</button>
            
            <div id="orderInfo" class="info-display">
                è®¢å•ä¿¡æ¯: æ— 
            </div>
            
            <div id="driverInfo" class="info-display">
                å¸æœºä¿¡æ¯: æ— 
            </div>
        </div>

        <div class="debug-section">
            <h3>3. WebSocketæ¶ˆæ¯æ¨¡æ‹Ÿ</h3>
            <button onclick="sendOrderAssignedMessage()">å‘é€ORDER_ASSIGNEDæ¶ˆæ¯</button>
            <button onclick="sendDriverLocationMessage()">å‘é€DRIVER_LOCATIONæ¶ˆæ¯</button>
            <button onclick="clearMessages()" class="danger">æ¸…é™¤æ¶ˆæ¯</button>
            
            <div id="websocketMessages" class="info-display">
                WebSocketæ¶ˆæ¯è®°å½•:
            </div>
        </div>

        <div class="debug-section">
            <h3>4. åœ°å›¾å…ƒç´ æ£€æŸ¥</h3>
            <button onclick="checkMapElements()">æ£€æŸ¥åœ°å›¾å…ƒç´ </button>
            <button onclick="testDriverMarker()">æµ‹è¯•å¸æœºæ ‡è®°</button>
            <button onclick="testDriverRoute()">æµ‹è¯•å¸æœºè·¯çº¿</button>
            
            <div id="mapElementsStatus" class="info-display">
                åœ°å›¾å…ƒç´ çŠ¶æ€: æœªæ£€æŸ¥
            </div>
        </div>

        <div class="debug-section">
            <h3>5. å®Œæ•´æµç¨‹æµ‹è¯•</h3>
            <button onclick="testCompleteFlow()">æµ‹è¯•å®Œæ•´æµç¨‹</button>
            <div id="flowTestResult" class="info-display">
                æµç¨‹æµ‹è¯•ç»“æœ: æœªå¼€å§‹
            </div>
        </div>
    </div>

    <div class="container">
        <h3>ğŸ“‹ è°ƒè¯•æ—¥å¿—</h3>
        <div id="debugLog" style="background: #f8f9fa; padding: 15px; border-radius: 5px; font-family: monospace; font-size: 12px; max-height: 400px; overflow-y: auto;"></div>
    </div>

    <script>
        let mockUser = null;
        let mockOrder = null;
        let mockDriver = null;
        let websocketMessages = [];

        function log(message, type = 'info') {
            const logDiv = document.getElementById('debugLog');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}\\n`;
            logDiv.textContent += logEntry;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(logEntry);
        }

        function updateUserStatus() {
            const statusDiv = document.getElementById('userStatus');
            if (mockUser) {
                statusDiv.innerHTML = `ç”¨æˆ·çŠ¶æ€: å·²ç™»å½•
ç”¨æˆ·ID: ${mockUser.id}
ä¹˜å®¢ID: ${mockUser.passengerId}
å§“å: ${mockUser.name}`;
                statusDiv.className = 'info-display status-good';
            } else {
                statusDiv.textContent = 'ç”¨æˆ·çŠ¶æ€: æœªç™»å½•';
                statusDiv.className = 'info-display status-error';
            }
        }

        function updateOrderInfo() {
            const orderDiv = document.getElementById('orderInfo');
            if (mockOrder) {
                orderDiv.innerHTML = `è®¢å•ä¿¡æ¯:
è®¢å•å·: ${mockOrder.orderNumber}
çŠ¶æ€: ${mockOrder.status}
ä¸Šè½¦ç‚¹: ${mockOrder.pickupAddress}
ä¸Šè½¦ç‚¹åæ ‡: (${mockOrder.pickupLatitude}, ${mockOrder.pickupLongitude})
ç›®çš„åœ°: ${mockOrder.destinationAddress}
ç›®çš„åœ°åæ ‡: (${mockOrder.destinationLatitude}, ${mockOrder.destinationLongitude})`;
                orderDiv.className = 'info-display status-good';
            } else {
                orderDiv.textContent = 'è®¢å•ä¿¡æ¯: æ— ';
                orderDiv.className = 'info-display status-warning';
            }
        }

        function updateDriverInfo() {
            const driverDiv = document.getElementById('driverInfo');
            if (mockDriver) {
                driverDiv.innerHTML = `å¸æœºä¿¡æ¯:
å¸æœºID: ${mockDriver.id}
å§“å: ${mockDriver.name}
ç”µè¯: ${mockDriver.phone}
å½“å‰ä½ç½®: (${mockDriver.latitude}, ${mockDriver.longitude})
è¯„åˆ†: ${mockDriver.rating}
è½¦è¾†ä¿¡æ¯: ${mockDriver.carModel}`;
                
                // æ£€æŸ¥å…³é”®ä¿¡æ¯æ˜¯å¦å®Œæ•´
                if (mockDriver.latitude && mockDriver.longitude) {
                    driverDiv.className = 'info-display status-good';
                } else {
                    driverDiv.className = 'info-display status-error';
                    driverDiv.innerHTML += '\\nâš ï¸ è­¦å‘Š: å¸æœºä½ç½®ä¿¡æ¯ç¼ºå¤±!';
                }
            } else {
                driverDiv.textContent = 'å¸æœºä¿¡æ¯: æ— ';
                driverDiv.className = 'info-display status-warning';
            }
        }

        function updateWebSocketMessages() {
            const messagesDiv = document.getElementById('websocketMessages');
            if (websocketMessages.length > 0) {
                let content = 'WebSocketæ¶ˆæ¯è®°å½•:\\n';
                websocketMessages.forEach((msg, index) => {
                    content += `\\n[${index + 1}] ${msg.timestamp} - ${msg.type}:\\n`;
                    content += JSON.stringify(msg.data, null, 2) + '\\n';
                });
                messagesDiv.textContent = content;
            } else {
                messagesDiv.textContent = 'WebSocketæ¶ˆæ¯è®°å½•: æ— æ¶ˆæ¯';
            }
        }

        function simulateLogin() {
            mockUser = {
                id: 1,
                passengerId: 1,
                name: 'æµ‹è¯•ä¹˜å®¢',
                phone: '13800138000'
            };
            
            updateUserStatus();
            log('æ¨¡æ‹Ÿç”¨æˆ·ç™»å½•æˆåŠŸ');
        }

        function simulateLogout() {
            mockUser = null;
            mockOrder = null;
            mockDriver = null;
            websocketMessages = [];
            
            updateUserStatus();
            updateOrderInfo();
            updateDriverInfo();
            updateWebSocketMessages();
            
            log('ç”¨æˆ·ç™»å‡ºï¼Œæ‰€æœ‰çŠ¶æ€å·²æ¸…é™¤');
        }

        function simulateOrderAssigned() {
            if (!mockUser) {
                alert('è¯·å…ˆæ¨¡æ‹Ÿç”¨æˆ·ç™»å½•');
                return;
            }
            
            mockOrder = {
                id: Date.now(),
                orderNumber: `ORDER${Date.now()}`,
                status: 'ASSIGNED',
                pickupAddress: 'åŒ—äº¬å¸‚æœé˜³åŒºä¸‰é‡Œå±¯',
                destinationAddress: 'åŒ—äº¬å¸‚æµ·æ·€åŒºä¸­å…³æ‘',
                pickupLatitude: 39.93428,
                pickupLongitude: 116.44857,
                destinationLatitude: 39.98279,
                destinationLongitude: 116.31038,
                estimatedFare: 25.50
            };
            
            mockDriver = {
                id: 1,
                driverId: 1,
                name: 'å¼ å¸ˆå‚…',
                driverName: 'å¼ å¸ˆå‚…',
                phone: '13900139000',
                phoneNumber: '13900139000',
                latitude: 39.93128,  // å¸æœºå½“å‰ä½ç½®ï¼ˆæ¥è¿‘ä¸Šè½¦ç‚¹ï¼‰
                longitude: 116.44557,
                rating: 4.8,
                vehicleInfo: 'äº¬A12345',
                carModel: 'å¤§ä¼—æœ—é€¸'
            };
            
            updateOrderInfo();
            updateDriverInfo();
            log('æ¨¡æ‹Ÿå¸æœºæ¥å•å®Œæˆ');
        }

        function simulateDriverLocationUpdate() {
            if (!mockDriver) {
                alert('è¯·å…ˆæ¨¡æ‹Ÿå¸æœºæ¥å•');
                return;
            }
            
            // æ¨¡æ‹Ÿå¸æœºä½ç½®å˜åŒ–ï¼ˆå‘ä¸Šè½¦ç‚¹ç§»åŠ¨ï¼‰
            mockDriver.latitude += (Math.random() - 0.5) * 0.001;
            mockDriver.longitude += (Math.random() - 0.5) * 0.001;
            
            updateDriverInfo();
            log(`å¸æœºä½ç½®æ›´æ–°: (${mockDriver.latitude}, ${mockDriver.longitude})`);
        }

        function clearOrderInfo() {
            mockOrder = null;
            mockDriver = null;
            updateOrderInfo();
            updateDriverInfo();
            log('è®¢å•å’Œå¸æœºä¿¡æ¯å·²æ¸…é™¤');
        }

        function sendOrderAssignedMessage() {
            if (!mockOrder || !mockDriver) {
                alert('è¯·å…ˆæ¨¡æ‹Ÿè®¢å•å’Œå¸æœºä¿¡æ¯');
                return;
            }
            
            const message = {
                timestamp: new Date().toLocaleTimeString(),
                type: 'ORDER_ASSIGNED',
                data: {
                    type: 'ORDER_ASSIGNED',
                    order: mockOrder,
                    driver: mockDriver
                }
            };
            
            websocketMessages.push(message);
            updateWebSocketMessages();
            log('å‘é€ORDER_ASSIGNEDæ¶ˆæ¯');
            
            // æ¨¡æ‹Ÿæ¶ˆæ¯å¤„ç†
            processWebSocketMessage(message.data);
        }

        function sendDriverLocationMessage() {
            if (!mockDriver) {
                alert('è¯·å…ˆæ¨¡æ‹Ÿå¸æœºä¿¡æ¯');
                return;
            }
            
            const message = {
                timestamp: new Date().toLocaleTimeString(),
                type: 'DRIVER_LOCATION',
                data: {
                    type: 'DRIVER_LOCATION',
                    driverId: mockDriver.id,
                    latitude: mockDriver.latitude,
                    longitude: mockDriver.longitude
                }
            };
            
            websocketMessages.push(message);
            updateWebSocketMessages();
            log('å‘é€DRIVER_LOCATIONæ¶ˆæ¯');
            
            // æ¨¡æ‹Ÿæ¶ˆæ¯å¤„ç†
            processWebSocketMessage(message.data);
        }

        function clearMessages() {
            websocketMessages = [];
            updateWebSocketMessages();
            log('WebSocketæ¶ˆæ¯å·²æ¸…é™¤');
        }

        function processWebSocketMessage(data) {
            log(`å¤„ç†WebSocketæ¶ˆæ¯: ${data.type}`);
            
            switch (data.type) {
                case 'ORDER_ASSIGNED':
                    if (data.order) {
                        mockOrder = { ...mockOrder, ...data.order };
                        log('âœ… è®¢å•ä¿¡æ¯å·²æ›´æ–°');
                    }
                    if (data.driver) {
                        mockDriver = { ...mockDriver, ...data.driver };
                        log('âœ… å¸æœºä¿¡æ¯å·²æ›´æ–°');
                        
                        // æ£€æŸ¥å¸æœºä½ç½®ä¿¡æ¯
                        if (data.driver.latitude && data.driver.longitude) {
                            log(`âœ… å¸æœºä½ç½®: (${data.driver.latitude}, ${data.driver.longitude})`);
                        } else {
                            log('âŒ è­¦å‘Š: å¸æœºä½ç½®ä¿¡æ¯ç¼ºå¤±!');
                        }
                    }
                    break;
                    
                case 'DRIVER_LOCATION':
                    if (mockDriver && data.driverId === mockDriver.id) {
                        mockDriver.latitude = data.latitude;
                        mockDriver.longitude = data.longitude;
                        log(`âœ… å¸æœºä½ç½®å·²æ›´æ–°: (${data.latitude}, ${data.longitude})`);
                    }
                    break;
            }
            
            updateOrderInfo();
            updateDriverInfo();
        }

        function checkMapElements() {
            const statusDiv = document.getElementById('mapElementsStatus');
            let status = 'åœ°å›¾å…ƒç´ æ£€æŸ¥ç»“æœ:\\n';
            
            // æ£€æŸ¥å…¨å±€å˜é‡
            status += `\\nå…¨å±€å˜é‡æ£€æŸ¥:`;
            status += `\\n- window.AMap: ${typeof window.AMap !== 'undefined' ? 'âœ… å·²åŠ è½½' : 'âŒ æœªåŠ è½½'}`;
            status += `\\n- mapå®ä¾‹: ${typeof window.map !== 'undefined' && window.map ? 'âœ… å·²åˆå§‹åŒ–' : 'âŒ æœªåˆå§‹åŒ–'}`;
            
            // æ£€æŸ¥å¸æœºç›¸å…³å…ƒç´ 
            status += `\\n\\nå¸æœºåœ°å›¾å…ƒç´ :`;
            status += `\\n- driverMarker: ${typeof window.driverMarker !== 'undefined' && window.driverMarker ? 'âœ… å­˜åœ¨' : 'âŒ ä¸å­˜åœ¨'}`;
            status += `\\n- driverRouteLine: ${typeof window.driverRouteLine !== 'undefined' && window.driverRouteLine ? 'âœ… å­˜åœ¨' : 'âŒ ä¸å­˜åœ¨'}`;
            
            // æ£€æŸ¥æ•°æ®å®Œæ•´æ€§
            status += `\\n\\næ•°æ®å®Œæ•´æ€§:`;
            status += `\\n- è®¢å•ä¿¡æ¯: ${mockOrder ? 'âœ… å­˜åœ¨' : 'âŒ ç¼ºå¤±'}`;
            status += `\\n- å¸æœºä¿¡æ¯: ${mockDriver ? 'âœ… å­˜åœ¨' : 'âŒ ç¼ºå¤±'}`;
            if (mockDriver) {
                status += `\\n- å¸æœºä½ç½®: ${mockDriver.latitude && mockDriver.longitude ? 'âœ… å®Œæ•´' : 'âŒ ç¼ºå¤±'}`;
            }
            
            statusDiv.textContent = status;
            statusDiv.className = 'info-display';
            
            log('åœ°å›¾å…ƒç´ æ£€æŸ¥å®Œæˆ');
        }

        function testDriverMarker() {
            if (!mockDriver || !mockDriver.latitude || !mockDriver.longitude) {
                alert('è¯·å…ˆè®¾ç½®å®Œæ•´çš„å¸æœºä¿¡æ¯');
                return;
            }
            
            log(`æµ‹è¯•å¸æœºæ ‡è®°: (${mockDriver.latitude}, ${mockDriver.longitude})`);
            
            // æ¨¡æ‹Ÿè°ƒç”¨showDriverOnMapå‡½æ•°
            if (typeof window.showDriverOnMap === 'function') {
                try {
                    window.showDriverOnMap(mockDriver.latitude, mockDriver.longitude);
                    log('âœ… å¸æœºæ ‡è®°æµ‹è¯•æˆåŠŸ');
                } catch (error) {
                    log(`âŒ å¸æœºæ ‡è®°æµ‹è¯•å¤±è´¥: ${error.message}`);
                }
            } else {
                log('âŒ showDriverOnMapå‡½æ•°ä¸å­˜åœ¨');
            }
        }

        function testDriverRoute() {
            if (!mockDriver || !mockDriver.latitude || !mockDriver.longitude) {
                alert('è¯·å…ˆè®¾ç½®å®Œæ•´çš„å¸æœºä¿¡æ¯');
                return;
            }
            
            if (!mockOrder || !mockOrder.pickupLatitude || !mockOrder.pickupLongitude) {
                alert('è¯·å…ˆè®¾ç½®å®Œæ•´çš„è®¢å•ä¿¡æ¯');
                return;
            }
            
            log(`æµ‹è¯•å¸æœºè·¯çº¿: å¸æœº(${mockDriver.latitude}, ${mockDriver.longitude}) â†’ ä¸Šè½¦ç‚¹(${mockOrder.pickupLatitude}, ${mockOrder.pickupLongitude})`);
            
            // æ¨¡æ‹Ÿè°ƒç”¨updateDriverRouteå‡½æ•°
            if (typeof window.updateDriverRoute === 'function') {
                try {
                    window.updateDriverRoute(mockDriver.latitude, mockDriver.longitude);
                    log('âœ… å¸æœºè·¯çº¿æµ‹è¯•æˆåŠŸ');
                } catch (error) {
                    log(`âŒ å¸æœºè·¯çº¿æµ‹è¯•å¤±è´¥: ${error.message}`);
                }
            } else {
                log('âŒ updateDriverRouteå‡½æ•°ä¸å­˜åœ¨');
            }
        }

        function testCompleteFlow() {
            const resultDiv = document.getElementById('flowTestResult');
            let result = 'å®Œæ•´æµç¨‹æµ‹è¯•:\\n';
            
            log('å¼€å§‹å®Œæ•´æµç¨‹æµ‹è¯•...');
            
            // æ­¥éª¤1: ç”¨æˆ·ç™»å½•
            simulateLogin();
            result += '\\nâœ… æ­¥éª¤1: ç”¨æˆ·ç™»å½•';
            
            setTimeout(() => {
                // æ­¥éª¤2: å¸æœºæ¥å•
                simulateOrderAssigned();
                result += '\\nâœ… æ­¥éª¤2: å¸æœºæ¥å•';
                
                setTimeout(() => {
                    // æ­¥éª¤3: å‘é€WebSocketæ¶ˆæ¯
                    sendOrderAssignedMessage();
                    result += '\\nâœ… æ­¥éª¤3: WebSocketæ¶ˆæ¯å¤„ç†';
                    
                    setTimeout(() => {
                        // æ­¥éª¤4: æ£€æŸ¥æ•°æ®å®Œæ•´æ€§
                        let dataComplete = true;
                        if (!mockDriver || !mockDriver.latitude || !mockDriver.longitude) {
                            result += '\\nâŒ æ­¥éª¤4: å¸æœºä½ç½®æ•°æ®ç¼ºå¤±';
                            dataComplete = false;
                        } else {
                            result += '\\nâœ… æ­¥éª¤4: å¸æœºä½ç½®æ•°æ®å®Œæ•´';
                        }
                        
                        setTimeout(() => {
                            // æ­¥éª¤5: æµ‹è¯•åœ°å›¾åŠŸèƒ½
                            if (dataComplete) {
                                result += '\\nâœ… æ­¥éª¤5: å‡†å¤‡æµ‹è¯•åœ°å›¾åŠŸèƒ½';
                                result += '\\nğŸ’¡ æç¤º: è¯·åœ¨å®é™…é¡µé¢ä¸­æµ‹è¯•å¸æœºæ ‡è®°å’Œè·¯çº¿æ˜¾ç¤º';
                            } else {
                                result += '\\nâŒ æ­¥éª¤5: æ•°æ®ä¸å®Œæ•´ï¼Œæ— æ³•æµ‹è¯•åœ°å›¾åŠŸèƒ½';
                            }
                            
                            result += '\\n\\nğŸ¯ æµ‹è¯•æ€»ç»“:';
                            result += dataComplete ? '\\nâœ… æ•°æ®æµç¨‹æ­£å¸¸ï¼Œé—®é¢˜å¯èƒ½åœ¨åœ°å›¾æ¸²æŸ“å±‚' : '\\nâŒ æ•°æ®æµç¨‹æœ‰é—®é¢˜ï¼Œéœ€è¦æ£€æŸ¥WebSocketæ¶ˆæ¯å¤„ç†';
                            
                            resultDiv.textContent = result;
                            resultDiv.className = dataComplete ? 'info-display status-good' : 'info-display status-error';
                            
                            log('å®Œæ•´æµç¨‹æµ‹è¯•å®Œæˆ');
                        }, 1000);
                    }, 1000);
                }, 1000);
            }, 1000);
        }

        // é¡µé¢åŠ è½½æ—¶çš„åˆå§‹åŒ–
        window.onload = function() {
            log('å¸æœºä½ç½®è°ƒè¯•å·¥å…·å·²åŠ è½½');
            updateUserStatus();
            updateOrderInfo();
            updateDriverInfo();
            updateWebSocketMessages();
            
            log('è°ƒè¯•è¯´æ˜:');
            log('1. æ¨¡æ‹Ÿç”¨æˆ·ç™»å½•å’Œè®¢å•çŠ¶æ€');
            log('2. æµ‹è¯•WebSocketæ¶ˆæ¯å¤„ç†');
            log('3. æ£€æŸ¥å¸æœºä½ç½®æ•°æ®å®Œæ•´æ€§');
            log('4. éªŒè¯åœ°å›¾å…ƒç´ æ¸²æŸ“åŠŸèƒ½');
        };
    </script>
</body>
</html>"