<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>评价管理测试</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/element-plus/dist/index.full.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css">
    <style>
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        .test-container {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e4e7ed;
            border-radius: 4px;
        }
        .test-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #303133;
        }
        .api-result {
            background-color: #f5f7fa;
            padding: 15px;
            border-radius: 4px;
            margin-top: 10px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .user-info {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="test-container">
            <h1>评价管理功能测试</h1>
            
            <!-- 测试获取所有评价 -->
            <div class="test-section">
                <div class="test-title">1. 测试获取所有评价API</div>
                <el-button type="primary" @click="testGetAllReviews" :loading="loading.getAllReviews">
                    获取所有评价
                </el-button>
                <div class="api-result" v-if="results.getAllReviews">
                    {{ results.getAllReviews }}
                </div>
            </div>

            <!-- 评价列表展示 -->
            <div class="test-section" v-if="reviews.length > 0">
                <div class="test-title">2. 评价列表展示</div>
                <el-table :data="reviews" style="width: 100%">
                    <el-table-column prop="id" label="ID" width="80" />
                    
                    <el-table-column label="评分" width="120">
                        <template #default="scope">
                            <el-rate
                                v-model="scope.row.rating"
                                disabled
                                show-score
                                text-color="#ff9900"
                                score-template="{value}"
                            />
                        </template>
                    </el-table-column>
                    
                    <el-table-column label="评价者" width="150">
                        <template #default="scope">
                            <div class="user-info">
                                <img 
                                    :src="getAvatarUrl(scope.row.reviewerAvatar)" 
                                    :alt="scope.row.reviewerName"
                                    class="user-avatar"
                                    @error="handleImageError"
                                />
                                <span>{{ scope.row.reviewerName }}</span>
                            </div>
                        </template>
                    </el-table-column>
                    
                    <el-table-column label="被评价者" width="150">
                        <template #default="scope">
                            <div class="user-info">
                                <img 
                                    :src="getAvatarUrl(scope.row.revieweeAvatar)" 
                                    :alt="scope.row.revieweeName"
                                    class="user-avatar"
                                    @error="handleImageError"
                                />
                                <span>{{ scope.row.revieweeName }}</span>
                            </div>
                        </template>
                    </el-table-column>
                    
                    <el-table-column label="评价类型" width="120">
                        <template #default="scope">
                            <el-tag :type="scope.row.reviewType === 'passenger_to_driver' ? 'primary' : 'success'">
                                {{ scope.row.reviewType === 'passenger_to_driver' ? '乘客→司机' : '司机→乘客' }}
                            </el-tag>
                        </template>
                    </el-table-column>
                    
                    <el-table-column prop="comment" label="评价内容" min-width="200">
                        <template #default="scope">
                            <div style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                {{ scope.row.comment || '无评价内容' }}
                            </div>
                        </template>
                    </el-table-column>
                    
                    <el-table-column prop="orderId" label="订单ID" width="100" />
                    
                    <el-table-column label="评价时间" width="180">
                        <template #default="scope">
                            {{ formatTime(scope.row.createdAt) }}
                        </template>
                    </el-table-column>
                </el-table>
            </div>

            <!-- 测试删除评价 -->
            <div class="test-section" v-if="reviews.length > 0">
                <div class="test-title">3. 测试删除评价功能</div>
                <el-select v-model="selectedReviewId" placeholder="选择要删除的评价" style="width: 200px; margin-right: 10px;">
                    <el-option 
                        v-for="review in reviews.filter(r => r.rating <= 2)" 
                        :key="review.id" 
                        :label="`ID: ${review.id} - ${review.rating}星`" 
                        :value="review.id" 
                    />
                </el-select>
                <el-button 
                    type="danger" 
                    @click="testDeleteReview" 
                    :loading="loading.deleteReview"
                    :disabled="!selectedReviewId"
                >
                    删除评价
                </el-button>
                <div class="api-result" v-if="results.deleteReview">
                    {{ results.deleteReview }}
                </div>
            </div>

            <!-- 统计信息 -->
            <div class="test-section" v-if="stats.totalReviews > 0">
                <div class="test-title">4. 评价统计信息</div>
                <el-row :gutter="20">
                    <el-col :span="6">
                        <el-card>
                            <div style="text-align: center;">
                                <div style="font-size: 24px; font-weight: bold; color: #409eff;">{{ stats.totalReviews }}</div>
                                <div style="color: #666;">总评价数</div>
                            </div>
                        </el-card>
                    </el-col>
                    <el-col :span="6">
                        <el-card>
                            <div style="text-align: center;">
                                <div style="font-size: 24px; font-weight: bold; color: #67c23a;">{{ stats.averageRating }}</div>
                                <div style="color: #666;">平均评分</div>
                            </div>
                        </el-card>
                    </el-col>
                    <el-col :span="6">
                        <el-card>
                            <div style="text-align: center;">
                                <div style="font-size: 24px; font-weight: bold; color: #e6a23c;">{{ stats.todayReviews }}</div>
                                <div style="color: #666;">今日评价</div>
                            </div>
                        </el-card>
                    </el-col>
                    <el-col :span="6">
                        <el-card>
                            <div style="text-align: center;">
                                <div style="font-size: 24px; font-weight: bold; color: #f56c6c;">{{ stats.lowRatingReviews }}</div>
                                <div style="color: #666;">低分评价</div>
                            </div>
                        </el-card>
                    </el-col>
                </el-row>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, reactive, onMounted } = Vue;
        const { ElMessage, ElMessageBox } = ElementPlus;

        createApp({
            setup() {
                const loading = reactive({
                    getAllReviews: false,
                    deleteReview: false
                });

                const results = reactive({
                    getAllReviews: '',
                    deleteReview: ''
                });

                const reviews = ref([]);
                const selectedReviewId = ref(null);

                const stats = reactive({
                    totalReviews: 0,
                    averageRating: 0,
                    todayReviews: 0,
                    lowRatingReviews: 0
                });

                const testGetAllReviews = async () => {
                    loading.getAllReviews = true;
                    try {
                        console.log('测试获取所有评价...');
                        
                        const response = await fetch('/api/reviews/all');
                        console.log('API响应状态:', response.status);
                        
                        const data = await response.json();
                        console.log('API响应数据:', data);
                        
                        results.getAllReviews = JSON.stringify(data, null, 2);
                        
                        if (data.success && data.data) {
                            reviews.value = data.data.map(review => ({
                                ...review,
                                reviewerName: review.reviewerName || '未知用户',
                                revieweeName: review.revieweeName || '未知用户',
                                reviewType: review.reviewType || 'passenger_to_driver'
                            }));
                            
                            updateStats(data.data);
                            ElMessage.success('获取评价数据成功');
                        } else {
                            ElMessage.error('获取评价数据失败');
                        }
                    } catch (error) {
                        console.error('获取评价数据失败:', error);
                        results.getAllReviews = `错误: ${error.message}`;
                        ElMessage.error(`获取评价数据失败: ${error.message}`);
                    } finally {
                        loading.getAllReviews = false;
                    }
                };

                const testDeleteReview = async () => {
                    if (!selectedReviewId.value) {
                        ElMessage.warning('请选择要删除的评价');
                        return;
                    }

                    try {
                        await ElMessageBox.confirm(
                            '确定要删除这条评价吗？此操作不可恢复。',
                            '确认删除',
                            {
                                confirmButtonText: '确定',
                                cancelButtonText: '取消',
                                type: 'warning',
                            }
                        );

                        loading.deleteReview = true;
                        
                        const response = await fetch(`/api/reviews/${selectedReviewId.value}`, {
                            method: 'DELETE'
                        });
                        
                        const data = await response.json();
                        console.log('删除评价响应:', data);
                        
                        results.deleteReview = JSON.stringify(data, null, 2);
                        
                        if (data.success) {
                            ElMessage.success('评价删除成功');
                            selectedReviewId.value = null;
                            // 重新获取评价列表
                            testGetAllReviews();
                        } else {
                            ElMessage.error('评价删除失败');
                        }
                    } catch (error) {
                        if (error !== 'cancel') {
                            console.error('删除评价失败:', error);
                            results.deleteReview = `错误: ${error.message}`;
                            ElMessage.error(`删除评价失败: ${error.message}`);
                        }
                    } finally {
                        loading.deleteReview = false;
                    }
                };

                const updateStats = (reviewsData) => {
                    stats.totalReviews = reviewsData.length;
                    
                    if (reviewsData.length > 0) {
                        const totalRating = reviewsData.reduce((sum, review) => sum + (review.rating || 0), 0);
                        stats.averageRating = (totalRating / reviewsData.length).toFixed(1);
                    } else {
                        stats.averageRating = 0;
                    }
                    
                    // 今日评价数
                    const today = new Date().toISOString().split('T')[0];
                    stats.todayReviews = reviewsData.filter(review => {
                        const reviewDate = review.createdAt || review.created_at;
                        return reviewDate && reviewDate.startsWith(today);
                    }).length;
                    
                    // 低分评价数（1-2星）
                    stats.lowRatingReviews = reviewsData.filter(review => review.rating <= 2).length;
                };

                const formatTime = (time) => {
                    if (!time) return '-';
                    return new Date(time).toLocaleString();
                };

                const getAvatarUrl = (avatar) => {
                    if (!avatar) return '/default-avatar.png';
                    if (avatar.startsWith('http')) return avatar;
                    return `/api/files/avatar/${avatar}`;
                };

                const handleImageError = (event) => {
                    event.target.src = '/default-avatar.png';
                };

                onMounted(() => {
                    console.log('评价管理测试页面已加载');
                });

                return {
                    loading,
                    results,
                    reviews,
                    selectedReviewId,
                    stats,
                    testGetAllReviews,
                    testDeleteReview,
                    formatTime,
                    getAvatarUrl,
                    handleImageError
                };
            }
        }).use(ElementPlus).mount('#app');
    </script>
</body>
</html>