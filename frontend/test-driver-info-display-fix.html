<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>司机信息显示修复测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        button {
            background: #409EFF;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #66b1ff;
        }
        .result-display {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 14px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .status-good {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .status-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .driver-info-preview {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }
        .driver-info-item {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
        }
        .label {
            font-weight: bold;
            color: #495057;
        }
        .value {
            color: #212529;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔧 司机信息显示修复测试</h1>
        <p>测试乘客端是否能正确显示司机车辆信息</p>
    </div>

    <div class="container">
        <h3>步骤1: 模拟WebSocket消息</h3>
        <button onclick="simulateWebSocketMessage()">模拟司机接单消息</button>
        <div id="messageResult" class="result-display">
            点击模拟WebSocket消息...
        </div>
    </div>

    <div class="container">
        <h3>步骤2: 测试信息提取</h3>
        <button onclick="testInfoExtraction()">测试信息提取逻辑</button>
        <div id="extractionResult" class="result-display">
            点击测试信息提取...
        </div>
    </div>

    <div class="container">
        <h3>步骤3: 预览显示效果</h3>
        <div id="previewResult" class="driver-info-preview" style="display: none;">
            <h4>司机信息预览</h4>
            <div class="driver-info-item">
                <span class="label">司机姓名:</span>
                <span class="value" id="previewName">-</span>
            </div>
            <div class="driver-info-item">
                <span class="label">车牌号:</span>
                <span class="value" id="previewPlate">-</span>
            </div>
            <div class="driver-info-item">
                <span class="label">车型:</span>
                <span class="value" id="previewModel">-</span>
            </div>
            <div class="driver-info-item">
                <span class="label">颜色:</span>
                <span class="value" id="previewColor">-</span>
            </div>
            <div class="driver-info-item">
                <span class="label">类型:</span>
                <span class="value" id="previewType">-</span>
            </div>
        </div>
    </div>

    <script>
        function log(message, containerId = 'result') {
            const container = document.getElementById(containerId);
            const timestamp = new Date().toLocaleTimeString();
            container.textContent += `[${timestamp}] ${message}\n`;
            container.scrollTop = container.scrollHeight;
            console.log(message);
        }

        // 模拟你提供的WebSocket消息
        const mockWebSocketMessage = {
            "driver": {
                "vehicleColor": "白色",
                "latitude": 39.04170548630136,
                "rating": 5,
                "vehicleInfo": "we 123 s123445",
                "avatar": null,
                "plateNumber": "s123445",
                "vehicleBrand": "we",
                "phoneNumber": "13164586598",
                "vehicleYear": 2025,
                "driverId": 1,
                "phone": "13164586598",
                "vehicleSeats": 5,
                "name": "qyj",
                "vehicleModel": "123",
                "driverName": "qyj",
                "id": 1,
                "vehicleType": "COMFORT",
                "carModel": "we 123",
                "longitude": 121.79689317941666
            },
            "type": "ORDER_ASSIGNED",
            "order": {
                "orderNumber": "ORDER1754426749071b2fb5eb5",
                "destinationAddress": "山东大学(中心校区)",
                "pickupAddress": "位置 (39.041706, 121.796893)",
                "pickupLongitude": 121.796893,
                "estimatedFare": 2785,
                "id": 365,
                "destinationLatitude": 36.675668,
                "destinationLongitude": 117.060109,
                "pickupLatitude": 39.041706,
                "status": "ASSIGNED"
            },
            "timestamp": 1754426750353
        };

        function simulateWebSocketMessage() {
            const resultDiv = document.getElementById('messageResult');
            resultDiv.textContent = '';
            resultDiv.className = 'result-display';
            
            log('📨 模拟WebSocket消息...', 'messageResult');
            log('消息类型: ' + mockWebSocketMessage.type, 'messageResult');
            log('司机ID: ' + mockWebSocketMessage.driver.id, 'messageResult');
            log('司机姓名: ' + mockWebSocketMessage.driver.name, 'messageResult');
            
            log('\n🚗 车辆信息:', 'messageResult');
            log('车牌号: ' + mockWebSocketMessage.driver.plateNumber, 'messageResult');
            log('品牌: ' + mockWebSocketMessage.driver.vehicleBrand, 'messageResult');
            log('型号: ' + mockWebSocketMessage.driver.vehicleModel, 'messageResult');
            log('颜色: ' + mockWebSocketMessage.driver.vehicleColor, 'messageResult');
            log('类型: ' + mockWebSocketMessage.driver.vehicleType, 'messageResult');
            log('座位数: ' + mockWebSocketMessage.driver.vehicleSeats, 'messageResult');
            log('年份: ' + mockWebSocketMessage.driver.vehicleYear, 'messageResult');
            
            resultDiv.className = 'result-display status-good';
        }

        function testInfoExtraction() {
            const resultDiv = document.getElementById('extractionResult');
            resultDiv.textContent = '';
            resultDiv.className = 'result-display';
            
            log('🔧 测试信息提取逻辑...', 'extractionResult');
            
            // 模拟修复后的handleOrderAssigned逻辑
            const data = mockWebSocketMessage;
            
            if (data.driver) {
                const driverData = {
                    id: data.driver.id || data.driver.driverId,
                    name: data.driver.name || data.driver.driverName || "司机",
                    phone: data.driver.phone || data.driver.phoneNumber,
                    avatar: data.driver.avatar,
                    rating: data.driver.rating || 5.0,
                    // 车辆信息
                    plateNumber: data.driver.plateNumber || "暂无车牌",
                    vehicleBrand: data.driver.vehicleBrand || "未知",
                    vehicleModel: data.driver.vehicleModel || "",
                    vehicleColor: data.driver.vehicleColor || "未知",
                    vehicleType: data.driver.vehicleType || "ECONOMY",
                    vehicleSeats: data.driver.vehicleSeats || 5,
                    vehicleYear: data.driver.vehicleYear,
                    vehicleInfo: data.driver.vehicleInfo || data.driver.carModel || `${data.driver.vehicleBrand || '未知'} ${data.driver.vehicleModel || ''} ${data.driver.plateNumber || ''}`.trim(),
                    carModel: data.driver.carModel || `${data.driver.vehicleBrand || '未知'} ${data.driver.vehicleModel || ''}`.trim(),
                    latitude: data.driver.latitude,
                    longitude: data.driver.longitude,
                };
                
                log('✅ 提取的司机数据:', 'extractionResult');
                log('ID: ' + driverData.id, 'extractionResult');
                log('姓名: ' + driverData.name, 'extractionResult');
                log('电话: ' + driverData.phone, 'extractionResult');
                log('评分: ' + driverData.rating, 'extractionResult');
                
                log('\n🚗 提取的车辆数据:', 'extractionResult');
                log('车牌号: ' + driverData.plateNumber, 'extractionResult');
                log('品牌: ' + driverData.vehicleBrand, 'extractionResult');
                log('型号: ' + driverData.vehicleModel, 'extractionResult');
                log('颜色: ' + driverData.vehicleColor, 'extractionResult');
                log('类型: ' + driverData.vehicleType, 'extractionResult');
                log('座位数: ' + driverData.vehicleSeats, 'extractionResult');
                log('年份: ' + driverData.vehicleYear, 'extractionResult');
                log('车辆信息: ' + driverData.vehicleInfo, 'extractionResult');
                log('车型: ' + driverData.carModel, 'extractionResult');
                
                // 更新预览
                updatePreview(driverData);
                
                resultDiv.className = 'result-display status-good';
            } else {
                log('❌ 没有司机数据', 'extractionResult');
                resultDiv.className = 'result-display status-error';
            }
        }

        function updatePreview(driverData) {
            const previewDiv = document.getElementById('previewResult');
            previewDiv.style.display = 'block';
            
            document.getElementById('previewName').textContent = driverData.name;
            document.getElementById('previewPlate').textContent = driverData.plateNumber;
            document.getElementById('previewModel').textContent = `${driverData.vehicleBrand} ${driverData.vehicleModel}`;
            document.getElementById('previewColor').textContent = driverData.vehicleColor;
            document.getElementById('previewType').textContent = getVehicleTypeText(driverData.vehicleType);
        }

        function getVehicleTypeText(type) {
            const typeMap = {
                'ECONOMY': '经济型',
                'COMFORT': '舒适型',
                'PREMIUM': '高级型',
                'LUXURY': '豪华型'
            };
            return typeMap[type] || '经济型';
        }

        // 页面加载时的说明
        window.onload = function() {
            log('司机信息显示修复测试页面加载完成', 'messageResult');
            log('按顺序点击按钮进行测试', 'messageResult');
        };
    </script>
</body>
</html>